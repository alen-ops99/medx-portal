<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Med&X Admin — Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚕️</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --bg-hover: #475569;
            --accent-gold: #c9a962;
            --accent-gold-dim: #a38a4f;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --border-light: #475569;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --plexus: #a78bfa;
            --accelerator: #22d3ee;
            --forum: #fb923c;
            --bridges: #f472b6;
            --finances: #10b981;
            --pr-media: #ec4899;

            /* Aliases used in inline styles throughout the app */
            --border-color: #334155;
            --input-bg: #1e293b;
            --card-bg: #1e293b;
            --accent-primary: #22d3ee;
            --accent-color: #c9a962;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --success-rgb: 34, 197, 94;
            --danger-rgb: 239, 68, 68;
            --pr-media-rgb: 236, 72, 153;
            --plexus-rgb: 167, 139, 250;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        *:focus-visible {
            outline: 2px solid var(--accent-gold);
            outline-offset: 2px;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
        }

        /* ===== LOGIN PAGE ===== */
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1a2744 100%);
        }

        .login-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-logo img {
            height: 60px;
            width: auto;
            object-fit: contain;
            margin-bottom: 8px;
            filter: brightness(0) invert(1);
        }

        .login-logo h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .login-logo h1 span {
            color: var(--accent-gold);
        }

        .login-logo p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 8px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .login-form .form-input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .login-form .form-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.1);
        }

        .login-form .form-input::placeholder {
            color: var(--text-muted);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-gold);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .login-btn:hover {
            background: var(--accent-gold-dim);
        }

        .login-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 20px;
            display: none;
        }

        .login-error.show {
            display: block;
        }

        /* ===== ONBOARDING MODAL ===== */
        .onboarding-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: rgba(10, 12, 28, 0);
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(0px);
            transition: background 0.4s ease, backdrop-filter 0.4s ease, opacity 0.3s ease;
            opacity: 0;
        }

        .onboarding-overlay.visible {
            display: flex;
        }

        .onboarding-overlay.active {
            opacity: 1;
            background: rgba(10, 12, 28, 0.92);
            backdrop-filter: blur(8px);
        }

        .onboarding-overlay.closing .onboarding-card {
            animation: cardExit 0.3s cubic-bezier(0.4, 0, 1, 1) forwards;
        }

        @keyframes cardExit {
            to { opacity: 0; transform: translateY(16px) scale(0.97); }
        }

        .onboarding-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 640px;
            max-height: 90vh;
            overflow-y: auto;
            animation: cardEntrance 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes cardEntrance {
            from { opacity: 0; transform: translateY(30px) scale(0.97); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .onboarding-card h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
            animation: textFadeIn 0.5s ease 0.15s both;
        }

        .onboarding-card h2 span {
            color: var(--accent-gold);
        }

        .onboarding-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 28px;
            animation: textFadeIn 0.5s ease 0.25s both;
        }

        @keyframes textFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 28px;
        }

        /* Staggered entrance for each card */
        .section-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: border-color 0.2s ease, background 0.2s ease, transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), box-shadow 0.2s ease;
            user-select: none;
            animation: cardStagger 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
        }

        .section-card:nth-child(1) { animation-delay: 0.2s; }
        .section-card:nth-child(2) { animation-delay: 0.25s; }
        .section-card:nth-child(3) { animation-delay: 0.3s; }
        .section-card:nth-child(4) { animation-delay: 0.35s; }
        .section-card:nth-child(5) { animation-delay: 0.4s; }
        .section-card:nth-child(6) { animation-delay: 0.45s; }
        .section-card:nth-child(7) { animation-delay: 0.5s; }
        .section-card:nth-child(8) { animation-delay: 0.55s; }

        @keyframes cardStagger {
            from { opacity: 0; transform: translateY(16px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .section-card:hover:not(.always-on) {
            border-color: var(--accent-gold-dim);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .section-card:active:not(.always-on) {
            transform: scale(0.98);
            transition-duration: 0.08s;
        }

        .section-card.selected {
            border-color: var(--accent-gold);
            background: rgba(201, 169, 98, 0.08);
            box-shadow: 0 0 0 1px rgba(201, 169, 98, 0.15), 0 2px 8px rgba(201, 169, 98, 0.1);
        }

        .section-card.selected:hover:not(.always-on) {
            box-shadow: 0 0 0 1px rgba(201, 169, 98, 0.25), 0 4px 16px rgba(201, 169, 98, 0.15);
        }

        .section-card.always-on {
            opacity: 0.5;
            cursor: default;
            border-color: var(--accent-gold-dim);
            background: rgba(201, 169, 98, 0.05);
        }

        .section-card-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            flex-shrink: 0;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .section-card.selected .section-card-icon {
            transform: scale(1.1);
        }

        .section-card-info {
            flex: 1;
            min-width: 0;
        }

        .section-card-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            transition: color 0.2s ease;
        }

        .section-card.selected .section-card-name {
            color: var(--accent-gold);
        }

        .section-card-desc {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .section-card-check {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            font-size: 10px;
            color: transparent;
        }

        .section-card.selected .section-card-check,
        .section-card.always-on .section-card-check {
            border-color: var(--accent-gold);
            background: var(--accent-gold);
            color: var(--bg-primary);
            transform: scale(1.1);
        }

        /* Checkmark pop animation on toggle */
        .section-card.selected .section-card-check i {
            animation: checkPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes checkPop {
            0% { transform: scale(0); }
            60% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .onboarding-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            animation: textFadeIn 0.5s ease 0.6s both;
        }

        .onboarding-btn {
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            font-family: inherit;
            border: none;
            position: relative;
        }

        .onboarding-btn-primary {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        .onboarding-btn-primary:hover:not(:disabled) {
            background: var(--accent-gold-dim);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(201, 169, 98, 0.3);
        }

        .onboarding-btn-primary:active:not(:disabled) {
            transform: scale(0.97);
            transition-duration: 0.08s;
        }

        .onboarding-btn-primary:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .manage-sections-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .manage-sections-btn:hover {
            background: var(--bg-tertiary);
            color: var(--accent-gold);
            transform: rotate(45deg);
        }

        @media (max-width: 600px) {
            .section-grid { grid-template-columns: 1fr; }
            .onboarding-card { padding: 24px; margin: 12px; }
        }

        /* ===== SETTINGS MODAL ===== */
        .settings-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 10000;
            background: rgba(10, 12, 28, 0);
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(0px);
            transition: background 0.4s ease, backdrop-filter 0.4s ease, opacity 0.3s ease;
            opacity: 0;
        }
        .settings-overlay.visible { display: flex; }
        .settings-overlay.active {
            opacity: 1;
            background: rgba(10, 12, 28, 0.92);
            backdrop-filter: blur(8px);
        }
        .settings-overlay.closing .settings-card {
            animation: cardExit 0.3s cubic-bezier(0.4, 0, 1, 1) forwards;
        }
        .settings-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 100%;
            max-width: 560px;
            max-height: 90vh;
            overflow-y: auto;
            animation: cardEntrance 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 28px 0;
        }
        .settings-header h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }
        .settings-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .settings-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        .settings-tabs {
            display: flex;
            gap: 0;
            padding: 16px 28px 0;
            border-bottom: 1px solid var(--border);
        }
        .settings-tab {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            padding: 8px 16px 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        .settings-tab:hover {
            color: var(--text-primary);
        }
        .settings-tab.active {
            color: var(--accent-gold);
            border-bottom-color: var(--accent-gold);
        }
        .settings-body {
            padding: 24px 28px 28px;
        }
        .settings-pane {
            display: none;
        }
        .settings-pane.active {
            display: block;
        }
        .settings-form .form-group {
            margin-bottom: 16px;
        }
        .settings-form .form-label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .settings-feedback {
            font-size: 13px;
            padding: 8px 0;
            min-height: 30px;
        }
        .settings-feedback.success { color: var(--success); }
        .settings-feedback.error { color: var(--danger); }

        @media (max-width: 600px) {
            .settings-card { margin: 12px; }
            .settings-header, .settings-tabs, .settings-body { padding-left: 20px; padding-right: 20px; }
        }

        /* ===== PORTAL PULSE CARD ===== */
        .portal-pulse-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .pulse-stat {
            padding: 10px 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        .pulse-stat::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 3px;
            background: var(--accent-gold);
            border-radius: 3px 0 0 3px;
        }
        .pulse-stat.pulse-stat--warning::before { background: var(--warning, #f59e0b); }
        .pulse-stat.pulse-stat--danger::before { background: var(--danger); }
        .pulse-stat.pulse-stat--success::before { background: var(--success); }
        .pulse-stat.pulse-stat--info::before { background: #60a5fa; }
        .pulse-stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
            margin-bottom: 4px;
        }
        .pulse-stat-header-left {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .pulse-stat-header i {
            font-size: 11px;
            opacity: 0.6;
        }
        .pulse-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-gold);
            line-height: 1.1;
        }
        .pulse-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .pulse-stat-detail {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 3px;
            display: flex;
            flex-wrap: wrap;
            gap: 2px 8px;
        }
        .pulse-stat-detail span {
            white-space: nowrap;
        }
        .pulse-stat-badge {
            display: inline-block;
            font-size: 10px;
            font-weight: 600;
            color: var(--success);
            margin-left: 3px;
        }
        .pulse-trend {
            font-size: 11px;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 4px;
            line-height: 1.4;
        }
        .pulse-trend--up { color: var(--success); background: rgba(var(--success-rgb), 0.1); }
        .pulse-trend--down { color: var(--danger); background: rgba(var(--danger-rgb), 0.1); }
        .pulse-trend--stable { color: var(--text-muted); background: var(--bg-tertiary); }
        .pulse-mini-bar {
            height: 3px;
            border-radius: 2px;
            background: var(--bg-tertiary);
            margin-top: 6px;
            overflow: hidden;
        }
        .pulse-mini-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }
        .pulse-pending-row {
            grid-column: 1 / -1;
            padding: 8px 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
        }
        .pulse-pending-row::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 3px;
            background: var(--warning, #f59e0b);
            border-radius: 3px 0 0 3px;
        }
        .pulse-pending-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }
        .pulse-pending-header i {
            font-size: 11px;
            color: var(--warning, #f59e0b);
            opacity: 0.8;
        }
        .pulse-pending-header span {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .pulse-pending-items {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .pulse-pending-tag {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-weight: 500;
            white-space: nowrap;
        }
        .pulse-pending-tag--active {
            background: rgba(var(--danger-rgb), 0.15);
            color: var(--danger);
            font-weight: 600;
        }
        .pulse-freshness-row {
            grid-column: 1 / -1;
            display: flex;
            gap: 12px;
            padding: 6px 12px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border);
            align-items: center;
        }
        .pulse-freshness-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: var(--text-muted);
        }
        .pulse-freshness-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
        }
        .pulse-freshness-dot--hot { background: var(--success); box-shadow: 0 0 4px rgba(var(--success-rgb), 0.4); }
        .pulse-freshness-dot--warm { background: var(--warning, #f59e0b); }
        .pulse-freshness-dot--cold { background: var(--text-muted); }
        .pulse-refresh {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .pulse-refresh:hover {
            background: var(--bg-tertiary);
            color: var(--accent-gold);
        }
        @keyframes pulseGlow {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; text-shadow: 0 0 8px rgba(201, 169, 98, 0.5); }
        }
        .pulse-icon {
            animation: pulseGlow 2s ease-in-out infinite;
            color: var(--accent-gold);
        }

        /* ===== APP LAYOUT ===== */
        .app {
            display: none;
            min-height: 100vh;
        }

        .app.active {
            display: flex;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width, 260px);
            min-width: 200px;
            max-width: 400px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 100;
            flex-shrink: 0;
            position: relative;
        }

        .logo-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .logo {
            font-weight: 700;
            font-size: 20px;
            color: var(--text-primary);
        }

        .logo img {
            height: 32px;
            width: auto;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        .logo span {
            color: var(--accent-gold);
        }

        .nav {
            padding: 12px;
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 2px;
            transition: all 0.15s;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: rgba(201, 169, 98, 0.15);
            color: var(--accent-gold);
            border-left: 3px solid var(--accent-gold);
            padding-left: 9px;
        }

        .nav-item i {
            width: 18px;
            font-size: 14px;
        }

        .nav-divider {
            height: 1px;
            background: var(--border);
            margin: 12px 0;
        }

        .nav-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 12px 6px;
        }

        .project-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        /* Sidebar project items */
        .sidebar-project {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 2px;
            transition: all 0.15s;
            position: relative;
        }

        .sidebar-project:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .sidebar-project.active {
            background: rgba(201, 169, 98, 0.15);
            color: var(--accent-gold);
            border-left: 3px solid var(--accent-gold);
            padding-left: 9px;
        }

        .sidebar-project.pinned {
            border-left: 2px solid var(--accent-gold);
            margin-left: -2px;
        }

        .sidebar-project .project-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-project .project-days {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .sidebar-project .project-days.soon {
            background: rgba(201, 169, 98, 0.2);
            color: var(--accent-gold);
        }

        .sidebar-project .project-days.urgent {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .sidebar-project .project-actions {
            display: none;
            gap: 4px;
        }

        .sidebar-project:hover .project-actions {
            display: flex;
        }

        .sidebar-project:hover .project-days {
            display: none;
        }

        .sidebar-project .pin-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 2px 4px;
            font-size: 11px;
            border-radius: 3px;
        }

        .sidebar-project .pin-btn:hover {
            color: var(--accent-gold);
            background: rgba(201, 169, 98, 0.15);
        }

        .sidebar-project.pinned .pin-btn {
            color: var(--accent-gold);
        }

        .sidebar-project .drag-handle {
            cursor: grab;
            color: var(--text-muted);
            padding: 2px 4px;
            font-size: 10px;
        }

        .sidebar-project .drag-handle:hover {
            color: var(--text-secondary);
        }

        .sidebar-project.dragging {
            opacity: 0.5;
            background: var(--bg-tertiary);
        }

        .sidebar-project.drag-over {
            border-top: 2px solid var(--accent-gold);
        }

        .channel-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px 8px 24px;
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s;
        }

        .channel-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .channel-item.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .channel-item .hash {
            color: var(--text-muted);
            font-weight: 500;
        }

        .channel-badge {
            background: var(--accent-gold);
            color: var(--bg-primary);
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: auto;
        }

        .user-section {
            padding: 16px;
            border-top: 1px solid var(--border);
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--accent-gold);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg-primary);
            font-weight: 600;
            font-size: 13px;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
        }

        .user-role {
            font-size: 12px;
            color: var(--text-muted);
        }

        .logout-btn {
            margin-left: auto;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
        }

        .logout-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        /* ===== MAIN CONTENT ===== */
        .main-wrapper {
            flex: 1;
            display: flex;
            min-width: 0;
            overflow: hidden;
        }

        .main {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            height: 100vh;
            min-width: 0;
        }

        .page-header {
            margin-bottom: 28px;
        }

        .page-header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Swiss Clock Widget */
        .clock-widget {
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .swiss-clock {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            position: relative;
        }

        .swiss-clock .clock-face {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .swiss-clock .hour-hand,
        .swiss-clock .minute-hand,
        .swiss-clock .second-hand {
            position: absolute;
            background: var(--text-primary);
            transform-origin: bottom center;
            left: 50%;
            bottom: 50%;
            border-radius: 2px;
        }

        .swiss-clock .hour-hand {
            width: 2px;
            height: 8px;
            margin-left: -1px;
        }

        .swiss-clock .minute-hand {
            width: 1.5px;
            height: 11px;
            margin-left: -0.75px;
        }

        .swiss-clock .second-hand {
            width: 1px;
            height: 12px;
            margin-left: -0.5px;
            background: #ef4444;
        }

        .swiss-clock .center-dot {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--text-primary);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .clock-time {
            font-size: 11px;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }

        .clock-timer {
            font-size: 11px;
            color: var(--accent-gold);
            padding: 2px 6px;
            background: rgba(201, 169, 98, 0.15);
            border-radius: 4px;
            display: none;
        }

        .clock-timer.active {
            display: block;
        }

        .clock-timer.warning {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Timer Modal */
        .timer-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            min-width: 160px;
            z-index: 200;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .timer-dropdown.active {
            display: block;
        }

        .timer-dropdown h4 {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .timer-presets {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .timer-preset {
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
        }

        .timer-preset:hover {
            background: var(--accent-gold-dim);
            color: var(--accent-gold);
        }

        .timer-cancel {
            width: 100%;
            padding: 6px;
            background: rgba(239, 68, 68, 0.1);
            border: none;
            border-radius: 4px;
            color: #ef4444;
            font-size: 11px;
            cursor: pointer;
            display: none;
        }

        .timer-cancel.active {
            display: block;
        }

        .timer-done-btn {
            width: 100%;
            padding: 6px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            margin-top: 8px;
        }

        .timer-done-btn:hover {
            background: var(--accent-gold-dim);
            color: var(--accent-gold);
        }

        /* Sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Fix: sections that escaped <main> due to HTML nesting issues
           need proper flex behavior when shown as direct .app children */
        .app > .section.active {
            flex: 1;
            min-width: 0;
            padding: 32px;
            overflow-y: auto;
            height: 100vh;
        }

        /* Hide main-wrapper when an external section is active */
        .main-wrapper.hidden-for-section {
            display: none !important;
        }

        /* PR Tab panels */
        .pr-tab {
            display: none;
        }
        .pr-tab.active {
            display: block;
        }

        /* ===== PINNED ITEMS ===== */
        .pinned-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 28px;
        }

        .pinned-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .pinned-item:hover {
            border-color: var(--border-light);
        }

        .pinned-item .pin-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--accent-gold);
            font-size: 11px;
            opacity: 0.6;
        }

        .pinned-item .pin-type {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .pinned-item .pin-source {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 6px;
            border-radius: 3px;
            margin-bottom: 8px;
        }

        .pinned-item .pin-source.plexus { background: rgba(167, 139, 250, 0.2); color: #a78bfa; }
        .pinned-item .pin-source.accelerator { background: rgba(34, 211, 238, 0.2); color: #22d3ee; }
        .pinned-item .pin-source.forum { background: rgba(251, 146, 60, 0.2); color: #fb923c; }
        .pinned-item .pin-source.bridges { background: rgba(244, 114, 182, 0.2); color: #f472b6; }

        .pinned-item .pin-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .pinned-item .pin-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .pinned-item .unpin-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-muted);
            width: 22px;
            height: 22px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.5;
            transition: all 0.15s;
        }

        .pinned-item:hover .unpin-btn {
            opacity: 1;
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .pinned-item.dragging {
            opacity: 0.5;
        }

        .pinned-item.drag-over-left {
            border-left: 3px solid var(--accent-gold);
        }

        .pinned-item.drag-over-right {
            border-right: 3px solid var(--accent-gold);
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 20px;
            transition: box-shadow 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-weight: 600;
            font-size: 15px;
        }

        .card-body {
            padding: 20px;
        }

        /* ===== PROJECT CARDS ===== */
        .project-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .project-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .project-card:hover {
            border-color: var(--accent-gold);
        }

        .project-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .project-icon.plexus {
            background: rgba(167, 139, 250, 0.15);
            color: var(--plexus);
        }

        .project-icon.accelerator {
            background: rgba(34, 211, 238, 0.15);
            color: var(--accelerator);
        }

        .project-icon.forum {
            background: rgba(251, 146, 60, 0.15);
            color: var(--forum);
        }

        .project-icon.bridges {
            background: rgba(244, 114, 182, 0.15);
            color: var(--bridges);
        }

        .project-info {
            flex: 1;
        }

        .project-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }

        .project-desc {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .project-badge {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
        }

        /* ===== TASK ITEMS ===== */
        .task-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .task-item:last-child {
            border-bottom: none;
        }

        .task-check {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-light);
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
            transition: all 0.15s;
        }

        .task-check:hover {
            border-color: var(--accent-gold);
        }

        .task-check.done {
            background: var(--success);
            border-color: var(--success);
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .task-meta {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .task-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 500;
        }

        .task-badge.urgent {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .task-badge.soon {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .task-pin {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: all 0.15s;
        }

        .task-item:hover .task-pin {
            opacity: 1;
        }

        .task-pin:hover {
            background: var(--bg-tertiary);
            color: var(--accent-gold);
        }

        .task-pin.pinned {
            opacity: 1;
            color: var(--accent-gold);
        }

        /* ===== STATS ROW ===== */
        .stats-row {
            display: flex;
            gap: 32px;
            margin-bottom: 24px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: var(--accent-gold-dim);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .plexus-table {
            width: 100%;
            border-collapse: collapse;
        }

        .plexus-table th, .plexus-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .plexus-table th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            background: rgba(255, 255, 255, 0.02);
        }

        .form-select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.1);
        }

        /* ===== VISUAL TIMELINE ===== */
        .timeline {
            position: relative;
            padding: 8px 0;
        }

        .timeline-today-marker {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(201, 169, 98, 0.12);
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            color: var(--accent-gold);
        }

        .timeline-scroll {
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .timeline-scroll::-webkit-scrollbar {
            height: 4px;
        }

        .timeline-scroll::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        .timeline-visual {
            position: relative;
            min-width: 600px;
            padding: 8px 16px;
        }

        .timeline-months {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            display: flex;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .timeline-month {
            flex: 1;
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 600;
            opacity: 0.8;
        }

        .timeline-track {
            position: relative;
            height: 100px;
            margin: 20px 0 16px;
        }

        .timeline-line {
            position: absolute;
            left: 0;
            right: 0;
            top: 10px;
            height: 2px;
            background: var(--border);
            border-radius: 1px;
        }

        .timeline-today-line {
            position: absolute;
            top: 4px;
            height: 14px;
            width: 1px;
            background: var(--accent-gold);
            z-index: 5;
            border-radius: 1px;
            opacity: 0.7;
        }

        .timeline-today-line::after {
            content: 'TODAY';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 7px;
            color: var(--accent-gold);
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .timeline-event {
            position: absolute;
            transform: translateX(-50%);
            cursor: pointer;
            z-index: 3;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .timeline-event:hover {
            z-index: 10;
        }

        .timeline-event:hover .timeline-card {
            background: var(--bg-hover);
        }

        .timeline-event .timeline-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid var(--bg-secondary);
            flex-shrink: 0;
        }

        .timeline-event .timeline-stem {
            width: 1px;
            background: var(--border);
        }

        .timeline-card {
            background: var(--bg-tertiary);
            border-radius: 4px;
            padding: 4px 8px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
            border-left: 2px solid;
            transition: background 0.15s;
        }

        .timeline-card .tc-name {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-primary);
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .timeline-card .tc-days {
            font-size: 10px;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
        }

        .timeline-event.above {
            top: 0;
            flex-direction: column;
        }

        .timeline-event.above .timeline-card {
            order: 1;
        }

        .timeline-event.above .timeline-stem {
            order: 2;
        }

        .timeline-event.above .timeline-dot {
            order: 3;
        }

        .timeline-event.below {
            bottom: 0;
            flex-direction: column;
        }

        .timeline-event.below .timeline-dot {
            order: 1;
        }

        .timeline-event.below .timeline-stem {
            order: 2;
        }

        .timeline-event.below .timeline-card {
            order: 3;
        }

        .timeline-event.past {
            opacity: 0.5;
        }

        /* Timeline range bars */
        .timeline-range {
            position: absolute;
            height: 6px;
            border-radius: 3px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            opacity: 0.4;
            transition: opacity 0.15s;
        }

        .timeline-range:hover {
            opacity: 0.7;
        }

        .timeline-range-label {
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .timeline-event-days {
            font-size: 8px;
            font-weight: 600;
            padding: 1px 4px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            display: inline-block;
        }

        .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-secondary);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 2px;
        }

        /* ===== RESIZABLE PANELS ===== */
        .resize-handle {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 6px;
            cursor: col-resize;
            z-index: 50;
            background: transparent;
            transition: background 0.2s;
        }

        .resize-handle:hover,
        .resize-handle.active {
            background: var(--accent-gold);
        }

        .resize-handle-left {
            right: 0;
        }

        .resize-handle-right {
            left: 0;
        }

        /* ===== PROJECT CHAT ===== */
        .project-chat {
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-top: 20px;
        }

        .project-chat-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .project-chat-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            flex: 1;
            overflow-x: auto;
        }

        .project-chat-tab {
            padding: 6px 12px;
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 6px;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .project-chat-tab:hover {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .project-chat-tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .project-chat-tab .hash {
            color: var(--text-muted);
            margin-right: 2px;
        }

        .project-chat-tab .member-count {
            font-size: 10px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            padding: 1px 5px;
            border-radius: 8px;
            margin-left: 4px;
        }

        .project-chat-tab.active .member-count {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        .channel-members-btn {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .channel-members-btn:hover {
            border-color: var(--accent-gold);
            color: var(--text-secondary);
        }

        .member-picker-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 999;
        }

        .member-picker-overlay.active { display: block; }

        .member-picker {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            min-width: 220px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }

        .member-picker-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 8px 8px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 4px;
        }

        .member-picker-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
            transition: background 0.1s;
        }

        .member-picker-item:hover {
            background: var(--bg-tertiary);
        }

        .member-picker-item .mp-check {
            width: 16px;
            height: 16px;
            border: 1.5px solid var(--border);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: transparent;
            transition: all 0.15s;
            flex-shrink: 0;
        }

        .member-picker-item.selected .mp-check {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--bg-primary);
        }

        .member-picker-item .mp-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            color: var(--bg-primary);
            flex-shrink: 0;
        }

        .member-picker-actions {
            display: flex;
            gap: 6px;
            padding: 8px 4px 4px;
            border-top: 1px solid var(--border);
            margin-top: 4px;
        }

        .member-picker-actions button {
            flex: 1;
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
        }

        .mp-btn-save {
            background: var(--accent-gold);
            color: var(--bg-primary);
            font-weight: 600;
        }

        .mp-btn-save:hover { opacity: 0.9; }

        .mp-btn-cancel {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .mp-btn-cancel:hover { background: var(--border); }

        .mp-btn-all {
            background: none;
            color: var(--accent-gold);
            font-weight: 500;
            border: 1px solid var(--accent-gold) !important;
        }

        .mp-btn-all:hover { background: rgba(201,169,98,0.1); }

        .project-chat-messages {
            height: 200px;
            overflow-y: auto;
            padding: 12px 16px;
        }

        .project-chat-input {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        .project-chat-input input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .project-chat-input input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .project-chat-input button {
            background: var(--accent-gold);
            color: var(--bg-primary);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }

        /* ===== SIDEBAR SEARCH & QUICK ACTION ===== */
        .sidebar-actions {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 8px;
            position: relative;
        }

        .search-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px 8px 32px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.1);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 12px;
        }

        .search-results {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-item:hover {
            background: var(--bg-tertiary);
        }

        .search-result-type {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .search-result-title {
            font-size: 13px;
            font-weight: 500;
        }

        .quick-action-btn {
            width: 36px;
            height: 36px;
            background: var(--accent-gold);
            color: var(--bg-primary);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        }

        .quick-action-btn:hover {
            background: var(--accent-gold-dim);
        }

        .quick-action-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            right: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-width: 180px;
            z-index: 1000;
            display: none;
        }

        .quick-action-dropdown.active {
            display: block;
        }

        .quick-action-item {
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .quick-action-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .quick-action-item i {
            width: 16px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ===== FILE REPOSITORY ===== */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .file-item {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .file-item:hover {
            background: var(--bg-hover);
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .file-icon.pdf { color: #ef4444; }
        .file-icon.doc { color: #3b82f6; }
        .file-icon.ppt { color: #f97316; }
        .file-icon.img { color: #22c55e; }
        .file-icon.other { color: var(--text-muted); }

        .file-name {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .file-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        .file-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: var(--bg-secondary);
            border: none;
            border-radius: 6px;
            color: var(--text-muted);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }

        .file-item:hover .file-delete {
            display: flex;
        }

        .file-delete:hover {
            background: var(--danger);
            color: white;
        }

        .file-upload-zone {
            border: 2px dashed var(--border);
            border-radius: 10px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
        }

        .file-upload-zone:hover {
            border-color: var(--accent-gold);
            background: rgba(201, 169, 98, 0.05);
        }

        .file-upload-zone i {
            font-size: 24px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .file-upload-zone p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .file-upload-input {
            display: none;
        }

        /* ===== TASK GROUPS ===== */
        .task-group {
            margin-bottom: 20px;
        }

        .task-group:last-child {
            margin-bottom: 0;
        }

        .task-group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 8px;
            margin-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }

        .task-group-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .task-group-name {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .task-group-count {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: auto;
        }

        .pinned-tasks-section {
            background: rgba(201, 169, 98, 0.05);
            border: 1px solid rgba(201, 169, 98, 0.15);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 16px;
        }

        .pinned-tasks-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .pinned-tasks-section .task-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        /* ===== PROJECT PIN BUTTON ===== */
        .project-card {
            position: relative;
        }

        .pin-project-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            opacity: 0;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            transition: all 0.15s;
            z-index: 2;
        }

        .project-card:hover .pin-project-btn {
            opacity: 1;
        }

        .pin-project-btn:hover {
            background: var(--bg-hover);
            color: var(--accent-gold);
        }

        .pin-project-btn.pinned {
            opacity: 1;
            color: var(--accent-gold);
        }

        .pinned-projects .project-card {
            border-color: rgba(201, 169, 98, 0.3);
            background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(201, 169, 98, 0.03) 100%);
        }

        /* ===== CHAT PANEL ===== */
        .chat-panel {
            width: var(--chat-width, 340px);
            min-width: 280px;
            max-width: 500px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border);
            height: 100vh;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            position: relative;
        }

        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header h3 {
            font-size: 15px;
            font-weight: 600;
        }

        .chat-channel-name {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-channel-name .hash {
            color: var(--text-muted);
        }

        .chat-action-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .chat-action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .chat-action-btn.active {
            color: var(--accent-gold);
        }
        .chat-panel.hidden {
            display: none !important;
        }
        .chat-show-btn {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: var(--accent-gold);
            color: var(--bg-primary);
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .chat-show-btn:hover {
            transform: translateY(-2px);
        }
        .chat-show-btn.visible {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .chat-message {
            margin-bottom: 16px;
        }

        .chat-message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .chat-avatar {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .chat-sender {
            font-size: 13px;
            font-weight: 600;
        }

        .chat-time {
            font-size: 11px;
            color: var(--text-muted);
        }

        .chat-text {
            font-size: 14px;
            color: var(--text-secondary);
            padding-left: 36px;
        }

        .chat-input-wrapper {
            padding: 16px;
            border-top: 1px solid var(--border);
        }

        .chat-input-container {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.1);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .chat-send-btn {
            background: var(--accent-gold);
            color: var(--bg-primary);
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .chat-send-btn:hover {
            background: var(--accent-gold-dim);
        }

        .chat-empty {
            text-align: center;
            color: var(--text-muted);
            padding: 40px 20px;
        }

        .chat-empty i {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Team Members Strip in Chat */
        .chat-team-strip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            scrollbar-width: none;
        }

        .chat-team-strip::-webkit-scrollbar {
            display: none;
        }

        .chat-team-strip-label {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            white-space: nowrap;
            margin-right: 4px;
        }

        .team-member-bubble {
            position: relative;
            cursor: pointer;
            transition: transform 0.15s;
            flex-shrink: 0;
        }

        .team-member-bubble:hover {
            transform: scale(1.1);
        }

        .team-member-bubble.active {
            transform: scale(1.1);
        }

        .team-member-bubble.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: var(--accent-gold);
            border-radius: 50%;
        }

        .team-member-photo {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid transparent;
            transition: border-color 0.15s;
        }

        .team-member-bubble:hover .team-member-photo {
            border-color: var(--accent-gold);
        }

        .team-member-bubble.active .team-member-photo {
            border-color: var(--accent-gold);
        }

        .team-member-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 6px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.15s;
            pointer-events: none;
            z-index: 100;
            margin-bottom: 8px;
        }

        .team-member-bubble:hover .team-member-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .team-member-tooltip-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .team-member-tooltip-role {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* File upload button */
        .chat-file-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s;
        }

        .chat-file-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .chat-file-input {
            display: none;
        }

        /* File preview in chat */
        .chat-file {
            margin-top: 8px;
            padding-left: 36px;
        }

        .chat-file-image {
            max-width: 300px;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chat-file-image:hover {
            transform: scale(1.02);
        }

        .chat-file-attachment {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
        }

        .chat-file-attachment:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        .chat-file-attachment i {
            color: var(--accent-gold);
        }

        /* Upload progress */
        .chat-upload-progress {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .chat-upload-progress.active {
            display: flex;
        }

        .chat-upload-progress .progress-bar {
            flex: 1;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }

        .chat-upload-progress .progress-fill {
            height: 100%;
            background: var(--accent-gold);
            transition: width 0.3s;
        }

        .chat-upload-progress .progress-text {
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* DM indicator in header */
        .chat-dm-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-dm-back {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
        }

        .chat-dm-back:hover {
            color: var(--accent-gold);
        }

        /* Project Channel List in Chat Panel */
        .project-channel-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .project-channel-item {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border-radius: 16px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .project-channel-item:hover {
            background: var(--bg-hover);
        }

        .project-channel-item.active {
            background: var(--accent-gold);
            color: var(--bg-primary);
        }

        .project-channel-item .channel-hash {
            opacity: 0.7;
            font-weight: 600;
        }

        .project-channel-item.active .channel-hash {
            opacity: 1;
        }

        .no-channels {
            color: var(--text-muted);
            font-size: 12px;
            font-style: italic;
        }

        /* Sub-channel hierarchy styles */
        .project-chat-tab.sub-channel {
            padding-left: 28px;
            font-size: 11px;
            opacity: 0.85;
        }
        .project-chat-tab.sub-channel::before {
            content: '└ ';
            color: var(--text-muted);
            font-size: 10px;
        }
        .project-chat-tab.parent-channel {
            position: relative;
        }
        .project-chat-tab .toggle-children {
            font-size: 9px;
            margin-right: 4px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.15s;
        }
        .project-chat-tab .toggle-children:hover {
            opacity: 1;
        }
        .project-chat-tab .add-subchannel-btn {
            margin-left: 4px;
            font-size: 10px;
            opacity: 0;
            cursor: pointer;
            color: var(--text-muted);
            transition: opacity 0.15s;
        }
        .project-chat-tab:hover .add-subchannel-btn {
            opacity: 0.7;
        }
        .project-chat-tab .add-subchannel-btn:hover {
            opacity: 1;
            color: var(--accent-gold);
        }

        .project-channel-item.sub-channel {
            padding-left: 20px;
            font-size: 11px;
            opacity: 0.85;
        }
        .project-channel-item.sub-channel::before {
            content: '└ ';
            color: var(--text-muted);
            font-size: 10px;
        }
        .project-channel-item .add-subchannel-btn {
            margin-left: 4px;
            font-size: 10px;
            opacity: 0;
            cursor: pointer;
            color: var(--text-muted);
            transition: opacity 0.15s;
        }
        .project-channel-item:hover .add-subchannel-btn {
            opacity: 0.7;
        }
        .project-channel-item .add-subchannel-btn:hover {
            opacity: 1;
            color: var(--accent-gold);
        }

        /* ===== BACK LINK ===== */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 16px;
            cursor: pointer;
        }

        .back-link:hover {
            color: var(--accent-gold);
        }

        /* ===== EVENT ITEMS ===== */
        .event-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-item:hover {
            background: var(--bg-tertiary);
            margin: 0 -20px;
            padding: 14px 20px;
        }

        .event-date {
            width: 48px;
            text-align: center;
            flex-shrink: 0;
        }

        .event-date .day {
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-gold);
            line-height: 1;
        }

        .event-date .month {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .event-info {
            flex: 1;
        }

        .event-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .event-location {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ===== PHASE 5B: FORUM EVENT CARDS ===== */
        .forum-event-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }
        .forum-event-card:hover {
            border-color: var(--forum);
            box-shadow: 0 2px 12px rgba(251, 146, 60, 0.1);
        }
        .forum-event-card-header {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            margin-bottom: 12px;
        }
        .forum-event-date-block {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--forum), #f97316);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: white;
        }
        .forum-event-date-block .day { font-size: 20px; font-weight: 700; line-height: 1; }
        .forum-event-date-block .month { font-size: 10px; text-transform: uppercase; opacity: 0.9; }
        .forum-event-card-info { flex: 1; min-width: 0; }
        .forum-event-card-title { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .forum-event-card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        .forum-event-card-meta span { display: flex; align-items: center; gap: 4px; }
        .forum-event-badges { display: flex; gap: 6px; flex-wrap: wrap; }
        .forum-event-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        .forum-event-badge.type { background: rgba(251, 146, 60, 0.15); color: var(--forum); }
        .forum-event-badge.status-planning { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }
        .forum-event-badge.status-upcoming { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .forum-event-badge.status-open { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .forum-event-badge.status-ongoing { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
        .forum-event-badge.status-completed { background: rgba(107, 114, 128, 0.2); color: #6b7280; }
        .forum-event-badge.status-published { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .forum-event-badge.published { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .forum-event-badge.draft { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .forum-event-card-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }
        .forum-event-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .forum-event-stats {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .forum-event-stats span { display: flex; align-items: center; gap: 4px; }
        .forum-event-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .forum-event-toggle input[type="checkbox"] {
            width: 16px; height: 16px; accent-color: var(--forum);
        }
        .forum-events-grid {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        /* ===== STATUS ===== */
        .status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
        }

        .status.good {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .status.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .status.neutral {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        /* ===== TABLE ===== */
        .simple-table {
            width: 100%;
            border-collapse: collapse;
        }

        .simple-table th {
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.02);
        }

        .simple-table td {
            padding: 12px 16px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        .simple-table tr:last-child td {
            border-bottom: none;
        }

        .list-main {
            font-size: 14px;
        }

        .list-sub {
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 480px;
            max-height: 85vh;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2,
        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-tertiary);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-muted);
        }

        .modal-close:hover {
            background: var(--bg-hover);
        }

        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.1);
        }

        /* ===== SIMPLE LIST ===== */
        .simple-list {
            list-style: none;
        }

        .simple-list li {
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .simple-list li:last-child {
            border-bottom: none;
        }

        .list-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Doc Status */
        .doc-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .doc-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .doc-dot.complete {
            background: var(--success);
        }

        .doc-dot.pending {
            background: var(--warning);
        }

        .doc-dot.missing {
            background: var(--danger);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Add pinned section header */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-header h3 {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        /* ===== MOBILE MENU ===== */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 16px;
            align-items: center;
            justify-content: space-between;
            z-index: 200;
        }

        .mobile-menu-btn {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 20px;
            cursor: pointer;
        }

        .mobile-logo {
            font-weight: 700;
            font-size: 18px;
        }

        .mobile-logo span {
            color: var(--accent-gold);
        }

        .mobile-logo img {
            height: 24px;
            width: auto;
            filter: brightness(0) invert(1);
        }

        .mobile-chat-btn {
            width: 40px;
            height: 40px;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            position: relative;
        }

        .mobile-chat-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: var(--accent-gold);
            border-radius: 50%;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* ===== CHAT REPLY ===== */
        .chat-message-actions {
            position: absolute;
            right: 0;
            top: 0;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .chat-message:hover .chat-message-actions {
            opacity: 1;
        }

        .chat-reply-btn {
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        .chat-reply-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .chat-reply-preview {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent-gold);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 0 6px 6px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-reply-preview-text {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chat-reply-preview-name {
            font-weight: 600;
            color: var(--accent-gold);
            margin-right: 6px;
        }

        .chat-reply-cancel {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
        }

        .chat-message-reply-ref {
            background: var(--bg-tertiary);
            border-left: 2px solid var(--text-muted);
            padding: 4px 8px;
            margin-bottom: 4px;
            border-radius: 0 4px 4px 0;
            font-size: 11px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .chat-message-reply-ref:hover {
            background: var(--bg-hover);
        }

        .chat-message {
            position: relative;
        }

        /* ===== MOBILE RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .chat-panel {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .mobile-header {
                display: flex;
            }

            .app {
                flex-direction: column;
                padding-top: 56px;
            }

            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                transition: left 0.3s ease;
                z-index: 100;
            }

            .sidebar.open {
                left: 0;
            }

            .main-wrapper {
                margin-left: 0;
                flex-direction: column;
            }

            .main {
                max-width: 100%;
                padding: 16px;
                height: auto;
                min-height: calc(100vh - 56px);
            }

            .chat-panel {
                position: fixed;
                right: -100%;
                top: 56px;
                height: calc(100vh - 56px);
                width: 100%;
                transition: right 0.3s ease;
                z-index: 100;
            }

            .chat-panel.open {
                right: 0;
            }

            .pinned-grid {
                grid-template-columns: 1fr;
            }

            .stats-row {
                flex-wrap: wrap;
                gap: 16px;
            }

            .timeline-visual {
                min-width: 500px;
            }

            .timeline-event-card {
                min-width: 60px;
                max-width: 75px;
                padding: 4px 6px;
            }

            .timeline-event-name {
                font-size: 9px;
            }

            .file-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .page-header h1 {
                font-size: 20px;
            }

            .card-body {
                padding: 12px 16px;
            }

            .resize-handle {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .file-grid {
                grid-template-columns: 1fr;
            }

            .timeline-track {
                height: 70px;
            }

            .timeline-event-card {
                min-width: 50px;
                max-width: 65px;
                padding: 3px 4px;
            }

            .timeline-event-name {
                font-size: 8px;
            }

            .timeline-event-date,
            .timeline-event-days {
                font-size: 7px;
            }

            .sidebar-actions {
                padding: 8px;
            }

            .search-input {
                padding: 6px 10px 6px 28px;
                font-size: 12px;
            }

            .quick-action-btn {
                width: 32px;
                height: 32px;
            }
        }

        /* ===== PLEXUS CONFERENCE MANAGEMENT ===== */
        .plexus-tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 24px;
            overflow-x: auto;
            flex-wrap: nowrap;
        }

        .plexus-tab {
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .plexus-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .plexus-tab.active {
            background: var(--plexus);
            color: var(--bg-primary);
        }

        .plexus-tab i {
            font-size: 12px;
        }

        .plexus-content {
            display: none;
        }

        .plexus-content.active {
            display: block;
        }

        /* ===== ACCELERATOR KEY DATES TIMELINE ===== */
        .akd-timeline {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding: 8px 0;
        }
        .akd-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 14px 16px;
            position: relative;
            border-radius: 10px;
            transition: all 0.2s;
            cursor: default;
        }
        .akd-item:hover {
            background: var(--bg-secondary);
        }
        .akd-item::before {
            content: '';
            position: absolute;
            left: 23px;
            top: 38px;
            bottom: -14px;
            width: 2px;
            background: var(--border-color);
        }
        .akd-item:last-child::before {
            display: none;
        }
        /* Status: past */
        .akd-item.past {
            opacity: 0.5;
        }
        .akd-item.past .akd-marker {
            background: var(--text-muted) !important;
            box-shadow: none !important;
        }
        /* Status: today */
        .akd-item.today {
            background: rgba(34, 211, 238, 0.08);
            border: 1px solid rgba(34, 211, 238, 0.2);
        }
        .akd-item.today .akd-marker {
            animation: akdPulse 2s infinite;
        }
        /* Status: next upcoming */
        .akd-item.next .akd-marker {
            box-shadow: 0 0 0 4px rgba(34, 211, 238, 0.25);
        }
        @keyframes akdPulse {
            0%, 100% { box-shadow: 0 0 0 4px rgba(34, 211, 238, 0.3); }
            50% { box-shadow: 0 0 0 8px rgba(34, 211, 238, 0.1); }
        }
        /* Marker shapes */
        .akd-marker {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 3px;
            z-index: 1;
            transition: all 0.2s;
        }
        .akd-marker.diamond {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            transform: rotate(45deg);
            margin-top: 4px;
        }
        /* Category color overrides */
        .akd-item.cat-deadline .akd-marker { background: #ef4444; }
        .akd-item.cat-milestone .akd-marker { background: #c9a962; }
        .akd-item.cat-event .akd-marker { background: #22d3ee; }
        .akd-item.cat-deadline { border-left: 3px solid #ef4444; }
        .akd-item.cat-milestone { border-left: 3px solid #c9a962; }
        .akd-item.cat-event { border-left: 3px solid #22d3ee; }
        /* Content */
        .akd-content {
            flex: 1;
            min-width: 0;
        }
        .akd-date {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        .akd-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        .akd-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }
        .akd-badges {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
        }
        .akd-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
        }
        .akd-badge.today-badge { background: rgba(34, 211, 238, 0.2); color: #22d3ee; }
        .akd-badge.next-badge { background: rgba(201, 169, 98, 0.2); color: #c9a962; }
        .akd-badge.cat-badge-deadline { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .akd-badge.cat-badge-milestone { background: rgba(201, 169, 98, 0.15); color: #c9a962; }
        .akd-badge.cat-badge-event { background: rgba(34, 211, 238, 0.15); color: #22d3ee; }
        /* Inline editing */
        .akd-inline-input {
            background: var(--bg-secondary);
            border: 1px solid var(--accelerator);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: inherit;
            font-weight: inherit;
            padding: 2px 6px;
            outline: none;
            width: 100%;
        }
        .akd-inline-input:focus {
            box-shadow: 0 0 0 2px rgba(34, 211, 238, 0.3);
        }
        .akd-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.15s;
        }
        .akd-item:hover .akd-actions {
            opacity: 1;
        }
        /* Legend */
        .akd-legend {
            display: flex;
            gap: 16px;
            padding: 8px 0;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .akd-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }
        .akd-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .akd-legend-dot.diamond {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            transform: rotate(45deg);
        }

        /* ===== FINANCE TABS ===== */
        .tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 24px;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tab-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--finances);
            color: white;
        }

        .tab-btn i {
            font-size: 12px;
        }

        .finance-tab {
            display: none;
        }

        .finance-tab.active {
            display: block;
        }

        .plexus-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 900px) {
            .plexus-grid {
                grid-template-columns: 1fr;
            }
        }

        .plexus-stats-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 900px) {
            .plexus-stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 600px) {
            .plexus-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Dashboard Dynamic Cards Grid */
        .dashboard-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 16px;
        }
        .dashboard-dynamic-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-picker-item:hover {
            border-color: var(--accent-gold) !important;
            background: var(--bg-tertiary);
        }

        /* Pending Badges */
        .pending-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .pending-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .pending-badge:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .pending-badge.has-items {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        /* Data Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(255, 255, 255, 0.02);
        }

        .data-table tbody tr {
            transition: background 0.15s ease;
        }

        .data-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table .status {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }

        .data-table .status.paid {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .data-table .status.pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .data-table .status.cancelled {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .data-table .actions {
            display: flex;
            gap: 6px;
        }

        .data-table .actions button {
            padding: 4px 8px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 11px;
        }

        .data-table .actions button:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        /* Plexus Group/Sort/Filter Styles */
        .px-group-btn {
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 500;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }
        .px-group-btn:hover {
            border-color: var(--plexus);
            color: var(--plexus);
        }
        .px-group-btn.active {
            background: var(--plexus);
            color: #fff;
            border-color: var(--plexus);
        }
        .px-sortable {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        .px-sortable:hover {
            color: var(--plexus);
        }
        .px-sort-icon {
            font-size: 10px;
            margin-left: 2px;
            color: var(--plexus);
        }
        .px-group-section {
            margin-bottom: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .px-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: rgba(167, 139, 250, 0.1);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }
        .px-group-header:hover {
            background: rgba(167, 139, 250, 0.18);
        }
        .px-group-header-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--plexus);
        }
        .px-group-header-count {
            font-size: 12px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 2px 10px;
            border-radius: 10px;
        }
        .px-group-header .px-chevron {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: 8px;
            transition: transform 0.2s;
        }
        .px-group-header.collapsed .px-chevron {
            transform: rotate(-90deg);
        }
        .px-group-body {
            overflow: hidden;
            transition: max-height 0.2s ease;
        }
        .px-group-body.collapsed {
            max-height: 0 !important;
            overflow: hidden;
        }

        /* Schedule */
        .schedule-days {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .schedule-day-btn {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .schedule-day-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .schedule-day-btn.active {
            background: var(--plexus);
            color: var(--bg-primary);
        }

        .schedule-timeline {
            border-left: 2px solid var(--border);
            padding-left: 20px;
            margin-left: 10px;
        }

        .schedule-item {
            position: relative;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 16px;
        }

        .schedule-item::before {
            content: '';
            position: absolute;
            left: -27px;
            top: 20px;
            width: 12px;
            height: 12px;
            background: var(--plexus);
            border-radius: 50%;
            border: 2px solid var(--bg-primary);
        }

        .schedule-item .time {
            font-size: 12px;
            font-weight: 600;
            color: var(--plexus);
            margin-bottom: 4px;
        }

        .schedule-item .title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .schedule-item .location {
            font-size: 12px;
            color: var(--text-muted);
        }

        .schedule-item .speaker {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        /* Phase 3C: Calendar Grid Styles */
        .schedule-grid-wrapper {
            position: relative;
            overflow-x: auto;
        }
        .schedule-grid-container {
            display: grid;
            min-width: 600px;
            position: relative;
            background: var(--bg-tertiary);
            border-radius: 12px;
            overflow: hidden;
        }
        .schedule-grid-header {
            display: contents;
        }
        .schedule-grid-header-cell {
            padding: 10px 12px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 5;
        }
        .schedule-grid-time-label {
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-muted);
            text-align: right;
            border-right: 1px solid var(--border);
            background: var(--bg-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .schedule-grid-cell {
            border-bottom: 1px solid rgba(255,255,255,0.03);
            border-right: 1px solid rgba(255,255,255,0.03);
            min-height: 30px;
            position: relative;
            cursor: pointer;
            transition: background 0.1s;
        }
        .schedule-grid-cell:hover {
            background: rgba(167, 139, 250, 0.04);
        }
        .schedule-grid-cell.hour-mark {
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        .schedule-grid-room-col {
            position: relative;
        }
        .schedule-session-block {
            position: absolute;
            left: 2px;
            right: 2px;
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 11px;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.15s, box-shadow 0.15s;
            z-index: 2;
            border-left: 3px solid transparent;
        }
        .schedule-session-block:hover {
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        .schedule-session-block .session-block-title {
            font-weight: 700;
            font-size: 12px;
            line-height: 1.3;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .schedule-session-block .session-block-time {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 2px;
            font-weight: 500;
        }
        .schedule-session-block .session-block-speaker {
            font-size: 11px;
            opacity: 0.85;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .schedule-session-block .session-block-badges {
            display: flex;
            gap: 4px;
            margin-top: 2px;
        }
        .schedule-session-block .session-block-badge {
            font-size: 9px;
            padding: 1px 4px;
            border-radius: 3px;
            background: rgba(0,0,0,0.2);
        }
        .schedule-session-block.type-keynote { background: rgba(167, 139, 250, 0.55); border-left-color: #a78bfa; color: #ede9fe; }
        .schedule-session-block.type-panel { background: rgba(34, 211, 238, 0.50); border-left-color: #22d3ee; color: #ecfeff; }
        .schedule-session-block.type-workshop { background: rgba(251, 146, 60, 0.50); border-left-color: #fb923c; color: #fff7ed; }
        .schedule-session-block.type-poster_session { background: rgba(244, 114, 182, 0.50); border-left-color: #f472b6; color: #fdf2f8; }
        .schedule-session-block.type-break { background: rgba(255,255,255,0.08); border-left-color: rgba(255,255,255,0.4); color: var(--text-secondary); border-style: dashed; border-left-style: dashed; }
        .schedule-session-block.type-networking { background: rgba(16, 185, 129, 0.50); border-left-color: #10b981; color: #ecfdf5; }
        .schedule-session-block.type-talk { background: rgba(201, 169, 98, 0.50); border-left-color: #c9a962; color: #fef9ec; }
        .schedule-session-block.unpublished { opacity: 0.82; }
        .schedule-session-block.unpublished::after {
            content: 'DRAFT';
            position: absolute;
            top: 3px;
            right: 4px;
            font-size: 8px;
            font-weight: 700;
            background: rgba(255,255,255,0.2);
            padding: 1px 6px;
            border-radius: 3px;
            color: rgba(255,255,255,0.7);
        }

        .session-checkin-toggle {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .session-checkin-toggle:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .session-checkin-toggle.active {
            background: rgba(201, 169, 98, 0.2);
            color: var(--accent-gold);
            border-color: var(--accent-gold);
        }

        .session-checkin-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .session-checkin-card .session-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .session-checkin-card .session-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        .session-checkin-card .session-meta .count {
            color: var(--accent-gold);
            font-weight: 600;
        }
        .session-checkin-input-group {
            display: flex;
            gap: 8px;
        }
        .session-checkin-input-group input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
        }
        .session-checkin-input-group input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.1);
        }

        /* Speakers Grid */
        .speakers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
        }

        .speaker-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.15s;
        }

        .speaker-card:hover {
            background: var(--bg-hover);
        }

        .speaker-avatar {
            width: 64px;
            height: 64px;
            background: var(--plexus);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 22px;
            font-weight: 600;
            color: var(--bg-primary);
        }

        .speaker-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .speaker-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .speaker-org {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Sponsors */
        .sponsors-tiers {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .sponsor-tier {
            margin-bottom: 8px;
        }

        .sponsor-tier-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .sponsor-tier-label.gold { color: #fbbf24; }
        .sponsor-tier-label.silver { color: #94a3b8; }
        .sponsor-tier-label.bronze { color: #c2410c; }

        .sponsors-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .sponsor-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sponsor-logo {
            width: 48px;
            height: 48px;
            background: var(--bg-secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-muted);
        }

        .sponsor-name {
            font-size: 14px;
            font-weight: 600;
        }

        /* Sponsor Pipeline */
        .sponsor-pipeline-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        .sponsor-stat-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 14px 16px;
            text-align: center;
        }
        .sponsor-stat-card .stat-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text);
        }
        .sponsor-stat-card .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }
        .sponsor-pipeline-filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            align-items: center;
        }
        .sponsor-pipeline-filters .pipe-step {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-muted);
            transition: all 0.15s;
        }
        .sponsor-pipeline-filters .pipe-step:hover {
            border-color: var(--plexus);
            color: var(--text);
        }
        .sponsor-pipeline-filters .pipe-step.active {
            background: var(--plexus);
            border-color: var(--plexus);
            color: #fff;
        }
        .sponsor-pipeline-filters .pipe-step .pipe-count {
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 1px 7px;
            font-size: 11px;
            font-weight: 700;
        }
        .sponsor-pipeline-filters .pipe-step.active .pipe-count {
            background: rgba(255,255,255,0.25);
        }
        .sponsor-pipeline-filters .pipe-arrow {
            color: var(--text-muted);
            font-size: 10px;
            opacity: 0.4;
        }
        .sponsor-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 14px;
        }
        .sponsor-pipeline-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            transition: border-color 0.15s;
        }
        .sponsor-pipeline-card:hover {
            border-color: var(--plexus);
        }
        .sponsor-pipeline-card .sp-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .sponsor-pipeline-card .sp-logo {
            width: 44px;
            height: 44px;
            background: var(--bg-secondary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-muted);
            flex-shrink: 0;
            overflow: hidden;
        }
        .sponsor-pipeline-card .sp-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        .sponsor-pipeline-card .sp-info {
            flex: 1;
            min-width: 0;
        }
        .sponsor-pipeline-card .sp-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sponsor-pipeline-card .sp-name a {
            color: var(--text);
            text-decoration: none;
        }
        .sponsor-pipeline-card .sp-name a:hover {
            color: var(--plexus);
        }
        .sponsor-pipeline-card .sp-badges {
            display: flex;
            gap: 6px;
            margin-top: 4px;
            flex-wrap: wrap;
        }
        .sp-tier-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .sp-tier-badge.gold { background: rgba(201,169,98,0.15); color: #c9a962; }
        .sp-tier-badge.silver { background: rgba(148,163,184,0.15); color: #94a3b8; }
        .sp-tier-badge.bronze { background: rgba(180,83,9,0.15); color: #b45309; }
        .sp-tier-badge.partner { background: rgba(167,139,250,0.15); color: #a78bfa; }
        .sp-status-pill {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .sp-status-pill.prospect { background: rgba(100,116,139,0.15); color: #94a3b8; }
        .sp-status-pill.contacted { background: rgba(59,130,246,0.15); color: #60a5fa; }
        .sp-status-pill.negotiating { background: rgba(234,179,8,0.15); color: #facc15; }
        .sp-status-pill.confirmed { background: rgba(34,197,94,0.15); color: #4ade80; }
        .sp-status-pill.fulfilled { background: rgba(167,139,250,0.15); color: #a78bfa; }

        .sponsor-pipeline-card .sp-contact {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sponsor-pipeline-card .sp-contact a {
            color: var(--text-secondary);
            text-decoration: none;
        }
        .sponsor-pipeline-card .sp-contact a:hover {
            color: var(--plexus);
        }
        .sponsor-pipeline-card .sp-financial {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 10px;
        }
        .sponsor-pipeline-card .sp-financial-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .sponsor-pipeline-card .sp-financial-row span {
            font-weight: 600;
            color: var(--text);
        }
        .sponsor-pipeline-card .sp-progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
        }
        .sponsor-pipeline-card .sp-progress-fill {
            height: 100%;
            border-radius: 2px;
            background: linear-gradient(90deg, var(--plexus), #c9a962);
            transition: width 0.3s;
        }
        .sponsor-pipeline-card .sp-tasks-section {
            margin-bottom: 10px;
        }
        .sponsor-pipeline-card .sp-tasks-toggle {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 6px;
        }
        .sponsor-pipeline-card .sp-tasks-toggle:hover {
            color: var(--text);
        }
        .sponsor-pipeline-card .sp-task-list {
            display: none;
        }
        .sponsor-pipeline-card .sp-task-list.open {
            display: block;
        }
        .sponsor-pipeline-card .sp-task-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .sponsor-pipeline-card .sp-task-item input[type="checkbox"] {
            accent-color: var(--plexus);
            cursor: pointer;
        }
        .sponsor-pipeline-card .sp-task-item.done {
            text-decoration: line-through;
            opacity: 0.5;
        }
        .sponsor-pipeline-card .sp-task-item .sp-task-due {
            margin-left: auto;
            font-size: 10px;
            color: var(--text-muted);
        }
        .sponsor-pipeline-card .sp-add-task {
            display: flex;
            gap: 6px;
            margin-top: 6px;
        }
        .sponsor-pipeline-card .sp-add-task input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            color: var(--text);
            outline: none;
        }
        .sponsor-pipeline-card .sp-add-task input:focus {
            border-color: var(--plexus);
        }
        .sponsor-pipeline-card .sp-add-task button {
            background: var(--plexus);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
        }
        .sponsor-pipeline-card .sp-notes-toggle {
            font-size: 11px;
            color: var(--text-muted);
            cursor: pointer;
            margin-bottom: 6px;
        }
        .sponsor-pipeline-card .sp-notes-toggle:hover {
            color: var(--text);
        }
        .sponsor-pipeline-card .sp-notes-content {
            display: none;
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .sponsor-pipeline-card .sp-notes-content.open {
            display: block;
        }
        .sponsor-pipeline-card .sp-actions {
            display: flex;
            gap: 6px;
            border-top: 1px solid var(--border);
            padding-top: 10px;
        }
        .sponsor-pipeline-card .sp-actions button {
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-muted);
            transition: all 0.15s;
        }
        .sponsor-pipeline-card .sp-actions button:hover {
            border-color: var(--plexus);
            color: var(--text);
        }
        .sponsor-pipeline-card .sp-actions button.sp-publish {
            background: rgba(34,197,94,0.1);
            border-color: rgba(34,197,94,0.3);
            color: #4ade80;
        }
        .sponsor-pipeline-card .sp-actions button.sp-unpublish {
            background: rgba(234,179,8,0.1);
            border-color: rgba(234,179,8,0.3);
            color: #facc15;
        }
        .sponsor-pipeline-card .sp-actions button.sp-delete {
            margin-left: auto;
            background: rgba(239,68,68,0.1);
            border-color: rgba(239,68,68,0.3);
            color: #f87171;
        }

        /* Check-in */
        .checkin-panel {
            text-align: center;
        }

        .checkin-input-group {
            display: flex;
            gap: 12px;
            max-width: 500px;
            margin: 0 auto 20px;
        }

        .checkin-input {
            flex: 1;
            padding: 14px 18px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: inherit;
        }

        .checkin-input:focus {
            outline: none;
            border-color: var(--plexus);
            box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.1);
        }

        .checkin-result {
            padding: 16px;
            border-radius: 10px;
            margin-top: 16px;
        }

        .checkin-result.success {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .checkin-result.error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .checkin-result.already {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .checkin-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
        }

        .checkin-stat {
            text-align: center;
        }

        .checkin-stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--plexus);
            display: block;
        }

        .checkin-stat span:not(.checkin-stat-value) {
            font-size: 12px;
            color: var(--text-muted);
        }

        .recent-checkins {
            margin-top: 16px;
        }

        .recent-checkin-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .recent-checkin-item .check-icon {
            width: 32px;
            height: 32px;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--success);
        }

        .recent-checkin-item .info {
            flex: 1;
        }

        .recent-checkin-item .name {
            font-size: 14px;
            font-weight: 500;
        }

        .recent-checkin-item .time {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Empty State for tables */
        .table-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .table-empty i {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Forum Tab Styles */
        .forum-tabs .forum-tab.active {
            background: var(--forum);
            color: var(--bg-primary);
        }

        .forum-tabs .forum-tab:hover:not(.active) {
            background: var(--bg-tertiary);
        }

        /* Forum Members Group Buttons — override plexus purple with forum orange */
        #forum-members .px-group-btn:hover {
            border-color: var(--forum);
            color: var(--forum);
        }
        #forum-members .px-group-btn.active {
            background: var(--forum);
            color: #fff;
            border-color: var(--forum);
        }
        /* Forum Group Headers */
        .fm-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: rgba(251, 146, 60, 0.1);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }
        .fm-group-header:hover {
            background: rgba(251, 146, 60, 0.18);
        }
        .fm-group-header-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--forum);
        }
        .fm-group-header-count {
            font-size: 12px;
            color: var(--text-muted);
            background: var(--bg-tertiary);
            padding: 2px 10px;
            border-radius: 10px;
        }
        .fm-group-header .fm-chevron {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: 8px;
            transition: transform 0.2s;
        }
        .fm-group-header.collapsed .fm-chevron {
            transform: rotate(-90deg);
        }
        .fm-group-body.collapsed {
            display: none;
        }

        /* Feed Post Styles */
        .feed-post {
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .feed-post-header {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .feed-post-avatar {
            width: 40px;
            height: 40px;
            background: var(--forum);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--bg-primary);
            font-weight: 600;
        }

        .feed-post-actions {
            display: flex;
            gap: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        /* Group Card Styles */
        .group-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.15s;
        }

        .group-card:hover {
            background: var(--bg-hover);
        }

        .group-icon {
            width: 64px;
            height: 64px;
            background: var(--forum);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 24px;
            color: var(--bg-primary);
        }
        /* QR Scanner Styles */
        .qr-scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
        }
        .qr-scanner-container video { border-radius: 12px; }
        #qr-reader { width: 100% !important; }
        #qr-reader__scan_region { min-height: 250px; }
        #qr-reader__dashboard { padding: 8px !important; }
        #qr-reader__dashboard_section { padding: 4px !important; }
        #qr-reader__dashboard_section_csr button {
            background: var(--accent) !important; color: #fff !important;
            border: none !important; padding: 8px 16px !important;
            border-radius: 6px !important; cursor: pointer !important;
        }
        .checkin-camera-section { text-align: center; margin-bottom: 20px; }
        .checkin-camera-toggle {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border);
            background: var(--bg-secondary); color: var(--text-primary);
            cursor: pointer; font-size: 14px; margin-bottom: 12px;
        }
        .checkin-camera-toggle.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .checkin-result.success { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #22c55e; padding: 16px; border-radius: 8px; margin-top: 12px; }
        .checkin-result.error { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 16px; border-radius: 8px; margin-top: 12px; }
        .checkin-result.already { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); color: #f59e0b; padding: 16px; border-radius: 8px; margin-top: 12px; }
        .checkin-attendee-info { margin-top: 8px; font-size: 14px; }
        .checkin-attendee-info .name { font-size: 18px; font-weight: 700; }
        .checkin-attendee-info .detail { color: var(--text-muted); margin-top: 4px; }
        /* Speaker doc badges */
        .doc-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
        .doc-badge.has { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .doc-badge.missing { background: rgba(107, 114, 128, 0.15); color: #6b7280; }

        /* ===== GLOBAL QR SCANNER FAB ===== */
        .qr-fab {
            position: fixed;
            bottom: 28px;
            right: 28px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--accent-gold);
            color: #0f172a;
            border: none;
            font-size: 22px;
            cursor: pointer;
            box-shadow: 0 4px 14px rgba(201, 169, 98, 0.4);
            z-index: 900;
            display: none;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .qr-fab:hover {
            transform: scale(1.08);
            box-shadow: 0 6px 20px rgba(201, 169, 98, 0.55);
        }
        .qr-fab:active { transform: scale(0.95); }

        .qr-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.15s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .qr-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 24px;
            position: relative;
        }
        .qr-modal-close {
            position: absolute;
            top: 12px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
        }
        .qr-modal-close:hover { color: var(--text-primary); }
        .qr-modal h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .qr-modal h3 i { color: var(--accent-gold); }
        .qr-modal .qr-viewfinder {
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 16px;
            min-height: 280px;
            background: var(--bg-primary);
        }
        .qr-modal .manual-entry {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .qr-modal .manual-entry input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .qr-modal .manual-entry input:focus { border-color: var(--accent-gold); box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.1); }
        .qr-modal .manual-entry button {
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            background: var(--accent-gold);
            color: #0f172a;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        .qr-modal .manual-entry button:hover { opacity: 0.9; }
        .qr-modal #globalCheckinResult { margin-top: 14px; }

        /* Stats bar */
        .qr-stats-bar {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 14px;
        }
        .qr-stats-bar .qr-stats-overall {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .qr-stats-bar .qr-stats-overall .qr-stats-pct { color: var(--accent-gold); }
        .qr-progress {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        .qr-progress-fill {
            height: 100%;
            background: var(--accent-gold);
            border-radius: 3px;
            transition: width 0.4s ease;
        }
        .qr-stats-events {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .qr-stats-events .qr-stat-chip {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 6px;
            background: rgba(255,255,255,0.05);
            color: var(--text-muted);
        }
        .qr-stat-chip .qr-stat-count { font-weight: 600; color: var(--text-primary); }

        /* Tabs */
        .qr-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 14px;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 3px;
        }
        .qr-tab-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .qr-tab-btn.active {
            background: var(--accent-gold);
            color: #0f172a;
        }
        .qr-tab-btn:not(.active):hover { background: rgba(255,255,255,0.05); }

        /* Search results */
        .qr-search-input {
            width: 100%;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            margin-bottom: 10px;
            box-sizing: border-box;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .qr-search-input:focus { border-color: var(--accent-gold); box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.1); }
        .qr-search-results {
            max-height: 220px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .qr-search-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            gap: 8px;
        }
        .qr-search-row .qr-sr-info { flex: 1; min-width: 0; }
        .qr-search-row .qr-sr-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .qr-search-row .qr-sr-detail { font-size: 11px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .qr-search-row .qr-sr-btn {
            padding: 5px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        .qr-sr-btn.checkin { background: var(--accent-gold); color: #0f172a; }
        .qr-sr-btn.checkin:hover { opacity: 0.9; }
        .qr-sr-btn.checked { background: rgba(74,222,128,0.15); color: #4ade80; cursor: default; }

        /* Recent check-ins */
        .qr-recent-list {
            margin-top: 14px;
            border-top: 1px solid var(--border);
            padding-top: 10px;
        }
        .qr-recent-list h4 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .qr-recent-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 0;
            font-size: 12px;
        }
        .qr-recent-item .qr-ri-time { color: var(--text-muted); min-width: 42px; }
        .qr-recent-item .qr-ri-name { flex: 1; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Undo button */
        .qr-undo-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            padding: 5px 14px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .qr-undo-btn:hover { border-color: var(--accent-gold); color: var(--text-primary); }

        /* Offline banner */
        .qr-offline-banner {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: rgba(251,146,60,0.15);
            border: 1px solid rgba(251,146,60,0.3);
            border-radius: 8px;
            font-size: 12px;
            color: #fb923c;
            margin-top: 10px;
        }
        .qr-offline-banner .qr-flush-btn {
            margin-left: auto;
            padding: 3px 10px;
            border-radius: 4px;
            border: 1px solid rgba(251,146,60,0.4);
            background: transparent;
            color: #fb923c;
            font-size: 11px;
            cursor: pointer;
        }

        /* FAB badge for offline queue */
        .qr-fab-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            background: #ef4444;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }
        .event-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .event-badge.plexus { background: rgba(167,139,250,0.2); color: #a78bfa; }
        .event-badge.gala { background: rgba(201,169,98,0.2); color: #c9a962; }
        .event-badge.forum { background: rgba(251,146,60,0.2); color: #fb923c; }
        .event-badge.bridges { background: rgba(244,114,182,0.2); color: #f472b6; }

        /* Live pulse dot */
        .live-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            margin-right: 6px;
            animation: livePulse 2s ease-in-out infinite;
        }
        @keyframes livePulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); }
            50% { opacity: 0.7; box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }
        .toast {
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 500;
            color: #fff;
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            animation: toastIn 0.35s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            max-width: 380px;
            min-width: 240px;
        }
        .toast.removing {
            animation: toastOut 0.3s ease forwards;
        }
        .toast.success { background: rgba(16, 185, 129, 0.9); }
        .toast.error { background: rgba(239, 68, 68, 0.9); }
        .toast.warning { background: rgba(245, 158, 11, 0.9); }
        .toast.info { background: rgba(59, 130, 246, 0.9); }
        .toast i { font-size: 16px; flex-shrink: 0; }
        .toast-close {
            margin-left: auto;
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            padding: 2px;
            font-size: 14px;
        }
        .toast-close:hover { color: #fff; }
        @keyframes toastIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes toastOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Loading Skeletons */
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.03) 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s ease-in-out infinite;
            border-radius: 8px;
        }
        .skeleton-card {
            height: 120px;
            border-radius: 12px;
            margin-bottom: 12px;
        }
        .skeleton-row {
            height: 40px;
            margin-bottom: 8px;
        }
        .skeleton-text {
            height: 14px;
            width: 60%;
            margin-bottom: 8px;
        }
        .skeleton-text.short { width: 30%; }
        .skeleton-text.long { width: 85%; }
        .skeleton-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        @keyframes skeletonShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ===== CMD+K COMMAND PALETTE ===== */
        .cmd-palette-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 20000;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 18vh;
        }
        .cmd-palette-overlay.active { display: flex; }
        .cmd-palette {
            width: 560px;
            max-width: 92vw;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 24px 64px rgba(0,0,0,0.5), 0 0 0 1px rgba(201,169,98,0.08);
            overflow: hidden;
            animation: cmdPaletteIn 0.18s ease;
        }
        @keyframes cmdPaletteIn {
            from { opacity: 0; transform: scale(0.96) translateY(-8px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .cmd-palette-input-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
        }
        .cmd-palette-input-wrap i { color: var(--text-muted); font-size: 15px; }
        .cmd-palette-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 15px;
            color: var(--text-primary);
            font-family: inherit;
        }
        .cmd-palette-input::placeholder { color: var(--text-muted); }
        .cmd-palette-kbd {
            font-size: 11px;
            color: var(--text-muted);
            background: rgba(255,255,255,0.05);
            padding: 2px 7px;
            border-radius: 5px;
            border: 1px solid var(--border);
            font-family: inherit;
        }
        .cmd-palette-results {
            max-height: 360px;
            overflow-y: auto;
            padding: 6px;
        }
        .cmd-palette-results::-webkit-scrollbar { width: 4px; }
        .cmd-palette-results::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
        .cmd-palette-group {
            padding: 6px 12px 4px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            font-weight: 600;
        }
        .cmd-palette-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.12s;
        }
        .cmd-palette-item:hover,
        .cmd-palette-item.selected {
            background: rgba(201,169,98,0.1);
        }
        .cmd-palette-item.selected {
            outline: 1px solid rgba(201,169,98,0.25);
        }
        .cmd-palette-item-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            flex-shrink: 0;
        }
        .cmd-palette-item-text { flex: 1; min-width: 0; }
        .cmd-palette-item-title { font-size: 13px; font-weight: 500; color: var(--text-primary); }
        .cmd-palette-item-sub { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
        .cmd-palette-item-shortcut {
            font-size: 11px;
            color: var(--text-muted);
            background: rgba(255,255,255,0.04);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }
        .cmd-palette-empty {
            padding: 32px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }
        .cmd-palette-footer {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 8px 16px;
            border-top: 1px solid var(--border);
            font-size: 11px;
            color: var(--text-muted);
        }
        .cmd-palette-footer span { display: flex; align-items: center; gap: 4px; }
        .cmd-palette-footer kbd {
            background: rgba(255,255,255,0.05);
            padding: 1px 5px;
            border-radius: 3px;
            border: 1px solid var(--border);
            font-family: inherit;
            font-size: 10px;
        }

        /* ===== BREADCRUMBS ===== */
        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 0 12px;
            font-size: 12px;
            color: var(--text-muted);
            min-height: 24px;
        }
        .breadcrumbs:empty { display: none; }
        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: color 0.15s;
        }
        .breadcrumb-item:hover { color: var(--accent-gold); }
        .breadcrumb-item.current {
            color: var(--text-primary);
            font-weight: 500;
            cursor: default;
        }
        .breadcrumb-item.current:hover { color: var(--text-primary); }
        .breadcrumb-sep { color: var(--text-muted); opacity: 0.4; font-size: 10px; }

        /* ===== UNSAVED CHANGES INDICATOR ===== */
        .unsaved-bar {
            position: fixed;
            bottom: 0;
            left: var(--sidebar-width, 260px);
            right: 0;
            background: rgba(245, 158, 11, 0.95);
            backdrop-filter: blur(8px);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 500;
            z-index: 9000;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .unsaved-bar.visible { transform: translateY(0); }
        .unsaved-bar i { font-size: 14px; }
        .unsaved-bar-actions { display: flex; gap: 8px; margin-left: 12px; }
        .unsaved-bar-actions button {
            padding: 5px 14px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.15s;
        }
        .unsaved-bar-actions button:hover { opacity: 0.85; }
        .unsaved-bar-actions .btn-save { background: #fff; color: #b45309; }
        .unsaved-bar-actions .btn-discard { background: rgba(255,255,255,0.2); color: #fff; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.5); }
    </style>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <!-- CMD+K COMMAND PALETTE -->
    <div class="cmd-palette-overlay" id="cmdPalette" onclick="CmdPalette.close(event)">
        <div class="cmd-palette" onclick="event.stopPropagation()">
            <div class="cmd-palette-input-wrap">
                <i class="fas fa-search"></i>
                <input class="cmd-palette-input" id="cmdPaletteInput" type="text" placeholder="Search sections, tabs, actions..." autocomplete="off" oninput="CmdPalette.filter()" onkeydown="CmdPalette.handleKey(event)">
                <span class="cmd-palette-kbd">esc</span>
            </div>
            <div class="cmd-palette-results" id="cmdPaletteResults"></div>
            <div class="cmd-palette-footer">
                <span><kbd>&uarr;</kbd><kbd>&darr;</kbd> Navigate</span>
                <span><kbd>&crarr;</kbd> Open</span>
                <span><kbd>esc</kbd> Close</span>
            </div>
        </div>
    </div>

    <!-- UNSAVED CHANGES BAR -->
    <div class="unsaved-bar" id="unsavedBar">
        <i class="fas fa-exclamation-circle"></i>
        You have unsaved changes
        <div class="unsaved-bar-actions">
            <button class="btn-discard" onclick="UnsavedChanges.discard()">Discard</button>
        </div>
    </div>

    <!-- LOGIN PAGE -->
    <div class="login-page" id="loginPage">
        <div class="login-card">
            <div class="login-logo">
                <img src="assets/images/medx-logo.png" alt="Med&X">
                <p>Admin Portal</p>
            </div>

            <div class="login-error" id="loginError">Invalid email or password</div>

            <form class="login-form" onsubmit="App.login(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="juginovic.alen@gmail.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="login-btn">Sign In</button>
            </form>
        </div>
    </div>

    <!-- ONBOARDING MODAL -->
    <div class="onboarding-overlay" id="onboardingOverlay">
        <div class="onboarding-card">
            <h2>Welcome, <span id="onboardingName">there</span>!</h2>
            <p class="onboarding-subtitle">Choose the sections you work with. You can change this anytime.</p>
            <div class="section-grid" id="onboardingGrid"></div>
            <div class="onboarding-actions">
                <button class="onboarding-btn onboarding-btn-primary" id="onboardingSubmit" onclick="App.saveOnboarding()" disabled>Get Started</button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="settings-overlay" id="settingsOverlay">
        <div class="settings-card">
            <div class="settings-header">
                <h2>Settings</h2>
                <button class="settings-close" onclick="App.closeSettings()"><i class="fas fa-times"></i></button>
            </div>
            <div class="settings-tabs">
                <button class="settings-tab active" data-tab="profile" onclick="App.switchSettingsTab('profile')">Profile</button>
                <button class="settings-tab" data-tab="security" onclick="App.switchSettingsTab('security')">Security</button>
                <button class="settings-tab" data-tab="sections" onclick="App.switchSettingsTab('sections')">Sections</button>
            </div>
            <div class="settings-body">
                <!-- Profile Tab -->
                <div class="settings-pane active" id="settingsProfile">
                    <div class="settings-form">
                        <div class="form-group">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-input" id="settingsFirstName">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-input" id="settingsLastName">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Institution</label>
                            <input type="text" class="form-input" id="settingsInstitution">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="text" class="form-input" id="settingsPhone">
                        </div>
                        <div class="settings-feedback" id="profileFeedback"></div>
                        <button class="onboarding-btn onboarding-btn-primary" onclick="App.saveProfile()">Save Changes</button>
                    </div>
                </div>
                <!-- Security Tab -->
                <div class="settings-pane" id="settingsSecurity">
                    <div class="settings-form">
                        <div class="form-group">
                            <label class="form-label">Current Password</label>
                            <input type="password" class="form-input" id="settingsCurrentPw" placeholder="Enter current password">
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-input" id="settingsNewPw" placeholder="At least 6 characters">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" class="form-input" id="settingsConfirmPw" placeholder="Repeat new password">
                        </div>
                        <div class="settings-feedback" id="securityFeedback"></div>
                        <button class="onboarding-btn onboarding-btn-primary" onclick="App.changePassword()">Update Password</button>
                    </div>
                </div>
                <!-- Sections Tab -->
                <div class="settings-pane" id="settingsSections">
                    <p class="onboarding-subtitle" style="margin-bottom: 16px;">Choose the sections you work with.</p>
                    <div class="section-grid" id="settingsSectionsGrid"></div>
                    <div class="settings-feedback" id="sectionsFeedback"></div>
                    <button class="onboarding-btn onboarding-btn-primary" onclick="App.saveSections()" style="margin-top: 16px;">Save Sections</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app" id="mainApp">
        <!-- Global QR Scanner FAB -->
        <button id="globalQRBtn" class="qr-fab" onclick="App.openGlobalQRScanner()" title="Scan QR Check-in">
            <i class="fas fa-qrcode"></i>
        </button>

        <!-- Mobile Header -->
        <header class="mobile-header">
            <button class="mobile-menu-btn" onclick="App.toggleMobileMenu()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="mobile-logo"><img src="assets/images/medx-logo.png" alt="Med&X" style="height: 28px; width: auto;"></div>
            <button class="mobile-chat-btn" onclick="App.toggleMobileChat()">
                <i class="fas fa-comment"></i>
                <span class="mobile-chat-badge" id="mobileChatBadge" style="display: none;"></span>
            </button>
        </header>

        <!-- Sidebar Overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="App.toggleMobileMenu()"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="resize-handle resize-handle-left" id="sidebarResizeHandle"></div>
            <div class="logo-row">
                <div class="logo"><img src="assets/images/medx-logo.png" alt="Med&X"></div>
                <div class="clock-widget" onclick="App.toggleTimerDropdown(event)">
                    <div class="swiss-clock">
                        <div class="clock-face">
                            <div class="hour-hand" id="clockHour"></div>
                            <div class="minute-hand" id="clockMinute"></div>
                            <div class="second-hand" id="clockSecond"></div>
                            <div class="center-dot"></div>
                        </div>
                    </div>
                    <span class="clock-timer" id="clockTimer">25:00</span>
                    <div class="timer-dropdown" id="timerDropdown">
                        <h4>Focus Timer</h4>
                        <div class="timer-presets" id="timerPresets">
                            <button class="timer-preset" onclick="App.startTimer(15, event)">15m</button>
                            <button class="timer-preset" onclick="App.startTimer(25, event)">25m</button>
                            <button class="timer-preset" onclick="App.startTimer(45, event)">45m</button>
                            <button class="timer-preset" onclick="App.startTimer(60, event)">60m</button>
                        </div>
                        <div class="timer-extend" id="timerExtend" style="display: none;">
                            <p style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Time's up! Extend?</p>
                            <div class="timer-presets">
                                <button class="timer-preset" onclick="App.startTimer(15, event)">+15m</button>
                                <button class="timer-preset" onclick="App.startTimer(25, event)">+25m</button>
                                <button class="timer-preset" onclick="App.startTimer(45, event)">+45m</button>
                            </div>
                            <button class="timer-done-btn" onclick="App.dismissTimerPrompt(event)">I'm done</button>
                        </div>
                        <button class="timer-cancel" id="timerCancel" onclick="App.cancelTimer(event)">Cancel Timer</button>
                    </div>
                </div>
            </div>

            <!-- Search & Quick Action -->
            <div class="sidebar-actions">
                <div class="search-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="globalSearch" placeholder="Search..." oninput="App.handleSearch(this.value)">
                    <div class="search-results" id="searchResults"></div>
                </div>
                <button class="quick-action-btn" onclick="App.toggleQuickAction(event)" title="Quick actions">
                    <i class="fas fa-plus"></i>
                </button>
                <div class="quick-action-dropdown" id="quickActionDropdown">
                    <div class="quick-action-item" onclick="App.launchCustomShortcut()" id="customShortcutItem">
                        <i class="fas fa-video" id="customShortcutIcon"></i>
                        <span id="customShortcutLabel">Start Zoom Call</span>
                    </div>
                    <div class="quick-action-item" onclick="App.editCustomShortcut()">
                        <i class="fas fa-cog"></i>
                        <span>Edit Shortcut</span>
                    </div>
                    <div style="border-top: 1px solid var(--border-color); margin: 6px 0;"></div>
                    <div class="quick-action-item" onclick="App.quickAddTask()">
                        <i class="fas fa-check-square"></i>
                        <span>New Task</span>
                    </div>
                    <div class="quick-action-item" onclick="App.quickAddFolder()">
                        <i class="fas fa-folder-plus"></i>
                        <span>New Folder</span>
                    </div>
                    <div class="quick-action-item" onclick="App.openFileUpload()">
                        <i class="fas fa-upload"></i>
                        <span>Upload File</span>
                    </div>
                    <div class="quick-action-item" onclick="App.showSection('dashboard'); document.getElementById('quickActionDropdown').classList.remove('active');">
                        <i class="fas fa-home"></i>
                        <span>Go to Home</span>
                    </div>
                </div>
            </div>

            <nav class="nav" id="sidebarNav">
                <a class="nav-item active" onclick="App.showSection('dashboard', this)">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>

                <div class="nav-divider"></div>
                <div class="nav-label">Projects</div>

                <div id="projectsList"></div>

                <div class="nav-divider"></div>
                <div class="nav-label">Organization</div>

                <a class="nav-item" data-section="finances" onclick="App.showSection('finances', this)">
                    <i class="fas fa-coins" style="color: var(--finances);"></i>
                    <span>Finances</span>
                </a>

                <a class="nav-item" data-section="pr-media" onclick="App.showSection('pr-media', this)">
                    <i class="fas fa-bullhorn" style="color: var(--pr-media);"></i>
                    <span>PR & Media</span>
                </a>

                <a class="nav-item" data-section="user-notifications" onclick="App.showSection('user-notifications', this)">
                    <i class="fas fa-paper-plane" style="color: #22d3ee;"></i>
                    <span>Notifications</span>
                    <span id="userNotifCount" style="background: #ef4444; color: white; padding: 1px 6px; border-radius: 10px; font-size: 10px; font-weight: 600; margin-left: auto; display: none;">0</span>
                </a>

                <a class="nav-item" data-section="newsletter" onclick="App.showSection('newsletter', this)">
                    <i class="fas fa-envelope-open-text" style="color: #10b981;"></i>
                    <span>Newsletter</span>
                </a>

                <a class="nav-item" data-section="portal-content" onclick="App.showSection('portal-content', this)">
                    <i class="fas fa-th-large" style="color: #c9a962;"></i>
                    <span>Portal Content</span>
                </a>

                <a class="nav-item" data-section="messages" onclick="App.showSection('messages', this)">
                    <i class="fas fa-envelope" style="color: #a78bfa;"></i>
                    <span>Messages</span>
                </a>

                <a class="nav-item" data-section="gala" onclick="App.showSection('gala', this)">
                    <i class="fas fa-glass-cheers" style="color: #C9A962;"></i>
                    <span>Gala Evening</span>
                    <span id="galaPendingCount" style="background: #f59e0b; color: white; padding: 1px 6px; border-radius: 10px; font-size: 10px; font-weight: 600; margin-left: auto; display: none;">0</span>
                </a>
            </nav>

            <!-- My Network Button -->
            <div id="networkSection" data-section="contacts" style="padding: 12px 16px; border-top: 1px solid var(--border);">
                <button class="btn btn-secondary" onclick="NetworkApp.openPanel()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 10px;">
                    <i class="fas fa-address-book" style="color: var(--accent-gold);"></i>
                    <span>My Network</span>
                    <span id="networkCount" style="background: var(--accent-gold); color: var(--bg-primary); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600;">0</span>
                </button>
            </div>

            <div class="user-section">
                <div class="user-card">
                    <div class="user-avatar" id="userAvatar">AJ</div>
                    <div>
                        <div class="user-name" id="userName">Alen Juginovic</div>
                        <div class="user-role" id="userRole">President</div>
                    </div>
                    <button class="manage-sections-btn" onclick="App.openSettings()" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="logout-btn" onclick="App.logout()" title="Sign out">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="main-wrapper">
            <main class="main">
                <!-- BREADCRUMBS -->
                <div class="breadcrumbs" id="breadcrumbs"></div>

                <!-- DASHBOARD -->
                <div class="section active" id="section-dashboard">
                    <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h1 id="welcomeHeader">Welcome back</h1>
                            <p>Here's what needs your attention</p>
                        </div>
                        <div style="position: relative;">
                            <button class="btn btn-secondary" onclick="App.toggleWidgetMenu()" id="widgetMenuBtn" title="Customize dashboard">
                                <i class="fas fa-cog"></i> Customize
                            </button>
                            <div id="widgetMenu" style="display:none; position:absolute; right:0; top:40px; background:var(--bg-secondary); border:1px solid var(--border); border-radius:12px; padding:16px; min-width:220px; z-index:100; box-shadow:0 8px 32px rgba(0,0,0,0.3);">
                                <div style="font-size:12px; font-weight:600; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:12px;">Show / Hide Cards</div>
                                <label style="display:flex; align-items:center; gap:10px; padding:8px 4px; cursor:pointer; font-size:13px; color:var(--text-primary); border-bottom:1px solid var(--border);">
                                    <input type="checkbox" checked onchange="App.toggleWidget('dashTimeline', this.checked)"> <i class="fas fa-calendar-alt" style="color:var(--accent-gold);width:16px;"></i> Timeline
                                </label>
                                <label style="display:flex; align-items:center; gap:10px; padding:8px 4px; cursor:pointer; font-size:13px; color:var(--text-primary); border-bottom:1px solid var(--border);">
                                    <input type="checkbox" checked onchange="App.toggleWidget('dashTodo', this.checked)"> <i class="fas fa-check-circle" style="color:var(--success);width:16px;"></i> To Do
                                </label>
                                <label style="display:flex; align-items:center; gap:10px; padding:8px 4px; cursor:pointer; font-size:13px; color:var(--text-primary); border-bottom:1px solid var(--border);">
                                    <input type="checkbox" checked onchange="App.toggleWidget('dashSequences', this.checked)"> <i class="fas fa-stream" style="color:var(--plexus);width:16px;"></i> Sequences
                                </label>
                                <label style="display:flex; align-items:center; gap:10px; padding:8px 4px; cursor:pointer; font-size:13px; color:var(--text-primary);">
                                    <input type="checkbox" checked onchange="App.toggleWidget('dashNotes', this.checked)"> <i class="fas fa-sticky-note" style="color:var(--warning);width:16px;"></i> Notes & Activity
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Pinned Items (from any project) -->
                    <div id="pinnedItemsSection" style="display: none; margin-bottom: 24px;">
                        <div class="section-header" style="margin-bottom: 12px;">
                            <h3 style="font-size: 14px; font-weight: 600;"><i class="fas fa-thumbtack" style="margin-right: 6px; color: var(--accent-gold);"></i> Pinned Items</h3>
                        </div>
                        <div class="pinned-grid" id="pinnedItemsGrid"></div>
                    </div>

                    <!-- Pinned Projects -->
                    <div id="pinnedProjectsSection" style="display: none;">
                        <div class="section-header">
                            <h3><i class="fas fa-star" style="margin-right: 6px;"></i> Priority Projects</h3>
                        </div>
                        <div class="project-list pinned-projects" id="pinnedProjectsList"></div>
                    </div>

                    <!-- Assigned Travel Orders (for traveler) -->
                    <div id="myTravelOrdersSection" style="display: none; margin-bottom: 24px;">
                        <div class="card" style="border-left: 4px solid var(--warning);">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-plane-departure" style="color: var(--warning); margin-right: 8px;"></i>Your Travel Orders</span>
                            </div>
                            <div class="card-body" id="myTravelOrdersList"></div>
                        </div>
                    </div>

                    <!-- Timeline -->
                    <div class="card" id="dashTimeline">
                        <div class="card-header">
                            <span class="card-title">Timeline</span>
                            <div class="timeline-today-marker">
                                <i class="fas fa-calendar-day"></i>
                                <span id="todayDate">Today</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="timeline" id="timelineContainer"></div>
                        </div>
                    </div>

                    <!-- Tasks -->
                    <div class="card" id="dashTodo">
                        <div class="card-header">
                            <span class="card-title">To Do</span>
                            <button class="btn btn-secondary" onclick="App.openTaskModal()">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <div class="card-body" id="dashboardTasks">
                            <div class="empty-state">
                                <i class="fas fa-check-circle"></i>
                                <p>Loading tasks...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Sequence Tasks -->
                    <div class="card" id="dashSequences">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-stream" style="margin-right: 8px;"></i>Sequences</span>
                            <button class="btn btn-secondary" onclick="App.openSequenceModal()">
                                <i class="fas fa-plus"></i> New
                            </button>
                        </div>
                        <div class="card-body" id="dashboardSequences">
                            <div class="empty-state">
                                <i class="fas fa-stream"></i>
                                <p>No active sequences</p>
                            </div>
                        </div>
                    </div>

                    <!-- Finance Summary (hidden from dashboard — access via Finance section) -->
                    <div class="card" style="display: none;">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-coins" style="margin-right: 8px; color: var(--finances);"></i>Finance Overview</span>
                            <button class="btn btn-secondary" onclick="App.showProject('finances')" style="font-size: 11px;">
                                <i class="fas fa-arrow-right"></i> Details
                            </button>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Balance</div>
                                    <div style="font-size: 16px; font-weight: 600;" id="dashFinBalance">—</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Income</div>
                                    <div style="font-size: 16px; font-weight: 600; color: var(--success);" id="dashFinIncome">—</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Expenses</div>
                                    <div style="font-size: 16px; font-weight: 600; color: var(--danger);" id="dashFinExpenses">—</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Net</div>
                                    <div style="font-size: 16px; font-weight: 600;" id="dashFinNet">—</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Portal Pulse -->
                    <div class="card" id="portalPulseCard">
                        <div class="card-header">
                            <span class="card-title"><span class="live-dot"></span><i class="fas fa-bolt pulse-icon" style="margin-right: 8px;"></i>Portal Pulse</span>
                            <button class="pulse-refresh" onclick="App.loadPortalStats()" title="Refresh stats">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="card-body" id="portalPulseBody">
                            <div style="text-align: center; color: var(--text-muted); padding: 20px;">Loading stats...</div>
                        </div>
                    </div>

                    <!-- Dashboard Charts & Notes -->
                    <div id="dashNotes">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px;">
                        <div class="card" style="grid-column: span 1;">
                            <div class="card-header">
                                <span class="card-title"><span class="live-dot"></span> Project Activity</span>
                            </div>
                            <div class="card-body" style="height: 260px;">
                                <canvas id="dashProjectChart"></canvas>
                            </div>
                        </div>
                        <div class="card" style="grid-column: span 1;">
                            <div class="card-header">
                                <span class="card-title">Registration Trends</span>
                            </div>
                            <div class="card-body" style="height: 260px;">
                                <canvas id="dashTrendChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Canvas -->
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-sticky-note" style="margin-right: 8px;"></i>Notes</span>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" id="notesSaveStatus" style="font-size: 11px; padding: 4px 8px; pointer-events: none; opacity: 0;">
                                    <i class="fas fa-check"></i> Saved
                                </button>
                            </div>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <textarea id="notesCanvas" placeholder="Write your notes here... (auto-saves)" style="width: 100%; min-height: 200px; max-height: 400px; resize: vertical; background: var(--bg-primary); border: none; border-radius: 0 0 8px 8px; padding: 16px; color: var(--text-primary); font-family: inherit; font-size: 14px; line-height: 1.6;" oninput="App.saveNotes()"></textarea>
                        </div>
                    </div>
                    </div><!-- /dashNotes -->

                    <!-- Dynamic Dashboard Cards -->
                    <div id="homeDashboardCards" style="margin-top: 16px;"></div>

                </div>

                <!-- PLEXUS CONFERENCE MANAGEMENT -->
                <div class="section" id="section-plexus">
                    <div class="back-link" onclick="App.showSection('dashboard')">
                        <i class="fas fa-arrow-left"></i> Back to Home
                    </div>
                    <div class="page-header">
                        <h1>Plexus Conference 2026</h1>
                        <p>December 4-5, 2026 in Zagreb</p>
                    </div>

                    <!-- Plexus Sub-Navigation -->
                    <div class="plexus-tabs">
                        <button class="plexus-tab active" onclick="App.showPlexusTab('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
                        <button class="plexus-tab" onclick="App.showPlexusTab('registrations')"><i class="fas fa-users"></i> Registrations</button>
                        <button class="plexus-tab" onclick="App.showPlexusTab('abstracts')"><i class="fas fa-file-alt"></i> Abstracts</button>
                        <button class="plexus-tab" onclick="App.showPlexusTab('schedule')"><i class="fas fa-calendar-alt"></i> Schedule</button>
                        <button class="plexus-tab" onclick="App.showPlexusTab('speakers')"><i class="fas fa-microphone"></i> Speakers</button>
                        <button class="plexus-tab" onclick="App.showPlexusTab('sponsors')"><i class="fas fa-handshake"></i> Sponsors</button>
                        <button class="plexus-tab" onclick="App.showPlexusTab('volunteers')"><i class="fas fa-hand-holding-heart"></i> Volunteers</button>
                        <button class="plexus-tab" onclick="App.showPlexusTab('checkin')"><i class="fas fa-qrcode"></i> Check-in</button>
                        <button class="plexus-tab" onclick="App.showPlexusTab('pending')"><i class="fas fa-tasks"></i> Pending</button>
                        <button class="plexus-tab" onclick="App.showPlexusTab('settings')"><i class="fas fa-cog"></i> Settings</button>
                    </div>

                    <!-- DASHBOARD TAB -->
                    <div class="plexus-content active" id="plexus-dashboard">
                        <div class="stats-row plexus-stats-grid" id="plexusStatsGrid">
                            <div class="stat-item"><div class="stat-value" id="pxStatReg">-</div><div class="stat-label">Registered</div></div>
                            <div class="stat-item"><div class="stat-value" id="pxStatPaid">-</div><div class="stat-label">Paid</div></div>
                            <div class="stat-item"><div class="stat-value" id="pxStatChecked">-</div><div class="stat-label">Checked In</div></div>
                            <div class="stat-item" style="border-left: 3px solid var(--accent-gold);"><div class="stat-value" id="pxStatRevenue">-</div><div class="stat-label">Revenue (EUR)</div></div>
                            <div class="stat-item"><div class="stat-value" id="pxStatAbstracts">-</div><div class="stat-label">Abstracts</div></div>
                            <div class="stat-item"><div class="stat-value" id="pxStatAccepted">-</div><div class="stat-label">Accepted</div></div>
                        </div>

                        <div class="plexus-grid">
                            <div class="card">
                                <div class="card-header"><span class="card-title">Registrations by Type</span></div>
                                <div class="card-body" id="pxChartByType" style="height: 280px;"><canvas id="pxChartByTypeCanvas"></canvas></div>
                            </div>
                            <div class="card">
                                <div class="card-header"><span class="card-title">Top Countries</span></div>
                                <div class="card-body" id="pxChartByCountry" style="height: 280px;"><canvas id="pxChartByCountryCanvas"></canvas></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Pending Actions</span>
                            </div>
                            <div class="card-body" id="pxPendingQuick">
                                <div class="pending-badges">
                                    <span class="pending-badge" id="pxPendingRefunds">0 Refunds</span>
                                    <span class="pending-badge" id="pxPendingVisas">0 Visa Requests</span>
                                    <span class="pending-badge" id="pxPendingScholarships">0 Scholarships</span>
                                    <span class="pending-badge" id="pxPendingSpeakers">0 Speaker Apps</span>
                                </div>
                            </div>
                        </div>

                        <div class="plexus-grid">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Tasks</span>
                                    <button class="btn btn-secondary" onclick="App.openTaskModal('plexus')"><i class="fas fa-plus"></i> Add</button>
                                </div>
                                <div class="card-body" id="plexusTasks"></div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Files</span>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-secondary" onclick="App.createFolder('plexus')"><i class="fas fa-folder-plus"></i></button>
                                        <button class="btn btn-secondary" onclick="App.triggerFileUpload('plexus')"><i class="fas fa-upload"></i></button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="file-grid" id="plexusFiles"></div>
                                    <input type="file" class="file-upload-input" id="fileUpload-plexus" onchange="App.uploadFile('plexus', this.files[0])">
                                </div>
                            </div>
                        </div>

                        <!-- Project Timeline -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>Project Timeline</span>
                                <button class="btn btn-secondary" onclick="App.openTimelineEventModal('plexus')"><i class="fas fa-plus"></i> Add Event</button>
                            </div>
                            <div class="card-body" id="plexusTimeline" style="padding: 12px;"></div>
                        </div>

                        <!-- Dynamic Dashboard Cards -->
                        <div id="plexusDashboardCards" style="margin-top: 16px;"></div>

                    </div>

                    <!-- REGISTRATIONS TAB -->
                    <div class="plexus-content" id="plexus-registrations">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">All Registrations</span>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" onclick="App.exportPlexusRegistrations()"><i class="fas fa-download"></i> Export</button>
                                    <button class="btn btn-primary" onclick="App.openManualRegistration()"><i class="fas fa-plus"></i> Add</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Filter Bar -->
                                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; align-items: center;">
                                    <input type="text" class="search-input" id="pxRegSearch" placeholder="Search name, email, institution..." oninput="App.filterPlexusRegistrations()" style="width: 220px; padding-left: 12px;">
                                    <select class="search-input" id="pxRegStatusFilter" onchange="App.filterPlexusRegistrations()" style="width: auto; padding-left: 8px;">
                                        <option value="">All Status</option>
                                        <option value="confirmed">Confirmed</option>
                                        <option value="pending">Pending</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                    <select class="search-input" id="pxRegCountryFilter" onchange="App.filterPlexusRegistrations()" style="width: auto; padding-left: 8px;">
                                        <option value="">All Countries</option>
                                    </select>
                                    <select class="search-input" id="pxRegInstitutionFilter" onchange="App.filterPlexusRegistrations()" style="width: auto; padding-left: 8px;">
                                        <option value="">All Institutions</option>
                                    </select>
                                    <select class="search-input" id="pxRegTicketFilter" onchange="App.filterPlexusRegistrations()" style="width: auto; padding-left: 8px;">
                                        <option value="">All Tickets</option>
                                    </select>
                                    <select class="search-input" id="pxRegPaymentFilter" onchange="App.filterPlexusRegistrations()" style="width: auto; padding-left: 8px;">
                                        <option value="">All Payments</option>
                                        <option value="paid">Paid</option>
                                        <option value="pending">Pending</option>
                                        <option value="refunded">Refunded</option>
                                    </select>
                                    <button class="btn btn-secondary" onclick="App.clearRegFilters()" style="font-size: 12px; padding: 6px 10px;"><i class="fas fa-times"></i> Clear</button>
                                </div>
                                <!-- Group By Toggle -->
                                <div style="display: flex; gap: 6px; margin-bottom: 14px; align-items: center;">
                                    <span style="font-size: 12px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Group by:</span>
                                    <button class="px-group-btn active" data-group="none" onclick="App.groupPlexusRegistrations('none')">None</button>
                                    <button class="px-group-btn" data-group="status" onclick="App.groupPlexusRegistrations('status')">Status</button>
                                    <button class="px-group-btn" data-group="country" onclick="App.groupPlexusRegistrations('country')">Country</button>
                                    <button class="px-group-btn" data-group="ticket_type" onclick="App.groupPlexusRegistrations('ticket_type')">Ticket Type</button>
                                </div>
                                <!-- Table / Grouped View -->
                                <div id="pxRegGroupedContainer"></div>
                                <table class="data-table" id="pxRegTable">
                                    <thead>
                                        <tr>
                                            <th class="px-sortable" onclick="App.sortPlexusRegistrations('name')">Name <span class="px-sort-icon" id="pxRegSort-name"></span></th>
                                            <th class="px-sortable" onclick="App.sortPlexusRegistrations('email')">Email <span class="px-sort-icon" id="pxRegSort-email"></span></th>
                                            <th class="px-sortable" onclick="App.sortPlexusRegistrations('institution')">Institution <span class="px-sort-icon" id="pxRegSort-institution"></span></th>
                                            <th class="px-sortable" onclick="App.sortPlexusRegistrations('ticket_type')">Ticket <span class="px-sort-icon" id="pxRegSort-ticket_type"></span></th>
                                            <th class="px-sortable" onclick="App.sortPlexusRegistrations('status')">Status <span class="px-sort-icon" id="pxRegSort-status"></span></th>
                                            <th class="px-sortable" onclick="App.sortPlexusRegistrations('payment_status')">Payment <span class="px-sort-icon" id="pxRegSort-payment_status"></span></th>
                                            <th>Checked In</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pxRegTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ABSTRACTS TAB -->
                    <div class="plexus-content" id="plexus-abstracts">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Abstract Submissions</span>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" onclick="App.exportPlexusAbstracts()"><i class="fas fa-download"></i> Export CSV</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Filter Bar -->
                                <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; align-items: center;">
                                    <input type="text" class="search-input" id="pxAbsSearch" placeholder="Search title, submitter..." oninput="App.filterPlexusAbstracts()" style="width: 220px; padding-left: 12px;">
                                    <select class="search-input" id="pxAbsStatusFilter" onchange="App.filterPlexusAbstracts()" style="width: auto; padding-left: 8px;">
                                        <option value="">All Status</option>
                                        <option value="submitted">Submitted</option>
                                        <option value="under_review">Under Review</option>
                                        <option value="accepted">Accepted</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                    <select class="search-input" id="pxAbsTypeFilter" onchange="App.filterPlexusAbstracts()" style="width: auto; padding-left: 8px;">
                                        <option value="">All Types</option>
                                        <option value="Oral">Oral</option>
                                        <option value="Poster">Poster</option>
                                    </select>
                                    <select class="search-input" id="pxAbsCategoryFilter" onchange="App.filterPlexusAbstracts()" style="width: auto; padding-left: 8px;">
                                        <option value="">All Categories</option>
                                    </select>
                                    <button class="btn btn-secondary" onclick="App.clearAbsFilters()" style="font-size: 12px; padding: 6px 10px;"><i class="fas fa-times"></i> Clear</button>
                                </div>
                                <!-- Group By Toggle -->
                                <div style="display: flex; gap: 6px; margin-bottom: 14px; align-items: center;">
                                    <span style="font-size: 12px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Group by:</span>
                                    <button class="px-group-btn active" data-group="none" onclick="App.groupPlexusAbstracts('none')">None</button>
                                    <button class="px-group-btn" data-group="status" onclick="App.groupPlexusAbstracts('status')">Status</button>
                                    <button class="px-group-btn" data-group="category" onclick="App.groupPlexusAbstracts('category')">Category</button>
                                </div>
                                <!-- Table / Grouped View -->
                                <div id="pxAbsGroupedContainer"></div>
                                <table class="data-table" id="pxAbsTable">
                                    <thead>
                                        <tr>
                                            <th class="px-sortable" onclick="App.sortPlexusAbstracts('title')">Title <span class="px-sort-icon" id="pxAbsSort-title"></span></th>
                                            <th class="px-sortable" onclick="App.sortPlexusAbstracts('submitter')">Submitter <span class="px-sort-icon" id="pxAbsSort-submitter"></span></th>
                                            <th class="px-sortable" onclick="App.sortPlexusAbstracts('type')">Type <span class="px-sort-icon" id="pxAbsSort-type"></span></th>
                                            <th class="px-sortable" onclick="App.sortPlexusAbstracts('category')">Category <span class="px-sort-icon" id="pxAbsSort-category"></span></th>
                                            <th class="px-sortable" onclick="App.sortPlexusAbstracts('status')">Status <span class="px-sort-icon" id="pxAbsSort-status"></span></th>
                                            <th>Reviews</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pxAbsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- SCHEDULE TAB — Phase 3C Calendar Grid -->
                    <div class="plexus-content" id="plexus-schedule">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Conference Schedule</span>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" onclick="App.bulkPublishSessions()"><i class="fas fa-globe"></i> Publish All</button>
                                    <button class="btn btn-secondary" onclick="App.sendQuickNotification('plexus', 'plexus-schedule')" title="Send notification about schedule update"><i class="fas fa-bell"></i> Notify</button>
                                    <button class="btn btn-primary" onclick="App.openSessionModal()"><i class="fas fa-plus"></i> Add Session</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="schedule-days">
                                    <button class="schedule-day-btn active" onclick="App.showScheduleDay(1)">Day 1 - Dec 4</button>
                                    <button class="schedule-day-btn" onclick="App.showScheduleDay(2)">Day 2 - Dec 5</button>
                                </div>
                                <div class="schedule-grid-wrapper" id="pxScheduleGridWrapper"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Session Modal -->
                    <div class="modal" id="sessionModal">
                        <div class="modal-content" style="max-width: 560px;">
                            <div class="modal-header">
                                <h3 id="sessionModalTitle">Add Session</h3>
                                <button class="modal-close" onclick="App.closeModal('sessionModal')"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="modal-body" style="display: flex; flex-direction: column; gap: 12px;">
                                <div>
                                    <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Title *</label>
                                    <input type="text" class="search-input" id="sessionTitle" placeholder="Session title" style="width: 100%;">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Type</label>
                                        <select class="search-input" id="sessionType" style="width: 100%;">
                                            <option value="keynote">Keynote</option>
                                            <option value="panel">Panel</option>
                                            <option value="workshop">Workshop</option>
                                            <option value="poster_session">Poster Session</option>
                                            <option value="break">Break</option>
                                            <option value="networking">Networking</option>
                                            <option value="talk">Talk</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Day</label>
                                        <select class="search-input" id="sessionDay" style="width: 100%;">
                                            <option value="1">Day 1 - Dec 4</option>
                                            <option value="2">Day 2 - Dec 5</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Start Time *</label>
                                        <input type="time" class="search-input" id="sessionStartTime" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">End Time *</label>
                                        <input type="time" class="search-input" id="sessionEndTime" style="width: 100%;">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Room</label>
                                        <input type="text" class="search-input" id="sessionRoom" placeholder="e.g. Main Hall" list="roomSuggestions" style="width: 100%;">
                                        <datalist id="roomSuggestions"></datalist>
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Capacity</label>
                                        <input type="number" class="search-input" id="sessionCapacity" placeholder="Optional" style="width: 100%;">
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Speaker(s)</label>
                                    <select class="search-input" id="sessionSpeakers" multiple style="width: 100%; min-height: 60px;"></select>
                                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px;">Hold Ctrl/Cmd to select multiple</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Description</label>
                                    <textarea class="search-input" id="sessionDescription" rows="3" placeholder="Session description..." style="width: 100%; resize: vertical;"></textarea>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label style="font-size: 12px; color: var(--text-secondary);">Published</label>
                                    <input type="checkbox" id="sessionPublished">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="App.closeModal('sessionModal')">Cancel</button>
                                <button class="btn btn-primary" onclick="App.saveSession()"><i class="fas fa-check"></i> Save Session</button>
                            </div>
                        </div>
                    </div>

                    <!-- SPEAKERS TAB -->
                    <div class="plexus-content" id="plexus-speakers">
                        <!-- Document Summary -->
                        <div id="pxSpeakerDocSummary" style="margin-bottom: 16px; padding: 12px 16px; background: var(--bg-secondary); border-radius: 8px; font-size: 14px; color: var(--text-muted); display: none;">
                            <i class="fas fa-file-alt" style="margin-right: 8px;"></i>
                            <span id="pxSpeakerDocSummaryText"></span>
                        </div>

                        <div class="card">
                            <div class="card-header" style="flex-wrap: wrap; gap: 8px;">
                                <span class="card-title">Speakers</span>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                                    <select class="search-input" id="pxSpeakerYearFilter" onchange="App.filterSpeakers()" style="width: auto; padding: 6px 10px; font-size: 12px;">
                                        <option value="all">All Years</option>
                                        <option value="2026" selected>2026</option>
                                        <option value="2025">2025</option>
                                        <option value="2024">2024</option>
                                    </select>
                                    <input type="text" class="search-input" id="pxSpeakerSearch" placeholder="Search name/institution..." oninput="App.filterSpeakers()" style="width: 180px; padding: 6px 10px; font-size: 12px;">
                                    <select class="search-input" id="pxSpeakerPublishFilter" onchange="App.filterSpeakers()" style="width: auto; padding: 6px 10px; font-size: 12px;">
                                        <option value="">All Status</option>
                                        <option value="published">Published</option>
                                        <option value="unpublished">Unpublished</option>
                                    </select>
                                    <button class="btn btn-secondary" onclick="App.openSpeakerImportModal()" title="Import from CSV" style="padding: 6px 10px; font-size: 12px;">
                                        <i class="fas fa-file-upload"></i> Import CSV
                                    </button>
                                    <button class="btn btn-secondary" id="pxSpeakerInviteBtn" onclick="App.openSpeakerInviteModal()" title="Send invitation email to selected speakers" style="padding: 6px 10px; font-size: 12px; display: none;">
                                        <i class="fas fa-envelope"></i> Invite Selected (<span id="pxSpeakerSelectedCount">0</span>)
                                    </button>
                                    <button class="btn btn-secondary" onclick="App.sendQuickNotification('plexus', 'plexus-speaker')" title="Send notification to users about speakers" style="padding: 6px 10px; font-size: 12px;">
                                        <i class="fas fa-bell"></i> Notify
                                    </button>
                                    <button class="btn btn-primary" onclick="App.openSpeakerModal()" style="padding: 6px 12px; font-size: 12px;">
                                        <i class="fas fa-plus"></i> Add Speaker
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="speakers-grid" id="pxSpeakersGrid"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Speaker Import Modal -->
                    <div class="modal-overlay" id="speakerImportModal" style="display: none;" onclick="if(event.target===this) App.closeModal('speakerImportModal');">
                        <div class="modal" style="max-width: 640px;">
                            <div class="modal-header">
                                <h3>Import Speakers from CSV</h3>
                                <button class="modal-close" onclick="App.closeModal('speakerImportModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">
                                    Upload a CSV file with columns: <code style="color: var(--accent-gold);">name, title, institution, email, bio, speaker_type, is_keynote</code>
                                </p>
                                <div class="form-group">
                                    <label>Year</label>
                                    <select id="speakerImportYear" style="width: 120px;">
                                        <option value="2026" selected>2026</option>
                                        <option value="2025">2025</option>
                                        <option value="2024">2024</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>CSV File</label>
                                    <input type="file" id="speakerImportFile" accept=".csv,.txt" style="color: var(--text-primary);" onchange="App.previewSpeakerImport()">
                                </div>
                                <div id="speakerImportPreview" style="max-height: 300px; overflow-y: auto; margin-top: 12px;"></div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="App.closeModal('speakerImportModal')">Cancel</button>
                                <button class="btn btn-primary" id="speakerImportBtn" onclick="App.importSpeakers()" disabled><i class="fas fa-upload"></i> Import All</button>
                            </div>
                        </div>
                    </div>

                    <!-- Speaker Invitation Email Modal -->
                    <div class="modal-overlay" id="speakerInviteModal" style="display: none;" onclick="if(event.target===this) App.closeModal('speakerInviteModal');">
                        <div class="modal" style="max-width: 640px;">
                            <div class="modal-header">
                                <h3>Send Speaker Invitations</h3>
                                <button class="modal-close" onclick="App.closeModal('speakerInviteModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div id="speakerInviteList" style="margin-bottom: 16px; max-height: 150px; overflow-y: auto;"></div>
                                <div class="form-group">
                                    <label>Subject</label>
                                    <input type="text" id="speakerInviteSubject" value="Invitation to Speak at Plexus Conference 2026" style="width: 100%;">
                                </div>
                                <div class="form-group">
                                    <label>Body <span style="font-size: 11px; color: var(--text-muted);">(Use {{name}}, {{institution}}, {{conference}} for personalization)</span></label>
                                    <textarea id="speakerInviteBody" rows="10" style="width: 100%; font-size: 13px; line-height: 1.6;">Dear {{name}},

On behalf of Med&amp;X, we are delighted to invite you to speak at the {{conference}}, taking place in Zagreb, Croatia on December 4-5, 2026.

Your expertise and contributions to the field would make an invaluable addition to our program. Plexus brings together leading researchers, clinicians, and innovators from over 30 countries to exchange ideas and forge collaborations that bridge biomedical disciplines.

We would be honored to have you join us as a speaker. Please let us know if you are interested and available.

Warm regards,
Alen Juginovic, MD
President, Med&amp;X</textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="App.closeModal('speakerInviteModal')">Cancel</button>
                                <button class="btn btn-primary" onclick="App.sendSpeakerInvitations()"><i class="fas fa-paper-plane"></i> Send to All Selected</button>
                            </div>
                        </div>
                    </div>

                    <!-- SPONSORS TAB -->
                    <div class="plexus-content" id="plexus-sponsors">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Sponsor Pipeline</span>
                                <button class="btn btn-primary" onclick="App.openSponsorModal()"><i class="fas fa-plus"></i> Add Sponsor</button>
                            </div>
                            <div class="card-body">
                                <!-- Summary Stats -->
                                <div class="sponsor-pipeline-stats" id="pxSponsorStats"></div>
                                <!-- Pipeline Filters -->
                                <div class="sponsor-pipeline-filters" id="pxSponsorPipeline"></div>
                                <!-- Sponsor Cards -->
                                <div class="sponsor-cards-grid" id="pxSponsorsGrid"></div>
                            </div>
                        </div>
                    </div>

                    <!-- VOLUNTEERS TAB -->
                    <div class="plexus-content" id="plexus-volunteers">
                        <div class="plexus-grid">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Volunteer Applications</span>
                                    <button class="btn btn-secondary" onclick="App.exportPlexusVolunteers()"><i class="fas fa-download"></i> Export CSV</button>
                                </div>
                                <div class="card-body">
                                    <table class="data-table">
                                        <thead><tr><th>Name</th><th>Email</th><th>Availability</th><th>Status</th><th>Actions</th></tr></thead>
                                        <tbody id="pxVolunteersTable"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Shifts</span>
                                    <button class="btn btn-primary" onclick="App.openShiftModal()"><i class="fas fa-plus"></i> Add Shift</button>
                                </div>
                                <div class="card-body" id="pxShiftsList"></div>
                            </div>
                        </div>
                    </div>

                    <!-- CHECK-IN TAB -->
                    <div class="plexus-content" id="plexus-checkin">
                        <div class="plexus-grid">
                            <div class="card">
                                <div class="card-header"><span class="card-title"><i class="fas fa-qrcode" style="margin-right: 8px;"></i>Quick Check-in</span></div>
                                <div class="card-body checkin-panel">
                                    <div class="checkin-camera-section">
                                        <button class="checkin-camera-toggle" id="pxCameraToggle" onclick="App.toggleQRScanner('plexus')">
                                            <i class="fas fa-camera"></i> <span>Enable Camera</span>
                                        </button>
                                        <div id="qr-reader-plexus" style="display: none;"></div>
                                    </div>
                                    <div class="checkin-input-group">
                                        <input type="text" id="pxCheckinInput" class="checkin-input" placeholder="Scan QR code or enter registration ID...">
                                        <button class="btn btn-primary" onclick="App.performCheckin('plexus')"><i class="fas fa-check"></i> Check In</button>
                                    </div>
                                    <div id="pxCheckinResult" class="checkin-result"></div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header"><span class="card-title">Check-in Stats</span></div>
                                <div class="card-body">
                                    <div class="checkin-stats">
                                        <div class="checkin-stat"><span class="checkin-stat-value" id="pxCheckinTotal">0</span><span>Checked In</span></div>
                                        <div class="checkin-stat"><span class="checkin-stat-value" id="pxCheckinRemaining">0</span><span>Remaining</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><span class="card-title">Recent Check-ins</span></div>
                            <div class="card-body" id="pxRecentCheckins"></div>
                        </div>
                        <div class="card" id="sessionCheckinCard">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-calendar-check" style="margin-right: 8px; color: var(--accent-gold);"></i>Session Check-in</span>
                            </div>
                            <div class="card-body" id="sessionCheckinList">
                                <p style="color: var(--text-muted); font-size: 13px;">
                                    <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                                    Enable session check-in from the Schedule tab using the <i class="fas fa-qrcode" style="color: var(--accent-gold);"></i> button on each session.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- PENDING TAB -->
                    <div class="plexus-content" id="plexus-pending">
                        <div class="card">
                            <div class="card-header"><span class="card-title">Refund Requests</span></div>
                            <div class="card-body" id="pxPendingRefundsList"></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><span class="card-title">Visa Invitation Requests</span></div>
                            <div class="card-body" id="pxPendingVisasList"></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><span class="card-title">Scholarship Applications</span></div>
                            <div class="card-body" id="pxPendingScholarshipsList"></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><span class="card-title">Speaker Applications</span></div>
                            <div class="card-body" id="pxPendingSpeakersList"></div>
                        </div>
                    </div>

                    <!-- SETTINGS TAB -->
                    <div class="plexus-content" id="plexus-settings">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Conference Pricing (EUR)</h3></div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div class="form-group"><label class="form-label">Student Early Bird</label><input type="number" class="form-input" id="pxSettingPriceStudentEarly" step="0.01" placeholder="39"></div>
                                    <div class="form-group"><label class="form-label">Student Regular</label><input type="number" class="form-input" id="pxSettingPriceStudentLate" step="0.01" placeholder="59"></div>
                                    <div class="form-group"><label class="form-label">Professional Early Bird</label><input type="number" class="form-input" id="pxSettingPriceProfEarly" step="0.01" placeholder="99"></div>
                                    <div class="form-group"><label class="form-label">Professional Regular</label><input type="number" class="form-input" id="pxSettingPriceProfLate" step="0.01" placeholder="149"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Conference Dates</h3></div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div class="form-group"><label class="form-label">Conference Start</label><input type="date" class="form-input" id="pxSettingStartDate"></div>
                                    <div class="form-group"><label class="form-label">Conference End</label><input type="date" class="form-input" id="pxSettingEndDate"></div>
                                    <div class="form-group"><label class="form-label">Early Bird Deadline</label><input type="date" class="form-input" id="pxSettingEarlyBirdDeadline"></div>
                                    <div class="form-group"><label class="form-label">Abstract Deadline</label><input type="date" class="form-input" id="pxSettingAbstractDeadline"></div>
                                </div>
                                <div class="form-group" style="margin-top: 16px;"><label class="form-label">Registration Open</label><select class="form-input" id="pxSettingRegOpen" style="max-width: 200px;"><option value="1">Yes</option><option value="0">No</option></select></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;"><h3 class="card-title">Key Dates (shown on user portal)</h3><button class="btn btn-secondary" onclick="PlexusSettingsAdmin.addKeyDate()" style="font-size: 12px;"><i class="fas fa-plus"></i> Add Date</button></div>
                            <div class="card-body" id="pxKeyDatesEditor"></div>
                        </div>
                        <div class="card">
                            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;"><h3 class="card-title">Testimonials</h3><button class="btn btn-secondary" onclick="PlexusSettingsAdmin.addTestimonial()" style="font-size: 12px;"><i class="fas fa-plus"></i> Add Testimonial</button></div>
                            <div class="card-body" id="pxTestimonialsEditor"></div>
                        </div>
                        <div style="margin-top: 20px; display: flex; justify-content: flex-end;"><button class="btn btn-primary" onclick="PlexusSettingsAdmin.saveSettings()" style="padding: 12px 32px;"><i class="fas fa-save"></i> Save All Plexus Settings</button></div>
                    </div>

                </div>

                <!-- ACCELERATOR -->
                <div class="section" id="section-accelerator">
                    <div class="back-link" onclick="App.showSection('dashboard')">
                        <i class="fas fa-arrow-left"></i> Back to Home
                    </div>
                    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1>Med&X Accelerator</h1>
                            <p id="accYearSubtitle">Research internship program</p>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="accYearSelect" onchange="AcceleratorApp.loadYear(this.value)" style="padding: 8px 12px; border-radius: 6px; background: var(--card-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                <option value="2026">2026</option>
                            </select>
                            <button class="btn btn-secondary" onclick="AcceleratorApp.addYear()"><i class="fas fa-plus"></i> New Year</button>
                        </div>
                    </div>

                    <!-- Accelerator Tabs -->
                    <div class="plexus-tabs acc-tabs">
                        <button class="plexus-tab acc-tab active" onclick="AcceleratorApp.showTab('overview')"><i class="fas fa-home"></i> Overview</button>
                        <button class="plexus-tab acc-tab" onclick="AcceleratorApp.showTab('dates')"><i class="fas fa-calendar-alt"></i> Key Dates</button>
                        <button class="plexus-tab acc-tab" onclick="AcceleratorApp.showTab('institutions')"><i class="fas fa-university"></i> Institutions</button>
                        <button class="plexus-tab acc-tab" onclick="AcceleratorApp.showTab('apply')"><i class="fas fa-edit"></i> Application Form</button>
                        <button class="plexus-tab acc-tab" onclick="AcceleratorApp.showTab('applications')"><i class="fas fa-file-alt"></i> Applications</button>
                        <button class="plexus-tab acc-tab" onclick="AcceleratorApp.showTab('evaluation')"><i class="fas fa-star-half-alt"></i> Evaluation</button>
                        <button class="plexus-tab acc-tab" onclick="AcceleratorApp.showTab('interviewers')"><i class="fas fa-user-tie"></i> Interviewers</button>
                        <button class="plexus-tab acc-tab" onclick="AcceleratorApp.showTab('ranking')"><i class="fas fa-trophy"></i> Ranking</button>
                        <button class="plexus-tab acc-tab" onclick="AcceleratorApp.showTab('files')"><i class="fas fa-folder"></i> Files</button>
                    </div>

                    <!-- Overview Tab -->
                    <div class="plexus-content acc-content active" id="acc-overview">
                        <div class="plexus-stats-grid">
                            <div class="stat-item"><div class="stat-value" id="accStatApps">0</div><div class="stat-label">Application</div></div>
                            <div class="stat-item"><div class="stat-value" id="accStatReview">0</div><div class="stat-label">Under Review</div></div>
                            <div class="stat-item"><div class="stat-value" id="accStatValid">0</div><div class="stat-label">Valid</div></div>
                            <div class="stat-item"><div class="stat-value" id="accStatInstitutions">0</div><div class="stat-label">Institution</div></div>
                        </div>

                        <div class="plexus-grid">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Tasks</span>
                                    <button class="btn btn-secondary" onclick="App.openTaskModal('accelerator')"><i class="fas fa-plus"></i> Add</button>
                                </div>
                                <div class="card-body" id="acceleratorTasks"></div>
                            </div>
                            <div class="card">
                                <div class="card-header"><span class="card-title">Timeline</span></div>
                                <div class="card-body" id="accTimelinePreview" style="min-height: 200px;"></div>
                            </div>
                        </div>
                    </div>

                        <!-- Overview Config Card -->
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-sliders-h" style="margin-right: 8px;"></i>Overview Page Config</span>
                                <button class="btn btn-primary" id="accOverviewSaveBtn" onclick="AcceleratorApp.saveOverviewConfig()"><i class="fas fa-save"></i> Save</button>
                            </div>
                            <div class="card-body">
                                <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">These values are displayed on the user-facing Accelerator overview page.</p>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600;">Application Deadline</label>
                                        <input type="date" id="accCfgDeadline" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600;">Program Duration</label>
                                        <input type="text" id="accCfgDuration" placeholder="e.g., 8-12 Weeks" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600;">Labs & Clinics Count</label>
                                        <input type="text" id="accCfgLabs" placeholder="e.g., 15+ Worldwide" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600;">Positions Available</label>
                                        <input type="text" id="accCfgPositions" placeholder="e.g., 5-10" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                </div>
                                <div style="margin-top: 16px;">
                                    <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600;">About the Program</label>
                                    <textarea id="accCfgAbout" rows="6" placeholder="HTML or plain text describing the Accelerator program..." style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical; font-family: inherit;"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Dates Tab -->
                    <div class="plexus-content acc-content" id="acc-dates">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Key Dates for <span id="accDatesYear">2026</span></span>
                                <button class="btn btn-primary" onclick="AcceleratorApp.addKeyDate()"><i class="fas fa-plus"></i> Add Date</button>
                            </div>
                            <div class="card-body">
                                <div class="akd-legend">
                                    <div class="akd-legend-item"><div class="akd-legend-dot" style="background: #22d3ee;"></div> Event</div>
                                    <div class="akd-legend-item"><div class="akd-legend-dot" style="background: #ef4444;"></div> Deadline</div>
                                    <div class="akd-legend-item"><div class="akd-legend-dot diamond" style="background: #c9a962;"></div> Milestone</div>
                                </div>
                                <div id="accKeyDatesList"></div>
                            </div>
                        </div>
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header"><span class="card-title">Timeline Overview</span></div>
                            <div class="card-body" id="accDatesTimeline" style="min-height: 150px; position: relative;"></div>
                        </div>
                    </div>

                    <!-- Institutions Tab -->
                    <div class="plexus-content acc-content" id="acc-institutions">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Institutions for <span id="accInstYear">2026</span></span>
                                <button class="btn btn-primary" onclick="AcceleratorApp.addInstitution()"><i class="fas fa-plus"></i> New Institution</button>
                            </div>
                            <div class="card-body">
                                <div id="accInstitutionsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Application Form Tab (Phase 4C: Preview/Editor) -->
                    <div class="plexus-content acc-content" id="acc-apply">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-edit" style="margin-right: 8px;"></i>Application Form - Accelerator <span id="accApplyYear">2026</span></span>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span id="accFormModeLabel" style="font-size: 12px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;"><i class="fas fa-eye"></i> Preview Mode</span>
                                    <button id="accFormToggleBtn" class="btn btn-secondary" onclick="AcceleratorApp.toggleFormMode()" style="font-size: 12px;">
                                        <i class="fas fa-pencil-alt"></i> Edit Form
                                    </button>
                                    <button id="accFormSaveBtn" class="btn btn-primary" onclick="AcceleratorApp.saveFormConfig()" style="display: none; font-size: 12px;">
                                        <i class="fas fa-save"></i> Save Configuration
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Preview/Edit container rendered by JS -->
                                <div id="accFormPreviewContainer"></div>
                                <!-- Original form (hidden by default, shown when submitting) -->
                                <div id="accFormEditContainer" style="display: none;">
                                <form id="accApplicationForm" onsubmit="AcceleratorApp.submitApplication(event)">
                                    <!-- Section 1: Personal Data -->
                                    <div style="margin-bottom: 24px; padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                                        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: var(--accent-primary);"><i class="fas fa-user" style="margin-right: 8px;"></i>1. Personal Information</h3>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">First Name *</label>
                                                <input type="text" name="first_name" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Last Name *</label>
                                                <input type="text" name="last_name" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Email *</label>
                                                <input type="email" name="email" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Phone *</label>
                                                <input type="tel" name="phone" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Date of Birth *</label>
                                                <input type="date" name="date_of_birth" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Personal ID (OIB) *</label>
                                                <input type="text" name="oib" required maxlength="11" pattern="[0-9]{11}" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                            </div>
                                            <div style="grid-column: span 2;">
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Residential Address *</label>
                                                <input type="text" name="address" required placeholder="Street, house number, postal code, city" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Section 2: Education -->
                                    <div style="margin-bottom: 24px; padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                                        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: var(--accent-primary);"><i class="fas fa-graduation-cap" style="margin-right: 8px;"></i>2. Education</h3>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                            <div style="grid-column: span 2;">
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Faculty / Institution *</label>
                                                <input type="text" name="current_institution" required placeholder="E.g., School of Medicine, University of Zagreb" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Study Program *</label>
                                                <select name="degree_program" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                                    <option value="">-- Select --</option>
                                                    <option value="medicina">Medicine</option>
                                                    <option value="dentalna_medicina">Dental Medicine</option>
                                                    <option value="farmacija">Pharmacy</option>
                                                    <option value="biotehnologija">Medical Biochemistry / Biotechnology</option>
                                                    <option value="drugo">Other</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Year of Study *</label>
                                                <select name="year_of_study" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                                    <option value="">-- Select --</option>
                                                    <option value="1">1st Year</option>
                                                    <option value="2">2nd Year</option>
                                                    <option value="3">3rd Year</option>
                                                    <option value="4">4th Year</option>
                                                    <option value="5">5th Year</option>
                                                    <option value="6">6th Year</option>
                                                    <option value="apsolvant">Final Year</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">GPA *</label>
                                                <input type="number" name="gpa" required step="0.01" min="2.0" max="5.0" placeholder="e.g., 4.50" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Total ECTS Credits Completed</label>
                                                <input type="number" name="ects_total" min="0" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Section 3: Program Selection -->
                                    <div style="margin-bottom: 24px; padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                                        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: var(--accent-primary);"><i class="fas fa-university" style="margin-right: 8px;"></i>3. Program Selection</h3>
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Program Type *</label>
                                                <select name="program_type" required onchange="AcceleratorApp.updateInstitutionOptions(this.value)" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                                    <option value="">-- Select --</option>
                                                    <option value="scientific">Scientific Program</option>
                                                    <option value="clinical">Clinical Program</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Desired Institution *</label>
                                                <select name="selected_institution" id="accApplyInstitution" required style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                                    <option value="">-- First select program type --</option>
                                                </select>
                                            </div>
                                            <div style="grid-column: span 2;">
                                                <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Alternative Institution (optional)</label>
                                                <select name="alternative_institution" id="accApplyAltInstitution" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                                    <option value="">-- None --</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Section 4: Additional Information (matching PDF) -->
                                    <div style="margin-bottom: 24px; padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                                        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: var(--accent-primary);"><i class="fas fa-info-circle" style="margin-right: 8px;"></i>4. Additional Information</h3>
                                        <div style="margin-bottom: 16px;">
                                            <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">
                                                Have you participated in similar programs, projects, or research in the past?
                                                <span style="color: var(--text-muted);">(Maximum 150 words)</span>
                                            </label>
                                            <textarea name="previous_experience" id="accPrevExperience" rows="5" maxlength="1500" placeholder="If yes, please list them and describe your roles or contributions..." style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical;" oninput="AcceleratorApp.countWords(this, 150)"></textarea>
                                            <div style="text-align: right; font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                                <span id="accPrevExpWordCount">0</span>/150 words
                                            </div>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">
                                                Do you need any special arrangements or accommodations to participate in the program?
                                                <span style="color: var(--text-muted);">(If applicable, otherwise leave blank)</span>
                                            </label>
                                            <textarea name="special_arrangements" rows="2" placeholder="E.g., visa requirements, specific availability dates, health restrictions..." style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical;"></textarea>
                                        </div>
                                    </div>

                                    <!-- Section 5: Required Documents -->
                                    <div style="margin-bottom: 24px; padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                                        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: var(--accent-primary);"><i class="fas fa-file-upload" style="margin-right: 8px;"></i>5. Required Documents</h3>
                                        <p style="margin: 0 0 16px 0; font-size: 13px; color: var(--text-muted);">All documents must be in PDF format. Maximum file size: 10 MB.</p>
                                        <div id="accRequiredDocs" style="display: grid; gap: 12px;"></div>
                                    </div>

                                    <!-- Section 6: Optional Documents (Bonus Points) -->
                                    <div style="margin-bottom: 24px; padding: 20px; background: var(--bg-secondary); border-radius: 10px;">
                                        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: var(--accent-gold);"><i class="fas fa-star" style="margin-right: 8px;"></i>6. Additional Documents (bonus points)</h3>
                                        <p style="margin: 0 0 16px 0; font-size: 13px; color: var(--text-muted);">These documents are optional but can earn additional points during evaluation.</p>
                                        <div id="accOptionalDocs" style="display: grid; gap: 12px;"></div>
                                    </div>

                                    <!-- Section 7: GDPR Consent -->
                                    <div style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); border-radius: 10px; border: 1px solid rgba(34, 197, 94, 0.3);">
                                        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: #22c55e;"><i class="fas fa-shield-alt" style="margin-right: 8px;"></i>7. Consent (GDPR) *</h3>
                                        <div style="max-height: 200px; overflow-y: auto; padding: 12px; background: var(--card-bg); border-radius: 6px; font-size: 12px; line-height: 1.6; margin-bottom: 16px; border: 1px solid var(--border-color);" id="accGdprText"></div>
                                        <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer;">
                                            <input type="checkbox" name="gdpr_consent" id="accGdprConsent" required style="margin-top: 3px; width: 18px; height: 18px;">
                                            <span style="font-size: 13px; line-height: 1.5;">
                                                <strong>I have read and accept the terms of personal data processing.</strong><br>
                                                <span style="color: var(--text-muted);">I confirm that all information I have provided is true and accurate.</span>
                                            </span>
                                        </label>
                                    </div>

                                    <!-- Submit -->
                                    <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                        <button type="button" class="btn btn-secondary" onclick="AcceleratorApp.saveDraft()">
                                            <i class="fas fa-save"></i> Save Draft
                                        </button>
                                        <button type="submit" class="btn btn-primary" style="padding: 12px 32px;">
                                            <i class="fas fa-paper-plane"></i> Submit Application
                                        </button>
                                    </div>
                                </form>
                                </div><!-- /accFormEditContainer -->
                            </div>
                        </div>
                    </div>

                    <!-- Applications Tab (Phase 4D: Enhanced Filtering/Grouping) -->
                    <div class="plexus-content acc-content" id="acc-applications">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Applications for <span id="accAppsYear">2026</span></span>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" onclick="AcceleratorApp.exportApplicationsCsv()" style="font-size: 12px;"><i class="fas fa-download"></i> Export CSV</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- Summary Stats -->
                                <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px;">
                                    <div style="padding: 12px 20px; background: var(--bg-secondary); border-radius: 8px; min-width: 110px;">
                                        <div style="font-size: 22px; font-weight: 700; color: var(--text-primary);" id="accAppsStatTotal">0</div>
                                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Total</div>
                                    </div>
                                    <div style="padding: 12px 20px; background: var(--bg-secondary); border-radius: 8px; min-width: 110px;">
                                        <div style="font-size: 22px; font-weight: 700; color: #3b82f6;" id="accAppsStatPending">0</div>
                                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Pending Review</div>
                                    </div>
                                    <div style="padding: 12px 20px; background: var(--bg-secondary); border-radius: 8px; min-width: 110px;">
                                        <div style="font-size: 22px; font-weight: 700; color: #22c55e;" id="accAppsStatValid">0</div>
                                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Valid</div>
                                    </div>
                                    <div style="padding: 12px 20px; background: var(--bg-secondary); border-radius: 8px; min-width: 110px;">
                                        <div style="font-size: 22px; font-weight: 700; color: #ef4444;" id="accAppsStatInvalid">0</div>
                                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Invalid</div>
                                    </div>
                                    <div style="padding: 12px 20px; background: var(--bg-secondary); border-radius: 8px; min-width: 110px;">
                                        <div style="font-size: 22px; font-weight: 700; color: var(--accent-gold);" id="accAppsStatAvgScore">-</div>
                                        <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">Avg Score</div>
                                    </div>
                                </div>
                                <!-- Filter Bar -->
                                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; align-items: center;">
                                    <input type="text" id="accAppsSearch" placeholder="Search name, email, ID..." oninput="AcceleratorApp.filterApplications()" style="width: 200px; padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                    <select id="accAppsStatus" onchange="AcceleratorApp.filterApplications()" style="padding: 6px; border-radius: 4px; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                        <option value="">All Statuses</option>
                                        <option value="draft">Draft</option>
                                        <option value="submitted">Submitted</option>
                                        <option value="valid">Valid</option>
                                        <option value="invalid">Invalid</option>
                                        <option value="accepted">Accepted</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                    <select id="accAppsInst" onchange="AcceleratorApp.filterApplications()" style="padding: 6px; border-radius: 4px; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                        <option value="">All Institutions</option>
                                    </select>
                                    <select id="accAppsProgramType" onchange="AcceleratorApp.filterApplications()" style="padding: 6px; border-radius: 4px; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                        <option value="">All Programs</option>
                                        <option value="scientific">Scientific</option>
                                        <option value="clinical">Clinical</option>
                                    </select>
                                    <select id="accAppsScoreRange" onchange="AcceleratorApp.filterApplications()" style="padding: 6px; border-radius: 4px; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                        <option value="">All Scores</option>
                                        <option value="0-25">0-25%</option>
                                        <option value="25-50">25-50%</option>
                                        <option value="50-75">50-75%</option>
                                        <option value="75-100">75-100%</option>
                                    </select>
                                    <button class="btn btn-secondary" onclick="AcceleratorApp.clearAppFilters()" style="font-size: 12px; padding: 6px 10px;"><i class="fas fa-times"></i> Clear</button>
                                </div>
                                <!-- Group By Toggle -->
                                <div style="display: flex; gap: 6px; margin-bottom: 14px; align-items: center;">
                                    <span style="font-size: 12px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Group by:</span>
                                    <button class="px-group-btn active" data-group="none" onclick="AcceleratorApp.groupApplications('none')">None</button>
                                    <button class="px-group-btn" data-group="status" onclick="AcceleratorApp.groupApplications('status')">Status</button>
                                    <button class="px-group-btn" data-group="institution" onclick="AcceleratorApp.groupApplications('institution')">Institution</button>
                                    <button class="px-group-btn" data-group="program_type" onclick="AcceleratorApp.groupApplications('program_type')">Program</button>
                                </div>
                                <!-- Grouped Container -->
                                <div id="accAppsGroupedContainer"></div>
                                <!-- Table -->
                                <div style="overflow-x: auto;">
                                    <table id="accAppsTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                        <thead>
                                            <tr style="border-bottom: 2px solid var(--border-color);">
                                                <th class="px-sortable" style="padding: 10px; text-align: left;" onclick="AcceleratorApp.sortApplications('index')">No. <span class="px-sort-icon" id="accAppSort-index"></span></th>
                                                <th class="px-sortable" style="padding: 10px; text-align: left;" onclick="AcceleratorApp.sortApplications('candidate_id')">ID <span class="px-sort-icon" id="accAppSort-candidate_id"></span></th>
                                                <th class="px-sortable" style="padding: 10px; text-align: left;" onclick="AcceleratorApp.sortApplications('name')">Full Name <span class="px-sort-icon" id="accAppSort-name"></span></th>
                                                <th class="px-sortable" style="padding: 10px; text-align: left;" onclick="AcceleratorApp.sortApplications('current_institution')">Institution <span class="px-sort-icon" id="accAppSort-current_institution"></span></th>
                                                <th class="px-sortable" style="padding: 10px; text-align: left;" onclick="AcceleratorApp.sortApplications('year_of_study')">Year <span class="px-sort-icon" id="accAppSort-year_of_study"></span></th>
                                                <th class="px-sortable" style="padding: 10px; text-align: left;" onclick="AcceleratorApp.sortApplications('program_type')">Program <span class="px-sort-icon" id="accAppSort-program_type"></span></th>
                                                <th class="px-sortable" style="padding: 10px; text-align: left;" onclick="AcceleratorApp.sortApplications('status')">Status <span class="px-sort-icon" id="accAppSort-status"></span></th>
                                                <th class="px-sortable" style="padding: 10px; text-align: left;" onclick="AcceleratorApp.sortApplications('total_score')">Score <span class="px-sort-icon" id="accAppSort-total_score"></span></th>
                                                <th style="padding: 10px; text-align: center;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="accApplicationsTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Evaluation Tab -->

                    <div class="plexus-content acc-content" id="acc-evaluation">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Evaluation Criteria</span>
                                <button class="btn btn-primary" onclick="AcceleratorApp.addCriterion()"><i class="fas fa-plus"></i> Add Criterion</button>
                            </div>
                            <div class="card-body" id="accCriteriaList"></div>
                        </div>
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <span class="card-title">Candidate Evaluation</span>
                                <select id="accEvalAppSelect" onchange="AcceleratorApp.loadApplicationForEval(this.value)" style="padding: 6px 12px; border-radius: 4px; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                    <option value="">-- Select candidate --</option>
                                </select>
                            </div>
                            <div class="card-body" id="accEvaluationForm" style="display: none;">
                                <div id="accEvalScores"></div>
                                <div style="margin-top: 16px; display: flex; gap: 10px;">
                                    <button class="btn btn-primary" onclick="AcceleratorApp.saveEvaluation()"><i class="fas fa-save"></i> Save Points</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Interviewers Tab -->
                    <div class="plexus-content acc-content" id="acc-interviewers">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Interviewers for <span id="accIntYear">2026</span></span>
                                <button class="btn btn-primary" onclick="AcceleratorApp.addInterviewer()"><i class="fas fa-plus"></i> Add Interviewer</button>
                            </div>
                            <div class="card-body">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--border-color);">
                                            <th style="padding: 10px; text-align: left;">Name</th>
                                            <th style="padding: 10px; text-align: left;">Email</th>
                                            <th style="padding: 10px; text-align: left;">Institution</th>
                                            <th style="padding: 10px; text-align: left;">Specialty</th>
                                            <th style="padding: 10px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="accInterviewersList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Ranking Tab -->
                    <div class="plexus-content acc-content" id="acc-ranking">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Candidate Ranking</span>
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <select id="accRankInst" onchange="AcceleratorApp.loadRanking()" style="padding: 6px 12px; border-radius: 4px; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-primary);">
                                        <option value="">All Institutions</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="AcceleratorApp.updateRankings()"><i class="fas fa-sync"></i> Update</button>
                                    <button class="btn btn-primary" style="background: #22c55e; border-color: #22c55e;" onclick="AcceleratorApp.publishRankings()"><i class="fas fa-bullhorn"></i> Publish Rankings</button>
                                    <button class="btn btn-secondary" onclick="AcceleratorApp.editPdfSettings()"><i class="fas fa-cog"></i> PDF Settings</button>
                                    <button class="btn btn-secondary" onclick="AcceleratorApp.downloadRankingPDF()"><i class="fas fa-file-pdf"></i> Download PDF</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--border-color);">
                                            <th style="padding: 10px; text-align: center;">NO.</th>
                                            <th style="padding: 10px; text-align: center;">ID</th>
                                            <th style="padding: 10px; text-align: center;">GPA</th>
                                            <th style="padding: 10px; text-align: center;">MOTIVATION LETTER</th>
                                            <th style="padding: 10px; text-align: center;">RECOMMENDATION LETTER</th>
                                            <th style="padding: 10px; text-align: center;">OTHER POINTS</th>
                                            <th style="padding: 10px; text-align: center;">INTERVIEW</th>
                                            <th style="padding: 10px; text-align: center;">TOTAL</th>
                                        </tr>
                                    </thead>
                                    <tbody id="accRankingTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Files Tab -->
                    <div class="plexus-content acc-content" id="acc-files">
                        <!-- Application Documents Grouped by Applicant -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-users" style="margin-right: 8px; color: var(--accelerator);"></i>Application Documents by Applicant</span>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <input type="text" id="accFilesSearch" placeholder="Search applicant..." style="padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);" onkeyup="AcceleratorApp.filterGroupedFiles()">
                                    <button class="btn btn-secondary" onclick="AcceleratorApp.loadGroupedFiles()"><i class="fas fa-sync"></i> Refresh</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="accFilesStats" style="margin-bottom: 16px; display: flex; gap: 16px; flex-wrap: wrap;"></div>
                                <div id="accGroupedFiles" style="display: flex; flex-direction: column; gap: 8px;">
                                    <p style="color: var(--text-muted); text-align: center; padding: 40px;">Loading application documents...</p>
                                </div>
                            </div>
                        </div>
                        <!-- General Project Files -->
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-folder" style="margin-right: 8px;"></i>General Files</span>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" onclick="App.createFolder('accelerator')"><i class="fas fa-folder-plus"></i> New Folder</button>
                                    <button class="btn btn-secondary" onclick="App.triggerFileUpload('accelerator')"><i class="fas fa-upload"></i> Upload</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="file-grid" id="acceleratorFiles"></div>
                                <input type="file" class="file-upload-input" id="fileUpload-accelerator" onchange="App.uploadFile('accelerator', this.files[0])" accept="*">
                            </div>
                        </div>
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header"><span class="card-title">Team Chat</span></div>
                            <div class="project-chat">
                                <div class="project-chat-header">
                                    <div class="project-chat-tabs" id="acceleratorChatTabs"></div>
                                </div>
                                <div class="project-chat-messages" id="acceleratorChatMessages">
                                    <div class="chat-empty"><i class="fas fa-comments"></i><p>Select a channel</p></div>
                                </div>
                                <div class="project-chat-input">
                                    <input type="text" id="acceleratorChatInput" placeholder="Message..." onkeypress="if(event.key==='Enter') App.sendProjectMessage('accelerator')">
                                    <button onclick="App.sendProjectMessage('accelerator')"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Application Detail Modal -->
                <div id="accAppModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3 id="accAppModalTitle">Application Details</h3>
                            <button class="modal-close" onclick="AcceleratorApp.closeAppModal()">&times;</button>
                        </div>
                        <div class="modal-body" id="accAppModalBody"></div>
                    </div>
                </div>

                <!-- Institution Detail Modal -->
                <div id="accInstModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3 id="accInstModalTitle">Institution Details</h3>
                            <button class="modal-close" onclick="AcceleratorApp.closeInstModal()">&times;</button>
                        </div>
                        <div class="modal-body" id="accInstModalBody"></div>
                    </div>
                </div>

                <!-- Institution Edit Modal -->
                <div id="accInstEditModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3 id="accInstEditTitle">Edit Institution</h3>
                            <button class="modal-close" onclick="AcceleratorApp.closeInstEditModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="accInstEditForm" onsubmit="AcceleratorApp.saveInstitutionDetails(event)">
                                <input type="hidden" id="accInstEditId">
                                <div style="display: grid; gap: 16px;">
                                    <!-- Base institution info -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600;">Institution Name</label>
                                            <input type="text" id="accInstEditName" placeholder="e.g., Harvard Medical School" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600;">Website URL</label>
                                            <input type="url" id="accInstEditWebsite" placeholder="https://example.edu" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                        </div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600;">Logo / Photo URL</label>
                                        <input type="url" id="accInstEditLogo" placeholder="https://example.com/photo.jpg" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                        <div id="accInstLogoPreview" style="margin-top: 8px;"></div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 600;">Description</label>
                                        <textarea id="accInstEditDescription" rows="3" placeholder="Brief description of the institution..." style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical;"></textarea>
                                    </div>
                                    <!-- Year-specific details -->
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 500;">Program Type *</label>
                                            <input type="text" id="accInstEditProgramType" placeholder="e.g., Scientific, Clinical" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 500;">Available Spots *</label>
                                            <input type="number" id="accInstEditSpots" min="0" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                        </div>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 500;">Program Duration</label>
                                        <input type="text" id="accInstEditDuration" placeholder="e.g., 8 weeks" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 500;">Mentori</label>
                                        <textarea id="accInstEditMentors" rows="3" placeholder="Mentor names, their research areas..." style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical;"></textarea>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 500;">Visa Requirements</label>
                                        <textarea id="accInstEditVisa" rows="3" placeholder="Required documentation, application process..." style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical;"></textarea>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 500;">Accommodation</label>
                                            <textarea id="accInstEditAccommodation" rows="2" placeholder="Accommodation information..." style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical;"></textarea>
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 500;">Stipend</label>
                                            <textarea id="accInstEditStipend" rows="2" placeholder="Amount, conditions..." style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical;"></textarea>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 500;">Contact Person</label>
                                            <input type="text" id="accInstEditContactPerson" placeholder="Full Name" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 4px; font-size: 12px; font-weight: 500;">Contact Email</label>
                                            <input type="email" id="accInstEditContactEmail" placeholder="email@example.com" style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                        <button type="button" class="btn btn-secondary" onclick="AcceleratorApp.closeInstEditModal()">Cancel</button>
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Message Candidate Modal -->
                <div id="accMessageModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 id="accMessageModalTitle">Send Message</h3>
                            <button class="modal-close" onclick="AcceleratorApp.closeMessageModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="accMessageForm" onsubmit="AcceleratorApp.sendMessage(event)">
                                <input type="hidden" id="accMessageAppId">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">Recipient</label>
                                    <div id="accMessageRecipient" style="padding: 10px; background: var(--card-bg); border-radius: 6px; color: var(--text-secondary);"></div>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">Message Type</label>
                                    <select id="accMessageType" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                        <option value="info">Information</option>
                                        <option value="request">Document Request</option>
                                        <option value="reminder">Reminder</option>
                                        <option value="update">Status Update</option>
                                    </select>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">Subject *</label>
                                    <input type="text" id="accMessageSubject" required placeholder="Message subject..." style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">Message *</label>
                                    <textarea id="accMessageContent" required rows="5" placeholder="Message content..." style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical;"></textarea>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                                    <input type="checkbox" id="accMessageSendEmail" checked style="width: 18px; height: 18px;">
                                    <label for="accMessageSendEmail" style="cursor: pointer;">Also send email notification</label>
                                </div>
                                <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                    <button type="button" class="btn btn-secondary" onclick="AcceleratorApp.closeMessageModal()">Cancel</button>
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Send</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Validity Status Modal -->
                <div id="accValidityModal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 450px;">
                        <div class="modal-header">
                            <h3>Set Application Validity</h3>
                            <button class="modal-close" onclick="AcceleratorApp.closeValidityModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="accValidityForm" onsubmit="AcceleratorApp.saveValidity(event)">
                                <input type="hidden" id="accValidityAppId">
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">Candidate</label>
                                    <div id="accValidityCandidate" style="padding: 10px; background: var(--card-bg); border-radius: 6px; color: var(--text-secondary);"></div>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">Validity Status *</label>
                                    <div style="display: flex; gap: 12px;">
                                        <label style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; border-radius: 8px; border: 2px solid var(--border-color); cursor: pointer; flex: 1; justify-content: center;" class="validity-option" data-value="valid">
                                            <input type="radio" name="accValidityStatus" value="valid" style="display: none;">
                                            <i class="fas fa-check-circle" style="color: var(--success-color); font-size: 18px;"></i>
                                            <span>Valid</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; border-radius: 8px; border: 2px solid var(--border-color); cursor: pointer; flex: 1; justify-content: center;" class="validity-option" data-value="invalid">
                                            <input type="radio" name="accValidityStatus" value="invalid" style="display: none;">
                                            <i class="fas fa-times-circle" style="color: var(--danger-color); font-size: 18px;"></i>
                                            <span>Invalid</span>
                                        </label>
                                    </div>
                                </div>
                                <div style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">Reason (optional)</label>
                                    <textarea id="accValidityReason" rows="3" placeholder="Note or reason for decision..." style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical;"></textarea>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                                    <input type="checkbox" id="accValidityNotify" checked style="width: 18px; height: 18px;">
                                    <label for="accValidityNotify" style="cursor: pointer;">Notify candidate by email</label>
                                </div>
                                <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                    <button type="button" class="btn btn-secondary" onclick="AcceleratorApp.closeValidityModal()">Cancel</button>
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- FORUM -->
                <!-- BIOMEDICAL FORUM -->
                <div class="section" id="section-forum">
                    <div class="back-link" onclick="App.showSection('dashboard')">
                        <i class="fas fa-arrow-left"></i> Back to Home
                    </div>
                    <div class="page-header">
                        <h1>Biomedical Forum</h1>
                        <p id="forumSubtitle">Senior leaders network</p>
                    </div>

                    <!-- Forum Sub-Navigation -->
                    <div class="plexus-tabs forum-tabs">
                        <button class="plexus-tab forum-tab active" onclick="App.showForumTab('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
                        <button class="plexus-tab forum-tab" onclick="App.showForumTab('feed')"><i class="fas fa-stream"></i> Feed</button>
                        <button class="plexus-tab forum-tab" onclick="App.showForumTab('events')"><i class="fas fa-calendar-alt"></i> Events</button>
                        <button class="plexus-tab forum-tab" onclick="App.showForumTab('groups')"><i class="fas fa-layer-group"></i> Groups</button>
                        <button class="plexus-tab forum-tab" onclick="App.showForumTab('members')"><i class="fas fa-user-cog"></i> Members</button>
                        <button class="plexus-tab forum-tab" onclick="App.showForumTab('applications')"><i class="fas fa-user-plus"></i> Applications</button>
                        <button class="plexus-tab forum-tab" onclick="App.showForumTab('checkin')"><i class="fas fa-qrcode"></i> Check-in</button>
                        <button class="plexus-tab forum-tab" onclick="App.showForumTab('gallery')"><i class="fas fa-images"></i> Gallery</button>
                    </div>

                    <!-- Dashboard Tab -->
                    <div class="plexus-content forum-content active" id="forum-dashboard">
                        <!-- Stats Grid -->
                        <div class="plexus-stats-grid">
                            <div class="stat-item"><div class="stat-value" id="fmStatMembers">0</div><div class="stat-label">Members</div></div>
                            <div class="stat-item"><div class="stat-value" id="fmStatPending">0</div><div class="stat-label">Pending</div></div>
                            <div class="stat-item"><div class="stat-value" id="fmStatPosts">0</div><div class="stat-label">Posts</div></div>
                            <div class="stat-item"><div class="stat-value" id="fmStatEvents">0</div><div class="stat-label">Events</div></div>
                            <div class="stat-item"><div class="stat-value" id="fmStatGroups">0</div><div class="stat-label">Groups</div></div>
                            <div class="stat-item"><div class="stat-value" id="fmStatMentors">0</div><div class="stat-label">Mentorships</div></div>
                        </div>

                        <div class="plexus-grid">
                            <!-- Members by Specialty -->
                            <div class="card">
                                <div class="card-header"><span class="card-title">Members by Specialty</span></div>
                                <div class="card-body" id="fmChartBySpecialty"></div>
                            </div>

                            <!-- Members by Country -->
                            <div class="card">
                                <div class="card-header"><span class="card-title">Members by Country</span></div>
                                <div class="card-body" id="fmChartByCountry"></div>
                            </div>
                        </div>

                        <div class="plexus-grid">
                            <!-- Tasks -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Tasks</span>
                                    <button class="btn btn-secondary" onclick="App.openTaskModal('forum')"><i class="fas fa-plus"></i> Add</button>
                                </div>
                                <div class="card-body" id="forumTasks"></div>
                            </div>

                            <!-- Files -->
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Files</span>
                                    <button class="btn btn-secondary" onclick="App.triggerFileUpload('forum')"><i class="fas fa-upload"></i></button>
                                </div>
                                <div class="card-body">
                                    <div class="file-grid" id="forumFiles"></div>
                                    <input type="file" class="file-upload-input" id="fileUpload-forum" onchange="App.uploadFile('forum', this.files[0])" accept="*">
                                </div>
                            </div>
                        </div>

                        <!-- Project Timeline -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title"><i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>Project Timeline</span>
                                <button class="btn btn-secondary" onclick="App.openTimelineEventModal('forum')"><i class="fas fa-plus"></i> Add Event</button>
                            </div>
                            <div class="card-body" id="forumTimeline" style="padding: 12px;"></div>
                        </div>

                        <!-- Dynamic Dashboard Cards -->
                        <div id="forumDashboardCards" style="margin-top: 16px;"></div>

                    </div>


                    <!-- Feed Tab -->
                    <div class="plexus-content forum-content" id="forum-feed">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Community Feed</span>
                                <button class="btn btn-primary" onclick="App.openPostModal()"><i class="fas fa-plus"></i> New Post</button>
                            </div>
                            <div class="card-body" id="fmFeedPosts">
                                <div class="table-empty"><i class="fas fa-stream"></i><p>No posts yet. Be the first to share!</p></div>
                            </div>
                        </div>
                    </div>

                    <!-- Events Tab (Phase 5B Enhanced) -->
                    <div class="plexus-content forum-content" id="forum-events">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Forum Events</span>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <select id="fmEventsFilter" class="search-input" style="width: 140px; padding: 6px 10px;" onchange="App.filterForumEventCards()">
                                        <option value="all">All Events</option>
                                        <option value="published">Published</option>
                                        <option value="draft">Draft</option>
                                        <option value="planning">Planning</option>
                                        <option value="upcoming">Upcoming</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                    <button class="btn btn-secondary" onclick="App.sendQuickNotification('forum', 'forum-event')" title="Send notification about forum event"><i class="fas fa-bell"></i> Notify</button>
                                    <button class="btn btn-primary" onclick="App.openForumEventModal()"><i class="fas fa-plus"></i> Create Event</button>
                                </div>
                            </div>
                            <div class="card-body forum-events-grid" id="fmEventsList">
                                <div class="table-empty"><i class="fas fa-calendar-alt"></i><p>No events yet</p></div>
                            </div>
                        </div>
                    </div>

                    <!-- Forum Event Editor Modal -->
                    <div class="modal-overlay" id="forumEventModal">
                        <div class="modal" style="max-width: 640px;">
                            <div class="modal-header">
                                <h3 id="forumEventModalTitle">Create Event</h3>
                                <button class="modal-close" onclick="App.closeModal('forumEventModal')"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="modal-body" style="display: flex; flex-direction: column; gap: 12px; max-height: 70vh; overflow-y: auto;">
                                <div>
                                    <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Title *</label>
                                    <input type="text" class="search-input" id="feTitle" placeholder="Event title" style="width: 100%;">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Type</label>
                                        <select class="search-input" id="feType" style="width: 100%;">
                                            <option value="symposium">Symposium</option>
                                            <option value="workshop">Workshop</option>
                                            <option value="networking">Networking</option>
                                            <option value="seminar">Seminar</option>
                                            <option value="webinar">Webinar</option>
                                            <option value="conference">Conference</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Status</label>
                                        <select class="search-input" id="feStatus" style="width: 100%;">
                                            <option value="planning">Planning</option>
                                            <option value="upcoming">Upcoming</option>
                                            <option value="registration_open">Registration Open</option>
                                            <option value="ongoing">Ongoing</option>
                                            <option value="completed">Completed</option>
                                            <option value="published">Published</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Start Date & Time</label>
                                        <input type="datetime-local" class="search-input" id="feStartDate" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">End Date & Time</label>
                                        <input type="datetime-local" class="search-input" id="feEndDate" style="width: 100%;">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Venue / Location Name</label>
                                        <input type="text" class="search-input" id="feVenue" placeholder="e.g. Hotel Esplanade" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Location Address</label>
                                        <input type="text" class="search-input" id="feAddress" placeholder="Street, City, Country" style="width: 100%;">
                                    </div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Speaker(s)</label>
                                    <input type="text" class="search-input" id="feSpeakers" placeholder="Comma-separated names" style="width: 100%;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Description</label>
                                    <textarea class="search-input" id="feDescription" rows="3" placeholder="Event description..." style="width: 100%; resize: vertical;"></textarea>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Max Capacity</label>
                                        <input type="number" class="search-input" id="feCapacity" placeholder="e.g. 100" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Registration Deadline</label>
                                        <input type="date" class="search-input" id="feRegDeadline" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; display: block;">Location Type</label>
                                        <select class="search-input" id="feLocationType" style="width: 100%;">
                                            <option value="in_person">In Person</option>
                                            <option value="virtual">Virtual</option>
                                            <option value="hybrid">Hybrid</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 20px; align-items: center; padding: 8px 0;">
                                    <label class="forum-event-toggle">
                                        <input type="checkbox" id="fePublished"> Published to users
                                    </label>
                                    <label class="forum-event-toggle">
                                        <input type="checkbox" id="feCheckinEnabled"> Enable QR check-in
                                    </label>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="App.closeModal('forumEventModal')">Cancel</button>
                                <button class="btn btn-primary" onclick="App.saveForumEvent()"><i class="fas fa-check"></i> Save Event</button>
                            </div>
                        </div>
                    </div>

                    <!-- Forum Event Registrations Modal -->
                    <div class="modal-overlay" id="forumEventRegsModal">
                        <div class="modal" style="max-width: 700px;">
                            <div class="modal-header">
                                <h3 id="forumEventRegsTitle">Registrations</h3>
                                <button class="modal-close" onclick="App.closeModal('forumEventRegsModal')"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                                <div id="forumEventRegsList">
                                    <div class="table-empty"><i class="fas fa-users"></i><p>No registrations</p></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="App.closeModal('forumEventRegsModal')">Close</button>
                            </div>
                        </div>
                    </div>

                    <!-- Forum Event Detail Modal (Phase 7B) -->
                    <div class="modal-overlay" id="forumEventDetailModal">
                        <div class="modal" style="max-width: 700px;">
                            <div class="modal-header">
                                <h3>Event Details</h3>
                                <button class="modal-close" onclick="App.closeModal('forumEventDetailModal')"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="modal-body" id="forumEventDetailBody" style="max-height: 70vh; overflow-y: auto;"></div>
                        </div>
                    </div>

                    <!-- Forum Post Modal -->
                    <div class="modal-overlay" id="forumPostModal">
                        <div class="modal" style="max-width: 560px;">
                            <div class="modal-header">
                                <h3>Create Post</h3>
                                <button class="modal-close" onclick="App.closeModal('forumPostModal')"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label>Title (optional)</label>
                                    <input type="text" class="search-input" id="fpTitle" placeholder="Post title">
                                </div>
                                <div class="form-group">
                                    <label>Content *</label>
                                    <textarea class="search-input" id="fpContent" rows="6" placeholder="Write your post..." style="width: 100%; resize: vertical;"></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="App.closeModal('forumPostModal')">Cancel</button>
                                <button class="btn btn-primary" onclick="App.submitForumPost()"><i class="fas fa-paper-plane"></i> Post</button>
                            </div>
                        </div>
                    </div>

                    <!-- Forum Member Profile Modal -->
                    <div class="modal-overlay" id="forumMemberModal">
                        <div class="modal" style="max-width: 480px;">
                            <div class="modal-header">
                                <h3 id="fmMemberModalTitle">Member Profile</h3>
                                <button class="modal-close" onclick="App.closeModal('forumMemberModal')"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="modal-body" id="fmMemberModalBody"></div>
                            <div class="modal-footer" id="fmMemberModalFooter"></div>
                        </div>
                    </div>

                    <!-- Groups Tab -->
                    <div class="plexus-content forum-content" id="forum-groups">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Interest Groups</span>
                                <button class="btn btn-primary" onclick="App.openGroupModal()"><i class="fas fa-plus"></i> Create Group</button>
                            </div>
                            <div class="card-body">
                                <div class="speakers-grid" id="fmGroupsGrid">
                                    <div class="table-empty"><i class="fas fa-layer-group"></i><p>No groups yet</p></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gallery Tab -->
                    <div class="plexus-content forum-content" id="forum-gallery">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Media Gallery</span>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" onclick="App.createMediaFolder()"><i class="fas fa-folder-plus"></i> New Folder</button>
                                    <button class="btn btn-primary" onclick="App.openMediaUpload()"><i class="fas fa-upload"></i> Upload</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="gallery-grid" id="fmGalleryGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                                    <div class="table-empty" style="grid-column: 1/-1;"><i class="fas fa-images"></i><p>No media yet</p></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Members Tab (Admin) — merged with Directory -->
                    <div class="plexus-content forum-content" id="forum-members">
                        <!-- Summary Stats -->
                        <div class="plexus-stats-grid" style="margin-bottom: 16px;">
                            <div class="stat-item"><div class="stat-value" id="fmMembStatTotal">0</div><div class="stat-label">Total Members</div></div>
                            <div class="stat-item"><div class="stat-value" id="fmMembStatActive">0</div><div class="stat-label">Active</div></div>
                            <div class="stat-item"><div class="stat-value" id="fmMembStatCountries">0</div><div class="stat-label">Countries</div></div>
                            <div class="stat-item"><div class="stat-value" id="fmMembStatSpecialties">0</div><div class="stat-label">Specialties</div></div>
                        </div>
                        <div class="card">
                            <div class="card-header" style="flex-direction: column; align-items: stretch; gap: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span class="card-title">All Members</span>
                                    <button class="btn btn-secondary" onclick="App.exportForumMembers()"><i class="fas fa-download"></i> Export CSV</button>
                                </div>
                                <!-- Search & Filters Row -->
                                <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                                    <input type="text" id="fmMemberSearch" placeholder="Search name, email, institution..." class="search-input" style="width: 220px;" onkeyup="App.filterForumMembers()" maxlength="100">
                                    <select id="fmMemberSpecialty" class="form-select" style="width: 150px;" onchange="App.filterForumMembers()">
                                        <option value="">All Specialties</option>
                                    </select>
                                    <select id="fmMemberCareer" class="form-select" style="width: 150px;" onchange="App.filterForumMembers()">
                                        <option value="">All Levels</option>
                                        <option value="student">Student</option>
                                        <option value="early_career">Early Career</option>
                                        <option value="mid_career">Mid Career</option>
                                        <option value="senior">Senior Expert</option>
                                    </select>
                                    <select id="fmMemberCountry" class="form-select" style="width: 150px;" onchange="App.filterForumMembers()">
                                        <option value="">All Countries</option>
                                    </select>
                                    <select id="fmMemberIndustry" class="form-select" style="width: 150px;" onchange="App.filterForumMembers()">
                                        <option value="">All Industries</option>
                                    </select>
                                </div>
                                <!-- Grouping Row -->
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span style="font-size: 12px; color: var(--text-muted); font-weight: 500;">Group by:</span>
                                    <button class="px-group-btn active" data-group="none" onclick="App.groupForumMembers('none')" style="--px-color: var(--forum);">None</button>
                                    <button class="px-group-btn" data-group="specialty" onclick="App.groupForumMembers('specialty')" style="--px-color: var(--forum);">Specialty</button>
                                    <button class="px-group-btn" data-group="country" onclick="App.groupForumMembers('country')" style="--px-color: var(--forum);">Country</button>
                                    <button class="px-group-btn" data-group="institution" onclick="App.groupForumMembers('institution')" style="--px-color: var(--forum);">Institution</button>
                                    <span style="flex: 1;"></span>
                                    <span id="fmMembersCount" style="font-size: 12px; color: var(--text-muted);"></span>
                                </div>
                            </div>
                            <div class="card-body" style="overflow-x: auto;">
                                <table class="data-table" id="fmMembersTable">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Specialty</th>
                                            <th>Institution</th>
                                            <th>Country</th>
                                            <th>Status</th>
                                            <th>Level</th>
                                            <th>Points</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fmMembersTableBody"></tbody>
                                </table>
                                <!-- Grouped View Container -->
                                <div id="fmMembersGrouped" style="display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Applications Tab (Admin) -->
                    <div class="plexus-content forum-content" id="forum-applications">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Pending Applications</span>
                            </div>
                            <div class="card-body" id="fmApplicationsList">
                                <div class="table-empty"><i class="fas fa-user-plus"></i><p>No pending applications</p></div>
                            </div>
                        </div>
                    </div>

                    <!-- Forum Check-in Tab -->
                    <div class="plexus-content forum-content" id="forum-checkin">
                        <div class="card">
                            <div class="card-header"><span class="card-title"><i class="fas fa-qrcode" style="margin-right: 8px;"></i>Forum Check-in</span></div>
                            <div class="card-body checkin-panel">
                                <div class="checkin-camera-section">
                                    <button class="checkin-camera-toggle" onclick="App.toggleQRScanner('forum')">
                                        <i class="fas fa-camera"></i> <span>Enable Camera</span>
                                    </button>
                                    <div id="qr-reader-forum" style="display: none;"></div>
                                </div>
                                <div class="checkin-input-group">
                                    <input type="text" id="fmCheckinInput" class="checkin-input" placeholder="Scan QR code or enter member ID...">
                                    <button class="btn btn-primary" onclick="App.performCheckin('forum')"><i class="fas fa-check"></i> Check In</button>
                                </div>
                                <div id="fmCheckinResult" class="checkin-result"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BRIDGES -->
                <div class="section" id="section-bridges">
                    <div class="back-link" onclick="App.showSection('dashboard')">
                        <i class="fas fa-arrow-left"></i> Back to Home
                    </div>
                    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1><i class="fas fa-globe-americas" style="color: var(--bridges); margin-right: 12px;"></i>Building Bridges in Biomedicine</h1>
                            <p>Mini-events connecting Croatian biomedical professionals globally</p>
                        </div>
                        <button class="btn btn-primary" onclick="BridgesApp.openEventModal()">
                            <i class="fas fa-plus"></i> New Event
                        </button>
                    </div>

                    <!-- Events List View -->
                    <div id="bridgesEventsList">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">2026 Mini-Events</span>
                                <div style="display: flex; gap: 8px;">
                                    <select id="bridgesStatusFilter" onchange="BridgesApp.loadEvents()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                                        <option value="">All Statuses</option>
                                        <option value="planning">Planning</option>
                                        <option value="upcoming">Upcoming</option>
                                        <option value="registration_open">Registration Open</option>
                                        <option value="ongoing">Ongoing</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                    <button class="btn btn-secondary" onclick="App.sendQuickNotification('bridges', 'bridges-event')" title="Send notification to attendees"><i class="fas fa-bell"></i> Notify</button>
                                </div>
                            </div>
                            <div class="card-body" id="bridgesEventsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px;">
                                <p style="color: var(--text-muted);">Loading events...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Single Event Detail View (hidden by default) -->
                    <div id="bridgesEventDetail" style="display: none;">
                        <div class="back-link" onclick="BridgesApp.showEventsList()" style="margin-bottom: 16px;">
                            <i class="fas fa-arrow-left"></i> Back to Events
                        </div>

                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <h2 id="bridgesEventTitle" style="font-size: 24px; font-weight: 700; margin-bottom: 4px;"></h2>
                                    <p id="bridgesEventSubtitle" style="color: var(--text-muted);"></p>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <button class="btn btn-secondary" id="bridgesPublishBtn" onclick="BridgesApp.togglePublish()"><i class="fas fa-globe"></i> Publish</button>
                                    <button class="btn btn-secondary" onclick="BridgesApp.editCurrentEvent()"><i class="fas fa-edit"></i> Edit</button>
                                    <button class="btn btn-danger" onclick="BridgesApp.deleteCurrentEvent()"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px;">
                                    <div style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                                        <div id="bridgesEventRegCount" style="font-size: 28px; font-weight: 700; color: var(--bridges);">0</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">Registered</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                                        <div id="bridgesEventCheckedIn" style="font-size: 28px; font-weight: 700; color: var(--success);">0</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">Checked In</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                                        <div id="bridgesEventCapacity" style="font-size: 28px; font-weight: 700; color: var(--text-secondary);">0</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">Capacity</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: var(--bg-tertiary); border-radius: 8px;">
                                        <div id="bridgesEventStatus" style="font-size: 14px; font-weight: 600; padding: 4px 12px; border-radius: 12px; display: inline-block;"></div>
                                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Status</div>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div>
                                        <h4 style="margin-bottom: 8px; color: var(--text-secondary);">Event Details</h4>
                                        <div id="bridgesEventDetails" style="font-size: 14px; line-height: 1.8;"></div>
                                    </div>
                                    <div>
                                        <h4 style="margin-bottom: 8px; color: var(--text-secondary);">Description</h4>
                                        <div id="bridgesEventDescription" style="font-size: 14px; color: var(--text-muted);"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Registrations Table -->
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Registrations</span>
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" id="bridgesRegSearch" placeholder="Search..." onkeyup="BridgesApp.filterRegistrations()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); width: 200px;">
                                    <button class="btn btn-primary" onclick="BridgesApp.openRegistrationModal()"><i class="fas fa-plus"></i> Add</button>
                                </div>
                            </div>
                            <div class="card-body" style="padding: 0;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: var(--bg-tertiary); text-align: left;">
                                            <th style="padding: 12px 16px; font-weight: 600; font-size: 13px;">Name</th>
                                            <th style="padding: 12px 16px; font-weight: 600; font-size: 13px;">Email</th>
                                            <th style="padding: 12px 16px; font-weight: 600; font-size: 13px;">Institution</th>
                                            <th style="padding: 12px 16px; font-weight: 600; font-size: 13px;">Status</th>
                                            <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; text-align: center;">Check-in</th>
                                            <th style="padding: 12px 16px; font-weight: 600; font-size: 13px; text-align: right;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bridgesRegistrationsTable">
                                        <tr><td colspan="6" style="padding: 20px; text-align: center; color: var(--text-muted);">No registrations yet</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Bridges Quick Check-in -->
                    <div class="card" id="bridgesCheckinCard" style="margin-top: 20px; display: none;">
                        <div class="card-header"><span class="card-title"><i class="fas fa-qrcode" style="margin-right: 8px;"></i>Event Check-in</span></div>
                        <div class="card-body checkin-panel">
                            <div class="checkin-camera-section">
                                <button class="checkin-camera-toggle" onclick="App.toggleQRScanner('bridges')">
                                    <i class="fas fa-camera"></i> <span>Enable Camera</span>
                                </button>
                                <div id="qr-reader-bridges" style="display: none;"></div>
                            </div>
                            <div class="checkin-input-group">
                                <input type="text" id="brCheckinInput" class="checkin-input" placeholder="Scan QR code or enter registration ID...">
                                <button class="btn btn-primary" onclick="App.performCheckin('bridges')"><i class="fas fa-check"></i> Check In</button>
                            </div>
                            <div id="brCheckinResult" class="checkin-result"></div>
                        </div>
                    </div>

                    <!-- Speakers Management -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-microphone-alt" style="color: var(--bridges); margin-right: 8px;"></i>Speakers</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="bridgesSpeakerEventFilter" onchange="BridgesApp.loadSpeakers()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 13px;">
                                    <option value="">All Events</option>
                                </select>
                                <button class="btn btn-primary" onclick="BridgesApp.openSpeakerModal()"><i class="fas fa-plus"></i> Add Speaker</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="bridgesSpeakersGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                                <p style="color: var(--text-muted);">Loading speakers...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Program Management -->
                    <div class="card" style="margin-top: 20px;">
                        <div class="card-header">
                            <span class="card-title"><i class="fas fa-list-alt" style="color: var(--bridges); margin-right: 8px;"></i>Program / Schedule</span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="bridgesProgramEventFilter" onchange="BridgesApp.loadProgram()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 13px;">
                                    <option value="">All Events</option>
                                </select>
                                <button class="btn btn-primary" onclick="BridgesApp.openProgramModal()"><i class="fas fa-plus"></i> Add Item</button>
                            </div>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <div id="bridgesProgramList">
                                <p style="padding: 20px; color: var(--text-muted);">Loading program...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tasks and Files below events -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Tasks</span>
                                <button class="btn btn-secondary" onclick="App.openTaskModal('bridges')">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div class="card-body" id="bridgesTasks"></div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Files</span>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" onclick="App.createFolder('bridges')">
                                        <i class="fas fa-folder-plus"></i> Folder
                                    </button>
                                    <button class="btn btn-secondary" onclick="App.triggerFileUpload('bridges')">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="file-grid" id="bridgesFiles"></div>
                                <input type="file" class="file-upload-input" id="fileUpload-bridges" onchange="App.uploadFile('bridges', this.files[0])" accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.jpg,.jpeg,.png,.gif">
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Dashboard Cards -->
                    <div id="bridgesDashboardCards" style="margin-top: 16px;"></div>
                </div>

                <!-- FINANCES -->
                <div class="section" id="section-finances">
                    <div class="back-link" onclick="App.showSection('dashboard')">
                        <i class="fas fa-arrow-left"></i> Back to Home
                    </div>
                    <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h1><i class="fas fa-coins" style="color: var(--finances); margin-right: 12px;"></i>Finances</h1>
                            <p>Financial management and tracking</p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <label style="font-size: 13px; color: var(--text-muted);">Fiscal Year:</label>
                            <select id="finYearSelector" onchange="FinanceApp.changeYear(this.value)" style="padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; font-weight: 600;">
                            </select>
                        </div>
                    </div>

                    <!-- Finance Tabs -->
                    <div class="tabs" style="margin-bottom: 20px;">
                        <button class="tab-btn active" onclick="FinanceApp.showTab('dashboard', this)">
                            <i class="fas fa-chart-line"></i> Dashboard
                        </button>
                        <button class="tab-btn" onclick="FinanceApp.showTab('bank-balance', this)">
                            <i class="fas fa-university"></i> Bank Balance
                        </button>
                        <button class="tab-btn" onclick="FinanceApp.showTab('transactions', this)">
                            <i class="fas fa-exchange-alt"></i> Transactions
                        </button>
                        <button class="tab-btn" onclick="FinanceApp.showTab('work-units', this)">
                            <i class="fas fa-briefcase"></i> Work Units
                        </button>
                        <button class="tab-btn" onclick="FinanceApp.showTab('invoices', this)">
                            <i class="fas fa-file-invoice"></i> Invoices
                        </button>
                        <button class="tab-btn" onclick="FinanceApp.showTab('payment-orders', this)">
                            <i class="fas fa-money-check-alt"></i> Payment Orders
                        </button>
                        <button class="tab-btn" onclick="FinanceApp.showTab('travel-orders', this)">
                            <i class="fas fa-plane-departure"></i> Travel Orders
                        </button>
                        <button class="tab-btn" onclick="FinanceApp.showTab('conference-payments', this)">
                            <i class="fas fa-ticket-alt"></i> Conference Payments
                        </button>
                        <button class="tab-btn" onclick="FinanceApp.showTab('reports', this)">
                            <i class="fas fa-chart-pie"></i> Reports
                        </button>
                        <button class="tab-btn" onclick="FinanceApp.showTab('settings', this)">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </div>

                    <!-- Finance Tab Contents -->

                    <!-- Dashboard Tab -->
                    <div class="finance-tab active" id="finance-tab-dashboard">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div class="stat-card" style="background: linear-gradient(135deg, var(--finances), #059669); padding: 20px; border-radius: 12px;">
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Current Bank Balance</div>
                                <div style="font-size: 28px; font-weight: 700; color: white;" id="finDashBalance">0.00 EUR</div>
                                <div style="font-size: 11px; color: rgba(255,255,255,0.6);" id="finDashBalanceDate">-</div>
                            </div>
                            <div class="stat-card" style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                                <div style="font-size: 13px; color: var(--text-muted);">Total Income</div>
                                <div style="font-size: 24px; font-weight: 600; color: var(--success);" id="finDashIncome">0.00 EUR</div>
                            </div>
                            <div class="stat-card" style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                                <div style="font-size: 13px; color: var(--text-muted);">Total Expenses</div>
                                <div style="font-size: 24px; font-weight: 600; color: var(--danger);" id="finDashExpenses">0.00 EUR</div>
                            </div>
                            <div class="stat-card" style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                                <div style="font-size: 13px; color: var(--text-muted);">Net Balance</div>
                                <div style="font-size: 24px; font-weight: 600;" id="finDashNet">0.00 EUR</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Work Units Overview</span>
                                </div>
                                <div class="card-body" id="finDashWorkUnits">
                                    <p style="color: var(--text-muted);">No active work units</p>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">By Project</span>
                                </div>
                                <div class="card-body" id="finDashProjects">
                                    <p style="color: var(--text-muted);">No transactions yet</p>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <span class="card-title">Pending Items</span>
                            </div>
                            <div class="card-body" style="display: flex; gap: 20px;">
                                <div style="flex: 1; text-align: center; padding: 20px; background: var(--bg-secondary); border-radius: 8px;">
                                    <div style="font-size: 28px; font-weight: 600; color: var(--warning);" id="finDashPendingInvoices">0</div>
                                    <div style="font-size: 13px; color: var(--text-muted);">Pending Invoices</div>
                                </div>
                                <div style="flex: 1; text-align: center; padding: 20px; background: var(--bg-secondary); border-radius: 8px;">
                                    <div style="font-size: 28px; font-weight: 600; color: var(--warning);" id="finDashPendingTravel">0</div>
                                    <div style="font-size: 13px; color: var(--text-muted);">Pending Travel Orders</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <button class="btn btn-danger" onclick="FinanceApp.closeYear()">
                                <i class="fas fa-lock"></i> Close Fiscal Year
                            </button>
                        </div>
                    </div>

                    <!-- Bank Balance Tab -->
                    <div class="finance-tab" id="finance-tab-bank-balance">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Bank Balance History</span>
                                <button class="btn btn-primary" onclick="FinanceApp.openBankBalanceModal()">
                                    <i class="fas fa-plus"></i> Add Entry
                                </button>
                            </div>
                            <div class="card-body">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <th style="padding: 12px; text-align: left;">Date</th>
                                            <th style="padding: 12px; text-align: right;">Balance</th>
                                            <th style="padding: 12px; text-align: left;">Notes</th>
                                            <th style="padding: 12px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="finBankBalanceTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Transactions Tab -->
                    <div class="finance-tab" id="finance-tab-transactions">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Transactions</span>
                                <div style="display: flex; gap: 8px;">
                                    <select id="finTransFilter" onchange="FinanceApp.loadTransactions()" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                                        <option value="">All Types</option>
                                        <option value="income">Income</option>
                                        <option value="expense">Expense</option>
                                    </select>
                                    <select id="finTransProject" onchange="FinanceApp.loadTransactions()" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                                        <option value="">All Projects</option>
                                        <option value="plexus">Plexus</option>
                                        <option value="accelerator">Accelerator</option>
                                        <option value="forum">Forum</option>
                                        <option value="bridges">Bridges</option>
                                        <option value="general">General</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="FinanceApp.openTransactionModal()">
                                        <i class="fas fa-plus"></i> Add
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <th style="padding: 12px; text-align: left;">Number</th>
                                            <th style="padding: 12px; text-align: left;">Date</th>
                                            <th style="padding: 12px; text-align: left;">Type</th>
                                            <th style="padding: 12px; text-align: right;">Amount</th>
                                            <th style="padding: 12px; text-align: left;">Description</th>
                                            <th style="padding: 12px; text-align: left;">Project</th>
                                            <th style="padding: 12px; text-align: left;">Work Unit</th>
                                            <th style="padding: 12px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="finTransactionsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Work Units Tab -->
                    <div class="finance-tab" id="finance-tab-work-units">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Work Units</span>
                                <button class="btn btn-primary" onclick="FinanceApp.openWorkUnitModal()">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div class="card-body">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <th style="padding: 12px; text-align: left;">Code</th>
                                            <th style="padding: 12px; text-align: left;">Name</th>
                                            <th style="padding: 12px; text-align: left;">Grant Source</th>
                                            <th style="padding: 12px; text-align: right;">Budget</th>
                                            <th style="padding: 12px; text-align: right;">Used</th>
                                            <th style="padding: 12px; text-align: right;">Remaining</th>
                                            <th style="padding: 12px; text-align: center;">Status</th>
                                            <th style="padding: 12px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="finWorkUnitsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Invoices Tab -->
                    <div class="finance-tab" id="finance-tab-invoices">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Invoices</span>
                                <div style="display: flex; gap: 8px;">
                                    <select id="finInvoiceDirection" onchange="FinanceApp.loadInvoices()" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                                        <option value="">All</option>
                                        <option value="incoming">Incoming</option>
                                        <option value="outgoing">Outgoing</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="FinanceApp.openInvoiceModal()">
                                        <i class="fas fa-plus"></i> Create Invoice
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <th style="padding: 12px; text-align: left;">Number</th>
                                            <th style="padding: 12px; text-align: left;">Type</th>
                                            <th style="padding: 12px; text-align: left;">Party</th>
                                            <th style="padding: 12px; text-align: right;">Total</th>
                                            <th style="padding: 12px; text-align: left;">Issue Date</th>
                                            <th style="padding: 12px; text-align: left;">Due Date</th>
                                            <th style="padding: 12px; text-align: center;">Status</th>
                                            <th style="padding: 12px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="finInvoicesTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Orders Tab -->
                    <div class="finance-tab" id="finance-tab-payment-orders">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Payment Orders</span>
                                <button class="btn btn-primary" onclick="FinanceApp.openPaymentOrderModal()">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div class="card-body">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <th style="padding: 12px; text-align: left;">Number</th>
                                            <th style="padding: 12px; text-align: left;">Recipient</th>
                                            <th style="padding: 12px; text-align: right;">Amount</th>
                                            <th style="padding: 12px; text-align: left;">Date</th>
                                            <th style="padding: 12px; text-align: left;">Project</th>
                                            <th style="padding: 12px; text-align: center;">Status</th>
                                            <th style="padding: 12px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="finPaymentOrdersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Travel Orders Tab -->
                    <div class="finance-tab" id="finance-tab-travel-orders">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Travel Orders</span>
                                <div style="display: flex; gap: 8px;">
                                    <select id="finTravelStatus" onchange="FinanceApp.loadTravelOrders()" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                                        <option value="">All Statuses</option>
                                        <option value="assigned">Assigned</option>
                                        <option value="submitted">Submitted</option>
                                        <option value="approved">Approved</option>
                                        <option value="rejected">Rejected</option>
                                        <option value="paid">Paid</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="FinanceApp.openTravelOrderModal()">
                                        <i class="fas fa-plus"></i> Create
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <th style="padding: 12px; text-align: left;">Number</th>
                                            <th style="padding: 12px; text-align: left;">Traveler</th>
                                            <th style="padding: 12px; text-align: left;">Destination</th>
                                            <th style="padding: 12px; text-align: left;">Dates</th>
                                            <th style="padding: 12px; text-align: right;">Total Cost</th>
                                            <th style="padding: 12px; text-align: center;">Status</th>
                                            <th style="padding: 12px; text-align: center;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="finTravelOrdersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Conference Payments Tab -->
                    <div class="finance-tab" id="finance-tab-conference-payments">
                        <!-- Summary Cards -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6, #2563eb); padding: 20px; border-radius: 12px;">
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Total Registrations</div>
                                <div style="font-size: 28px; font-weight: 700; color: white;" id="confPayTotal">0</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706); padding: 20px; border-radius: 12px;">
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Pending Payment</div>
                                <div style="font-size: 28px; font-weight: 700; color: white;" id="confPayPending">0</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #22c55e, #16a34a); padding: 20px; border-radius: 12px;">
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Paid</div>
                                <div style="font-size: 28px; font-weight: 700; color: white;" id="confPayPaid">0</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, var(--finances), #059669); padding: 20px; border-radius: 12px;">
                                <div style="font-size: 13px; color: rgba(255,255,255,0.8);">Revenue Collected</div>
                                <div style="font-size: 28px; font-weight: 700; color: white;" id="confPayRevenue">0.00 EUR</div>
                            </div>
                        </div>

                        <!-- Source Filter Buttons -->
                        <div style="display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;">
                            <button onclick="FinanceApp.filterConfPaySource('all')" id="confPaySrcAll" class="confPaySrcBtn" style="padding: 8px 18px; border-radius: 20px; border: 2px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 13px; font-weight: 600; cursor: pointer;">All Sources</button>
                            <button onclick="FinanceApp.filterConfPaySource('plexus')" id="confPaySrcPlexus" class="confPaySrcBtn" style="padding: 8px 18px; border-radius: 20px; border: 2px solid transparent; background: rgba(99,102,241,0.12); color: #6366f1; font-size: 13px; font-weight: 600; cursor: pointer;">Plexus</button>
                            <button onclick="FinanceApp.filterConfPaySource('gala')" id="confPaySrcGala" class="confPaySrcBtn" style="padding: 8px 18px; border-radius: 20px; border: 2px solid transparent; background: rgba(201,169,98,0.12); color: #C9A962; font-size: 13px; font-weight: 600; cursor: pointer;">Gala</button>
                            <button onclick="FinanceApp.filterConfPaySource('accelerator')" id="confPaySrcAccelerator" class="confPaySrcBtn" style="padding: 8px 18px; border-radius: 20px; border: 2px solid transparent; background: rgba(59,130,246,0.12); color: #3b82f6; font-size: 13px; font-weight: 600; cursor: pointer;">Accelerator</button>
                            <button onclick="FinanceApp.filterConfPaySource('forum')" id="confPaySrcForum" class="confPaySrcBtn" style="padding: 8px 18px; border-radius: 20px; border: 2px solid transparent; background: rgba(20,184,166,0.12); color: #14b8a6; font-size: 13px; font-weight: 600; cursor: pointer;">Forum</button>
                        </div>

                        <!-- Filters -->
                        <div class="card" style="margin-bottom: 20px;">
                            <div class="card-body" style="padding: 16px;">
                                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                                    <select id="confPayStatusFilter" onchange="FinanceApp.loadConferencePayments()" style="padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;">
                                        <option value="all">All Statuses</option>
                                        <option value="pending">Pending</option>
                                        <option value="paid">Paid</option>
                                    </select>
                                    <input type="text" id="confPaySearch" placeholder="Search name, email, invoice..." oninput="FinanceApp.debounceConfPaySearch()" style="flex: 1; min-width: 200px; padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px;">
                                    <button onclick="FinanceApp.loadConferencePayments()" style="padding: 8px 16px; background: var(--finances); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Payments Table -->
                        <div class="card">
                            <div class="card-body" style="padding: 0;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--border);">
                                            <th style="padding: 12px 16px; text-align: left; font-size: 13px; color: var(--text-muted);">Attendee</th>
                                            <th style="padding: 12px 16px; text-align: center; font-size: 13px; color: var(--text-muted);">Source</th>
                                            <th style="padding: 12px 16px; text-align: left; font-size: 13px; color: var(--text-muted);">Invoice #</th>
                                            <th style="padding: 12px 16px; text-align: left; font-size: 13px; color: var(--text-muted);">Ticket</th>
                                            <th style="padding: 12px 16px; text-align: right; font-size: 13px; color: var(--text-muted);">Amount</th>
                                            <th style="padding: 12px 16px; text-align: center; font-size: 13px; color: var(--text-muted);">Status</th>
                                            <th style="padding: 12px 16px; text-align: left; font-size: 13px; color: var(--text-muted);">Date</th>
                                            <th style="padding: 12px 16px; text-align: center; font-size: 13px; color: var(--text-muted);">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="confPayTable">
                                        <tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--text-muted);">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div style="margin-top: 12px; font-size: 12px; color: var(--text-muted);">
                            <i class="fas fa-info-circle"></i> Pending revenue: <strong id="confPayPendingRevenue">€0.00</strong> awaiting bank transfer confirmation.
                        </div>
                    </div>

                    <!-- Reports Tab -->
                    <div class="finance-tab" id="finance-tab-reports">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">By Project</span>
                                </div>
                                <div class="card-body" id="finReportByProject">
                                    <table style="width: 100%;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid var(--border);">
                                                <th style="padding: 10px; text-align: left;">Project</th>
                                                <th style="padding: 10px; text-align: right;">Income</th>
                                                <th style="padding: 10px; text-align: right;">Expenses</th>
                                                <th style="padding: 10px; text-align: right;">Net</th>
                                            </tr>
                                        </thead>
                                        <tbody id="finReportProjectTable"></tbody>
                                    </table>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">By Work Unit</span>
                                </div>
                                <div class="card-body" id="finReportByWorkUnit">
                                    <table style="width: 100%;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid var(--border);">
                                                <th style="padding: 10px; text-align: left;">Code</th>
                                                <th style="padding: 10px; text-align: left;">Name</th>
                                                <th style="padding: 10px; text-align: right;">Budget</th>
                                                <th style="padding: 10px; text-align: right;">Used</th>
                                                <th style="padding: 10px; text-align: right;">%</th>
                                            </tr>
                                        </thead>
                                        <tbody id="finReportWorkUnitTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <span class="card-title">Monthly Overview</span>
                            </div>
                            <div class="card-body" id="finReportMonthly">
                                <table style="width: 100%;">
                                    <thead>
                                        <tr style="border-bottom: 1px solid var(--border);">
                                            <th style="padding: 10px; text-align: left;">Month</th>
                                            <th style="padding: 10px; text-align: right;">Income</th>
                                            <th style="padding: 10px; text-align: right;">Expenses</th>
                                            <th style="padding: 10px; text-align: right;">Net</th>
                                        </tr>
                                    </thead>
                                    <tbody id="finReportMonthlyTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div class="finance-tab" id="finance-tab-settings">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Company Information</span>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div class="form-group">
                                        <label>Company Name</label>
                                        <input type="text" id="finSettingCompanyName" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                    <div class="form-group">
                                        <label>Tax ID (OIB)</label>
                                        <input type="text" id="finSettingOib" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Address</label>
                                    <input type="text" id="finSettingAddress" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div class="form-group">
                                        <label>Email</label>
                                        <input type="email" id="finSettingEmail" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                    <div class="form-group">
                                        <label>IBAN</label>
                                        <input type="text" id="finSettingIban" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <span class="card-title">Travel Settings</span>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div class="form-group">
                                        <label>Daily Allowance Rate (EUR)</label>
                                        <input type="number" id="finSettingDailyRate" step="0.01" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                    <div class="form-group">
                                        <label>Kilometer Rate (EUR/km)</label>
                                        <input type="number" id="finSettingKmRate" step="0.01" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <span class="card-title">Invoice Settings</span>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Invoice Footer Text</label>
                                    <textarea id="finSettingInvoiceFooter" rows="2" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);"></textarea>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="FinanceApp.saveSettings()">
                                <i class="fas fa-save"></i> Save Settings
                            </button>
                        </div>
                    </div>

                </div>

                <!-- ===== PR & MEDIA SECTION ===== -->
                <div class="section" id="section-pr-media">
                    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 4px;">
                                <i class="fas fa-bullhorn" style="color: var(--pr-media); margin-right: 12px;"></i>
                                PR & Media
                            </h1>
                            <p style="color: var(--text-muted);">Social media, newsletters, and content management</p>
                        </div>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <select id="prProjectFilter" onchange="PRApp.filterByProject(this.value)" style="padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                                <option value="">All Projects</option>
                                <option value="plexus">Plexus</option>
                                <option value="accelerator">Accelerator</option>
                                <option value="forum">Forum</option>
                                <option value="bridges">Bridges</option>
                                <option value="medx">Med&X General</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="tabs" style="display: flex; gap: 4px; padding: 4px; background: var(--bg-secondary); border-radius: 10px; margin-bottom: 24px; flex-wrap: wrap;">
                        <button class="tab-btn active" onclick="PRApp.showTab('dashboard', this)" style="padding: 10px 16px; background: var(--pr-media); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500;">
                            <i class="fas fa-chart-line"></i> Dashboard
                        </button>
                        <button class="tab-btn" onclick="PRApp.showTab('calendar', this)" style="padding: 10px 16px; background: transparent; color: var(--text-secondary); border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500;">
                            <i class="fas fa-calendar-alt"></i> Calendar
                        </button>
                        <button class="tab-btn" onclick="PRApp.showTab('social', this)" style="padding: 10px 16px; background: transparent; color: var(--text-secondary); border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500;">
                            <i class="fas fa-share-alt"></i> Social Media
                        </button>
                        <button class="tab-btn" onclick="PRApp.showTab('newsletters', this)" style="padding: 10px 16px; background: transparent; color: var(--text-secondary); border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500;">
                            <i class="fas fa-envelope-open-text"></i> Newsletters
                        </button>
                        <button class="tab-btn" onclick="PRApp.showTab('media', this)" style="padding: 10px 16px; background: transparent; color: var(--text-secondary); border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500;">
                            <i class="fas fa-images"></i> Media Library
                        </button>
                        <button class="tab-btn" onclick="PRApp.showTab('ai-studio', this)" style="padding: 10px 16px; background: transparent; color: var(--text-secondary); border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500;">
                            <i class="fas fa-magic"></i> AI Studio
                        </button>
                        <button class="tab-btn" onclick="PRApp.showTab('campaigns', this)" style="padding: 10px 16px; background: transparent; color: var(--text-secondary); border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500;">
                            <i class="fas fa-bullseye"></i> Campaigns
                        </button>
                        <button class="tab-btn" onclick="PRApp.showTab('subscribers', this)" style="padding: 10px 16px; background: transparent; color: var(--text-secondary); border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500;">
                            <i class="fas fa-users"></i> Subscribers
                        </button>
                    </div>

                    <!-- Dashboard Tab -->
                    <div class="pr-tab active" id="pr-tab-dashboard">
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                            <div class="card" style="text-align: center; padding: 20px;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--pr-media);" id="prDashPosts">0</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Posts This Month</div>
                            </div>
                            <div class="card" style="text-align: center; padding: 20px;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--success);" id="prDashEngagement">0</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Total Engagement</div>
                            </div>
                            <div class="card" style="text-align: center; padding: 20px;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--accelerator);" id="prDashSubscribers">0</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Subscribers</div>
                            </div>
                            <div class="card" style="text-align: center; padding: 20px;">
                                <div style="font-size: 32px; font-weight: 700; color: var(--forum);" id="prDashCampaigns">0</div>
                                <div style="font-size: 13px; color: var(--text-muted);">Active Campaigns</div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Upcoming Content</span>
                                    <button class="btn btn-primary" onclick="PRApp.openContentModal()" style="padding: 6px 12px; font-size: 12px;">
                                        <i class="fas fa-plus"></i> New
                                    </button>
                                </div>
                                <div class="card-body" id="prDashUpcoming" style="max-height: 300px; overflow-y: auto;">
                                    <p style="color: var(--text-muted);">No upcoming content scheduled</p>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Recent Posts</span>
                                </div>
                                <div class="card-body" id="prDashRecent" style="max-height: 300px; overflow-y: auto;">
                                    <p style="color: var(--text-muted);">No recent posts</p>
                                </div>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Draft Newsletters</span>
                                    <button class="btn btn-primary" onclick="PRApp.openNewsletterModal()" style="padding: 6px 12px; font-size: 12px;">
                                        <i class="fas fa-plus"></i> New
                                    </button>
                                </div>
                                <div class="card-body" id="prDashNewsletters" style="max-height: 200px; overflow-y: auto;">
                                    <p style="color: var(--text-muted);">No draft newsletters</p>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title">Active Campaigns</span>
                                    <button class="btn btn-primary" onclick="PRApp.openCampaignModal()" style="padding: 6px 12px; font-size: 12px;">
                                        <i class="fas fa-plus"></i> New
                                    </button>
                                </div>
                                <div class="card-body" id="prDashCampaignsList" style="max-height: 200px; overflow-y: auto;">
                                    <p style="color: var(--text-muted);">No active campaigns</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar Tab -->
                    <div class="pr-tab" id="pr-tab-calendar">
                        <!-- View Toggle + Navigation -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div id="prCalendarMonthNav" style="display: flex; align-items: center; gap: 12px;">
                                    <button class="btn btn-secondary" onclick="PRApp.prevMonth()" style="padding: 8px 12px;"><i class="fas fa-chevron-left"></i></button>
                                    <span class="card-title" id="prCalendarMonth" style="min-width: 160px; text-align: center;">January 2026</span>
                                    <button class="btn btn-secondary" onclick="PRApp.nextMonth()" style="padding: 8px 12px;"><i class="fas fa-chevron-right"></i></button>
                                </div>
                                <div id="prCalendarWeekNav" style="display: none; align-items: center; gap: 12px;">
                                    <button class="btn btn-secondary" onclick="PRApp.prevWeek()" style="padding: 8px 12px;"><i class="fas fa-chevron-left"></i></button>
                                    <span class="card-title" id="prWeekLabel" style="min-width: 220px; text-align: center;">Feb 24 - Mar 2, 2026</span>
                                    <button class="btn btn-secondary" onclick="PRApp.nextWeek()" style="padding: 8px 12px;"><i class="fas fa-chevron-right"></i></button>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <!-- View Toggle -->
                                <div style="display: flex; border-radius: 8px; overflow: hidden; border: 1px solid var(--border);">
                                    <button id="prViewMonth" onclick="PRApp.setCalendarView('month')" style="padding: 8px 14px; background: var(--pr-media); color: white; border: none; cursor: pointer; font-size: 12px; font-weight: 500;">
                                        <i class="fas fa-calendar-alt"></i> Month
                                    </button>
                                    <button id="prViewWeek" onclick="PRApp.setCalendarView('week')" style="padding: 8px 14px; background: var(--bg-secondary); color: var(--text-secondary); border: none; border-left: 1px solid var(--border); cursor: pointer; font-size: 12px; font-weight: 500;">
                                        <i class="fas fa-calendar-week"></i> Week
                                    </button>
                                </div>
                                <select id="prCalendarPlatform" onchange="PRApp.refreshCalendarView()" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                                    <option value="">All Platforms</option>
                                    <option value="instagram">Instagram</option>
                                    <option value="linkedin">LinkedIn</option>
                                    <option value="twitter">Twitter/X</option>
                                    <option value="facebook">Facebook</option>
                                    <option value="tiktok">TikTok</option>
                                    <option value="youtube">YouTube</option>
                                </select>
                                <button class="btn btn-primary" onclick="PRApp.openContentModal()"><i class="fas fa-plus"></i> Add Content</button>
                            </div>
                        </div>

                        <!-- Month View -->
                        <div id="prMonthView" class="card">
                            <div class="card-body">
                                <div id="prCalendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
                                    <!-- Calendar will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Week View -->
                        <div id="prWeekView" style="display: none;">
                            <div id="prWeekGrid">
                                <!-- Week view will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- Social Media Tab -->
                    <div class="pr-tab" id="pr-tab-social">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Social Media Posts</span>
                                <div style="display: flex; gap: 8px;">
                                    <select id="prPostsPlatform" onchange="PRApp.loadPosts()" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                                        <option value="">All Platforms</option>
                                        <option value="instagram">Instagram</option>
                                        <option value="linkedin">LinkedIn</option>
                                        <option value="twitter">Twitter/X</option>
                                        <option value="facebook">Facebook</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="PRApp.openPostModal()"><i class="fas fa-plus"></i> Log Post</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="prPostsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                                    <p style="color: var(--text-muted);">No posts yet</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Newsletters Tab -->
                    <div class="pr-tab" id="pr-tab-newsletters">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Newsletters</span>
                                <div style="display: flex; gap: 8px;">
                                    <select id="prNewsletterStatus" onchange="PRApp.loadNewsletters()" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                                        <option value="">All</option>
                                        <option value="draft">Drafts</option>
                                        <option value="scheduled">Scheduled</option>
                                        <option value="sent">Sent</option>
                                    </select>
                                    <button class="btn btn-primary" onclick="PRApp.openNewsletterModal()"><i class="fas fa-plus"></i> Create Newsletter</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--border);">
                                            <th style="text-align: left; padding: 12px; font-weight: 600;">Name</th>
                                            <th style="text-align: left; padding: 12px; font-weight: 600;">Subject</th>
                                            <th style="text-align: center; padding: 12px; font-weight: 600;">Status</th>
                                            <th style="text-align: center; padding: 12px; font-weight: 600;">Recipients</th>
                                            <th style="text-align: center; padding: 12px; font-weight: 600;">Open Rate</th>
                                            <th style="text-align: center; padding: 12px; font-weight: 600;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="prNewslettersList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Media Library Tab -->
                    <div class="pr-tab" id="pr-tab-media">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Media Library</span>
                                <div style="display: flex; gap: 8px;">
                                    <select id="prMediaCategory" onchange="PRApp.loadMedia()" style="padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                                        <option value="">All Categories</option>
                                        <option value="photo">Photos</option>
                                        <option value="graphic">Graphics</option>
                                        <option value="logo">Logos</option>
                                        <option value="template">Templates</option>
                                        <option value="ai">AI Generated</option>
                                    </select>
                                    <input type="text" id="prMediaSearch" placeholder="Search..." style="padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);" onkeyup="PRApp.loadMedia()">
                                    <button class="btn btn-primary" onclick="PRApp.openUploadModal()"><i class="fas fa-upload"></i> Upload</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="prMediaGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px;">
                                    <p style="color: var(--text-muted);">No media files</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Studio Tab -->
                    <div class="pr-tab" id="pr-tab-ai-studio">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title"><i class="fas fa-image" style="color: var(--pr-media); margin-right: 8px;"></i>Generate Image</span>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Project</label>
                                        <select id="prAiProject" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                                            <option value="plexus">Plexus</option>
                                            <option value="accelerator">Accelerator</option>
                                            <option value="forum">Biomedical Forum</option>
                                            <option value="bridges">Bridges</option>
                                            <option value="medx">Med&X General</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Platform</label>
                                        <select id="prAiPlatform" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                                            <option value="instagram">Instagram Post</option>
                                            <option value="instagram-story">Instagram Story</option>
                                            <option value="linkedin">LinkedIn</option>
                                            <option value="twitter">Twitter/X</option>
                                            <option value="facebook">Facebook</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Describe the image you want</label>
                                        <textarea id="prAiImagePrompt" rows="4" placeholder="e.g., A professional social media graphic for Plexus 2026 conference announcement with medical/biomedical theme, modern design..." style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);"></textarea>
                                    </div>
                                    <button class="btn btn-primary" onclick="PRApp.generateImage()" style="width: 100%;">
                                        <i class="fas fa-magic"></i> Generate Image
                                    </button>
                                    <div id="prAiImageResult" style="margin-top: 16px; display: none;">
                                        <img id="prAiGeneratedImage" style="max-width: 100%; border-radius: 8px; border: 1px solid var(--border);">
                                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                                            <button class="btn btn-primary" onclick="PRApp.useGeneratedImage()"><i class="fas fa-check"></i> Use This</button>
                                            <button class="btn btn-secondary" onclick="PRApp.generateImage()"><i class="fas fa-redo"></i> Regenerate</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <span class="card-title"><i class="fas fa-pen-fancy" style="color: var(--pr-media); margin-right: 8px;"></i>Generate Caption</span>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Topic / What to announce</label>
                                        <textarea id="prAiCaptionTopic" rows="3" placeholder="e.g., Announcing early bird registration for Plexus 2026, highlighting keynote speakers and networking opportunities..." style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Tone</label>
                                        <select id="prAiCaptionTone" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                                            <option value="professional">Professional</option>
                                            <option value="excited">Excited/Enthusiastic</option>
                                            <option value="informative">Informative</option>
                                            <option value="casual">Casual/Friendly</option>
                                            <option value="inspiring">Inspiring</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Platform</label>
                                        <select id="prAiCaptionPlatform" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                                            <option value="instagram">Instagram</option>
                                            <option value="linkedin">LinkedIn</option>
                                            <option value="twitter">Twitter/X (short)</option>
                                            <option value="facebook">Facebook</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary" onclick="PRApp.generateCaption()" style="width: 100%;">
                                        <i class="fas fa-magic"></i> Generate Caption
                                    </button>
                                    <div id="prAiCaptionResult" style="margin-top: 16px; display: none;">
                                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; white-space: pre-wrap;" id="prAiGeneratedCaption"></div>
                                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                                            <button class="btn btn-primary" onclick="PRApp.useGeneratedCaption()"><i class="fas fa-copy"></i> Copy</button>
                                            <button class="btn btn-secondary" onclick="PRApp.generateCaption()"><i class="fas fa-redo"></i> Regenerate</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 24px;">
                            <div class="card-header">
                                <span class="card-title">Recent Generations</span>
                            </div>
                            <div class="card-body" id="prAiHistory" style="max-height: 400px; overflow-y: auto;">
                                <p style="color: var(--text-muted);">No generations yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Campaigns Tab -->
                    <div class="pr-tab" id="pr-tab-campaigns">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Marketing Campaigns</span>
                                <button class="btn btn-primary" onclick="PRApp.openCampaignModal()"><i class="fas fa-plus"></i> New Campaign</button>
                            </div>
                            <div class="card-body">
                                <div id="prCampaignsList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px;">
                                    <p style="color: var(--text-muted);">No campaigns yet</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subscribers Tab -->
                    <div class="pr-tab" id="pr-tab-subscribers">
                        <div class="card">
                            <div class="card-header">
                                <span class="card-title">Newsletter Subscribers</span>
                                <div style="display: flex; gap: 8px;">
                                    <input type="text" id="prSubscriberSearch" placeholder="Search..." style="padding: 8px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);" onkeyup="PRApp.loadSubscribers()">
                                    <button class="btn btn-secondary" onclick="PRApp.exportSubscribers()"><i class="fas fa-download"></i> Export</button>
                                    <button class="btn btn-primary" onclick="PRApp.openSubscriberModal()"><i class="fas fa-plus"></i> Add</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div style="margin-bottom: 16px; display: flex; gap: 16px; align-items: center;">
                                    <span id="prSubscriberCount" style="font-weight: 600;">0 subscribers</span>
                                    <span style="color: var(--text-muted);">|</span>
                                    <span id="prActiveCount" style="color: var(--success);">0 active</span>
                                </div>
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="border-bottom: 2px solid var(--border);">
                                            <th style="text-align: left; padding: 12px; font-weight: 600;">Email</th>
                                            <th style="text-align: left; padding: 12px; font-weight: 600;">Name</th>
                                            <th style="text-align: center; padding: 12px; font-weight: 600;">Projects</th>
                                            <th style="text-align: center; padding: 12px; font-weight: 600;">Status</th>
                                            <th style="text-align: center; padding: 12px; font-weight: 600;">Subscribed</th>
                                            <th style="text-align: center; padding: 12px; font-weight: 600;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="prSubscribersList"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- User Notifications Section -->
                <div class="section" id="section-user-notifications">
                    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 4px;">
                                <i class="fas fa-paper-plane" style="color: #22d3ee; margin-right: 12px;"></i>
                                User Notifications
                            </h1>
                            <p style="color: var(--text-muted);">Send announcements and notifications to user portal members</p>
                        </div>
                        <button class="btn btn-primary" onclick="UserNotifApp.showSendForm()">
                            <i class="fas fa-plus"></i> New Notification
                        </button>
                    </div>

                    <!-- Send Notification Form -->
                    <div id="notifSendForm" style="display: none; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 16px;">
                            <i class="fas fa-bullhorn" style="margin-right: 8px; color: #22d3ee;"></i>
                            Compose Notification
                        </h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Title *</label>
                                <input type="text" id="notifTitle" class="form-control" placeholder="e.g., Plexus 2026 Registration Now Open" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Category</label>
                                <select id="notifCategory" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                                    <option value="announcement">Announcement</option>
                                    <option value="event">Event</option>
                                    <option value="registration">Registration</option>
                                    <option value="reminder">Reminder</option>
                                    <option value="homepage">Homepage</option>
                                    <option value="system">System</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Message</label>
                            <textarea id="notifMessage" rows="3" class="form-control" placeholder="Write your notification message..." style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); resize: vertical;"></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Target Group</label>
                                <select id="notifGroup" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                                    <option value="all">All Users</option>
                                    <option value="plexus">Plexus Registrants</option>
                                    <option value="accelerator">Accelerator Applicants</option>
                                    <option value="forum">Forum Members</option>
                                    <option value="building-bridges">Building Bridges</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Project</label>
                                <select id="notifProject" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                                    <option value="">None</option>
                                    <option value="plexus">Plexus Conference</option>
                                    <option value="accelerator">Accelerator</option>
                                    <option value="forum">Biomedical Forum</option>
                                    <option value="building-bridges">Building Bridges</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Icon</label>
                                <select id="notifIcon" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                                    <option value="fa-bullhorn">Announcement</option>
                                    <option value="fa-calendar-check">Event</option>
                                    <option value="fa-bell">Bell</option>
                                    <option value="fa-clock">Reminder</option>
                                    <option value="fa-user-plus">Connection</option>
                                    <option value="fa-star">Star</option>
                                    <option value="fa-info-circle">Info</option>
                                    <option value="fa-exclamation-triangle">Warning</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Type</label>
                                <select id="notifType" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                                    <option value="info">Info</option>
                                    <option value="success">Success</option>
                                    <option value="warning">Warning</option>
                                    <option value="alert">Alert</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Target Tier</label>
                                <select id="notifTargetTier" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                                    <option value="all">All Tiers</option>
                                    <option value="bronze">Bronze</option>
                                    <option value="silver">Silver</option>
                                    <option value="gold">Gold</option>
                                    <option value="platinum">Platinum</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Placement</label>
                                <select id="notifPlacement" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                                    <option value="panel">Notification Panel Only</option>
                                    <option value="homepage">Homepage Banner</option>
                                    <option value="both">Both (Panel + Homepage)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Expires</label>
                                <input type="date" id="notifExpiry" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                            </div>
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Link (optional)</label>
                            <input type="text" id="notifLink" class="form-control" placeholder="e.g., #plexus/registration" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                        </div>

                        <!-- Quick Templates -->
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary);">Quick Templates</label>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn btn-sm" style="font-size: 11px; padding: 4px 10px; border-radius: 6px; background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer;" onclick="UserNotifApp.useTemplate('registration')">Registration Open</button>
                                <button class="btn btn-sm" style="font-size: 11px; padding: 4px 10px; border-radius: 6px; background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer;" onclick="UserNotifApp.useTemplate('speaker')">New Speaker</button>
                                <button class="btn btn-sm" style="font-size: 11px; padding: 4px 10px; border-radius: 6px; background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer;" onclick="UserNotifApp.useTemplate('schedule')">Schedule Update</button>
                                <button class="btn btn-sm" style="font-size: 11px; padding: 4px 10px; border-radius: 6px; background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer;" onclick="UserNotifApp.useTemplate('deadline')">Deadline Reminder</button>
                                <button class="btn btn-sm" style="font-size: 11px; padding: 4px 10px; border-radius: 6px; background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer;" onclick="UserNotifApp.useTemplate('welcome')">Welcome Message</button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="UserNotifApp.hideSendForm()">Cancel</button>
                            <button class="btn btn-primary" onclick="UserNotifApp.send()">
                                <i class="fas fa-paper-plane" style="margin-right: 6px;"></i> Send Notification
                            </button>
                        </div>
                    </div>

                    <!-- Notification History -->
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                        <div style="padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="font-size: 14px; font-weight: 600;">Sent Notifications</h3>
                            <div style="display: flex; gap: 8px;">
                                <select id="notifFilterCategory" onchange="UserNotifApp.load()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 12px;">
                                    <option value="">All Categories</option>
                                    <option value="announcement">Announcement</option>
                                    <option value="event">Event</option>
                                    <option value="registration">Registration</option>
                                    <option value="reminder">Reminder</option>
                                    <option value="homepage">Homepage</option>
                                    <option value="system">System</option>
                                </select>
                                <select id="notifFilterProject" onchange="UserNotifApp.load()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 12px;">
                                    <option value="">All Projects</option>
                                    <option value="plexus">Plexus</option>
                                    <option value="accelerator">Accelerator</option>
                                    <option value="forum">Forum</option>
                                    <option value="building-bridges">Building Bridges</option>
                                </select>
                                <select id="notifFilterPlacement" onchange="UserNotifApp.load()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 12px;">
                                    <option value="">All Placements</option>
                                    <option value="homepage">Homepage Announcements</option>
                                    <option value="both">Homepage + Panel</option>
                                    <option value="panel">Panel Only</option>
                                </select>
                            </div>
                        </div>
                        <div id="notifHistory" style="max-height: 600px; overflow-y: auto; padding: 8px;">
                            <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                <i class="fas fa-bell-slash" style="font-size: 32px; margin-bottom: 12px; opacity: 0.3;"></i>
                                <p>No notifications sent yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Newsletter Section -->
                <div class="section" id="section-newsletter">
                    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 4px;">
                                <i class="fas fa-envelope-open-text" style="color: #10b981; margin-right: 12px;"></i>
                                Member Newsletter
                            </h1>
                            <p style="color: var(--text-muted);">Create and send email newsletters to user portal members</p>
                        </div>
                        <button class="btn btn-primary" onclick="NewsletterApp.showCompose()">
                            <i class="fas fa-plus"></i> New Newsletter
                        </button>
                    </div>

                    <!-- Compose Area -->
                    <div id="newsletterComposeArea" style="display: none; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px;">
                        <h3 style="margin-bottom: 16px; font-size: 16px;">
                            <i class="fas fa-pen-fancy" style="margin-right: 8px; color: #10b981;"></i>
                            <span id="newsletterComposeTitle">Compose Newsletter</span>
                        </h3>
                        <input type="hidden" id="newsletterEditId">

                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Title *</label>
                                <input type="text" id="newsletterTitleInput" class="form-control" placeholder="e.g., Med&X Monthly Update - February 2026" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                            </div>
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Target Audience</label>
                                <select id="newsletterAudience" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                                    <option value="all">All Members</option>
                                    <option value="bronze">Bronze Tier</option>
                                    <option value="silver">Silver Tier</option>
                                    <option value="gold">Gold Tier</option>
                                    <option value="platinum">Platinum Tier</option>
                                    <option value="plexus">Plexus Registrants</option>
                                </select>
                            </div>
                        </div>

                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <label style="font-size: 12px; font-weight: 600; color: var(--text-secondary);">Body</label>
                                <button class="btn btn-sm" onclick="NewsletterApp.autoGenerate()" style="font-size: 11px; padding: 4px 12px; border-radius: 6px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; cursor: pointer;">
                                    <i class="fas fa-magic" style="margin-right: 4px;"></i> Auto-Generate
                                </button>
                            </div>
                            <textarea id="newsletterBodyInput" rows="12" placeholder="Write your newsletter content here..." style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); resize: vertical; font-family: 'Inter', sans-serif; line-height: 1.6;"></textarea>
                        </div>

                        <!-- Preview -->
                        <div id="newsletterPreviewArea" style="display: none; margin-bottom: 16px;">
                            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Preview</label>
                            <div id="newsletterPreviewContent" style="background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 20px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; font-size: 13px; line-height: 1.6;"></div>
                        </div>

                        <div style="display: flex; gap: 12px; justify-content: space-between;">
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm" onclick="NewsletterApp.togglePreview()" style="font-size: 12px; padding: 6px 14px; border-radius: 6px; background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer;">
                                    <i class="fas fa-eye" style="margin-right: 4px;"></i> Preview
                                </button>
                            </div>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-secondary" onclick="NewsletterApp.hideCompose()">Cancel</button>
                                <button class="btn" onclick="NewsletterApp.saveDraft()" style="background: var(--bg-hover); color: var(--text-primary); border: 1px solid var(--border); padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                                    <i class="fas fa-save" style="margin-right: 6px;"></i> Save Draft
                                </button>
                                <button class="btn btn-primary" onclick="NewsletterApp.sendNewsletter()" style="background: #10b981; border-color: #10b981;">
                                    <i class="fas fa-paper-plane" style="margin-right: 6px;"></i> Send Newsletter
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Newsletter History -->
                    <div style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; overflow: hidden;">
                        <div style="padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="font-size: 14px; font-weight: 600;">Newsletter History</h3>
                            <div style="display: flex; gap: 8px;">
                                <select id="newsletterFilterStatus" onchange="NewsletterApp.load()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 12px;">
                                    <option value="">All Statuses</option>
                                    <option value="draft">Draft</option>
                                    <option value="sent">Sent</option>
                                </select>
                                <select id="newsletterFilterAudience" onchange="NewsletterApp.load()" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 12px;">
                                    <option value="">All Audiences</option>
                                    <option value="all">All Members</option>
                                    <option value="bronze">Bronze</option>
                                    <option value="silver">Silver</option>
                                    <option value="gold">Gold</option>
                                    <option value="platinum">Platinum</option>
                                    <option value="plexus">Plexus</option>
                                </select>
                            </div>
                        </div>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--bg-primary);">
                                        <th style="text-align: left; padding: 10px 16px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Title</th>
                                        <th style="text-align: left; padding: 10px 16px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Audience</th>
                                        <th style="text-align: left; padding: 10px 16px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Status</th>
                                        <th style="text-align: left; padding: 10px 16px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Date</th>
                                        <th style="text-align: right; padding: 10px 16px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="newsletterHistoryBody">
                                    <tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);"><i class="fas fa-envelope" style="font-size: 32px; margin-bottom: 12px; opacity: 0.3; display: block;"></i>No newsletters yet</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Portal Content Management Section -->
                <div class="section" id="section-portal-content">
                    <div class="back-link" onclick="App.showSection('dashboard')">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </div>

                    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 4px;">
                                <i class="fas fa-th-large" style="color: #c9a962; margin-right: 12px;"></i>
                                Portal Content
                            </h1>
                            <p style="color: var(--text-muted);">Manage dynamic content displayed on the user portal (news, hero cards, featured content, quick links)</p>
                        </div>
                        <button class="btn btn-primary" onclick="PortalContentApp.openCreateModal()">
                            <i class="fas fa-plus"></i> Add Content
                        </button>
                    </div>

                    <!-- Section Filter Tabs -->
                    <div style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn pc-filter-tab active" data-filter="all" onclick="PortalContentApp.filterSection('all', this)" style="padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; background: var(--accent-gold); color: var(--bg-primary); border: 1px solid var(--accent-gold);">All</button>
                        <button class="btn pc-filter-tab" data-filter="hero" onclick="PortalContentApp.filterSection('hero', this)" style="padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border);">Hero Cards</button>
                        <button class="btn pc-filter-tab" data-filter="news" onclick="PortalContentApp.filterSection('news', this)" style="padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border);">News</button>
                        <button class="btn pc-filter-tab" data-filter="featured" onclick="PortalContentApp.filterSection('featured', this)" style="padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border);">Featured</button>
                        <button class="btn pc-filter-tab" data-filter="links" onclick="PortalContentApp.filterSection('links', this)" style="padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border);">Quick Links</button>
                    </div>

                    <!-- Stats Row -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                        <div class="card" style="padding: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent-gold);" id="pcStatTotal">0</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Total Items</div>
                        </div>
                        <div class="card" style="padding: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: #22c55e;" id="pcStatPublished">0</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Published</div>
                        </div>
                        <div class="card" style="padding: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: #f59e0b;" id="pcStatDraft">0</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Drafts</div>
                        </div>
                        <div class="card" style="padding: 16px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: #8b5cf6;" id="pcStatSections">0</div>
                            <div style="font-size: 12px; color: var(--text-muted);">Sections</div>
                        </div>
                    </div>

                    <!-- Content List -->
                    <div class="card">
                        <div class="card-body" id="pcContentList" style="padding: 0;">
                            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                                <i class="fas fa-th-large" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                                <p>No content items yet. Click "Add Content" to create your first item.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MESSAGES -->
                <div class="section" id="section-messages">
                    <div class="back-link" onclick="App.showSection('dashboard')">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </div>

                    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 4px;">
                                <i class="fas fa-envelope" style="color: #a78bfa; margin-right: 12px;"></i>
                                Messages
                            </h1>
                            <p style="color: var(--text-muted);">Direct messaging with users</p>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="App.openBulkMessageModal()"><i class="fas fa-users"></i> Bulk Message</button>
                            <button class="btn btn-primary" onclick="App.openComposeModal()"><i class="fas fa-pen"></i> Compose</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header" style="padding: 16px 20px; border-bottom: 1px solid var(--border);">
                            <span style="font-weight: 600; font-size: 14px;">Sent Messages</span>
                        </div>
                        <div class="card-body" id="adminMessagesList" style="padding: 0;">
                            <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                                <i class="fas fa-envelope" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                                <p>No messages sent yet</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GALA EVENING MANAGEMENT -->
                <div class="section" id="section-gala">
                    <div class="back-link" onclick="App.showSection('dashboard')">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </div>

                    <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <div>
                            <h1 style="font-size: 28px; font-weight: 700; margin-bottom: 4px;">
                                <i class="fas fa-glass-cheers" style="color: #C9A962; margin-right: 12px;"></i>
                                Gala Evening
                            </h1>
                            <p style="color: var(--text-muted);">Manage invitations, settings, and registrations</p>
                        </div>
                    </div>

                    <!-- Gala Stats -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="card" style="padding: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--accent-gold);" id="galaStatTotal">0</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Total Requests</div>
                        </div>
                        <div class="card" style="padding: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #f59e0b;" id="galaStatPending">0</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Pending</div>
                        </div>
                        <div class="card" style="padding: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #10b981;" id="galaStatApproved">0</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Approved</div>
                        </div>
                        <div class="card" style="padding: 20px; text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: #3b82f6;" id="galaStatPaid">0</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Paid / Confirmed</div>
                        </div>
                    </div>

                    <!-- Gala Tabs -->
                    <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 12px;">
                        <button class="btn btn-primary" id="galaTabRegs" onclick="GalaAdmin.showTab('registrations')" style="font-size: 13px;">
                            <i class="fas fa-users"></i> Registrations
                        </button>
                        <button class="btn btn-secondary" id="galaTabSettings" onclick="GalaAdmin.showTab('settings')" style="font-size: 13px;">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </div>

                    <!-- Registrations Tab -->
                    <div id="galaRegistrationsTab">
                        <div class="card">
                            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 class="card-title">Invitation Requests</h3>
                                <div style="display: flex; gap: 8px;">
                                    <select id="galaStatusFilter" onchange="GalaAdmin.filterRegistrations()" style="padding: 6px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-size: 13px;">
                                        <option value="all">All Statuses</option>
                                        <option value="pending">Pending</option>
                                        <option value="approved">Approved</option>
                                        <option value="confirmed">Confirmed (Paid)</option>
                                        <option value="rejected">Rejected</option>
                                    </select>
                                </div>
                            </div>
                            <div class="card-body" id="galaRegistrationsList" style="padding: 0;">
                                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 24px;"></i>
                                    <p>Loading registrations...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div id="galaSettingsTab" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Event Settings</h3>
                            </div>
                            <div class="card-body">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div class="form-group">
                                        <label class="form-label">Event Title</label>
                                        <input type="text" class="form-input" id="galaSettingTitle" placeholder="Gala Evening 2026">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Tagline</label>
                                        <input type="text" class="form-input" id="galaSettingTagline" placeholder="The Pinnacle of Biomedical Excellence">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Date</label>
                                        <input type="date" class="form-input" id="galaSettingDate">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Time</label>
                                        <input type="time" class="form-input" id="galaSettingTime">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Venue</label>
                                        <input type="text" class="form-input" id="galaSettingVenue" placeholder="Grand Ballroom, Zagreb">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Dress Code</label>
                                        <input type="text" class="form-input" id="galaSettingDressCode" placeholder="Black Tie / Formal Evening Attire">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Capacity</label>
                                        <input type="number" class="form-input" id="galaSettingCapacity" placeholder="150">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Registration Open</label>
                                        <select class="form-input" id="galaSettingRegOpen">
                                            <option value="1">Yes</option>
                                            <option value="0">No</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group" style="margin-top: 16px;">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-input" id="galaSettingDescription" rows="3" placeholder="Event description..."></textarea>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-top: 16px;">
                                    <div class="form-group">
                                        <label class="form-label">Gala Only Price (EUR)</label>
                                        <input type="number" class="form-input" id="galaSettingPriceOnly" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Bundle Price (EUR)</label>
                                        <input type="number" class="form-input" id="galaSettingPriceBundle" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Bundle Original Price</label>
                                        <input type="number" class="form-input" id="galaSettingPriceBundleOrig" step="0.01">
                                    </div>
                                </div>
                                <div style="margin-top: 20px; display: flex; justify-content: flex-end;">
                                    <button class="btn btn-primary" onclick="GalaAdmin.saveSettings()">
                                        <i class="fas fa-save"></i> Save Settings
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;"><h3 class="card-title">Gala Speakers</h3><button class="btn btn-secondary" onclick="GalaAdmin.addSpeaker()" style="font-size: 12px;"><i class="fas fa-plus"></i> Add Speaker</button></div>
                            <div class="card-body" id="galaSpeakersEditor"></div>
                        </div>
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;"><h3 class="card-title">Gala Schedule / Timeline</h3><button class="btn btn-secondary" onclick="GalaAdmin.addScheduleItem()" style="font-size: 12px;"><i class="fas fa-plus"></i> Add Item</button></div>
                            <div class="card-body" id="galaScheduleEditor"></div>
                        </div>
                        <div style="margin-top: 20px; display: flex; justify-content: flex-end;"><button class="btn btn-primary" onclick="GalaAdmin.saveSpeakersAndSchedule()" style="padding: 12px 32px;"><i class="fas fa-save"></i> Save Speakers & Schedule</button></div>
                    </div>
                </div>

            </main>

            <!-- Chat Panel -->
            <div class="chat-panel" id="chatPanel">
                <div class="resize-handle resize-handle-right" id="chatResizeHandle"></div>
                <div class="chat-header">
                    <div class="chat-channel-name" id="chatChannelHeader">
                        <i class="fas fa-comments" style="color: var(--accent-gold); margin-right: 6px;"></i>
                        <h3 id="chatChannelTitle">Team Chat</h3>
                    </div>
                    <div class="chat-header-actions" style="display: flex; gap: 8px;">
                        <button class="chat-action-btn" id="chatPinBtn" onclick="App.toggleChatPin()" title="Pin/Unpin chat">
                            <i class="fas fa-thumbtack"></i>
                        </button>
                        <button class="chat-action-btn" id="chatHideBtn" onclick="App.toggleChatVisibility()" title="Hide chat">
                            <i class="fas fa-eye-slash"></i>
                        </button>
                    </div>
                </div>

                <!-- Team Members Strip -->
                <div class="chat-team-strip" id="teamMembersStrip">
                    <span class="chat-team-strip-label">Team:</span>
                    <!-- Team member bubbles will be rendered here -->
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="chat-empty">
                        <i class="fas fa-comments"></i>
                        <p>No messages yet</p>
                    </div>
                </div>

                <div class="chat-input-wrapper">
                    <div class="chat-upload-progress" id="chatUploadProgress">
                        <div class="progress-bar"><div class="progress-fill" id="uploadProgressFill"></div></div>
                        <span class="progress-text" id="uploadProgressText">Uploading...</span>
                    </div>
                    <div class="chat-reply-preview" id="chatReplyPreview" style="display: none;">
                        <div class="chat-reply-preview-text">
                            <span class="chat-reply-preview-name" id="replyToName"></span>
                            <span id="replyToText"></span>
                        </div>
                        <button class="chat-reply-cancel" onclick="App.cancelReply()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="chat-input-container">
                        <input type="file" class="chat-file-input" id="chatFileInput" onchange="App.handleFileSelect(event)" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt">
                        <button class="chat-file-btn" onclick="document.getElementById('chatFileInput').click()" title="Upload file">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="text" class="chat-input" id="chatInput" placeholder="Message everyone..." onkeypress="if(event.key==='Enter') App.sendMessage()">
                        <button class="chat-send-btn" onclick="App.sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Show Chat Button (when hidden) -->
    <button class="chat-show-btn" id="chatShowBtn" onclick="App.toggleChatVisibility()">
        <i class="fas fa-comments"></i> Show Chat
    </button>

    <!-- Portal Content Modal -->
    <div class="modal-overlay" id="pcModal" style="display: none;" onclick="if(event.target===this) App.closeModal('pcModal');">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="pcModalTitle">Add Content</h2>
                <button class="modal-close" onclick="App.closeModal('pcModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pcEditId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Section *</label>
                        <select class="form-input" id="pcSection">
                            <option value="hero">Hero Cards</option>
                            <option value="news">News / Announcements</option>
                            <option value="featured">Featured Content</option>
                            <option value="links">Quick Links</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Project (optional)</label>
                        <select class="form-input" id="pcProject">
                            <option value="">Global (all projects)</option>
                            <option value="plexus">Plexus Conference</option>
                            <option value="accelerator">Accelerator</option>
                            <option value="forum">Biomedical Forum</option>
                            <option value="bridges">Building Bridges</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" class="form-input" id="pcTitle" placeholder="e.g., Plexus 2026 Registration Now Open">
                </div>
                <div class="form-group">
                    <label class="form-label">Content / Body</label>
                    <textarea class="form-input" id="pcContent" rows="4" placeholder="Write the content body..."></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Image URL (optional)</label>
                        <input type="text" class="form-input" id="pcImageUrl" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Link URL (optional)</label>
                        <input type="text" class="form-input" id="pcLink" placeholder="e.g., plexus or https://...">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Sort Order</label>
                        <input type="number" class="form-input" id="pcSortOrder" value="0" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <div style="display: flex; align-items: center; gap: 12px; padding-top: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="pcPublished" style="width: 18px; height: 18px; accent-color: var(--accent-gold);">
                                <span style="font-size: 14px;">Published</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Preview Panel -->
                <div style="margin-top: 16px; padding: 16px; background: var(--bg-primary); border: 1px solid var(--border); border-radius: 12px;">
                    <div style="font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">Preview</div>
                    <div id="pcPreview" style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border);">
                        <div style="color: var(--text-muted); text-align: center; padding: 20px; font-size: 13px;">
                            <i class="fas fa-eye" style="margin-right: 6px;"></i> Fill in the fields above to see a preview
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="App.closeModal('pcModal')">Cancel</button>
                <button class="btn btn-primary" onclick="PortalContentApp.save()">
                    <i class="fas fa-save" style="margin-right: 6px;"></i> Save
                </button>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h2 id="taskModalTitle">Add Task</h2>
                <button class="modal-close" onclick="App.closeModal('taskModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="taskEditId">
                <div class="form-group">
                    <label class="form-label">What needs to be done?</label>
                    <input type="text" class="form-input" id="taskTitle" placeholder="e.g., Send speaker invitations">
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optional)</label>
                    <textarea class="form-input" id="taskDesc" rows="2" placeholder="Additional details..."></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Due date</label>
                        <input type="date" class="form-input" id="taskDue">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <select class="form-input" id="taskPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Project (optional)</label>
                        <select class="form-input" id="taskProject">
                            <option value="">No project</option>
                            <option value="plexus">Plexus Conference</option>
                            <option value="accelerator">Accelerator</option>
                            <option value="forum">Biomedical Forum</option>
                            <option value="bridges">Building Bridges</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Assign to</label>
                        <select class="form-input" id="taskAssignee">
                            <option value="">Unassigned</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Attachments</label>
                    <div id="taskFiles" style="margin-bottom: 8px;"></div>
                    <input type="file" id="taskFileInput" multiple style="display: none;" onchange="App.handleTaskFiles(event)">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('taskFileInput').click()">
                        <i class="fas fa-paperclip"></i> Attach Files
                    </button>
                </div>
                <div class="form-group" id="subtasksSection" style="display: none;">
                    <label class="form-label">Subtasks</label>
                    <div id="taskSubtasks" style="margin-bottom: 8px;"></div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="form-input" id="newSubtaskTitle" placeholder="Add subtask..." style="flex: 1;" onkeypress="if(event.key==='Enter'){event.preventDefault();App.addSubtask();}">
                        <button type="button" class="btn btn-secondary" onclick="App.addSubtask()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="App.closeModal('taskModal')">Cancel</button>
                <button class="btn btn-danger" id="taskDeleteBtn" style="display: none;" onclick="App.deleteTask()">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button class="btn btn-primary" id="taskSaveBtn" onclick="App.saveTask()">Add Task</button>
            </div>
        </div>
    </div>

    <!-- Sequence Modal -->
    <div class="modal-overlay" id="sequenceModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h2 id="sequenceModalTitle">Create Sequence Task</h2>
                <button class="modal-close" onclick="App.closeModal('sequenceModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Sequence Name</label>
                    <input type="text" class="form-input" id="seqName" placeholder="e.g., Onboard new speaker">
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optional)</label>
                    <textarea class="form-input" id="seqDesc" rows="2" placeholder="What is this sequence for?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Project (optional)</label>
                    <select class="form-input" id="seqProject">
                        <option value="">No project</option>
                        <option value="plexus">Plexus Conference</option>
                        <option value="accelerator">Accelerator</option>
                        <option value="forum">Biomedical Forum</option>
                        <option value="bridges">Building Bridges</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Steps (in order)</label>
                    <div id="seqSteps" style="margin-bottom: 8px;"></div>
                    <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 8px;">
                        <input type="text" class="form-input" id="seqStepTitle" placeholder="Step description...">
                        <select class="form-input" id="seqStepAssignee" style="width: 150px;">
                            <option value="">Unassigned</option>
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="App.addSequenceStep()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="App.closeModal('sequenceModal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.createSequence()">Create Sequence</button>
            </div>
        </div>
    </div>

    <!-- Timeline Event Modal -->
    <div class="modal-overlay" id="timelineEventModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="timelineEventModalTitle">Add Timeline Event</h2>
                <button class="modal-close" onclick="App.closeModal('timelineEventModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="tlEventId">
                <input type="hidden" id="tlEventProject">
                <div class="form-group">
                    <label class="form-label">Event Name *</label>
                    <input type="text" class="form-input" id="tlEventName" placeholder="e.g., Application Deadline">
                </div>
                <div class="form-group">
                    <label class="form-label">Description (optional)</label>
                    <textarea class="form-input" id="tlEventDesc" rows="2" placeholder="Additional details..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Event Type</label>
                    <select class="form-input" id="tlEventType" onchange="App.toggleEndDate()">
                        <option value="point">Single Date (Point)</option>
                        <option value="range">Date Range (Period)</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Start Date *</label>
                        <input type="date" class="form-input" id="tlEventDate">
                    </div>
                    <div class="form-group" id="tlEndDateGroup" style="display: none;">
                        <label class="form-label">End Date *</label>
                        <input type="date" class="form-input" id="tlEventEndDate">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Color (optional)</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button type="button" class="color-btn" data-color="#a78bfa" onclick="App.selectTimelineColor('#a78bfa')" style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #a78bfa; cursor: pointer;"></button>
                        <button type="button" class="color-btn" data-color="#22d3ee" onclick="App.selectTimelineColor('#22d3ee')" style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #22d3ee; cursor: pointer;"></button>
                        <button type="button" class="color-btn" data-color="#fb923c" onclick="App.selectTimelineColor('#fb923c')" style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #fb923c; cursor: pointer;"></button>
                        <button type="button" class="color-btn" data-color="#f472b6" onclick="App.selectTimelineColor('#f472b6')" style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #f472b6; cursor: pointer;"></button>
                        <button type="button" class="color-btn" data-color="#22c55e" onclick="App.selectTimelineColor('#22c55e')" style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #22c55e; cursor: pointer;"></button>
                        <button type="button" class="color-btn" data-color="#ef4444" onclick="App.selectTimelineColor('#ef4444')" style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #ef4444; cursor: pointer;"></button>
                        <button type="button" class="color-btn" data-color="#c9a962" onclick="App.selectTimelineColor('#c9a962')" style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; background: #c9a962; cursor: pointer;"></button>
                    </div>
                    <input type="hidden" id="tlEventColor" value="">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="App.closeModal('timelineEventModal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.saveTimelineEvent()">Save Event</button>
            </div>
        </div>
    </div>

    <!-- Add Speaker Modal -->
    <div class="modal-overlay" id="addSpeakerModal">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <h3>Add Speaker</h3>
                <button class="modal-close" onclick="App.closeModal('addSpeakerModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group"><label>Name *</label><input type="text" class="search-input" id="newSpkName" placeholder="Full name"></div>
                    <div class="form-group"><label>Title</label><input type="text" class="search-input" id="newSpkTitle" placeholder="Professor, Dr., etc."></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="form-group"><label>Institution</label><input type="text" class="search-input" id="newSpkInstitution" placeholder="University, hospital..."></div>
                    <div class="form-group"><label>Email</label><input type="email" class="search-input" id="newSpkEmail" placeholder="speaker@example.com"></div>
                </div>
                <div class="form-group"><label>Talk Title</label><input type="text" class="search-input" id="newSpkTalkTitle" placeholder="Optional"></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                    <div class="form-group"><label>Type</label><select class="search-input" id="newSpkType"><option value="invited">Invited</option><option value="keynote">Keynote</option><option value="contributed">Contributed</option><option value="panel">Panel</option><option value="workshop">Workshop</option></select></div>
                    <div class="form-group"><label>Year</label><select class="search-input" id="newSpkYear"><option value="2026" selected>2026</option><option value="2025">2025</option><option value="2024">2024</option></select></div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 8px; padding-top: 22px;"><input type="checkbox" id="newSpkKeynote"><label for="newSpkKeynote" style="margin: 0;">Keynote</label></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="App.closeModal('addSpeakerModal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.submitNewSpeaker()"><i class="fas fa-plus"></i> Add Speaker</button>
            </div>
        </div>
    </div>

    <!-- Project Settings Modal -->
    <div class="modal-overlay" id="projectSettingsModal">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <h2 id="projectSettingsModalTitle">Edit Project Details</h2>
                <button class="modal-close" onclick="App.closeModal('projectSettingsModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="psProject">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label class="form-label">Start Date *</label>
                        <input type="date" class="form-input" id="psStartDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" id="psEndDate">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Venue</label>
                    <input type="text" class="form-input" id="psVenue" placeholder="e.g., Hotel Esplanade">
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <input type="text" class="form-input" id="psLocation" placeholder="e.g., Zagreb, Croatia">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="psDescription" placeholder="Short description">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="App.closeModal('projectSettingsModal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.saveProjectSettings()"><i class="fas fa-save" style="margin-right: 6px;"></i>Save</button>
            </div>
        </div>
    </div>

    <!-- Finance Modals -->
    <!-- Bank Balance Modal -->
    <div class="modal-overlay" id="finBankBalanceModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3>Add Bank Balance Entry</h3>
                <button class="modal-close" onclick="FinanceApp.closeModal('finBankBalanceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Balance (EUR)</label>
                    <input type="number" id="finBankBalanceAmount" step="0.01" placeholder="0.00" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="finBankBalanceDate" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="finBankBalanceNotes" rows="2" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="FinanceApp.closeModal('finBankBalanceModal')">Cancel</button>
                <button class="btn btn-primary" onclick="FinanceApp.saveBankBalance()">Save</button>
            </div>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div class="modal-overlay" id="finTransactionModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h3 id="finTransactionModalTitle">Add Transaction</h3>
                <button class="modal-close" onclick="FinanceApp.closeModal('finTransactionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="finTransactionId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="finTransactionType" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Amount (EUR)</label>
                        <input type="number" id="finTransactionAmount" step="0.01" placeholder="0.00" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="finTransactionDate" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="finTransactionDesc" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Project</label>
                        <select id="finTransactionProject" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="">None</option>
                            <option value="plexus">Plexus</option>
                            <option value="accelerator">Accelerator</option>
                            <option value="forum">Forum</option>
                            <option value="bridges">Bridges</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Work Unit</label>
                        <select id="finTransactionWorkUnit" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="">None</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="FinanceApp.closeModal('finTransactionModal')">Cancel</button>
                <button class="btn btn-primary" onclick="FinanceApp.saveTransaction()">Save</button>
            </div>
        </div>
    </div>

    <!-- Work Unit Modal -->
    <div class="modal-overlay" id="finWorkUnitModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="finWorkUnitModalTitle">Add Work Unit</h3>
                <button class="modal-close" onclick="FinanceApp.closeModal('finWorkUnitModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="finWorkUnitId">
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 16px;">
                    <div class="form-group">
                        <label>Code</label>
                        <input type="text" id="finWorkUnitCode" placeholder="RJ-2026-001" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="finWorkUnitName" placeholder="Grant name" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Grant Source</label>
                    <input type="text" id="finWorkUnitSource" placeholder="EU, Ministry, etc." style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Total Budget (EUR)</label>
                    <input type="number" id="finWorkUnitBudget" step="0.01" placeholder="0.00" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="finWorkUnitDesc" rows="2" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="FinanceApp.closeModal('finWorkUnitModal')">Cancel</button>
                <button class="btn btn-primary" onclick="FinanceApp.saveWorkUnit()">Save</button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal-overlay" id="finInvoiceModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="finInvoiceModalTitle">Create Invoice</h3>
                <button class="modal-close" onclick="FinanceApp.closeModal('finInvoiceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="finInvoiceId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label>Direction</label>
                        <select id="finInvoiceDirection2" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="outgoing">Outgoing - We Issue</option>
                            <option value="incoming">Incoming - We Receive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fiscalized</label>
                        <select id="finInvoiceFiscalized" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="0">No</option>
                            <option value="1">Yes</option>
                        </select>
                    </div>
                </div>
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 12px; color: var(--text-primary);">Party Information</h4>
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="finInvoicePartyName" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="finInvoicePartyAddress" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label>Tax ID (OIB)</label>
                            <input type="text" id="finInvoicePartyOib" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="finInvoicePartyEmail" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        </div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label>Issue Date</label>
                        <input type="date" id="finInvoiceIssueDate" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="finInvoiceDueDate" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                </div>
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin-bottom: 12px; color: var(--text-primary);">Line Items</h4>
                    <div id="finInvoiceItems"></div>
                    <button class="btn btn-secondary" onclick="FinanceApp.addInvoiceItem()" style="margin-top: 8px;">
                        <i class="fas fa-plus"></i> Add Item
                    </button>
                </div>
                <div style="text-align: right; font-size: 16px; margin-bottom: 16px;">
                    <div style="margin-bottom: 4px;">Subtotal: <strong id="finInvoiceSubtotal">0.00 EUR</strong></div>
                    <div style="margin-bottom: 4px;">Discount: <strong id="finInvoiceDiscount">0.00 EUR</strong></div>
                    <div style="margin-bottom: 4px;">VAT: <strong id="finInvoiceVat">0.00 EUR</strong></div>
                    <div style="font-size: 18px; color: var(--finances);">Total: <strong id="finInvoiceTotal">0.00 EUR</strong></div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="finInvoiceNotes" rows="2" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="FinanceApp.closeModal('finInvoiceModal')">Cancel</button>
                <button class="btn btn-primary" onclick="FinanceApp.saveInvoice()">Save</button>
            </div>
        </div>
    </div>

    <!-- Payment Order Modal -->
    <div class="modal-overlay" id="finPaymentOrderModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="finPaymentOrderModalTitle">Add Payment Order</h3>
                <button class="modal-close" onclick="FinanceApp.closeModal('finPaymentOrderModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="finPaymentOrderId">
                <div class="form-group">
                    <label>Recipient Name</label>
                    <input type="text" id="finPaymentOrderRecipient" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Recipient IBAN</label>
                    <input type="text" id="finPaymentOrderIban" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Amount (EUR)</label>
                        <input type="number" id="finPaymentOrderAmount" step="0.01" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="finPaymentOrderDate" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Reference</label>
                    <input type="text" id="finPaymentOrderRef" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="finPaymentOrderDesc" rows="2" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);"></textarea>
                </div>
                <div class="form-group">
                    <label>Project</label>
                    <select id="finPaymentOrderProject" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        <option value="">None</option>
                        <option value="plexus">Plexus</option>
                        <option value="accelerator">Accelerator</option>
                        <option value="forum">Forum</option>
                        <option value="bridges">Bridges</option>
                        <option value="general">General</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="FinanceApp.closeModal('finPaymentOrderModal')">Cancel</button>
                <button class="btn btn-primary" onclick="FinanceApp.savePaymentOrder()">Save</button>
            </div>
        </div>
    </div>

    <!-- Travel Order Modal -->
    <div class="modal-overlay" id="finTravelOrderModal">
        <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="finTravelOrderModalTitle">Create Travel Order</h3>
                <button class="modal-close" onclick="FinanceApp.closeModal('finTravelOrderModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="finTravelOrderId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Traveler</label>
                        <select id="finTravelOrderTraveler" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="">Select team member</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Destination</label>
                        <input type="text" id="finTravelOrderDest" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Purpose</label>
                    <input type="text" id="finTravelOrderPurpose" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Planned Departure</label>
                        <input type="date" id="finTravelOrderDeparture" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>Planned Return</label>
                        <input type="date" id="finTravelOrderReturn" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Travel Method</label>
                        <select id="finTravelOrderMethod" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="plane">Plane</option>
                            <option value="train">Train</option>
                            <option value="bus">Bus</option>
                            <option value="car">Car</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Advance Amount (EUR)</label>
                        <input type="number" id="finTravelOrderAdvance" step="0.01" value="0" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Project</label>
                    <select id="finTravelOrderProject" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        <option value="">None</option>
                        <option value="plexus">Plexus</option>
                        <option value="accelerator">Accelerator</option>
                        <option value="forum">Forum</option>
                        <option value="bridges">Bridges</option>
                        <option value="general">General</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="finTravelOrderNotes" rows="2" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="FinanceApp.closeModal('finTravelOrderModal')">Cancel</button>
                <button class="btn btn-primary" onclick="FinanceApp.saveTravelOrder()">Create & Assign</button>
            </div>
        </div>
    </div>

    <!-- Travel Order Detail Modal -->
    <div class="modal-overlay" id="finTravelOrderDetailModal">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="finTravelOrderDetailTitle">Travel Order Details</h3>
                <button class="modal-close" onclick="FinanceApp.closeModal('finTravelOrderDetailModal')">&times;</button>
            </div>
            <div class="modal-body" id="finTravelOrderDetailBody">
            </div>
            <div class="modal-footer" id="finTravelOrderDetailFooter">
            </div>
        </div>
    </div>

    <!-- PR Content Modal -->
    <div class="modal-overlay" id="prContentModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="prContentModalTitle">Schedule Content</h3>
                <button class="modal-close" onclick="PRApp.closeModal('prContentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="prContentId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Project</label>
                        <select id="prContentProject" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="plexus">Plexus</option>
                            <option value="accelerator">Accelerator</option>
                            <option value="forum">Forum</option>
                            <option value="bridges">Bridges</option>
                            <option value="medx">Med&X</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Platform</label>
                        <select id="prContentPlatform" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="instagram">Instagram</option>
                            <option value="linkedin">LinkedIn</option>
                            <option value="twitter">Twitter/X</option>
                            <option value="facebook">Facebook</option>
                        </select>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="prContentDate" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>Time</label>
                        <input type="time" id="prContentTime" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="prContentTitle" placeholder="Brief title for internal reference" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Content / Caption</label>
                    <textarea id="prContentText" rows="4" placeholder="The post caption..." style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);"></textarea>
                </div>
                <div class="form-group">
                    <label>Hashtags</label>
                    <input type="text" id="prContentHashtags" placeholder="#plexus2026 #medx #biomedicine" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Image URL (optional)</label>
                    <input type="text" id="prContentImage" placeholder="https://..." style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="prContentStatus" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        <option value="draft">Draft</option>
                        <option value="scheduled">Scheduled</option>
                        <option value="approved">Approved</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="PRApp.closeModal('prContentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="PRApp.saveContent()"><i class="fas fa-save"></i> Save</button>
            </div>
        </div>
    </div>

    <!-- PR Newsletter Modal -->
    <div class="modal-overlay" id="prNewsletterModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="prNewsletterModalTitle">Create Newsletter</h3>
                <button class="modal-close" onclick="PRApp.closeModal('prNewsletterModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="prNewsletterId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Name (internal)</label>
                        <input type="text" id="prNewsletterName" placeholder="e.g., January 2026 Update" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>Project</label>
                        <select id="prNewsletterProject" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="">All Projects</option>
                            <option value="plexus">Plexus</option>
                            <option value="accelerator">Accelerator</option>
                            <option value="forum">Forum</option>
                            <option value="bridges">Bridges</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Subject Line</label>
                    <input type="text" id="prNewsletterSubject" placeholder="Email subject" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Preview Text</label>
                    <input type="text" id="prNewsletterPreview" placeholder="Preview text shown in inbox" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Content (HTML)</label>
                    <textarea id="prNewsletterContent" rows="10" placeholder="Newsletter HTML content..." style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary); font-family: monospace;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="PRApp.closeModal('prNewsletterModal')">Cancel</button>
                <button class="btn btn-primary" onclick="PRApp.saveNewsletter()"><i class="fas fa-save"></i> Save Draft</button>
            </div>
        </div>
    </div>

    <!-- PR Campaign Modal -->
    <div class="modal-overlay" id="prCampaignModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="prCampaignModalTitle">New Campaign</h3>
                <button class="modal-close" onclick="PRApp.closeModal('prCampaignModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="prCampaignId">
                <div class="form-group">
                    <label>Campaign Name</label>
                    <input type="text" id="prCampaignName" placeholder="e.g., Plexus 2026 Launch" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Project</label>
                    <select id="prCampaignProject" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        <option value="">Organization-wide</option>
                        <option value="plexus">Plexus</option>
                        <option value="accelerator">Accelerator</option>
                        <option value="forum">Forum</option>
                        <option value="bridges">Bridges</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="prCampaignDesc" rows="2" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="prCampaignStart" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="prCampaignEnd" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Goal</label>
                    <input type="text" id="prCampaignGoal" placeholder="e.g., 500 registrations, 10K reach" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Target Audience</label>
                    <input type="text" id="prCampaignAudience" placeholder="e.g., Medical students, young researchers" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="PRApp.closeModal('prCampaignModal')">Cancel</button>
                <button class="btn btn-primary" onclick="PRApp.saveCampaign()"><i class="fas fa-save"></i> Save</button>
            </div>
        </div>
    </div>

    <!-- PR Subscriber Modal -->
    <div class="modal-overlay" id="prSubscriberModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Add Subscriber</h3>
                <button class="modal-close" onclick="PRApp.closeModal('prSubscriberModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="prSubscriberEmail" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" id="prSubscriberFirst" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" id="prSubscriberLast" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                </div>
                <div class="form-group">
                    <label>Subscribe to</label>
                    <select id="prSubscriberProjects" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        <option value="all">All Projects</option>
                        <option value="plexus">Plexus only</option>
                        <option value="accelerator">Accelerator only</option>
                        <option value="forum">Forum only</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="PRApp.closeModal('prSubscriberModal')">Cancel</button>
                <button class="btn btn-primary" onclick="PRApp.saveSubscriber()"><i class="fas fa-plus"></i> Add</button>
            </div>
        </div>
    </div>

    <!-- PR Post Modal -->
    <div class="modal-overlay" id="prPostModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Log Published Post</h3>
                <button class="modal-close" onclick="PRApp.closeModal('prPostModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="prPostId">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Project</label>
                        <select id="prPostProject" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="plexus">Plexus</option>
                            <option value="accelerator">Accelerator</option>
                            <option value="forum">Forum</option>
                            <option value="bridges">Bridges</option>
                            <option value="medx">Med&X</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Platform</label>
                        <select id="prPostPlatform" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="instagram">Instagram</option>
                            <option value="linkedin">LinkedIn</option>
                            <option value="twitter">Twitter/X</option>
                            <option value="facebook">Facebook</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Published Date</label>
                    <input type="datetime-local" id="prPostDate" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Content / Caption</label>
                    <textarea id="prPostText" rows="3" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);"></textarea>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                    <div class="form-group">
                        <label>Likes</label>
                        <input type="number" id="prPostLikes" value="0" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>Comments</label>
                        <input type="number" id="prPostComments" value="0" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>Shares</label>
                        <input type="number" id="prPostShares" value="0" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                    <div class="form-group">
                        <label>Reach</label>
                        <input type="number" id="prPostReach" value="0" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="PRApp.closeModal('prPostModal')">Cancel</button>
                <button class="btn btn-primary" onclick="PRApp.savePost()"><i class="fas fa-save"></i> Save</button>
            </div>
        </div>
    </div>

    <!-- PR Upload Modal -->
    <div class="modal-overlay" id="prUploadModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Upload Media</h3>
                <button class="modal-close" onclick="PRApp.closeModal('prUploadModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>File</label>
                    <input type="file" id="prUploadFile" accept="image/*" style="width: 100%; padding: 10px;">
                </div>
                <div class="form-group">
                    <label>Project</label>
                    <select id="prUploadProject" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        <option value="">General</option>
                        <option value="plexus">Plexus</option>
                        <option value="accelerator">Accelerator</option>
                        <option value="forum">Forum</option>
                        <option value="bridges">Bridges</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="prUploadCategory" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        <option value="photo">Photo</option>
                        <option value="graphic">Graphic</option>
                        <option value="logo">Logo</option>
                        <option value="template">Template</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="prUploadTags" placeholder="conference, speaker, networking" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
                <div class="form-group">
                    <label>Caption</label>
                    <input type="text" id="prUploadCaption" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="PRApp.closeModal('prUploadModal')">Cancel</button>
                <button class="btn btn-primary" onclick="PRApp.uploadMedia()"><i class="fas fa-upload"></i> Upload</button>
            </div>
        </div>
    </div>

    <!-- Bridges Event Modal -->
    <div class="modal-overlay" id="bridgesEventModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="bridgesEventModalTitle">New Event</h3>
                <button class="modal-close" onclick="BridgesApp.closeModal('bridgesEventModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="bridgesEventId">
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Event Name</label>
                        <input type="text" id="bridgesEventName" placeholder="e.g., New York Symposium">
                    </div>
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="bridgesEventCity" placeholder="e.g., New York">
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Venue Name</label>
                        <input type="text" id="bridgesEventVenue" placeholder="e.g., Croatian Consulate">
                    </div>
                    <div class="form-group">
                        <label>Venue Address</label>
                        <input type="text" id="bridgesEventAddress" placeholder="Full address">
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="bridgesEventDate">
                    </div>
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="time" id="bridgesEventTime">
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <input type="time" id="bridgesEventEndTime">
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Capacity</label>
                        <input type="number" id="bridgesEventCapacity" value="50">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="bridgesEventStatusSelect">
                            <option value="planning">Planning</option>
                            <option value="upcoming">Upcoming</option>
                            <option value="registration_open">Registration Open</option>
                            <option value="ongoing">Ongoing</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Registration Deadline</label>
                        <input type="date" id="bridgesEventDeadline">
                    </div>
                </div>
                <div class="form-group">
                    <label>Contact Email</label>
                    <input type="email" id="bridgesEventEmail" placeholder="contact@medx.hr">
                </div>
                <div class="form-group">
                    <label>Contact Phone</label>
                    <input type="tel" id="bridgesEventPhone" placeholder="+385 91 234 5678">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="bridgesEventDescriptionInput" rows="3" placeholder="Brief description of the event..."></textarea>
                </div>
                <div class="form-group">
                    <label>Notes (internal)</label>
                    <textarea id="bridgesEventNotes" rows="2" placeholder="Internal notes..."></textarea>
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0;">
                        <input type="checkbox" id="bridgesEventPublished" style="width: 18px; height: 18px; accent-color: var(--bridges);">
                        <span style="font-weight: 600;">Published to User Portal</span>
                    </label>
                    <span style="font-size: 12px; color: var(--text-muted);">When published, this event is visible on the user-facing Building Bridges page</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="BridgesApp.closeModal('bridgesEventModal')">Cancel</button>
                <button class="btn btn-primary" onclick="BridgesApp.saveEvent()"><i class="fas fa-save"></i> Save Event</button>
            </div>
        </div>
    </div>

    <!-- Network Panel (sliding panel from left - wide version) -->
    <div id="networkPanel" style="position: fixed; top: 0; left: -65%; width: 65%; height: 100vh; background: var(--bg-secondary); border-right: 1px solid var(--border); z-index: 1001; transition: left 0.3s ease; display: flex; flex-direction: column;">
        <div style="padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <h2 style="font-size: 20px; font-weight: 600;"><i class="fas fa-address-book" style="color: var(--accent-gold); margin-right: 10px;"></i>My Network</h2>
            <button onclick="NetworkApp.closePanel()" style="background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; padding: 4px 8px;">&times;</button>
        </div>
        <div style="padding: 12px 24px; border-bottom: 1px solid var(--border); display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <input type="text" id="networkSearch" placeholder="Search by name, organization, or notes..." onkeyup="NetworkApp.loadContacts()" style="flex: 1; min-width: 250px; padding: 10px 14px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
            <select id="networkProjectFilter" onchange="NetworkApp.loadContacts()" style="padding: 10px 14px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); min-width: 140px;">
                <option value="">All Projects</option>
                <option value="plexus">Plexus</option>
                <option value="accelerator">Accelerator</option>
                <option value="forum">Forum</option>
                <option value="bridges">Bridges</option>
            </select>
            <label style="display: flex; align-items: center; gap: 6px; color: var(--text-secondary); font-size: 13px; cursor: pointer;">
                <input type="checkbox" id="networkFavoritesOnly" onchange="NetworkApp.loadContacts()"> Favorites only
            </label>
            <button class="btn btn-primary" onclick="NetworkApp.openContactModal()" style="padding: 10px 16px;"><i class="fas fa-plus"></i> Add Contact</button>
        </div>
        <!-- Horizontal table layout -->
        <div style="flex: 1; overflow: auto; padding: 16px 24px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;" id="networkContactsTable">
                <thead>
                    <tr style="border-bottom: 2px solid var(--border); text-align: left;">
                        <th style="padding: 10px 8px; color: var(--text-muted); font-weight: 600; width: 30px;"></th>
                        <th style="padding: 10px 8px; color: var(--text-muted); font-weight: 600;">Name</th>
                        <th style="padding: 10px 8px; color: var(--text-muted); font-weight: 600;">Title / Organization</th>
                        <th style="padding: 10px 8px; color: var(--text-muted); font-weight: 600;">Projects</th>
                        <th style="padding: 10px 8px; color: var(--text-muted); font-weight: 600;">Location</th>
                        <th style="padding: 10px 8px; color: var(--text-muted); font-weight: 600;">Contact</th>
                        <th style="padding: 10px 8px; color: var(--text-muted); font-weight: 600;">Notes / Action Items</th>
                        <th style="padding: 10px 8px; color: var(--text-muted); font-weight: 600; width: 80px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="networkContactsList">
                    <tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--text-muted);">Loading contacts...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    <div id="networkOverlay" onclick="NetworkApp.closePanel()" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none;"></div>

    <!-- Network Contact Modal -->
    <div class="modal-overlay" id="networkContactModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h3 id="networkContactModalTitle">Add Contact</h3>
                <button class="modal-close" onclick="NetworkApp.closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="networkContactId">
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" id="networkFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input type="text" id="networkLastName" required>
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Organization</label>
                        <input type="text" id="networkOrg">
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <input type="text" id="networkPosition">
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="networkEmail">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="networkPhone">
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" id="networkCity">
                    </div>
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" id="networkCountry">
                    </div>
                </div>
                <div class="form-group">
                    <label>Projects (for which projects is this contact relevant?)</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="checkbox" id="networkProjPlexus" value="plexus"> Plexus</label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="checkbox" id="networkProjAccelerator" value="accelerator"> Accelerator</label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="checkbox" id="networkProjForum" value="forum"> Forum</label>
                        <label style="display: flex; align-items: center; gap: 4px; cursor: pointer;"><input type="checkbox" id="networkProjBridges" value="bridges"> Bridges</label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Tags (comma separated)</label>
                    <input type="text" id="networkTags" placeholder="e.g., speaker, sponsor, mentor">
                </div>
                <div class="form-group">
                    <label>Notes / Action Items</label>
                    <textarea id="networkNotes" rows="3" placeholder="What do you need to contact them about?"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="NetworkApp.closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="NetworkApp.saveContact()"><i class="fas fa-save"></i> Save</button>
            </div>
        </div>
    </div>

    <!-- Bridges Registration Modal -->
    <div class="modal-overlay" id="bridgesRegModal">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h3 id="bridgesRegModalTitle">Add Registration</h3>
                <button class="modal-close" onclick="BridgesApp.closeModal('bridgesRegModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="bridgesRegId">
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" id="bridgesRegFirstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input type="text" id="bridgesRegLastName" required>
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="bridgesRegEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="bridgesRegPhone">
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Institution</label>
                        <input type="text" id="bridgesRegInstitution">
                    </div>
                    <div class="form-group">
                        <label>Position</label>
                        <input type="text" id="bridgesRegPosition">
                    </div>
                </div>
                <div class="form-group">
                    <label>Dietary Requirements</label>
                    <input type="text" id="bridgesRegDietary" placeholder="e.g., Vegetarian, Halal, Allergies...">
                </div>
                <div class="form-group">
                    <label>Special Requests</label>
                    <textarea id="bridgesRegSpecial" rows="2" placeholder="Any special accommodations needed..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="BridgesApp.closeModal('bridgesRegModal')">Cancel</button>
                <button class="btn btn-primary" onclick="BridgesApp.saveRegistration()"><i class="fas fa-save"></i> Save</button>
            </div>
        </div>
    </div>

    <!-- Bridges Speaker Modal -->
    <div class="modal-overlay" id="bridgesSpeakerModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="bridgesSpeakerModalTitle">Add Speaker</h3>
                <button class="modal-close" onclick="BridgesApp.closeModal('bridgesSpeakerModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="bridgesSpeakerId">
                <div class="form-group">
                    <label>Event</label>
                    <select id="bridgesSpeakerEvent" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="">-- No specific event --</option>
                    </select>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="bridgesSpeakerName" placeholder="e.g., Dr. Ana Kovac">
                    </div>
                    <div class="form-group">
                        <label>Title / Position</label>
                        <input type="text" id="bridgesSpeakerTitle" placeholder="e.g., Professor of Neuroscience">
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Institution</label>
                        <input type="text" id="bridgesSpeakerInstitution" placeholder="e.g., ETH Zurich">
                    </div>
                    <div class="form-group">
                        <label>Talk Title</label>
                        <input type="text" id="bridgesSpeakerTalkTitle" placeholder="e.g., Croatian Excellence in Swiss Research">
                    </div>
                </div>
                <div class="form-group">
                    <label>Photo URL</label>
                    <input type="text" id="bridgesSpeakerPhotoUrl" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label>Bio</label>
                    <textarea id="bridgesSpeakerBio" rows="3" placeholder="Brief biography..."></textarea>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Sort Order</label>
                        <input type="number" id="bridgesSpeakerSortOrder" value="0">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="bridgesSpeakerPublished"> Publish immediately
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="BridgesApp.closeModal('bridgesSpeakerModal')">Cancel</button>
                <button class="btn btn-primary" onclick="BridgesApp.saveSpeaker()"><i class="fas fa-save"></i> Save Speaker</button>
            </div>
        </div>
    </div>

    <!-- Bridges Program Modal -->
    <div class="modal-overlay" id="bridgesProgramModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 id="bridgesProgramModalTitle">Add Program Item</h3>
                <button class="modal-close" onclick="BridgesApp.closeModal('bridgesProgramModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="bridgesProgramId">
                <div class="form-group">
                    <label>Event</label>
                    <select id="bridgesProgramEvent" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="">-- No specific event --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="bridgesProgramTitle" placeholder="e.g., Keynote: Croatian Excellence in Switzerland">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="bridgesProgramDescription" rows="2" placeholder="Brief description of this program item..."></textarea>
                </div>
                <div class="form-group">
                    <label>Speaker</label>
                    <select id="bridgesProgramSpeaker" style="width: 100%; padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                        <option value="">-- No speaker --</option>
                    </select>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="time" id="bridgesProgramStartTime">
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <input type="time" id="bridgesProgramEndTime">
                    </div>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label>Sort Order</label>
                        <input type="number" id="bridgesProgramSortOrder" value="0">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="bridgesProgramPublished"> Publish immediately
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="BridgesApp.closeModal('bridgesProgramModal')">Cancel</button>
                <button class="btn btn-primary" onclick="BridgesApp.saveProgramItem()"><i class="fas fa-save"></i> Save Item</button>
            </div>
        </div>
    </div>

    <!-- Card Picker Modal -->
    <div class="modal-overlay" id="cardPickerModal">
        <div class="modal" style="max-width: 480px;">
            <div class="modal-header">
                <h3>Add Card to Dashboard</h3>
                <button class="modal-close" onclick="App.closeModal('cardPickerModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="cardPickerBody" style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">
            </div>
        </div>
    </div>

    <!-- Compose Message Modal -->
    <div class="modal-overlay" id="composeMessageModal">
        <div class="modal" style="max-width: 560px;">
            <div class="modal-header">
                <h3 id="composeModalTitle">Compose Message</h3>
                <button class="modal-close" onclick="App.closeModal('composeMessageModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Recipient Email *</label>
                    <input type="email" class="search-input" id="msgRecipient" placeholder="user@example.com" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Title</label>
                    <input type="text" class="search-input" id="msgTitle" placeholder="Message title (optional)" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Message *</label>
                    <textarea class="search-input" id="msgContent" rows="6" placeholder="Type your message..." style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; padding: 16px 20px; border-top: 1px solid var(--border);">
                <button class="btn btn-secondary" onclick="App.closeModal('composeMessageModal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.sendAdminMessage()"><i class="fas fa-paper-plane"></i> Send</button>
            </div>
        </div>
    </div>

    <!-- Bulk Message Modal -->
    <div class="modal-overlay" id="bulkMessageModal">
        <div class="modal" style="max-width: 560px;">
            <div class="modal-header">
                <h3>Bulk Message</h3>
                <button class="modal-close" onclick="App.closeModal('bulkMessageModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Target Group *</label>
                    <select class="search-input" id="bulkMsgGroup" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                        <option value="">Select group...</option>
                        <option value="all">All Users</option>
                        <option value="plexus">Plexus Registrants</option>
                        <option value="forum">Forum Members</option>
                        <option value="bridges">Building Bridges</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Title</label>
                    <input type="text" class="search-input" id="bulkMsgTitle" placeholder="Message title (optional)" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);">
                </div>
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Message *</label>
                    <textarea class="search-input" id="bulkMsgContent" rows="6" placeholder="Type your message..." style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); resize: vertical;"></textarea>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 10px; padding: 16px 20px; border-top: 1px solid var(--border);">
                <button class="btn btn-secondary" onclick="App.closeModal('bulkMessageModal')">Cancel</button>
                <button class="btn btn-primary" onclick="App.sendBulkMessage()"><i class="fas fa-paper-plane"></i> Send to Group</button>
            </div>
        </div>
    </div>

    <script>
        const Toast = {
            show(message, type = 'info', duration = 3500) {
                const container = document.getElementById('toastContainer');
                if (!container) return;
                const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<i class="fas ${icons[type] || icons.info}"></i><span>${message}</span><button class="toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('removing');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            },
            success(msg) { this.show(msg, 'success'); },
            error(msg) { this.show(msg, 'error', 5000); },
            warning(msg) { this.show(msg, 'warning'); },
            info(msg) { this.show(msg, 'info'); }
        };

        function showSkeleton(containerId, type = 'cards', count = 3) {
            const el = document.getElementById(containerId);
            if (!el) return;
            let html = '';
            if (type === 'cards') {
                for (let i = 0; i < count; i++) {
                    html += '<div class="skeleton skeleton-card"></div>';
                }
            } else if (type === 'table') {
                for (let i = 0; i < count; i++) {
                    html += '<div class="skeleton skeleton-row"></div>';
                }
            } else if (type === 'grid') {
                html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">';
                for (let i = 0; i < count; i++) {
                    html += '<div class="skeleton skeleton-card" style="height: 180px;"></div>';
                }
                html += '</div>';
            }
            el.innerHTML = html;
        }

        const App = {
            token: null,
            user: null,
            teamMember: null,
            channels: [],
            currentChannel: null,
            pinnedItems: [],
            pinnedProjects: JSON.parse(localStorage.getItem('medx_pinned_projects') || '[]'),
            allTasks: {},
            chatRefreshInterval: null,
            teamMembers: [],
            dmChannel: null,
            teamListCollapsed: false,
            currentView: 'dashboard', // 'dashboard' or project name
            currentProjectChannel: null,

            // Project configuration (dates loaded from backend)
            projects: {
                plexus: { name: 'Plexus Conference', desc: 'Dec 4-5 in Zagreb', icon: 'fa-users', color: '#a78bfa', date: '2026-12-04' },
                accelerator: { name: 'Med&X Accelerator', desc: 'Research internship program', icon: 'fa-rocket', color: '#22d3ee', date: '2026-06-01' },
                forum: { name: 'Biomedical Forum', desc: 'Senior leaders network', icon: 'fa-landmark', color: '#fb923c', date: '2026-12-06' },
                bridges: { name: 'Building Bridges', desc: 'Global networking events', icon: 'fa-globe-americas', color: '#f472b6', date: '2026-04-18' },
                general: { name: 'General Tasks', desc: 'Miscellaneous tasks', icon: 'fa-tasks', color: '#6b7280', date: null }
            },

            // Timeline events (sub-events for Bridges and Accelerator)
            // type: 'point' for single events, 'range' for periods
            timelineEvents: [
                { id: 'plexus', parent: 'plexus', name: 'Plexus Conference', color: '#a78bfa', date: '2026-12-04', type: 'point' },
                { id: 'forum', parent: 'forum', name: 'Biomedical Forum', color: '#fb923c', date: '2026-12-06', type: 'point' },
                // Bridges events
                { id: 'bridges-zurich', parent: 'bridges', name: 'Zurich Symposium', color: '#f472b6', date: '2026-03-15', type: 'point' },
                { id: 'bridges-washington', parent: 'bridges', name: 'Washington Event', color: '#f472b6', date: '2026-04-18', type: 'point' },
                { id: 'bridges-boston', parent: 'bridges', name: 'Boston Symposium', color: '#f472b6', date: '2026-09-20', type: 'point' },
            ],

            // ========== CUSTOMIZABLE DASHBOARD CARDS ==========
            CARD_REGISTRY: {
                home: [
                    { id: 'portal-pulse', title: 'Portal Pulse', icon: 'fa-heartbeat', default: true, renderer: 'renderPortalPulseCard' },
                    { id: 'timeline', title: 'Timeline', icon: 'fa-calendar-alt', default: true, renderer: 'renderHomeTimeline' },
                    { id: 'tasks', title: 'Tasks', icon: 'fa-tasks', default: true, renderer: 'renderHomeTasks' },
                    { id: 'sequences', title: 'Sequences', icon: 'fa-stream', default: true, renderer: 'renderHomeSequences' },
                    { id: 'project-activity', title: 'Project Activity', icon: 'fa-chart-line', default: true, renderer: 'renderProjectActivity' },
                    { id: 'registration-trends', title: 'Registration Trends', icon: 'fa-chart-area', default: false, renderer: 'renderRegistrationTrends' },
                    { id: 'finance-overview', title: 'Finance Overview', icon: 'fa-euro-sign', default: false, renderer: 'renderFinanceOverview' },
                    { id: 'recent-registrations', title: 'Recent Registrations', icon: 'fa-user-plus', default: false, renderer: 'renderRecentRegistrations' },
                    { id: 'upcoming-events', title: 'Upcoming Events', icon: 'fa-calendar-check', default: false, renderer: 'renderUpcomingEvents' },
                    { id: 'team-activity', title: 'Team Activity', icon: 'fa-users', default: false, renderer: 'renderTeamActivity' },
                    { id: 'notes', title: 'Quick Notes', icon: 'fa-sticky-note', default: false, renderer: 'renderQuickNotes' },
                ],
                plexus: [
                    { id: 'px-stats', title: 'Stats Overview', icon: 'fa-chart-bar', default: true, renderer: 'renderPlexusStatsCard' },
                    { id: 'px-charts', title: 'Charts', icon: 'fa-chart-pie', default: true, renderer: 'renderPlexusChartsCard' },
                    { id: 'px-pending', title: 'Pending Actions', icon: 'fa-clock', default: true, renderer: 'renderPlexusPendingCard' },
                    { id: 'px-tasks', title: 'Tasks', icon: 'fa-tasks', default: true, renderer: 'renderPlexusTasksCard' },
                    { id: 'px-files', title: 'Files', icon: 'fa-folder', default: false, renderer: 'renderPlexusFilesCard' },
                    { id: 'px-timeline', title: 'Project Timeline', icon: 'fa-calendar-alt', default: true, renderer: 'renderPlexusTimelineCard' },
                    { id: 'px-recent-reg', title: 'Recent Registrations', icon: 'fa-user-plus', default: false, renderer: 'renderPlexusRecentRegCard' },
                    { id: 'px-speaker-summary', title: 'Speaker Summary', icon: 'fa-microphone', default: false, renderer: 'renderPlexusSpeakerSummaryCard' },
                ],
                forum: [
                    { id: 'fm-stats', title: 'Stats Overview', icon: 'fa-chart-bar', default: true, renderer: 'renderForumStatsCard' },
                    { id: 'fm-activity', title: 'Activity Charts', icon: 'fa-chart-line', default: true, renderer: 'renderForumActivityCard' },
                    { id: 'fm-tasks', title: 'Tasks', icon: 'fa-tasks', default: true, renderer: 'renderForumTasksCard' },
                    { id: 'fm-files', title: 'Files', icon: 'fa-folder', default: false, renderer: 'renderForumFilesCard' },
                    { id: 'fm-timeline', title: 'Project Timeline', icon: 'fa-calendar-alt', default: true, renderer: 'renderForumTimelineCard' },
                    { id: 'fm-recent-posts', title: 'Recent Posts', icon: 'fa-comments', default: false, renderer: 'renderForumRecentPostsCard' },
                ],
                bridges: [
                    { id: 'bb-stats', title: 'Stats Overview', icon: 'fa-chart-bar', default: true, renderer: 'renderBridgesStatsCard' },
                    { id: 'bb-upcoming', title: 'Upcoming Events', icon: 'fa-calendar-check', default: true, renderer: 'renderBridgesUpcomingCard' },
                    { id: 'bb-tasks', title: 'Tasks', icon: 'fa-tasks', default: true, renderer: 'renderBridgesTasksCard' },
                    { id: 'bb-files', title: 'Files', icon: 'fa-folder', default: false, renderer: 'renderBridgesFilesCard' },
                    { id: 'bb-timeline', title: 'Project Timeline', icon: 'fa-calendar-alt', default: true, renderer: 'renderBridgesTimelineCard' },
                ],
            },
            dashboardPrefs: {},

            async init() {
                const savedToken = localStorage.getItem('medx_token');
                const savedUser = localStorage.getItem('medx_user');
                if (savedToken && savedUser) {
                    this.token = savedToken;
                    this.user = JSON.parse(savedUser);
                    await this.showApp();
                } else {
                    document.getElementById('loginPage').style.display = 'flex';
                }
                this.loadCustomShortcut();
            },

            async loadProjectSettings() {
                try {
                    const settings = await this.api('/api/projects/settings');
                    Object.keys(settings).forEach(proj => {
                        if (this.projects[proj]) {
                            this.projects[proj].date = settings[proj].date;
                            this.projects[proj].end_date = settings[proj].end_date || null;
                            this.projects[proj].venue = settings[proj].venue || null;
                            this.projects[proj].location = settings[proj].location || null;
                            if (settings[proj].description) {
                                this.projects[proj].desc = settings[proj].description;
                            }
                        }
                    });
                    this.renderTimeline();
                    this.updateProjectHeaders();
                } catch (err) {
                    console.error('Failed to load project settings:', err);
                }
            },

            updateProjectHeaders() {
                Object.keys(this.projects).forEach(proj => {
                    const header = document.querySelector(`#section-${proj} .page-header p`);
                    if (header && this.projects[proj].date) {
                        const p = this.projects[proj];
                        const d = new Date(p.date);
                        let dateStr = d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                        if (p.end_date) {
                            const ed = new Date(p.end_date);
                            if (d.getMonth() === ed.getMonth() && d.getFullYear() === ed.getFullYear()) {
                                dateStr = `${d.toLocaleDateString('en-US', { month: 'long' })} ${d.getDate()}-${ed.getDate()}, ${d.getFullYear()}`;
                            } else {
                                dateStr += ` - ${ed.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}`;
                            }
                        }
                        let details = dateStr;
                        if (p.venue || p.location) {
                            const parts = [p.venue, p.location].filter(Boolean);
                            details += ` &middot; ${parts.join(', ')}`;
                        }
                        header.innerHTML = `${details} <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 11px; margin-left: 8px;" onclick="App.editProjectSettings('${proj}')"><i class="fas fa-edit"></i></button>`;
                    }
                });
            },

            editProjectSettings(project) {
                const p = this.projects[project];
                if (!p) return;
                document.getElementById('psProject').value = project;
                document.getElementById('psStartDate').value = p.date || '';
                document.getElementById('psEndDate').value = p.end_date || '';
                document.getElementById('psVenue').value = p.venue || '';
                document.getElementById('psLocation').value = p.location || '';
                document.getElementById('psDescription').value = p.desc || '';
                document.getElementById('projectSettingsModalTitle').textContent = `Edit ${p.name} Details`;
                document.getElementById('projectSettingsModal').classList.add('active');
            },

            async saveProjectSettings() {
                const project = document.getElementById('psProject').value;
                const date = document.getElementById('psStartDate').value;
                const end_date = document.getElementById('psEndDate').value;
                const venue = document.getElementById('psVenue').value;
                const location = document.getElementById('psLocation').value;
                const description = document.getElementById('psDescription').value;

                if (!date) {
                    Toast.warning('Start date is required');
                    return;
                }
                if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                    Toast.warning('Please use format YYYY-MM-DD for start date');
                    return;
                }
                if (end_date && !/^\d{4}-\d{2}-\d{2}$/.test(end_date)) {
                    Toast.warning('Please use format YYYY-MM-DD for end date');
                    return;
                }

                try {
                    await this.api(`/api/projects/${project}/settings`, {
                        method: 'PUT',
                        body: JSON.stringify({ date, end_date, venue, location, description })
                    });
                    this.projects[project].date = date;
                    this.projects[project].end_date = end_date || null;
                    this.projects[project].venue = venue || null;
                    this.projects[project].location = location || null;
                    this.projects[project].desc = description || this.projects[project].desc;
                    this.renderTimeline();
                    this.updateProjectHeaders();
                    this.renderProjects();
                    this.closeModal('projectSettingsModal');
                } catch (err) {
                    Toast.error('Failed to update project settings');
                    console.error(err);
                }
            },

            // Legacy method kept for backward compatibility
            async editProjectDate(project) {
                this.editProjectSettings(project);
            },

            async login(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                try {
                    const res = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await res.json();

                    if (data.success) {
                        this.token = data.token;
                        this.user = data.user;
                        localStorage.setItem('medx_token', data.token);
                        localStorage.setItem('medx_user', JSON.stringify(data.user));
                        await this.showApp();
                    } else {
                        document.getElementById('loginError').classList.add('show');
                    }
                } catch (err) {
                    console.error('Login error:', err);
                    document.getElementById('loginError').classList.add('show');
                }
            },

            logout() {
                localStorage.removeItem('medx_token');
                localStorage.removeItem('medx_user');
                this.token = null;
                this.user = null;
                if (this.chatRefreshInterval) clearInterval(this.chatRefreshInterval);
                document.getElementById('mainApp').classList.remove('active');
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('globalQRBtn').style.display = 'none';
            },

            async showApp() {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').classList.add('active');
                document.getElementById('globalQRBtn').style.display = 'flex';
                this.updateFabBadge();

                // Online/offline listeners for check-in queue
                window.addEventListener('online', () => this.flushCheckinQueue());
                window.addEventListener('offline', () => this.updateFabBadge());

                // Update user info
                const initials = (this.user.first_name?.[0] || '') + (this.user.last_name?.[0] || '');
                document.getElementById('userAvatar').textContent = initials || 'U';
                document.getElementById('userName').textContent = `${this.user.first_name || ''} ${this.user.last_name || ''}`.trim() || this.user.email;
                document.getElementById('welcomeHeader').textContent = `Welcome back, ${this.user.first_name || 'there'}`;

                // Set today's date
                const today = new Date();
                document.getElementById('todayDate').textContent = today.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

                // Load team member info
                await this.loadTeamMember();

                // Load all data
                await Promise.all([
                    this.loadChannels(),
                    this.loadPinnedItems(),
                    this.loadDashboardSummary(),
                    this.loadDashboardFinance(),
                    this.loadMyTravelOrders(),
                    this.loadAllTasks(),
                    this.loadProjectSettings(),
                    this.loadTeamMembers()
                ]);

                // Render UI
                this.renderProjects();
                this.renderTimeline();
                this.updateProjectHeaders();
                this.renderTeamMembers();

                // Load files for all projects
                ['plexus', 'accelerator', 'forum', 'bridges'].forEach(p => this.loadProjectFiles(p));

                // Initialize resize handles
                this.initResizeHandles();

                // Load chat preferences (hide/pin state)
                this.loadChatPreferences();

                // Load notes
                this.loadNotes();

                // Load sequences
                this.loadSequences();

                // Load network contacts count
                NetworkApp.init();

                // Load project timelines
                ['plexus', 'forum', 'bridges'].forEach(p => this.loadProjectTimeline(p));

                // Start chat refresh
                this.startChatRefresh();

                // Start clock
                this.initClock();

                // Check section preferences / onboarding
                await this.checkOnboarding();

                // Load portal pulse after sections are known
                this.loadPortalStats();

                // Initialize dashboard charts
                this.initDashboardCharts();

                // Load and render customizable dashboard cards for home
                this.loadDashboardPrefs('home').then(() => this.renderDynamicDashboard('home', 'homeDashboardCards'));

                // Restore widget visibility preferences
                this.restoreWidgetStates();

                // Update notification badge count in sidebar
                UserNotifApp.updateNotificationBadge();
            },

            initDashboardCharts() {
                // Project Activity Bar Chart
                const projectCtx = document.getElementById('dashProjectChart');
                if (projectCtx && typeof Chart !== 'undefined') {
                    if (window._dashProjectChart) window._dashProjectChart.destroy();
                    window._dashProjectChart = new Chart(projectCtx, {
                        type: 'bar',
                        data: {
                            labels: ['Plexus', 'Accelerator', 'Forum', 'Bridges'],
                            datasets: [{
                                label: 'Registrations',
                                data: [147, 38, 89, 24],
                                backgroundColor: ['#a78bfa', '#22d3ee', '#fb923c', '#f472b6'],
                                borderRadius: 8,
                                borderSkipped: false
                            }, {
                                label: 'Active Tasks',
                                data: [23, 15, 8, 6],
                                backgroundColor: ['rgba(167,139,250,0.3)', 'rgba(34,211,238,0.3)', 'rgba(251,146,60,0.3)', 'rgba(244,114,182,0.3)'],
                                borderRadius: 8,
                                borderSkipped: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { color: 'rgba(255,255,255,0.7)', font: { family: 'Inter', size: 12 } }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: { color: 'rgba(255,255,255,0.5)', font: { family: 'Inter' } },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                },
                                y: {
                                    ticks: { color: 'rgba(255,255,255,0.5)', font: { family: 'Inter' } },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                }
                            }
                        }
                    });
                }

                // Registration Trends Line Chart
                const trendCtx = document.getElementById('dashTrendChart');
                if (trendCtx && typeof Chart !== 'undefined') {
                    if (window._dashTrendChart) window._dashTrendChart.destroy();
                    window._dashTrendChart = new Chart(trendCtx, {
                        type: 'line',
                        data: {
                            labels: ['Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb'],
                            datasets: [{
                                label: 'Plexus Registrations',
                                data: [12, 28, 56, 89, 124, 147],
                                borderColor: '#a78bfa',
                                backgroundColor: 'rgba(167,139,250,0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 4,
                                pointBackgroundColor: '#a78bfa'
                            }, {
                                label: 'Accelerator Applications',
                                data: [0, 0, 5, 12, 28, 38],
                                borderColor: '#22d3ee',
                                backgroundColor: 'rgba(34,211,238,0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 4,
                                pointBackgroundColor: '#22d3ee'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { color: 'rgba(255,255,255,0.7)', font: { family: 'Inter', size: 12 } }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: { color: 'rgba(255,255,255,0.5)', font: { family: 'Inter' } },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                },
                                y: {
                                    ticks: { color: 'rgba(255,255,255,0.5)', font: { family: 'Inter' } },
                                    grid: { color: 'rgba(255,255,255,0.05)' }
                                }
                            }
                        }
                    });
                }
            },

            async api(endpoint, options = {}) {
                const res = await fetch(endpoint, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.token}`,
                        ...options.headers
                    }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || `Request failed (${res.status})`);
                return data;
            },

            // Section definitions for onboarding
            sectionDefs: [
                { id: 'dashboard', label: 'Home', icon: 'fa-home', color: '#c9a962', desc: 'Dashboard overview', alwaysOn: true },
                { id: 'plexus', label: 'Plexus Conference', icon: 'fa-users', color: '#a78bfa', desc: 'Annual flagship conference' },
                { id: 'accelerator', label: 'Med&X Accelerator', icon: 'fa-rocket', color: '#22d3ee', desc: 'Research internship program' },
                { id: 'forum', label: 'Biomedical Forum', icon: 'fa-landmark', color: '#fb923c', desc: 'Senior leaders network' },
                { id: 'bridges', label: 'Building Bridges', icon: 'fa-globe-americas', color: '#f472b6', desc: 'Global networking events' },
                { id: 'finances', label: 'Finances', icon: 'fa-coins', color: '#4ade80', desc: 'Budget & expense tracking' },
                { id: 'pr-media', label: 'PR & Media', icon: 'fa-bullhorn', color: '#f87171', desc: 'Press releases & outreach' },
                { id: 'contacts', label: 'My Network', icon: 'fa-address-book', color: '#60a5fa', desc: 'Contact management' },
            ],

            userSections: null, // null = all visible (backwards compat), array = filtered

            async checkOnboarding() {
                try {
                    const prefs = await this.api('/api/admin/sections');
                    if (!prefs.onboarded) {
                        this.showOnboardingModal();
                    } else {
                        this.userSections = prefs.sections;
                        this.applySectionFilters();
                    }
                } catch(e) {
                    console.error('Failed to check onboarding:', e);
                }
            },

            showOnboardingModal(preselected) {
                const overlay = document.getElementById('onboardingOverlay');
                const grid = document.getElementById('onboardingGrid');
                const nameEl = document.getElementById('onboardingName');

                nameEl.textContent = this.user.first_name || 'there';

                // Build section cards
                grid.innerHTML = this.sectionDefs.map(s => {
                    const isSelected = preselected ? preselected.includes(s.id) : s.alwaysOn;
                    return `
                        <div class="section-card ${isSelected ? 'selected' : ''} ${s.alwaysOn ? 'always-on' : ''}"
                             data-section="${s.id}"
                             onclick="${s.alwaysOn ? '' : 'App.toggleOnboardingSection(this)'}">
                            <div class="section-card-icon" style="background: ${s.color}20; color: ${s.color};">
                                <i class="fas ${s.icon}"></i>
                            </div>
                            <div class="section-card-info">
                                <div class="section-card-name">${s.label}</div>
                                <div class="section-card-desc">${s.alwaysOn ? 'Always visible' : s.desc}</div>
                            </div>
                            <div class="section-card-check"><i class="fas fa-check"></i></div>
                        </div>
                    `;
                }).join('');

                // Two-step open: set display, then trigger transitions on next frame
                overlay.classList.add('visible');
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => overlay.classList.add('active'));
                });
                this.updateOnboardingBtn();
            },

            toggleOnboardingSection(card) {
                card.classList.toggle('selected');
                this.updateOnboardingBtn();
            },

            updateOnboardingBtn() {
                const selected = document.querySelectorAll('#onboardingGrid .section-card.selected:not(.always-on)');
                document.getElementById('onboardingSubmit').disabled = selected.length === 0;
            },

            async saveOnboarding() {
                const cards = document.querySelectorAll('#onboardingGrid .section-card.selected');
                const sections = Array.from(cards).map(c => c.dataset.section).filter(id => id !== 'dashboard');

                try {
                    await this.api('/api/admin/sections', {
                        method: 'POST',
                        body: JSON.stringify({ sections })
                    });
                    this.userSections = sections;
                    const overlay = document.getElementById('onboardingOverlay');
                    overlay.classList.add('closing');
                    overlay.classList.remove('active');
                    setTimeout(() => {
                        overlay.classList.remove('visible', 'closing');
                    }, 300);
                    this.applySectionFilters();
                } catch(e) {
                    console.error('Failed to save sections:', e);
                }
            },

            applySectionFilters() {
                if (!this.userSections) return; // null = show everything

                // Filter project items in sidebar
                document.querySelectorAll('#projectsList .sidebar-project').forEach(el => {
                    const projectId = el.dataset.project;
                    el.style.display = this.userSections.includes(projectId) ? '' : 'none';
                });

                // Filter static nav items (Finances, PR & Media)
                document.querySelectorAll('#sidebarNav [data-section]').forEach(el => {
                    el.style.display = this.userSections.includes(el.dataset.section) ? '' : 'none';
                });

                // Filter My Network button
                const networkEl = document.getElementById('networkSection');
                if (networkEl) {
                    networkEl.style.display = this.userSections.includes('contacts') ? '' : 'none';
                }

                // Hide Organization label if both finances and pr-media are hidden
                const orgLabel = document.querySelector('#sidebarNav .nav-label:last-of-type');
                const orgDivider = orgLabel?.previousElementSibling;
                const hasOrgSections = this.userSections.includes('finances') || this.userSections.includes('pr-media');
                if (orgLabel) orgLabel.style.display = hasOrgSections ? '' : 'none';
                if (orgDivider?.classList.contains('nav-divider')) orgDivider.style.display = hasOrgSections ? '' : 'none';
            },

            openManageSections() {
                this.openSettings('sections');
            },

            // ========== SETTINGS MODAL ==========
            openSettings(tab = 'profile') {
                const overlay = document.getElementById('settingsOverlay');
                // Populate profile fields
                document.getElementById('settingsFirstName').value = this.user.first_name || '';
                document.getElementById('settingsLastName').value = this.user.last_name || '';
                document.getElementById('settingsInstitution').value = this.user.institution || '';
                document.getElementById('settingsPhone').value = this.user.phone || '';
                // Clear security fields
                document.getElementById('settingsCurrentPw').value = '';
                document.getElementById('settingsNewPw').value = '';
                document.getElementById('settingsConfirmPw').value = '';
                // Clear all feedback
                document.querySelectorAll('.settings-feedback').forEach(el => { el.textContent = ''; el.className = 'settings-feedback'; });
                // Build sections grid
                this.renderSettingsSections();
                // Open
                overlay.classList.add('visible');
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => overlay.classList.add('active'));
                });
                this.switchSettingsTab(tab);
            },

            closeSettings() {
                const overlay = document.getElementById('settingsOverlay');
                overlay.classList.add('closing');
                overlay.classList.remove('active');
                setTimeout(() => {
                    overlay.classList.remove('visible', 'closing');
                }, 300);
            },

            switchSettingsTab(tab) {
                document.querySelectorAll('.settings-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
                document.querySelectorAll('.settings-pane').forEach(p => p.classList.remove('active'));
                const paneId = { profile: 'settingsProfile', security: 'settingsSecurity', sections: 'settingsSections' }[tab];
                document.getElementById(paneId)?.classList.add('active');
            },

            renderSettingsSections() {
                const grid = document.getElementById('settingsSectionsGrid');
                const preselected = this.userSections || [];
                grid.innerHTML = this.sectionDefs.map(s => {
                    const isSelected = preselected.includes(s.id) || s.alwaysOn;
                    return `
                        <div class="section-card ${isSelected ? 'selected' : ''} ${s.alwaysOn ? 'always-on' : ''}"
                             data-section="${s.id}"
                             onclick="${s.alwaysOn ? '' : 'App.toggleSettingsSection(this)'}">
                            <div class="section-card-icon" style="background: ${s.color}20; color: ${s.color};">
                                <i class="fas ${s.icon}"></i>
                            </div>
                            <div class="section-card-info">
                                <div class="section-card-name">${s.label}</div>
                                <div class="section-card-desc">${s.alwaysOn ? 'Always visible' : s.desc}</div>
                            </div>
                            <div class="section-card-check"><i class="fas fa-check"></i></div>
                        </div>
                    `;
                }).join('');
            },

            toggleSettingsSection(card) {
                card.classList.toggle('selected');
            },

            async saveProfile() {
                const fb = document.getElementById('profileFeedback');
                fb.textContent = ''; fb.className = 'settings-feedback';
                const data = {
                    first_name: document.getElementById('settingsFirstName').value.trim(),
                    last_name: document.getElementById('settingsLastName').value.trim(),
                    institution: document.getElementById('settingsInstitution').value.trim(),
                    phone: document.getElementById('settingsPhone').value.trim(),
                    country: this.user.country || '',
                    bio: this.user.bio || '',
                    is_public_profile: this.user.is_public_profile || false
                };
                try {
                    await this.api('/api/auth/profile', { method: 'PUT', body: JSON.stringify(data) });
                    // Update local user object & sidebar
                    Object.assign(this.user, data);
                    localStorage.setItem('user', JSON.stringify(this.user));
                    const initials = (data.first_name?.[0] || '') + (data.last_name?.[0] || '');
                    document.getElementById('userAvatar').textContent = initials || 'U';
                    document.getElementById('userName').textContent = `${data.first_name} ${data.last_name}`.trim() || this.user.email;
                    document.getElementById('welcomeHeader').textContent = `Welcome back, ${data.first_name || 'there'}`;
                    fb.textContent = 'Profile updated successfully.';
                    fb.className = 'settings-feedback success';
                } catch(e) {
                    fb.textContent = e.message || 'Failed to save profile.';
                    fb.className = 'settings-feedback error';
                }
            },

            async changePassword() {
                const fb = document.getElementById('securityFeedback');
                fb.textContent = ''; fb.className = 'settings-feedback';
                const currentPassword = document.getElementById('settingsCurrentPw').value;
                const newPassword = document.getElementById('settingsNewPw').value;
                const confirmPw = document.getElementById('settingsConfirmPw').value;
                if (!currentPassword || !newPassword) { fb.textContent = 'Please fill in all fields.'; fb.className = 'settings-feedback error'; return; }
                if (newPassword.length < 6) { fb.textContent = 'New password must be at least 6 characters.'; fb.className = 'settings-feedback error'; return; }
                if (newPassword !== confirmPw) { fb.textContent = 'New passwords do not match.'; fb.className = 'settings-feedback error'; return; }
                try {
                    await this.api('/api/auth/password', { method: 'PUT', body: JSON.stringify({ currentPassword, newPassword }) });
                    fb.textContent = 'Password updated successfully.';
                    fb.className = 'settings-feedback success';
                    document.getElementById('settingsCurrentPw').value = '';
                    document.getElementById('settingsNewPw').value = '';
                    document.getElementById('settingsConfirmPw').value = '';
                } catch(e) {
                    fb.textContent = e.message || 'Failed to update password.';
                    fb.className = 'settings-feedback error';
                }
            },

            async saveSections() {
                const fb = document.getElementById('sectionsFeedback');
                fb.textContent = ''; fb.className = 'settings-feedback';
                const cards = document.querySelectorAll('#settingsSectionsGrid .section-card.selected');
                const sections = Array.from(cards).map(c => c.dataset.section).filter(id => id !== 'dashboard');
                try {
                    await this.api('/api/admin/sections', { method: 'POST', body: JSON.stringify({ sections }) });
                    this.userSections = sections;
                    this.applySectionFilters();
                    fb.textContent = 'Sections updated successfully.';
                    fb.className = 'settings-feedback success';
                    // Reload portal stats to respect new section filters
                    this.loadPortalStats();
                } catch(e) {
                    fb.textContent = e.message || 'Failed to save sections.';
                    fb.className = 'settings-feedback error';
                }
            },

            // ========== PORTAL PULSE ==========
            async loadPortalStats() {
                try {
                    const stats = await this.api('/api/dashboard/portal-stats');
                    this.portalStats = stats;
                    this.renderPortalPulse(stats);
                } catch(e) {
                    console.error('Failed to load portal stats:', e);
                    const body = document.getElementById('portalPulseBody');
                    if (body) body.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 16px;">Unable to load stats</div>';
                }
            },

            _pulseTrend(trend) {
                if (trend === 'up') return '<span class="pulse-trend pulse-trend--up">&uarr;</span>';
                if (trend === 'down') return '<span class="pulse-trend pulse-trend--down">&darr;</span>';
                return '<span class="pulse-trend pulse-trend--stable">&rarr;</span>';
            },

            _pulseMiniBar(value, max, color) {
                const pct = max > 0 ? Math.min(100, Math.round((value / max) * 100)) : 0;
                return `<div class="pulse-mini-bar"><div class="pulse-mini-bar-fill" style="width: ${pct}%; background: ${color};"></div></div>`;
            },

            _freshnessDot(count) {
                if (count > 0) return 'pulse-freshness-dot--hot';
                return 'pulse-freshness-dot--cold';
            },

            renderPortalPulse(stats) {
                const body = document.getElementById('portalPulseBody');
                if (!body) return;
                const sections = this.userSections || [];
                let cells = '';

                // Users -- always show
                cells += `
                    <div class="pulse-stat">
                        <div class="pulse-stat-header">
                            <div class="pulse-stat-header-left"><i class="fas fa-users" style="color: #c9a962;"></i><span class="pulse-stat-label">Users</span></div>
                            ${this._pulseTrend(stats.users.trend)}
                        </div>
                        <div class="pulse-stat-value">${stats.users.total}${stats.users.newThisWeek > 0 ? `<span class="pulse-stat-badge">+${stats.users.newThisWeek} this wk</span>` : ''}</div>
                        <div class="pulse-stat-detail"><span>${stats.users.admins} admins</span><span>${stats.users.newThisMonth} new /30d</span></div>
                    </div>`;

                // Plexus registrations
                if (sections.includes('plexus')) {
                    const paidPct = stats.plexus.registrations > 0 ? Math.round((stats.plexus.paid / stats.plexus.registrations) * 100) : 0;
                    cells += `
                    <div class="pulse-stat${stats.plexus.pending > 0 ? ' pulse-stat--warning' : ''}">
                        <div class="pulse-stat-header">
                            <div class="pulse-stat-header-left"><i class="fas fa-ticket-alt" style="color: #a78bfa;"></i><span class="pulse-stat-label">Registrations</span></div>
                            ${this._pulseTrend(stats.plexus.trend)}
                        </div>
                        <div class="pulse-stat-value">${stats.plexus.registrations}</div>
                        <div class="pulse-stat-detail"><span>${stats.plexus.paid} paid (${paidPct}%)</span><span>${stats.plexus.pending} pending</span></div>
                        ${this._pulseMiniBar(stats.plexus.paid, stats.plexus.registrations, '#a78bfa')}
                    </div>`;
                }

                // Abstracts
                if (sections.includes('plexus')) {
                    const reviewedPct = stats.plexus.abstracts > 0 ? Math.round((stats.plexus.abstractsAccepted / stats.plexus.abstracts) * 100) : 0;
                    cells += `
                    <div class="pulse-stat${(stats.plexus.abstractsPending || 0) > 0 ? ' pulse-stat--info' : ''}">
                        <div class="pulse-stat-header">
                            <div class="pulse-stat-header-left"><i class="fas fa-file-alt" style="color: #a78bfa;"></i><span class="pulse-stat-label">Abstracts</span></div>
                        </div>
                        <div class="pulse-stat-value">${stats.plexus.abstracts}</div>
                        <div class="pulse-stat-detail"><span>${stats.plexus.abstractsAccepted} accepted (${reviewedPct}%)</span><span>${stats.plexus.abstractsPending || 0} unreviewed</span></div>
                        ${this._pulseMiniBar(stats.plexus.abstractsAccepted, stats.plexus.abstracts, '#60a5fa')}
                    </div>`;
                }

                // Accelerator
                if (sections.includes('accelerator')) {
                    const reviewPct = stats.accelerator.applications > 0 ? Math.round(((stats.accelerator.accepted + stats.accelerator.rejected) / stats.accelerator.applications) * 100) : 0;
                    cells += `
                    <div class="pulse-stat${stats.accelerator.submitted > 0 ? ' pulse-stat--warning' : ''}">
                        <div class="pulse-stat-header">
                            <div class="pulse-stat-header-left"><i class="fas fa-rocket" style="color: #22d3ee;"></i><span class="pulse-stat-label">Applications</span></div>
                            ${this._pulseTrend(stats.accelerator.trend)}
                        </div>
                        <div class="pulse-stat-value">${stats.accelerator.applications}</div>
                        <div class="pulse-stat-detail"><span>${stats.accelerator.submitted} new</span><span>${stats.accelerator.underReview} reviewing</span><span>${stats.accelerator.accepted} accepted</span></div>
                        ${this._pulseMiniBar(stats.accelerator.accepted + stats.accelerator.rejected, stats.accelerator.applications, '#22d3ee')}
                    </div>`;
                }

                // Forum
                if (sections.includes('forum')) {
                    cells += `
                    <div class="pulse-stat">
                        <div class="pulse-stat-header">
                            <div class="pulse-stat-header-left"><i class="fas fa-landmark" style="color: #fb923c;"></i><span class="pulse-stat-label">Forum</span></div>
                            ${this._pulseTrend(stats.forum.trend)}
                        </div>
                        <div class="pulse-stat-value">${stats.forum.members}</div>
                        <div class="pulse-stat-detail"><span>${stats.forum.activeThisMonth} active /30d</span><span>${stats.forum.posts} posts</span><span>${stats.forum.events} events</span></div>
                    </div>`;
                }

                // Revenue
                if (sections.includes('plexus')) {
                    const rev = stats.plexus.revenue;
                    const formatted = rev >= 1000 ? '\u20AC' + (rev / 1000).toFixed(1) + 'k' : '\u20AC' + rev;
                    cells += `
                    <div class="pulse-stat pulse-stat--success">
                        <div class="pulse-stat-header">
                            <div class="pulse-stat-header-left"><i class="fas fa-coins" style="color: #4ade80;"></i><span class="pulse-stat-label">Revenue</span></div>
                        </div>
                        <div class="pulse-stat-value">${formatted}</div>
                        <div class="pulse-stat-detail"><span>${stats.plexus.speakers} speakers</span><span>${stats.plexus.checkedIn} checked in</span></div>
                    </div>`;
                }

                // Pending actions row -- only show if there are pending items
                if (stats.pending && stats.pending.total > 0) {
                    const p = stats.pending;
                    const items = [];
                    if (p.abstracts > 0) items.push({label: p.abstracts + ' abstracts', active: true});
                    if (p.speakerApps > 0) items.push({label: p.speakerApps + ' speaker apps', active: true});
                    if (p.scholarships > 0) items.push({label: p.scholarships + ' scholarships', active: true});
                    if (p.visas > 0) items.push({label: p.visas + ' visas', active: true});
                    if (p.refunds > 0) items.push({label: p.refunds + ' refunds', active: true});
                    // Add task alerts
                    if (stats.tasks && stats.tasks.overdue > 0) items.push({label: stats.tasks.overdue + ' overdue tasks', active: true});
                    if (stats.tasks && stats.tasks.urgent > 0) items.push({label: stats.tasks.urgent + ' urgent tasks', active: false});

                    cells += `
                    <div class="pulse-pending-row">
                        <div class="pulse-pending-header"><i class="fas fa-exclamation-circle"></i><span>Needs Attention (${p.total})</span></div>
                        <div class="pulse-pending-items">
                            ${items.map(i => `<span class="pulse-pending-tag${i.active ? ' pulse-pending-tag--active' : ''}">${i.label}</span>`).join('')}
                        </div>
                    </div>`;
                }

                // Content freshness row
                if (stats.freshness) {
                    const f = stats.freshness;
                    const hasActivity = f.registrations > 0 || f.abstracts > 0 || f.forumPosts > 0;
                    cells += `
                    <div class="pulse-freshness-row">
                        <span style="font-size: 10px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px;">7d activity</span>
                        <div class="pulse-freshness-item"><span class="pulse-freshness-dot ${this._freshnessDot(f.registrations)}"></span>${f.registrations} reg</div>
                        <div class="pulse-freshness-item"><span class="pulse-freshness-dot ${this._freshnessDot(f.abstracts)}"></span>${f.abstracts} abs</div>
                        <div class="pulse-freshness-item"><span class="pulse-freshness-dot ${this._freshnessDot(f.forumPosts)}"></span>${f.forumPosts} posts</div>
                    </div>`;
                }

                body.innerHTML = cells ? `<div class="portal-pulse-grid">${cells}</div>` : '<div style="text-align: center; color: var(--text-muted); padding: 16px;">Enable sections to see portal stats</div>';
            },

            async loadTeamMember() {
                try {
                    const result = await this.api('/api/team/me');
                    if (result && result.id) {
                        this.teamMember = result;
                        document.getElementById('userRole').textContent = this.teamMember.role || 'Team Member';
                        console.log('Team member loaded:', this.teamMember.name);
                    } else {
                        console.warn('No team member record found - creating one');
                        // Try to create a team member record
                        const newMember = await this.api('/api/team', {
                            method: 'POST',
                            body: JSON.stringify({
                                name: `${this.user.first_name || ''} ${this.user.last_name || ''}`.trim() || this.user.email,
                                role: 'Admin',
                                user_id: this.user.id
                            })
                        });
                        if (newMember && newMember.id) {
                            this.teamMember = newMember;
                        }
                    }
                } catch (err) {
                    console.error('Failed to load team member:', err);
                }
            },

            // ===== CHANNELS & CHAT =====
            async loadChannels() {
                try {
                    this.channels = await this.api('/api/channels');
                    console.log('Loaded channels:', this.channels.length);

                    // Auto-select the #general channel for homepage
                    const generalChannel = this.channels.find(c => c.is_default === 1 || c.name === 'general');
                    if (generalChannel) {
                        this.currentChannel = generalChannel;
                        console.log('Selected channel:', generalChannel.name);
                        await this.loadMessages();
                    } else if (this.channels.length > 0) {
                        // Fallback to first channel
                        this.currentChannel = this.channels[0];
                        console.log('Fallback channel:', this.currentChannel.name);
                        await this.loadMessages();
                    } else {
                        console.warn('No channels available');
                    }
                } catch (err) {
                    console.error('Failed to load channels:', err);
                }
            },

            async loadMessages() {
                if (!this.currentChannel) return;

                try {
                    const messages = await this.api(`/api/chat/messages?channel_id=${this.currentChannel.id}`);
                    this.renderMessages(messages);
                } catch (err) {
                    console.error('Failed to load messages:', err);
                }
            },

            renderMessages(messages) {
                const container = document.getElementById('chatMessages');

                if (!messages || messages.length === 0) {
                    container.innerHTML = `
                        <div class="chat-empty">
                            <i class="fas fa-comments"></i>
                            <p>No messages yet. Say hello to the team!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = messages.map(msg => {
                    const initials = msg.sender_name ? msg.sender_name.split(' ').map(n => n[0]).join('') : '?';
                    const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const msgText = this.escapeHtml(msg.message);
                    const senderName = msg.sender_name || 'Unknown';

                    // Reply reference
                    let replyHtml = '';
                    if (msg.reply_to && msg.reply_message) {
                        replyHtml = `
                            <div class="chat-message-reply-ref">
                                <strong>${msg.reply_sender_name || 'Someone'}</strong>: ${this.escapeHtml(msg.reply_message).substring(0, 40)}${msg.reply_message.length > 40 ? '...' : ''}
                            </div>
                        `;
                    }

                    // File attachment
                    let fileHtml = '';
                    if (msg.file_url) {
                        if (msg.file_type === 'image') {
                            fileHtml = `
                                <div class="chat-file">
                                    <img src="${msg.file_url}" alt="${msg.file_name || 'Image'}" class="chat-file-image" onclick="window.open('${msg.file_url}', '_blank')">
                                </div>
                            `;
                        } else {
                            fileHtml = `
                                <div class="chat-file">
                                    <a href="${msg.file_url}" target="_blank" class="chat-file-attachment" download="${msg.file_name || 'file'}">
                                        <i class="fas fa-file"></i>
                                        <span>${msg.file_name || 'Download file'}</span>
                                    </a>
                                </div>
                            `;
                        }
                    }

                    return `
                        <div class="chat-message" id="msg-${msg.id}">
                            <div class="chat-message-actions">
                                <button class="chat-reply-btn" onclick="App.setReplyTo('${msg.id}', '${senderName}', '${msgText.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-reply"></i> Reply
                                </button>
                            </div>
                            <div class="chat-message-header">
                                <div class="chat-avatar" style="background: ${msg.avatar_color || 'var(--accent-gold)'}; color: var(--bg-primary);">
                                    ${initials}
                                </div>
                                <span class="chat-sender">${senderName}</span>
                                <span class="chat-time">${time}</span>
                            </div>
                            ${replyHtml}
                            ${msg.file_url ? '' : `<div class="chat-text">${msgText}</div>`}
                            ${fileHtml}
                        </div>
                    `;
                }).join('');

                container.scrollTop = container.scrollHeight;
            },

            async sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();

                if (!message) {
                    console.log('No message to send');
                    return;
                }
                if (!this.teamMember) {
                    console.error('No team member - cannot send message');
                    Toast.warning('Unable to send message: Your team profile is not loaded. Please refresh the page.');
                    return;
                }
                if (!this.currentChannel) {
                    console.error('No channel selected - cannot send message');
                    Toast.warning('Unable to send message: No channel selected.');
                    return;
                }

                try {
                    const payload = {
                        message,
                        sender_id: this.teamMember.id,
                        channel_id: this.currentChannel.id
                    };

                    // Include reply_to if replying
                    if (this.replyingTo) {
                        payload.reply_to = this.replyingTo.id;
                    }

                    await this.api('/api/chat/messages', {
                        method: 'POST',
                        body: JSON.stringify(payload)
                    });

                    input.value = '';
                    this.cancelReply(); // Clear reply state
                    await this.loadMessages();
                } catch (err) {
                    console.error('Failed to send message:', err);
                }
            },

            startChatRefresh() {
                if (this.chatRefreshInterval) clearInterval(this.chatRefreshInterval);
                this.chatRefreshInterval = setInterval(async () => {
                    await this.loadMessages();
                }, 5000);
            },

            // ===== TEAM MEMBERS & DM =====
            async loadTeamMembers() {
                try {
                    this.teamMembers = await this.api('/api/team');
                } catch (err) {
                    console.error('Failed to load team members:', err);
                    this.teamMembers = [];
                }
            },

            renderTeamMembers() {
                const container = document.getElementById('teamMembersStrip');
                if (!container || !this.teamMembers.length) return;

                // Filter out current user from the list
                const otherMembers = this.teamMembers.filter(m => m.id !== this.teamMember?.id);

                // Keep the label and add team members
                container.innerHTML = `<span class="chat-team-strip-label">Team:</span>` +
                    otherMembers.map(member => {
                        const initials = member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                        const isActive = this.dmChannel && this.dmChannel.other_member?.id === member.id;
                        const photoUrl = member.photo_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(member.name)}&background=${member.avatar_color?.replace('#', '') || 'C9A962'}&color=0f172a&size=72`;

                        return `
                            <div class="team-member-bubble ${isActive ? 'active' : ''}" onclick="App.startDM('${member.id}')">
                                <img src="${photoUrl}" alt="${member.name}" class="team-member-photo" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(member.name)}&background=${member.avatar_color?.replace('#', '') || 'C9A962'}&color=0f172a&size=72'">
                                <div class="team-member-tooltip">
                                    <div class="team-member-tooltip-name">${member.name}</div>
                                    <div class="team-member-tooltip-role">${member.role || 'Team Member'}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
            },

            // Switch chat panel between team chat, project chat, and section chat
            switchChatPanel(mode, projectId = null) {
                const chatPanel = document.getElementById('chatPanel');
                const teamStrip = document.getElementById('teamMembersStrip');
                const chatHeader = document.getElementById('chatChannelHeader');
                const chatInput = document.getElementById('chatInput');

                // Hide project channels by default
                const channelList = document.getElementById('projectChannelList');
                if (channelList) channelList.remove();

                if (mode === 'team') {
                    // Show team chat mode
                    teamStrip.style.display = 'flex';
                    chatHeader.innerHTML = `
                        <i class="fas fa-comments" style="color: var(--accent-gold); margin-right: 6px;"></i>
                        <h3 id="chatChannelTitle">Team Chat</h3>
                    `;
                    chatInput.placeholder = 'Message everyone...';

                    // Load team chat messages
                    const defaultChannel = this.channels.find(c => c.is_default);
                    if (defaultChannel) {
                        this.currentChannel = defaultChannel;
                        this.loadMessages();
                    }
                } else if (mode === 'section' && projectId) {
                    // Show section-specific chat (Finances, PR & Media)
                    teamStrip.style.display = 'flex';

                    const sectionConfig = {
                        'finances': { name: 'Finances Team', icon: 'fa-chart-pie', color: 'var(--finances)' },
                        'pr-media': { name: 'PR & Media Team', icon: 'fa-bullhorn', color: 'var(--pr-media)' }
                    };
                    const section = sectionConfig[projectId] || { name: 'Team Chat', icon: 'fa-comments', color: 'var(--accent-gold)' };

                    chatHeader.innerHTML = `
                        <i class="fas ${section.icon}" style="color: ${section.color}; margin-right: 6px;"></i>
                        <h3 id="chatChannelTitle">${section.name}</h3>
                    `;
                    chatInput.placeholder = `Message ${section.name}...`;

                    // Find or use section-specific channel
                    const sectionChannel = this.channels.find(c => c.name?.toLowerCase().includes(projectId.replace('-', '')));
                    if (sectionChannel) {
                        this.currentChannel = sectionChannel;
                        this.loadMessages();
                    } else {
                        // Use default channel if no section channel exists
                        const defaultChannel = this.channels.find(c => c.is_default);
                        if (defaultChannel) {
                            this.currentChannel = defaultChannel;
                            this.loadMessages();
                        }
                    }
                } else if (mode === 'project' && projectId) {
                    // Show project chat mode
                    teamStrip.style.display = 'none';
                    const project = this.projects[projectId];
                    chatHeader.innerHTML = `
                        <i class="fas fa-${project.icon}" style="color: ${project.color}; margin-right: 6px;"></i>
                        <h3 id="chatChannelTitle">${project.name}</h3>
                    `;
                    chatInput.placeholder = `Message ${project.name}...`;

                    // Render project channels
                    this.renderProjectChannelsInPanel(projectId);
                }
            },

            renderProjectChannelsInPanel(projectId) {
                const channels = this.projectChannels[projectId] || [];
                const chatMessages = document.getElementById('chatMessages');

                // Create or update channel list
                let channelList = document.getElementById('projectChannelList');
                if (!channelList) {
                    channelList = document.createElement('div');
                    channelList.id = 'projectChannelList';
                    channelList.className = 'project-channel-list';
                    chatMessages.parentNode.insertBefore(channelList, chatMessages);
                }

                const activeId = this.currentProjectChannel;
                const tree = this.buildChannelTree(channels);
                let html = '';
                tree.forEach(parent => {
                    const mc = parent.member_count || 0;
                    html += `<div class="project-channel-item ${parent.id === activeId ? 'active' : ''}"
                         onclick="App.selectPanelChannel('${projectId}', '${parent.id}')">
                        <span class="channel-hash">#</span>
                        <span class="channel-name">${parent.name}</span>
                        ${mc > 0 ? `<span class="member-count" style="font-size:9px; background:var(--bg-tertiary); color:var(--text-muted); padding:1px 4px; border-radius:8px; margin-left:auto;">${mc}</span>` : ''}
                        <span class="add-subchannel-btn" onclick="event.stopPropagation(); App.addSubChannel('${projectId}', '${parent.id}', event)" title="Add sub-channel">+</span>
                    </div>`;
                    if (parent.children && parent.children.length > 0) {
                        parent.children.forEach(child => {
                            const cmc = child.member_count || 0;
                            html += `<div class="project-channel-item sub-channel ${child.id === activeId ? 'active' : ''}"
                                 onclick="App.selectPanelChannel('${projectId}', '${child.id}')">
                                <span class="channel-hash">#</span>
                                <span class="channel-name">${child.name}</span>
                                ${cmc > 0 ? `<span class="member-count" style="font-size:9px; background:var(--bg-tertiary); color:var(--text-muted); padding:1px 4px; border-radius:8px; margin-left:auto;">${cmc}</span>` : ''}
                            </div>`;
                        });
                    }
                });
                channelList.innerHTML = html || '<div class="no-channels">No channels yet</div>';

                // Auto-select first top-level channel if none selected
                const topLevel = channels.filter(ch => !ch.parent_channel_id);
                if (topLevel.length > 0 && !activeId) {
                    this.selectPanelChannel(projectId, topLevel[0].id);
                } else if (channels.length > 0 && !activeId) {
                    this.selectPanelChannel(projectId, channels[0].id);
                }
            },

            async selectPanelChannel(projectId, channelId) {
                this.currentProjectChannel = channelId;
                this.renderProjectChannelsInPanel(projectId);

                // Find the channel and set as current
                const channel = (this.projectChannels[projectId] || []).find(c => c.id === channelId);
                if (channel) {
                    this.currentChannel = channel;
                    await this.loadMessages();
                }
            },

            async startDM(memberId) {
                try {
                    const result = await this.api('/api/chat/dm', {
                        method: 'POST',
                        body: JSON.stringify({ target_member_id: memberId })
                    });

                    this.dmChannel = result;
                    this.currentChannel = result;

                    // Update header to show DM
                    const header = document.getElementById('chatChannelHeader');
                    header.innerHTML = `
                        <div class="chat-dm-indicator">
                            <button class="chat-dm-back" onclick="App.exitDM(event)" title="Back to Team Chat">
                                <i class="fas fa-arrow-left"></i>
                            </button>
                            <i class="fas fa-user" style="color: var(--accent-gold); margin-right: 6px;"></i>
                            <h3>${result.other_member.name}</h3>
                        </div>
                    `;

                    // Update placeholder
                    document.getElementById('chatInput').placeholder = `Message ${result.other_member.name}...`;

                    // Load DM messages
                    await this.loadMessages();
                    this.renderTeamMembers();
                } catch (err) {
                    console.error('Failed to start DM:', err);
                }
            },

            async exitDM(e) {
                if (e) e.stopPropagation();
                this.dmChannel = null;

                // Reset header
                const header = document.getElementById('chatChannelHeader');
                header.innerHTML = `
                    <i class="fas fa-comments" style="color: var(--accent-gold); margin-right: 6px;"></i>
                    <h3 id="chatChannelTitle">Team Chat</h3>
                `;

                // Reset placeholder
                document.getElementById('chatInput').placeholder = 'Message everyone...';

                // Switch back to default channel
                const defaultChannel = this.channels.find(c => c.is_default);
                if (defaultChannel) {
                    this.currentChannel = defaultChannel;
                }

                await this.loadMessages();
                this.renderTeamMembers();
            },

            // ===== FILE UPLOAD =====
            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Show progress
                const progressEl = document.getElementById('chatUploadProgress');
                const progressFill = document.getElementById('uploadProgressFill');
                const progressText = document.getElementById('uploadProgressText');

                progressEl.classList.add('active');
                progressFill.style.width = '0%';
                progressText.textContent = `Uploading ${file.name}...`;

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    // Upload with progress tracking
                    const xhr = new XMLHttpRequest();

                    xhr.upload.onprogress = (e) => {
                        if (e.lengthComputable) {
                            const percent = Math.round((e.loaded / e.total) * 100);
                            progressFill.style.width = percent + '%';
                            progressText.textContent = `Uploading ${file.name}... ${percent}%`;
                        }
                    };

                    xhr.onload = async () => {
                        progressEl.classList.remove('active');
                        event.target.value = ''; // Reset file input

                        if (xhr.status === 200) {
                            const result = JSON.parse(xhr.responseText);
                            // Send message with file
                            await this.sendFileMessage(result.url, result.name, result.type);
                        } else {
                            Toast.error('File upload failed');
                        }
                    };

                    xhr.onerror = () => {
                        progressEl.classList.remove('active');
                        event.target.value = '';
                        Toast.error('File upload failed');
                    };

                    xhr.open('POST', '/api/chat/upload');
                    xhr.setRequestHeader('Authorization', `Bearer ${this.token}`);
                    xhr.send(formData);
                } catch (err) {
                    progressEl.classList.remove('active');
                    event.target.value = '';
                    console.error('Failed to upload file:', err);
                    Toast.error('File upload failed');
                }
            },

            async sendFileMessage(fileUrl, fileName, fileType) {
                if (!this.teamMember || !this.currentChannel) return;

                try {
                    await this.api('/api/chat/messages', {
                        method: 'POST',
                        body: JSON.stringify({
                            message: fileName,
                            sender_id: this.teamMember.id,
                            channel_id: this.currentChannel.id,
                            file_url: fileUrl,
                            file_name: fileName,
                            file_type: fileType
                        })
                    });

                    await this.loadMessages();
                } catch (err) {
                    console.error('Failed to send file message:', err);
                }
            },

            // ===== SWISS CLOCK & TIMER =====
            clockInterval: null,
            timerInterval: null,
            timerEndTime: null,

            initClock() {
                this.updateClock();
                this.clockInterval = setInterval(() => this.updateClock(), 1000);
            },

            updateClock() {
                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes();
                const seconds = now.getSeconds();

                // Update analog hands
                const hourDeg = (hours % 12) * 30 + minutes * 0.5;
                const minDeg = minutes * 6;
                const secDeg = seconds * 6;

                const hourHand = document.getElementById('clockHour');
                const minHand = document.getElementById('clockMinute');
                const secHand = document.getElementById('clockSecond');
                const timeDisplay = document.getElementById('clockTime');

                if (hourHand) hourHand.style.transform = `rotate(${hourDeg}deg)`;
                if (minHand) minHand.style.transform = `rotate(${minDeg}deg)`;
                if (secHand) secHand.style.transform = `rotate(${secDeg}deg)`;
                if (timeDisplay) {
                    timeDisplay.textContent = now.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                }

                // Update timer if active
                if (this.timerEndTime) {
                    const remaining = this.timerEndTime - Date.now();
                    const timerEl = document.getElementById('clockTimer');
                    const cancelBtn = document.getElementById('timerCancel');

                    if (remaining <= 0) {
                        this.timerEndTime = null;
                        timerEl?.classList.remove('active', 'warning');
                        cancelBtn?.classList.remove('active');
                        this.notifyTimerEnd();
                    } else {
                        const mins = Math.floor(remaining / 60000);
                        const secs = Math.floor((remaining % 60000) / 1000);
                        timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                        timerEl.classList.add('active');
                        timerEl.classList.toggle('warning', remaining < 60000);
                    }
                }
            },

            toggleTimerDropdown(e) {
                e.stopPropagation();
                const dropdown = document.getElementById('timerDropdown');
                dropdown.classList.toggle('active');
            },

            startTimer(minutes, e) {
                e.stopPropagation();
                this.timerEndTime = Date.now() + minutes * 60000;
                document.getElementById('timerCancel').classList.add('active');
                document.getElementById('timerDropdown').classList.remove('active');
            },

            cancelTimer(e) {
                e.stopPropagation();
                this.timerEndTime = null;
                const timerEl = document.getElementById('clockTimer');
                const cancelBtn = document.getElementById('timerCancel');
                timerEl?.classList.remove('active', 'warning');
                cancelBtn?.classList.remove('active');
                document.getElementById('timerDropdown').classList.remove('active');
            },

            notifyTimerEnd() {
                // Play a subtle notification sound (using Web Audio API)
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    osc.frequency.value = 800;
                    gain.gain.value = 0.1;
                    osc.start();
                    setTimeout(() => { osc.stop(); ctx.close(); }, 200);
                } catch (e) {}

                // Show browser notification if permitted
                if (Notification.permission === 'granted') {
                    new Notification('Focus Timer', { body: 'Your focus session has ended! Want to extend?', icon: '/favicon.ico' });
                }

                // Show extend prompt in dropdown
                document.getElementById('timerPresets').style.display = 'none';
                document.getElementById('timerExtend').style.display = 'block';
                document.getElementById('timerCancel').classList.remove('active');
                document.getElementById('timerDropdown').classList.add('active');
            },

            dismissTimerPrompt(e) {
                e.stopPropagation();
                document.getElementById('timerPresets').style.display = 'flex';
                document.getElementById('timerExtend').style.display = 'none';
                document.getElementById('timerDropdown').classList.remove('active');
            },

            // ===== PINNED ITEMS =====
            async loadPinnedItems() {
                try {
                    this.pinnedItems = await this.api('/api/pinned');
                    this.renderPinnedItems();
                } catch (err) {
                    console.error('Failed to load pinned items:', err);
                }
            },

            renderPinnedItems() {
                const section = document.getElementById('pinnedItemsSection');
                const grid = document.getElementById('pinnedItemsGrid');

                if (!this.pinnedItems || this.pinnedItems.length === 0) {
                    section.style.display = 'none';
                    return;
                }

                section.style.display = 'block';

                const projectNames = {
                    plexus: 'Plexus',
                    accelerator: 'Accelerator',
                    forum: 'Forum',
                    bridges: 'Bridges'
                };

                const typeIcons = {
                    task: 'fa-check-square',
                    event: 'fa-calendar',
                    stat: 'fa-chart-bar',
                    application: 'fa-file-alt',
                    registration: 'fa-user-plus',
                    speaker: 'fa-microphone'
                };

                grid.innerHTML = this.pinnedItems.map((item, index) => {
                    const proj = item.project || 'plexus';
                    const projName = projectNames[proj] || proj;
                    const icon = typeIcons[item.item_type] || 'fa-thumbtack';

                    return `
                        <div class="pinned-item"
                             draggable="true"
                             data-pin-index="${index}"
                             data-pin-id="${item.id}"
                             onclick="App.navigateToPinnedItem('${item.item_type}', '${item.item_id}', '${proj}')">
                            <button class="unpin-btn" onclick="App.unpinItem('${item.id}'); event.stopPropagation();" title="Unpin">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            <span class="pin-source ${proj}">
                                <i class="fas fa-circle" style="font-size: 6px;"></i>
                                ${projName}
                            </span>
                            <div class="pin-title">${item.item_title}</div>
                        </div>
                    `;
                }).join('');

                // Setup drag-drop for pinned items
                this.initPinnedItemsDragDrop();
            },

            initPinnedItemsDragDrop() {
                const grid = document.getElementById('pinnedItemsGrid');
                let draggedEl = null;

                grid.querySelectorAll('.pinned-item').forEach(el => {
                    el.addEventListener('dragstart', (e) => {
                        draggedEl = el;
                        el.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                    });

                    el.addEventListener('dragend', () => {
                        draggedEl?.classList.remove('dragging');
                        grid.querySelectorAll('.pinned-item').forEach(p => p.classList.remove('drag-over-left', 'drag-over-right'));
                        draggedEl = null;
                    });

                    el.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        if (draggedEl && draggedEl !== el) {
                            const rect = el.getBoundingClientRect();
                            const midX = rect.left + rect.width / 2;
                            el.classList.remove('drag-over-left', 'drag-over-right');
                            if (e.clientX < midX) {
                                el.classList.add('drag-over-left');
                            } else {
                                el.classList.add('drag-over-right');
                            }
                        }
                    });

                    el.addEventListener('dragleave', () => {
                        el.classList.remove('drag-over-left', 'drag-over-right');
                    });

                    el.addEventListener('drop', (e) => {
                        e.preventDefault();
                        el.classList.remove('drag-over-left', 'drag-over-right');
                        if (draggedEl && draggedEl !== el) {
                            const draggedIdx = parseInt(draggedEl.dataset.pinIndex);
                            const targetIdx = parseInt(el.dataset.pinIndex);

                            // Reorder the array
                            const item = this.pinnedItems.splice(draggedIdx, 1)[0];
                            const rect = el.getBoundingClientRect();
                            const insertIdx = e.clientX < rect.left + rect.width / 2 ? targetIdx : targetIdx + 1;
                            this.pinnedItems.splice(insertIdx > draggedIdx ? insertIdx - 1 : insertIdx, 0, item);

                            // Re-render
                            this.renderPinnedItems();

                            // Save order to backend
                            this.savePinnedItemsOrder();
                        }
                    });
                });
            },

            async savePinnedItemsOrder() {
                try {
                    const order = this.pinnedItems.map(item => item.id);
                    await this.api('/api/pinned/reorder', {
                        method: 'PUT',
                        body: JSON.stringify({ order })
                    });
                } catch (err) {
                    console.error('Failed to save pinned items order:', err);
                }
            },

            navigateToPinnedItem(type, itemId, project) {
                // Navigate to the appropriate project/section based on pinned item type
                if (project) {
                    this.showProject(project);
                    // Could add more specific navigation based on type
                }
            },

            async pinItem(type, id, title, subtitle, project) {
                try {
                    await this.api('/api/pinned', {
                        method: 'POST',
                        body: JSON.stringify({
                            item_type: type,
                            item_id: id,
                            item_title: title,
                            item_subtitle: subtitle,
                            project
                        })
                    });
                    await this.loadPinnedItems();
                } catch (err) {
                    console.error('Failed to pin item:', err);
                }
            },

            async unpinItem(id) {
                try {
                    await this.api(`/api/pinned/${id}`, { method: 'DELETE' });
                    await this.loadPinnedItems();
                } catch (err) {
                    console.error('Failed to unpin item:', err);
                }
            },

            // ===== PROJECT PINNING =====
            togglePinProject(projectId, e) {
                e.stopPropagation();
                const idx = this.pinnedProjects.indexOf(projectId);
                if (idx >= 0) {
                    this.pinnedProjects.splice(idx, 1);
                } else {
                    this.pinnedProjects.push(projectId);
                }
                localStorage.setItem('medx_pinned_projects', JSON.stringify(this.pinnedProjects));
                this.renderProjects();
            },

            // Project order for drag-drop
            projectOrder: JSON.parse(localStorage.getItem('medx_project_order') || '["plexus","accelerator","forum","bridges"]'),

            renderProjects() {
                const pinnedSection = document.getElementById('pinnedProjectsSection');
                const pinnedList = document.getElementById('pinnedProjectsList');
                const sidebarList = document.getElementById('projectsList');

                const pinnedHtml = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Render sidebar projects in order
                const sortedProjects = this.projectOrder.map(id => [id, this.projects[id]]).filter(([id, proj]) => proj);

                const sidebarHtml = sortedProjects.map(([id, proj]) => {
                    const isPinned = this.pinnedProjects.includes(id);

                    return `
                        <div class="sidebar-project ${isPinned ? 'pinned' : ''}"
                             data-project="${id}"
                             draggable="true"
                             onclick="App.showProject('${id}', this)">
                            <span class="project-dot" style="background: ${proj.color}"></span>
                            <span class="project-name">${proj.name}</span>
                            <div class="project-actions">
                                <button class="pin-btn" onclick="App.togglePinProject('${id}', event)" title="${isPinned ? 'Unpin' : 'Pin'}">
                                    <i class="fas fa-star"></i>
                                </button>
                                <span class="drag-handle" title="Drag to reorder">
                                    <i class="fas fa-grip-vertical"></i>
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');

                sidebarList.innerHTML = sidebarHtml;

                // Setup drag-drop handlers
                this.initProjectDragDrop();

                // Render pinned projects on dashboard
                Object.entries(this.projects).forEach(([id, proj]) => {
                    const isPinned = this.pinnedProjects.includes(id);
                    const badgeId = `${id}Badge`;
                    // Build date string for card
                    let dateInfo = '';
                    if (proj.date) {
                        const d = new Date(proj.date);
                        dateInfo = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        if (proj.end_date) {
                            const ed = new Date(proj.end_date);
                            if (d.getMonth() === ed.getMonth()) {
                                dateInfo = `${d.toLocaleDateString('en-US', { month: 'short' })} ${d.getDate()}-${ed.getDate()}`;
                            } else {
                                dateInfo += ` - ${ed.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                            }
                        }
                    }
                    const venueInfo = [proj.venue, proj.location].filter(Boolean).join(', ');
                    const html = `
                        <div class="project-card" onclick="App.showProject('${id}')">
                            <button class="pin-project-btn ${isPinned ? 'pinned' : ''}" onclick="App.togglePinProject('${id}', event)" title="${isPinned ? 'Unpin' : 'Pin to top'}">
                                <i class="fas fa-star"></i>
                            </button>
                            <div class="project-icon ${id}"><i class="fas ${proj.icon}"></i></div>
                            <div class="project-info">
                                <div class="project-name">${proj.name}</div>
                                <div class="project-desc">${proj.desc}</div>
                                ${dateInfo || venueInfo ? `<div style="margin-top: 4px; font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                    ${dateInfo ? `<span><i class="fas fa-calendar-alt" style="margin-right: 3px;"></i>${dateInfo}</span>` : ''}
                                    ${venueInfo ? `<span><i class="fas fa-map-marker-alt" style="margin-right: 3px;"></i>${venueInfo}</span>` : ''}
                                    <button class="btn btn-secondary" style="padding: 1px 6px; font-size: 10px; line-height: 1;" onclick="event.stopPropagation(); App.editProjectSettings('${id}')" title="Edit dates & venue"><i class="fas fa-pen"></i></button>
                                </div>` : ''}
                            </div>
                            <span class="project-badge" id="${badgeId}">-</span>
                        </div>
                    `;

                    if (isPinned) {
                        pinnedHtml.push(html);
                    }
                });

                if (pinnedHtml.length > 0) {
                    pinnedSection.style.display = 'block';
                    pinnedList.innerHTML = pinnedHtml.join('');
                } else {
                    pinnedSection.style.display = 'none';
                }

                // Re-apply section filters after rendering
                this.applySectionFilters();
            },

            initProjectDragDrop() {
                const container = document.getElementById('projectsList');
                let draggedEl = null;

                container.querySelectorAll('.sidebar-project').forEach(el => {
                    el.addEventListener('dragstart', (e) => {
                        draggedEl = el;
                        el.classList.add('dragging');
                        e.dataTransfer.effectAllowed = 'move';
                    });

                    el.addEventListener('dragend', () => {
                        draggedEl?.classList.remove('dragging');
                        container.querySelectorAll('.sidebar-project').forEach(p => p.classList.remove('drag-over'));
                        draggedEl = null;
                    });

                    el.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        if (draggedEl && draggedEl !== el) {
                            el.classList.add('drag-over');
                        }
                    });

                    el.addEventListener('dragleave', () => {
                        el.classList.remove('drag-over');
                    });

                    el.addEventListener('drop', (e) => {
                        e.preventDefault();
                        el.classList.remove('drag-over');
                        if (draggedEl && draggedEl !== el) {
                            const draggedId = draggedEl.dataset.project;
                            const targetId = el.dataset.project;
                            const draggedIdx = this.projectOrder.indexOf(draggedId);
                            const targetIdx = this.projectOrder.indexOf(targetId);

                            // Remove from old position and insert at new
                            this.projectOrder.splice(draggedIdx, 1);
                            this.projectOrder.splice(targetIdx, 0, draggedId);

                            localStorage.setItem('medx_project_order', JSON.stringify(this.projectOrder));
                            this.renderProjects();
                        }
                    });
                });
            },

            // ===== VISUAL TIMELINE =====
            renderTimeline() {
                const container = document.getElementById('timelineContainer');
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // Timeline spans from Jan 1 to Dec 31
                const startDate = new Date(today.getFullYear(), 0, 1);
                const endDate = new Date(today.getFullYear(), 11, 31);
                const totalMs = endDate - startDate;

                // Calculate today's position
                const todayPosition = ((today - startDate) / totalMs) * 100;

                // Process timeline events
                const events = this.timelineEvents.map(evt => {
                    const eventDate = new Date(evt.date);
                    eventDate.setHours(0, 0, 0, 0);
                    const position = ((eventDate - startDate) / totalMs) * 100;
                    const diffDays = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));

                    let endPosition = null;
                    if (evt.type === 'range' && evt.endDate) {
                        const end = new Date(evt.endDate);
                        end.setHours(0, 0, 0, 0);
                        endPosition = ((end - startDate) / totalMs) * 100;
                    }

                    return {
                        ...evt,
                        eventDate,
                        position: Math.max(2, Math.min(98, position)),
                        endPosition: endPosition ? Math.max(2, Math.min(98, endPosition)) : null,
                        diffDays,
                        isPast: eventDate < today
                    };
                }).sort((a, b) => a.position - b.position);

                // Separate ranges and points
                const ranges = events.filter(e => e.type === 'range');
                const points = events.filter(e => e.type === 'point');

                // Assign above/below positions for point events with proper collision detection
                // Each card occupies ~10% of timeline width horizontally
                const cardWidth = 10; // percentage of timeline width a card occupies
                const baseStemHeight = 10; // px - minimum stem height
                const stemIncrement = 22; // px - how much to increase stem per collision tier
                const maxTiers = 4; // maximum number of graduated heights per lane

                // Occupied bands: track which horizontal ranges are taken at each tier per lane
                // Each entry: { left: number, right: number, tier: number }
                const occupiedAbove = [];
                const occupiedBelow = [];

                // Check if a position+tier collides with any occupied band in a lane
                function collides(occupied, position, tier) {
                    const left = position - cardWidth / 2;
                    const right = position + cardWidth / 2;
                    return occupied.some(band =>
                        band.tier === tier && !(right <= band.left || left >= band.right)
                    );
                }

                // Place each event, trying to find the best lane and tier
                points.forEach((event, i) => {
                    let bestLane = null;
                    let bestTier = maxTiers; // start with worst case

                    // Try above first (tier 0), then below (tier 0), then escalate tiers
                    for (let tier = 0; tier < maxTiers; tier++) {
                        if (!collides(occupiedAbove, event.position, tier)) {
                            bestLane = 'above';
                            bestTier = tier;
                            break;
                        }
                        if (!collides(occupiedBelow, event.position, tier)) {
                            bestLane = 'below';
                            bestTier = tier;
                            break;
                        }
                    }

                    // Fallback: if all tiers exhausted, place above at max tier
                    if (bestLane === null) {
                        bestLane = 'above';
                        bestTier = maxTiers;
                    }

                    event.position_type = bestLane;
                    event.stemHeight = baseStemHeight + (bestTier * stemIncrement);

                    // Register the occupied band
                    const band = {
                        left: event.position - cardWidth / 2,
                        right: event.position + cardWidth / 2,
                        tier: bestTier
                    };
                    if (bestLane === 'above') {
                        occupiedAbove.push(band);
                    } else {
                        occupiedBelow.push(band);
                    }
                });

                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                container.innerHTML = `
                    <div class="timeline-scroll">
                        <div class="timeline-visual">
                            <div class="timeline-track">
                                <div class="timeline-line" style="top: 50%;"></div>
                                <div class="timeline-months">
                                    ${months.map(m => `<span class="timeline-month">${m}</span>`).join('')}
                                </div>
                                <div class="timeline-today-line" style="left: ${todayPosition}%; top: 20%; height: 60%;"></div>

                                <!-- Range events (colored bars) -->
                                ${ranges.map(evt => `
                                    <div class="timeline-range"
                                         style="left: ${evt.position}%; width: ${evt.endPosition - evt.position}%; background: ${evt.color};"
                                         onclick="App.showProject('${evt.parent}')"
                                         title="${evt.name}">
                                        <span class="timeline-range-label" style="color: ${evt.color};">${evt.name}</span>
                                    </div>
                                `).join('')}

                                <!-- Point events -->
                                ${points.map(event => {
                                    const dateStr = event.eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                    return `
                                        <div class="timeline-event ${event.position_type} ${event.isPast ? 'past' : ''}"
                                             style="left: ${event.position}%;"
                                             onclick="App.showProject('${event.parent}')">
                                            <div class="timeline-dot" style="background: ${event.color};"></div>
                                            <div class="timeline-stem" style="height: ${event.stemHeight}px; background: ${event.color}40;"></div>
                                            <div class="timeline-card" style="border-color: ${event.color};">
                                                <span class="tc-name">${event.name}</span>
                                                <span class="tc-date" style="font-size: 11px; color: var(--text-secondary);">${dateStr}</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            // ===== DASHBOARD & TASKS =====
            async loadDashboardSummary() {
                try {
                    const summary = await this.api('/api/dashboard/summary');
                    this.summary = summary;

                    // Update badges after projects are rendered
                    setTimeout(() => {
                        const plexusBadge = document.getElementById('plexusBadge');
                        const accBadge = document.getElementById('acceleratorBadge');
                        const forumBadge = document.getElementById('forumBadge');
                        const bridgesBadge = document.getElementById('bridgesBadge');

                        if (plexusBadge) plexusBadge.textContent = `${summary.plexus?.registrations || 0} registered`;
                        if (accBadge) accBadge.textContent = `${summary.accelerator?.to_review || 0} to review`;
                        if (forumBadge) forumBadge.textContent = `${summary.forum?.members || 0} members`;
                        if (bridgesBadge) bridgesBadge.textContent = `${summary.bridges?.cities || 0} cities`;
                    }, 100);

                    // Update project page stats
                    const plexusStats = document.getElementById('plexusStats');
                    if (plexusStats) {
                        plexusStats.innerHTML = `
                            <div class="stat-item">
                                <div class="stat-value">${summary.plexus?.registrations || 0}</div>
                                <div class="stat-label">Registered</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${summary.plexus?.speakers || 0}</div>
                                <div class="stat-label">Speakers</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${summary.plexus?.pending_tasks || 0}</div>
                                <div class="stat-label">Tasks</div>
                            </div>
                        `;
                    }

                    const accStats = document.getElementById('acceleratorStats');
                    if (accStats) {
                        accStats.innerHTML = `
                            <div class="stat-item">
                                <div class="stat-value">${summary.accelerator?.applications || 0}</div>
                                <div class="stat-label">Applications</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${summary.accelerator?.to_review || 0}</div>
                                <div class="stat-label">To Review</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${summary.accelerator?.accepted || 0}</div>
                                <div class="stat-label">Accepted</div>
                            </div>
                        `;
                    }
                } catch (err) {
                    console.error('Failed to load summary:', err);
                }
            },

            async loadDashboardFinance() {
                try {
                    const data = await this.api(`/api/finance/dashboard?year=${new Date().getFullYear()}`);
                    const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'EUR' }).format(amount || 0);

                    document.getElementById('dashFinBalance').textContent = formatCurrency(data.currentBalance);
                    document.getElementById('dashFinIncome').textContent = formatCurrency(data.totalIncome);
                    document.getElementById('dashFinExpenses').textContent = formatCurrency(data.totalExpenses);
                    document.getElementById('dashFinNet').textContent = formatCurrency(data.netBalance);
                    document.getElementById('dashFinNet').style.color = data.netBalance >= 0 ? 'var(--success)' : 'var(--danger)';
                } catch (err) {
                    console.error('Failed to load finance summary:', err);
                }
            },

            async loadMyTravelOrders() {
                try {
                    const orders = await this.api('/api/finance/my-travel-orders');
                    const section = document.getElementById('myTravelOrdersSection');
                    const list = document.getElementById('myTravelOrdersList');

                    // Filter for orders that need user action (assigned or returned for revision)
                    const actionable = orders.filter(o => o.status === 'assigned' || o.status === 'rejected');

                    if (actionable.length === 0) {
                        section.style.display = 'none';
                        return;
                    }

                    section.style.display = 'block';
                    const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'EUR' }).format(amount || 0);

                    list.innerHTML = actionable.map(o => {
                        const statusClass = o.status === 'assigned' ? 'rgba(59,130,246,0.2)' : 'rgba(239,68,68,0.2)';
                        const statusColor = o.status === 'assigned' ? '#3b82f6' : 'var(--danger)';
                        return `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
                                <div>
                                    <strong>${o.order_number}</strong> - ${o.destination}
                                    <div style="font-size: 12px; color: var(--text-muted);">${o.planned_departure || 'TBD'} - ${o.planned_return || 'TBD'}</div>
                                    ${o.rejection_reason ? `<div style="font-size: 12px; color: var(--danger);"><i class="fas fa-exclamation-circle"></i> ${o.rejection_reason}</div>` : ''}
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="background: ${statusClass}; color: ${statusColor}; padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">${o.status}</span>
                                    <button class="btn btn-primary" onclick="App.openTravelOrderFillModal('${o.id}')" style="padding: 6px 12px; font-size: 12px;">
                                        <i class="fas fa-edit"></i> Fill Details
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } catch (err) {
                    console.error('Failed to load travel orders:', err);
                    document.getElementById('myTravelOrdersSection').style.display = 'none';
                }
            },

            async openTravelOrderFillModal(id) {
                // Navigate to finances and open travel order
                this.showSection('finances');
                setTimeout(async () => {
                    FinanceApp.showTab('travel-orders', document.querySelector('[onclick*="travel-orders"]'));
                    setTimeout(() => FinanceApp.viewTravelOrder(id), 300);
                }, 300);
            },

            async loadAllTasks() {
                const projectIds = ['plexus', 'accelerator', 'forum', 'bridges', 'general'];

                try {
                    // Load tasks for each project
                    for (const project of projectIds) {
                        const tasks = await this.api(`/api/tasks/${project}`);
                        this.allTasks[project] = tasks.filter(t => t.status !== 'done').map(t => ({ ...t, project }));
                        if (project !== 'general') {
                            this.renderProjectTasks(project, tasks);
                        }
                    }

                    // Render grouped dashboard tasks
                    this.renderDashboardTasks();
                } catch (err) {
                    console.error('Failed to load tasks:', err);
                }
            },

            renderProjectTasks(project, tasks) {
                const container = document.getElementById(`${project}Tasks`);
                if (!container) return;

                const incompleteTasks = tasks.filter(t => t.status !== 'done');

                if (incompleteTasks.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <p>All tasks completed</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = incompleteTasks.map(task => this.renderTaskItem(task, project)).join('');
            },

            renderDashboardTasks() {
                const container = document.getElementById('dashboardTasks');
                const projectIds = ['plexus', 'accelerator', 'forum', 'bridges', 'general'];
                const currentUserId = this.user?.id?.toString();

                // Get pinned task IDs
                const pinnedTaskIds = this.pinnedItems.filter(p => p.item_type === 'task').map(p => p.item_id);

                // Filter function: only show tasks assigned to current user or unassigned
                const isMyTask = (task) => {
                    if (!task.assigned_to) return true; // Unassigned tasks visible to all
                    return task.assigned_to?.toString() === currentUserId;
                };

                // Collect pinned tasks first (only my tasks)
                const pinnedTasks = [];
                const groupedTasks = {};

                projectIds.forEach(project => {
                    const tasks = (this.allTasks[project] || []).filter(isMyTask);
                    groupedTasks[project] = [];

                    tasks.forEach(task => {
                        if (pinnedTaskIds.includes(task.id)) {
                            pinnedTasks.push(task);
                        } else {
                            groupedTasks[project].push(task);
                        }
                    });
                });

                let html = '';

                // Pinned tasks section
                if (pinnedTasks.length > 0) {
                    html += `
                        <div class="pinned-tasks-section">
                            <div class="pinned-tasks-header">
                                <i class="fas fa-thumbtack"></i> Pinned
                            </div>
                            ${pinnedTasks.map(task => this.renderTaskItem(task, task.project)).join('')}
                        </div>
                    `;
                }

                // Grouped by project
                projectIds.forEach(project => {
                    const tasks = groupedTasks[project];
                    if (tasks.length === 0) return;

                    const proj = this.projects[project];
                    html += `
                        <div class="task-group">
                            <div class="task-group-header">
                                <div class="task-group-dot" style="background: ${proj.color}"></div>
                                <span class="task-group-name">${proj.name.split(' ')[0]}</span>
                                <span class="task-group-count">${tasks.length} task${tasks.length !== 1 ? 's' : ''}</span>
                            </div>
                            ${tasks.slice(0, 3).map(task => this.renderTaskItem(task, project)).join('')}
                            ${tasks.length > 3 ? `<div style="text-align: center; padding: 8px;"><a style="color: var(--text-muted); font-size: 12px; cursor: pointer;" onclick="App.showProject('${project}')">View all ${tasks.length} tasks</a></div>` : ''}
                        </div>
                    `;
                });

                if (!html) {
                    html = `
                        <div class="empty-state">
                            <i class="fas fa-check-circle"></i>
                            <p>No pending tasks</p>
                        </div>
                    `;
                }

                container.innerHTML = html;
            },

            renderTaskItem(task, project, isSubtask = false) {
                const isPinned = this.pinnedItems.some(p => p.item_type === 'task' && p.item_id === task.id);
                const dueText = task.due_date ? this.formatDueDate(task.due_date) : '';
                const badge = this.getDueBadge(task.due_date);
                const proj = this.projects[project];
                const assignee = task.assigned_to ? this.teamMembers.find(m => m.id == task.assigned_to) : null;
                const assigneeInitials = assignee ? (assignee.first_name?.[0] || '') + (assignee.last_name?.[0] || '') : '';
                const hasFiles = task.files && task.files.length > 0;
                const hasSubtasks = task.subtasks && task.subtasks.length > 0;
                const completedSubtasks = hasSubtasks ? task.subtasks.filter(st => st.status === 'done').length : 0;

                let subtasksHtml = '';
                if (hasSubtasks && !isSubtask) {
                    subtasksHtml = `
                        <div class="task-subtasks" style="margin-left: 32px; padding-left: 12px; border-left: 2px solid var(--border-color);">
                            ${task.subtasks.map(st => this.renderTaskItem(st, project, true)).join('')}
                        </div>
                    `;
                }

                return `
                    <div class="task-item ${isSubtask ? 'subtask' : ''}" style="${isSubtask ? 'padding: 8px 0;' : ''}">
                        <div class="task-check ${task.status === 'done' ? 'done' : ''}" onclick="App.toggleTask('${task.id}', '${project}')" style="${isSubtask ? 'width: 16px; height: 16px;' : ''}"></div>
                        <div class="task-content" onclick="App.openTaskModal('${project}', '${task.id}')" style="cursor: pointer;">
                            <div class="task-title" style="${isSubtask ? 'font-size: 13px;' : ''}">${this.escapeHtml(task.title)}</div>
                            <div class="task-meta">
                                ${assignee ? `<span title="${assignee.first_name} ${assignee.last_name}" style="display: inline-flex; align-items: center; justify-content: center; width: ${isSubtask ? '16' : '20'}px; height: ${isSubtask ? '16' : '20'}px; border-radius: 50%; background: var(--accent-gold); color: var(--bg-primary); font-size: ${isSubtask ? '8' : '9'}px; font-weight: 600;">${assigneeInitials}</span>` : ''}
                                ${hasFiles ? `<span title="${task.files.length} file(s)"><i class="fas fa-paperclip" style="color: var(--text-muted);"></i></span>` : ''}
                                ${hasSubtasks && !isSubtask ? `<span style="font-size: 11px; color: var(--text-muted);"><i class="fas fa-tasks"></i> ${completedSubtasks}/${task.subtasks.length}</span>` : ''}
                                ${dueText ? `<span>Due ${dueText}</span>` : ''}
                                ${badge}
                            </div>
                        </div>
                        ${!isSubtask ? `
                            <button class="task-pin ${isPinned ? 'pinned' : ''}" onclick="App.togglePinTask('${task.id}', '${this.escapeHtml(task.title)}', '${project}', ${isPinned})" title="${isPinned ? 'Unpin' : 'Pin to top'}">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                        ` : ''}
                    </div>
                    ${subtasksHtml}
                `;
            },

            formatDueDate(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            },

            getDueBadge(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const diffDays = Math.ceil((date - today) / (1000 * 60 * 60 * 24));

                if (diffDays < 0) return '<span class="task-badge urgent">Overdue</span>';
                if (diffDays === 0) return '<span class="task-badge urgent">Today</span>';
                if (diffDays === 1) return '<span class="task-badge urgent">Tomorrow</span>';
                if (diffDays <= 3) return `<span class="task-badge soon">${diffDays} days</span>`;
                return '';
            },

            async toggleTask(taskId, project) {
                try {
                    await this.api(`/api/tasks/${taskId}/toggle`, { method: 'POST' });
                    await this.loadAllTasks();
                    await this.loadDashboardSummary();
                } catch (err) {
                    console.error('Failed to toggle task:', err);
                }
            },

            async togglePinTask(taskId, title, project, isPinned) {
                if (isPinned) {
                    const pinned = this.pinnedItems.find(p => p.item_type === 'task' && p.item_id === taskId);
                    if (pinned) await this.unpinItem(pinned.id);
                } else {
                    await this.pinItem('task', taskId, title, this.projects[project]?.name || project, project);
                }
                await this.loadPinnedItems();
                this.renderDashboardTasks();
            },

            // ===== NAVIGATION =====
            showSection(sectionId, navItem, skipHistory = false) {
                const sectionNames = {
                    'dashboard': 'Dashboard',
                    'plexus': 'Plexus Conference',
                    'accelerator': 'Accelerator',
                    'forum': 'Biomedical Forum',
                    'bridges': 'Building Bridges',
                    'finances': 'Finances',
                    'pr-media': 'PR & Media',
                    'user-notifications': 'User Notifications',
                    'newsletter': 'Newsletter',
                    'portal-content': 'Portal Content',
                    'messages': 'Messages',
                    'gala': 'Gala Evening',
                    'settings': 'Settings'
                };
                document.title = `Med&X Admin — ${sectionNames[sectionId] || sectionId}`;

                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                const sectionEl = document.getElementById('section-' + sectionId);
                sectionEl.classList.add('active');

                // Fix: hide main-wrapper when showing a section that escaped <main>
                const mainWrapper = document.querySelector('.main-wrapper');
                const mainEl = document.querySelector('main.main');
                if (mainWrapper) {
                    if (sectionEl.parentElement !== mainEl) {
                        mainWrapper.classList.add('hidden-for-section');
                    } else {
                        mainWrapper.classList.remove('hidden-for-section');
                    }
                }

                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                if (navItem) navItem.classList.add('active');
                else document.querySelector('.nav-item').classList.add('active');

                // Only show chat panel for sections that use team chat
                const chatPanel = document.getElementById('chatPanel');
                const chatSections = ['dashboard', 'plexus', 'finances', 'pr-media'];
                if (chatSections.includes(sectionId)) {
                    chatPanel?.classList.remove('hidden');
                } else {
                    chatPanel?.classList.add('hidden');
                }

                if (sectionId === 'finances') {
                    // Switch to Finances team chat
                    this.currentView = 'finances';
                    this.switchChatPanel('section', 'finances');
                } else if (sectionId === 'pr-media') {
                    // Switch to PR & Media team chat
                    this.currentView = 'pr-media';
                    this.switchChatPanel('section', 'pr-media');
                    PRApp.init();
                } else if (sectionId === 'user-notifications') {
                    this.currentView = 'user-notifications';
                    this.switchChatPanel('team');
                    UserNotifApp.init();
                } else if (sectionId === 'newsletter') {
                    this.currentView = 'newsletter';
                    this.switchChatPanel('team');
                    NewsletterApp.init();
                } else if (sectionId === 'portal-content') {
                    this.currentView = 'portal-content';
                    this.switchChatPanel('team');
                    PortalContentApp.init();
                } else if (sectionId === 'messages') {
                    this.currentView = 'messages';
                    this.switchChatPanel('team');
                    this.loadAdminMessages();
                } else if (sectionId === 'gala') {
                    this.currentView = 'gala';
                    this.switchChatPanel('team');
                    GalaAdmin.init();
                } else {
                    // Switch chat panel to team chat mode
                    this.currentView = 'dashboard';
                    this.switchChatPanel('team');
                }

                // Update browser history
                if (!skipHistory) {
                    history.pushState({ section: sectionId }, '', `#${sectionId}`);
                }
            },

            showProject(projectId, navItem, skipHistory = false) {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                const sectionEl = document.getElementById('section-' + projectId);
                sectionEl.classList.add('active');

                // Fix: hide/show main-wrapper based on section DOM position
                const mainWrapper = document.querySelector('.main-wrapper');
                const mainEl = document.querySelector('main.main');
                if (mainWrapper) {
                    if (sectionEl.parentElement !== mainEl) {
                        mainWrapper.classList.add('hidden-for-section');
                    } else {
                        mainWrapper.classList.remove('hidden-for-section');
                    }
                }

                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                document.querySelectorAll('.sidebar-project').forEach(n => n.classList.remove('active'));

                // Mark the correct project as active in sidebar
                const projectEl = document.querySelector(`.sidebar-project[data-project="${projectId}"]`);
                if (projectEl) projectEl.classList.add('active');
                if (navItem && navItem.classList.contains('nav-item')) navItem.classList.add('active');

                // Switch chat panel to project mode
                this.currentView = projectId;
                this.switchChatPanel('project', projectId);

                // Load project-specific channels
                this.loadProjectChannels(projectId);

                // Load Plexus-specific data
                if (projectId === 'plexus') {
                    this.showPlexusTab('dashboard');
                }

                // Load Forum-specific data
                if (projectId === 'forum') {
                    this.showForumTab('dashboard');
                }

                // Load Accelerator-specific data
                if (projectId === 'accelerator') {
                    AcceleratorApp.showTab('overview');
                }

                // Load Building Bridges events
                if (projectId === 'bridges') {
                    BridgesApp.init();
                    this.loadDashboardPrefs('bridges').then(() => this.renderDynamicDashboard('bridges', 'bridgesDashboardCards'));
                }

                // Close mobile menu if open
                document.getElementById('sidebar')?.classList.remove('open');
                document.getElementById('sidebarOverlay')?.classList.remove('active');

                // Update browser history
                if (!skipHistory) {
                    history.pushState({ section: projectId }, '', `#${projectId}`);
                }
            },

            // Handle browser back/forward buttons
            handlePopState(event) {
                const section = event.state?.section || window.location.hash.slice(1) || 'dashboard';
                const projects = ['plexus', 'accelerator', 'forum', 'bridges'];

                if (projects.includes(section)) {
                    this.showProject(section, null, true);
                } else {
                    this.showSection(section, null, true);
                }
            },

            // ===== CUSTOMIZABLE DASHBOARD METHODS =====
            openModal(id) {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('active');
                    el.style.display = '';
                }
            },

            async loadDashboardPrefs(section) {
                try {
                    const prefs = await this.api(`/api/dashboard-preferences/${section}`);
                    if (prefs && prefs.length > 0) {
                        this.dashboardPrefs[section] = prefs;
                    } else {
                        this.dashboardPrefs[section] = (this.CARD_REGISTRY[section] || []).map((card, i) => ({
                            card_id: card.id,
                            is_visible: card.default ? 1 : 0,
                            sort_order: i
                        }));
                    }
                } catch (err) {
                    console.error('Failed to load dashboard prefs:', err);
                    this.dashboardPrefs[section] = (this.CARD_REGISTRY[section] || []).map((card, i) => ({
                        card_id: card.id,
                        is_visible: card.default ? 1 : 0,
                        sort_order: i
                    }));
                }
            },

            async saveDashboardPrefs(section) {
                try {
                    const prefs = this.dashboardPrefs[section] || [];
                    await this.api(`/api/dashboard-preferences/${section}`, {
                        method: 'PUT',
                        body: JSON.stringify({ cards: prefs })
                    });
                } catch (err) {
                    console.error('Failed to save dashboard prefs:', err);
                }
            },

            renderDynamicDashboard(section, containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const registry = this.CARD_REGISTRY[section] || [];
                const prefs = this.dashboardPrefs[section] || [];

                const sortedPrefs = [...prefs].sort((a, b) => a.sort_order - b.sort_order);
                const visibleCards = sortedPrefs.filter(p => p.is_visible);

                const hiddenCards = registry.filter(r => !visibleCards.find(v => v.card_id === r.id));

                let html = '<div style="display: flex; justify-content: flex-end; margin-bottom: 12px;">';
                if (hiddenCards.length > 0) {
                    html += `<button class="btn btn-secondary" onclick="App.openCardPicker('${section}', '${containerId}')"><i class="fas fa-plus"></i> Add Card</button>`;
                }
                html += '</div>';

                html += '<div class="dashboard-cards-grid">';

                visibleCards.forEach(pref => {
                    const cardDef = registry.find(r => r.id === pref.card_id);
                    if (!cardDef) return;

                    html += `<div class="card dashboard-dynamic-card" data-card-id="${cardDef.id}">
                        <div class="card-header">
                            <span class="card-title"><i class="fas ${cardDef.icon}" style="margin-right: 8px;"></i>${cardDef.title}</span>
                            <button class="btn-icon" onclick="App.removeDashboardCard('${section}', '${cardDef.id}', '${containerId}')" title="Remove card" style="opacity: 0.5; font-size: 12px;"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="card-body" id="dc-${cardDef.id}"></div>
                    </div>`;
                });

                html += '</div>';
                container.innerHTML = html;

                visibleCards.forEach(pref => {
                    const cardDef = registry.find(r => r.id === pref.card_id);
                    if (cardDef && typeof this[cardDef.renderer] === 'function') {
                        try { this[cardDef.renderer](`dc-${cardDef.id}`); } catch(e) { console.error(`Renderer error for ${cardDef.id}:`, e); }
                    }
                });
            },

            async removeDashboardCard(section, cardId, containerId) {
                const prefs = this.dashboardPrefs[section] || [];
                const pref = prefs.find(p => p.card_id === cardId);
                if (pref) {
                    pref.is_visible = 0;
                    await this.saveDashboardPrefs(section);
                    this.renderDynamicDashboard(section, containerId);
                }
            },

            openCardPicker(section, containerId) {
                const registry = this.CARD_REGISTRY[section] || [];
                const prefs = this.dashboardPrefs[section] || [];
                const visibleIds = prefs.filter(p => p.is_visible).map(p => p.card_id);
                const hiddenCards = registry.filter(r => !visibleIds.includes(r.id));

                if (hiddenCards.length === 0) { Toast.info('All cards are already visible'); return; }

                const pickerBody = document.getElementById('cardPickerBody');
                if (!pickerBody) return;

                pickerBody.innerHTML = hiddenCards.map(card => `
                    <div class="card-picker-item" onclick="App.addDashboardCard('${section}', '${card.id}', '${containerId}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <div style="width: 40px; height: 40px; border-radius: 8px; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center;">
                            <i class="fas ${card.icon}" style="color: var(--accent-gold);"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600; font-size: 14px;">${card.title}</div>
                        </div>
                    </div>
                `).join('');

                this._cardPickerSection = section;
                this._cardPickerContainer = containerId;
                this.openModal('cardPickerModal');
            },

            async addDashboardCard(section, cardId, containerId) {
                const prefs = this.dashboardPrefs[section] || [];
                const existing = prefs.find(p => p.card_id === cardId);
                if (existing) {
                    existing.is_visible = 1;
                    existing.sort_order = prefs.length;
                } else {
                    prefs.push({ card_id: cardId, is_visible: 1, sort_order: prefs.length });
                }
                this.dashboardPrefs[section] = prefs;
                await this.saveDashboardPrefs(section);
                this.closeModal('cardPickerModal');
                this.renderDynamicDashboard(section, containerId);
            },

            // ===== CARD RENDERERS: HOME =====
            renderPortalPulseCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary); font-size: 13px;"><i class="fas fa-heartbeat" style="margin-right: 6px; color: var(--accent-gold);"></i>Portal is running smoothly</div>';
            },

            renderHomeTimeline(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                const timelineEl = document.getElementById('globalTimeline');
                if (timelineEl) el.innerHTML = timelineEl.innerHTML;
                else el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Timeline loading...</div>';
            },

            renderHomeTasks(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                // Gather tasks from all projects
                const allProjects = Object.keys(this.allTasks || {});
                const pending = [];
                allProjects.forEach(proj => {
                    (this.allTasks[proj] || []).forEach(t => {
                        if (t.status !== 'done' && t.status !== 'completed') pending.push(t);
                    });
                });
                if (pending.length === 0) {
                    el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">No pending tasks</div>';
                    return;
                }
                el.innerHTML = pending.slice(0, 5).map(t => `<div style="padding: 6px 8px; border-bottom: 1px solid var(--border); font-size: 13px; display: flex; align-items: center; gap: 8px;"><i class="fas fa-circle" style="font-size: 6px; color: var(--accent-gold);"></i>${t.title || t.name || 'Untitled task'}</div>`).join('');
            },

            renderHomeSequences(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                const seqs = this.sequences || [];
                if (seqs.length === 0) {
                    el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">No active sequences</div>';
                    return;
                }
                el.innerHTML = seqs.slice(0, 5).map(s => `<div style="padding: 6px 8px; border-bottom: 1px solid var(--border); font-size: 13px;">${s.name} <span style="color: var(--text-muted); font-size: 11px;">${s.status || 'active'}</span></div>`).join('');
            },

            renderProjectActivity(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);"><i class="fas fa-chart-line" style="font-size: 24px; margin-bottom: 8px; display: block; color: var(--accent-gold);"></i>Activity chart available after data loads</div>';
            },

            renderRegistrationTrends(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);"><i class="fas fa-chart-area" style="font-size: 24px; margin-bottom: 8px; display: block; color: var(--plexus);"></i>Registration trends</div>';
            },

            async renderFinanceOverview(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);">Loading finance data...</div>';
                try {
                    const data = await this.api(`/api/finance/dashboard?year=${new Date().getFullYear()}`);
                    const fmt = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'EUR' }).format(amount || 0);
                    el.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Balance</div>
                                <div style="font-size: 16px; font-weight: 600;">${fmt(data.currentBalance)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Net</div>
                                <div style="font-size: 16px; font-weight: 600; color: ${data.netBalance >= 0 ? 'var(--success)' : 'var(--danger)'};">${fmt(data.netBalance)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Income</div>
                                <div style="font-size: 14px; font-weight: 600; color: var(--success);">${fmt(data.totalIncome)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">Expenses</div>
                                <div style="font-size: 14px; font-weight: 600; color: var(--danger);">${fmt(data.totalExpenses)}</div>
                            </div>
                        </div>
                        ${data.pendingInvoices > 0 || data.pendingTravelOrders > 0 ? `
                        <div style="display: flex; gap: 8px; padding: 0 12px 12px; justify-content: center;">
                            ${data.pendingInvoices > 0 ? `<span style="background: rgba(245,158,11,0.2); color: var(--warning); padding: 2px 8px; border-radius: 4px; font-size: 11px;">${data.pendingInvoices} pending invoice${data.pendingInvoices > 1 ? 's' : ''}</span>` : ''}
                            ${data.pendingTravelOrders > 0 ? `<span style="background: rgba(245,158,11,0.2); color: var(--warning); padding: 2px 8px; border-radius: 4px; font-size: 11px;">${data.pendingTravelOrders} pending travel</span>` : ''}
                        </div>` : ''}
                    `;
                } catch (err) {
                    el.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);"><i class="fas fa-euro-sign" style="font-size: 24px; margin-bottom: 8px; display: block; color: var(--success);"></i>Finance data unavailable</div>';
                }
            },

            renderRecentRegistrations(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Recent registrations will appear here</div>';
            },

            renderUpcomingEvents(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Upcoming events will appear here</div>';
            },

            renderTeamActivity(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Team activity feed</div>';
            },

            renderQuickNotes(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px;"><textarea class="search-input" placeholder="Quick notes..." style="width: 100%; height: 80px; resize: vertical;"></textarea></div>';
            },

            // ===== CARD RENDERERS: PLEXUS =====
            renderPlexusStatsCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                const statsEl = document.getElementById('plexusStatsGrid');
                if (statsEl) el.innerHTML = statsEl.innerHTML;
                else el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Loading stats...</div>';
            },

            renderPlexusChartsCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);"><i class="fas fa-chart-pie" style="font-size: 24px; color: var(--plexus);"></i><p style="margin-top: 8px;">Charts load with dashboard data</p></div>';
            },

            renderPlexusPendingCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                const pendingEl = document.getElementById('pxPendingQuick');
                if (pendingEl) el.innerHTML = pendingEl.innerHTML;
                else el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">No pending actions</div>';
            },

            renderPlexusTasksCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Plexus tasks</div>';
            },

            renderPlexusFilesCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Plexus shared files</div>';
            },

            renderPlexusTimelineCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                const timelineEl = document.getElementById('plexusTimeline');
                if (timelineEl) el.innerHTML = timelineEl.innerHTML;
                else el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Timeline loading...</div>';
            },

            renderPlexusRecentRegCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Recent Plexus registrations</div>';
            },

            renderPlexusSpeakerSummaryCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Speaker summary</div>';
            },

            // ===== CARD RENDERERS: FORUM =====
            renderForumStatsCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Forum stats</div>';
            },

            renderForumActivityCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);"><i class="fas fa-chart-line" style="font-size: 24px; color: var(--forum);"></i><p style="margin-top: 8px;">Activity charts</p></div>';
            },

            renderForumTasksCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Forum tasks</div>';
            },

            renderForumFilesCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Forum shared files</div>';
            },

            renderForumTimelineCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                const timelineEl = document.getElementById('forumTimeline');
                if (timelineEl) el.innerHTML = timelineEl.innerHTML;
                else el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Timeline loading...</div>';
            },

            renderForumRecentPostsCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Recent forum posts</div>';
            },

            // ===== CARD RENDERERS: BRIDGES =====
            renderBridgesStatsCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Bridges stats</div>';
            },

            renderBridgesUpcomingCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Upcoming Building Bridges events</div>';
            },

            renderBridgesTasksCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Bridges tasks</div>';
            },

            renderBridgesFilesCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Bridges shared files</div>';
            },

            renderBridgesTimelineCard(containerId) {
                const el = document.getElementById(containerId);
                if (!el) return;
                const timelineEl = document.getElementById('bridgesTimeline');
                if (timelineEl) el.innerHTML = timelineEl.innerHTML;
                else el.innerHTML = '<div style="padding: 8px; color: var(--text-secondary);">Timeline loading...</div>';
            },

            // ===== MODALS =====
            taskPendingFiles: [],
            editingTask: null,

            openTaskModal(project, taskId = null) {
                // Populate assignee dropdown
                this.populateAssigneeDropdown();

                // Reset form
                document.getElementById('taskEditId').value = '';
                document.getElementById('taskTitle').value = '';
                document.getElementById('taskDesc').value = '';
                document.getElementById('taskDue').value = '';
                document.getElementById('taskPriority').value = 'medium';
                document.getElementById('taskProject').value = project || '';
                document.getElementById('taskAssignee').value = '';
                document.getElementById('taskFiles').innerHTML = '';
                this.taskPendingFiles = [];
                this.editingTask = null;

                if (taskId) {
                    // Edit mode - find the task
                    let task = null;
                    for (const proj of ['plexus', 'accelerator', 'forum', 'bridges', 'general']) {
                        const found = (this.allTasks[proj] || []).find(t => t.id === taskId);
                        if (found) { task = found; break; }
                    }
                    if (task) {
                        this.editingTask = task;
                        document.getElementById('taskEditId').value = task.id;
                        document.getElementById('taskTitle').value = task.title || '';
                        document.getElementById('taskDesc').value = task.description || '';
                        document.getElementById('taskDue').value = task.due_date || '';
                        document.getElementById('taskPriority').value = task.priority || 'medium';
                        document.getElementById('taskProject').value = task.project || '';
                        document.getElementById('taskAssignee').value = task.assigned_to || '';
                        document.getElementById('taskModalTitle').textContent = 'Edit Task';
                        document.getElementById('taskSaveBtn').textContent = 'Save Changes';
                        document.getElementById('taskDeleteBtn').style.display = 'inline-flex';

                        // Show existing files
                        if (task.files && task.files.length > 0) {
                            document.getElementById('taskFiles').innerHTML = task.files.map(f => `
                                <div style="display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: var(--bg-secondary); border-radius: 4px; margin-bottom: 4px;">
                                    <i class="fas fa-file" style="color: var(--text-muted);"></i>
                                    <span style="flex: 1; font-size: 13px;">${f.filename}</span>
                                    <button class="btn btn-secondary" style="padding: 2px 6px;" onclick="App.removeTaskFile('${f.id}')"><i class="fas fa-times"></i></button>
                                </div>
                            `).join('');
                        }

                        // Show subtasks section (only for parent tasks, not subtasks)
                        if (!task.parent_id) {
                            document.getElementById('subtasksSection').style.display = 'block';
                            this.renderSubtasksInModal(task.subtasks || []);
                        } else {
                            document.getElementById('subtasksSection').style.display = 'none';
                        }
                    }
                } else {
                    document.getElementById('taskModalTitle').textContent = 'Add Task';
                    document.getElementById('taskSaveBtn').textContent = 'Add Task';
                    document.getElementById('taskDeleteBtn').style.display = 'none';
                    document.getElementById('subtasksSection').style.display = 'none';
                    if (project) document.getElementById('taskProject').value = project;
                }

                document.getElementById('taskModal').classList.add('active');
                document.getElementById('taskTitle').focus();
            },

            populateAssigneeDropdown() {
                const select = document.getElementById('taskAssignee');
                select.innerHTML = '<option value="">Unassigned</option>';
                this.teamMembers.forEach(m => {
                    select.innerHTML += `<option value="${m.id}">${m.first_name} ${m.last_name}</option>`;
                });
            },

            renderSubtasksInModal(subtasks) {
                const container = document.getElementById('taskSubtasks');
                if (subtasks.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px; padding: 8px 0;">No subtasks yet</div>';
                    return;
                }
                container.innerHTML = subtasks.map(st => `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 10px; background: var(--bg-secondary); border-radius: 4px; margin-bottom: 4px;">
                        <div class="task-check ${st.status === 'done' ? 'done' : ''}" onclick="App.toggleSubtask('${st.id}')" style="width: 16px; height: 16px; cursor: pointer;"></div>
                        <span style="flex: 1; font-size: 13px; ${st.status === 'done' ? 'text-decoration: line-through; color: var(--text-muted);' : ''}">${this.escapeHtml(st.title)}</span>
                        <button class="btn btn-secondary" style="padding: 2px 6px;" onclick="App.deleteSubtask('${st.id}')"><i class="fas fa-times"></i></button>
                    </div>
                `).join('');
            },

            async addSubtask() {
                if (!this.editingTask) return;
                const title = document.getElementById('newSubtaskTitle').value.trim();
                if (!title) return;

                try {
                    await this.api('/api/tasks', {
                        method: 'POST',
                        body: JSON.stringify({
                            project: this.editingTask.project,
                            title,
                            parent_id: this.editingTask.id
                        })
                    });
                    document.getElementById('newSubtaskTitle').value = '';
                    await this.loadAllTasks();

                    // Refresh the task in the modal
                    let updatedTask = null;
                    for (const proj of ['plexus', 'accelerator', 'forum', 'bridges', 'general']) {
                        const found = (this.allTasks[proj] || []).find(t => t.id === this.editingTask.id);
                        if (found) { updatedTask = found; break; }
                    }
                    if (updatedTask) {
                        this.editingTask = updatedTask;
                        this.renderSubtasksInModal(updatedTask.subtasks || []);
                    }
                } catch (err) {
                    console.error('Failed to add subtask:', err);
                }
            },

            async toggleSubtask(subtaskId) {
                try {
                    await this.api(`/api/tasks/${subtaskId}/toggle`, { method: 'POST' });
                    await this.loadAllTasks();

                    // Refresh the task in the modal
                    if (this.editingTask) {
                        let updatedTask = null;
                        for (const proj of ['plexus', 'accelerator', 'forum', 'bridges', 'general']) {
                            const found = (this.allTasks[proj] || []).find(t => t.id === this.editingTask.id);
                            if (found) { updatedTask = found; break; }
                        }
                        if (updatedTask) {
                            this.editingTask = updatedTask;
                            this.renderSubtasksInModal(updatedTask.subtasks || []);
                        }
                    }
                } catch (err) {
                    console.error('Failed to toggle subtask:', err);
                }
            },

            async deleteSubtask(subtaskId) {
                if (!confirm('Delete this subtask?')) return;
                try {
                    await this.api(`/api/tasks/${subtaskId}`, { method: 'DELETE' });
                    await this.loadAllTasks();

                    // Refresh the task in the modal
                    if (this.editingTask) {
                        let updatedTask = null;
                        for (const proj of ['plexus', 'accelerator', 'forum', 'bridges', 'general']) {
                            const found = (this.allTasks[proj] || []).find(t => t.id === this.editingTask.id);
                            if (found) { updatedTask = found; break; }
                        }
                        if (updatedTask) {
                            this.editingTask = updatedTask;
                            this.renderSubtasksInModal(updatedTask.subtasks || []);
                        }
                    }
                } catch (err) {
                    console.error('Failed to delete subtask:', err);
                }
            },

            handleTaskFiles(event) {
                const files = Array.from(event.target.files);
                const container = document.getElementById('taskFiles');

                files.forEach(file => {
                    this.taskPendingFiles.push(file);
                    container.innerHTML += `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 6px 10px; background: var(--bg-secondary); border-radius: 4px; margin-bottom: 4px;" data-pending="${file.name}">
                            <i class="fas fa-file" style="color: var(--accent-gold);"></i>
                            <span style="flex: 1; font-size: 13px;">${file.name}</span>
                            <span style="font-size: 11px; color: var(--text-muted);">(pending)</span>
                        </div>
                    `;
                });
                event.target.value = '';
            },

            async removeTaskFile(fileId) {
                if (!confirm('Remove this file?')) return;
                try {
                    await this.api(`/api/tasks/files/${fileId}`, { method: 'DELETE' });
                    await this.loadAllTasks();
                    if (this.editingTask) {
                        this.openTaskModal(this.editingTask.project, this.editingTask.id);
                    }
                } catch (err) {
                    console.error('Failed to remove file:', err);
                }
            },

            // ===== ADMIN MESSAGING =====
            adminMessages: [],

            async loadAdminMessages() {
                try {
                    const messages = await this.api('/api/admin/messages');
                    this.adminMessages = messages || [];
                    this.renderAdminMessages();
                } catch (err) {
                    console.error('Failed to load messages:', err);
                }
            },

            renderAdminMessages() {
                const container = document.getElementById('adminMessagesList');
                if (!container) return;

                const messages = this.adminMessages || [];
                if (messages.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: var(--text-muted);"><i class="fas fa-envelope" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i><p>No messages sent yet</p></div>';
                    return;
                }

                // Group by receiver
                const grouped = {};
                messages.forEach(m => {
                    if (!grouped[m.receiver_id]) grouped[m.receiver_id] = [];
                    grouped[m.receiver_id].push(m);
                });

                container.innerHTML = Object.entries(grouped).map(([userId, msgs]) => {
                    const latest = msgs[0];
                    const unread = msgs.filter(m => !m.is_read && m.sender_type !== 'admin').length;
                    const escapedUserId = userId.replace(/'/g, "\\'");
                    return `<div style="display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background=''" onclick="App.openConversation('${escapedUserId}')">
                        <div style="min-width: 0;">
                            <div style="font-weight: 600; font-size: 14px; color: var(--text-primary);">${userId}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 400px;">${latest.title || (latest.content ? latest.content.substring(0, 60) : 'No content')}${latest.content && latest.content.length > 60 ? '...' : ''}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                            ${unread > 0 ? `<span style="background: var(--danger, #ef4444); color: white; font-size: 11px; padding: 2px 6px; border-radius: 10px; font-weight: 600;">${unread}</span>` : ''}
                            <span style="font-size: 11px; color: var(--text-muted);">${new Date(latest.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>`;
                }).join('');
            },

            openComposeModal(recipient) {
                document.getElementById('msgRecipient').value = recipient || '';
                document.getElementById('msgTitle').value = '';
                document.getElementById('msgContent').value = '';
                this.openModal('composeMessageModal');
            },

            async sendAdminMessage() {
                const receiver_id = document.getElementById('msgRecipient').value.trim();
                const title = document.getElementById('msgTitle').value.trim();
                const content = document.getElementById('msgContent').value.trim();

                if (!receiver_id) { Toast.warning('Recipient email is required'); return; }
                if (!content) { Toast.warning('Message content is required'); return; }

                try {
                    await this.api('/api/admin/messages', {
                        method: 'POST',
                        body: JSON.stringify({ receiver_id, title, content })
                    });
                    this.closeModal('composeMessageModal');
                    Toast.success('Message sent');
                    await this.loadAdminMessages();
                } catch (err) {
                    console.error('Failed to send message:', err);
                    Toast.error('Failed to send message');
                }
            },

            openBulkMessageModal() {
                document.getElementById('bulkMsgGroup').value = '';
                document.getElementById('bulkMsgTitle').value = '';
                document.getElementById('bulkMsgContent').value = '';
                this.openModal('bulkMessageModal');
            },

            async sendBulkMessage() {
                const group = document.getElementById('bulkMsgGroup').value;
                const title = document.getElementById('bulkMsgTitle').value.trim();
                const content = document.getElementById('bulkMsgContent').value.trim();

                if (!group) { Toast.warning('Please select a target group'); return; }
                if (!content) { Toast.warning('Message content is required'); return; }

                if (!confirm(`Send this message to all ${group} users? This cannot be undone.`)) return;

                try {
                    const result = await this.api('/api/admin/messages/bulk', {
                        method: 'POST',
                        body: JSON.stringify({ group, title, content })
                    });
                    this.closeModal('bulkMessageModal');
                    Toast.success(`Message sent to ${result.sent} user(s)`);
                    await this.loadAdminMessages();
                } catch (err) {
                    console.error('Failed to send bulk message:', err);
                    Toast.error('Failed to send bulk message');
                }
            },

            async openConversation(userId) {
                try {
                    const messages = await this.api(`/api/admin/messages/${encodeURIComponent(userId)}`);

                    const container = document.getElementById('adminMessagesList');
                    if (!container) return;

                    const escapedUserId = userId.replace(/'/g, "\\'");

                    let html = `<div style="padding: 14px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px;">
                        <button class="btn btn-secondary" onclick="App.loadAdminMessages()" style="padding: 6px 12px;"><i class="fas fa-arrow-left"></i></button>
                        <h3 style="font-size: 16px; font-weight: 600; color: var(--text-primary);">Conversation with ${userId}</h3>
                    </div>`;

                    html += '<div style="max-height: 400px; overflow-y: auto; padding: 16px 20px;">';
                    (messages || []).forEach(m => {
                        const isAdmin = m.sender_type === 'admin';
                        html += `<div style="margin-bottom: 12px; display: flex; justify-content: ${isAdmin ? 'flex-end' : 'flex-start'};">
                            <div style="max-width: 70%; padding: 10px 14px; border-radius: 12px; background: ${isAdmin ? 'rgba(167,139,250,0.15)' : 'var(--bg-tertiary)'}; font-size: 13px; color: var(--text-primary);">
                                ${m.title ? `<div style="font-weight: 600; margin-bottom: 4px;">${m.title}</div>` : ''}
                                <div>${m.content}</div>
                                <div style="font-size: 10px; color: var(--text-muted); margin-top: 6px;">${new Date(m.created_at).toLocaleString()}</div>
                            </div>
                        </div>`;
                    });
                    html += '</div>';

                    html += `<div style="padding: 12px 20px; border-top: 1px solid var(--border); display: flex; gap: 8px;">
                        <input type="text" class="search-input" id="replyInput" placeholder="Type a reply..." style="flex: 1; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary);" onkeypress="if(event.key==='Enter') App.sendReply('${escapedUserId}')">
                        <button class="btn btn-primary" onclick="App.sendReply('${escapedUserId}')"><i class="fas fa-paper-plane"></i></button>
                    </div>`;

                    container.innerHTML = html;
                } catch (err) {
                    console.error('Failed to load conversation:', err);
                    Toast.error('Failed to load conversation');
                }
            },

            async sendReply(userId) {
                const input = document.getElementById('replyInput');
                if (!input) return;
                const content = input.value.trim();
                if (!content) return;

                try {
                    await this.api('/api/admin/messages', {
                        method: 'POST',
                        body: JSON.stringify({ receiver_id: userId, content })
                    });
                    await this.openConversation(userId);
                } catch (err) {
                    Toast.error('Failed to send reply');
                }
            },

            closeModal(id) {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.remove('active');
                    el.style.display = 'none';
                }
                this.editingTask = null;
                this.taskPendingFiles = [];
            },

            async saveTask() {
                const taskId = document.getElementById('taskEditId').value;
                const title = document.getElementById('taskTitle').value.trim();
                const description = document.getElementById('taskDesc').value.trim();
                const due_date = document.getElementById('taskDue').value;
                const priority = document.getElementById('taskPriority').value;
                const project = document.getElementById('taskProject').value || 'general';
                const assigned_to = document.getElementById('taskAssignee').value || null;

                if (!title) return;

                try {
                    let savedTask;
                    if (taskId) {
                        // Update existing task
                        savedTask = await this.api(`/api/tasks/${taskId}`, {
                            method: 'PUT',
                            body: JSON.stringify({ title, description, priority, due_date, project, assigned_to })
                        });
                    } else {
                        // Create new task
                        savedTask = await this.api('/api/tasks', {
                            method: 'POST',
                            body: JSON.stringify({ project, title, description, priority, due_date, assigned_to })
                        });
                    }

                    // Upload pending files
                    const taskIdForFiles = taskId || savedTask.id;
                    for (const file of this.taskPendingFiles) {
                        const formData = new FormData();
                        formData.append('file', file);
                        await fetch(`/api/tasks/${taskIdForFiles}/files`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${this.token}` },
                            body: formData
                        });
                    }

                    this.closeModal('taskModal');
                    await this.loadAllTasks();
                    await this.loadDashboardSummary();
                } catch (err) {
                    console.error('Failed to save task:', err);
                }
            },

            async deleteTask() {
                const taskId = document.getElementById('taskEditId').value;
                if (!taskId) return;
                if (!confirm('Delete this task?')) return;

                try {
                    await this.api(`/api/tasks/${taskId}`, { method: 'DELETE' });
                    this.closeModal('taskModal');
                    await this.loadAllTasks();
                    await this.loadDashboardSummary();
                } catch (err) {
                    console.error('Failed to delete task:', err);
                }
            },

            // Keep createTask for backward compatibility
            async createTask() {
                await this.saveTask();
            },

            // ===== SEARCH =====
            searchTimeout: null,
            async handleSearch(query) {
                clearTimeout(this.searchTimeout);
                const results = document.getElementById('searchResults');

                if (!query || query.length < 2) {
                    results.classList.remove('active');
                    return;
                }

                this.searchTimeout = setTimeout(async () => {
                    try {
                        const data = await this.api(`/api/search?q=${encodeURIComponent(query)}`);

                        if (data.tasks.length === 0 && data.files.length === 0) {
                            results.innerHTML = '<div class="search-result-item"><div class="search-result-title" style="color: var(--text-muted)">No results found</div></div>';
                        } else {
                            results.innerHTML = [
                                ...data.tasks.map(t => `
                                    <div class="search-result-item" onclick="App.showProject('${t.project}'); App.closeSearchResults();">
                                        <div class="search-result-type">Task</div>
                                        <div class="search-result-title">${this.escapeHtml(t.title)}</div>
                                    </div>
                                `),
                                ...data.files.map(f => `
                                    <div class="search-result-item" onclick="App.showProject('${f.project}'); App.closeSearchResults();">
                                        <div class="search-result-type">File</div>
                                        <div class="search-result-title">${this.escapeHtml(f.original_name)}</div>
                                    </div>
                                `)
                            ].join('');
                        }
                        results.classList.add('active');
                    } catch (err) {
                        console.error('Search failed:', err);
                    }
                }, 300);
            },

            closeSearchResults() {
                document.getElementById('searchResults').classList.remove('active');
                document.getElementById('globalSearch').value = '';
            },

            // ===== QUICK ACTIONS =====
            toggleQuickAction(e) {
                e.stopPropagation();
                const dropdown = document.getElementById('quickActionDropdown');
                dropdown.classList.toggle('active');
            },

            getCurrentProject() {
                const sections = ['plexus', 'accelerator', 'forum', 'bridges'];
                for (const p of sections) {
                    const section = document.getElementById(`section-${p}`);
                    if (section && section.classList.contains('active')) {
                        return p;
                    }
                }
                return null;
            },

            quickAddTask() {
                document.getElementById('quickActionDropdown').classList.remove('active');
                const project = this.getCurrentProject();
                this.openTaskModal(project);
            },

            quickAddFolder() {
                document.getElementById('quickActionDropdown').classList.remove('active');
                const project = this.getCurrentProject();
                if (project) {
                    this.createFolder(project);
                } else {
                    Toast.warning('Please select a project first to create a folder.');
                }
            },

            openFileUpload() {
                document.getElementById('quickActionDropdown').classList.remove('active');
                const project = this.getCurrentProject();
                if (project) {
                    this.triggerFileUpload(project);
                } else {
                    // Default to showing plexus
                    this.showProject('plexus');
                    setTimeout(() => this.triggerFileUpload('plexus'), 100);
                }
            },

            // ===== CUSTOM SHORTCUT =====
            defaultShortcut: {
                label: 'Start Zoom Call',
                url: 'https://harvard.zoom.us/my/alen1',
                icon: 'fa-video'
            },

            // ===== NOTES CANVAS =====
            notesTimeout: null,

            loadNotes() {
                const notes = localStorage.getItem('medxHomeNotes') || '';
                const textarea = document.getElementById('notesCanvas');
                if (textarea) textarea.value = notes;
            },

            saveNotes() {
                // Debounce saves
                clearTimeout(this.notesTimeout);
                this.notesTimeout = setTimeout(() => {
                    const notes = document.getElementById('notesCanvas')?.value || '';
                    localStorage.setItem('medxHomeNotes', notes);

                    // Show saved indicator
                    const status = document.getElementById('notesSaveStatus');
                    if (status) {
                        status.style.opacity = '1';
                        setTimeout(() => { status.style.opacity = '0'; }, 1500);
                    }
                }, 500);
            },

            // ===== WIDGET MANAGEMENT =====
            toggleWidgetMenu() {
                const menu = document.getElementById('widgetMenu');
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
                // Close on outside click
                if (menu.style.display === 'block') {
                    setTimeout(() => {
                        const close = (e) => { if (!menu.contains(e.target) && e.target.id !== 'widgetMenuBtn') { menu.style.display = 'none'; document.removeEventListener('click', close); } };
                        document.addEventListener('click', close);
                    }, 10);
                }
                // Restore saved states
                ['dashTimeline','dashTodo','dashSequences','dashNotes'].forEach(id => {
                    const hidden = localStorage.getItem('widget_' + id) === 'hidden';
                    const cb = menu.querySelector(`input[onchange*="${id}"]`);
                    if (cb) cb.checked = !hidden;
                });
            },

            toggleWidget(widgetId, show) {
                const el = document.getElementById(widgetId);
                if (!el) return;
                el.style.display = show ? '' : 'none';
                localStorage.setItem('widget_' + widgetId, show ? 'visible' : 'hidden');
            },

            restoreWidgetStates() {
                ['dashTimeline','dashTodo','dashSequences','dashNotes'].forEach(id => {
                    const hidden = localStorage.getItem('widget_' + id) === 'hidden';
                    if (hidden) { const el = document.getElementById(id); if (el) el.style.display = 'none'; }
                });
            },

            // ===== SEQUENCE TASKS =====
            sequences: [],
            sequenceSteps: [],

            async loadSequences() {
                try {
                    const data = await this.api('/api/sequences');
                    this.sequences = data || [];
                    this.renderSequences();
                } catch (err) {
                    console.error('Failed to load sequences:', err);
                }
            },

            renderSequences() {
                const container = document.getElementById('dashboardSequences');
                if (!container) return;

                if (!this.sequences.length) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <i class="fas fa-stream" style="font-size: 24px; color: var(--text-muted); margin-bottom: 8px;"></i>
                            <p>No active sequences</p>
                        </div>
                    `;
                    return;
                }

                const currentUserId = this.user?.id?.toString();

                container.innerHTML = this.sequences.map(seq => {
                    const steps = seq.steps || [];
                    const currentStep = steps.find(s => s.status === 'pending') || steps[steps.length - 1];
                    const completedSteps = steps.filter(s => s.status === 'completed').length;
                    const progress = steps.length ? Math.round((completedSteps / steps.length) * 100) : 0;

                    // Find user's position in the sequence
                    const userStepIndex = steps.findIndex(s => s.assigned_to?.toString() === currentUserId);
                    let userPosition = '';
                    if (userStepIndex >= 0) {
                        const userStep = steps[userStepIndex];
                        if (userStep.status === 'completed') {
                            userPosition = '<span style="color: var(--success); font-size: 11px;"><i class="fas fa-check"></i> Done</span>';
                        } else if (userStep === currentStep) {
                            userPosition = '<span style="color: var(--warning); font-size: 11px;"><i class="fas fa-bell"></i> Your turn!</span>';
                        } else {
                            const stepsUntilMe = userStepIndex - steps.findIndex(s => s === currentStep);
                            userPosition = `<span style="color: var(--text-muted); font-size: 11px;">${stepsUntilMe} step${stepsUntilMe !== 1 ? 's' : ''} away</span>`;
                        }
                    }

                    return `
                        <div class="sequence-card" style="background: var(--bg-tertiary); border-radius: 8px; padding: 12px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div>
                                    <strong style="color: var(--text-primary);">${seq.name}</strong>
                                    ${userPosition ? `<div>${userPosition}</div>` : ''}
                                </div>
                                <div style="display: flex; gap: 4px;">
                                    <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="App.viewSequence('${seq.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn" style="padding: 4px 8px; font-size: 11px; color: var(--danger);" onclick="App.deleteSequence('${seq.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">
                                    <span>Step ${completedSteps + 1} of ${steps.length}</span>
                                    <span>${progress}%</span>
                                </div>
                                <div style="background: var(--bg-primary); border-radius: 4px; height: 6px; overflow: hidden;">
                                    <div style="background: var(--accent-gold); height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div style="font-size: 12px;">
                                ${steps.map((step, idx) => {
                                    const isActive = step === currentStep;
                                    const isDone = step.status === 'completed';
                                    const assigneeName = this.teamMembers?.find(u => u.id?.toString() === step.assigned_to?.toString())?.name || 'Unassigned';
                                    return `
                                        <div style="display: flex; align-items: center; gap: 8px; padding: 4px 0; ${isActive ? 'background: var(--bg-hover); margin: 0 -8px; padding: 4px 8px; border-radius: 4px;' : ''}">
                                            <span style="color: ${isDone ? 'var(--success)' : isActive ? 'var(--warning)' : 'var(--text-muted)'};">
                                                <i class="fas ${isDone ? 'fa-check-circle' : isActive ? 'fa-circle-dot' : 'fa-circle'}"></i>
                                            </span>
                                            <span style="flex: 1; color: ${isDone ? 'var(--text-muted)' : 'var(--text-primary)'}; ${isDone ? 'text-decoration: line-through;' : ''}">${step.title}</span>
                                            <span style="color: var(--text-muted); font-size: 11px;">${assigneeName}</span>
                                            ${step.notification_sent && isActive ? '<span title="Notification sent" style="color: var(--accent-gold); font-size: 10px; margin-left: 2px;"><i class="fas fa-bell"></i></span>' : ''}
                                            ${isActive && step.assigned_to?.toString() === currentUserId ? `
                                                <button class="btn btn-primary" style="padding: 2px 8px; font-size: 10px;" onclick="App.completeSequenceStep('${seq.id}', '${step.id}')">
                                                    Complete
                                                </button>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            openSequenceModal() {
                this.sequenceSteps = [];
                document.getElementById('seqName').value = '';
                document.getElementById('seqDesc').value = '';
                document.getElementById('seqProject').value = '';

                // Populate assignee dropdown with users
                const assigneeSelect = document.getElementById('seqStepAssignee');
                if (assigneeSelect && this.teamMembers) {
                    assigneeSelect.innerHTML = '<option value="">Unassigned</option>' +
                        this.teamMembers.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
                }

                this.renderSequenceSteps();
                document.getElementById('sequenceModal').classList.add('active');
            },

            renderSequenceSteps() {
                const container = document.getElementById('seqSteps');
                if (!container) return;

                if (!this.sequenceSteps.length) {
                    container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px; padding: 8px 0;">No steps added yet. Add steps below.</p>';
                    return;
                }

                container.innerHTML = this.sequenceSteps.map((step, idx) => {
                    const assigneeName = this.teamMembers?.find(u => u.id?.toString() === step.assigned_to?.toString())?.name || 'Unassigned';
                    return `
                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-tertiary); border-radius: 6px; margin-bottom: 6px;">
                            <span style="background: var(--accent-gold); color: var(--bg-primary); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${idx + 1}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${step.title}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${assigneeName}</div>
                            </div>
                            <button class="btn" style="padding: 4px 8px; color: var(--danger);" onclick="App.removeSequenceStep(${idx})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }).join('');
            },

            addSequenceStep() {
                const titleInput = document.getElementById('seqStepTitle');
                const assigneeSelect = document.getElementById('seqStepAssignee');
                const title = titleInput?.value?.trim();
                const assigned_to = assigneeSelect?.value || '';

                if (!title) {
                    Toast.warning('Please enter a step title');
                    return;
                }

                this.sequenceSteps.push({ title, assigned_to });
                titleInput.value = '';
                assigneeSelect.value = '';
                this.renderSequenceSteps();
            },

            removeSequenceStep(idx) {
                this.sequenceSteps.splice(idx, 1);
                this.renderSequenceSteps();
            },

            async createSequence() {
                const name = document.getElementById('seqName').value.trim();
                const description = document.getElementById('seqDesc').value.trim();
                const project = document.getElementById('seqProject').value;

                if (!name) {
                    Toast.warning('Please enter a sequence name');
                    return;
                }

                if (this.sequenceSteps.length < 2) {
                    Toast.warning('Please add at least 2 steps to the sequence');
                    return;
                }

                try {
                    await this.api('/api/sequences', {
                        method: 'POST',
                        body: JSON.stringify({
                            name,
                            description,
                            project: project || null,
                            steps: this.sequenceSteps
                        })
                    });

                    this.closeModal('sequenceModal');
                    await this.loadSequences();
                    Toast.success('Sequence created successfully');
                } catch (err) {
                    Toast.error('Failed to create sequence: ' + err.message);
                }
            },

            async viewSequence(seqId) {
                const seq = this.sequences.find(s => s.id === seqId);
                if (!seq) return;

                const steps = seq.steps || [];
                const stepsHtml = steps.map((step, idx) => {
                    const isDone = step.status === 'completed';
                    const isActive = step.status === 'active';
                    const assigneeName = this.teamMembers?.find(u => u.id?.toString() === step.assigned_to?.toString())?.name || 'Unassigned';
                    return `
                        <div style="display: flex; align-items: start; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px; ${isActive ? 'border-left: 3px solid var(--accent-gold);' : ''}">
                            <span style="background: ${isDone ? 'var(--success)' : isActive ? 'var(--accent-gold)' : 'var(--bg-hover)'}; color: ${isDone || isActive ? 'white' : 'var(--text-secondary)'}; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600;">${idx + 1}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 500; ${isDone ? 'text-decoration: line-through; color: var(--text-muted);' : ''}">${step.title}</div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">
                                    <i class="fas fa-user"></i> ${assigneeName}
                                    ${step.notification_sent && isActive ? ' <span style="color: var(--accent-gold);" title="Notification sent"><i class="fas fa-bell"></i> Notified</span>' : ''}
                                    ${step.completed_at ? ` • Completed ${new Date(step.completed_at).toLocaleDateString()}` : ''}
                                </div>
                            </div>
                            <span style="color: ${isDone ? 'var(--success)' : isActive ? 'var(--accent-gold)' : 'var(--text-muted)'};">
                                <i class="fas ${isDone ? 'fa-check-circle' : isActive ? 'fa-bell' : 'fa-clock'}"></i>
                            </span>
                        </div>
                    `;
                }).join('');

                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'viewSequenceModal';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h2>${seq.name}</h2>
                            <button class="modal-close" onclick="document.getElementById('viewSequenceModal').remove()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body">
                            ${seq.description ? `<p style="color: var(--text-secondary); margin-bottom: 16px;">${seq.description}</p>` : ''}
                            <h4 style="margin-bottom: 12px; font-size: 14px;">Steps</h4>
                            ${stepsHtml}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            async completeSequenceStep(seqId, stepId) {
                try {
                    await this.api(`/api/sequences/${seqId}/steps/${stepId}/complete`, {
                        method: 'POST'
                    });
                    await this.loadSequences();
                    Toast.success('Step completed!');
                } catch (err) {
                    Toast.error('Failed to complete step: ' + err.message);
                }
            },

            async deleteSequence(seqId) {
                if (!confirm('Delete this sequence? This cannot be undone.')) return;

                try {
                    await this.api(`/api/sequences/${seqId}`, { method: 'DELETE' });
                    await this.loadSequences();
                    Toast.success('Sequence deleted');
                } catch (err) {
                    Toast.error('Failed to delete sequence: ' + err.message);
                }
            },

            // ===== PROJECT TIMELINE EVENTS =====
            projectTimelines: {},

            async loadProjectTimeline(project) {
                try {
                    const events = await this.api(`/api/timeline/${project}`);
                    this.projectTimelines[project] = events || [];
                    this.renderProjectTimeline(project);
                } catch (err) {
                    console.error(`Failed to load timeline for ${project}:`, err);
                }
            },

            renderProjectTimeline(project) {
                const container = document.getElementById(`${project}Timeline`);
                if (!container) return;

                const events = this.projectTimelines[project] || [];
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (!events.length) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 20px; text-align: center;">
                            <i class="fas fa-calendar-plus" style="font-size: 24px; color: var(--text-muted); margin-bottom: 8px;"></i>
                            <p style="color: var(--text-muted);">No timeline events yet</p>
                        </div>
                    `;
                    return;
                }

                // Sort events by date
                const sortedEvents = [...events].sort((a, b) => new Date(a.event_date) - new Date(b.event_date));

                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        ${sortedEvents.map(evt => {
                            const eventDate = new Date(evt.event_date);
                            eventDate.setHours(0, 0, 0, 0);
                            const diffDays = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
                            const isPast = eventDate < today;
                            const isToday = diffDays === 0;

                            const color = evt.color || this.projects[project]?.color || '#c9a962';
                            const dateStr = eventDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                            let statusText = '';
                            let statusColor = color;
                            if (isToday) {
                                statusText = 'Today';
                                statusColor = 'var(--warning)';
                            } else if (isPast) {
                                statusText = `${Math.abs(diffDays)} days ago`;
                                statusColor = 'var(--text-muted)';
                            } else {
                                statusText = `in ${diffDays} days`;
                            }

                            let endDateStr = '';
                            if (evt.event_type === 'range' && evt.end_date) {
                                const endDate = new Date(evt.end_date);
                                endDateStr = ` - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                            }

                            return `
                                <div class="timeline-item" style="display: flex; align-items: center; gap: 12px; padding: 10px 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid ${color}; ${isPast ? 'opacity: 0.6;' : ''}">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: var(--text-primary);">${evt.name}</div>
                                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">
                                            <i class="fas fa-calendar"></i> ${dateStr}${endDateStr}
                                            ${evt.description ? ` <span style="margin-left: 8px;"><i class="fas fa-info-circle"></i> ${evt.description}</span>` : ''}
                                        </div>
                                    </div>
                                    <div style="text-align: right; min-width: 80px;">
                                        <span style="font-size: 12px; color: ${statusColor}; font-weight: 500;">${statusText}</span>
                                    </div>
                                    <div style="display: flex; gap: 4px;">
                                        <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="App.editTimelineEvent('${project}', '${evt.id}')" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn" style="padding: 4px 8px; font-size: 11px; color: var(--danger);" onclick="App.deleteTimelineEvent('${project}', '${evt.id}')" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            },

            openTimelineEventModal(project, event = null) {
                document.getElementById('tlEventId').value = event?.id || '';
                document.getElementById('tlEventProject').value = project;
                document.getElementById('tlEventName').value = event?.name || '';
                document.getElementById('tlEventDesc').value = event?.description || '';
                document.getElementById('tlEventType').value = event?.event_type || 'point';
                document.getElementById('tlEventDate').value = event?.event_date || '';
                document.getElementById('tlEventEndDate').value = event?.end_date || '';
                document.getElementById('tlEventColor').value = event?.color || '';

                // Update modal title
                document.getElementById('timelineEventModalTitle').textContent = event ? 'Edit Timeline Event' : 'Add Timeline Event';

                // Toggle end date visibility
                this.toggleEndDate();

                // Reset color selection
                document.querySelectorAll('#timelineEventModal .color-btn').forEach(btn => {
                    btn.style.borderColor = btn.dataset.color === (event?.color || '') ? 'white' : 'transparent';
                });

                document.getElementById('timelineEventModal').classList.add('active');
            },

            toggleEndDate() {
                const type = document.getElementById('tlEventType').value;
                document.getElementById('tlEndDateGroup').style.display = type === 'range' ? 'block' : 'none';
            },

            selectTimelineColor(color) {
                document.getElementById('tlEventColor').value = color;
                document.querySelectorAll('#timelineEventModal .color-btn').forEach(btn => {
                    btn.style.borderColor = btn.dataset.color === color ? 'white' : 'transparent';
                });
            },

            async saveTimelineEvent() {
                const id = document.getElementById('tlEventId').value;
                const project = document.getElementById('tlEventProject').value;
                const name = document.getElementById('tlEventName').value.trim();
                const description = document.getElementById('tlEventDesc').value.trim();
                const event_type = document.getElementById('tlEventType').value;
                const event_date = document.getElementById('tlEventDate').value;
                const end_date = document.getElementById('tlEventEndDate').value;
                const color = document.getElementById('tlEventColor').value;

                if (!name) {
                    Toast.warning('Please enter an event name');
                    return;
                }
                if (!event_date) {
                    Toast.warning('Please select a date');
                    return;
                }
                if (event_type === 'range' && !end_date) {
                    Toast.warning('Please select an end date for the range');
                    return;
                }

                try {
                    if (id) {
                        // Update existing
                        await this.api(`/api/timeline/${project}/${id}`, {
                            method: 'PUT',
                            body: JSON.stringify({ name, description, event_date, end_date: event_type === 'range' ? end_date : null, event_type, color })
                        });
                    } else {
                        // Create new
                        await this.api(`/api/timeline/${project}`, {
                            method: 'POST',
                            body: JSON.stringify({ name, description, event_date, end_date: event_type === 'range' ? end_date : null, event_type, color })
                        });
                    }

                    this.closeModal('timelineEventModal');
                    await this.loadProjectTimeline(project);
                    Toast.success(id ? 'Event updated' : 'Event created');
                } catch (err) {
                    Toast.error('Failed to save event: ' + err.message);
                }
            },

            editTimelineEvent(project, eventId) {
                const events = this.projectTimelines[project] || [];
                const event = events.find(e => e.id === eventId);
                if (event) {
                    this.openTimelineEventModal(project, event);
                }
            },

            async deleteTimelineEvent(project, eventId) {
                if (!confirm('Delete this event?')) return;

                try {
                    await this.api(`/api/timeline/${project}/${eventId}`, { method: 'DELETE' });
                    await this.loadProjectTimeline(project);
                    Toast.success('Event deleted');
                } catch (err) {
                    Toast.error('Failed to delete event: ' + err.message);
                }
            },

            // ===== CUSTOM SHORTCUT =====
            loadCustomShortcut() {
                const saved = localStorage.getItem('medxCustomShortcut');
                const shortcut = saved ? JSON.parse(saved) : this.defaultShortcut;

                document.getElementById('customShortcutLabel').textContent = shortcut.label;
                const iconEl = document.getElementById('customShortcutIcon');
                iconEl.className = 'fas ' + shortcut.icon;
            },

            launchCustomShortcut() {
                document.getElementById('quickActionDropdown').classList.remove('active');
                const saved = localStorage.getItem('medxCustomShortcut');
                const shortcut = saved ? JSON.parse(saved) : this.defaultShortcut;
                window.open(shortcut.url, '_blank');
            },

            editCustomShortcut() {
                document.getElementById('quickActionDropdown').classList.remove('active');
                const saved = localStorage.getItem('medxCustomShortcut');
                const current = saved ? JSON.parse(saved) : this.defaultShortcut;

                const label = prompt('Shortcut name:', current.label);
                if (!label) return;

                const url = prompt('URL to open:', current.url);
                if (!url) return;

                const iconChoice = prompt('Icon (video, link, globe, rocket, paper-plane, bolt):',
                    current.icon.replace('fa-', ''));
                const icon = iconChoice ? 'fa-' + iconChoice : 'fa-link';

                const shortcut = { label, url, icon };
                localStorage.setItem('medxCustomShortcut', JSON.stringify(shortcut));
                this.loadCustomShortcut();
                Toast.success('Shortcut saved!');
            },

            // ===== FILE MANAGEMENT =====
            projectFiles: {},
            projectFolders: {},

            async loadProjectFiles(project) {
                try {
                    const folderId = this.currentFolders[project] || null;
                    const url = folderId
                        ? `/api/files/${project}?folder_id=${folderId}`
                        : `/api/files/${project}`;
                    const data = await this.api(url);
                    this.projectFiles[project] = data.files || [];
                    this.projectFolders[project] = data.folders || [];
                    this.renderProjectFiles(project);
                } catch (err) {
                    console.error(`Failed to load files for ${project}:`, err);
                }
            },

            renderProjectFiles(project) {
                const container = document.getElementById(`${project}Files`);
                if (!container) return;

                const files = this.projectFiles[project] || [];
                const folders = this.projectFolders[project] || [];
                const isInFolder = !!this.currentFolders[project];

                let html = '';

                // Back button if in a folder
                if (isInFolder) {
                    html += `
                        <div class="file-item" onclick="App.goUpFolder('${project}')" style="border: 1px dashed var(--border);">
                            <div class="file-icon" style="background: transparent;"><i class="fas fa-arrow-left" style="color: var(--text-muted);"></i></div>
                            <div class="file-name" style="color: var(--text-muted);">Back</div>
                        </div>
                    `;
                }

                // Folders
                html += folders.map(folder => `
                    <div class="file-item" onclick="App.openFolder('${project}', '${folder.id}', '${this.escapeHtml(folder.name)}')">
                        <button class="file-delete" onclick="event.stopPropagation(); App.deleteFolder('${folder.id}', '${project}')" title="Delete folder">
                            <i class="fas fa-trash"></i>
                        </button>
                        <div class="file-icon" style="color: #fbbf24;"><i class="fas fa-folder"></i></div>
                        <div class="file-name">${this.escapeHtml(folder.name)}</div>
                        <div class="file-meta">Folder</div>
                    </div>
                `).join('');

                // Files
                html += files.map(file => {
                    const ext = file.original_name.split('.').pop().toLowerCase();
                    let iconClass = 'other';
                    let icon = 'fa-file';

                    if (['pdf'].includes(ext)) { iconClass = 'pdf'; icon = 'fa-file-pdf'; }
                    else if (['doc', 'docx'].includes(ext)) { iconClass = 'doc'; icon = 'fa-file-word'; }
                    else if (['ppt', 'pptx'].includes(ext)) { iconClass = 'ppt'; icon = 'fa-file-powerpoint'; }
                    else if (['xls', 'xlsx'].includes(ext)) { iconClass = 'doc'; icon = 'fa-file-excel'; }
                    else if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) { iconClass = 'img'; icon = 'fa-file-image'; }

                    const size = file.file_size < 1024 * 1024
                        ? `${(file.file_size / 1024).toFixed(0)} KB`
                        : `${(file.file_size / (1024 * 1024)).toFixed(1)} MB`;

                    return `
                        <div class="file-item" onclick="window.open('${file.file_path}', '_blank')">
                            <button class="file-delete" onclick="event.stopPropagation(); App.deleteFile('${file.id}', '${project}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                            <div class="file-icon ${iconClass}"><i class="fas ${icon}"></i></div>
                            <div class="file-name" title="${this.escapeHtml(file.original_name)}">${this.escapeHtml(file.original_name)}</div>
                            <div class="file-meta">${size}</div>
                        </div>
                    `;
                }).join('');

                // Add folder & file buttons
                html += `
                    <div class="file-item" style="background: transparent; border: 2px dashed var(--border);" onclick="App.createFolder('${project}')">
                        <div class="file-icon" style="background: transparent;"><i class="fas fa-folder-plus" style="color: var(--text-muted);"></i></div>
                        <div class="file-name" style="color: var(--text-muted);">New folder</div>
                    </div>
                    <div class="file-item" style="background: transparent; border: 2px dashed var(--border);" onclick="App.triggerFileUpload('${project}')">
                        <div class="file-icon" style="background: transparent;"><i class="fas fa-plus" style="color: var(--text-muted);"></i></div>
                        <div class="file-name" style="color: var(--text-muted);">Add file</div>
                    </div>
                `;

                if (files.length === 0 && folders.length === 0 && !isInFolder) {
                    html = `
                        <div class="file-upload-zone" onclick="App.triggerFileUpload('${project}')">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drop files here or click to upload</p>
                        </div>
                        <div class="file-item" style="background: transparent; border: 2px dashed var(--border); margin-top: 12px;" onclick="App.createFolder('${project}')">
                            <div class="file-icon" style="background: transparent;"><i class="fas fa-folder-plus" style="color: var(--text-muted);"></i></div>
                            <div class="file-name" style="color: var(--text-muted);">New folder</div>
                        </div>
                    `;
                }

                container.innerHTML = html;
            },

            triggerFileUpload(project) {
                document.getElementById(`fileUpload-${project}`).click();
            },

            async uploadFile(project, file) {
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);
                if (this.currentFolders[project]) {
                    formData.append('folder_id', this.currentFolders[project]);
                }

                try {
                    const res = await fetch(`/api/files/${project}`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${this.token}` },
                        body: formData
                    });
                    const data = await res.json();

                    if (data.success) {
                        await this.loadProjectFiles(project);
                    }
                } catch (err) {
                    console.error('Upload failed:', err);
                }

                // Clear the input
                document.getElementById(`fileUpload-${project}`).value = '';
            },

            async deleteFile(fileId, project) {
                if (!confirm('Delete this file?')) return;

                try {
                    await this.api(`/api/files/${fileId}`, { method: 'DELETE' });
                    await this.loadProjectFiles(project);
                } catch (err) {
                    console.error('Delete failed:', err);
                }
            },

            // ===== FOLDERS =====
            currentFolders: {},

            async createFolder(project) {
                const name = prompt('Folder name:');
                if (!name) return;

                try {
                    await this.api(`/api/folders/${project}`, {
                        method: 'POST',
                        body: JSON.stringify({ name, parent_id: this.currentFolders[project] || null })
                    });
                    await this.loadProjectFiles(project);
                } catch (err) {
                    console.error('Create folder failed:', err);
                }
            },

            async openFolder(project, folderId, folderName) {
                this.currentFolders[project] = folderId;
                await this.loadProjectFiles(project);
            },

            async goUpFolder(project) {
                this.currentFolders[project] = null;
                await this.loadProjectFiles(project);
            },

            async deleteFolder(folderId, project) {
                if (!confirm('Delete this folder? Files will be moved to parent.')) return;

                try {
                    await this.api(`/api/folders/${folderId}`, { method: 'DELETE' });
                    await this.loadProjectFiles(project);
                } catch (err) {
                    console.error('Delete folder failed:', err);
                }
            },

            // ===== MOBILE =====
            toggleMobileMenu() {
                document.getElementById('sidebar').classList.toggle('open');
                document.getElementById('sidebarOverlay').classList.toggle('active');
            },

            toggleMobileChat() {
                document.getElementById('chatPanel').classList.toggle('open');
            },

            // Chat visibility and pinning
            chatHidden: false,
            chatPinned: true,

            toggleChatVisibility() {
                this.chatHidden = !this.chatHidden;
                const chatPanel = document.getElementById('chatPanel');
                const showBtn = document.getElementById('chatShowBtn');
                const hideBtn = document.getElementById('chatHideBtn');

                if (this.chatHidden) {
                    chatPanel.classList.add('hidden');
                    showBtn.classList.add('visible');
                    if (hideBtn) hideBtn.innerHTML = '<i class="fas fa-eye"></i>';
                } else {
                    chatPanel.classList.remove('hidden');
                    showBtn.classList.remove('visible');
                    if (hideBtn) hideBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                }

                // Save preference
                localStorage.setItem('chatHidden', this.chatHidden);
            },

            toggleChatPin() {
                this.chatPinned = !this.chatPinned;
                const pinBtn = document.getElementById('chatPinBtn');

                if (this.chatPinned) {
                    pinBtn.classList.add('active');
                    pinBtn.title = 'Unpin chat';
                } else {
                    pinBtn.classList.remove('active');
                    pinBtn.title = 'Pin chat';
                }

                // Save preference
                localStorage.setItem('chatPinned', this.chatPinned);
            },

            loadChatPreferences() {
                const hidden = localStorage.getItem('chatHidden') === 'true';
                const pinned = localStorage.getItem('chatPinned') !== 'false'; // Default to pinned

                this.chatHidden = hidden;
                this.chatPinned = pinned;

                if (hidden) {
                    document.getElementById('chatPanel').classList.add('hidden');
                    document.getElementById('chatShowBtn').classList.add('visible');
                }

                if (pinned) {
                    document.getElementById('chatPinBtn')?.classList.add('active');
                }
            },

            // ===== PROJECT CHAT =====
            projectChannels: {},
            projectActiveChannel: {},
            collapsedParentChannels: {},

            async loadProjectChannels(project) {
                try {
                    const allChannels = await this.api('/api/channels');
                    this.projectChannels[project] = allChannels.filter(ch => ch.project === project);
                    this.renderProjectChatTabs(project);

                    // Auto-select first top-level channel
                    const topLevel = this.projectChannels[project].filter(ch => !ch.parent_channel_id);
                    if (topLevel.length > 0 && !this.projectActiveChannel[project]) {
                        this.selectProjectChannel(project, topLevel[0].id);
                    } else if (this.projectChannels[project].length > 0 && !this.projectActiveChannel[project]) {
                        this.selectProjectChannel(project, this.projectChannels[project][0].id);
                    }
                } catch (err) {
                    console.error(`Failed to load channels for ${project}:`, err);
                }
            },

            buildChannelTree(channels) {
                const topLevel = channels.filter(ch => !ch.parent_channel_id);
                return topLevel.map(parent => ({
                    ...parent,
                    children: channels.filter(ch => ch.parent_channel_id === parent.id)
                }));
            },

            toggleParentChannel(project, parentId, event) {
                if (event) event.stopPropagation();
                if (!this.collapsedParentChannels[project]) this.collapsedParentChannels[project] = {};
                this.collapsedParentChannels[project][parentId] = !this.collapsedParentChannels[project][parentId];
                this.renderProjectChatTabs(project);
            },

            async addSubChannel(project, parentId, event) {
                if (event) event.stopPropagation();
                const name = prompt('Sub-channel name:');
                if (!name || !name.trim()) return;
                try {
                    await this.api('/api/channels', {
                        method: 'POST',
                        body: JSON.stringify({ name: name.trim(), project, parent_channel_id: parentId })
                    });
                    await this.loadProjectChannels(project);
                } catch (err) {
                    console.error('Failed to create sub-channel:', err);
                    Toast.error('Failed to create sub-channel');
                }
            },

            renderProjectChatTabs(project) {
                const container = document.getElementById(`${project}ChatTabs`);
                if (!container) return;

                const channels = this.projectChannels[project] || [];
                const activeId = this.projectActiveChannel[project];
                const tree = this.buildChannelTree(channels);
                const collapsed = this.collapsedParentChannels[project] || {};

                let html = '';
                tree.forEach(parent => {
                    const hasChildren = parent.children && parent.children.length > 0;
                    const isCollapsed = collapsed[parent.id];
                    const toggleIcon = hasChildren ? (isCollapsed ? '\u25B6' : '\u25BC') : '';
                    const mc = parent.member_count || 0;

                    html += `<div class="project-chat-tab ${hasChildren ? 'parent-channel' : ''} ${parent.id === activeId ? 'active' : ''}"
                         onclick="App.selectProjectChannel('${project}', '${parent.id}')">`;
                    if (hasChildren) {
                        html += `<span class="toggle-children" onclick="App.toggleParentChannel('${project}', '${parent.id}', event)">${toggleIcon}</span>`;
                    }
                    html += `<span class="hash">#</span>${parent.name}`;
                    if (mc > 0) html += `<span class="member-count" title="${mc} member${mc !== 1 ? 's' : ''}">${mc}</span>`;
                    html += `<span class="add-subchannel-btn" onclick="App.addSubChannel('${project}', '${parent.id}', event)" title="Add sub-channel">+</span>`;
                    html += `</div>`;

                    if (hasChildren && !isCollapsed) {
                        parent.children.forEach(child => {
                            const cmc = child.member_count || 0;
                            html += `<div class="project-chat-tab sub-channel ${child.id === activeId ? 'active' : ''}"
                                 onclick="App.selectProjectChannel('${project}', '${child.id}')">
                                <span class="hash">#</span>${child.name}${cmc > 0 ? `<span class="member-count" title="${cmc} member${cmc !== 1 ? 's' : ''}">${cmc}</span>` : ''}
                            </div>`;
                        });
                    }
                });

                // Add members button at end
                if (channels.length > 0) {
                    html += `<button class="channel-members-btn" onclick="App.openChannelMemberPicker('${project}', event)" title="Manage channel members">
                        <i class="fas fa-user-plus"></i> Members
                    </button>`;
                }

                container.innerHTML = html || '<span style="color: var(--text-muted); font-size: 12px;">No channels yet</span>';
            },

            async selectProjectChannel(project, channelId) {
                this.projectActiveChannel[project] = channelId;
                this.renderProjectChatTabs(project);
                await this.loadProjectMessages(project);
            },

            async loadProjectMessages(project) {
                const channelId = this.projectActiveChannel[project];
                if (!channelId) return;

                try {
                    const messages = await this.api(`/api/chat/messages?channel_id=${channelId}`);
                    this.renderProjectMessages(project, messages);
                } catch (err) {
                    console.error(`Failed to load messages for ${project}:`, err);
                }
            },

            renderProjectMessages(project, messages) {
                const container = document.getElementById(`${project}ChatMessages`);
                if (!container) return;

                if (!messages || messages.length === 0) {
                    container.innerHTML = `
                        <div class="chat-empty">
                            <i class="fas fa-comments"></i>
                            <p>No messages in this channel yet</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = messages.map(msg => {
                    const initials = msg.sender_name ? msg.sender_name.split(' ').map(n => n[0]).join('') : '?';
                    const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    return `
                        <div class="chat-message">
                            <div class="chat-message-header">
                                <div class="chat-avatar" style="background: ${msg.avatar_color || 'var(--accent-gold)'}; color: var(--bg-primary); width: 24px; height: 24px; font-size: 10px;">
                                    ${initials}
                                </div>
                                <span class="chat-sender" style="font-size: 12px;">${msg.sender_name || 'Unknown'}</span>
                                <span class="chat-time" style="font-size: 10px;">${time}</span>
                            </div>
                            <div class="chat-text" style="font-size: 13px;">${this.escapeHtml(msg.message)}</div>
                        </div>
                    `;
                }).join('');

                container.scrollTop = container.scrollHeight;
            },

            async sendProjectMessage(project) {
                const input = document.getElementById(`${project}ChatInput`);
                const message = input.value.trim();
                const channelId = this.projectActiveChannel[project];

                if (!message || !this.teamMember || !channelId) return;

                try {
                    await this.api('/api/chat/messages', {
                        method: 'POST',
                        body: JSON.stringify({
                            message,
                            sender_id: this.teamMember.id,
                            channel_id: channelId
                        })
                    });

                    input.value = '';
                    await this.loadProjectMessages(project);
                } catch (err) {
                    console.error('Failed to send message:', err);
                }
            },

            // ===== CHANNEL MEMBER PICKER =====
            channelMemberPickerState: null,

            async openChannelMemberPicker(project, event) {
                event.stopPropagation();
                const channelId = this.projectActiveChannel[project];
                if (!channelId) { Toast.warning('Select a channel first'); return; }

                const channel = (this.projectChannels[project] || []).find(c => c.id === channelId);
                if (!channel) return;

                // Fetch current members for this channel
                let currentMembers = [];
                try {
                    currentMembers = await this.api(`/api/channels/${channelId}/members`);
                } catch (e) { console.error(e); }

                const currentMemberIds = new Set(currentMembers.map(m => m.member_id));

                // Store state
                this.channelMemberPickerState = {
                    project,
                    channelId,
                    channelName: channel.name,
                    selectedIds: new Set(currentMemberIds)
                };

                // Build picker HTML
                const allMembers = this.teamMembers || [];
                let pickerHtml = `
                    <div class="member-picker-overlay active" onclick="App.closeChannelMemberPicker()"></div>
                    <div class="member-picker" id="memberPickerDropdown">
                        <div class="member-picker-title"><i class="fas fa-users" style="margin-right: 4px;"></i> #${channel.name} Members</div>
                        ${allMembers.map(m => {
                            const initials = m.name ? m.name.split(' ').map(n => n[0]).join('') : '?';
                            const isSelected = currentMemberIds.has(m.id);
                            return `<div class="member-picker-item ${isSelected ? 'selected' : ''}" data-member-id="${m.id}" onclick="App.toggleChannelMember('${m.id}')">
                                <div class="mp-check"><i class="fas fa-check"></i></div>
                                <div class="mp-avatar" style="background: ${m.avatar_color || 'var(--accent-gold)'}">${initials}</div>
                                <span>${m.name}</span>
                            </div>`;
                        }).join('')}
                        ${allMembers.length === 0 ? '<div style="padding: 12px; color: var(--text-muted); font-size: 12px;">No team members found</div>' : ''}
                        <div class="member-picker-actions">
                            <button class="mp-btn-all" onclick="App.addToAllProjectChannels('${project}')"><i class="fas fa-layer-group"></i> All Ch.</button>
                            <button class="mp-btn-cancel" onclick="App.closeChannelMemberPicker()">Cancel</button>
                            <button class="mp-btn-save" onclick="App.saveChannelMembers()"><i class="fas fa-check"></i> Save</button>
                        </div>
                    </div>
                `;

                // Remove existing picker if any
                const existing = document.getElementById('channelMemberPickerContainer');
                if (existing) existing.remove();

                // Create container
                const container = document.createElement('div');
                container.id = 'channelMemberPickerContainer';
                container.innerHTML = pickerHtml;
                document.body.appendChild(container);

                // Position the picker near the button
                const btn = event.currentTarget;
                const rect = btn.getBoundingClientRect();
                const picker = document.getElementById('memberPickerDropdown');
                picker.style.top = (rect.bottom + 4) + 'px';
                picker.style.left = Math.min(rect.left, window.innerWidth - 240) + 'px';
            },

            toggleChannelMember(memberId) {
                if (!this.channelMemberPickerState) return;
                const state = this.channelMemberPickerState;

                if (state.selectedIds.has(memberId)) {
                    state.selectedIds.delete(memberId);
                } else {
                    state.selectedIds.add(memberId);
                }

                // Toggle visual state
                const item = document.querySelector(`.member-picker-item[data-member-id="${memberId}"]`);
                if (item) item.classList.toggle('selected');
            },

            closeChannelMemberPicker() {
                this.channelMemberPickerState = null;
                const container = document.getElementById('channelMemberPickerContainer');
                if (container) container.remove();
            },

            async saveChannelMembers() {
                const state = this.channelMemberPickerState;
                if (!state) return;

                const { channelId, project, selectedIds } = state;

                try {
                    // Get current members
                    const currentMembers = await this.api(`/api/channels/${channelId}/members`);
                    const currentIds = new Set(currentMembers.map(m => m.member_id));

                    // Add new members
                    const toAdd = [...selectedIds].filter(id => !currentIds.has(id));
                    if (toAdd.length > 0) {
                        await this.api(`/api/channels/${channelId}/members`, {
                            method: 'POST',
                            body: JSON.stringify({ member_ids: toAdd })
                        });
                    }

                    // Remove unselected members
                    const toRemove = [...currentIds].filter(id => !selectedIds.has(id));
                    for (const mid of toRemove) {
                        await this.api(`/api/channels/${channelId}/members/${mid}`, {
                            method: 'DELETE'
                        });
                    }

                    // Refresh channels to update member counts
                    await this.loadProjectChannels(project);
                    this.closeChannelMemberPicker();
                } catch (err) {
                    console.error('Failed to save channel members:', err);
                    Toast.error('Failed to save members');
                }
            },

            async addToAllProjectChannels(project) {
                const state = this.channelMemberPickerState;
                if (!state) return;

                // Get all selected members and add each to all project channels
                const selectedIds = [...state.selectedIds];
                if (selectedIds.length === 0) {
                    Toast.warning('Select at least one member first');
                    return;
                }

                try {
                    for (const memberId of selectedIds) {
                        await this.api(`/api/channels/${state.channelId}/members/bulk`, {
                            method: 'POST',
                            body: JSON.stringify({ member_id: memberId, project })
                        });
                    }

                    // Refresh channels to update member counts
                    await this.loadProjectChannels(project);
                    this.closeChannelMemberPicker();
                } catch (err) {
                    console.error('Failed to bulk add members:', err);
                    Toast.error('Failed to add members to all channels');
                }
            },

            // ===== CHAT REPLY =====
            replyingTo: null,

            setReplyTo(msgId, senderName, message) {
                this.replyingTo = { id: msgId, name: senderName, text: message };
                document.getElementById('chatReplyPreview').style.display = 'flex';
                document.getElementById('replyToName').textContent = senderName;
                document.getElementById('replyToText').textContent = message.substring(0, 50) + (message.length > 50 ? '...' : '');
                document.getElementById('chatInput').focus();
            },

            cancelReply() {
                this.replyingTo = null;
                document.getElementById('chatReplyPreview').style.display = 'none';
            },

            // ===== RESIZE PANELS =====
            initResizeHandles() {
                const sidebarHandle = document.getElementById('sidebarResizeHandle');
                const chatHandle = document.getElementById('chatResizeHandle');
                const sidebar = document.getElementById('sidebar');
                const chatPanel = document.getElementById('chatPanel');
                const root = document.documentElement;

                let isResizing = false;
                let currentHandle = null;

                const startResize = (e, handle) => {
                    isResizing = true;
                    currentHandle = handle;
                    handle.classList.add('active');
                    document.body.style.cursor = 'col-resize';
                    document.body.style.userSelect = 'none';
                    e.preventDefault();
                };

                const resize = (e) => {
                    if (!isResizing) return;

                    if (currentHandle === sidebarHandle) {
                        const width = Math.min(400, Math.max(200, e.clientX));
                        root.style.setProperty('--sidebar-width', width + 'px');
                    } else if (currentHandle === chatHandle) {
                        const width = Math.min(500, Math.max(280, window.innerWidth - e.clientX));
                        root.style.setProperty('--chat-width', width + 'px');
                    }
                };

                const stopResize = () => {
                    if (isResizing) {
                        isResizing = false;
                        currentHandle?.classList.remove('active');
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                    }
                };

                if (sidebarHandle) {
                    sidebarHandle.addEventListener('mousedown', (e) => startResize(e, sidebarHandle));
                }
                if (chatHandle) {
                    chatHandle.addEventListener('mousedown', (e) => startResize(e, chatHandle));
                }
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
            },

            // ===== PLEXUS CONFERENCE MANAGEMENT =====
            plexusCurrentTab: 'dashboard',
            plexusScheduleDay: 1,
            plexusRegistrations: [],
            plexusAbstracts: [],
            plexusSessions: [],
            plexusSpeakers: [],
            plexusSponsors: [],
            plexusVolunteers: [],
            plexusPending: {},

            showPlexusTab(tab) {
                const tabNames = {
                    'dashboard': 'Dashboard',
                    'registrations': 'Registrations',
                    'abstracts': 'Abstracts',
                    'schedule': 'Schedule',
                    'speakers': 'Speakers',
                    'sponsors': 'Sponsors',
                    'volunteers': 'Volunteers',
                    'checkin': 'Check-in',
                    'pending': 'Pending',
                    'settings': 'Settings'
                };
                document.title = `Med&X Admin — Plexus · ${tabNames[tab] || tab}`;

                this.plexusCurrentTab = tab;

                // Update tab buttons
                document.querySelectorAll('.plexus-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.plexus-tab[onclick*="'${tab}'"]`)?.classList.add('active');

                // Update content panels
                document.querySelectorAll('.plexus-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`plexus-${tab}`)?.classList.add('active');

                // Load data for the tab
                switch(tab) {
                    case 'dashboard':
                        this.loadPlexusStats();
                        this.loadDashboardPrefs('plexus').then(() => this.renderDynamicDashboard('plexus', 'plexusDashboardCards'));
                        break;
                    case 'registrations': this.loadPlexusRegistrations(); break;
                    case 'abstracts': this.loadPlexusAbstracts(); break;
                    case 'schedule': this.loadPlexusSchedule(); break;
                    case 'speakers': this.loadPlexusSpeakers(); break;
                    case 'sponsors': this.loadPlexusSponsors(); break;
                    case 'volunteers': this.loadPlexusVolunteers(); break;
                    case 'checkin': this.loadPlexusCheckinStats(); break;
                    case 'pending': this.loadPlexusPending(); break;
                    case 'settings': PlexusSettingsAdmin.loadSettings(); break;
                }
            },

            async loadPlexusStats() {
                try {
                    const stats = await this.api('/api/admin/plexus/stats');

                    document.getElementById('pxStatReg').textContent = stats.total_registrations || 0;
                    document.getElementById('pxStatPaid').textContent = stats.paid_registrations || 0;
                    document.getElementById('pxStatChecked').textContent = stats.checked_in || 0;
                    document.getElementById('pxStatRevenue').textContent = (stats.total_revenue || 0).toLocaleString();
                    document.getElementById('pxStatAbstracts').textContent = stats.total_abstracts || 0;
                    document.getElementById('pxStatAccepted').textContent = stats.accepted_abstracts || 0;

                    // Update pending badges
                    const pending = stats.pending || {};
                    this.updatePendingBadge('pxPendingRefunds', pending.refunds || 0, 'Refunds');
                    this.updatePendingBadge('pxPendingVisas', pending.visas || 0, 'Visa Requests');
                    this.updatePendingBadge('pxPendingScholarships', pending.scholarships || 0, 'Scholarships');
                    this.updatePendingBadge('pxPendingSpeakers', pending.speaker_apps || 0, 'Speaker Apps');

                    // Render charts
                    this.renderPlexusCharts(stats);
                } catch (err) {
                    console.error('Failed to load Plexus stats:', err);
                }
            },

            updatePendingBadge(id, count, label) {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = `${count} ${label}`;
                    el.classList.toggle('has-items', count > 0);
                }
            },

            renderPlexusCharts(stats) {
                const typeColors = ['#a78bfa', '#22d3ee', '#c9a962', '#f472b6', '#fb923c', '#10b981'];

                // Registration by type chart (Doughnut)
                const typeCtx = document.getElementById('pxChartByTypeCanvas');
                const types = stats.by_type || {};
                if (typeCtx && typeof Chart !== 'undefined') {
                    if (window._pxTypeChart) window._pxTypeChart.destroy();
                    const typeLabels = Object.keys(types);
                    const typeData = Object.values(types);
                    if (typeLabels.length > 0) {
                        window._pxTypeChart = new Chart(typeCtx, {
                            type: 'doughnut',
                            data: {
                                labels: typeLabels,
                                datasets: [{
                                    data: typeData,
                                    backgroundColor: typeColors.slice(0, typeLabels.length),
                                    borderWidth: 0,
                                    spacing: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                cutout: '65%',
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: { color: 'rgba(255,255,255,0.7)', font: { family: 'Inter', size: 11 }, padding: 12, usePointStyle: true }
                                    }
                                }
                            }
                        });
                    } else {
                        document.getElementById('pxChartByType').innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No registrations yet</p>';
                    }
                }

                // Top Countries (Horizontal Bar)
                const countryCtx = document.getElementById('pxChartByCountryCanvas');
                const countries = stats.by_country || {};
                if (countryCtx && typeof Chart !== 'undefined') {
                    if (window._pxCountryChart) window._pxCountryChart.destroy();
                    const topCountries = Object.entries(countries).sort((a,b) => b[1] - a[1]).slice(0, 7);
                    const countryLabels = topCountries.map(c => c[0]);
                    const countryData = topCountries.map(c => c[1]);
                    if (countryLabels.length > 0) {
                        window._pxCountryChart = new Chart(countryCtx, {
                            type: 'bar',
                            data: {
                                labels: countryLabels,
                                datasets: [{
                                    data: countryData,
                                    backgroundColor: '#a78bfa',
                                    borderRadius: 6,
                                    borderSkipped: false
                                }]
                            },
                            options: {
                                indexAxis: 'y',
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: {
                                    x: {
                                        ticks: { color: 'rgba(255,255,255,0.5)', font: { family: 'Inter' } },
                                        grid: { color: 'rgba(255,255,255,0.05)' }
                                    },
                                    y: {
                                        ticks: { color: 'rgba(255,255,255,0.7)', font: { family: 'Inter', size: 12 } },
                                        grid: { display: false }
                                    }
                                }
                            }
                        });
                    } else {
                        document.getElementById('pxChartByCountry').innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No country data yet</p>';
                    }
                }
            },

            // Registration state for sorting/grouping
            pxRegSortCol: null,
            pxRegSortDir: 'asc',
            pxRegGroupBy: 'none',
            pxRegFiltered: [],

            async loadPlexusRegistrations() {
                showSkeleton('pxRegTableBody', 'table', 5);
                try {
                    const regs = await this.api('/api/admin/plexus/registrations');
                    this.plexusRegistrations = regs;
                    this.populateRegFilterDropdowns(regs);
                    this.pxRegSortCol = null;
                    this.pxRegSortDir = 'asc';
                    this.pxRegGroupBy = 'none';
                    this.filterPlexusRegistrations();
                } catch (err) {
                    console.error('Failed to load registrations:', err);
                }
            },

            populateRegFilterDropdowns(regs) {
                // Country dropdown
                const countries = [...new Set(regs.map(r => r.country).filter(Boolean))].sort();
                const countrySelect = document.getElementById('pxRegCountryFilter');
                if (countrySelect) {
                    countrySelect.innerHTML = '<option value="">All Countries</option>' +
                        countries.map(c => `<option value="${this.escapeHtml(c)}">${this.escapeHtml(c)}</option>`).join('');
                }
                // Institution dropdown
                const institutions = [...new Set(regs.map(r => r.institution).filter(Boolean))].sort();
                const instSelect = document.getElementById('pxRegInstitutionFilter');
                if (instSelect) {
                    instSelect.innerHTML = '<option value="">All Institutions</option>' +
                        institutions.map(i => `<option value="${this.escapeHtml(i)}">${this.escapeHtml(i)}</option>`).join('');
                }
                // Ticket type dropdown
                const tickets = [...new Set(regs.map(r => r.ticket_type).filter(Boolean))].sort();
                const ticketSelect = document.getElementById('pxRegTicketFilter');
                if (ticketSelect) {
                    ticketSelect.innerHTML = '<option value="">All Tickets</option>' +
                        tickets.map(t => `<option value="${this.escapeHtml(t)}">${this.escapeHtml(t)}</option>`).join('');
                }
            },

            getRegName(r) {
                return ((r.first_name || '') + ' ' + (r.last_name || '')).trim();
            },

            renderPlexusRegistrations(regs) {
                const tbody = document.getElementById('pxRegTableBody');
                const table = document.getElementById('pxRegTable');
                const groupedContainer = document.getElementById('pxRegGroupedContainer');
                if (!tbody || !table || !groupedContainer) return;

                if (!regs || regs.length === 0) {
                    groupedContainer.innerHTML = '';
                    groupedContainer.style.display = 'none';
                    table.style.display = '';
                    tbody.innerHTML = '<tr><td colspan="8" class="table-empty"><i class="fas fa-users"></i><p>No registrations yet</p></td></tr>';
                    return;
                }

                if (this.pxRegGroupBy !== 'none') {
                    // Grouped view
                    table.style.display = 'none';
                    groupedContainer.style.display = '';
                    const groups = {};
                    regs.forEach(r => {
                        const key = r[this.pxRegGroupBy] || 'Unknown';
                        if (!groups[key]) groups[key] = [];
                        groups[key].push(r);
                    });
                    const sortedKeys = Object.keys(groups).sort();
                    groupedContainer.innerHTML = sortedKeys.map(key => `
                        <div class="px-group-section">
                            <div class="px-group-header" onclick="this.classList.toggle('collapsed'); this.nextElementSibling.classList.toggle('collapsed');">
                                <div>
                                    <span class="px-group-header-title">${this.escapeHtml(key)}</span>
                                    <span class="px-group-header-count">${groups[key].length}</span>
                                    <i class="fas fa-chevron-down px-chevron"></i>
                                </div>
                            </div>
                            <div class="px-group-body">
                                <table class="data-table" style="margin: 0;">
                                    <thead>
                                        <tr><th>Name</th><th>Email</th><th>Institution</th><th>Ticket</th><th>Status</th><th>Payment</th><th>Checked In</th><th>Actions</th></tr>
                                    </thead>
                                    <tbody>${groups[key].map(r => this.renderRegRow(r)).join('')}</tbody>
                                </table>
                            </div>
                        </div>
                    `).join('');
                } else {
                    // Flat table view
                    groupedContainer.style.display = 'none';
                    groupedContainer.innerHTML = '';
                    table.style.display = '';
                    tbody.innerHTML = regs.map(r => this.renderRegRow(r)).join('');
                }
            },

            renderRegRow(r) {
                return `<tr>
                    <td><strong>${this.escapeHtml(r.first_name || '')} ${this.escapeHtml(r.last_name || '')}</strong></td>
                    <td>${this.escapeHtml(r.email || '')}</td>
                    <td>${this.escapeHtml(r.institution || '-')}</td>
                    <td>${this.escapeHtml(r.ticket_type || 'General')}</td>
                    <td><span class="status ${r.status || 'pending'}">${r.status || 'Pending'}</span></td>
                    <td><span class="status ${r.payment_status === 'paid' ? 'paid' : 'pending'}">${r.payment_status || 'Pending'}</span></td>
                    <td>${r.checked_in ? '<i class="fas fa-check" style="color: var(--success);"></i>' : '-'}</td>
                    <td class="actions">
                        <button onclick="App.viewRegistration('${r.id}')" title="View"><i class="fas fa-eye"></i></button>
                        <button onclick="App.editRegistration('${r.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>`;
            },

            filterPlexusRegistrations() {
                const search = (document.getElementById('pxRegSearch')?.value || '').toLowerCase();
                const statusFilter = document.getElementById('pxRegStatusFilter')?.value || '';
                const countryFilter = document.getElementById('pxRegCountryFilter')?.value || '';
                const instFilter = document.getElementById('pxRegInstitutionFilter')?.value || '';
                const ticketFilter = document.getElementById('pxRegTicketFilter')?.value || '';
                const paymentFilter = document.getElementById('pxRegPaymentFilter')?.value || '';

                let filtered = this.plexusRegistrations.filter(r => {
                    const matchSearch = !search ||
                        (r.first_name && r.first_name.toLowerCase().includes(search)) ||
                        (r.last_name && r.last_name.toLowerCase().includes(search)) ||
                        (r.email && r.email.toLowerCase().includes(search)) ||
                        (r.institution && r.institution.toLowerCase().includes(search));
                    const matchStatus = !statusFilter || r.status === statusFilter;
                    const matchCountry = !countryFilter || r.country === countryFilter;
                    const matchInst = !instFilter || r.institution === instFilter;
                    const matchTicket = !ticketFilter || r.ticket_type === ticketFilter;
                    const matchPayment = !paymentFilter || r.payment_status === paymentFilter;
                    return matchSearch && matchStatus && matchCountry && matchInst && matchTicket && matchPayment;
                });

                // Apply current sort
                if (this.pxRegSortCol) {
                    filtered = this.applySortRegs(filtered);
                }

                this.pxRegFiltered = filtered;
                this.renderPlexusRegistrations(filtered);
            },

            clearRegFilters() {
                const ids = ['pxRegSearch', 'pxRegStatusFilter', 'pxRegCountryFilter', 'pxRegInstitutionFilter', 'pxRegTicketFilter', 'pxRegPaymentFilter'];
                ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
                this.filterPlexusRegistrations();
            },

            sortPlexusRegistrations(col) {
                if (this.pxRegSortCol === col) {
                    this.pxRegSortDir = this.pxRegSortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    this.pxRegSortCol = col;
                    this.pxRegSortDir = 'asc';
                }
                // Update sort icons
                document.querySelectorAll('[id^="pxRegSort-"]').forEach(el => el.textContent = '');
                const icon = document.getElementById(`pxRegSort-${col}`);
                if (icon) icon.textContent = this.pxRegSortDir === 'asc' ? ' \u2191' : ' \u2193';

                this.filterPlexusRegistrations();
            },

            applySortRegs(arr) {
                const col = this.pxRegSortCol;
                const dir = this.pxRegSortDir === 'asc' ? 1 : -1;
                return [...arr].sort((a, b) => {
                    let va, vb;
                    if (col === 'name') {
                        va = this.getRegName(a).toLowerCase();
                        vb = this.getRegName(b).toLowerCase();
                    } else {
                        va = (a[col] || '').toString().toLowerCase();
                        vb = (b[col] || '').toString().toLowerCase();
                    }
                    if (va < vb) return -1 * dir;
                    if (va > vb) return 1 * dir;
                    return 0;
                });
            },

            groupPlexusRegistrations(groupBy) {
                this.pxRegGroupBy = groupBy;
                // Update toggle buttons
                document.querySelectorAll('#plexus-registrations .px-group-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.group === groupBy);
                });
                this.filterPlexusRegistrations();
            },

            exportPlexusRegistrations() {
                const data = this.pxRegFiltered && this.pxRegFiltered.length > 0 ? this.pxRegFiltered : this.plexusRegistrations;
                if (!data || data.length === 0) {
                    Toast.warning('No registrations to export');
                    return;
                }

                const headers = ['First Name', 'Last Name', 'Email', 'Institution', 'Country', 'Ticket Type', 'Status', 'Payment', 'Checked In'];
                const rows = data.map(r => [
                    r.first_name || '', r.last_name || '', r.email || '', r.institution || '',
                    r.country || '', r.ticket_type || '', r.status || '', r.payment_status || '', r.checked_in ? 'Yes' : 'No'
                ]);

                const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${(c || '').replace(/"/g, '""')}"`).join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `plexus-registrations-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            },

            openManualRegistration() {
                alert('Manual registration form coming soon. For now, registrations are created through the public registration flow.');
            },

            viewRegistration(id) {
                const reg = this.plexusRegistrations.find(r => r.id === id);
                if (reg) {
                    alert(`Registration Details:\n\nName: ${reg.first_name} ${reg.last_name}\nEmail: ${reg.email}\nInstitution: ${reg.institution || 'N/A'}\nTicket: ${reg.ticket_type}\nStatus: ${reg.status}\nPayment: ${reg.payment_status}`);
                }
            },

            editRegistration(id) {
                alert('Edit registration form coming soon.');
            },

            // Abstract state for sorting/grouping
            pxAbsSortCol: null,
            pxAbsSortDir: 'asc',
            pxAbsGroupBy: 'none',
            pxAbsFiltered: [],

            async loadPlexusAbstracts() {
                try {
                    const abstracts = await this.api('/api/admin/plexus/abstracts');
                    this.plexusAbstracts = abstracts;
                    this.populateAbsFilterDropdowns(abstracts);
                    this.pxAbsSortCol = null;
                    this.pxAbsSortDir = 'asc';
                    this.pxAbsGroupBy = 'none';
                    this.filterPlexusAbstracts();
                } catch (err) {
                    console.error('Failed to load abstracts:', err);
                }
            },

            populateAbsFilterDropdowns(abstracts) {
                const categories = [...new Set(abstracts.map(a => a.category).filter(Boolean))].sort();
                const catSelect = document.getElementById('pxAbsCategoryFilter');
                if (catSelect) {
                    catSelect.innerHTML = '<option value="">All Categories</option>' +
                        categories.map(c => `<option value="${this.escapeHtml(c)}">${this.escapeHtml(c)}</option>`).join('');
                }
            },

            renderPlexusAbstracts(abstracts) {
                const tbody = document.getElementById('pxAbsTableBody');
                const table = document.getElementById('pxAbsTable');
                const groupedContainer = document.getElementById('pxAbsGroupedContainer');
                if (!tbody || !table || !groupedContainer) return;

                if (!abstracts || abstracts.length === 0) {
                    groupedContainer.innerHTML = '';
                    groupedContainer.style.display = 'none';
                    table.style.display = '';
                    tbody.innerHTML = '<tr><td colspan="7" class="table-empty"><i class="fas fa-file-alt"></i><p>No abstract submissions yet</p></td></tr>';
                    return;
                }

                if (this.pxAbsGroupBy !== 'none') {
                    table.style.display = 'none';
                    groupedContainer.style.display = '';
                    const groups = {};
                    abstracts.forEach(a => {
                        const key = a[this.pxAbsGroupBy] || 'Unknown';
                        if (!groups[key]) groups[key] = [];
                        groups[key].push(a);
                    });
                    const sortedKeys = Object.keys(groups).sort();
                    groupedContainer.innerHTML = sortedKeys.map(key => `
                        <div class="px-group-section">
                            <div class="px-group-header" onclick="this.classList.toggle('collapsed'); this.nextElementSibling.classList.toggle('collapsed');">
                                <div>
                                    <span class="px-group-header-title">${this.escapeHtml(key)}</span>
                                    <span class="px-group-header-count">${groups[key].length}</span>
                                    <i class="fas fa-chevron-down px-chevron"></i>
                                </div>
                            </div>
                            <div class="px-group-body">
                                <table class="data-table" style="margin: 0;">
                                    <thead>
                                        <tr><th>Title</th><th>Submitter</th><th>Type</th><th>Category</th><th>Status</th><th>Reviews</th><th>Actions</th></tr>
                                    </thead>
                                    <tbody>${groups[key].map(a => this.renderAbsRow(a)).join('')}</tbody>
                                </table>
                            </div>
                        </div>
                    `).join('');
                } else {
                    groupedContainer.style.display = 'none';
                    groupedContainer.innerHTML = '';
                    table.style.display = '';
                    tbody.innerHTML = abstracts.map(a => this.renderAbsRow(a)).join('');
                }
            },

            renderAbsRow(a) {
                return `<tr>
                    <td><strong>${this.escapeHtml(a.title || 'Untitled')}</strong></td>
                    <td>${this.escapeHtml(a.submitter_name || a.email || '-')}</td>
                    <td>${a.type || 'Poster'}</td>
                    <td>${a.category || '-'}</td>
                    <td><span class="status ${a.status === 'accepted' ? 'paid' : a.status === 'rejected' ? 'cancelled' : 'pending'}">${a.status || 'Submitted'}</span></td>
                    <td>${a.review_count || 0} / 3</td>
                    <td class="actions">
                        <button onclick="App.viewAbstract('${a.id}')" title="View"><i class="fas fa-eye"></i></button>
                        <button onclick="App.reviewAbstract('${a.id}')" title="Review"><i class="fas fa-clipboard-check"></i></button>
                    </td>
                </tr>`;
            },

            filterPlexusAbstracts() {
                const search = (document.getElementById('pxAbsSearch')?.value || '').toLowerCase();
                const statusFilter = document.getElementById('pxAbsStatusFilter')?.value || '';
                const typeFilter = document.getElementById('pxAbsTypeFilter')?.value || '';
                const categoryFilter = document.getElementById('pxAbsCategoryFilter')?.value || '';

                let filtered = this.plexusAbstracts.filter(a => {
                    const matchSearch = !search ||
                        (a.title && a.title.toLowerCase().includes(search)) ||
                        (a.submitter_name && a.submitter_name.toLowerCase().includes(search)) ||
                        (a.email && a.email.toLowerCase().includes(search));
                    const matchStatus = !statusFilter || a.status === statusFilter;
                    const matchType = !typeFilter || a.type === typeFilter;
                    const matchCategory = !categoryFilter || a.category === categoryFilter;
                    return matchSearch && matchStatus && matchType && matchCategory;
                });

                if (this.pxAbsSortCol) {
                    filtered = this.applySortAbs(filtered);
                }

                this.pxAbsFiltered = filtered;
                this.renderPlexusAbstracts(filtered);
            },

            clearAbsFilters() {
                const ids = ['pxAbsSearch', 'pxAbsStatusFilter', 'pxAbsTypeFilter', 'pxAbsCategoryFilter'];
                ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
                this.filterPlexusAbstracts();
            },

            sortPlexusAbstracts(col) {
                if (this.pxAbsSortCol === col) {
                    this.pxAbsSortDir = this.pxAbsSortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    this.pxAbsSortCol = col;
                    this.pxAbsSortDir = 'asc';
                }
                document.querySelectorAll('[id^="pxAbsSort-"]').forEach(el => el.textContent = '');
                const icon = document.getElementById(`pxAbsSort-${col}`);
                if (icon) icon.textContent = this.pxAbsSortDir === 'asc' ? ' \u2191' : ' \u2193';

                this.filterPlexusAbstracts();
            },

            applySortAbs(arr) {
                const col = this.pxAbsSortCol;
                const dir = this.pxAbsSortDir === 'asc' ? 1 : -1;
                return [...arr].sort((a, b) => {
                    let va, vb;
                    if (col === 'submitter') {
                        va = (a.submitter_name || a.email || '').toLowerCase();
                        vb = (b.submitter_name || b.email || '').toLowerCase();
                    } else {
                        va = (a[col] || '').toString().toLowerCase();
                        vb = (b[col] || '').toString().toLowerCase();
                    }
                    if (va < vb) return -1 * dir;
                    if (va > vb) return 1 * dir;
                    return 0;
                });
            },

            groupPlexusAbstracts(groupBy) {
                this.pxAbsGroupBy = groupBy;
                document.querySelectorAll('#plexus-abstracts .px-group-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.group === groupBy);
                });
                this.filterPlexusAbstracts();
            },

            exportPlexusAbstracts() {
                const data = this.pxAbsFiltered && this.pxAbsFiltered.length > 0 ? this.pxAbsFiltered : this.plexusAbstracts;
                if (!data || data.length === 0) {
                    Toast.warning('No abstracts to export');
                    return;
                }

                const headers = ['Title', 'Submitter Name', 'Submitter Email', 'Type', 'Category', 'Status', 'Decision', 'Average Score'];
                const rows = data.map(a => [
                    a.title || '', a.submitter_name || '', a.email || '', a.type || 'Poster',
                    a.category || '', a.status || '', a.decision || '',
                    a.average_score != null ? a.average_score : ''
                ]);

                const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${(c || '').toString().replace(/"/g, '""')}"`).join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `plexus-abstracts-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            },

            viewAbstract(id) {
                const abs = this.plexusAbstracts.find(a => a.id === id);
                if (abs) {
                    alert(`Abstract: ${abs.title}\n\nType: ${abs.type}\nCategory: ${abs.category}\nStatus: ${abs.status}\n\nAbstract text preview coming soon.`);
                }
            },

            reviewAbstract(id) {
                alert('Abstract review panel coming soon.');
            },

            // Phase 3C: Schedule Builder — Calendar Grid
            editingSessionId: null,

            async loadPlexusSchedule() {
                try {
                    const sessions = await this.api('/api/admin/plexus/sessions');
                    this.plexusSessions = sessions || [];
                    this.renderScheduleGrid();
                } catch (err) {
                    console.error('Failed to load schedule:', err);
                    try {
                        const data = await this.api('/api/plexus/schedule');
                        this.plexusSessions = data.sessions || data || [];
                        this.renderScheduleGrid();
                    } catch (e) { console.error('Schedule fallback failed:', e); }
                }
            },

            showScheduleDay(day) {
                this.plexusScheduleDay = day;
                document.querySelectorAll('.schedule-day-btn').forEach((btn, i) => {
                    btn.classList.toggle('active', i + 1 === day);
                });
                this.renderScheduleGrid();
            },

            _getSessionTypeColor(type) {
                const colors = { keynote: '#a78bfa', panel: '#22d3ee', workshop: '#fb923c', poster_session: '#f472b6', break: 'rgba(255,255,255,0.3)', networking: '#10b981', talk: '#c9a962' };
                return colors[type] || '#c9a962';
            },

            _timeToMinutes(timeStr) {
                if (!timeStr) return 0;
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + (m || 0);
            },

            _minutesToTime(mins) {
                const h = Math.floor(mins / 60);
                const m = mins % 60;
                return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            },

            renderScheduleGrid() {
                const wrapper = document.getElementById('pxScheduleGridWrapper');
                if (!wrapper) return;

                const day = this.plexusScheduleDay || 1;
                const daySessions = this.plexusSessions.filter(s => (s.day || 1) == day);

                if (daySessions.length === 0) {
                    wrapper.innerHTML = `
                        <div class="table-empty">
                            <i class="fas fa-calendar-plus" style="font-size: 32px; color: var(--plexus); margin-bottom: 12px;"></i>
                            <p>No sessions scheduled for Day ${day}</p>
                            <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Click "Add Session" to create your first session</p>
                            <button class="btn btn-primary" style="margin-top: 12px;" onclick="App.openSessionModal()">
                                <i class="fas fa-plus"></i> Add Session
                            </button>
                        </div>`;
                    return;
                }

                // Determine rooms from sessions
                const defaultRooms = ['Main Hall', 'Room A', 'Room B', 'Workshop Room'];
                const sessionRooms = [...new Set(daySessions.map(s => s.room).filter(Boolean))];
                const rooms = sessionRooms.length > 0 ? sessionRooms : defaultRooms;

                // Time grid config
                const startHour = 8;
                const endHour = 20;
                const slotMinutes = 30;
                const totalSlots = (endHour - startHour) * 60 / slotMinutes;
                const slotHeight = 30;
                const headerHeight = 40;

                const roomColWidth = Math.max(140, Math.floor(800 / rooms.length));
                const timeLabelWidth = 60;

                let html = `<div class="schedule-grid-container" style="grid-template-columns: ${timeLabelWidth}px repeat(${rooms.length}, minmax(${roomColWidth}px, 1fr)); position: relative;">`;

                // Header row
                html += `<div class="schedule-grid-header-cell" style="grid-column: 1; grid-row: 1;"></div>`;
                rooms.forEach((room, i) => {
                    html += `<div class="schedule-grid-header-cell" style="grid-column: ${i + 2}; grid-row: 1;">${this.escapeHtml(room)}</div>`;
                });

                // Time slot rows
                for (let slot = 0; slot < totalSlots; slot++) {
                    const mins = startHour * 60 + slot * slotMinutes;
                    const isHour = mins % 60 === 0;
                    const timeLabel = isHour ? this._minutesToTime(mins) : '';
                    const row = slot + 2;

                    html += `<div class="schedule-grid-time-label ${isHour ? 'hour-mark' : ''}" style="grid-column: 1; grid-row: ${row}; height: ${slotHeight}px; line-height: ${slotHeight}px;">${timeLabel}</div>`;

                    rooms.forEach((room, ri) => {
                        const cellTime = this._minutesToTime(mins);
                        html += `<div class="schedule-grid-cell ${isHour ? 'hour-mark' : ''}" style="grid-column: ${ri + 2}; grid-row: ${row}; height: ${slotHeight}px;"
                            onclick="App.openSessionModal(null, ${day}, '${cellTime}', '${this.escapeHtml(room)}')"></div>`;
                    });
                }

                html += '</div>';

                // Wrap in a relative container for absolute session blocks
                html = `<div style="position: relative; overflow-x: auto;">` + html;

                // Position session blocks
                daySessions.forEach(s => {
                    const startMins = this._timeToMinutes(s.start_time);
                    const endMins = this._timeToMinutes(s.end_time);
                    if (!s.start_time || !s.end_time) return;

                    const roomIdx = rooms.indexOf(s.room);
                    if (roomIdx === -1) return;

                    const topOffset = headerHeight + ((startMins - startHour * 60) / slotMinutes) * slotHeight;
                    const blockHeight = Math.max(slotHeight, ((endMins - startMins) / slotMinutes) * slotHeight);
                    const colStart = timeLabelWidth + roomIdx * roomColWidth;
                    const colWidth = roomColWidth;

                    const typeClass = 'type-' + (s.session_type || 'talk');
                    const unpubClass = s.is_published ? '' : ' unpublished';
                    const speakerText = s.speaker_names ? s.speaker_names.replace(/,/g, ', ') : '';

                    html += `<div class="schedule-session-block ${typeClass}${unpubClass}"
                        style="top: ${topOffset}px; left: ${colStart + 2}px; width: ${colWidth - 6}px; height: ${blockHeight - 2}px;"
                        onclick="event.stopPropagation(); App.openSessionModal('${s.id}')"
                        title="${this.escapeHtml(s.title || '')} | ${s.start_time} - ${s.end_time}${speakerText ? ' | ' + speakerText : ''}">
                        <div class="session-block-title">${this.escapeHtml(s.title || 'Untitled')}</div>
                        <div class="session-block-time">${s.start_time} - ${s.end_time}</div>
                        ${speakerText ? `<div class="session-block-speaker">${this.escapeHtml(speakerText)}</div>` : ''}
                        <div class="session-block-badges">
                            ${s.is_published ? '<span class="session-block-badge" style="background: rgba(34,197,94,0.3); color: #86efac;">LIVE</span>' : ''}
                        </div>
                    </div>`;
                });

                html += '</div>';
                wrapper.innerHTML = html;
            },

            openSessionModal(sessionId, preDay, preTime, preRoom) {
                this.editingSessionId = sessionId || null;
                const modal = document.getElementById('sessionModal');
                const titleEl = document.getElementById('sessionModalTitle');

                // Populate speaker dropdown
                const speakerSelect = document.getElementById('sessionSpeakers');
                speakerSelect.innerHTML = (this.plexusSpeakers || []).map(s =>
                    `<option value="${s.id}">${this.escapeHtml(s.name || 'Unknown')}</option>`
                ).join('');

                // Populate room suggestions
                const roomList = document.getElementById('roomSuggestions');
                const existingRooms = [...new Set((this.plexusSessions || []).map(s => s.room).filter(Boolean))];
                const allRooms = [...new Set([...existingRooms, 'Main Hall', 'Room A', 'Room B', 'Workshop Room'])];
                roomList.innerHTML = allRooms.map(r => `<option value="${r}">`).join('');

                if (sessionId) {
                    // Edit mode
                    const s = this.plexusSessions.find(x => x.id === sessionId);
                    if (!s) return;
                    titleEl.textContent = 'Edit Session';
                    document.getElementById('sessionTitle').value = s.title || '';
                    document.getElementById('sessionType').value = s.session_type || 'talk';
                    document.getElementById('sessionDay').value = s.day || 1;
                    document.getElementById('sessionStartTime').value = s.start_time || '';
                    document.getElementById('sessionEndTime').value = s.end_time || '';
                    document.getElementById('sessionRoom').value = s.room || '';
                    document.getElementById('sessionCapacity').value = s.capacity || '';
                    document.getElementById('sessionDescription').value = s.description || '';
                    document.getElementById('sessionPublished').checked = !!s.is_published;
                    if (s.speaker_ids) {
                        const ids = s.speaker_ids.split(',').map(x => x.trim());
                        Array.from(speakerSelect.options).forEach(opt => { opt.selected = ids.includes(opt.value); });
                    }
                } else {
                    // Create mode
                    titleEl.textContent = 'Add Session';
                    document.getElementById('sessionTitle').value = '';
                    document.getElementById('sessionType').value = 'keynote';
                    document.getElementById('sessionDay').value = preDay || this.plexusScheduleDay || 1;
                    document.getElementById('sessionStartTime').value = preTime || '09:00';
                    document.getElementById('sessionEndTime').value = preTime ? this._minutesToTime(this._timeToMinutes(preTime) + 60) : '10:00';
                    document.getElementById('sessionRoom').value = preRoom || 'Main Hall';
                    document.getElementById('sessionCapacity').value = '';
                    document.getElementById('sessionDescription').value = '';
                    document.getElementById('sessionPublished').checked = false;
                    Array.from(speakerSelect.options).forEach(opt => opt.selected = false);
                }

                modal.classList.add('active');
            },

            async saveSession() {
                const title = document.getElementById('sessionTitle').value.trim();
                if (!title) { Toast.warning('Title is required'); return; }
                const startTime = document.getElementById('sessionStartTime').value;
                const endTime = document.getElementById('sessionEndTime').value;
                if (!startTime || !endTime) { Toast.warning('Start and end times are required'); return; }

                const speakerSelect = document.getElementById('sessionSpeakers');
                const selectedSpeakerIds = Array.from(speakerSelect.selectedOptions).map(o => o.value);

                const data = {
                    title,
                    session_type: document.getElementById('sessionType').value,
                    day: parseInt(document.getElementById('sessionDay').value),
                    start_time: startTime,
                    end_time: endTime,
                    room: document.getElementById('sessionRoom').value.trim() || 'Main Hall',
                    capacity: parseInt(document.getElementById('sessionCapacity').value) || null,
                    description: document.getElementById('sessionDescription').value.trim(),
                    is_published: document.getElementById('sessionPublished').checked ? 1 : 0,
                    speaker_ids: selectedSpeakerIds.length > 0 ? selectedSpeakerIds : null
                };

                try {
                    if (this.editingSessionId) {
                        await this.api(`/api/admin/plexus/sessions/${this.editingSessionId}`, { method: 'PUT', body: JSON.stringify(data) });
                    } else {
                        await this.api('/api/admin/plexus/sessions', { method: 'POST', body: JSON.stringify(data) });
                    }
                    this.closeModal('sessionModal');
                    await this.loadPlexusSchedule();
                    Toast.success(this.editingSessionId ? 'Session updated' : 'Session created');
                } catch (err) {
                    console.error('Failed to save session:', err);
                    Toast.error('Failed to save session: ' + err.message);
                }
            },

            async deleteSession(id) {
                if (!confirm('Delete this session? This cannot be undone.')) return;
                try {
                    await this.api(`/api/admin/plexus/sessions/${id}`, { method: 'DELETE' });
                    await this.loadPlexusSchedule();
                    Toast.success('Session deleted');
                } catch (err) {
                    console.error('Failed to delete session:', err);
                    Toast.error('Failed to delete session');
                }
            },

            async publishSession(id) {
                try {
                    await this.api(`/api/admin/plexus/sessions/${id}/publish`, { method: 'PUT' });
                    await this.loadPlexusSchedule();
                    Toast.success('Session published');
                } catch (err) {
                    console.error('Failed to publish session:', err);
                }
            },

            async bulkPublishSessions() {
                const unpublished = (this.plexusSessions || []).filter(s => !s.is_published);
                if (unpublished.length === 0) { Toast.success('All sessions are already published'); return; }
                if (!confirm(`Publish ${unpublished.length} unpublished session(s)? Users will be notified.`)) return;
                try {
                    const result = await this.api('/api/admin/plexus/sessions/bulk-publish', {
                        method: 'POST', body: JSON.stringify({ session_ids: unpublished.map(s => s.id) })
                    });
                    await this.loadPlexusSchedule();
                    Toast.success(`${result.published || unpublished.length} session(s) published`);
                } catch (err) {
                    console.error('Failed to bulk publish:', err);
                    Toast.error('Failed to publish sessions');
                }
            },

            // Speaker selection tracking for bulk actions
            selectedSpeakerIds: new Set(),

            async loadPlexusSpeakers() {
                showSkeleton('pxSpeakersGrid', 'grid', 4);
                try {
                    const year = document.getElementById('pxSpeakerYearFilter')?.value || 'all';
                    const url = year && year !== 'all' ? `/api/admin/plexus/speakers?year=${year}` : '/api/admin/plexus/speakers';
                    const speakers = await this.api(url) || [];
                    this.plexusSpeakers = speakers;
                    await this.loadSpeakerDocSummary();
                    this.loadSpeakerYears();
                    this.renderPlexusSpeakers();
                } catch (err) {
                    console.error('Failed to load speakers:', err);
                }
            },

            async loadSpeakerYears() {
                try {
                    const years = await this.api('/api/admin/plexus/speakers/years') || [];
                    const select = document.getElementById('pxSpeakerYearFilter');
                    if (!select) return;
                    const currentVal = select.value;
                    let options = '<option value="all">All Years</option>';
                    const allYears = new Set([2026, 2025, 2024, ...years]);
                    [...allYears].sort((a, b) => b - a).forEach(y => {
                        options += `<option value="${y}" ${String(y) === currentVal ? 'selected' : ''}>${y}</option>`;
                    });
                    select.innerHTML = options;
                } catch (e) { /* silent */ }
            },

            filterSpeakers() {
                this.renderPlexusSpeakers();
            },

            getFilteredSpeakers() {
                const search = (document.getElementById('pxSpeakerSearch')?.value || '').toLowerCase();
                const publishFilter = document.getElementById('pxSpeakerPublishFilter')?.value || '';
                return this.plexusSpeakers.filter(s => {
                    if (search) {
                        const haystack = `${s.name || ''} ${s.institution || ''} ${s.title || ''} ${s.talk_title || ''}`.toLowerCase();
                        if (!haystack.includes(search)) return false;
                    }
                    if (publishFilter === 'published' && !s.is_published) return false;
                    if (publishFilter === 'unpublished' && s.is_published) return false;
                    return true;
                });
            },

            renderPlexusSpeakers() {
                const container = document.getElementById('pxSpeakersGrid');
                if (!container) return;
                const filtered = this.getFilteredSpeakers();
                if (filtered.length === 0) {
                    container.innerHTML = `<div class="table-empty" style="grid-column: 1/-1;"><i class="fas fa-microphone"></i><p>${this.plexusSpeakers.length === 0 ? 'No speakers added yet' : 'No speakers match your filters'}</p><button class="btn btn-primary" style="margin-top: 12px;" onclick="App.openSpeakerModal()"><i class="fas fa-plus"></i> Add Speaker</button></div>`;
                    return;
                }
                const getStatusBadge = (status) => {
                    const colors = { confirmed: { bg: 'rgba(34,197,94,0.15)', color: '#22c55e', icon: 'fa-check-circle', text: 'Confirmed' }, pending: { bg: 'rgba(245,158,11,0.15)', color: '#f59e0b', icon: 'fa-clock', text: 'Pending' }, declined: { bg: 'rgba(239,68,68,0.15)', color: '#ef4444', icon: 'fa-times-circle', text: 'Declined' } };
                    const s = colors[status] || colors.pending;
                    return `<span style="background:${s.bg};color:${s.color};padding:3px 8px;border-radius:4px;font-size:10px;font-weight:500;"><i class="fas ${s.icon}" style="margin-right:4px;"></i>${s.text}</span>`;
                };
                const getBookingBadge = (status, type) => {
                    const colors = { booked: { bg: 'rgba(34,197,94,0.15)', color: '#22c55e', icon: 'fa-check' }, pending: { bg: 'rgba(245,158,11,0.15)', color: '#f59e0b', icon: 'fa-clock' }, not_booked: { bg: 'rgba(107,114,128,0.15)', color: '#6b7280', icon: 'fa-minus' }, not_needed: { bg: 'rgba(107,114,128,0.1)', color: '#9ca3af', icon: 'fa-ban' } };
                    const s = colors[status] || colors.not_booked;
                    const icon = type === 'flight' ? 'fa-plane' : 'fa-hotel';
                    return `<span style="background:${s.bg};color:${s.color};padding:2px 6px;border-radius:4px;font-size:10px;" title="${type}: ${status}"><i class="fas ${icon}" style="margin-right:3px;"></i><i class="fas ${s.icon}" style="font-size:8px;"></i></span>`;
                };
                const getInviteBadge = (status) => {
                    const colors = { unsent: { bg: 'rgba(107,114,128,0.15)', color: '#6b7280', text: 'Not Invited' }, sent: { bg: 'rgba(59,130,246,0.15)', color: '#3b82f6', text: 'Invited' }, responded: { bg: 'rgba(34,197,94,0.15)', color: '#22c55e', text: 'Responded' } };
                    const s = colors[status] || colors.unsent;
                    return `<span style="background:${s.bg};color:${s.color};padding:2px 6px;border-radius:4px;font-size:9px;">${s.text}</span>`;
                };
                const getAssigneeName = (teamMemberId) => { if (!teamMemberId) return null; const member = this.teamMembers.find(m => m.id === teamMemberId); return member ? member.name.split(' ')[0] : null; };

                container.innerHTML = filtered.map(s => {
                    const initials = (s.name || 'S').split(' ').map(n => n[0]).join('').substring(0, 2);
                    const confirmStatus = s.confirmation_status || 'pending';
                    const flightStatus = s.flight_status || 'not_booked';
                    const hotelStatus = s.hotel_status || 'not_booked';
                    const flightAssignee = getAssigneeName(s.flight_assigned_to);
                    const hotelAssignee = getAssigneeName(s.hotel_assigned_to);
                    const isPublished = s.is_published ? true : false;
                    const inviteStatus = s.invitation_status || 'unsent';
                    const isSelected = this.selectedSpeakerIds.has(s.id);
                    return `<div class="speaker-card" style="cursor:pointer;position:relative;${isSelected ? 'border:2px solid var(--accent-gold);box-shadow:0 0 12px rgba(201,169,98,0.3);' : ''}" onclick="App.openSpeakerDetailModal('${s.id}')">
                        <div style="position:absolute;top:6px;left:8px;right:8px;display:flex;justify-content:space-between;align-items:center;">
                            <label onclick="event.stopPropagation();" style="cursor:pointer;"><input type="checkbox" ${isSelected ? 'checked' : ''} onchange="App.toggleSpeakerSelect('${s.id}',this.checked)" style="cursor:pointer;"></label>
                            <div style="display:flex;gap:4px;align-items:center;">
                                ${s.is_keynote ? '<span style="background:var(--accent-gold);color:var(--bg-primary);padding:2px 6px;border-radius:4px;font-size:9px;font-weight:600;">KEYNOTE</span>' : ''}
                                <span style="background:${isPublished ? 'rgba(34,197,94,0.15)' : 'rgba(107,114,128,0.15)'};color:${isPublished ? '#22c55e' : '#6b7280'};padding:2px 6px;border-radius:4px;font-size:9px;"><i class="fas ${isPublished ? 'fa-eye' : 'fa-eye-slash'}" style="margin-right:3px;"></i>${isPublished ? 'Published' : 'Draft'}</span>
                            </div>
                        </div>
                        <div style="margin-top:16px;"><div class="speaker-avatar">${initials}</div></div>
                        <div class="speaker-name">${this.escapeHtml(s.name || 'Unknown')}</div>
                        <div class="speaker-title">${this.escapeHtml(s.title || '')}</div>
                        <div class="speaker-org">${this.escapeHtml(s.institution || s.organization || '')}</div>
                        ${s.talk_title ? `<div style="font-size:11px;color:var(--plexus);margin-top:4px;font-style:italic;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:100%;" title="${this.escapeHtml(s.talk_title)}">${this.escapeHtml(s.talk_title)}</div>` : ''}
                        ${s.year ? `<div style="font-size:10px;color:var(--text-muted);margin-top:2px;">${s.year}</div>` : ''}
                        <div style="margin-top:8px;display:flex;gap:4px;justify-content:center;flex-wrap:wrap;">${getStatusBadge(confirmStatus)} ${getInviteBadge(inviteStatus)}</div>
                        <div style="margin-top:6px;display:flex;gap:6px;justify-content:center;align-items:center;">${getBookingBadge(flightStatus, 'flight')} ${getBookingBadge(hotelStatus, 'hotel')}</div>
                        ${this.getSpeakerDocBadges(s.id)}
                        ${(flightAssignee || hotelAssignee) ? `<div style="margin-top:6px;font-size:10px;color:var(--text-muted);">Assigned: ${[flightAssignee, hotelAssignee].filter(x=>x).join(', ')}</div>` : ''}
                        <div style="margin-top:8px;display:flex;gap:4px;justify-content:center;" onclick="event.stopPropagation();">
                            <button class="btn" style="padding:4px 8px;font-size:11px;" onclick="App.openSpeakerDetailModal('${s.id}')" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn" style="padding:4px 8px;font-size:11px;${isPublished ? 'color:#22c55e;' : ''}" onclick="App.toggleSpeakerPublish('${s.id}',${isPublished ? 0 : 1})" title="${isPublished ? 'Unpublish' : 'Publish'}"><i class="fas ${isPublished ? 'fa-eye-slash' : 'fa-eye'}"></i></button>
                            <button class="btn" style="padding:4px 8px;font-size:11px;color:var(--plexus);" onclick="App.notifySpeaker('${s.id}')" title="Push notification"><i class="fas fa-bell"></i></button>
                            <button class="btn" style="padding:4px 8px;font-size:11px;color:var(--accent-gold);" onclick="App.sendSpeakerInviteQuick('${s.id}')" title="Send invitation email"><i class="fas fa-envelope"></i></button>
                            <button class="btn" style="padding:4px 8px;font-size:11px;color:#ef4444;" onclick="App.deleteSpeaker('${s.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                }).join('');
            },

            toggleSpeakerSelect(speakerId, checked) {
                if (checked) { this.selectedSpeakerIds.add(speakerId); } else { this.selectedSpeakerIds.delete(speakerId); }
                const btn = document.getElementById('pxSpeakerInviteBtn');
                const count = document.getElementById('pxSpeakerSelectedCount');
                if (btn) btn.style.display = this.selectedSpeakerIds.size > 0 ? '' : 'none';
                if (count) count.textContent = this.selectedSpeakerIds.size;
            },

            async toggleSpeakerPublish(speakerId, newVal) {
                try { await this.api(`/api/admin/plexus/speakers/${speakerId}/publish`, { method: 'PUT', body: JSON.stringify({ is_published: newVal }) }); await this.loadPlexusSpeakers(); } catch (err) { console.error('Failed to toggle publish:', err); Toast.error('Failed to update speaker visibility'); }
            },

            async notifySpeaker(speakerId) {
                const speaker = this.plexusSpeakers.find(s => s.id === speakerId);
                if (!speaker) return;
                if (!confirm(`Push notification about ${speaker.name} to all users?`)) return;
                try { await this.api(`/api/admin/plexus/speakers/${speakerId}/notify`, { method: 'POST' }); Toast.success('Notification sent to all users'); } catch (err) { console.error('Failed to send notification:', err); Toast.error('Failed to send notification'); }
            },

            sendQuickNotification(project, template) {
                const templates = {
                    'plexus-speaker': { title: 'New Speaker Announcement', body: 'A new speaker has been added to the Plexus Conference lineup. Check the schedule for details!', type: 'plexus', category: 'event', group: 'plexus', icon: 'fa-user-plus' },
                    'plexus-schedule': { title: 'Schedule Update', body: 'The Plexus Conference schedule has been updated. Please review the latest changes.', type: 'plexus', category: 'event', group: 'plexus', icon: 'fa-clock' },
                    'forum-event': { title: 'New Forum Event', body: 'A new event has been posted in the Biomedical Forum. Check it out!', type: 'forum', category: 'event', group: 'forum', icon: 'fa-calendar-check' },
                    'bridges-event': { title: 'Building Bridges Update', body: 'There is an update for Building Bridges. Check the latest details.', type: 'building-bridges', category: 'announcement', group: 'building-bridges', icon: 'fa-bullhorn' },
                };

                const tmpl = templates[template];
                if (!tmpl) { Toast.error('Unknown notification template'); return; }

                // Navigate to notifications section with pre-filled data
                this.showSection('user-notifications');

                // Pre-fill notification form after a short delay to let the section render
                setTimeout(() => {
                    UserNotifApp.showSendForm();
                    setTimeout(() => {
                        const titleInput = document.getElementById('notifTitle');
                        const bodyInput = document.getElementById('notifMessage');
                        const categorySelect = document.getElementById('notifCategory');
                        const groupSelect = document.getElementById('notifGroup');
                        const projectSelect = document.getElementById('notifProject');
                        const iconSelect = document.getElementById('notifIcon');

                        if (titleInput) titleInput.value = tmpl.title;
                        if (bodyInput) bodyInput.value = tmpl.body;
                        if (categorySelect) categorySelect.value = tmpl.category;
                        if (groupSelect) groupSelect.value = tmpl.group;
                        if (projectSelect) projectSelect.value = tmpl.type;
                        if (iconSelect) iconSelect.value = tmpl.icon;
                    }, 100);
                }, 300);
            },

            async sendSpeakerInviteQuick(speakerId) {
                const speaker = this.plexusSpeakers.find(s => s.id === speakerId);
                if (!speaker) return;
                if (!speaker.email) { Toast.warning('This speaker has no email address. Please edit the speaker and add their email first.'); return; }
                this.selectedSpeakerIds = new Set([speakerId]);
                this.openSpeakerInviteModal();
            },

            async reinviteSpeaker(speakerId) {
                const speaker = this.plexusSpeakers.find(s => s.id === speakerId);
                if (!speaker) return;
                const year = prompt('Re-invite for which year?', new Date().getFullYear());
                if (!year) return;
                try { await this.api(`/api/admin/plexus/speakers/${speakerId}/reinvite`, { method: 'POST', body: JSON.stringify({ year: parseInt(year) }) }); await this.loadPlexusSpeakers(); Toast.success(`${speaker.name} copied to ${year}`); } catch (err) { console.error('Failed to reinvite speaker:', err); Toast.error('Failed to re-invite speaker'); }
            },

            openSpeakerDetailModal(speakerId) {
                const speaker = this.plexusSpeakers.find(s => s.id === speakerId);
                if (!speaker) return;
                const teamOptions = this.teamMembers.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
                const yearOptions = [2024, 2025, 2026, 2027].map(y => `<option value="${y}" ${speaker.year == y ? 'selected' : ''}>${y}</option>`).join('');
                const typeOptions = ['keynote', 'invited', 'contributed', 'panel', 'workshop'].map(t => `<option value="${t}" ${speaker.speaker_type === t ? 'selected' : ''}>${t.charAt(0).toUpperCase() + t.slice(1)}</option>`).join('');
                const modalHtml = `
                    <div class="modal-overlay active" id="speakerDetailModal" onclick="if(event.target===this) this.remove();">
                        <div class="modal" style="max-width:680px;max-height:90vh;overflow-y:auto;">
                            <div class="modal-header"><h3>${this.escapeHtml(speaker.name)}</h3><button class="modal-close" onclick="document.getElementById('speakerDetailModal').remove()">&times;</button></div>
                            <div class="modal-body">
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                    <div class="form-group"><label>Name</label><input type="text" id="spkName" value="${this.escapeHtml(speaker.name || '')}"></div>
                                    <div class="form-group"><label>Title / Position</label><input type="text" id="spkTitle" value="${this.escapeHtml(speaker.title || '')}"></div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                    <div class="form-group"><label>Institution</label><input type="text" id="spkInstitution" value="${this.escapeHtml(speaker.institution || '')}"></div>
                                    <div class="form-group"><label>Email</label><input type="email" id="spkEmail" value="${this.escapeHtml(speaker.email || '')}" placeholder="speaker@example.com"></div>
                                </div>
                                <div class="form-group"><label>Bio</label><textarea id="spkBio" rows="3" placeholder="Speaker biography...">${speaker.bio || ''}</textarea></div>
                                <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px;">
                                    <div class="form-group"><label>Talk Title</label><input type="text" id="spkTalkTitle" value="${this.escapeHtml(speaker.talk_title || '')}"></div>
                                    <div class="form-group"><label>Invite Code</label><input type="text" id="spkInviteCode" value="${this.escapeHtml(speaker.invite_code || '')}" readonly style="color:var(--accent-gold);font-family:monospace;font-weight:600;"></div>
                                </div>
                                <div class="form-group"><label>Talk Abstract</label><textarea id="spkTalkAbstract" rows="3" placeholder="Talk abstract...">${speaker.talk_abstract || ''}</textarea></div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                    <div class="form-group"><label>Photo URL</label><input type="text" id="spkPhotoUrl" value="${this.escapeHtml(speaker.photo_url || '')}" placeholder="https://..."></div>
                                    <div class="form-group"><label>LinkedIn URL</label><input type="text" id="spkLinkedin" value="${this.escapeHtml(speaker.linkedin_url || '')}" placeholder="https://linkedin.com/in/..."></div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                    <div class="form-group"><label>Twitter URL</label><input type="text" id="spkTwitter" value="${this.escapeHtml(speaker.twitter_url || '')}" placeholder="https://twitter.com/..."></div>
                                    <div class="form-group"><label>Year</label><select id="spkYear">${yearOptions}</select></div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                                    <div class="form-group"><label>Speaker Type</label><select id="spkType">${typeOptions}</select></div>
                                    <div class="form-group" style="display:flex;align-items:center;gap:8px;padding-top:22px;"><input type="checkbox" id="spkKeynote" ${speaker.is_keynote ? 'checked' : ''}><label for="spkKeynote" style="margin:0;">Keynote</label></div>
                                    <div class="form-group" style="display:flex;align-items:center;gap:8px;padding-top:22px;"><input type="checkbox" id="spkPublished" ${speaker.is_published ? 'checked' : ''}><label for="spkPublished" style="margin:0;">Published</label></div>
                                </div>
                                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0;">
                                <h4 style="margin-bottom:12px;color:var(--text-primary);">Status &amp; Logistics</h4>
                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                                    <div class="form-group"><label>Confirmation</label><select id="spkConfirmStatus"><option value="pending" ${speaker.confirmation_status === 'pending' ? 'selected' : ''}>Pending</option><option value="confirmed" ${speaker.confirmation_status === 'confirmed' ? 'selected' : ''}>Confirmed</option><option value="declined" ${speaker.confirmation_status === 'declined' ? 'selected' : ''}>Declined</option></select></div>
                                    <div class="form-group"><label>Flight</label><select id="spkFlightStatus"><option value="not_booked" ${speaker.flight_status === 'not_booked' ? 'selected' : ''}>Not Booked</option><option value="pending" ${speaker.flight_status === 'pending' ? 'selected' : ''}>Pending</option><option value="booked" ${speaker.flight_status === 'booked' ? 'selected' : ''}>Booked</option><option value="not_needed" ${speaker.flight_status === 'not_needed' ? 'selected' : ''}>Not Needed</option></select></div>
                                    <div class="form-group"><label>Hotel</label><select id="spkHotelStatus"><option value="not_booked" ${speaker.hotel_status === 'not_booked' ? 'selected' : ''}>Not Booked</option><option value="pending" ${speaker.hotel_status === 'pending' ? 'selected' : ''}>Pending</option><option value="booked" ${speaker.hotel_status === 'booked' ? 'selected' : ''}>Booked</option><option value="not_needed" ${speaker.hotel_status === 'not_needed' ? 'selected' : ''}>Not Needed</option></select></div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                    <div class="form-group"><label>Flight Assigned To</label><select id="spkFlightAssigned"><option value="">-- Unassigned --</option>${teamOptions}</select></div>
                                    <div class="form-group"><label>Hotel Assigned To</label><select id="spkHotelAssigned"><option value="">-- Unassigned --</option>${teamOptions}</select></div>
                                </div>
                                <div class="form-group"><label>Flight Details</label><textarea id="spkFlightDetails" rows="2" placeholder="Flight number, times, etc.">${speaker.flight_details || ''}</textarea></div>
                                <div class="form-group"><label>Hotel Details</label><textarea id="spkHotelDetails" rows="2" placeholder="Hotel name, check-in/out, room, etc.">${speaker.hotel_details || ''}</textarea></div>
                                <div class="form-group"><label>Notes</label><textarea id="spkNotes" rows="2" placeholder="Any special requirements or notes...">${speaker.notes || ''}</textarea></div>
                                <hr style="border:none;border-top:1px solid var(--border);margin:16px 0;">
                                <h4 style="margin-bottom:12px;color:var(--text-primary);"><i class="fas fa-file-alt" style="margin-right:8px;"></i>Uploaded Documents</h4>
                                <div id="spkDocumentsList" style="min-height:40px;"><p style="color:var(--text-muted);font-size:13px;">Loading documents...</p></div>
                            </div>
                            <div class="modal-footer" style="flex-wrap:wrap;gap:6px;">
                                <button class="btn btn-danger" onclick="App.deleteSpeaker('${speaker.id}')" style="margin-right:auto;"><i class="fas fa-trash"></i></button>
                                <button class="btn btn-secondary" onclick="App.reinviteSpeaker('${speaker.id}')" title="Copy to new year"><i class="fas fa-redo"></i> Re-invite</button>
                                <button class="btn btn-secondary" onclick="App.sendSpeakerUploadLink('${speaker.id}')" title="Send upload link" style="background:rgba(201,169,98,0.15);color:var(--accent-gold);border:1px solid rgba(201,169,98,0.3);"><i class="fas fa-paper-plane"></i> Upload Link</button>
                                <button class="btn btn-secondary" onclick="document.getElementById('speakerDetailModal').remove()">Cancel</button>
                                <button class="btn btn-primary" onclick="App.saveSpeakerDetails('${speaker.id}')"><i class="fas fa-save"></i> Save</button>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                setTimeout(() => { const fa = document.getElementById('spkFlightAssigned'); const ha = document.getElementById('spkHotelAssigned'); if (fa) fa.value = speaker.flight_assigned_to || ''; if (ha) ha.value = speaker.hotel_assigned_to || ''; }, 0);
                this.loadSpeakerDocuments(speakerId).then(docs => {
                    const container = document.getElementById('spkDocumentsList');
                    if (!container) return;
                    if (!docs || docs.length === 0) { container.innerHTML = '<p style="color:var(--text-muted);font-size:13px;">No documents uploaded yet</p>'; return; }
                    const typeIcons = { presentation: 'fa-file-powerpoint', cv: 'fa-file-alt', photo: 'fa-image', 'bio-photo': 'fa-image', bio: 'fa-user', additional: 'fa-file' };
                    container.innerHTML = docs.map(d => `<div style="display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:6px;background:var(--bg-tertiary);margin-bottom:6px;"><i class="fas ${typeIcons[d.type] || 'fa-file'}" style="color:var(--accent);font-size:16px;"></i><div style="flex:1;"><div style="font-size:13px;font-weight:500;">${this.escapeHtml(d.original_name)}</div><div style="font-size:11px;color:var(--text-muted);">${d.type} &bull; ${d.file_size ? (d.file_size / 1024).toFixed(0) + ' KB' : ''} &bull; ${new Date(d.uploaded_at).toLocaleDateString()}</div></div><a href="/api/admin/plexus/speakers/${speakerId}/documents/${d.id}/download" class="btn btn-secondary" style="padding:4px 10px;font-size:12px;" title="Download"><i class="fas fa-download"></i></a></div>`).join('');
                });
            },

            async saveSpeakerDetails(speakerId) {
                const data = {
                    name: document.getElementById('spkName').value,
                    title: document.getElementById('spkTitle').value,
                    institution: document.getElementById('spkInstitution').value,
                    email: document.getElementById('spkEmail').value || null,
                    bio: document.getElementById('spkBio').value || null,
                    talk_title: document.getElementById('spkTalkTitle').value,
                    talk_abstract: document.getElementById('spkTalkAbstract').value || null,
                    photo_url: document.getElementById('spkPhotoUrl').value || null,
                    linkedin_url: document.getElementById('spkLinkedin').value || null,
                    twitter_url: document.getElementById('spkTwitter').value || null,
                    year: document.getElementById('spkYear').value || null,
                    speaker_type: document.getElementById('spkType').value,
                    is_keynote: document.getElementById('spkKeynote').checked,
                    is_published: document.getElementById('spkPublished').checked,
                    confirmation_status: document.getElementById('spkConfirmStatus').value,
                    flight_status: document.getElementById('spkFlightStatus').value,
                    hotel_status: document.getElementById('spkHotelStatus').value,
                    flight_assigned_to: document.getElementById('spkFlightAssigned').value || null,
                    hotel_assigned_to: document.getElementById('spkHotelAssigned').value || null,
                    flight_details: document.getElementById('spkFlightDetails').value,
                    hotel_details: document.getElementById('spkHotelDetails').value,
                    notes: document.getElementById('spkNotes').value
                };
                try {
                    await this.api(`/api/admin/plexus/speakers/${speakerId}`, { method: 'PUT', body: JSON.stringify(data) });
                    document.getElementById('speakerDetailModal').remove();
                    await this.loadPlexusSpeakers();
                } catch (err) { console.error('Failed to save speaker:', err); Toast.error('Failed to save speaker details'); }
            },

            async deleteSpeaker(speakerId) {
                if (!confirm('Delete this speaker?')) return;
                try { await this.api(`/api/admin/plexus/speakers/${speakerId}`, { method: 'DELETE' }); document.getElementById('speakerDetailModal')?.remove(); await this.loadPlexusSpeakers(); } catch (err) { console.error('Failed to delete speaker:', err); }
            },

            async sendSpeakerUploadLink(speakerId) {
                const emailInput = document.getElementById('spkEmail');
                if (emailInput) { const currentEmail = emailInput.value.trim(); if (currentEmail) { await this.api(`/api/admin/plexus/speakers/${speakerId}`, { method: 'PUT', body: JSON.stringify({ email: currentEmail }) }); } }
                try {
                    const result = await this.api(`/api/admin/plexus/speakers/${speakerId}/send-upload-link`, { method: 'POST' });
                    if (result.mock) { alert(`Email mocked (no SMTP configured)\n\nInvite Code: ${result.invite_code}\nCheck server console.`); } else { alert(`Upload link sent!\n\nInvite Code: ${result.invite_code}`); }
                    const codeInput = document.getElementById('spkInviteCode'); if (codeInput) codeInput.value = result.invite_code;
                } catch (err) { console.error('Failed to send upload link:', err); Toast.error(`Failed to send upload link: ${err.message}`); }
            },

            openSpeakerModal() {
                document.getElementById('newSpkName').value = '';
                document.getElementById('newSpkTitle').value = '';
                document.getElementById('newSpkInstitution').value = '';
                document.getElementById('newSpkEmail').value = '';
                document.getElementById('newSpkTalkTitle').value = '';
                document.getElementById('newSpkType').value = 'invited';
                document.getElementById('newSpkYear').value = '2026';
                document.getElementById('newSpkKeynote').checked = false;
                this.openModal('addSpeakerModal');
            },

            async submitNewSpeaker() {
                const name = document.getElementById('newSpkName').value.trim();
                if (!name) { Toast.warning('Name is required'); return; }
                const data = { name, title: document.getElementById('newSpkTitle').value || null, institution: document.getElementById('newSpkInstitution').value || null, email: document.getElementById('newSpkEmail').value || null, talk_title: document.getElementById('newSpkTalkTitle').value || null, speaker_type: document.getElementById('newSpkType').value, year: document.getElementById('newSpkYear').value, is_keynote: document.getElementById('newSpkKeynote').checked };
                try { await this.api('/api/admin/plexus/speakers', { method: 'POST', body: JSON.stringify(data) }); this.closeModal('addSpeakerModal'); await this.loadPlexusSpeakers(); } catch (err) { console.error('Failed to create speaker:', err); Toast.error('Failed to add speaker'); }
            },

            async createSpeaker(data) {
                try { await this.api('/api/admin/plexus/speakers', { method: 'POST', body: JSON.stringify(data) }); await this.loadPlexusSpeakers(); } catch (err) { console.error('Failed to create speaker:', err); Toast.error('Failed to add speaker'); }
            },

            openSpeakerImportModal() {
                const modal = document.getElementById('speakerImportModal');
                if (modal) { modal.style.display = 'flex'; document.getElementById('speakerImportPreview').innerHTML = ''; document.getElementById('speakerImportFile').value = ''; document.getElementById('speakerImportBtn').disabled = true; }
            },

            previewSpeakerImport() {
                const file = document.getElementById('speakerImportFile').files[0];
                const preview = document.getElementById('speakerImportPreview');
                const btn = document.getElementById('speakerImportBtn');
                if (!file) { preview.innerHTML = ''; btn.disabled = true; return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(l => l.trim());
                    if (lines.length < 2) { preview.innerHTML = '<p style="color:#ef4444;">File must have header + at least 1 data row</p>'; btn.disabled = true; return; }
                    const headers = lines[0].split(',').map(h => h.trim().replace(/['"]/g, ''));
                    const rows = [];
                    for (let i = 1; i < Math.min(lines.length, 11); i++) { const row = []; let current = '', inQ = false; for (const ch of lines[i]) { if (ch === '"') { inQ = !inQ; continue; } if (ch === ',' && !inQ) { row.push(current.trim()); current = ''; continue; } current += ch; } row.push(current.trim()); rows.push(row); }
                    let html = `<p style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Preview (${lines.length - 1} speakers found):</p><table class="data-table" style="font-size:11px;"><thead><tr>`;
                    headers.forEach(h => { html += `<th>${h}</th>`; });
                    html += '</tr></thead><tbody>';
                    rows.forEach(row => { html += '<tr>'; row.forEach(cell => { html += `<td>${cell || '-'}</td>`; }); html += '</tr>'; });
                    if (lines.length > 11) html += `<tr><td colspan="${headers.length}" style="text-align:center;color:var(--text-muted);">... and ${lines.length - 11} more</td></tr>`;
                    html += '</tbody></table>';
                    preview.innerHTML = html;
                    btn.disabled = false;
                };
                reader.readAsText(file);
            },

            async importSpeakers() {
                const file = document.getElementById('speakerImportFile').files[0];
                if (!file) return;
                const year = document.getElementById('speakerImportYear').value;
                const formData = new FormData();
                formData.append('file', file);
                formData.append('year', year);
                try {
                    const token = localStorage.getItem('token');
                    const res = await fetch('/api/admin/plexus/speakers/import', { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData });
                    const result = await res.json();
                    if (!res.ok) throw new Error(result.error || 'Import failed');
                    this.closeModal('speakerImportModal');
                    await this.loadPlexusSpeakers();
                    Toast.success(`Successfully imported ${result.imported} speakers`);
                } catch (err) { console.error('Import failed:', err); Toast.error(`Import failed: ${err.message}`); }
            },

            openSpeakerInviteModal() {
                const selected = [...this.selectedSpeakerIds];
                const speakers = selected.map(id => this.plexusSpeakers.find(s => s.id === id)).filter(Boolean);
                if (speakers.length === 0) { Toast.warning('No speakers selected. Use the checkboxes on speaker cards to select speakers.'); return; }
                const listHtml = speakers.map(s => `<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:var(--bg-tertiary);border-radius:6px;margin-bottom:4px;"><i class="fas fa-user" style="color:var(--plexus);"></i><span style="font-size:13px;font-weight:500;">${this.escapeHtml(s.name)}</span><span style="font-size:11px;color:var(--text-muted);">${s.email || 'No email'}</span>${!s.email ? '<span style="font-size:10px;color:#ef4444;margin-left:auto;">WILL BE SKIPPED</span>' : ''}</div>`).join('');
                document.getElementById('speakerInviteList').innerHTML = listHtml;
                const modal = document.getElementById('speakerInviteModal');
                if (modal) modal.style.display = 'flex';
            },

            async sendSpeakerInvitations() {
                const selected = [...this.selectedSpeakerIds];
                if (selected.length === 0) return;
                const subject = document.getElementById('speakerInviteSubject').value;
                const body = document.getElementById('speakerInviteBody').value;
                try {
                    const result = await this.api('/api/admin/plexus/speakers/invite', { method: 'POST', body: JSON.stringify({ speaker_ids: selected, subject, body }) });
                    this.closeModal('speakerInviteModal');
                    this.selectedSpeakerIds.clear();
                    const btn = document.getElementById('pxSpeakerInviteBtn'); if (btn) btn.style.display = 'none';
                    const sent = result.results.filter(r => r.status === 'sent').length;
                    const skipped = result.results.filter(r => r.status === 'skipped').length;
                    let msg = `Invitations sent to ${sent} speaker(s)`;
                    if (skipped) msg += `\n${skipped} skipped (no email)`;
                    if (result.results.some(r => r.mock)) msg += '\n\n(Emails mocked - no SMTP configured)';
                    alert(msg);
                    await this.loadPlexusSpeakers();
                } catch (err) { console.error('Failed to send invitations:', err); Toast.error('Failed to send invitations: ' + err.message); }
            },

            async loadPlexusSponsors() {
                showSkeleton('pxSponsorsGrid', 'grid', 4);
                try {
                    const sponsors = await this.api('/api/admin/plexus/sponsors') || [];
                    this.plexusSponsors = sponsors;
                    if (sponsors.length > 0) {
                        await Promise.all(sponsors.map(async (s) => {
                            try {
                                this.sponsorTasks[s.id] = await this.api(`/api/admin/plexus/sponsors/${s.id}/tasks`) || [];
                            } catch (e) { this.sponsorTasks[s.id] = []; }
                        }));
                    }
                    this.renderPlexusSponsors();
                } catch (err) {
                    console.error('Failed to load sponsors:', err);
                    this.plexusSponsors = [];
                    this.renderPlexusSponsors();
                }
            },

            renderSponsorStats() {
                const container = document.getElementById('pxSponsorStats');
                if (!container) return;
                const sponsors = this.plexusSponsors || [];
                const totalPledged = sponsors.reduce((sum, s) => sum + (parseFloat(s.amount_pledged) || 0), 0);
                const totalReceived = sponsors.reduce((sum, s) => sum + (parseFloat(s.amount_received) || 0), 0);
                const confirmed = sponsors.filter(s => s.status === 'confirmed' || s.status === 'fulfilled').length;
                const conversionRate = sponsors.length > 0 ? Math.round((confirmed / sponsors.length) * 100) : 0;

                container.innerHTML = `
                    <div class="sponsor-stat-card">
                        <div class="stat-value">${sponsors.length}</div>
                        <div class="stat-label">Total Sponsors</div>
                    </div>
                    <div class="sponsor-stat-card">
                        <div class="stat-value" style="color: var(--accent-gold);">&euro;${totalPledged.toLocaleString()}</div>
                        <div class="stat-label">Total Pledged</div>
                    </div>
                    <div class="sponsor-stat-card">
                        <div class="stat-value" style="color: var(--success);">&euro;${totalReceived.toLocaleString()}</div>
                        <div class="stat-label">Total Received</div>
                    </div>
                    <div class="sponsor-stat-card">
                        <div class="stat-value" style="color: var(--plexus);">${conversionRate}%</div>
                        <div class="stat-label">Conversion Rate</div>
                    </div>
                `;
            },

            renderSponsorPipeline() {
                const container = document.getElementById('pxSponsorPipeline');
                if (!container) return;
                const sponsors = this.plexusSponsors || [];
                const stages = [
                    { key: 'all', label: 'All' },
                    { key: 'prospect', label: 'Prospect' },
                    { key: 'contacted', label: 'Contacted' },
                    { key: 'negotiating', label: 'Negotiating' },
                    { key: 'confirmed', label: 'Confirmed' },
                    { key: 'fulfilled', label: 'Fulfilled' }
                ];

                container.innerHTML = stages.map((stage, i) => {
                    const count = stage.key === 'all' ? sponsors.length : sponsors.filter(s => (s.status || 'prospect') === stage.key).length;
                    const active = this.sponsorPipelineFilter === stage.key ? 'active' : '';
                    const arrow = i < stages.length - 1 && i > 0 ? '<span class="pipe-arrow"><i class="fas fa-chevron-right"></i></span>' : '';
                    return `
                        <div class="pipe-step ${active}" onclick="App.filterSponsorPipeline('${stage.key}')">
                            ${stage.label} <span class="pipe-count">${count}</span>
                        </div>
                        ${arrow}
                    `;
                }).join('');
            },

            filterSponsorPipeline(status) {
                this.sponsorPipelineFilter = status;
                this.renderPlexusSponsors();
            },

            renderPlexusSponsors() {
                this.renderSponsorStats();
                this.renderSponsorPipeline();

                const container = document.getElementById('pxSponsorsGrid');
                if (!container) return;

                let sponsors = this.plexusSponsors || [];
                if (this.sponsorPipelineFilter !== 'all') {
                    sponsors = sponsors.filter(s => (s.status || 'prospect') === this.sponsorPipelineFilter);
                }

                if (sponsors.length === 0 && this.plexusSponsors.length === 0) {
                    container.innerHTML = `
                        <div class="table-empty" style="grid-column: 1 / -1;">
                            <i class="fas fa-handshake"></i>
                            <p>No sponsors yet</p>
                            <button class="btn btn-primary" style="margin-top: 12px;" onclick="App.openSponsorModal()">
                                <i class="fas fa-plus"></i> Add Sponsor
                            </button>
                        </div>
                    `;
                    return;
                }

                if (sponsors.length === 0) {
                    container.innerHTML = `<p style="color: var(--text-muted); grid-column: 1 / -1; text-align: center; padding: 24px;">No sponsors in this stage</p>`;
                    return;
                }

                container.innerHTML = sponsors.map(s => {
                    const tier = (s.tier || 'partner').toLowerCase();
                    const status = (s.status || 'prospect').toLowerCase();
                    const pledged = parseFloat(s.amount_pledged) || 0;
                    const received = parseFloat(s.amount_received) || 0;
                    const progress = pledged > 0 ? Math.min(100, Math.round((received / pledged) * 100)) : 0;
                    const tasks = this.sponsorTasks[s.id] || [];
                    const completedTasks = tasks.filter(t => t.is_completed).length;
                    const initials = (s.name || '??').split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();

                    const logoHtml = s.logo_url
                        ? `<img src="${this.escapeHtml(s.logo_url)}" alt="${this.escapeHtml(s.name)}">`
                        : initials;

                    return `
                        <div class="sponsor-pipeline-card" data-sponsor-id="${s.id}">
                            <div class="sp-header">
                                <div class="sp-logo">${logoHtml}</div>
                                <div class="sp-info">
                                    <div class="sp-name">${s.website ? `<a href="${this.escapeHtml(s.website)}" target="_blank">${this.escapeHtml(s.name)}</a>` : this.escapeHtml(s.name)}</div>
                                    <div class="sp-badges">
                                        <span class="sp-tier-badge ${tier}">${tier}</span>
                                        <span class="sp-status-pill ${status}">${status}</span>
                                        ${s.is_published ? '<span style="font-size:10px; color: var(--success);"><i class="fas fa-globe"></i> Published</span>' : ''}
                                    </div>
                                </div>
                            </div>

                            ${s.contact_name || s.contact_email ? `
                                <div class="sp-contact">
                                    <i class="fas fa-user" style="font-size: 10px;"></i>
                                    ${this.escapeHtml(s.contact_name || '')}
                                    ${s.contact_email ? `<a href="mailto:${this.escapeHtml(s.contact_email)}">${this.escapeHtml(s.contact_email)}</a>` : ''}
                                </div>
                            ` : ''}

                            ${pledged > 0 || received > 0 ? `
                                <div class="sp-financial">
                                    <div class="sp-financial-row">
                                        <div>Pledged: <span>&euro;${pledged.toLocaleString()}</span></div>
                                        <div>Received: <span style="color: var(--success);">&euro;${received.toLocaleString()}</span></div>
                                    </div>
                                    <div class="sp-progress-bar">
                                        <div class="sp-progress-fill" style="width: ${progress}%;"></div>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="sp-tasks-section">
                                <div class="sp-tasks-toggle" onclick="this.nextElementSibling.classList.toggle('open'); this.querySelector('i').classList.toggle('fa-chevron-down'); this.querySelector('i').classList.toggle('fa-chevron-right');">
                                    <i class="fas fa-chevron-right" style="font-size: 9px;"></i>
                                    Tasks (${completedTasks}/${tasks.length})
                                </div>
                                <div class="sp-task-list" id="spTasks-${s.id}">
                                    ${tasks.map(t => `
                                        <div class="sp-task-item ${t.is_completed ? 'done' : ''}">
                                            <input type="checkbox" ${t.is_completed ? 'checked' : ''} onchange="App.toggleSponsorTask('${t.id}', this.checked)">
                                            <span>${this.escapeHtml(t.title)}</span>
                                            ${t.due_date ? `<span class="sp-task-due">${t.due_date}</span>` : ''}
                                            <button onclick="App.deleteSponsorTask('${t.id}', '${s.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:10px;margin-left:4px;" title="Delete"><i class="fas fa-times"></i></button>
                                        </div>
                                    `).join('')}
                                    <div class="sp-add-task">
                                        <input type="text" placeholder="Add task..." id="spNewTask-${s.id}" onkeypress="if(event.key==='Enter') App.addSponsorTask('${s.id}')">
                                        <button onclick="App.addSponsorTask('${s.id}')">Add</button>
                                    </div>
                                </div>
                            </div>

                            ${s.notes ? `
                                <div class="sp-notes-toggle" onclick="this.nextElementSibling.classList.toggle('open')">
                                    <i class="fas fa-sticky-note" style="margin-right: 4px;"></i> Notes
                                </div>
                                <div class="sp-notes-content">${this.escapeHtml(s.notes)}</div>
                            ` : ''}

                            <div class="sp-actions">
                                <button onclick="App.openSponsorModal('${s.id}')"><i class="fas fa-edit"></i> Edit</button>
                                ${s.is_published
                                    ? `<button class="sp-unpublish" onclick="App.toggleSponsorPublish('${s.id}', false)"><i class="fas fa-eye-slash"></i> Unpublish</button>`
                                    : `<button class="sp-publish" onclick="App.toggleSponsorPublish('${s.id}', true)"><i class="fas fa-globe"></i> Publish</button>`
                                }
                                <button class="sp-delete" onclick="App.deleteSponsor('${s.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            openSponsorModal(editId) {
                const sponsor = editId ? this.plexusSponsors.find(s => s.id === editId) : null;
                const isEdit = !!sponsor;

                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.id = 'sponsorEditModal';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                modal.innerHTML = `
                    <div class="modal" style="max-width: 560px;">
                        <div class="modal-header">
                            <h2>${isEdit ? 'Edit Sponsor' : 'Add Sponsor'}</h2>
                            <button class="modal-close" onclick="document.getElementById('sponsorEditModal').remove()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="modal-body" style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                            <div style="display: grid; gap: 14px;">
                                <div class="form-group">
                                    <label class="form-label">Company / Sponsor Name *</label>
                                    <input type="text" class="form-input" id="spFormName" value="${this.escapeHtml(sponsor?.name || '')}" placeholder="Company name">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                                    <div class="form-group">
                                        <label class="form-label">Tier</label>
                                        <select class="form-input" id="spFormTier">
                                            <option value="gold" ${sponsor?.tier === 'gold' ? 'selected' : ''}>Gold</option>
                                            <option value="silver" ${sponsor?.tier === 'silver' ? 'selected' : ''}>Silver</option>
                                            <option value="bronze" ${sponsor?.tier === 'bronze' ? 'selected' : ''}>Bronze</option>
                                            <option value="partner" ${(!sponsor || sponsor?.tier === 'partner') ? 'selected' : ''}>Partner</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Status</label>
                                        <select class="form-input" id="spFormStatus">
                                            <option value="prospect" ${(!sponsor || sponsor?.status === 'prospect') ? 'selected' : ''}>Prospect</option>
                                            <option value="contacted" ${sponsor?.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                                            <option value="negotiating" ${sponsor?.status === 'negotiating' ? 'selected' : ''}>Negotiating</option>
                                            <option value="confirmed" ${sponsor?.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                            <option value="fulfilled" ${sponsor?.status === 'fulfilled' ? 'selected' : ''}>Fulfilled</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                                    <div class="form-group">
                                        <label class="form-label">Logo URL</label>
                                        <input type="text" class="form-input" id="spFormLogo" value="${this.escapeHtml(sponsor?.logo_url || '')}" placeholder="https://...">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Website URL</label>
                                        <input type="text" class="form-input" id="spFormWebsite" value="${this.escapeHtml(sponsor?.website || '')}" placeholder="https://...">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                                    <div class="form-group">
                                        <label class="form-label">Contact Name</label>
                                        <input type="text" class="form-input" id="spFormContactName" value="${this.escapeHtml(sponsor?.contact_name || '')}" placeholder="John Smith">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Contact Email</label>
                                        <input type="email" class="form-input" id="spFormContactEmail" value="${this.escapeHtml(sponsor?.contact_email || '')}" placeholder="john@company.com">
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                                    <div class="form-group">
                                        <label class="form-label">Amount Pledged (&euro;)</label>
                                        <input type="number" class="form-input" id="spFormPledged" value="${sponsor?.amount_pledged || 0}" min="0" step="100">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Amount Received (&euro;)</label>
                                        <input type="number" class="form-input" id="spFormReceived" value="${sponsor?.amount_received || 0}" min="0" step="100">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-input" id="spFormDescription" rows="2" placeholder="Brief description...">${this.escapeHtml(sponsor?.description || '')}</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Internal Notes</label>
                                    <textarea class="form-input" id="spFormNotes" rows="2" placeholder="Internal notes...">${this.escapeHtml(sponsor?.notes || '')}</textarea>
                                </div>
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="spFormPublished" ${sponsor?.is_published ? 'checked' : ''} style="accent-color: var(--plexus);">
                                    <label for="spFormPublished" class="form-label" style="margin: 0;">Publish to public site</label>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 16px 20px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="document.getElementById('sponsorEditModal').remove()">Cancel</button>
                            <button class="btn btn-primary" onclick="App.saveSponsor('${editId || ''}')">${isEdit ? 'Save Changes' : 'Add Sponsor'}</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            async saveSponsor(editId) {
                const data = {
                    name: document.getElementById('spFormName').value.trim(),
                    tier: document.getElementById('spFormTier').value,
                    status: document.getElementById('spFormStatus').value,
                    logo_url: document.getElementById('spFormLogo').value.trim(),
                    website: document.getElementById('spFormWebsite').value.trim(),
                    contact_name: document.getElementById('spFormContactName').value.trim(),
                    contact_email: document.getElementById('spFormContactEmail').value.trim(),
                    amount_pledged: parseFloat(document.getElementById('spFormPledged').value) || 0,
                    amount_received: parseFloat(document.getElementById('spFormReceived').value) || 0,
                    description: document.getElementById('spFormDescription').value.trim(),
                    notes: document.getElementById('spFormNotes').value.trim(),
                    is_published: document.getElementById('spFormPublished').checked ? 1 : 0
                };

                if (!data.name) {
                    Toast.warning('Sponsor name is required');
                    return;
                }

                try {
                    if (editId) {
                        await this.api(`/api/admin/plexus/sponsors/${editId}`, {
                            method: 'PUT',
                            body: JSON.stringify(data)
                        });
                    } else {
                        await this.api('/api/admin/plexus/sponsors', {
                            method: 'POST',
                            body: JSON.stringify(data)
                        });
                    }
                    const modal = document.getElementById('sponsorEditModal');
                    if (modal) modal.remove();
                    await this.loadPlexusSponsors();
                } catch (err) {
                    console.error('Failed to save sponsor:', err);
                    Toast.error('Failed to save sponsor');
                }
            },

            async deleteSponsor(id) {
                if (!confirm('Delete this sponsor? This will also remove all associated tasks.')) return;
                try {
                    await this.api(`/api/admin/plexus/sponsors/${id}`, { method: 'DELETE' });
                    await this.loadPlexusSponsors();
                } catch (err) {
                    console.error('Failed to delete sponsor:', err);
                    Toast.error('Failed to delete sponsor');
                }
            },

            async toggleSponsorPublish(id, publish) {
                try {
                    await this.api(`/api/admin/plexus/sponsors/${id}/publish`, {
                        method: 'PUT',
                        body: JSON.stringify({ is_published: publish })
                    });
                    await this.loadPlexusSponsors();
                } catch (err) {
                    console.error('Failed to toggle publish:', err);
                }
            },

            async addSponsorTask(sponsorId) {
                const input = document.getElementById(`spNewTask-${sponsorId}`);
                const title = input?.value.trim();
                if (!title) return;
                try {
                    await this.api(`/api/admin/plexus/sponsors/${sponsorId}/tasks`, {
                        method: 'POST',
                        body: JSON.stringify({ title })
                    });
                    input.value = '';
                    await this.loadPlexusSponsors();
                } catch (err) {
                    console.error('Failed to add task:', err);
                }
            },

            async toggleSponsorTask(taskId, completed) {
                try {
                    await this.api(`/api/admin/plexus/sponsor-tasks/${taskId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ is_completed: completed })
                    });
                    await this.loadPlexusSponsors();
                } catch (err) {
                    console.error('Failed to toggle task:', err);
                }
            },

            async deleteSponsorTask(taskId, sponsorId) {
                try {
                    await this.api(`/api/admin/plexus/sponsor-tasks/${taskId}`, { method: 'DELETE' });
                    await this.loadPlexusSponsors();
                } catch (err) {
                    console.error('Failed to delete task:', err);
                }
            },

            async loadPlexusVolunteers() {
                showSkeleton('pxVolunteersTable', 'table', 5);
                try {
                    const volunteers = await this.api('/api/admin/plexus/volunteers') || [];
                    this.plexusVolunteers = volunteers;
                    this.renderPlexusVolunteers();
                    this.loadPlexusShifts();
                } catch (err) {
                    console.error('Failed to load volunteers:', err);
                }
            },

            renderPlexusVolunteers() {
                const tbody = document.getElementById('pxVolunteersTable');
                if (!tbody) return;

                if (this.plexusVolunteers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="table-empty"><i class="fas fa-hand-holding-heart"></i><p>No volunteer applications yet</p></td></tr>';
                    return;
                }

                tbody.innerHTML = this.plexusVolunteers.map(v => `
                    <tr>
                        <td>${this.escapeHtml(v.name || v.email)}</td>
                        <td>${this.escapeHtml(v.email || '')}</td>
                        <td>${v.availability || 'Both days'}</td>
                        <td><span class="status ${v.status === 'approved' ? 'paid' : v.status === 'rejected' ? 'cancelled' : 'pending'}">${v.status || 'Pending'}</span></td>
                        <td class="actions">
                            <button onclick="App.approveVolunteer('${v.id}')" title="Approve"><i class="fas fa-check"></i></button>
                            <button onclick="App.rejectVolunteer('${v.id}')" title="Reject"><i class="fas fa-times"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            async approveVolunteer(id) {
                try {
                    await this.api(`/api/admin/plexus/volunteers/${id}/approve`, { method: 'POST' });
                    await this.loadPlexusVolunteers();
                } catch (err) {
                    console.error('Failed to approve volunteer:', err);
                }
            },

            async rejectVolunteer(id) {
                if (!confirm('Reject this volunteer application?')) return;
                try {
                    await this.api(`/api/admin/plexus/volunteers/${id}/reject`, { method: 'POST' });
                    await this.loadPlexusVolunteers();
                } catch (err) {
                    console.error('Failed to reject volunteer:', err);
                }
            },

            exportPlexusVolunteers() {
                if (!this.plexusVolunteers || this.plexusVolunteers.length === 0) {
                    Toast.warning('No volunteers to export');
                    return;
                }

                const headers = ['Name', 'Email', 'Availability', 'Preferred Tasks', 'Status'];
                const rows = this.plexusVolunteers.map(v => [
                    (v.first_name || '') + ' ' + (v.last_name || ''),
                    v.email || '',
                    v.availability || '',
                    v.preferred_tasks || '',
                    v.status || 'pending'
                ]);

                const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `plexus-volunteers-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            },

            async loadPlexusShifts() {
                const container = document.getElementById('pxShiftsList');
                if (!container) return;

                // For now, show placeholder shifts
                container.innerHTML = `
                    <div class="schedule-item">
                        <div class="time">08:00 - 12:00</div>
                        <div class="title">Registration Desk - Morning</div>
                        <div class="location">Dec 4 - Lobby</div>
                    </div>
                    <div class="schedule-item">
                        <div class="time">12:00 - 18:00</div>
                        <div class="title">Registration Desk - Afternoon</div>
                        <div class="location">Dec 4 - Lobby</div>
                    </div>
                    <div class="schedule-item">
                        <div class="time">18:00 - 22:00</div>
                        <div class="title">Gala Evening Support</div>
                        <div class="location">Dec 5 - Ballroom</div>
                    </div>
                `;
            },

            openShiftModal() {
                const title = prompt('Shift Name:');
                if (!title) return;
                alert('Shift creation coming soon. For now, shifts are managed manually.');
            },

            async loadPlexusCheckinStats() {
                try {
                    const stats = await this.api('/api/admin/plexus/stats');
                    document.getElementById('pxCheckinTotal').textContent = stats.checked_in || 0;
                    document.getElementById('pxCheckinRemaining').textContent = (stats.total_registrations || 0) - (stats.checked_in || 0);

                    // Load recent check-ins
                    const container = document.getElementById('pxRecentCheckins');
                    const recentCheckins = await this.api('/api/admin/plexus/recent-checkins') || [];

                    if (recentCheckins.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No check-ins yet</p>';
                    } else {
                        container.innerHTML = recentCheckins.slice(0, 10).map(c => `
                            <div class="recent-checkin-item">
                                <div class="check-icon"><i class="fas fa-check"></i></div>
                                <div class="info">
                                    <div class="name">${this.escapeHtml(c.name || c.email)}</div>
                                    <div class="time">${new Date(c.checked_in_at).toLocaleTimeString()}</div>
                                </div>
                            </div>
                        `).join('');
                    }
                    // Also load session check-in cards
                    this.loadSessionCheckins();
                } catch (err) {
                    console.error('Failed to load check-in stats:', err);
                }
            },

            // --- QR SCANNER ---
            qrScanners: {},

            toggleQRScanner(eventType) {
                const readerId = `qr-reader-${eventType}`;
                const readerEl = document.getElementById(readerId);
                if (!readerEl) return;

                const btn = readerEl.previousElementSibling;

                if (this.qrScanners[eventType]) {
                    // Stop scanner
                    this.qrScanners[eventType].clear().catch(() => {});
                    delete this.qrScanners[eventType];
                    readerEl.style.display = 'none';
                    readerEl.innerHTML = '';
                    if (btn) { btn.classList.remove('active'); btn.querySelector('span').textContent = 'Enable Camera'; }
                    return;
                }

                // Start scanner
                readerEl.style.display = 'block';
                if (btn) { btn.classList.add('active'); btn.querySelector('span').textContent = 'Disable Camera'; }

                try {
                    const scanner = new Html5QrcodeScanner(readerId, {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        rememberLastUsedCamera: true,
                        showTorchButtonIfSupported: true
                    }, false);

                    scanner.render(
                        (decodedText) => {
                            // On successful scan
                            this.handleQRScan(eventType, decodedText);
                        },
                        (errorMessage) => {
                            // Ignore scan errors (no QR in frame)
                        }
                    );
                    this.qrScanners[eventType] = scanner;
                } catch (err) {
                    console.error('QR Scanner init failed:', err);
                    readerEl.innerHTML = '<p style="color: var(--text-muted); padding: 20px; text-align: center;">Camera not available. Use manual entry below.</p>';
                }
            },

            async handleQRScan(eventType, code) {
                // Debounce: prevent rapid duplicate scans
                if (this._lastScan === code && Date.now() - this._lastScanTime < 3000) return;
                this._lastScan = code;
                this._lastScanTime = Date.now();

                // Put code in input for visibility
                const inputIds = { plexus: 'pxCheckinInput', forum: 'fmCheckinInput', bridges: 'brCheckinInput' };
                const input = document.getElementById(inputIds[eventType]);
                if (input) input.value = code;

                await this.performCheckin(eventType);
            },

            async performCheckin(eventType = 'plexus') {
                const inputIds = { plexus: 'pxCheckinInput', forum: 'fmCheckinInput', bridges: 'brCheckinInput' };
                const resultIds = { plexus: 'pxCheckinResult', forum: 'fmCheckinResult', bridges: 'brCheckinResult' };
                const endpoints = {
                    plexus: '/api/plexus/checkin',
                    forum: '/api/admin/forum/checkin',
                    bridges: '/api/admin/bridges/checkin'
                };

                const input = document.getElementById(inputIds[eventType]);
                const resultDiv = document.getElementById(resultIds[eventType]);
                const code = input?.value?.trim();

                if (!code) {
                    if (resultDiv) {
                        resultDiv.className = 'checkin-result error';
                        resultDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please enter a code or scan a QR code';
                    }
                    return;
                }

                try {
                    const result = await this.api(endpoints[eventType] || '/api/checkin', {
                        method: 'POST',
                        body: JSON.stringify({ code })
                    });

                    if (result.success) {
                        const a = result.attendee || {};
                        const qi = result.qr_info; // Rich QR data (v2)
                        const name = a.first_name ? `${a.first_name} ${a.last_name || ''}`.trim() : (qi?.name || a.name || a.email || 'Unknown');
                        const ticketType = a.ticket_name || qi?.ticket_type || '';
                        const eventLabel = result.event ? ` (${result.event.charAt(0).toUpperCase() + result.event.slice(1)})` : (qi?.event ? ` (${qi.event})` : '');
                        const detailParts = [a.email || '', ticketType].filter(Boolean);

                        if (result.already_checked_in) {
                            resultDiv.className = 'checkin-result already';
                            resultDiv.innerHTML = `
                                <i class="fas fa-info-circle"></i> Already checked in
                                <div class="checkin-attendee-info">
                                    <div class="name">${this.escapeHtml(name)}${eventLabel}</div>
                                    <div class="detail">${detailParts.map(p => this.escapeHtml(p)).join(' &bull; ')}</div>
                                </div>`;
                        } else {
                            resultDiv.className = 'checkin-result success';
                            resultDiv.innerHTML = `
                                <i class="fas fa-check-circle"></i> Checked in successfully!
                                <div class="checkin-attendee-info">
                                    <div class="name">${this.escapeHtml(name)}${eventLabel}</div>
                                    <div class="detail">${detailParts.map(p => this.escapeHtml(p)).join(' &bull; ')}</div>
                                </div>`;
                        }
                        if (input) input.value = '';
                        if (eventType === 'plexus') this.loadPlexusCheckinStats();
                    } else {
                        resultDiv.className = 'checkin-result error';
                        resultDiv.innerHTML = `<i class="fas fa-times-circle"></i> ${result.error || 'Not found'}`;
                    }
                } catch (err) {
                    if (resultDiv) {
                        resultDiv.className = 'checkin-result error';
                        resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> Check-in failed. Please try again.';
                    }
                }
            },

            // --- PER-SESSION CHECK-IN ---

            async toggleSessionCheckin(sessionId) {
                try {
                    const result = await this.api(`/api/admin/plexus/sessions/${sessionId}/toggle-checkin`, { method: 'PUT' });
                    // Update local data
                    const session = this.plexusSessions.find(s => s.id === sessionId);
                    if (session) session.checkin_enabled = result.checkin_enabled;
                    this.renderScheduleGrid();
                    // Reload session check-in list if on check-in tab
                    if (this.plexusCurrentTab === 'checkin') this.loadSessionCheckins();
                } catch (err) {
                    console.error('Failed to toggle session check-in:', err);
                }
            },

            async loadSessionCheckins() {
                try {
                    const sessions = await this.api('/api/admin/plexus/checkin-enabled-sessions');
                    const container = document.getElementById('sessionCheckinList');
                    if (!container) return;

                    if (!sessions || sessions.length === 0) {
                        container.innerHTML = `
                            <p style="color: var(--text-muted); font-size: 13px;">
                                <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                                Enable session check-in from the Schedule tab using the <i class="fas fa-qrcode" style="color: var(--accent-gold);"></i> button on each session.
                            </p>`;
                        return;
                    }

                    container.innerHTML = sessions.map(s => `
                        <div class="session-checkin-card">
                            <div class="session-title">${this.escapeHtml(s.title || 'Untitled')}</div>
                            <div class="session-meta">
                                ${s.start_time || ''} - ${s.end_time || ''} &bull; ${this.escapeHtml(s.room || 'TBD')}
                                &bull; <span class="count">${s.checkin_count || 0}</span> checked in
                            </div>
                            <div class="session-checkin-input-group">
                                <input type="text" id="sessionCheckin_${s.id}" placeholder="Scan QR or enter ID..."
                                    onkeydown="if(event.key==='Enter') App.sessionCheckin('${s.id}')">
                                <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="App.sessionCheckin('${s.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                            <div id="sessionCheckinResult_${s.id}" style="margin-top: 8px;"></div>
                        </div>
                    `).join('');
                } catch (err) {
                    console.error('Failed to load session check-ins:', err);
                }
            },

            async sessionCheckin(sessionId) {
                const input = document.getElementById(`sessionCheckin_${sessionId}`);
                const resultDiv = document.getElementById(`sessionCheckinResult_${sessionId}`);
                const code = input?.value?.trim();
                if (!code) return;

                try {
                    const result = await this.api(`/api/admin/plexus/sessions/${sessionId}/checkin`, {
                        method: 'POST',
                        body: JSON.stringify({ code })
                    });

                    if (result.success) {
                        const a = result.attendee || {};
                        if (result.already_checked_in) {
                            resultDiv.innerHTML = `<div class="checkin-result already" style="padding: 8px 12px; font-size: 13px;">
                                <i class="fas fa-info-circle"></i> ${this.escapeHtml(a.name || 'Unknown')} — already checked in</div>`;
                        } else {
                            resultDiv.innerHTML = `<div class="checkin-result success" style="padding: 8px 12px; font-size: 13px;">
                                <i class="fas fa-check-circle"></i> ${this.escapeHtml(a.name || 'Unknown')} — checked in! ${a.ticket_name ? '(' + this.escapeHtml(a.ticket_name) + ')' : ''}</div>`;
                            // Update the count
                            this.loadSessionCheckins();
                        }
                        input.value = '';
                    }
                } catch (err) {
                    if (resultDiv) {
                        resultDiv.innerHTML = `<div class="checkin-result error" style="padding: 8px 12px; font-size: 13px;">
                            <i class="fas fa-times-circle"></i> ${err.message || 'Check-in failed'}</div>`;
                    }
                }
            },

            // --- GLOBAL QR SCANNER ---
            _globalScanner: null,
            _globalActiveTab: 'scan',
            _globalSearchDebounce: null,
            _globalLastCheckin: null, // { id, event, name } for undo
            _globalResultTimer: null,

            openGlobalQRScanner() {
                if (document.getElementById('globalQRModal')) return;

                const overlay = document.createElement('div');
                overlay.id = 'globalQRModal';
                overlay.className = 'qr-modal-overlay';
                overlay.onclick = (e) => { if (e.target === overlay) this.closeGlobalQRScanner(); };
                overlay.innerHTML = `
                    <div class="qr-modal">
                        <button class="qr-modal-close" onclick="App.closeGlobalQRScanner()"><i class="fas fa-times"></i></button>
                        <h3><i class="fas fa-qrcode"></i> Quick Check-in</h3>

                        <div class="qr-stats-bar" id="qrStatsBar">
                            <div class="qr-stats-overall">
                                <span id="qrStatsLabel">Loading...</span>
                                <span class="qr-stats-pct" id="qrStatsPct"></span>
                            </div>
                            <div class="qr-progress"><div class="qr-progress-fill" id="qrProgressFill" style="width:0%"></div></div>
                            <div class="qr-stats-events" id="qrStatsEvents"></div>
                        </div>

                        <div class="qr-tabs">
                            <button class="qr-tab-btn active" id="qrTabScan" onclick="App.switchGlobalTab('scan')"><i class="fas fa-camera"></i> Scan</button>
                            <button class="qr-tab-btn" id="qrTabSearch" onclick="App.switchGlobalTab('search')"><i class="fas fa-search"></i> Search</button>
                        </div>

                        <div id="qrScanContent">
                            <div class="qr-viewfinder" id="globalQRReader"></div>
                            <div class="manual-entry">
                                <input type="text" id="globalCheckinInput" placeholder="Or type code / ID manually…"
                                       onkeydown="if(event.key==='Enter') App.globalCheckin()">
                                <button onclick="App.globalCheckin()"><i class="fas fa-check"></i> Check In</button>
                            </div>
                        </div>

                        <div id="qrSearchContent" style="display:none;">
                            <input type="text" class="qr-search-input" id="globalSearchInput"
                                   placeholder="Search by name or email…"
                                   oninput="App.globalSearchAttendees()">
                            <div class="qr-search-results" id="globalSearchResults"></div>
                        </div>

                        <div id="globalCheckinResult"></div>

                        <div class="qr-recent-list" id="qrRecentList">
                            <h4><i class="fas fa-history"></i> Recent Check-ins</h4>
                            <div id="qrRecentItems"><span style="font-size:12px;color:var(--text-muted)">Loading...</span></div>
                        </div>

                        <div class="qr-offline-banner" id="qrOfflineBanner" style="display:none;">
                            <i class="fas fa-triangle-exclamation"></i>
                            <span id="qrOfflineCount">0</span> queued
                            <button class="qr-flush-btn" onclick="App.flushCheckinQueue()"><i class="fas fa-sync"></i> Retry</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);

                // Escape key listener
                this._globalEscHandler = (e) => { if (e.key === 'Escape') this.closeGlobalQRScanner(); };
                document.addEventListener('keydown', this._globalEscHandler);

                // Load stats + recent
                this.loadGlobalCheckinStats();
                this.loadGlobalRecentCheckins();
                this.updateOfflineBanner();

                // Start camera scanner
                this._globalActiveTab = 'scan';
                this._startGlobalCamera();
            },

            _startGlobalCamera() {
                try {
                    const scanner = new Html5QrcodeScanner('globalQRReader', {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        rememberLastUsedCamera: true,
                        showTorchButtonIfSupported: true
                    }, false);

                    scanner.render(
                        (decodedText) => {
                            if (this._globalLastScan === decodedText && Date.now() - this._globalLastScanTime < 3000) return;
                            this._globalLastScan = decodedText;
                            this._globalLastScanTime = Date.now();

                            const input = document.getElementById('globalCheckinInput');
                            if (input) input.value = decodedText;
                            this.globalCheckin(decodedText);
                        },
                        () => {}
                    );
                    this._globalScanner = scanner;
                } catch (err) {
                    console.error('Global QR Scanner init failed:', err);
                    const reader = document.getElementById('globalQRReader');
                    if (reader) reader.innerHTML = '<p style="color: var(--text-muted); padding: 20px; text-align: center;">Camera not available. Use manual entry below.</p>';
                }
            },

            closeGlobalQRScanner() {
                if (this._globalScanner) {
                    this._globalScanner.clear().catch(() => {});
                    this._globalScanner = null;
                }
                if (this._globalEscHandler) {
                    document.removeEventListener('keydown', this._globalEscHandler);
                    this._globalEscHandler = null;
                }
                if (this._globalResultTimer) {
                    clearTimeout(this._globalResultTimer);
                    this._globalResultTimer = null;
                }
                const modal = document.getElementById('globalQRModal');
                if (modal) modal.remove();
                this._globalLastScan = null;
            },

            switchGlobalTab(tab) {
                this._globalActiveTab = tab;
                const scanBtn = document.getElementById('qrTabScan');
                const searchBtn = document.getElementById('qrTabSearch');
                const scanContent = document.getElementById('qrScanContent');
                const searchContent = document.getElementById('qrSearchContent');
                if (!scanBtn) return;

                if (tab === 'scan') {
                    scanBtn.classList.add('active');
                    searchBtn.classList.remove('active');
                    scanContent.style.display = '';
                    searchContent.style.display = 'none';
                    // Restart camera if it was stopped
                    if (!this._globalScanner) {
                        const reader = document.getElementById('globalQRReader');
                        if (reader) { reader.innerHTML = ''; this._startGlobalCamera(); }
                    }
                } else {
                    searchBtn.classList.add('active');
                    scanBtn.classList.remove('active');
                    searchContent.style.display = '';
                    scanContent.style.display = 'none';
                    // Stop camera to save resources
                    if (this._globalScanner) {
                        this._globalScanner.clear().catch(() => {});
                        this._globalScanner = null;
                    }
                    setTimeout(() => document.getElementById('globalSearchInput')?.focus(), 100);
                }
            },

            async loadGlobalCheckinStats() {
                try {
                    const stats = await this.api('/api/checkin/stats');
                    const o = stats.overall || { total: 0, checked_in: 0 };
                    const pct = o.total > 0 ? Math.round((o.checked_in / o.total) * 100) : 0;

                    const label = document.getElementById('qrStatsLabel');
                    const pctEl = document.getElementById('qrStatsPct');
                    const fill = document.getElementById('qrProgressFill');
                    const events = document.getElementById('qrStatsEvents');
                    if (!label) return;

                    label.textContent = `${o.checked_in} / ${o.total} checked in`;
                    pctEl.textContent = `${pct}%`;
                    fill.style.width = `${pct}%`;

                    events.innerHTML = ['plexus', 'gala', 'forum', 'bridges']
                        .filter(e => stats[e] && stats[e].total > 0)
                        .map(e => {
                            const s = stats[e];
                            return `<span class="qr-stat-chip"><span class="event-badge ${e}" style="margin-right:4px">${e}</span> <span class="qr-stat-count">${s.checked_in}</span>/${s.total}</span>`;
                        }).join('');
                } catch (err) {
                    console.error('Stats load failed:', err);
                }
            },

            async loadGlobalRecentCheckins() {
                try {
                    const recent = await this.api('/api/checkin/recent');
                    const container = document.getElementById('qrRecentItems');
                    if (!container) return;

                    if (!recent || recent.length === 0) {
                        container.innerHTML = '<span style="font-size:12px;color:var(--text-muted)">No check-ins yet</span>';
                        return;
                    }

                    container.innerHTML = recent.slice(0, 5).map(r => {
                        const time = r.checked_in_at ? new Date(r.checked_in_at + 'Z').toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '--:--';
                        return `<div class="qr-recent-item">
                            <span class="qr-ri-time">${time}</span>
                            <span class="qr-ri-name">${this.escapeHtml(r.name)}</span>
                            <span class="event-badge ${this.escapeHtml(r.event)}">${this.escapeHtml(r.event)}</span>
                        </div>`;
                    }).join('');
                } catch (err) {
                    console.error('Recent check-ins load failed:', err);
                }
            },

            globalSearchAttendees() {
                clearTimeout(this._globalSearchDebounce);
                this._globalSearchDebounce = setTimeout(async () => {
                    const input = document.getElementById('globalSearchInput');
                    const results = document.getElementById('globalSearchResults');
                    const q = input?.value?.trim();
                    if (!q || q.length < 2) { results.innerHTML = ''; return; }

                    results.innerHTML = '<span style="font-size:12px;color:var(--text-muted);padding:8px">Searching...</span>';
                    try {
                        const rows = await this.api(`/api/checkin/search?q=${encodeURIComponent(q)}`);
                        if (!rows || rows.length === 0) {
                            results.innerHTML = '<span style="font-size:12px;color:var(--text-muted);padding:8px">No results</span>';
                            return;
                        }
                        results.innerHTML = rows.map(r => {
                            const badge = `<span class="event-badge ${this.escapeHtml(r.event)}">${this.escapeHtml(r.event)}</span>`;
                            const detail = [r.email, r.ticket_name].filter(Boolean).join(' \u2022 ');
                            if (r.checked_in) {
                                return `<div class="qr-search-row">
                                    <div class="qr-sr-info"><div class="qr-sr-name">${this.escapeHtml(r.name)} ${badge}</div><div class="qr-sr-detail">${this.escapeHtml(detail)}</div></div>
                                    <button class="qr-sr-btn checked"><i class="fas fa-check"></i> Done</button>
                                </div>`;
                            }
                            return `<div class="qr-search-row">
                                <div class="qr-sr-info"><div class="qr-sr-name">${this.escapeHtml(r.name)} ${badge}</div><div class="qr-sr-detail">${this.escapeHtml(detail)}</div></div>
                                <button class="qr-sr-btn checkin" onclick="App.globalCheckinById(${r.id}, '${this.escapeHtml(r.event)}')"><i class="fas fa-check"></i> Check In</button>
                            </div>`;
                        }).join('');
                    } catch (err) {
                        results.innerHTML = '<span style="font-size:12px;color:var(--text-muted);padding:8px">Search failed</span>';
                    }
                }, 300);
            },

            async globalCheckinById(id, event) {
                const code = JSON.stringify({ id: String(id), event });
                await this.globalCheckin(code);
                // Refresh search results to update checked-in status
                this.globalSearchAttendees();
            },

            async globalCheckin(code) {
                const input = document.getElementById('globalCheckinInput');
                const resultDiv = document.getElementById('globalCheckinResult');
                if (!code) code = input?.value?.trim();

                if (!code) {
                    if (resultDiv) {
                        resultDiv.className = 'checkin-result error';
                        resultDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please enter a code or scan a QR code';
                    }
                    return;
                }

                // Clear previous auto-fade timer
                if (this._globalResultTimer) { clearTimeout(this._globalResultTimer); this._globalResultTimer = null; }

                try {
                    const result = await this.api('/api/checkin', {
                        method: 'POST',
                        body: JSON.stringify({ code })
                    });

                    if (result.success) {
                        const a = result.attendee || {};
                        const name = a.first_name ? `${a.first_name} ${a.last_name || ''}`.trim() : (a.name || a.email || 'Unknown');
                        const evt = result.event || 'unknown';
                        const badge = `<span class="event-badge ${this.escapeHtml(evt)}">${this.escapeHtml(evt)}</span>`;

                        if (result.already_checked_in) {
                            resultDiv.className = 'checkin-result already';
                            resultDiv.innerHTML = `
                                <i class="fas fa-info-circle"></i> Already checked in
                                <div class="checkin-attendee-info">
                                    <div class="name">${this.escapeHtml(name)} ${badge}</div>
                                    <div class="detail">${this.escapeHtml(a.email || '')} ${a.ticket_name ? '&bull; ' + this.escapeHtml(a.ticket_name) : ''}</div>
                                </div>`;
                        } else {
                            this._globalLastCheckin = { id: a.id, event: evt, name };
                            resultDiv.className = 'checkin-result success';
                            resultDiv.innerHTML = `
                                <i class="fas fa-check-circle"></i> Checked in successfully!
                                <div class="checkin-attendee-info">
                                    <div class="name">${this.escapeHtml(name)} ${badge}</div>
                                    <div class="detail">${this.escapeHtml(a.email || '')} ${a.ticket_name ? '&bull; ' + this.escapeHtml(a.ticket_name) : ''}</div>
                                </div>
                                <button class="qr-undo-btn" onclick="App.undoGlobalCheckin()"><i class="fas fa-undo"></i> Undo</button>`;
                        }
                        if (input) input.value = '';

                        // Refresh stats + recent
                        this.loadGlobalCheckinStats();
                        this.loadGlobalRecentCheckins();

                        // Flush any offline queue on successful network call
                        this.flushCheckinQueue();

                        // Auto-clear result after 4s
                        this._globalResultTimer = setTimeout(() => {
                            if (resultDiv) { resultDiv.className = ''; resultDiv.innerHTML = ''; }
                        }, 4000);
                    } else {
                        resultDiv.className = 'checkin-result error';
                        resultDiv.innerHTML = `<i class="fas fa-times-circle"></i> ${result.error || 'Not found'}`;
                    }
                } catch (err) {
                    // Network error — queue for offline retry
                    this.queueCheckin(code);
                    if (resultDiv) {
                        resultDiv.className = 'checkin-result already';
                        resultDiv.innerHTML = '<i class="fas fa-wifi"></i> Offline — queued for retry';
                    }
                }
            },

            async undoGlobalCheckin() {
                const last = this._globalLastCheckin;
                if (!last) return;
                const resultDiv = document.getElementById('globalCheckinResult');

                try {
                    const result = await this.api('/api/checkin/undo', {
                        method: 'POST',
                        body: JSON.stringify({ id: last.id, event: last.event })
                    });

                    if (result.success) {
                        resultDiv.className = 'checkin-result already';
                        resultDiv.innerHTML = `<i class="fas fa-undo"></i> Undone: ${this.escapeHtml(last.name)}`;
                        this._globalLastCheckin = null;
                        this.loadGlobalCheckinStats();
                        this.loadGlobalRecentCheckins();

                        this._globalResultTimer = setTimeout(() => {
                            if (resultDiv) { resultDiv.className = ''; resultDiv.innerHTML = ''; }
                        }, 3000);
                    } else {
                        resultDiv.className = 'checkin-result error';
                        resultDiv.innerHTML = `<i class="fas fa-times-circle"></i> ${result.error || 'Undo failed'}`;
                    }
                } catch (err) {
                    if (resultDiv) {
                        resultDiv.className = 'checkin-result error';
                        resultDiv.innerHTML = '<i class="fas fa-times-circle"></i> Undo failed (network error)';
                    }
                }
            },

            // --- Offline Queue ---
            queueCheckin(code) {
                const queue = JSON.parse(localStorage.getItem('checkinQueue') || '[]');
                queue.push({ code, timestamp: Date.now() });
                localStorage.setItem('checkinQueue', JSON.stringify(queue));
                this.updateOfflineBanner();
                this.updateFabBadge();
            },

            async flushCheckinQueue() {
                const queue = JSON.parse(localStorage.getItem('checkinQueue') || '[]');
                if (queue.length === 0) return;

                const remaining = [];
                for (const item of queue) {
                    try {
                        await this.api('/api/checkin', {
                            method: 'POST',
                            body: JSON.stringify({ code: item.code })
                        });
                    } catch (err) {
                        remaining.push(item);
                    }
                }
                localStorage.setItem('checkinQueue', JSON.stringify(remaining));
                this.updateOfflineBanner();
                this.updateFabBadge();

                if (remaining.length === 0 && queue.length > 0) {
                    // All flushed — refresh stats
                    this.loadGlobalCheckinStats();
                    this.loadGlobalRecentCheckins();
                }
            },

            updateOfflineBanner() {
                const banner = document.getElementById('qrOfflineBanner');
                const count = document.getElementById('qrOfflineCount');
                const queue = JSON.parse(localStorage.getItem('checkinQueue') || '[]');
                if (banner) {
                    banner.style.display = queue.length > 0 ? 'flex' : 'none';
                    if (count) count.textContent = queue.length;
                }
            },

            updateFabBadge() {
                const fab = document.getElementById('globalQRBtn');
                if (!fab) return;
                const queue = JSON.parse(localStorage.getItem('checkinQueue') || '[]');
                let badge = fab.querySelector('.qr-fab-badge');
                if (queue.length > 0) {
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'qr-fab-badge';
                        fab.style.position = 'fixed'; // ensure positioning context
                        fab.appendChild(badge);
                    }
                    badge.textContent = queue.length;
                } else if (badge) {
                    badge.remove();
                }
            },

            // --- SPEAKER DOCUMENT TRACKING ---
            speakerDocSummary: null,

            async loadSpeakerDocSummary() {
                try {
                    const summary = await this.api('/api/admin/plexus/speakers/documents/summary');
                    this.speakerDocSummary = summary;

                    // Show summary line
                    const el = document.getElementById('pxSpeakerDocSummary');
                    const text = document.getElementById('pxSpeakerDocSummaryText');
                    if (el && text && summary) {
                        text.textContent = `${summary.withPresentation}/${summary.total} speakers uploaded presentations`;
                        el.style.display = 'block';
                    }
                } catch (err) {
                    console.log('Could not load speaker doc summary:', err);
                }
            },

            getSpeakerDocBadges(speakerId) {
                if (!this.speakerDocSummary) return '';
                const s = this.speakerDocSummary.speakers?.find(sp => sp.speaker_id === speakerId);
                if (!s) return '';

                const badge = (has, icon, label) =>
                    `<span class="doc-badge ${has ? 'has' : 'missing'}"><i class="fas ${icon}"></i> ${label}</span>`;

                return `<div style="margin-top: 6px; display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                    ${badge(s.has_presentation, 'fa-file-powerpoint', 'PPT')}
                    ${badge(s.has_cv, 'fa-file-alt', 'CV')}
                    ${badge(s.has_photo, 'fa-image', 'Photo')}
                </div>`;
            },

            async loadSpeakerDocuments(speakerId) {
                try {
                    return await this.api(`/api/admin/plexus/speakers/${speakerId}/documents`) || [];
                } catch (err) {
                    console.error('Failed to load speaker docs:', err);
                    return [];
                }
            },

            async loadPlexusPending() {
                try {
                    const pending = await this.api('/api/admin/plexus/pending');
                    this.plexusPending = pending;

                    // Render each pending section
                    this.renderPendingList('pxPendingRefundsList', pending.refunds || [], 'refund');
                    this.renderPendingList('pxPendingVisasList', pending.visas || [], 'visa');
                    this.renderPendingList('pxPendingScholarshipsList', pending.scholarships || [], 'scholarship');
                    this.renderPendingList('pxPendingSpeakersList', pending.speaker_apps || [], 'speaker');
                } catch (err) {
                    console.error('Failed to load pending items:', err);
                }
            },

            renderPendingList(containerId, items, type) {
                const container = document.getElementById(containerId);
                if (!container) return;

                if (!items || items.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No pending items</p>';
                    return;
                }

                container.innerHTML = items.map(item => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 500;">${this.escapeHtml(item.name || item.email || 'Unknown')}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">${item.reason || item.details || ''}</div>
                        </div>
                        <div class="actions">
                            <button class="btn btn-primary" style="padding: 6px 12px;" onclick="App.approvePendingItem('${type}', '${item.id}')">Approve</button>
                            <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="App.rejectPendingItem('${type}', '${item.id}')">Reject</button>
                        </div>
                    </div>
                `).join('');
            },

            async approvePendingItem(type, id) {
                try {
                    await this.api(`/api/admin/plexus/${type}/${id}/approve`, { method: 'POST' });
                    await this.loadPlexusPending();
                    await this.loadPlexusStats();
                } catch (err) {
                    console.error('Failed to approve:', err);
                    Toast.error('Failed to approve item');
                }
            },

            async rejectPendingItem(type, id) {
                if (!confirm('Reject this request?')) return;
                try {
                    await this.api(`/api/admin/plexus/${type}/${id}/reject`, { method: 'POST' });
                    await this.loadPlexusPending();
                    await this.loadPlexusStats();
                } catch (err) {
                    console.error('Failed to reject:', err);
                    Toast.error('Failed to reject item');
                }
            },

            // ===== BIOMEDICAL FORUM MANAGEMENT =====
            forumCurrentTab: 'dashboard',
            forumMembers: [],
            forumPosts: [],
            forumEvents: [],
            forumGroups: [],
            forumApplications: [],
            forumMediaFolders: [],
            forumCurrentFolder: null,
            forumGallery: [],
            forumEventSchedule: [],
            currentForumEventId: null,

            showForumTab(tab) {
                this.forumCurrentTab = tab;

                // Update tab buttons
                document.querySelectorAll('.forum-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.forum-tab[onclick*="'${tab}'"]`)?.classList.add('active');

                // Update content panels
                document.querySelectorAll('.forum-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`forum-${tab}`)?.classList.add('active');

                // Load data for the tab
                switch(tab) {
                    case 'dashboard':
                        this.loadForumStats();
                        this.loadDashboardPrefs('forum').then(() => this.renderDynamicDashboard('forum', 'forumDashboardCards'));
                        break;
                    case 'directory': this.showForumTab('members'); return; // Redirect legacy directory to members
                    case 'feed': this.loadForumPosts(); break;
                    case 'events': this.loadForumEvents(); break;
                    case 'groups': this.loadForumGroups(); break;
                    case 'gallery': this.loadForumGallery(); break;
                    case 'members': this.loadForumMembers(); break;
                    case 'applications': this.loadForumApplications(); break;
                    case 'checkin': break; // Check-in tab needs no data pre-load
                }
            },

            async loadForumStats() {
                try {
                    const stats = await this.api('/api/admin/forum/stats');

                    document.getElementById('fmStatMembers').textContent = stats.total_members || 0;
                    document.getElementById('fmStatPending').textContent = stats.pending_applications || 0;
                    document.getElementById('fmStatPosts').textContent = stats.total_posts || 0;
                    document.getElementById('fmStatEvents').textContent = stats.total_events || 0;
                    document.getElementById('fmStatGroups').textContent = stats.total_groups || 0;
                    document.getElementById('fmStatMentors').textContent = stats.active_mentorships || 0;

                    // Update subtitle
                    document.getElementById('forumSubtitle').textContent = `${stats.total_members} members from ${stats.by_country?.length || 0} countries`;

                    // Render charts
                    this.renderForumCharts(stats);
                } catch (err) {
                    console.error('Failed to load Forum stats:', err);
                }
            },

            renderForumCharts(stats) {
                // Specialty chart
                const bySpecContainer = document.getElementById('fmChartBySpecialty');
                const specialties = stats.by_specialty || [];
                if (specialties.length > 0) {
                    const maxVal = Math.max(...specialties.map(s => s.count), 1);
                    bySpecContainer.innerHTML = specialties.map(s => `
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                                <span>${s.specialty || 'Other'}</span>
                                <span style="color: var(--text-muted);">${s.count}</span>
                            </div>
                            <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${(s.count/maxVal)*100}%; background: var(--forum); border-radius: 4px;"></div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    bySpecContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No data yet</p>';
                }

                // Country chart
                const byCountryContainer = document.getElementById('fmChartByCountry');
                const countries = stats.by_country || [];
                if (countries.length > 0) {
                    const maxVal = Math.max(...countries.map(c => c.count), 1);
                    byCountryContainer.innerHTML = countries.slice(0, 5).map(c => `
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px;">
                                <span>${c.country || 'Unknown'}</span>
                                <span style="color: var(--text-muted);">${c.count}</span>
                            </div>
                            <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${(c.count/maxVal)*100}%; background: var(--accent-gold); border-radius: 4px;"></div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    byCountryContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No data yet</p>';
                }
            },

            // Directory functions merged into Members tab
            loadForumDirectory() {
                // Legacy redirect — directory is now part of Members tab
                this.showForumTab('members');
            },

            filterForumDirectory() {
                // Legacy redirect
                this.filterForumMembers();
            },

            viewForumMember(id) {
                const member = this.forumMembers.find(m => m.id === id);
                if (!member) return;

                document.getElementById('fmMemberModalTitle').textContent = `${member.first_name || ''} ${member.last_name || ''}`.trim() || 'Member Profile';
                document.getElementById('fmMemberModalBody').innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: grid; grid-template-columns: 100px 1fr; gap: 8px; font-size: 14px;">
                            <span style="color: var(--text-secondary);">Email</span><span>${member.email || 'N/A'}</span>
                            <span style="color: var(--text-secondary);">Specialty</span><span>${member.specialty || 'N/A'}</span>
                            <span style="color: var(--text-secondary);">Institution</span><span>${member.institution || 'N/A'}</span>
                            <span style="color: var(--text-secondary);">Country</span><span>${member.country || 'N/A'}</span>
                        </div>
                        ${member.bio ? `<div style="padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 13px; color: var(--text-secondary); line-height: 1.6;">${member.bio}</div>` : ''}
                    </div>
                `;
                document.getElementById('fmMemberModalFooter').innerHTML = `
                    <button class="btn btn-secondary" onclick="App.emailForumMember('${id}')"><i class="fas fa-envelope"></i> Email</button>
                    <button class="btn btn-primary" onclick="App.closeModal('forumMemberModal')">Close</button>
                `;
                this.openModal('forumMemberModal');
            },

            emailForumMember(id) {
                const member = this.forumMembers.find(m => m.id === id);
                if (member && member.email) {
                    window.open(`mailto:${member.email}`, '_blank');
                }
            },

            async removeForumMember(id) {
                const member = this.forumMembers.find(m => m.id === id);
                if (!member) return;
                if (!confirm(`Remove ${member.first_name} ${member.last_name} from the Forum?\n\nThis action cannot be undone.`)) return;
                try {
                    await this.api(`/api/admin/forum/members/${id}`, { method: 'DELETE' });
                    this.forumMembers = this.forumMembers.filter(m => m.id !== id);
                    this.filterForumMembers();
                } catch (err) {
                    // If API fails, still remove from local state for demo
                    this.forumMembers = this.forumMembers.filter(m => m.id !== id);
                    this.filterForumMembers();
                }
            },

            async loadForumPosts() {
                try {
                    const posts = await this.api('/api/forum/posts');
                    this.forumPosts = posts;
                    this.renderForumPosts(posts);
                } catch (err) {
                    console.error('Failed to load posts:', err);
                }
            },

            renderForumPosts(posts) {
                const container = document.getElementById('fmFeedPosts');
                if (!container) return;

                if (!posts || posts.length === 0) {
                    container.innerHTML = '<div class="table-empty"><i class="fas fa-stream"></i><p>No posts yet. Be the first to share!</p></div>';
                    return;
                }

                container.innerHTML = posts.map(p => `
                    <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 10px; margin-bottom: 12px;">
                        <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                            <div style="width: 40px; height: 40px; background: var(--forum); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--bg-primary); font-weight: 600;">
                                ${(p.first_name || '?')[0]}${(p.last_name || '?')[0]}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${this.escapeHtml(p.first_name || '')} ${this.escapeHtml(p.last_name || '')}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${p.specialty || ''} ${p.institution ? '· ' + p.institution : ''}</div>
                            </div>
                            <div style="margin-left: auto; font-size: 11px; color: var(--text-muted);">
                                ${new Date(p.created_at).toLocaleDateString()}
                            </div>
                        </div>
                        ${p.title ? `<div style="font-weight: 600; margin-bottom: 8px;">${this.escapeHtml(p.title)}</div>` : ''}
                        <div style="font-size: 14px; line-height: 1.5; margin-bottom: 12px;">${this.escapeHtml(p.content)}</div>
                        ${p.image_url ? `<img src="${p.image_url}" style="max-width: 100%; border-radius: 8px; margin-bottom: 12px;">` : ''}
                        <div style="display: flex; gap: 16px; padding-top: 12px; border-top: 1px solid var(--border);">
                            <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="App.likeForumPost('${p.id}')">
                                <i class="fas fa-heart" style="color: ${p.has_liked ? 'var(--danger)' : 'inherit'};"></i> ${p.likes_count || 0}
                            </button>
                            <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="App.viewPostComments('${p.id}')">
                                <i class="fas fa-comment"></i> ${p.comments_count || 0}
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            async likeForumPost(id) {
                try {
                    await this.api(`/api/forum/posts/${id}/react`, { method: 'POST' });
                    await this.loadForumPosts();
                } catch (err) {
                    console.error('Failed to like post:', err);
                }
            },

            viewPostComments(id) {
                alert('Comments view coming soon.');
            },

            openPostModal() {
                document.getElementById('fpTitle').value = '';
                document.getElementById('fpContent').value = '';
                this.openModal('forumPostModal');
            },

            submitForumPost() {
                const content = document.getElementById('fpContent').value.trim();
                if (!content) { Toast.warning('Post content is required'); return; }
                const title = document.getElementById('fpTitle').value.trim() || null;
                this.createForumPost({ content, title });
                this.closeModal('forumPostModal');
            },

            async createForumPost(data) {
                try {
                    await this.api('/api/forum/posts', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    await this.loadForumPosts();
                } catch (err) {
                    console.error('Failed to create post:', err);
                    Toast.error('Failed to create post. You may need Forum membership.');
                }
            },

            // ===== PHASE 5B: FORUM EVENT MANAGEMENT =====
            editingForumEventId: null,

            async loadForumEvents() {
                try {
                    const events = await this.api('/api/admin/forum/events');
                    this.forumEvents = events;
                    this.renderForumEvents(events);
                } catch (err) {
                    console.error('Failed to load events:', err);
                    try {
                        const events = await this.api('/api/forum/events');
                        this.forumEvents = events;
                        this.renderForumEvents(events);
                    } catch (e2) { console.error('Fallback failed:', e2); }
                }
            },

            _statusBadgeClass(status) {
                const map = { planning: 'status-planning', upcoming: 'status-upcoming', registration_open: 'status-open',
                    ongoing: 'status-ongoing', completed: 'status-completed', published: 'status-published', draft: 'status-planning' };
                return map[status] || 'status-planning';
            },

            _statusLabel(status) {
                const map = { planning: 'Planning', upcoming: 'Upcoming', registration_open: 'Reg. Open',
                    ongoing: 'Ongoing', completed: 'Completed', published: 'Published', draft: 'Draft' };
                return map[status] || status || 'Planning';
            },

            _eventTypeLabel(type) {
                const map = { symposium: 'Symposium', workshop: 'Workshop', networking: 'Networking',
                    seminar: 'Seminar', webinar: 'Webinar', conference: 'Conference' };
                return map[type] || type || 'Event';
            },

            renderForumEvents(events) {
                const container = document.getElementById('fmEventsList');
                if (!container) return;

                if (!events || events.length === 0) {
                    container.innerHTML = '<div class="table-empty"><i class="fas fa-calendar-alt"></i><p>No events yet. Create your first event!</p></div>';
                    return;
                }

                container.innerHTML = events.map(e => {
                    const date = e.start_date ? new Date(e.start_date) : null;
                    const dayStr = date ? date.getDate() : '?';
                    const monthStr = date ? date.toLocaleString('default', { month: 'short' }) : '';
                    const dateStr = date ? date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) : 'TBD';
                    const timeStr = date ? date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '';
                    const endDate = e.end_date ? new Date(e.end_date) : null;
                    const endTimeStr = endDate ? endDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '';
                    const regCount = e.reg_count || e.registrations_count || 0;
                    const location = e.venue || e.location_name || (e.location_type === 'virtual' ? 'Virtual' : 'TBD');
                    const isPublished = !!e.is_published || e.status === 'published';

                    return `
                        <div class="forum-event-card" data-status="${e.status || 'planning'}" data-published="${isPublished ? 1 : 0}">
                            <div class="forum-event-card-header">
                                <div class="forum-event-date-block" style="cursor: pointer;" onclick="App.openForumEventDetail('${e.id}')">
                                    <div class="day">${dayStr}</div>
                                    <div class="month">${monthStr}</div>
                                </div>
                                <div class="forum-event-card-info">
                                    <div class="forum-event-card-title" style="cursor: pointer;" onclick="App.openForumEventDetail('${e.id}')">${this.escapeHtml(e.title)}</div>
                                    <div class="forum-event-card-meta">
                                        <span><i class="fas fa-clock"></i> ${dateStr}${timeStr ? ' ' + timeStr : ''}${endTimeStr ? ' - ' + endTimeStr : ''}</span>
                                        <span><i class="fas fa-map-marker-alt"></i> ${this.escapeHtml(location)}</span>
                                        ${e.speakers ? `<span><i class="fas fa-user-tie"></i> ${this.escapeHtml(e.speakers)}</span>` : ''}
                                    </div>
                                    <div class="forum-event-badges">
                                        <span class="forum-event-badge type"><i class="fas fa-tag"></i> ${this._eventTypeLabel(e.event_type)}</span>
                                        <span class="forum-event-badge ${this._statusBadgeClass(e.status)}">${this._statusLabel(e.status)}</span>
                                        ${isPublished ? '<span class="forum-event-badge published"><i class="fas fa-globe"></i> Published</span>' : '<span class="forum-event-badge draft"><i class="fas fa-eye-slash"></i> Draft</span>'}
                                        ${e.checkin_enabled ? '<span class="forum-event-badge type"><i class="fas fa-qrcode"></i> QR Check-in</span>' : ''}
                                    </div>
                                </div>
                                <div class="forum-event-card-actions">
                                    <button class="btn btn-secondary" style="padding: 6px 10px;" onclick="App.openForumEventModal('${e.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-secondary" style="padding: 6px 10px;" onclick="App.deleteForumEvent('${e.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="forum-event-card-footer">
                                <div class="forum-event-stats">
                                    <span><i class="fas fa-users"></i> ${regCount}${e.capacity ? '/' + e.capacity : ''} registered</span>
                                    ${e.registration_deadline ? `<span><i class="fas fa-hourglass-half"></i> Deadline: ${new Date(e.registration_deadline).toLocaleDateString()}</span>` : ''}
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" onclick="App.viewForumEventRegs('${e.id}')"><i class="fas fa-list"></i> Registrations</button>
                                    <button class="btn ${isPublished ? 'btn-secondary' : 'btn-primary'}" style="padding: 5px 10px; font-size: 12px;" onclick="App.toggleForumEventPublish('${e.id}')">
                                        <i class="fas ${isPublished ? 'fa-eye-slash' : 'fa-globe'}"></i> ${isPublished ? 'Unpublish' : 'Publish'}
                                    </button>
                                    <label class="forum-event-toggle" title="QR Check-in">
                                        <input type="checkbox" ${e.checkin_enabled ? 'checked' : ''} onchange="App.toggleForumEventCheckin('${e.id}')">
                                        <span style="font-size: 11px;">QR</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            filterForumEventCards() {
                const filter = document.getElementById('fmEventsFilter')?.value || 'all';
                const cards = document.querySelectorAll('.forum-event-card');
                cards.forEach(card => {
                    const status = card.dataset.status;
                    const published = card.dataset.published === '1';
                    let show = false;
                    switch(filter) {
                        case 'all': show = true; break;
                        case 'published': show = published; break;
                        case 'draft': show = !published; break;
                        case 'planning': show = status === 'planning'; break;
                        case 'upcoming': show = status === 'upcoming' || status === 'registration_open'; break;
                        case 'completed': show = status === 'completed'; break;
                        default: show = true;
                    }
                    card.style.display = show ? '' : 'none';
                });
            },

            openForumEventModal(eventId) {
                this.editingForumEventId = eventId || null;
                const modal = document.getElementById('forumEventModal');
                const titleEl = document.getElementById('forumEventModalTitle');

                if (eventId) {
                    const e = this.forumEvents.find(x => x.id === eventId);
                    if (!e) return;
                    titleEl.textContent = 'Edit Event';
                    document.getElementById('feTitle').value = e.title || '';
                    document.getElementById('feType').value = e.event_type || 'symposium';
                    document.getElementById('feStatus').value = e.status || 'planning';
                    document.getElementById('feStartDate').value = e.start_date ? e.start_date.replace(' ', 'T').substring(0, 16) : '';
                    document.getElementById('feEndDate').value = e.end_date ? e.end_date.replace(' ', 'T').substring(0, 16) : '';
                    document.getElementById('feVenue').value = e.venue || e.location_name || '';
                    document.getElementById('feAddress').value = e.location_address || '';
                    document.getElementById('feSpeakers').value = e.speakers || '';
                    document.getElementById('feDescription').value = e.description || '';
                    document.getElementById('feCapacity').value = e.capacity || '';
                    document.getElementById('feRegDeadline').value = e.registration_deadline || '';
                    document.getElementById('feLocationType').value = e.location_type || 'in_person';
                    document.getElementById('fePublished').checked = !!e.is_published || e.status === 'published';
                    document.getElementById('feCheckinEnabled').checked = !!e.checkin_enabled;
                } else {
                    titleEl.textContent = 'Create Event';
                    document.getElementById('feTitle').value = '';
                    document.getElementById('feType').value = 'symposium';
                    document.getElementById('feStatus').value = 'planning';
                    document.getElementById('feStartDate').value = '';
                    document.getElementById('feEndDate').value = '';
                    document.getElementById('feVenue').value = '';
                    document.getElementById('feAddress').value = '';
                    document.getElementById('feSpeakers').value = '';
                    document.getElementById('feDescription').value = '';
                    document.getElementById('feCapacity').value = '';
                    document.getElementById('feRegDeadline').value = '';
                    document.getElementById('feLocationType').value = 'in_person';
                    document.getElementById('fePublished').checked = false;
                    document.getElementById('feCheckinEnabled').checked = false;
                }

                modal.classList.add('active');
            },

            async saveForumEvent() {
                const title = document.getElementById('feTitle').value.trim();
                if (!title) { Toast.warning('Title is required'); return; }

                const data = {
                    title,
                    description: document.getElementById('feDescription').value.trim(),
                    event_type: document.getElementById('feType').value,
                    status: document.getElementById('feStatus').value,
                    start_date: document.getElementById('feStartDate').value,
                    end_date: document.getElementById('feEndDate').value,
                    venue: document.getElementById('feVenue').value.trim(),
                    location_name: document.getElementById('feVenue').value.trim(),
                    location_address: document.getElementById('feAddress').value.trim(),
                    speakers: document.getElementById('feSpeakers').value.trim(),
                    capacity: document.getElementById('feCapacity').value ? parseInt(document.getElementById('feCapacity').value) : null,
                    registration_deadline: document.getElementById('feRegDeadline').value,
                    location_type: document.getElementById('feLocationType').value,
                    is_published: document.getElementById('fePublished').checked ? 1 : 0,
                    checkin_enabled: document.getElementById('feCheckinEnabled').checked ? 1 : 0
                };

                try {
                    if (this.editingForumEventId) {
                        await this.api(`/api/admin/forum/events/${this.editingForumEventId}`, {
                            method: 'PUT',
                            body: JSON.stringify(data)
                        });
                    } else {
                        await this.api('/api/admin/forum/events', {
                            method: 'POST',
                            body: JSON.stringify(data)
                        });
                    }
                    this.closeModal('forumEventModal');
                    await this.loadForumEvents();
                } catch (err) {
                    console.error('Failed to save event:', err);
                    Toast.error('Failed to save event');
                }
            },

            async deleteForumEvent(id) {
                if (!confirm('Delete this event? This will also delete all registrations.')) return;
                try {
                    await this.api(`/api/admin/forum/events/${id}`, { method: 'DELETE' });
                    await this.loadForumEvents();
                } catch (err) {
                    console.error('Failed to delete event:', err);
                    Toast.error('Failed to delete event');
                }
            },

            // ========== PHASE 7B: EVENT DETAIL + SCHEDULE ==========

            async openForumEventDetail(eventId) {
                const event = this.forumEvents.find(e => e.id === eventId);
                if (!event) return;

                this.currentForumEventId = eventId;

                // Load schedule items
                let schedule = [];
                try {
                    schedule = await this.api(`/api/admin/forum/events/${eventId}/schedule`) || [];
                } catch (e) { schedule = []; }
                this.forumEventSchedule = schedule;

                // Build detail modal content
                const body = document.getElementById('forumEventDetailBody');
                if (!body) return;

                const dateStr = event.start_date ? new Date(event.start_date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) : 'TBD';
                const location = event.venue || event.location_name || (event.location_type === 'virtual' ? 'Virtual' : 'TBD');

                body.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h3 style="font-size: 18px; font-weight: 700; margin: 0;">${this.escapeHtml(event.title || 'Untitled Event')}</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" onclick="App.closeModal('forumEventDetailModal'); App.openForumEventModal('${eventId}')"><i class="fas fa-edit"></i> Edit</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; font-size: 13px; color: var(--text-secondary);">
                            <span><i class="fas fa-calendar"></i> ${dateStr}</span>
                            <span><i class="fas fa-map-marker-alt"></i> ${this.escapeHtml(location)}</span>
                            <span><i class="fas fa-users"></i> ${event.capacity || 'Unlimited'} spots</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 12px;">
                        <button class="btn btn-secondary active" onclick="App.showEventDetailTab('schedule')" id="evtTabSchedule"><i class="fas fa-clock"></i> Schedule</button>
                        <button class="btn btn-secondary" onclick="App.showEventDetailTab('registrations')" id="evtTabRegs"><i class="fas fa-users"></i> Registrations</button>
                    </div>

                    <div id="eventDetailContent"></div>
                `;

                this.showEventDetailTab('schedule');
                this.openModal('forumEventDetailModal');
            },

            showEventDetailTab(tab) {
                const content = document.getElementById('eventDetailContent');
                if (!content) return;

                // Update tab buttons
                document.querySelectorAll('[id^="evtTab"]').forEach(b => b.classList.remove('active'));
                const tabBtn = document.getElementById(tab === 'schedule' ? 'evtTabSchedule' : 'evtTabRegs');
                if (tabBtn) tabBtn.classList.add('active');

                if (tab === 'schedule') {
                    this.renderEventSchedule(content);
                } else {
                    content.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-secondary);"><i class="fas fa-users" style="font-size: 24px; margin-bottom: 8px; display: block;"></i>Registrations view coming soon</div>';
                }
            },

            renderEventSchedule(container) {
                const schedule = this.forumEventSchedule || [];

                let html = `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="font-size: 14px; font-weight: 600;">Program Items</span>
                    <button class="btn btn-primary" onclick="App.addScheduleItem()" style="padding: 6px 12px;"><i class="fas fa-plus"></i> Add Item</button>
                </div>`;

                if (schedule.length === 0) {
                    html += '<div class="table-empty"><i class="fas fa-clock"></i><p>No schedule items yet. Add your first program item.</p></div>';
                } else {
                    schedule.forEach(item => {
                        const speaker = item.speaker_ids || item.speaker || '';
                        const location = item.room || item.location || '';
                        html += `<div style="display: flex; gap: 12px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px;">
                            <div style="min-width: 70px; font-size: 12px; color: var(--accent-gold); font-weight: 600;">
                                ${item.start_time || ''}<br>${item.end_time ? '- ' + item.end_time : ''}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px;">${this.escapeHtml(item.title)}</div>
                                ${speaker ? `<div style="font-size: 12px; color: var(--text-secondary);"><i class="fas fa-user"></i> ${this.escapeHtml(speaker)}</div>` : ''}
                                ${location ? `<div style="font-size: 12px; color: var(--text-muted);"><i class="fas fa-map-pin"></i> ${this.escapeHtml(location)}</div>` : ''}
                                ${item.description ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${this.escapeHtml(item.description)}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 4px; align-items: flex-start;">
                                <button class="btn-icon" onclick="App.editScheduleItem('${item.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="btn-icon" onclick="App.deleteScheduleItem('${item.id}')" title="Delete" style="color: var(--danger);"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                    });
                }

                container.innerHTML = html;
            },

            async addScheduleItem() {
                const title = prompt('Program item title:');
                if (!title) return;
                const speaker = prompt('Speaker (optional):') || null;
                const start_time = prompt('Start time (e.g., 09:00):') || null;
                const end_time = prompt('End time (e.g., 10:00):') || null;

                try {
                    await this.api(`/api/admin/forum/events/${this.currentForumEventId}/schedule`, {
                        method: 'POST',
                        body: JSON.stringify({ title, speaker, start_time, end_time })
                    });
                    // Reload
                    this.forumEventSchedule = await this.api(`/api/admin/forum/events/${this.currentForumEventId}/schedule`) || [];
                    const content = document.getElementById('eventDetailContent');
                    if (content) this.renderEventSchedule(content);
                    Toast.success('Schedule item added');
                } catch (err) {
                    Toast.error('Failed to add schedule item');
                }
            },

            async editScheduleItem(itemId) {
                const item = (this.forumEventSchedule || []).find(i => i.id === itemId);
                if (!item) return;

                const title = prompt('Title:', item.title);
                if (title === null) return;
                const speaker = prompt('Speaker:', item.speaker_ids || item.speaker || '');
                const start_time = prompt('Start time:', item.start_time || '');
                const end_time = prompt('End time:', item.end_time || '');

                try {
                    await this.api(`/api/admin/forum/events/${this.currentForumEventId}/schedule/${itemId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ title, speaker: speaker || null, start_time: start_time || null, end_time: end_time || null })
                    });
                    this.forumEventSchedule = await this.api(`/api/admin/forum/events/${this.currentForumEventId}/schedule`) || [];
                    const content = document.getElementById('eventDetailContent');
                    if (content) this.renderEventSchedule(content);
                    Toast.success('Schedule item updated');
                } catch (err) {
                    Toast.error('Failed to update schedule item');
                }
            },

            async deleteScheduleItem(itemId) {
                if (!confirm('Delete this schedule item?')) return;
                try {
                    await this.api(`/api/admin/forum/events/${this.currentForumEventId}/schedule/${itemId}`, { method: 'DELETE' });
                    this.forumEventSchedule = await this.api(`/api/admin/forum/events/${this.currentForumEventId}/schedule`) || [];
                    const content = document.getElementById('eventDetailContent');
                    if (content) this.renderEventSchedule(content);
                    Toast.success('Item deleted');
                } catch (err) {
                    Toast.error('Failed to delete item');
                }
            },

            // ========== END PHASE 7B ==========

            async toggleForumEventPublish(id) {
                try {
                    const result = await this.api(`/api/admin/forum/events/${id}/publish`, { method: 'PUT' });
                    if (result.is_published) {
                        Toast.success('Event published! Notifications sent to all forum members.');
                    }
                    await this.loadForumEvents();
                } catch (err) {
                    console.error('Failed to toggle publish:', err);
                    Toast.error('Failed to toggle publish status');
                }
            },

            async toggleForumEventCheckin(id) {
                try {
                    await this.api(`/api/admin/forum/events/${id}/toggle-checkin`, { method: 'PUT' });
                    await this.loadForumEvents();
                } catch (err) {
                    console.error('Failed to toggle check-in:', err);
                }
            },

            async viewForumEventRegs(eventId) {
                try {
                    const regs = await this.api(`/api/admin/forum/events/${eventId}/registrations`);
                    const event = this.forumEvents.find(e => e.id === eventId);
                    document.getElementById('forumEventRegsTitle').textContent = `Registrations - ${event?.title || 'Event'}`;

                    const container = document.getElementById('forumEventRegsList');
                    if (!regs || regs.length === 0) {
                        container.innerHTML = '<div class="table-empty"><i class="fas fa-users"></i><p>No registrations yet</p></div>';
                    } else {
                        container.innerHTML = `
                            <div style="margin-bottom: 12px; font-size: 13px; color: var(--text-muted);">
                                ${regs.length} registered | ${regs.filter(r => r.checked_in).length} checked in
                            </div>
                            <table class="simple-table" style="width: 100%;">
                                <thead><tr>
                                    <th>Name</th><th>Email</th><th>Institution</th><th>Registered</th><th>Check-in</th><th>Actions</th>
                                </tr></thead>
                                <tbody>
                                    ${regs.map(r => `
                                        <tr>
                                            <td>${this.escapeHtml(r.name || (r.user_first ? (r.user_first + ' ' + (r.user_last || '')) : 'Unknown'))}</td>
                                            <td>${this.escapeHtml(r.email || r.user_email || '-')}</td>
                                            <td>${this.escapeHtml(r.institution || r.member_institution || '-')}</td>
                                            <td>${r.registered_at ? new Date(r.registered_at).toLocaleDateString() : '-'}</td>
                                            <td>${r.checked_in ? '<span class="status good"><i class="fas fa-check"></i> Checked in</span>' : '<span class="status neutral">Not checked in</span>'}</td>
                                            <td>${!r.checked_in ? `<button class="btn btn-primary" style="padding: 4px 8px; font-size: 11px;" onclick="App.checkinForumRegistrant('${eventId}', '${r.id}')"><i class="fas fa-qrcode"></i> Check in</button>` : `<span style="font-size: 11px; color: var(--text-muted);">${r.checked_in_at ? new Date(r.checked_in_at).toLocaleTimeString() : ''}</span>`}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                    }

                    document.getElementById('forumEventRegsModal').classList.add('active');
                } catch (err) {
                    console.error('Failed to load registrations:', err);
                    Toast.error('Failed to load registrations');
                }
            },

            async checkinForumRegistrant(eventId, regId) {
                try {
                    await this.api(`/api/admin/forum/events/${eventId}/checkin`, {
                        method: 'POST',
                        body: JSON.stringify({ registration_id: regId })
                    });
                    await this.viewForumEventRegs(eventId);
                } catch (err) {
                    console.error('Failed to check in:', err);
                    Toast.error(err.message || 'Failed to check in');
                }
            },

            async registerForForumEvent(id) {
                try {
                    await this.api(`/api/forum/events/${id}/register`, { method: 'POST' });
                    Toast.success('Successfully registered!');
                    await this.loadForumEvents();
                } catch (err) {
                    console.error('Failed to register:', err);
                    Toast.error(err.message || 'Failed to register for event');
                }
            },

            async loadForumGroups() {
                try {
                    const groups = await this.api('/api/forum/groups');
                    this.forumGroups = groups;
                    this.renderForumGroups(groups);
                } catch (err) {
                    console.error('Failed to load groups:', err);
                }
            },

            renderForumGroups(groups) {
                const container = document.getElementById('fmGroupsGrid');
                if (!container) return;

                if (!groups || groups.length === 0) {
                    container.innerHTML = '<div class="table-empty" style="grid-column: 1/-1;"><i class="fas fa-layer-group"></i><p>No groups yet</p></div>';
                    return;
                }

                container.innerHTML = groups.map(g => `
                    <div class="speaker-card">
                        <div class="speaker-avatar" style="background: ${g.is_member ? 'var(--success)' : 'var(--forum)'};">
                            <i class="fas ${g.icon || 'fa-users'}"></i>
                        </div>
                        <div class="speaker-name">${this.escapeHtml(g.name)}</div>
                        <div class="speaker-title">${g.member_count || 0} members</div>
                        <div class="speaker-org">${this.escapeHtml(g.description || '')}</div>
                        <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; justify-content: center;">
                            <button class="btn ${g.is_member ? 'btn-secondary' : 'btn-primary'}" style="padding: 6px 12px;"
                                onclick="App.toggleGroupMembership('${g.id}', ${g.is_member})">
                                ${g.is_member ? 'Leave' : 'Join'}
                            </button>
                            <button class="btn btn-secondary" style="padding: 6px 12px;" onclick="App.inviteToForumGroup('${g.id}')" title="Invite member">
                                <i class="fas fa-user-plus"></i>
                            </button>
                            <button class="btn btn-secondary" style="padding: 6px 12px; color: var(--danger);" onclick="App.deleteForumGroup('${g.id}')" title="Delete group">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            async toggleGroupMembership(id, isMember) {
                try {
                    await this.api(`/api/forum/groups/${id}/membership`, {
                        method: 'POST',
                        body: JSON.stringify({ action: isMember ? 'leave' : 'join' })
                    });
                    await this.loadForumGroups();
                } catch (err) {
                    console.error('Failed to update membership:', err);
                    Toast.error('Failed to update group membership');
                }
            },

            async deleteForumGroup(id) {
                if (!confirm('Delete this group? This cannot be undone.')) return;
                try {
                    await this.api(`/api/admin/forum/groups/${id}`, { method: 'DELETE' });
                    await this.loadForumGroups();
                    Toast.success('Group deleted');
                } catch (err) {
                    console.error('Failed to delete group:', err);
                    Toast.error('Failed to delete group');
                }
            },

            async inviteToForumGroup(groupId) {
                const email = prompt('Enter member email to invite:');
                if (!email) return;
                try {
                    await this.api(`/api/admin/forum/groups/${groupId}/invite`, { method: 'POST', body: JSON.stringify({ email }) });
                    Toast.success('Invitation sent');
                } catch (err) {
                    console.error('Failed to invite member:', err);
                    Toast.error('Failed to invite member');
                }
            },

            openGroupModal() {
                const name = prompt('Group Name:');
                if (!name) return;

                const description = prompt('Description:');
                const category = prompt('Category (e.g., specialty, research, networking):');

                this.createForumGroup({ name, description, category });
            },

            async createForumGroup(data) {
                try {
                    await this.api('/api/admin/forum/groups', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                    await this.loadForumGroups();
                } catch (err) {
                    console.error('Failed to create group:', err);
                    Toast.error('Failed to create group');
                }
            },

            async loadForumGallery() {
                try {
                    const media = await this.api('/api/forum/media');
                    this.forumGallery = media || [];
                    await this.loadForumMediaFolders();
                    this.renderForumGalleryWithFolders();
                } catch (err) {
                    console.error('Failed to load gallery:', err);
                }
            },

            renderForumGallery(media) {
                this.forumGallery = media || [];
                this.renderForumGalleryWithFolders();
            },

            async loadForumMediaFolders() {
                try {
                    this.forumMediaFolders = await this.api('/api/admin/forum/media/folders') || [];
                } catch (e) { this.forumMediaFolders = []; }
            },

            async createMediaFolder() {
                const name = prompt('Folder name:');
                if (!name) return;
                try {
                    await this.api('/api/admin/forum/media/folders', {
                        method: 'POST',
                        body: JSON.stringify({ name, parent_id: this.forumCurrentFolder })
                    });
                    await this.loadForumMediaFolders();
                    this.renderForumGalleryWithFolders();
                    Toast.success('Folder created');
                } catch (err) {
                    Toast.error('Failed to create folder');
                }
            },

            async deleteMediaFolder(id) {
                if (!confirm('Delete this folder? Media inside will be moved to root.')) return;
                try {
                    await this.api(`/api/admin/forum/media/folders/${id}`, { method: 'DELETE' });
                    if (this.forumCurrentFolder === id) this.forumCurrentFolder = null;
                    await this.loadForumMediaFolders();
                    this.renderForumGalleryWithFolders();
                    Toast.success('Folder deleted');
                } catch (err) {
                    Toast.error('Failed to delete folder');
                }
            },

            navigateMediaFolder(folderId) {
                this.forumCurrentFolder = folderId;
                this.renderForumGalleryWithFolders();
            },

            renderForumGalleryWithFolders() {
                const container = document.getElementById('fmGalleryGrid');
                if (!container) return;

                const folders = this.forumMediaFolders || [];
                const media = this.forumGallery || [];
                const currentFolder = this.forumCurrentFolder;

                // Filter folders and media for current level
                const subfolders = folders.filter(f => f.parent_id === currentFolder);
                const currentMedia = media.filter(m => (m.folder_id || null) === currentFolder);

                let html = '';

                // Breadcrumb
                if (currentFolder) {
                    const folder = folders.find(f => f.id === currentFolder);
                    html += `<div style="grid-column: 1/-1; display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding: 8px; background: var(--bg-tertiary); border-radius: 8px;">
                        <button class="btn btn-secondary" onclick="App.navigateMediaFolder(null)" style="padding: 4px 8px;"><i class="fas fa-home"></i></button>
                        <i class="fas fa-chevron-right" style="font-size: 10px; color: var(--text-muted);"></i>
                        <span style="font-weight: 600;">${folder ? this.escapeHtml(folder.name) : 'Unknown'}</span>
                    </div>`;
                }

                // Folder grid
                if (subfolders.length > 0) {
                    subfolders.forEach(f => {
                        html += `<div style="aspect-ratio: 1; padding: 16px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center;" onclick="App.navigateMediaFolder('${f.id}')" oncontextmenu="event.preventDefault(); if(confirm('Delete folder: ${this.escapeHtml(f.name)}?')) App.deleteMediaFolder('${f.id}')">
                            <i class="fas fa-folder" style="font-size: 32px; color: var(--accent-gold); margin-bottom: 8px;"></i>
                            <div style="font-size: 12px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%;">${this.escapeHtml(f.name)}</div>
                        </div>`;
                    });
                }

                // Media grid items
                if (currentMedia.length > 0) {
                    currentMedia.forEach(m => {
                        html += `<div style="aspect-ratio: 1; background: var(--bg-tertiary); border-radius: 8px; overflow: hidden; cursor: pointer;" onclick="window.open('${m.file_url}', '_blank')">
                            ${m.media_type === 'image' ? `<img src="${m.thumbnail_url || m.file_url}" style="width: 100%; height: 100%; object-fit: cover;">` : `<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"><i class="fas fa-play-circle" style="font-size: 32px; color: var(--forum);"></i></div>`}
                        </div>`;
                    });
                }

                if (subfolders.length === 0 && currentMedia.length === 0) {
                    html += '<div class="table-empty" style="grid-column: 1/-1;"><i class="fas fa-images"></i><p>No media in this folder</p></div>';
                }

                container.innerHTML = html;
            },

            openMediaUpload() {
                alert('Media upload coming soon. For now, contact an admin to upload photos.');
            },

            fmMembGroupBy: 'none',
            fmMembFiltered: [],

            async loadForumMembers() {
                try {
                    const members = await this.api('/api/admin/forum/members');
                    this.forumMembers = members;
                    this.populateMemberFilterDropdowns(members);
                    this.updateMemberStats(members);
                    this.fmMembGroupBy = 'none';
                    document.querySelectorAll('#forum-members .px-group-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.group === 'none');
                    });
                    this.filterForumMembers();
                } catch (err) {
                    console.error('Failed to load members:', err);
                }
            },

            populateMemberFilterDropdowns(members) {
                // Specialties
                const specialties = [...new Set(members.map(m => m.specialty).filter(Boolean))].sort();
                const specSelect = document.getElementById('fmMemberSpecialty');
                if (specSelect) {
                    specSelect.innerHTML = '<option value="">All Specialties</option>' +
                        specialties.map(s => `<option value="${this.escapeHtml(s)}">${this.escapeHtml(s)}</option>`).join('');
                }
                // Countries
                const countries = [...new Set(members.map(m => m.country).filter(Boolean))].sort();
                const countrySelect = document.getElementById('fmMemberCountry');
                if (countrySelect) {
                    countrySelect.innerHTML = '<option value="">All Countries</option>' +
                        countries.map(c => `<option value="${this.escapeHtml(c)}">${this.escapeHtml(c)}</option>`).join('');
                }
                // Industries
                const industries = [...new Set(members.map(m => m.industry).filter(Boolean))].sort();
                const indSelect = document.getElementById('fmMemberIndustry');
                if (indSelect) {
                    indSelect.innerHTML = '<option value="">All Industries</option>' +
                        industries.map(i => `<option value="${this.escapeHtml(i)}">${this.escapeHtml(i)}</option>`).join('');
                }
            },

            updateMemberStats(members) {
                const total = members.length;
                const active = members.filter(m => m.membership_status === 'approved' || m.membership_status === 'active').length;
                const countries = new Set(members.map(m => m.country).filter(Boolean)).size;
                const specialties = new Set(members.map(m => m.specialty).filter(Boolean)).size;

                const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                setEl('fmMembStatTotal', total);
                setEl('fmMembStatActive', active);
                setEl('fmMembStatCountries', countries);
                setEl('fmMembStatSpecialties', specialties);
            },

            groupForumMembers(groupBy) {
                this.fmMembGroupBy = groupBy;
                document.querySelectorAll('#forum-members .px-group-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.group === groupBy);
                });
                this.filterForumMembers();
            },

            renderForumMembersTable(members) {
                const tbody = document.getElementById('fmMembersTableBody');
                const table = document.getElementById('fmMembersTable');
                const groupedContainer = document.getElementById('fmMembersGrouped');
                if (!tbody) return;

                // Show count
                const countEl = document.getElementById('fmMembersCount');
                if (countEl) countEl.textContent = `${members.length} member${members.length !== 1 ? 's' : ''}`;

                if (!members || members.length === 0) {
                    if (groupedContainer) groupedContainer.style.display = 'none';
                    if (table) table.style.display = '';
                    tbody.innerHTML = '<tr><td colspan="9" class="table-empty"><i class="fas fa-users"></i><p>No members found</p></td></tr>';
                    return;
                }

                if (this.fmMembGroupBy !== 'none') {
                    // Grouped view
                    if (table) table.style.display = 'none';
                    if (groupedContainer) groupedContainer.style.display = '';
                    const groups = {};
                    members.forEach(m => {
                        const key = m[this.fmMembGroupBy] || 'Unknown';
                        if (!groups[key]) groups[key] = [];
                        groups[key].push(m);
                    });
                    const sortedKeys = Object.keys(groups).sort();
                    groupedContainer.innerHTML = sortedKeys.map(key => `
                        <div class="fm-group-section">
                            <div class="fm-group-header" onclick="this.classList.toggle('collapsed'); this.nextElementSibling.classList.toggle('collapsed');">
                                <div>
                                    <span class="fm-group-header-title">${this.escapeHtml(key)}</span>
                                    <span class="fm-group-header-count">${groups[key].length}</span>
                                    <i class="fas fa-chevron-down fm-chevron"></i>
                                </div>
                            </div>
                            <div class="fm-group-body">
                                <table class="data-table" style="margin: 0;">
                                    <thead>
                                        <tr><th>Name</th><th>Email</th><th>Specialty</th><th>Institution</th><th>Country</th><th>Status</th><th>Actions</th></tr>
                                    </thead>
                                    <tbody>${groups[key].map(m => this.renderForumMemberRow(m)).join('')}</tbody>
                                </table>
                            </div>
                        </div>
                    `).join('');
                } else {
                    // Flat table view
                    if (groupedContainer) groupedContainer.style.display = 'none';
                    if (table) table.style.display = '';
                    tbody.innerHTML = members.map(m => this.renderForumMemberRow(m)).join('');
                }
            },

            renderForumMemberRow(m) {
                return `
                    <tr>
                        <td><strong>${this.escapeHtml(m.first_name || '')} ${this.escapeHtml(m.last_name || '')}</strong></td>
                        <td>${this.escapeHtml(m.email || '')}</td>
                        <td>${this.escapeHtml(m.specialty || '-')}</td>
                        <td>${this.escapeHtml(m.institution || '-')}</td>
                        <td>${this.escapeHtml(m.country || '-')}</td>
                        <td><span class="status ${m.membership_status === 'approved' || m.membership_status === 'active' ? 'paid' : m.membership_status === 'rejected' ? 'cancelled' : 'pending'}">${m.membership_status || 'Pending'}</span></td>
                        <td>${m.membership_level || 'member'}</td>
                        <td>${m.points || 0}</td>
                        <td class="actions">
                            <button onclick="App.viewForumMember('${m.id}')" title="View Profile"><i class="fas fa-eye"></i></button>
                            <button onclick="App.emailForumMember('${m.id}')" title="Email"><i class="fas fa-envelope"></i></button>
                            <button onclick="App.removeForumMember('${m.id}')" title="Remove" style="color: var(--danger);"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            },

            filterForumMembers() {
                const search = document.getElementById('fmMemberSearch')?.value.toLowerCase() || '';
                const specialty = document.getElementById('fmMemberSpecialty')?.value || '';
                const career = document.getElementById('fmMemberCareer')?.value || '';
                const country = document.getElementById('fmMemberCountry')?.value || '';
                const industry = document.getElementById('fmMemberIndustry')?.value || '';

                const filtered = this.forumMembers.filter(m => {
                    const matchSearch = !search ||
                        (m.first_name && m.first_name.toLowerCase().includes(search)) ||
                        (m.last_name && m.last_name.toLowerCase().includes(search)) ||
                        (m.email && m.email.toLowerCase().includes(search)) ||
                        (m.institution && m.institution.toLowerCase().includes(search)) ||
                        (m.bio && m.bio.toLowerCase().includes(search));
                    const matchSpec = !specialty || (m.specialty && m.specialty.includes(specialty));
                    const matchCareer = !career || m.career_stage === career;
                    const matchCountry = !country || m.country === country;
                    const matchIndustry = !industry || m.industry === industry;
                    return matchSearch && matchSpec && matchCareer && matchCountry && matchIndustry;
                });

                this.fmMembFiltered = filtered;
                this.renderForumMembersTable(filtered);
            },

            exportForumMembers() {
                const data = this.fmMembFiltered && this.fmMembFiltered.length > 0 ? this.fmMembFiltered : this.forumMembers;
                if (!data || data.length === 0) {
                    Toast.warning('No members to export');
                    return;
                }

                const headers = ['First Name', 'Last Name', 'Email', 'Specialty', 'Institution', 'Country', 'Industry', 'Status', 'Level', 'Points'];
                const rows = data.map(m => [
                    m.first_name || '', m.last_name || '', m.email || '', m.specialty || '',
                    m.institution || '', m.country || '', m.industry || '',
                    m.membership_status || '', m.membership_level || '', m.points || 0
                ]);

                const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${(c || '').toString().replace(/"/g, '""')}"`).join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `forum-members-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            },

            async loadForumApplications() {
                try {
                    const applications = await this.api('/api/admin/forum/applications');
                    this.forumApplications = applications;
                    this.renderForumApplications(applications);
                } catch (err) {
                    console.error('Failed to load applications:', err);
                }
            },

            renderForumApplications(applications) {
                const container = document.getElementById('fmApplicationsList');
                if (!container) return;

                if (!applications || applications.length === 0) {
                    container.innerHTML = '<div class="table-empty"><i class="fas fa-user-plus"></i><p>No pending applications</p></div>';
                    return;
                }

                container.innerHTML = applications.map(a => `
                    <div style="padding: 16px; background: var(--bg-tertiary); border-radius: 10px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="font-weight: 600; font-size: 16px;">${this.escapeHtml(a.first_name || '')} ${this.escapeHtml(a.last_name || '')}</div>
                                <div style="font-size: 13px; color: var(--text-secondary);">${this.escapeHtml(a.email || '')}</div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                                    ${a.specialty ? `<span style="margin-right: 12px;"><i class="fas fa-stethoscope"></i> ${a.specialty}</span>` : ''}
                                    ${a.institution ? `<span><i class="fas fa-building"></i> ${a.institution}</span>` : ''}
                                </div>
                            </div>
                            <div style="font-size: 11px; color: var(--text-muted);">
                                Applied ${a.application_submitted_at ? new Date(a.application_submitted_at).toLocaleDateString() : 'N/A'}
                            </div>
                        </div>
                        ${a.application_text ? `<div style="margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; font-size: 13px;">"${this.escapeHtml(a.application_text)}"</div>` : ''}
                        <div style="display: flex; gap: 8px; margin-top: 12px;">
                            <button class="btn btn-primary" style="padding: 8px 16px;" onclick="App.approveForumApplication('${a.id}')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-secondary" style="padding: 8px 16px;" onclick="App.rejectForumApplication('${a.id}')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            async approveForumApplication(id) {
                try {
                    await this.api(`/api/admin/forum/applications/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'approved' })
                    });
                    await this.loadForumApplications();
                    await this.loadForumStats();
                } catch (err) {
                    console.error('Failed to approve:', err);
                    Toast.error('Failed to approve application');
                }
            },

            async rejectForumApplication(id) {
                const reason = prompt('Rejection reason (optional):');
                try {
                    await this.api(`/api/admin/forum/applications/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'rejected', rejection_reason: reason })
                    });
                    await this.loadForumApplications();
                    await this.loadForumStats();
                } catch (err) {
                    console.error('Failed to reject:', err);
                    Toast.error('Failed to reject application');
                }
            },

            escapeHtml(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
        };

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.onclick = function(e) {
                if (e.target === this) this.classList.remove('active');
            };
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            // Close quick action dropdown
            const quickDropdown = document.getElementById('quickActionDropdown');
            if (quickDropdown && !e.target.closest('.quick-action-btn') && !e.target.closest('.quick-action-dropdown')) {
                quickDropdown.classList.remove('active');
            }

            // Close search results
            const searchResults = document.getElementById('searchResults');
            if (searchResults && !e.target.closest('.search-wrapper')) {
                searchResults.classList.remove('active');
            }
        });

        // Handle browser back/forward navigation
        window.addEventListener('popstate', (e) => App.handlePopState(e));

        // ========== ACCELERATOR APP ==========
        const AcceleratorApp = {
            currentYear: 2026,
            years: [2026],
            institutions: [],
            applications: [],
            criteria: [],
            interviewers: [],
            currentApplication: null,

            // Toast notification helper for accelerator section
            showAccToast(message, type = 'info') {
                const colors = { success: '#22c55e', error: '#ef4444', warning: '#f59e0b', info: '#22d3ee' };
                const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
                const toast = document.createElement('div');
                toast.setAttribute('role', 'alert');
                toast.style.cssText = `position: fixed; top: 20px; right: 20px; z-index: 100000; display: flex; align-items: center; gap: 10px; padding: 14px 20px; background: var(--bg-secondary); border: 1px solid ${colors[type] || colors.info}; border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.3); color: var(--text-primary); font-size: 14px; animation: fadeInDown 0.3s ease;`;
                toast.innerHTML = `<i class="fas ${icons[type] || icons.info}" style="color: ${colors[type] || colors.info};"></i> ${message}`;
                document.body.appendChild(toast);
                setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 3000);
            },

            // Loading state helper for buttons
            setButtonLoading(btn, loading, originalHtml = '') {
                if (loading) {
                    btn._origHtml = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                } else {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml || btn._origHtml || '';
                }
            },

            async init() {
                await this.loadYears();
                await this.loadYear(this.currentYear);
            },

            async api(endpoint, options = {}) {
                const res = await fetch(endpoint, {
                    ...options,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.token}`, ...options.headers }
                });
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.error || `Request failed (${res.status})`);
                }
                return res.json();
            },

            showTab(tab) {
                document.querySelectorAll('.acc-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.acc-content').forEach(c => c.classList.remove('active'));
                document.querySelector(`.acc-tab[onclick*="'${tab}'"]`)?.classList.add('active');
                document.getElementById(`acc-${tab}`)?.classList.add('active');

                if (tab === 'overview') this.loadOverviewConfig();
                if (tab === 'dates') this.loadKeyDates();
                if (tab === 'institutions') this.loadInstitutions();
                if (tab === 'apply') { this.formEditMode = false; this.loadFormConfig().then(() => this.renderFormPreview()); }
                if (tab === 'applications') this.loadApplications();
                if (tab === 'evaluation') { this.loadCriteria(); this.loadApplicationsForEval(); }
                if (tab === 'interviewers') this.loadInterviewers();
                if (tab === 'ranking') this.loadRanking();
                if (tab === 'files') this.loadGroupedFiles();
            },

            async loadYears() {
                this.years = await this.api('/api/accelerator/years');
                if (this.years.length === 0) this.years = [2026];
                const sel = document.getElementById('accYearSelect');
                sel.innerHTML = this.years.map(y => `<option value="${y}">${y}</option>`).join('');
            },

            async loadYear(year) {
                this.currentYear = parseInt(year);
                document.getElementById('accYearSelect').value = year;
                document.getElementById('accYearSubtitle').textContent = `Research internship program ${year}`;
                document.getElementById('accDatesYear').textContent = year;
                document.getElementById('accInstYear').textContent = year;
                document.getElementById('accAppsYear').textContent = year;
                document.getElementById('accIntYear').textContent = year;

                await Promise.all([
                    this.loadInstitutions(),
                    this.loadApplications(),
                    this.loadKeyDates(),
                    this.loadOverviewConfig()
                ]);
                this.updateStats();
            },

            async addYear() {
                const year = prompt('Enter year (e.g., 2027):');
                if (!year || isNaN(year)) return;
                await this.api('/api/accelerator/years', { method: 'POST', body: JSON.stringify({ year: parseInt(year) }) });
                await this.loadYears();
                this.loadYear(year);
            },

            updateStats() {
                document.getElementById('accStatApps').textContent = this.applications.length;
                document.getElementById('accStatReview').textContent = this.applications.filter(a => a.status === 'submitted').length;
                document.getElementById('accStatValid').textContent = this.applications.filter(a => a.validity_status === 'valid').length;
                document.getElementById('accStatInstitutions').textContent = this.institutions.length;
            },

            // OVERVIEW CONFIG — Admin-editable overview page values
            async loadOverviewConfig() {
                try {
                    const cfg = await this.api(`/api/admin/accelerator/overview-config?year=${this.currentYear}`);
                    document.getElementById('accCfgDeadline').value = cfg.applicationDeadline || '';
                    document.getElementById('accCfgDuration').value = cfg.programDuration || '';
                    document.getElementById('accCfgLabs').value = cfg.labsCount || '';
                    document.getElementById('accCfgPositions').value = cfg.positionsRange || '';
                    document.getElementById('accCfgAbout').value = cfg.aboutProgram || '';
                } catch (err) {
                    console.error('Failed to load overview config:', err);
                }
            },

            async saveOverviewConfig() {
                const btn = document.getElementById('accOverviewSaveBtn');
                this.setButtonLoading(btn, true);
                try {
                    await this.api('/api/admin/accelerator/overview-config', {
                        method: 'PUT',
                        body: JSON.stringify({
                            year: this.currentYear,
                            applicationDeadline: document.getElementById('accCfgDeadline').value,
                            programDuration: document.getElementById('accCfgDuration').value,
                            labsCount: document.getElementById('accCfgLabs').value,
                            positionsRange: document.getElementById('accCfgPositions').value,
                            aboutProgram: document.getElementById('accCfgAbout').value
                        })
                    });
                    this.showAccToast('Overview config saved successfully', 'success');
                } catch (err) {
                    this.showAccToast('Failed to save: ' + err.message, 'error');
                } finally {
                    this.setButtonLoading(btn, false, '<i class="fas fa-save"></i> Save');
                }
            },

            // KEY DATES — Enhanced with inline editing, categories, milestone markers, status indicators
            _keyDates: [],

            async loadKeyDates() {
                this._keyDates = await this.api(`/api/accelerator/years/${this.currentYear}/dates`);
                this.renderKeyDatesList(this._keyDates);
                this.renderDatesTimeline(this._keyDates);
            },

            renderKeyDatesList(dates) {
                const container = document.getElementById('accKeyDatesList');
                if (!dates.length) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No key dates. Click "Add Date" to create the first one.</p>';
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const sortedDates = [...dates].sort((a, b) => new Date(a.date_start) - new Date(b.date_start));
                let foundNext = false;
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                let html = '<div class="akd-timeline">';
                sortedDates.forEach(d => {
                    const dateObj = new Date(d.date_start + 'T00:00:00');
                    const endObj = d.date_end ? new Date(d.date_end + 'T00:00:00') : null;
                    const isPast = endObj ? endObj < today : dateObj < today;
                    const isToday = dateObj.getTime() === today.getTime() || (endObj && dateObj <= today && today <= endObj);
                    const isNext = !isPast && !isToday && !foundNext;
                    if (isNext) foundNext = true;

                    const cat = d.category || 'event';
                    const isMilestone = cat === 'milestone';
                    const statusClass = isToday ? 'today' : (isPast ? 'past' : (isNext ? 'next' : ''));
                    const monthDay = `${monthNames[dateObj.getMonth()]} ${dateObj.getDate()}`;
                    const dateRange = endObj && d.date_end !== d.date_start
                        ? `${monthDay} - ${monthNames[endObj.getMonth()]} ${endObj.getDate()}`
                        : monthDay;

                    const eName = (d.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const eDesc = (d.description || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

                    html += `
                        <div class="akd-item cat-${cat} ${statusClass}" data-id="${d.id}">
                            <div class="akd-marker ${isMilestone ? 'diamond' : ''}" style="background: ${d.color || '#22d3ee'};"></div>
                            <div class="akd-content">
                                <div class="akd-date" onclick="AcceleratorApp.inlineEditDate('${d.id}', '${d.date_start}', '${d.date_end || ''}', this)">${dateRange}</div>
                                <div class="akd-name" onclick="AcceleratorApp.inlineEditText('${d.id}', 'name', '${eName}', this)">${d.name}</div>
                                ${d.description ? `<div class="akd-desc" onclick="AcceleratorApp.inlineEditText('${d.id}', 'description', '${eDesc}', this)">${d.description}</div>` : `<div class="akd-desc" style="font-style: italic; opacity: 0.5;" onclick="AcceleratorApp.inlineEditText('${d.id}', 'description', '', this)">Click to add description</div>`}
                            </div>
                            <div class="akd-badges">
                                ${isToday ? '<span class="akd-badge today-badge">Today</span>' : ''}
                                ${isNext ? '<span class="akd-badge next-badge">Next</span>' : ''}
                                <span class="akd-badge cat-badge-${cat}" style="cursor: pointer;" onclick="AcceleratorApp.cycleCategory('${d.id}', '${cat}')" title="Click to change category">${cat}</span>
                            </div>
                            <div class="akd-actions">
                                <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="AcceleratorApp.editKeyDateModal('${d.id}')" title="Edit all fields"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="AcceleratorApp.deleteKeyDate('${d.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            },

            inlineEditText(id, field, currentValue, el) {
                if (el.querySelector('input')) return;
                const original = el.innerHTML;
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'akd-inline-input';
                input.value = currentValue;
                input.style.fontWeight = field === 'name' ? '600' : 'normal';
                input.style.fontSize = field === 'name' ? '14px' : '12px';
                el.innerHTML = '';
                el.appendChild(input);
                input.focus();
                input.select();

                const save = async () => {
                    const newVal = input.value.trim();
                    if (newVal !== currentValue && newVal !== '') {
                        await this.api(`/api/accelerator/dates/${id}`, {
                            method: 'PUT', body: JSON.stringify({ [field]: newVal })
                        });
                        this.loadKeyDates();
                    } else {
                        el.innerHTML = original;
                    }
                };

                input.addEventListener('blur', save);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
                    if (e.key === 'Escape') { input.removeEventListener('blur', save); el.innerHTML = original; }
                });
            },

            inlineEditDate(id, dateStart, dateEnd, el) {
                if (el.querySelector('input')) return;
                const original = el.innerHTML;
                const wrapper = document.createElement('div');
                wrapper.style.cssText = 'display: flex; gap: 6px; align-items: center;';
                const startInput = document.createElement('input');
                startInput.type = 'date';
                startInput.className = 'akd-inline-input';
                startInput.value = dateStart;
                startInput.style.fontSize = '11px';
                startInput.style.width = '130px';
                wrapper.appendChild(startInput);

                const dash = document.createElement('span');
                dash.textContent = '-';
                dash.style.color = 'var(--text-muted)';
                wrapper.appendChild(dash);

                const endInput = document.createElement('input');
                endInput.type = 'date';
                endInput.className = 'akd-inline-input';
                endInput.value = dateEnd || '';
                endInput.style.fontSize = '11px';
                endInput.style.width = '130px';
                endInput.placeholder = 'End (optional)';
                wrapper.appendChild(endInput);

                el.innerHTML = '';
                el.appendChild(wrapper);
                startInput.focus();

                const save = async () => {
                    const newStart = startInput.value;
                    const newEnd = endInput.value;
                    if (newStart && (newStart !== dateStart || newEnd !== dateEnd)) {
                        await this.api(`/api/accelerator/dates/${id}`, {
                            method: 'PUT', body: JSON.stringify({ date_start: newStart, date_end: newEnd || null })
                        });
                        this.loadKeyDates();
                    } else {
                        el.innerHTML = original;
                    }
                };

                let blurTimeout;
                const handleBlur = () => {
                    clearTimeout(blurTimeout);
                    blurTimeout = setTimeout(() => {
                        if (!wrapper.contains(document.activeElement)) save();
                    }, 150);
                };
                startInput.addEventListener('blur', handleBlur);
                endInput.addEventListener('blur', handleBlur);

                const handleKey = (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); save(); }
                    if (e.key === 'Escape') {
                        startInput.removeEventListener('blur', handleBlur);
                        endInput.removeEventListener('blur', handleBlur);
                        el.innerHTML = original;
                    }
                };
                startInput.addEventListener('keydown', handleKey);
                endInput.addEventListener('keydown', handleKey);
            },

            async cycleCategory(id, current) {
                const cats = ['event', 'deadline', 'milestone'];
                const next = cats[(cats.indexOf(current) + 1) % cats.length];
                const colorMap = { event: '#22d3ee', deadline: '#ef4444', milestone: '#c9a962' };
                await this.api(`/api/accelerator/dates/${id}`, {
                    method: 'PUT', body: JSON.stringify({ category: next, color: colorMap[next] })
                });
                this.loadKeyDates();
            },

            renderDatesTimeline(dates) {
                const container = document.getElementById('accDatesTimeline');
                if (!dates.length) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No dates to display.</p>';
                    const preview = document.getElementById('accTimelinePreview');
                    if (preview) preview.innerHTML = '<p style="color: var(--text-muted);">No dates to display.</p>';
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const sortedDates = [...dates].sort((a, b) => new Date(a.date_start) - new Date(b.date_start));
                let foundNext = false;
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                let html = '<div class="akd-timeline">';
                sortedDates.forEach(d => {
                    const dateObj = new Date(d.date_start + 'T00:00:00');
                    const endObj = d.date_end ? new Date(d.date_end + 'T00:00:00') : null;
                    const isPast = endObj ? endObj < today : dateObj < today;
                    const isToday = dateObj.getTime() === today.getTime() || (endObj && dateObj <= today && today <= endObj);
                    const isNext = !isPast && !isToday && !foundNext;
                    if (isNext) foundNext = true;

                    const cat = d.category || 'event';
                    const isMilestone = cat === 'milestone';
                    const statusClass = isToday ? 'today' : (isPast ? 'past' : (isNext ? 'next' : ''));
                    const monthDay = `${monthNames[dateObj.getMonth()]} ${dateObj.getDate()}`;

                    html += `
                        <div class="akd-item cat-${cat} ${statusClass}">
                            <div class="akd-marker ${isMilestone ? 'diamond' : ''}" style="background: ${d.color || '#22d3ee'};"></div>
                            <div class="akd-content">
                                <div class="akd-date">${monthDay}</div>
                                <div class="akd-name">${d.name}</div>
                                ${d.description ? `<div class="akd-desc">${d.description}</div>` : ''}
                            </div>
                            ${isToday ? '<span class="akd-badge today-badge">Today</span>' : ''}
                            ${isNext ? '<span class="akd-badge next-badge">Next</span>' : ''}
                        </div>
                    `;
                });
                html += '</div>';

                container.innerHTML = html;
                const preview = document.getElementById('accTimelinePreview');
                if (preview) preview.innerHTML = html;
            },

            async addKeyDate() {
                const name = prompt('Period name (e.g., "Applications Open"):');
                if (!name) return;
                const date_start = prompt('Start Date (YYYY-MM-DD):');
                if (!date_start) return;
                const date_end = prompt('End Date (optional, YYYY-MM-DD):', '');
                const description = prompt('Description (optional):', '');
                const catInput = prompt('Category (event / deadline / milestone):', 'event');
                const category = ['event', 'deadline', 'milestone'].includes(catInput) ? catInput : 'event';
                const colorMap = { event: '#22d3ee', deadline: '#ef4444', milestone: '#c9a962' };

                await this.api(`/api/accelerator/years/${this.currentYear}/dates`, {
                    method: 'POST', body: JSON.stringify({ name, date_start, date_end: date_end || null, description, category, color: colorMap[category] })
                });
                this.loadKeyDates();
            },

            async editKeyDateModal(id) {
                const d = this._keyDates.find(x => x.id === id);
                if (!d) return;
                const newName = prompt('Name:', d.name);
                if (!newName) return;
                const newStart = prompt('Start Date:', d.date_start);
                const newEnd = prompt('End Date:', d.date_end || '');
                const newDesc = prompt('Description:', d.description || '');
                const catInput = prompt('Category (event / deadline / milestone):', d.category || 'event');
                const category = ['event', 'deadline', 'milestone'].includes(catInput) ? catInput : (d.category || 'event');
                const colorMap = { event: '#22d3ee', deadline: '#ef4444', milestone: '#c9a962' };

                await this.api(`/api/accelerator/dates/${id}`, {
                    method: 'PUT', body: JSON.stringify({ name: newName, date_start: newStart, date_end: newEnd || null, description: newDesc, category, color: colorMap[category] })
                });
                this.loadKeyDates();
            },

            async deleteKeyDate(id) {
                if (!confirm('Delete this date?')) return;
                await this.api(`/api/accelerator/dates/${id}`, { method: 'DELETE' });
                this.loadKeyDates();
            },

            // INSTITUTIONS
            async loadInstitutions() {
                this.institutions = await this.api(`/api/accelerator/years/${this.currentYear}/institutions`);
                const container = document.getElementById('accInstitutionsList');

                // Update filter dropdowns
                const instSelect = document.getElementById('accAppsInst');
                const rankSelect = document.getElementById('accRankInst');
                const opts = '<option value="">All Institutions</option>' + this.institutions.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
                if (instSelect) instSelect.innerHTML = opts;
                if (rankSelect) rankSelect.innerHTML = opts;

                if (this.institutions.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No institutions. Add the first institution.</p>';
                    return;
                }

                container.innerHTML = this.institutions.map(inst => `
                    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 10px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="margin: 0 0 4px 0;">${inst.name}</h4>
                                <p style="margin: 0; font-size: 12px; color: var(--text-muted);">${inst.city || ''}, ${inst.country || ''}</p>
                            </div>
                            <span style="background: ${inst.program_type === 'clinical' ? '#f472b6' : '#22d3ee'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px;">
                                ${inst.program_type === 'clinical' ? 'Clinical' : 'Scientific'}
                            </span>
                        </div>
                        <div style="margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                            <div><i class="fas fa-users" style="width: 20px; color: var(--text-muted);"></i> ${inst.available_spots || '-'} spots</div>
                            <div><i class="fas fa-clock" style="width: 20px; color: var(--text-muted);"></i> ${inst.internship_duration || '-'}</div>
                        </div>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <button class="btn btn-secondary" style="flex: 1; font-size: 12px;" onclick="AcceleratorApp.showInstitutionDetails('${inst.id}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            <button class="btn btn-secondary" style="font-size: 12px;" onclick="AcceleratorApp.editInstitution('${inst.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            },

            showInstitutionDetails(instId) {
                const inst = this.institutions.find(i => i.id === instId);
                if (!inst) return;

                const programBadge = inst.program_type ?
                    `<span style="background: ${inst.program_type === 'clinical' ? '#f472b6' : '#22d3ee'}; color: white; padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500;">
                        ${inst.program_type}
                    </span>` : '';

                document.getElementById('accInstModalTitle').innerHTML = `${inst.name} ${programBadge}`;
                document.getElementById('accInstModalBody').innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Basic Info -->
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--accent-primary);">${inst.available_spots || '-'}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Student Spots</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--accent-gold);">${inst.internship_duration || '-'}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Program Duration</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 14px; font-weight: 600;">${inst.city || '-'}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${inst.country || '-'}</div>
                            </div>
                        </div>

                        <!-- Mentors Section -->
                        <div style="padding: 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-user-tie" style="color: var(--accent-primary);"></i> Mentors
                            </h4>
                            <p style="margin: 0; font-size: 13px; line-height: 1.6; white-space: pre-line;">${inst.mentors || 'Mentor information not yet available.'}</p>
                        </div>

                        <!-- Visa Requirements -->
                        <div style="padding: 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-passport" style="color: #f59e0b;"></i> Visa Requirements
                            </h4>
                            <p style="margin: 0; font-size: 13px; line-height: 1.6; white-space: pre-line;">${inst.visa_requirements || 'Visa requirements information not yet available.'}</p>
                        </div>

                        <!-- Accommodation & Stipend -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div style="padding: 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                                <h4 style="margin: 0 0 8px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-home" style="color: #22c55e;"></i> Accommodation
                                </h4>
                                <p style="margin: 0; font-size: 13px; line-height: 1.6; white-space: pre-line;">${inst.accommodation_info || 'Not specified'}</p>
                            </div>
                            <div style="padding: 16px; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                                <h4 style="margin: 0 0 8px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-euro-sign" style="color: #6366f1;"></i> Stipend
                                </h4>
                                <p style="margin: 0; font-size: 13px; line-height: 1.6; white-space: pre-line;">${inst.stipend_info || 'Not specified'}</p>
                            </div>
                        </div>

                        <!-- Contact -->
                        <div style="padding: 16px; background: linear-gradient(135deg, rgba(34, 211, 238, 0.1), rgba(34, 211, 238, 0.05)); border-radius: 8px; border: 1px solid rgba(34, 211, 238, 0.3);">
                            <h4 style="margin: 0 0 8px 0; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-address-card" style="color: var(--accent-primary);"></i> Kontakt
                            </h4>
                            <div style="font-size: 13px;">
                                ${inst.contact_person ? `<div><strong>Osoba:</strong> ${inst.contact_person}</div>` : ''}
                                ${inst.contact_email ? `<div><strong>Email:</strong> <a href="mailto:${inst.contact_email}">${inst.contact_email}</a></div>` : ''}
                                ${inst.website_url ? `<div style="margin-top: 8px;"><a href="${inst.website_url}" target="_blank" class="btn btn-secondary" style="font-size: 12px;"><i class="fas fa-external-link-alt"></i> Posjeti web stranicu</a></div>` : ''}
                            </div>
                        </div>

                        <!-- Edit Button -->
                        <div style="display: flex; justify-content: flex-end; padding-top: 8px; border-top: 1px solid var(--border-color);">
                            <button class="btn btn-primary" onclick="AcceleratorApp.closeInstModal(); AcceleratorApp.editInstitution('${inst.id}');">
                                <i class="fas fa-edit"></i> Edit detalje
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('accInstModal').style.display = 'flex';
            },

            closeInstModal() {
                document.getElementById('accInstModal').style.display = 'none';
            },

            async addInstitution() {
                const name = prompt('Institution name:');
                if (!name) return;
                const city = prompt('City:');
                const country = prompt('Country:');

                const result = await this.api('/api/accelerator/institutions', {
                    method: 'POST', body: JSON.stringify({ name, city, country })
                });

                // Refresh the institutions list first so the edit modal has the new data
                await this.loadInstitutions();

                if (result.id) {
                    this.openInstEditModal(result.id);
                }
            },

            async editInstitution(instId) {
                this.openInstEditModal(instId);
            },

            openInstEditModal(instId) {
                const inst = this.institutions.find(i => i.id === instId) || {};

                document.getElementById('accInstEditId').value = instId;
                document.getElementById('accInstEditTitle').textContent = `Edit: ${inst.name || 'New Institution'}`;
                document.getElementById('accInstEditName').value = inst.name || '';
                document.getElementById('accInstEditWebsite').value = inst.website_url || '';
                document.getElementById('accInstEditLogo').value = inst.logo_url || '';
                document.getElementById('accInstEditDescription').value = inst.description || '';
                const logoPreview = document.getElementById('accInstLogoPreview');
                if (logoPreview) {
                    logoPreview.innerHTML = inst.logo_url ? `<img src="${inst.logo_url}" style="max-height: 60px; border-radius: 8px; border: 1px solid var(--border-color);">` : '';
                }
                document.getElementById('accInstEditProgramType').value = inst.program_type || '';
                document.getElementById('accInstEditSpots').value = inst.available_spots || '';
                document.getElementById('accInstEditDuration').value = inst.internship_duration || '';
                document.getElementById('accInstEditMentors').value = inst.mentors || '';
                document.getElementById('accInstEditVisa').value = inst.visa_requirements || '';
                document.getElementById('accInstEditAccommodation').value = inst.accommodation_info || '';
                document.getElementById('accInstEditStipend').value = inst.stipend_info || '';
                document.getElementById('accInstEditContactPerson').value = inst.contact_person || '';
                document.getElementById('accInstEditContactEmail').value = inst.contact_email || '';

                document.getElementById('accInstEditModal').style.display = 'flex';
            },

            closeInstEditModal() {
                document.getElementById('accInstEditModal').style.display = 'none';
            },

            async saveInstitutionDetails(event) {
                event.preventDefault();

                const instId = document.getElementById('accInstEditId').value;
                const detailsData = {
                    program_type: document.getElementById('accInstEditProgramType').value,
                    available_spots: parseInt(document.getElementById('accInstEditSpots').value) || 0,
                    internship_duration: document.getElementById('accInstEditDuration').value,
                    mentors: document.getElementById('accInstEditMentors').value,
                    visa_requirements: document.getElementById('accInstEditVisa').value,
                    accommodation_info: document.getElementById('accInstEditAccommodation').value,
                    stipend_info: document.getElementById('accInstEditStipend').value,
                    contact_person: document.getElementById('accInstEditContactPerson').value,
                    contact_email: document.getElementById('accInstEditContactEmail').value
                };

                // Base institution fields
                const baseData = {
                    name: document.getElementById('accInstEditName').value,
                    website_url: document.getElementById('accInstEditWebsite').value,
                    logo_url: document.getElementById('accInstEditLogo').value,
                    description: document.getElementById('accInstEditDescription').value
                };

                const btn = event.target.querySelector('button[type="submit"]');
                this.setButtonLoading(btn, true);

                try {
                    // Save base institution fields
                    await this.api(`/api/accelerator/institutions/${instId}`, {
                        method: 'PUT',
                        body: JSON.stringify(baseData)
                    });
                    // Save year-specific details
                    await this.api(`/api/accelerator/years/${this.currentYear}/institutions/${instId}`, {
                        method: 'PUT',
                        body: JSON.stringify(detailsData)
                    });
                    this.closeInstEditModal();
                    await this.loadInstitutions();
                    this.showAccToast('Institution saved!', 'success');
                } catch (err) {
                    this.showAccToast('Error saving institution: ' + err.message, 'error');
                } finally {
                    this.setButtonLoading(btn, false);
                }
            },

            // APPLICATIONS (Phase 4D: Enhanced Filtering/Grouping/Sorting)
            accAppsSortCol: null,
            accAppsSortDir: 'asc',
            accAppsGroupBy: 'none',
            accAppsFiltered: [],

            async loadApplications() {
                this.applications = await this.api(`/api/accelerator/years/${this.currentYear}/applications`);
                this.accAppsSortCol = null;
                this.accAppsSortDir = 'asc';
                this.accAppsGroupBy = 'none';
                // Reset group-by buttons
                document.querySelectorAll('#acc-applications .px-group-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.group === 'none');
                });
                this.filterApplications();
                this.updateStats();
                this.updateAppsSummaryStats();
            },

            updateAppsSummaryStats() {
                const apps = this.applications || [];
                const el = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
                el('accAppsStatTotal', apps.length);
                el('accAppsStatPending', apps.filter(a => a.status === 'submitted' && !a.validity_status).length);
                el('accAppsStatValid', apps.filter(a => a.validity_status === 'valid').length);
                el('accAppsStatInvalid', apps.filter(a => a.validity_status === 'invalid').length);
                const scored = apps.filter(a => a.total_score != null && a.total_score > 0);
                el('accAppsStatAvgScore', scored.length > 0 ? (scored.reduce((s, a) => s + a.total_score, 0) / scored.length).toFixed(1) : '-');
            },

            filterApplications() {
                const search = document.getElementById('accAppsSearch')?.value?.toLowerCase() || '';
                const status = document.getElementById('accAppsStatus')?.value || '';
                const inst = document.getElementById('accAppsInst')?.value || '';
                const programType = document.getElementById('accAppsProgramType')?.value || '';
                const scoreRange = document.getElementById('accAppsScoreRange')?.value || '';

                let filtered = this.applications || [];
                if (search) {
                    filtered = filtered.filter(a =>
                        (a.first_name + ' ' + a.last_name).toLowerCase().includes(search) ||
                        a.email?.toLowerCase().includes(search) ||
                        a.application_number?.toLowerCase().includes(search) ||
                        (a.candidate_id || '').toLowerCase().includes(search)
                    );
                }
                if (status) {
                    if (status === 'valid' || status === 'invalid') {
                        filtered = filtered.filter(a => a.validity_status === status);
                    } else if (status === 'accepted' || status === 'rejected') {
                        filtered = filtered.filter(a => a.decision === status);
                    } else {
                        filtered = filtered.filter(a => a.status === status);
                    }
                }
                if (inst) filtered = filtered.filter(a => a.selected_institution === inst);
                if (programType) {
                    filtered = filtered.filter(a => {
                        const instObj = this.institutions.find(i => i.id === a.selected_institution);
                        return (instObj?.program_type || a.program_type) === programType;
                    });
                }
                if (scoreRange) {
                    const [lo, hi] = scoreRange.split('-').map(Number);
                    filtered = filtered.filter(a => {
                        if (a.total_score == null) return false;
                        const pct = (a.total_score / 100) * 100; // score as percent
                        return pct >= lo && pct <= hi;
                    });
                }

                // Apply sorting
                if (this.accAppsSortCol) {
                    filtered = this.applySortApps(filtered);
                }

                this.accAppsFiltered = filtered;
                this.renderApplicationsTable(filtered);
            },

            clearAppFilters() {
                ['accAppsSearch', 'accAppsStatus', 'accAppsInst', 'accAppsProgramType', 'accAppsScoreRange'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                this.filterApplications();
            },

            sortApplications(col) {
                if (this.accAppsSortCol === col) {
                    this.accAppsSortDir = this.accAppsSortDir === 'asc' ? 'desc' : 'asc';
                } else {
                    this.accAppsSortCol = col;
                    this.accAppsSortDir = 'asc';
                }
                document.querySelectorAll('[id^="accAppSort-"]').forEach(el => el.textContent = '');
                const icon = document.getElementById(`accAppSort-${col}`);
                if (icon) icon.textContent = this.accAppsSortDir === 'asc' ? ' \u2191' : ' \u2193';
                this.filterApplications();
            },

            applySortApps(arr) {
                const col = this.accAppsSortCol;
                const dir = this.accAppsSortDir === 'asc' ? 1 : -1;
                return [...arr].sort((a, b) => {
                    let va, vb;
                    if (col === 'name') {
                        va = (a.first_name + ' ' + a.last_name).toLowerCase();
                        vb = (b.first_name + ' ' + b.last_name).toLowerCase();
                    } else if (col === 'total_score') {
                        va = a.total_score || 0;
                        vb = b.total_score || 0;
                        return (va - vb) * dir;
                    } else if (col === 'index') {
                        return 0; // natural order
                    } else {
                        va = (a[col] || '').toString().toLowerCase();
                        vb = (b[col] || '').toString().toLowerCase();
                    }
                    if (va < vb) return -1 * dir;
                    if (va > vb) return 1 * dir;
                    return 0;
                });
            },

            groupApplications(groupBy) {
                this.accAppsGroupBy = groupBy;
                document.querySelectorAll('#acc-applications .px-group-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.group === groupBy);
                });
                this.filterApplications();
            },

            getAppGroupKey(app, groupBy) {
                if (groupBy === 'status') {
                    if (app.validity_status === 'valid') return 'Valid';
                    if (app.validity_status === 'invalid') return 'Invalid';
                    if (app.status === 'submitted') return 'Submitted';
                    if (app.status === 'draft') return 'Draft';
                    return app.status || 'Unknown';
                }
                if (groupBy === 'institution') {
                    return this.institutions.find(i => i.id === app.selected_institution)?.name || app.current_institution || 'Unknown';
                }
                if (groupBy === 'program_type') {
                    const instObj = this.institutions.find(i => i.id === app.selected_institution);
                    const pt = instObj?.program_type || app.program_type;
                    return pt === 'clinical' ? 'Clinical' : pt === 'scientific' ? 'Scientific' : 'Unknown';
                }
                return 'All';
            },

            renderAppRow(app, idx) {
                const instName = this.institutions.find(i => i.id === app.selected_institution)?.short_name || app.selected_institution || '-';
                const programType = this.institutions.find(i => i.id === app.selected_institution)?.program_type || app.program_type || '-';
                const statusBadge = {
                    draft: '<span style="background: #6b7280; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">Draft</span>',
                    submitted: '<span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">Submitted</span>',
                }[app.status] || '';
                const validityBadge = app.validity_status === 'valid'
                    ? '<span style="background: #22c55e; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">Valid</span>'
                    : app.validity_status === 'invalid'
                    ? '<span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">Invalid</span>'
                    : '';
                const scoreDisplay = app.total_score != null ? app.total_score.toFixed(1) : '-';

                return `<tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 10px;">${idx + 1}</td>
                    <td style="padding: 10px; font-weight: 600; font-family: monospace;">${app.candidate_id || app.work_number || '-'}</td>
                    <td style="padding: 10px;">${app.first_name} ${app.last_name}</td>
                    <td style="padding: 10px;">${app.current_institution || '-'}</td>
                    <td style="padding: 10px;">${app.year_of_study || '-'}</td>
                    <td style="padding: 10px;">${programType}<br><small>${instName}</small></td>
                    <td style="padding: 10px;">${statusBadge} ${validityBadge}</td>
                    <td style="padding: 10px; text-align: center;">${scoreDisplay}</td>
                    <td style="padding: 10px; text-align: center;">
                        <button class="btn btn-secondary" style="padding: 4px 8px; margin: 2px;" onclick="AcceleratorApp.viewApplication('${app.id}')" title="View"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-secondary" style="padding: 4px 8px; margin: 2px;" onclick="AcceleratorApp.messageCandidate('${app.id}')" title="Message"><i class="fas fa-envelope"></i></button>
                        <button class="btn btn-secondary" style="padding: 4px 8px; margin: 2px;" onclick="AcceleratorApp.setValidity('${app.id}')" title="Validity"><i class="fas fa-check-circle"></i></button>
                        <button class="btn btn-secondary" style="padding: 4px 8px; margin: 2px;" onclick="AcceleratorApp.downloadDocs('${app.id}')" title="Download"><i class="fas fa-download"></i></button>
                    </td>
                </tr>`;
            },

            renderApplicationsTable(filtered) {
                filtered = filtered || this.accAppsFiltered || this.applications || [];
                const tbody = document.getElementById('accApplicationsTable');
                const table = document.getElementById('accAppsTable');
                const groupedContainer = document.getElementById('accAppsGroupedContainer');

                if (!filtered.length) {
                    if (groupedContainer) { groupedContainer.innerHTML = ''; groupedContainer.style.display = 'none'; }
                    if (table) table.style.display = '';
                    if (tbody) tbody.innerHTML = '<tr><td colspan="9" style="padding: 20px; text-align: center; color: var(--text-muted);">No applications</td></tr>';
                    return;
                }

                if (this.accAppsGroupBy !== 'none') {
                    if (table) table.style.display = 'none';
                    if (groupedContainer) groupedContainer.style.display = '';
                    const groups = {};
                    filtered.forEach(a => {
                        const key = this.getAppGroupKey(a, this.accAppsGroupBy);
                        if (!groups[key]) groups[key] = [];
                        groups[key].push(a);
                    });
                    const sortedKeys = Object.keys(groups).sort();
                    groupedContainer.innerHTML = sortedKeys.map(key => `
                        <div class="px-group-section">
                            <div class="px-group-header" onclick="this.classList.toggle('collapsed'); this.nextElementSibling.classList.toggle('collapsed');">
                                <div>
                                    <span class="px-group-header-title">${key}</span>
                                    <span class="px-group-header-count">${groups[key].length}</span>
                                    <i class="fas fa-chevron-down px-chevron"></i>
                                </div>
                            </div>
                            <div class="px-group-body">
                                <table style="width: 100%; border-collapse: collapse; font-size: 13px; margin: 0;">
                                    <thead><tr style="border-bottom: 2px solid var(--border-color);">
                                        <th style="padding: 10px; text-align: left;">No.</th>
                                        <th style="padding: 10px; text-align: left;">ID</th>
                                        <th style="padding: 10px; text-align: left;">Full Name</th>
                                        <th style="padding: 10px; text-align: left;">Institution</th>
                                        <th style="padding: 10px; text-align: left;">Year</th>
                                        <th style="padding: 10px; text-align: left;">Program</th>
                                        <th style="padding: 10px; text-align: left;">Status</th>
                                        <th style="padding: 10px; text-align: left;">Score</th>
                                        <th style="padding: 10px; text-align: center;">Actions</th>
                                    </tr></thead>
                                    <tbody>${groups[key].map((a, i) => this.renderAppRow(a, i)).join('')}</tbody>
                                </table>
                            </div>
                        </div>
                    `).join('');
                } else {
                    if (groupedContainer) { groupedContainer.style.display = 'none'; groupedContainer.innerHTML = ''; }
                    if (table) table.style.display = '';
                    if (tbody) tbody.innerHTML = filtered.map((app, idx) => this.renderAppRow(app, idx)).join('');
                }
            },

            exportApplicationsCsv() {
                const data = this.accAppsFiltered && this.accAppsFiltered.length > 0 ? this.accAppsFiltered : this.applications;
                if (!data || data.length === 0) { Toast.warning('No applications to export'); return; }

                const headers = ['Candidate ID', 'First Name', 'Last Name', 'Email', 'Phone', 'Institution', 'Year of Study', 'GPA', 'Program Type', 'Selected Institution', 'Status', 'Validity', 'Total Score', 'Submitted At'];
                const rows = data.map(a => [
                    a.candidate_id || a.work_number || '', a.first_name || '', a.last_name || '', a.email || '', a.phone || '',
                    a.current_institution || '', a.year_of_study || '', a.gpa || '', a.program_type || '',
                    this.institutions.find(i => i.id === a.selected_institution)?.name || '',
                    a.status || '', a.validity_status || '', a.total_score || '', a.submitted_at || ''
                ]);

                const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${(c || '').toString().replace(/"/g, '""')}"`).join(','))].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `accelerator-applications-${this.currentYear}-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            },

            async viewApplication(appId) {
                const app = await this.api(`/api/accelerator/applications/${appId}/full`);
                this.currentApplication = app;

                const instName = this.institutions.find(i => i.id === app.selected_institution)?.name || app.selected_institution || '-';

                const validityBadge = app.validity_status === 'valid'
                    ? '<span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Valid</span>'
                    : app.validity_status === 'invalid'
                    ? '<span style="background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Invalid</span>'
                    : '<span style="background: rgba(148, 163, 184, 0.2); color: #94a3b8; padding: 2px 8px; border-radius: 4px; font-size: 12px;">Pending Review</span>';

                document.getElementById('accAppModalTitle').textContent = `Candidate #${app.candidate_id || app.application_number}`;
                document.getElementById('accAppModalBody').innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                        <div>
                            <span style="color: var(--text-muted); font-size: 12px;">Candidate ID</span>
                            <div style="font-size: 20px; font-weight: bold; color: var(--accent-color);">${app.candidate_id || '-'}</div>
                        </div>
                        <div style="text-align: right;">
                            <div>${validityBadge}</div>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Application: ${app.created_at?.split('T')[0] || '-'}</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 style="margin: 0 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Personal Information</h4>
                            <p><strong>Full Name:</strong> ${app.first_name} ${app.last_name}</p>
                            <p><strong>Email:</strong> ${app.email}</p>
                            <p><strong>Phone:</strong> ${app.phone || '-'}</p>
                            <p><strong>Date of Birth:</strong> ${app.date_of_birth || '-'}</p>
                            <p><strong>Address:</strong> ${app.address || '-'}</p>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Education</h4>
                            <p><strong>Institution:</strong> ${app.current_institution || '-'}</p>
                            <p><strong>Program:</strong> ${app.degree_program || '-'}</p>
                            <p><strong>Year of Study:</strong> ${app.year_of_study || '-'}</p>
                            <p><strong>GPA (GPA):</strong> ${app.gpa || '-'}</p>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4 style="margin: 0 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Program</h4>
                        <p><strong>Type:</strong> ${app.program_type === 'clinical' ? 'Clinical' : 'Scientific'}</p>
                        <p><strong>Institution:</strong> ${instName}</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4 style="margin: 0 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Additional Information</h4>
                        <p><strong>Previous Experience:</strong><br>${app.previous_experience || '-'}</p>
                        <p><strong>Special Requirements:</strong> ${app.special_arrangements || '-'}</p>
                    </div>
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">
                            <h4 style="margin: 0;">Documents (${app.documents?.length || 0})</h4>
                            <button class="btn btn-primary" style="padding: 6px 12px;" onclick="AcceleratorApp.downloadDocs('${app.id}')">
                                <i class="fas fa-file-pdf"></i> Download All (PDF)
                            </button>
                        </div>
                        ${app.documents?.length ? app.documents.map(d => {
                            const icon = d.mime_type?.includes('pdf') ? 'fa-file-pdf' : d.mime_type?.includes('image') ? 'fa-file-image' : 'fa-file';
                            const color = d.mime_type?.includes('pdf') ? '#ef4444' : d.mime_type?.includes('image') ? '#3b82f6' : '#94a3b8';
                            return `
                            <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg-secondary); border-radius: 4px; margin-bottom: 4px;">
                                <i class="fas ${icon}" style="color: ${color};"></i>
                                <div style="flex: 1;">
                                    <div style="font-size: 13px;">${d.document_type}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">${d.original_filename} ${d.file_size ? '(' + (d.file_size / 1024).toFixed(1) + ' KB)' : ''}</div>
                                </div>
                                <a href="/api/accelerator/documents/${d.id}/download" class="btn btn-secondary" style="padding: 4px 8px;" title="Download"><i class="fas fa-download"></i></a>
                            </div>`;
                        }).join('') : '<p style="color: var(--text-muted);">No documents loaded</p>'}
                    </div>
                    <div style="margin-top: 20px;">
                        <h4 style="margin: 0 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Evaluation</h4>
                        ${app.evaluations?.length ? `
                            <table style="width: 100%; font-size: 13px;">
                                ${app.evaluations.map(e => `<tr><td>${e.name_hr || e.name}</td><td style="text-align: right;"><strong>${e.score}</strong> / ${e.max_points}</td></tr>`).join('')}
                            </table>
                            <p style="margin-top: 10px;"><strong>Total:</strong> ${app.total_score?.toFixed(2) || '-'}</p>
                        ` : '<p style="color: var(--text-muted);">Nije evaluirano</p>'}
                    </div>
                    <div style="margin-top: 20px;">
                        <h4 style="margin: 0 0 12px 0; border-bottom: 1px solid var(--border-color); padding-bottom: 8px;">Poruke</h4>
                        ${app.messages?.length ? app.messages.map(m => `
                            <div style="padding: 8px; background: var(--bg-secondary); border-radius: 4px; margin-bottom: 4px;">
                                <small style="color: var(--text-muted);">${m.sent_at} - ${m.sent_by}</small>
                                <p style="margin: 4px 0 0 0;">${m.content}</p>
                            </div>
                        `).join('') : '<p style="color: var(--text-muted);">No messagea</p>'}
                    </div>
                `;
                document.getElementById('accAppModal').style.display = 'flex';
            },

            closeAppModal() {
                document.getElementById('accAppModal').style.display = 'none';
            },

            messageCandidate(appId) {
                const app = this.applications.find(a => a.id === appId);
                document.getElementById('accMessageAppId').value = appId;
                document.getElementById('accMessageRecipient').innerHTML = `
                    <strong>${app.first_name} ${app.last_name}</strong><br>
                    <span style="font-size: 13px;">${app.email}</span>
                `;
                document.getElementById('accMessageSubject').value = '';
                document.getElementById('accMessageContent').value = '';
                document.getElementById('accMessageType').value = 'info';
                document.getElementById('accMessageSendEmail').checked = true;
                document.getElementById('accMessageModal').style.display = 'flex';
            },

            closeMessageModal() {
                document.getElementById('accMessageModal').style.display = 'none';
            },

            async sendMessage(e) {
                e.preventDefault();
                const appId = document.getElementById('accMessageAppId').value;
                const subject = document.getElementById('accMessageSubject').value;
                const content = document.getElementById('accMessageContent').value;
                const messageType = document.getElementById('accMessageType').value;
                const sendEmail = document.getElementById('accMessageSendEmail').checked;

                const btn = e.target.querySelector('button[type="submit"]');
                this.setButtonLoading(btn, true);

                try {
                    await this.api(`/api/accelerator/applications/${appId}/message`, {
                        method: 'POST',
                        body: JSON.stringify({ subject, content, message_type: messageType, send_email: sendEmail })
                    });
                    this.closeMessageModal();
                    this.showAccToast('Message sent successfully!', 'success');
                    if (this.currentApplication?.id == appId) {
                        this.viewApplication(appId);
                    }
                } catch (err) {
                    this.showAccToast('Error sending message: ' + err.message, 'error');
                } finally {
                    this.setButtonLoading(btn, false);
                }
            },

            setValidity(appId) {
                const app = this.applications.find(a => a.id === appId);
                document.getElementById('accValidityAppId').value = appId;
                document.getElementById('accValidityCandidate').innerHTML = `
                    <strong>${app.first_name} ${app.last_name}</strong> (ID: ${app.candidate_id || '-'})<br>
                    <span style="font-size: 13px;">Institution: ${app.institution_name || '-'}</span>
                `;
                document.getElementById('accValidityReason').value = '';
                document.getElementById('accValidityNotify').checked = true;

                // Reset radio buttons and styling
                document.querySelectorAll('.validity-option').forEach(opt => {
                    opt.style.borderColor = 'var(--border-color)';
                    opt.style.background = 'transparent';
                    opt.querySelector('input').checked = false;
                });

                // Set current validity if exists
                if (app.validity_status) {
                    const current = document.querySelector(`.validity-option[data-value="${app.validity_status}"]`);
                    if (current) {
                        current.querySelector('input').checked = true;
                        current.style.borderColor = app.validity_status === 'valid' ? 'var(--success-color)' : 'var(--danger-color)';
                        current.style.background = app.validity_status === 'valid' ? 'rgba(var(--success-rgb), 0.1)' : 'rgba(var(--danger-rgb), 0.1)';
                    }
                }

                document.getElementById('accValidityModal').style.display = 'flex';

                // Add click handlers for validity options
                document.querySelectorAll('.validity-option').forEach(opt => {
                    opt.onclick = () => {
                        document.querySelectorAll('.validity-option').forEach(o => {
                            o.style.borderColor = 'var(--border-color)';
                            o.style.background = 'transparent';
                        });
                        opt.querySelector('input').checked = true;
                        const val = opt.dataset.value;
                        opt.style.borderColor = val === 'valid' ? 'var(--success-color)' : 'var(--danger-color)';
                        opt.style.background = val === 'valid' ? 'rgba(46, 204, 113, 0.1)' : 'rgba(231, 76, 60, 0.1)';
                    };
                });
            },

            closeValidityModal() {
                document.getElementById('accValidityModal').style.display = 'none';
            },

            async saveValidity(e) {
                e.preventDefault();
                const appId = document.getElementById('accValidityAppId').value;
                const validityStatus = document.querySelector('input[name="accValidityStatus"]:checked')?.value;
                const reason = document.getElementById('accValidityReason').value;
                const notify = document.getElementById('accValidityNotify').checked;

                if (!validityStatus) {
                    this.showAccToast('Please select a validity status.', 'warning');
                    return;
                }

                const btn = e.target.querySelector('button[type="submit"]');
                this.setButtonLoading(btn, true);

                try {
                    await this.api(`/api/accelerator/applications/${appId}/validity`, {
                        method: 'PUT',
                        body: JSON.stringify({ validity_status: validityStatus, reason, notify })
                    });
                    this.closeValidityModal();
                    this.loadApplications();
                    this.showAccToast('Validity status saved!', 'success');
                } catch (err) {
                    this.showAccToast('Error: ' + err.message, 'error');
                } finally {
                    this.setButtonLoading(btn, false);
                }
            },

            downloadDocs(appId) {
                window.open(`/api/accelerator/applications/${appId}/merge-docs`, '_blank');
            },

            // EVALUATION
            async loadCriteria() {
                this.criteria = await this.api(`/api/accelerator/years/${this.currentYear}/criteria`);
                const container = document.getElementById('accCriteriaList');

                if (this.criteria.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No kriterija. Addte prvi kriterij evaluacije.</p>';
                    return;
                }

                container.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 8px; text-align: left;">Name</th>
                                <th style="padding: 8px; text-align: left;">Name (HR)</th>
                                <th style="padding: 8px; text-align: center;">Max Points</th>
                                <th style="padding: 8px; text-align: center;">Weight</th>
                                <th style="padding: 8px; text-align: center;">Category</th>
                                <th style="padding: 8px; text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${this.criteria.map(c => `
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td style="padding: 8px;">${c.name}</td>
                                    <td style="padding: 8px;">${c.name_hr || '-'}</td>
                                    <td style="padding: 8px; text-align: center;">${c.max_points}</td>
                                    <td style="padding: 8px; text-align: center;">${c.weight}</td>
                                    <td style="padding: 8px; text-align: center;">${c.category}</td>
                                    <td style="padding: 8px; text-align: center;">
                                        <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="AcceleratorApp.editCriterion('${c.id}')"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="AcceleratorApp.deleteCriterion('${c.id}')"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            },

            async addCriterion() {
                const name = prompt('Name (English):');
                if (!name) return;
                const name_hr = prompt('Name (Croatian):');
                const max_points = prompt('Maximum points:', '10');
                const weight = prompt('Weight (1 = normal):', '1');
                const category = prompt('Category (objective/interview/bonus):', 'objective');

                await this.api(`/api/accelerator/years/${this.currentYear}/criteria`, {
                    method: 'POST', body: JSON.stringify({ name, name_hr, max_points: parseFloat(max_points), weight: parseFloat(weight), category })
                });
                this.loadCriteria();
            },

            async editCriterion(id) {
                const c = this.criteria.find(x => x.id === id);
                const name = prompt('Name:', c.name);
                const name_hr = prompt('Name (HR):', c.name_hr);
                const max_points = prompt('Max Points:', c.max_points);
                const weight = prompt('Weight:', c.weight);

                await this.api(`/api/accelerator/criteria/${id}`, {
                    method: 'PUT', body: JSON.stringify({ name, name_hr, max_points: parseFloat(max_points), weight: parseFloat(weight) })
                });
                this.loadCriteria();
            },

            async deleteCriterion(id) {
                if (!confirm('Delete this criterion?')) return;
                await this.api(`/api/accelerator/criteria/${id}`, { method: 'DELETE' });
                this.loadCriteria();
            },

            async loadApplicationsForEval() {
                const select = document.getElementById('accEvalAppSelect');
                const apps = this.applications.filter(a => a.status === 'submitted');
                select.innerHTML = '<option value="">-- Select candidate --</option>' +
                    apps.map(a => `<option value="${a.id}">${a.work_number || '-'} - ${a.first_name} ${a.last_name}</option>`).join('');
            },

            async loadApplicationForEval(appId) {
                if (!appId) {
                    document.getElementById('accEvaluationForm').style.display = 'none';
                    return;
                }

                const app = await this.api(`/api/accelerator/applications/${appId}/full`);
                this.currentApplication = app;

                document.getElementById('accEvaluationForm').style.display = 'block';

                const evalMap = {};
                (app.evaluations || []).forEach(e => evalMap[e.criterion_id] = e.score);

                document.getElementById('accEvalScores').innerHTML = this.criteria.map(c => `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 8px;">
                        <div style="flex: 1;">
                            <strong>${c.name_hr || c.name}</strong>
                            <small style="color: var(--text-muted);"> (max ${c.max_points})</small>
                        </div>
                        <input type="number" id="eval-${c.id}" value="${evalMap[c.id] || ''}" min="0" max="${c.max_points}" step="0.1"
                            style="width: 80px; padding: 6px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                    </div>
                `).join('');
            },

            async saveEvaluation() {
                if (!this.currentApplication) return;

                const evaluations = this.criteria.map(c => ({
                    criterion_id: c.id,
                    score: parseFloat(document.getElementById(`eval-${c.id}`).value) || 0
                }));

                try {
                    await this.api(`/api/accelerator/applications/${this.currentApplication.id}/evaluate-batch`, {
                        method: 'POST', body: JSON.stringify({ evaluations })
                    });
                    this.showAccToast('Evaluation scores saved successfully.', 'success');
                    this.loadApplications();
                } catch (err) {
                    this.showAccToast('Error saving evaluation: ' + err.message, 'error');
                }
            },

            // INTERVIEWERS
            async loadInterviewers() {
                this.interviewers = await this.api(`/api/accelerator/years/${this.currentYear}/interviewers`);
                document.getElementById('accIntYear').textContent = this.currentYear;
                const tbody = document.getElementById('accInterviewersList');

                if (this.interviewers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: var(--text-muted);">No interviewers. Add the first interviewer.</td></tr>';
                    return;
                }

                tbody.innerHTML = this.interviewers.map(i => `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 10px;">
                            <strong>${i.name}</strong>
                        </td>
                        <td style="padding: 10px;">${i.email}</td>
                        <td style="padding: 10px;">${i.institution || '-'}</td>
                        <td style="padding: 10px;">${i.specialty || '-'}</td>
                        <td style="padding: 10px; text-align: center; white-space: nowrap;">
                            <button class="btn btn-primary" style="padding: 4px 8px; margin: 2px;" onclick="AcceleratorApp.sendMagicLink('${i.id}')" title="Send magic link via email"><i class="fas fa-paper-plane"></i></button>
                            <button class="btn btn-secondary" style="padding: 4px 8px; margin: 2px;" onclick="AcceleratorApp.copyInterviewerLink('${i.access_token}')" title="Copy link"><i class="fas fa-link"></i></button>
                            <button class="btn btn-secondary" style="padding: 4px 8px; margin: 2px;" onclick="AcceleratorApp.showInterviewerModal('${i.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-secondary" style="padding: 4px 8px; margin: 2px;" onclick="AcceleratorApp.regenerateToken('${i.id}')" title="Regenerate token"><i class="fas fa-key"></i></button>
                            <button class="btn btn-secondary" style="padding: 4px 8px; margin: 2px;" onclick="AcceleratorApp.deleteInterviewer('${i.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            addInterviewer() {
                this.showInterviewerModal(null);
            },

            showInterviewerModal(id) {
                const interviewer = id ? this.interviewers.find(i => i.id === id) : null;
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.id = 'interviewerModal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 450px;">
                        <div class="modal-header">
                            <h3>${interviewer ? 'Edit Interviewer' : 'Add Interviewer'}</h3>
                            <button class="modal-close" onclick="document.getElementById('interviewerModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form onsubmit="AcceleratorApp.saveInterviewer(event, '${id || ''}')">
                                <div style="display: grid; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Full Name *</label>
                                        <input type="text" id="intName" required value="${interviewer?.name || ''}" placeholder="dr. Ivan Horvat" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Email *</label>
                                        <input type="email" id="intEmail" required value="${interviewer?.email || ''}" placeholder="john.doe@example.com" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Institution</label>
                                        <input type="text" id="intInstitution" value="${interviewer?.institution || ''}" placeholder="KBC Zagreb" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Specialty</label>
                                        <input type="text" id="intSpecialty" value="${interviewer?.specialty || ''}" placeholder="Internal Medicine" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                    <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('interviewerModal').remove()">Cancel</button>
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            async saveInterviewer(e, id) {
                e.preventDefault();
                const data = {
                    name: document.getElementById('intName').value,
                    email: document.getElementById('intEmail').value,
                    institution: document.getElementById('intInstitution').value,
                    specialty: document.getElementById('intSpecialty').value
                };

                const btn = e.target.querySelector('button[type="submit"]');
                this.setButtonLoading(btn, true);

                try {
                    if (id) {
                        await this.api(`/api/accelerator/interviewers/${id}`, {
                            method: 'PUT', body: JSON.stringify(data)
                        });
                        this.showAccToast('Interviewer updated successfully.', 'success');
                    } else {
                        await this.api(`/api/accelerator/years/${this.currentYear}/interviewers`, {
                            method: 'POST', body: JSON.stringify(data)
                        });
                        this.showAccToast('Interviewer added. You can now send them a magic link.', 'success');
                    }
                    document.getElementById('interviewerModal').remove();
                    this.loadInterviewers();
                } catch (err) {
                    this.showAccToast('Error saving interviewer: ' + err.message, 'error');
                    this.setButtonLoading(btn, false);
                }
            },

            async deleteInterviewer(id) {
                if (!confirm('Are you sure you want to delete this interviewer?')) return;
                await this.api(`/api/accelerator/interviewers/${id}`, { method: 'DELETE' });
                this.loadInterviewers();
            },

            copyInterviewerLink(token) {
                const link = `${window.location.origin}/evaluate?token=${token}`;
                navigator.clipboard.writeText(link);
                this.showAccToast('Magic link copied to clipboard.', 'success');
            },

            async sendMagicLink(id) {
                const interviewer = this.interviewers.find(i => i.id === id);
                if (!confirm(`Send magic link to ${interviewer.email}?`)) return;

                try {
                    await this.api(`/api/accelerator/interviewers/${id}/send-link`, { method: 'POST' });
                    this.showAccToast(`Magic link sent to ${interviewer.email}`, 'success');
                } catch (err) {
                    this.showAccToast('Error sending magic link: ' + err.message, 'error');
                }
            },

            async regenerateToken(id) {
                if (!confirm('Regenerate access token? The old link will no longer work.')) return;

                try {
                    await this.api(`/api/accelerator/interviewers/${id}/regenerate-token`, { method: 'POST' });
                    this.showAccToast('Token regenerated. Send the new magic link to the interviewer.', 'success');
                    this.loadInterviewers();
                } catch (err) {
                    this.showAccToast('Error regenerating token: ' + err.message, 'error');
                }
            },

            // REGISTRATIONS
            registrations: [],

            async loadRegistrations() {
                const data = await this.api('/api/accelerator/registrations');
                this.registrations = data.applicants || [];

                // Update stats
                document.getElementById('accRegTotal').textContent = data.stats?.total || 0;
                document.getElementById('accRegVerified').textContent = data.stats?.verified || 0;
                document.getElementById('accRegWithApp').textContent = data.stats?.withApplications || 0;

                this.renderRegistrations();
            },

            renderRegistrations() {
                const search = (document.getElementById('accRegSearch')?.value || '').toLowerCase();
                const filtered = this.registrations.filter(r => {
                    if (!search) return true;
                    return (r.first_name || '').toLowerCase().includes(search) ||
                           (r.last_name || '').toLowerCase().includes(search) ||
                           (r.email || '').toLowerCase().includes(search) ||
                           (r.current_institution || '').toLowerCase().includes(search);
                });

                const tbody = document.getElementById('accRegistrationsTable');
                if (filtered.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: var(--text-muted);">No registrations found</td></tr>';
                    return;
                }

                tbody.innerHTML = filtered.map(r => `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 10px;">
                            <strong>${r.first_name || ''} ${r.last_name || ''}</strong>
                            ${!r.first_name && !r.last_name ? '<span style="color: var(--text-muted);">No name</span>' : ''}
                        </td>
                        <td style="padding: 10px;">${r.email}</td>
                        <td style="padding: 10px;">${r.phone || '-'}</td>
                        <td style="padding: 10px;">${r.current_institution || '-'}</td>
                        <td style="padding: 10px; text-align: center;">
                            ${r.email_verified ? '<span style="color: var(--success);"><i class="fas fa-check-circle"></i> Yes</span>' : '<span style="color: var(--text-muted);"><i class="fas fa-clock"></i> Pending</span>'}
                        </td>
                        <td style="padding: 10px;">${r.created_at ? new Date(r.created_at).toLocaleDateString() : '-'}</td>
                        <td style="padding: 10px; text-align: center;">
                            ${r.application_count > 0 ? `<span class="status-badge" style="background: rgba(34, 211, 238, 0.2); color: #22d3ee;">${r.application_count} (${r.submitted_count} submitted)</span>` : '<span style="color: var(--text-muted);">None</span>'}
                        </td>
                    </tr>
                `).join('');
            },

            filterRegistrations() {
                this.renderRegistrations();
            },

            // RANKING
            async loadRanking() {
                const inst = document.getElementById('accRankInst')?.value || '';
                const url = `/api/accelerator/years/${this.currentYear}/ranking${inst ? '?institution=' + inst : ''}`;
                const ranking = await this.api(url);

                const tbody = document.getElementById('accRankingTable');
                if (ranking.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="padding: 20px; text-align: center; color: var(--text-muted);">No data for ranking list</td></tr>';
                    return;
                }

                tbody.innerHTML = ranking.map((app, idx) => `
                    <tr style="border-bottom: 1px solid var(--border-color); ${idx < 3 ? 'background: rgba(34, 197, 94, 0.1);' : ''}">
                        <td style="padding: 10px; text-align: center; font-weight: bold;">${idx + 1}</td>
                        <td style="padding: 10px; text-align: center;">${app.work_number || '-'}</td>
                        <td style="padding: 10px; text-align: center;">${app.gpa?.toFixed(2) || '-'}</td>
                        <td style="padding: 10px; text-align: center;">-</td>
                        <td style="padding: 10px; text-align: center;">-</td>
                        <td style="padding: 10px; text-align: center;">${app.objective_score?.toFixed(2) || '-'}</td>
                        <td style="padding: 10px; text-align: center;">${app.interview_score?.toFixed(2) || '-'}</td>
                        <td style="padding: 10px; text-align: center; font-weight: bold;">${app.total_score?.toFixed(2) || '-'}</td>
                    </tr>
                `).join('');
            },

            async updateRankings() {
                try {
                    await this.api(`/api/accelerator/years/${this.currentYear}/update-rankings`, { method: 'POST' });
                    this.loadRanking();
                    this.showAccToast('Ranking list updated.', 'success');
                } catch (err) {
                    this.showAccToast('Error updating rankings: ' + err.message, 'error');
                }
            },

            async publishRankings() {
                if (!confirm('Publish rankings? This will notify all applicants with their rank position.')) return;

                try {
                    const result = await this.api(`/api/accelerator/years/${this.currentYear}/publish-rankings`, { method: 'POST' });
                    this.showAccToast(`Rankings published! ${result.notified || 0} applicants notified.`, 'success');
                    this.loadRanking();
                } catch (err) {
                    this.showAccToast('Error publishing rankings: ' + err.message, 'error');
                }
            },

            downloadRankingPDF() {
                window.open(`/api/accelerator/years/${this.currentYear}/ranking-pdf`, '_blank');
            },

            async editPdfSettings() {
                const settings = await this.api(`/api/accelerator/years/${this.currentYear}/pdf-settings`);
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.id = 'pdfSettingsModal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>PDF Settings - Ranking List ${this.currentYear}</h3>
                            <button class="modal-close" onclick="document.getElementById('pdfSettingsModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form onsubmit="AcceleratorApp.savePdfSettings(event)">
                                <div style="display: grid; gap: 16px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Introduction Text</label>
                                        <textarea id="pdfHeaderIntro" rows="4" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical; font-size: 13px;">${settings.header_intro || ''}</textarea>
                                        <small style="color: var(--text-muted);">Use [DATE] for automatic date</small>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Document Title</label>
                                        <input type="text" id="pdfHeaderTitle" value="${settings.header_title || ''}" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Article 1</label>
                                        <textarea id="pdfArticle1" rows="5" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical; font-size: 13px;">${settings.article1_text || ''}</textarea>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Article 2</label>
                                        <textarea id="pdfArticle2" rows="3" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical; font-size: 13px;">${settings.article2_text || ''}</textarea>
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 6px; font-weight: 500;">Article 3</label>
                                        <textarea id="pdfArticle3" rows="3" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); resize: vertical; font-size: 13px;">${settings.article3_text || ''}</textarea>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 6px; font-weight: 500;">Signatory Name</label>
                                            <input type="text" id="pdfSignName" value="${settings.signatory_name || ''}" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 6px; font-weight: 500;">Body/Organization</label>
                                            <input type="text" id="pdfSignTitle" value="${settings.signatory_title || ''}" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                        </div>
                                        <div>
                                            <label style="display: block; margin-bottom: 6px; font-weight: 500;">Role/Position</label>
                                            <input type="text" id="pdfSignRole" value="${settings.signatory_role || ''}" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('pdfSettingsModal').remove()">Cancel</button>
                                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },

            async savePdfSettings(e) {
                e.preventDefault();
                const data = {
                    header_intro: document.getElementById('pdfHeaderIntro').value,
                    header_title: document.getElementById('pdfHeaderTitle').value,
                    article1_text: document.getElementById('pdfArticle1').value,
                    article2_text: document.getElementById('pdfArticle2').value,
                    article3_text: document.getElementById('pdfArticle3').value,
                    signatory_name: document.getElementById('pdfSignName').value,
                    signatory_title: document.getElementById('pdfSignTitle').value,
                    signatory_role: document.getElementById('pdfSignRole').value
                };

                try {
                    await this.api(`/api/accelerator/years/${this.currentYear}/pdf-settings`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                    document.getElementById('pdfSettingsModal').remove();
                    this.showAccToast('PDF settings saved!', 'success');
                } catch (err) {
                    this.showAccToast('Error saving PDF settings: ' + err.message, 'error');
                }
            },

            // GROUPED FILES
            groupedFilesData: [],

            async loadGroupedFiles() {
                try {
                    const data = await this.api(`/api/accelerator/files/grouped?year=${this.currentYear}`);
                    this.groupedFilesData = data || [];
                    this.renderGroupedFiles();
                } catch (err) {
                    // Fallback: build from applications data
                    await this.loadApplications();
                    this.groupedFilesData = this.applications
                        .filter(a => a.doc_count > 0)
                        .map(a => ({
                            applicant: { name: `${a.first_name} ${a.last_name}`, email: a.email, id: a.id, candidate_id: a.candidate_id || a.work_number },
                            files: []
                        }));
                    this.renderGroupedFiles();
                }
            },

            filterGroupedFiles() {
                this.renderGroupedFiles();
            },

            renderGroupedFiles() {
                const search = (document.getElementById('accFilesSearch')?.value || '').toLowerCase();
                const container = document.getElementById('accGroupedFiles');
                const statsContainer = document.getElementById('accFilesStats');

                let filtered = this.groupedFilesData;
                if (search) {
                    filtered = filtered.filter(g =>
                        g.applicant?.name?.toLowerCase().includes(search) ||
                        g.applicant?.email?.toLowerCase().includes(search)
                    );
                }

                // Stats
                const totalApplicants = this.groupedFilesData.length;
                const totalFiles = this.groupedFilesData.reduce((sum, g) => sum + (g.files?.length || 0), 0);
                statsContainer.innerHTML = `
                    <div style="padding: 10px 16px; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: 700; color: var(--accelerator);">${totalApplicants}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Applicants with Files</div>
                    </div>
                    <div style="padding: 10px 16px; background: var(--bg-secondary); border-radius: 8px;">
                        <div style="font-size: 18px; font-weight: 700;">${totalFiles}</div>
                        <div style="font-size: 11px; color: var(--text-muted);">Total Documents</div>
                    </div>
                `;

                if (filtered.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">No application documents found.</p>';
                    return;
                }

                container.innerHTML = filtered.map((group, idx) => {
                    const fileCount = group.files?.length || 0;
                    const filesHtml = (group.files || []).map(f => {
                        const icon = f.mime_type?.includes('pdf') ? 'fa-file-pdf' : f.mime_type?.includes('image') ? 'fa-file-image' : 'fa-file';
                        const color = f.mime_type?.includes('pdf') ? '#ef4444' : f.mime_type?.includes('image') ? '#3b82f6' : '#94a3b8';
                        const sizeStr = f.file_size ? (f.file_size / 1024).toFixed(1) + ' KB' : '';
                        return `
                            <div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-primary); border-radius: 4px;">
                                <i class="fas ${icon}" style="color: ${color}; width: 16px;"></i>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${f.document_type || f.original_filename || 'Document'}</div>
                                    <div style="font-size: 11px; color: var(--text-muted);">${f.original_filename || ''} ${sizeStr ? '(' + sizeStr + ')' : ''}</div>
                                </div>
                                <a href="/api/accelerator/documents/${f.id}/download" class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" title="Download"><i class="fas fa-download"></i></a>
                            </div>`;
                    }).join('');

                    return `
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; cursor: pointer; user-select: none;" onclick="AcceleratorApp.toggleApplicantFiles('accFileGroup-${idx}')">
                                <i class="fas fa-chevron-right" id="accFileGroupIcon-${idx}" style="color: var(--text-muted); transition: transform 0.2s; width: 12px;"></i>
                                <div style="width: 36px; height: 36px; border-radius: 50%; background: var(--accelerator); color: #0f172a; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;">
                                    ${(group.applicant?.name || '?')[0].toUpperCase()}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">${group.applicant?.name || 'Unknown'}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${group.applicant?.email || ''} ${group.applicant?.candidate_id ? '| ID: ' + group.applicant.candidate_id : ''}</div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="background: rgba(34, 211, 238, 0.2); color: var(--accelerator); padding: 2px 8px; border-radius: 12px; font-size: 12px;">${fileCount} file${fileCount !== 1 ? 's' : ''}</span>
                                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="event.stopPropagation(); AcceleratorApp.downloadDocs('${group.applicant?.id || ''}')" title="Download All"><i class="fas fa-download"></i> All</button>
                                </div>
                            </div>
                            <div id="accFileGroup-${idx}" style="display: none; padding: 0 16px 12px 60px; display: none;">
                                <div style="display: flex; flex-direction: column; gap: 4px;">
                                    ${filesHtml || '<p style="color: var(--text-muted); font-size: 13px; padding: 8px;">Click to load documents</p>'}
                                </div>
                            </div>
                        </div>`;
                }).join('');
            },

            toggleApplicantFiles(containerId) {
                const container = document.getElementById(containerId);
                const iconId = containerId.replace('accFileGroup', 'accFileGroupIcon');
                const icon = document.getElementById(iconId);
                if (container.style.display === 'none') {
                    container.style.display = 'block';
                    if (icon) icon.style.transform = 'rotate(90deg)';
                } else {
                    container.style.display = 'none';
                    if (icon) icon.style.transform = 'rotate(0deg)';
                }
            },

            // ===== APPLICATION FORM =====
            documentTypes: [
                // REQUIRED DOCUMENTS (11 items) - keys match backend DOCUMENT_TYPES
                { key: 'domovnica', label: '1. Certificate of Citizenship', required: true },
                { key: 'cv', label: '2. Curriculum Vitae (Europass Form)', required: true },
                { key: 'student_status', label: '3. Student Status Certificate from Eligible University', required: true },
                { key: 'ects_credits', label: '4. ECTS Credits Certificate from Previous Academic Year', required: true },
                { key: 'transcript', label: '5. Grade Average Certificate / Transcript with ECTS Credits', required: true },
                { key: 'language_cert', label: '6. Foreign Language Proficiency Certificate (B2 or higher)', required: true },
                { key: 'application_form', label: '7. Completed Application Form for the Program', required: true },
                { key: 'membership_form', label: '8. Application for Associate Membership', required: true },
                { key: 'membership_fee', label: '9. Proof of Membership Fee Payment for Current Year', required: true },
                { key: 'motivation', label: '10. Motivation Letter', required: true },
                { key: 'recommendation', label: '11. Letter of Recommendation (min. 1, max. 2)', required: true },
                // OPTIONAL DOCUMENTS (9 items) - bonus points
                { key: 'publication', label: '12. Copy of First Page of Published Scientific Paper', required: false },
                { key: 'conference', label: '13. Certificate of Active Participation in Scientific Conferences', required: false },
                { key: 'membership_proof', label: '14. Membership in Professional Associations or Student Bodies', required: false },
                { key: 'leadership_proof', label: '15. Leadership in Professional Association or Student Body', required: false },
                { key: 'dean_award', label: '16. Copy of Dean\'s Award', required: false },
                { key: 'rector_award', label: '17. Copy of Rector\'s Award', required: false },
                { key: 'sports', label: '18. Certificate of Athletic Achievements', required: false },
                { key: 'editorship', label: '19. Certificate of Journal Editorial Position', required: false },
                { key: 'other', label: '20. Other', required: false }
            ],

            gdprConsentText: `CONSENT FOR PERSONAL DATA PROCESSING

I hereby confirm that I have read, understood, and agree to the terms of processing my personal data as part of my application to the "Med&X Accelerator" program.

By applying to this program, I give the following consents:

1. I agree that my personal data (including name, surname, date of birth, address, email address, phone number, citizenship, education, and other relevant information) may be collected and processed for the purpose of selection and implementation of the International Program for Professional Development of Biomedical Students "Med&X Accelerator".

2. I agree that my personal data may be shared with program organizers and other relevant third parties involved in the selection and administration process.

3. I agree that my personal data may be stored for the period necessary for program administration, and thereafter will be used solely for the organization of future editions of the International Program for Professional Development of Biomedical Students "Med&X Accelerator".

4. I understand that I have the right to request access to my personal data, correction of inaccurate data, and deletion of data, in accordance with legal requirements.`,

            uploadedDocs: {},

            // Word count helper for text areas with limits
            countWords(textarea, maxWords) {
                const words = textarea.value.trim().split(/\s+/).filter(w => w.length > 0);
                const wordCount = words.length;
                const countEl = document.getElementById('accPrevExpWordCount');
                if (countEl) {
                    countEl.textContent = wordCount;
                    countEl.style.color = wordCount > maxWords ? '#ef4444' : 'var(--text-muted)';
                }
                if (wordCount > maxWords) {
                    textarea.style.borderColor = '#ef4444';
                } else {
                    textarea.style.borderColor = 'var(--border-color)';
                }
            },

            initApplicationForm() {
                document.getElementById('accApplyYear').textContent = this.currentYear;
                document.getElementById('accGdprText').textContent = this.gdprConsentText;

                // Render required documents
                const requiredContainer = document.getElementById('accRequiredDocs');
                requiredContainer.innerHTML = this.documentTypes
                    .filter(d => d.required)
                    .map((d, idx) => `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                            <span style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: var(--accent-primary); color: white; border-radius: 50%; font-size: 12px; font-weight: bold;">${idx + 1}</span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 500;">${d.label} *</div>
                                <div id="accDocStatus-${d.key}" style="font-size: 11px; color: var(--text-muted);">Not loaded</div>
                            </div>
                            <input type="file" id="accDocFile-${d.key}" accept=".pdf" style="display: none;" onchange="AcceleratorApp.handleDocUpload('${d.key}', this.files[0])">
                            <button type="button" class="btn btn-secondary" style="padding: 6px 12px;" onclick="document.getElementById('accDocFile-${d.key}').click()">
                                <i class="fas fa-upload"></i> Choose
                            </button>
                        </div>
                    `).join('');

                // Render optional documents
                const optionalContainer = document.getElementById('accOptionalDocs');
                optionalContainer.innerHTML = this.documentTypes
                    .filter(d => !d.required)
                    .map(d => `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                            <span style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: var(--accent-gold); color: #1a1a2e; border-radius: 50%; font-size: 10px;"><i class="fas fa-star"></i></span>
                            <div style="flex: 1;">
                                <div style="font-size: 13px; font-weight: 500;">${d.label}</div>
                                <div id="accDocStatus-${d.key}" style="font-size: 11px; color: var(--text-muted);">Not loaded</div>
                            </div>
                            <input type="file" id="accDocFile-${d.key}" accept=".pdf" style="display: none;" onchange="AcceleratorApp.handleDocUpload('${d.key}', this.files[0])">
                            <button type="button" class="btn btn-secondary" style="padding: 6px 12px;" onclick="document.getElementById('accDocFile-${d.key}').click()">
                                <i class="fas fa-upload"></i> Choose
                            </button>
                        </div>
                    `).join('');
            },

            handleDocUpload(docKey, file) {
                if (!file) return;
                if (file.type !== 'application/pdf') {
                    Toast.warning('Only PDF files are allowed.');
                    return;
                }
                if (file.size > 10 * 1024 * 1024) {
                    Toast.warning('File is too large (max 10 MB).');
                    return;
                }
                this.uploadedDocs[docKey] = file;
                const statusEl = document.getElementById(`accDocStatus-${docKey}`);
                statusEl.innerHTML = `<i class="fas fa-check-circle" style="color: #22c55e;"></i> ${file.name}`;
            },

            updateInstitutionOptions(programType) {
                const primarySelect = document.getElementById('accApplyInstitution');
                const altSelect = document.getElementById('accApplyAltInstitution');

                if (!programType) {
                    primarySelect.innerHTML = '<option value="">-- First select program type --</option>';
                    altSelect.innerHTML = '<option value="">-- None --</option>';
                    return;
                }

                const filtered = this.institutions.filter(i => i.program_type === programType);
                const options = filtered.map(i => `<option value="${i.id}">${i.name} (${i.city}, ${i.country})</option>`).join('');

                primarySelect.innerHTML = '<option value="">-- Select institution --</option>' + options;
                altSelect.innerHTML = '<option value="">-- No alternative --</option>' + options;
            },

            async submitApplication(event) {
                event.preventDefault();

                // Validate GDPR consent
                if (!document.getElementById('accGdprConsent').checked) {
                    Toast.warning('You must accept the personal data processing terms.');
                    return;
                }

                // Validate required documents
                const requiredDocs = this.documentTypes.filter(d => d.required);
                const missingDocs = requiredDocs.filter(d => !this.uploadedDocs[d.key]);
                if (missingDocs.length > 0) {
                    alert(`Missing required documents:\n${missingDocs.map(d => '- ' + d.label).join('\n')}`);
                    return;
                }

                const form = document.getElementById('accApplicationForm');
                const formData = new FormData(form);

                // Create application first
                const applicationData = {
                    year: this.currentYear,
                    first_name: formData.get('first_name'),
                    last_name: formData.get('last_name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    date_of_birth: formData.get('date_of_birth'),
                    oib: formData.get('oib'),
                    address: formData.get('address'),
                    current_institution: formData.get('current_institution'),
                    degree_program: formData.get('degree_program'),
                    year_of_study: formData.get('year_of_study'),
                    gpa: parseFloat(formData.get('gpa')),
                    ects_total: formData.get('ects_total') ? parseInt(formData.get('ects_total')) : null,
                    program_type: formData.get('program_type'),
                    selected_institution: formData.get('selected_institution'),
                    alternative_institution: formData.get('alternative_institution') || null,
                    previous_experience: formData.get('previous_experience'),
                    special_arrangements: formData.get('special_arrangements'),
                    gdpr_consent: true,
                    status: 'submitted'
                };

                try {
                    // Submit application
                    const result = await this.api('/api/accelerator/applications', {
                        method: 'POST',
                        body: JSON.stringify(applicationData)
                    });

                    if (!result.id) throw new Error(result.error || 'Error submitting application');

                    // Upload documents
                    for (const [docKey, file] of Object.entries(this.uploadedDocs)) {
                        const docFormData = new FormData();
                        docFormData.append('file', file);
                        docFormData.append('document_type', docKey);

                        await fetch(`/api/accelerator/applications/${result.id}/documents`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${App.token}` },
                            body: docFormData
                        });
                    }

                    this.showAccToast(`Application submitted! Number: ${result.application_number}`, 'success');
                    form.reset();
                    this.uploadedDocs = {};
                    this.initApplicationForm();
                    this.showTab('overview');
                } catch (err) {
                    console.error('Submit error:', err);
                    this.showAccToast('Error submitting application: ' + err.message, 'error');
                }
            },

            async saveDraft() {
                const form = document.getElementById('accApplicationForm');
                const formData = new FormData(form);

                const draft = {
                    year: this.currentYear,
                    first_name: formData.get('first_name'),
                    last_name: formData.get('last_name'),
                    email: formData.get('email'),
                    phone: formData.get('phone'),
                    date_of_birth: formData.get('date_of_birth'),
                    oib: formData.get('oib'),
                    address: formData.get('address'),
                    current_institution: formData.get('current_institution'),
                    degree_program: formData.get('degree_program'),
                    year_of_study: formData.get('year_of_study'),
                    gpa: formData.get('gpa'),
                    ects_total: formData.get('ects_total'),
                    program_type: formData.get('program_type'),
                    selected_institution: formData.get('selected_institution'),
                    alternative_institution: formData.get('alternative_institution'),
                    previous_experience: formData.get('previous_experience'),
                    special_arrangements: formData.get('special_arrangements'),
                    status: 'draft'
                };

                localStorage.setItem('accApplicationDraft', JSON.stringify(draft));
                Toast.success('Draft saved locally. You can continue later.');
            },

            loadDraft() {
                const saved = localStorage.getItem('accApplicationDraft');
                if (!saved) return;

                const draft = JSON.parse(saved);
                const form = document.getElementById('accApplicationForm');

                Object.keys(draft).forEach(key => {
                    const input = form.elements[key];
                    if (input && draft[key]) {
                        input.value = draft[key];
                    }
                });

                if (draft.program_type) {
                    this.updateInstitutionOptions(draft.program_type);
                    setTimeout(() => {
                        if (draft.selected_institution) {
                            document.getElementById('accApplyInstitution').value = draft.selected_institution;
                        }
                        if (draft.alternative_institution) {
                            document.getElementById('accApplyAltInstitution').value = draft.alternative_institution;
                        }
                    }, 100);
                }
            },

            // ===== PHASE 4C: APPLICATION FORM PREVIEW/EDITOR =====
            formEditMode: false,
            formConfig: [],

            // Default form sections definition (used for preview rendering)
            defaultFormSections: [
                {
                    name: 'Personal Information',
                    icon: 'fa-user',
                    fields: [
                        { name: 'first_name', label: 'First Name', type: 'text', required: true },
                        { name: 'last_name', label: 'Last Name', type: 'text', required: true },
                        { name: 'email', label: 'Email', type: 'email', required: true },
                        { name: 'phone', label: 'Phone', type: 'tel', required: true },
                        { name: 'date_of_birth', label: 'Date of Birth', type: 'date', required: true },
                        { name: 'oib', label: 'Personal ID (OIB)', type: 'text', required: true },
                        { name: 'address', label: 'Residential Address', type: 'text', required: true, span: 2 }
                    ]
                },
                {
                    name: 'Education',
                    icon: 'fa-graduation-cap',
                    fields: [
                        { name: 'current_institution', label: 'Faculty / Institution', type: 'text', required: true, span: 2 },
                        { name: 'degree_program', label: 'Study Program', type: 'select', required: true, options: 'Medicine,Dental Medicine,Pharmacy,Medical Biochemistry / Biotechnology,Other' },
                        { name: 'year_of_study', label: 'Year of Study', type: 'select', required: true, options: '1st Year,2nd Year,3rd Year,4th Year,5th Year,6th Year,Final Year' },
                        { name: 'gpa', label: 'GPA', type: 'number', required: true },
                        { name: 'ects_total', label: 'Total ECTS Credits Completed', type: 'number', required: false }
                    ]
                },
                {
                    name: 'Program Selection',
                    icon: 'fa-university',
                    fields: [
                        { name: 'program_type', label: 'Program Type', type: 'select', required: true, options: 'Scientific Program,Clinical Program' },
                        { name: 'selected_institution', label: 'Desired Institution', type: 'select', required: true, options: '(populated dynamically)' },
                        { name: 'alternative_institution', label: 'Alternative Institution (optional)', type: 'select', required: false, span: 2, options: '(populated dynamically)' }
                    ]
                },
                {
                    name: 'Additional Information',
                    icon: 'fa-info-circle',
                    fields: [
                        { name: 'previous_experience', label: 'Previous research/program experience', type: 'textarea', required: false, span: 2 },
                        { name: 'special_arrangements', label: 'Special arrangements needed', type: 'textarea', required: false, span: 2 }
                    ]
                },
                {
                    name: 'Required Documents',
                    icon: 'fa-file-upload',
                    fields: this.documentTypes ? this.documentTypes.filter(d => d.required).map(d => ({
                        name: d.key, label: d.label, type: 'file', required: true, span: 2
                    })) : []
                },
                {
                    name: 'Additional Documents (bonus)',
                    icon: 'fa-star',
                    fields: this.documentTypes ? this.documentTypes.filter(d => !d.required).map(d => ({
                        name: d.key, label: d.label, type: 'file', required: false, span: 2
                    })) : []
                },
                {
                    name: 'Consent (GDPR)',
                    icon: 'fa-shield-alt',
                    fields: [
                        { name: 'gdpr_consent', label: 'I accept the personal data processing terms', type: 'checkbox', required: true, span: 2 }
                    ]
                }
            ],

            async loadFormConfig() {
                try {
                    this.formConfig = await this.api('/api/accelerator/form-config');
                } catch (e) {
                    this.formConfig = [];
                }
            },

            toggleFormMode() {
                this.formEditMode = !this.formEditMode;
                const label = document.getElementById('accFormModeLabel');
                const toggleBtn = document.getElementById('accFormToggleBtn');
                const saveBtn = document.getElementById('accFormSaveBtn');
                const previewContainer = document.getElementById('accFormPreviewContainer');
                const editContainer = document.getElementById('accFormEditContainer');

                if (this.formEditMode) {
                    // Switch to edit mode - show original form
                    label.innerHTML = '<i class="fas fa-pencil-alt"></i> Edit Mode';
                    toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Preview Mode';
                    saveBtn.style.display = '';
                    previewContainer.style.display = 'none';
                    editContainer.style.display = '';
                    this.initApplicationForm();
                    this.loadDraft();
                } else {
                    // Switch to preview mode
                    label.innerHTML = '<i class="fas fa-eye"></i> Preview Mode';
                    toggleBtn.innerHTML = '<i class="fas fa-pencil-alt"></i> Edit Form';
                    saveBtn.style.display = 'none';
                    previewContainer.style.display = '';
                    editContainer.style.display = 'none';
                    this.renderFormPreview();
                }
            },

            renderFormPreview() {
                const container = document.getElementById('accFormPreviewContainer');
                if (!container) return;

                // Use DB config if available, otherwise default sections
                const sections = this.getFormSections();
                const colors = ['var(--accent-primary)', 'var(--accent-primary)', 'var(--accent-primary)', 'var(--accent-primary)', 'var(--accent-primary)', 'var(--accent-gold)', '#22c55e'];

                let html = `<div style="margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(34, 211, 238, 0.08), rgba(201, 169, 98, 0.08)); border-radius: 10px; border: 1px solid rgba(34, 211, 238, 0.2);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <i class="fas fa-eye" style="font-size: 24px; color: #22d3ee;"></i>
                        <div>
                            <div style="font-weight: 600; font-size: 15px;">Form Preview</div>
                            <div style="font-size: 12px; color: var(--text-muted);">This is how applicants see the form. Click "Edit Form" to modify fields and submit applications.</div>
                        </div>
                    </div>
                </div>`;

                sections.forEach((section, sIdx) => {
                    const color = colors[sIdx] || 'var(--accent-primary)';
                    const isGdpr = section.name.includes('GDPR') || section.name.includes('Consent');
                    const isBonus = section.name.includes('bonus') || section.name.includes('Additional Documents');
                    const sectionBg = isGdpr
                        ? 'background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05)); border: 1px solid rgba(34, 197, 94, 0.3);'
                        : 'background: var(--bg-secondary);';

                    html += `<div style="margin-bottom: 24px; padding: 20px; border-radius: 10px; ${sectionBg}">
                        <h3 style="margin: 0 0 16px 0; font-size: 16px; color: ${isGdpr ? '#22c55e' : isBonus ? 'var(--accent-gold)' : color};">
                            <i class="fas ${section.icon}" style="margin-right: 8px;"></i>${sIdx + 1}. ${section.name}
                        </h3>`;

                    if (section.fields && section.fields.length > 0) {
                        const isFileSection = section.fields.every(f => f.type === 'file');

                        if (isFileSection) {
                            // Render document list as clean preview
                            html += '<div style="display: grid; gap: 10px;">';
                            section.fields.forEach((field, fIdx) => {
                                const iconBg = field.required ? 'var(--accent-primary)' : 'var(--accent-gold)';
                                const iconColor = field.required ? 'white' : '#1a1a2e';
                                html += `<div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border-color);">
                                    <span style="width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: ${iconBg}; color: ${iconColor}; border-radius: 50%; font-size: ${field.required ? '12px' : '10px'}; font-weight: bold; flex-shrink: 0;">
                                        ${field.required ? (fIdx + 1) : '<i class="fas fa-star"></i>'}
                                    </span>
                                    <div style="flex: 1;">
                                        <div style="font-size: 13px; font-weight: 500;">${field.label}${field.required ? ' *' : ''}</div>
                                        <div style="font-size: 11px; color: var(--text-muted);">PDF, max 10 MB</div>
                                    </div>
                                    <i class="fas fa-cloud-upload-alt" style="color: var(--text-muted);"></i>
                                </div>`;
                            });
                            html += '</div>';
                        } else if (section.fields[0]?.type === 'checkbox') {
                            // GDPR consent preview
                            html += `<div style="max-height: 120px; overflow-y: auto; padding: 12px; background: var(--card-bg); border-radius: 6px; font-size: 12px; line-height: 1.6; margin-bottom: 16px; border: 1px solid var(--border-color); color: var(--text-muted);">
                                Personal data processing consent text appears here...
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; opacity: 0.7;">
                                <div style="width: 18px; height: 18px; border: 2px solid var(--border-color); border-radius: 3px;"></div>
                                <span style="font-size: 13px;"><strong>I accept the personal data processing terms</strong></span>
                            </div>`;
                        } else {
                            // Regular fields grid preview
                            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">';
                            section.fields.forEach(field => {
                                const span = field.span === 2 ? 'grid-column: span 2;' : '';
                                html += `<div style="${span}">
                                    <div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">${field.label}${field.required ? ' *' : ''}</div>
                                    <div style="padding: 10px 12px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border-color); font-size: 13px; color: var(--text-muted); min-height: ${field.type === 'textarea' ? '60px' : '20px'};">
                                        ${field.type === 'select' ? '<i class="fas fa-chevron-down" style="float: right; font-size: 10px;"></i>' : ''}
                                        ${field.placeholder || ''}
                                    </div>
                                </div>`;
                            });
                            html += '</div>';
                        }
                    }

                    html += '</div>';
                });

                // Submit buttons preview
                html += `<div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid var(--border-color); opacity: 0.6;">
                    <button class="btn btn-secondary" disabled><i class="fas fa-save"></i> Save Draft</button>
                    <button class="btn btn-primary" disabled style="padding: 12px 32px;"><i class="fas fa-paper-plane"></i> Submit Application</button>
                </div>`;

                container.innerHTML = html;
            },

            getFormSections() {
                // If we have DB config, use it; otherwise use defaults
                if (this.formConfig && this.formConfig.length > 0) {
                    const sectionMap = {};
                    this.formConfig.forEach(f => {
                        if (!sectionMap[f.section_name]) sectionMap[f.section_name] = { name: f.section_name, icon: 'fa-list', fields: [] };
                        if (f.is_visible) {
                            sectionMap[f.section_name].fields.push({
                                id: f.id,
                                name: f.field_name,
                                label: f.label || f.field_name,
                                type: f.field_type || 'text',
                                required: !!f.is_required,
                                placeholder: f.placeholder || '',
                                options: f.options || '',
                                span: 1,
                                sort_order: f.sort_order
                            });
                        }
                    });
                    return Object.values(sectionMap).sort((a, b) => {
                        const aOrder = Math.min(...a.fields.map(f => f.sort_order || 0));
                        const bOrder = Math.min(...b.fields.map(f => f.sort_order || 0));
                        return aOrder - bOrder;
                    });
                }
                return this.defaultFormSections;
            },

            async saveFormConfig() {
                // Build form config from current default sections and save to DB
                const fields = [];
                let sortOrder = 0;
                this.defaultFormSections.forEach(section => {
                    section.fields.forEach(field => {
                        fields.push({
                            id: field.id || `field-${section.name}-${field.name}`.replace(/[^a-z0-9-]/gi, '-').toLowerCase(),
                            section_name: section.name,
                            field_name: field.name,
                            field_type: field.type,
                            label: field.label,
                            placeholder: field.placeholder || '',
                            is_required: field.required,
                            options: field.options || null,
                            sort_order: sortOrder++,
                            is_visible: true
                        });
                    });
                });

                try {
                    await this.api('/api/accelerator/form-config', {
                        method: 'PUT',
                        body: JSON.stringify({ fields })
                    });
                    Toast.success('Form configuration saved to database.');
                    await this.loadFormConfig();
                } catch (err) {
                    Toast.error('Error saving form config: ' + err.message);
                }
            }
        };

        // ========== FINANCE APP ==========
        const FinanceApp = {
            workUnits: [],
            currentYear: new Date().getFullYear(),
            invoiceItems: [],

            async init() {
                await this.loadYears();
                await this.loadWorkUnits();
                await this.loadDashboard();
            },

            // Refresh all finance data — call after any operation that may affect multiple tabs
            async refreshAll() {
                this.loadDashboard();
                // Refresh the currently active tab
                const activeTab = document.querySelector('.finance-tab.active');
                if (activeTab) {
                    const tabId = activeTab.id.replace('finance-tab-', '');
                    if (tabId !== 'dashboard') { // dashboard already refreshed above
                        if (tabId === 'bank-balance') this.loadBankBalance();
                        else if (tabId === 'transactions') this.loadTransactions();
                        else if (tabId === 'work-units') this.loadWorkUnits();
                        else if (tabId === 'invoices') this.loadInvoices();
                        else if (tabId === 'payment-orders') this.loadPaymentOrders();
                        else if (tabId === 'travel-orders') this.loadTravelOrders();
                        else if (tabId === 'conference-payments') this.loadConferencePayments();
                        else if (tabId === 'reports') this.loadReports();
                    }
                }
            },

            // Year Management
            async loadYears() {
                const years = await this.api('/api/finance/years');
                const selector = document.getElementById('finYearSelector');
                if (!selector) return;

                // Include current year even if not in DB
                const yearSet = new Set(years.map(y => y.year));
                yearSet.add(new Date().getFullYear());
                const sortedYears = [...yearSet].sort((a, b) => b - a);

                selector.innerHTML = sortedYears.map(y =>
                    `<option value="${y}" ${y === this.currentYear ? 'selected' : ''}>${y}</option>`
                ).join('');
            },

            changeYear(year) {
                this.currentYear = parseInt(year);
                this.loadDashboard();
                // Reload current tab data
                const activeTab = document.querySelector('.finance-tab.active');
                if (activeTab) {
                    const tabId = activeTab.id.replace('finance-tab-', '');
                    if (tabId === 'bank-balance') this.loadBankBalance();
                    else if (tabId === 'transactions') this.loadTransactions();
                    else if (tabId === 'work-units') this.loadWorkUnits();
                    else if (tabId === 'invoices') this.loadInvoices();
                    else if (tabId === 'payment-orders') this.loadPaymentOrders();
                    else if (tabId === 'travel-orders') this.loadTravelOrders();
                    else if (tabId === 'conference-payments') this.loadConferencePayments();
                    else if (tabId === 'reports') this.loadReports();
                    else if (tabId === 'settings') this.loadSettings();
                }
            },

            async api(endpoint, options = {}) {
                const res = await fetch(endpoint, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${App.token}`,
                        ...options.headers
                    }
                });
                return res.json();
            },

            showTab(tabId, btn) {
                document.querySelectorAll('.finance-tab').forEach(t => t.classList.remove('active'));
                document.getElementById('finance-tab-' + tabId).classList.add('active');

                document.querySelectorAll('#section-finances .tab-btn').forEach(b => b.classList.remove('active'));
                if (btn) btn.classList.add('active');

                // Load tab data
                if (tabId === 'dashboard') this.loadDashboard();
                else if (tabId === 'bank-balance') this.loadBankBalance();
                else if (tabId === 'transactions') this.loadTransactions();
                else if (tabId === 'work-units') this.loadWorkUnits();
                else if (tabId === 'invoices') this.loadInvoices();
                else if (tabId === 'payment-orders') this.loadPaymentOrders();
                else if (tabId === 'travel-orders') this.loadTravelOrders();
                else if (tabId === 'conference-payments') this.loadConferencePayments();
                else if (tabId === 'reports') this.loadReports();
                else if (tabId === 'settings') this.loadSettings();
            },

            // Dashboard
            async loadDashboard() {
                const data = await this.api(`/api/finance/dashboard?year=${this.currentYear}`);

                document.getElementById('finDashBalance').textContent = this.formatCurrency(data.currentBalance);
                document.getElementById('finDashBalanceDate').textContent = data.balanceDate ? `as of ${data.balanceDate}` : '-';
                document.getElementById('finDashIncome').textContent = this.formatCurrency(data.totalIncome);
                document.getElementById('finDashExpenses').textContent = this.formatCurrency(data.totalExpenses);
                document.getElementById('finDashNet').textContent = this.formatCurrency(data.netBalance);
                document.getElementById('finDashNet').style.color = data.netBalance >= 0 ? 'var(--success)' : 'var(--danger)';
                document.getElementById('finDashPendingInvoices').textContent = data.pendingInvoices;
                document.getElementById('finDashPendingTravel').textContent = data.pendingTravelOrders;

                // Work units overview
                const wuContainer = document.getElementById('finDashWorkUnits');
                if (data.workUnitsCount > 0) {
                    const pct = data.totalBudget > 0 ? (data.usedBudget / data.totalBudget * 100).toFixed(1) : 0;
                    wuContainer.innerHTML = `
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span>${data.workUnitsCount} active work units</span>
                                <span>${pct}% used</span>
                            </div>
                            <div style="background: var(--bg-secondary); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: var(--finances); height: 100%; width: ${pct}%;"></div>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted);">
                            <span>Budget: ${this.formatCurrency(data.totalBudget)}</span>
                            <span>Remaining: ${this.formatCurrency(data.remainingBudget)}</span>
                        </div>
                    `;
                } else {
                    wuContainer.innerHTML = '<p style="color: var(--text-muted);">No active work units</p>';
                }

                // By project
                const projContainer = document.getElementById('finDashProjects');
                if (data.byProject && data.byProject.length > 0) {
                    const projects = {};
                    data.byProject.forEach(p => {
                        if (!projects[p.project]) projects[p.project] = { income: 0, expenses: 0 };
                        if (p.transaction_type === 'income') projects[p.project].income = p.total;
                        else projects[p.project].expenses = p.total;
                    });
                    projContainer.innerHTML = Object.entries(projects).map(([name, data]) => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <span style="text-transform: capitalize;">${name}</span>
                            <span><span style="color: var(--success);">${this.formatCurrency(data.income)}</span> / <span style="color: var(--danger);">${this.formatCurrency(data.expenses)}</span></span>
                        </div>
                    `).join('');
                } else {
                    projContainer.innerHTML = '<p style="color: var(--text-muted);">No transactions yet</p>';
                }
            },

            // Bank Balance
            async loadBankBalance() {
                const balances = await this.api('/api/finance/bank-balance');
                const tbody = document.getElementById('finBankBalanceTable');
                if (balances.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="padding: 20px; text-align: center; color: var(--text-muted);">No entries yet</td></tr>';
                    return;
                }
                tbody.innerHTML = balances.map(b => `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px;">${b.date}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">${this.formatCurrency(b.balance)}</td>
                        <td style="padding: 12px; color: var(--text-muted);">${b.notes || '-'}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="FinanceApp.deleteBankBalance('${b.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            openBankBalanceModal() {
                document.getElementById('finBankBalanceAmount').value = '';
                document.getElementById('finBankBalanceDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('finBankBalanceNotes').value = '';
                document.getElementById('finBankBalanceModal').classList.add('active');
            },

            async saveBankBalance() {
                const balance = parseFloat(document.getElementById('finBankBalanceAmount').value);
                const date = document.getElementById('finBankBalanceDate').value;
                const notes = document.getElementById('finBankBalanceNotes').value;

                if (!balance || !date) { Toast.warning('Please fill in balance and date'); return; }

                await this.api('/api/finance/bank-balance', {
                    method: 'POST',
                    body: JSON.stringify({ balance, date, notes })
                });

                this.closeModal('finBankBalanceModal');
                this.loadBankBalance();
                this.loadDashboard();
            },

            async deleteBankBalance(id) {
                if (!confirm('Delete this entry?')) return;
                await this.api(`/api/finance/bank-balance/${id}`, { method: 'DELETE' });
                this.loadBankBalance();
                this.loadDashboard();
            },

            // Transactions
            async loadTransactions() {
                const type = document.getElementById('finTransFilter')?.value || '';
                const project = document.getElementById('finTransProject')?.value || '';
                let url = `/api/finance/transactions?year=${this.currentYear}`;
                if (type) url += `&type=${type}`;
                if (project) url += `&project=${project}`;

                const transactions = await this.api(url);
                const tbody = document.getElementById('finTransactionsTable');
                if (transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="padding: 20px; text-align: center; color: var(--text-muted);">No transactions</td></tr>';
                    return;
                }
                tbody.innerHTML = transactions.map(t => `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px; font-weight: 500;">${t.transaction_number}</td>
                        <td style="padding: 12px;">${t.date}</td>
                        <td style="padding: 12px;">
                            <span style="background: ${t.transaction_type === 'income' ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)'}; color: ${t.transaction_type === 'income' ? 'var(--success)' : 'var(--danger)'}; padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">
                                ${t.transaction_type}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: right; font-weight: 600; color: ${t.transaction_type === 'income' ? 'var(--success)' : 'var(--danger)'};">${this.formatCurrency(t.amount)}</td>
                        <td style="padding: 12px;">${t.description || '-'}</td>
                        <td style="padding: 12px; text-transform: capitalize;">${t.project || '-'}</td>
                        <td style="padding: 12px;">${t.work_unit_code || '-'}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="FinanceApp.editTransaction('${t.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="FinanceApp.deleteTransaction('${t.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            async openTransactionModal(id = null) {
                document.getElementById('finTransactionId').value = '';
                document.getElementById('finTransactionType').value = 'income';
                document.getElementById('finTransactionAmount').value = '';
                document.getElementById('finTransactionDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('finTransactionDesc').value = '';
                document.getElementById('finTransactionProject').value = '';
                document.getElementById('finTransactionWorkUnit').value = '';
                document.getElementById('finTransactionModalTitle').textContent = 'Add Transaction';

                // Populate work units
                await this.loadWorkUnits();
                const wuSelect = document.getElementById('finTransactionWorkUnit');
                wuSelect.innerHTML = '<option value="">None</option>' + this.workUnits.map(wu => `<option value="${wu.id}">${wu.code} - ${wu.name}</option>`).join('');

                document.getElementById('finTransactionModal').classList.add('active');
            },

            async editTransaction(id) {
                const t = await this.api(`/api/finance/transactions/${id}`);
                document.getElementById('finTransactionId').value = t.id;
                document.getElementById('finTransactionType').value = t.transaction_type;
                document.getElementById('finTransactionAmount').value = t.amount;
                document.getElementById('finTransactionDate').value = t.date;
                document.getElementById('finTransactionDesc').value = t.description || '';
                document.getElementById('finTransactionProject').value = t.project || '';
                document.getElementById('finTransactionWorkUnit').value = t.work_unit_id || '';
                document.getElementById('finTransactionModalTitle').textContent = 'Edit Transaction';

                await this.loadWorkUnits();
                const wuSelect = document.getElementById('finTransactionWorkUnit');
                wuSelect.innerHTML = '<option value="">None</option>' + this.workUnits.map(wu => `<option value="${wu.id}" ${wu.id === t.work_unit_id ? 'selected' : ''}>${wu.code} - ${wu.name}</option>`).join('');

                document.getElementById('finTransactionModal').classList.add('active');
            },

            async saveTransaction() {
                const id = document.getElementById('finTransactionId').value;
                const data = {
                    transaction_type: document.getElementById('finTransactionType').value,
                    amount: parseFloat(document.getElementById('finTransactionAmount').value),
                    date: document.getElementById('finTransactionDate').value,
                    description: document.getElementById('finTransactionDesc').value,
                    project: document.getElementById('finTransactionProject').value || null,
                    work_unit_id: document.getElementById('finTransactionWorkUnit').value || null
                };

                if (!data.amount || !data.date) { Toast.warning('Please fill in amount and date'); return; }

                if (id) {
                    await this.api(`/api/finance/transactions/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await this.api('/api/finance/transactions', { method: 'POST', body: JSON.stringify(data) });
                }

                this.closeModal('finTransactionModal');
                this.loadTransactions();
                this.loadDashboard();
                // Transactions may affect work unit budget_used, refresh work units
                this.loadWorkUnits();
            },

            async deleteTransaction(id) {
                if (!confirm('Delete this transaction?')) return;
                await this.api(`/api/finance/transactions/${id}`, { method: 'DELETE' });
                this.loadTransactions();
                this.loadDashboard();
                // Transactions may affect work unit budget_used, refresh work units
                this.loadWorkUnits();
            },

            // Work Units
            async loadWorkUnits() {
                this.workUnits = await this.api(`/api/finance/work-units?year=${this.currentYear}`);
                const tbody = document.getElementById('finWorkUnitsTable');
                if (!tbody) return;
                if (this.workUnits.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="padding: 20px; text-align: center; color: var(--text-muted);">No work units</td></tr>';
                    return;
                }
                tbody.innerHTML = this.workUnits.map(wu => {
                    const remaining = wu.budget_total - wu.budget_used;
                    const pct = wu.budget_total > 0 ? (wu.budget_used / wu.budget_total * 100) : 0;
                    // Budget warnings
                    const isOverBudget = pct >= 100;
                    const isWarning = pct >= 80 && pct < 100;
                    const rowStyle = isOverBudget ? 'background: rgba(239,68,68,0.1);' : (isWarning ? 'background: rgba(245,158,11,0.1);' : '');
                    const budgetIcon = isOverBudget ? '<i class="fas fa-exclamation-circle" style="color: var(--danger); margin-left: 4px;" title="Over budget!"></i>' : (isWarning ? '<i class="fas fa-exclamation-triangle" style="color: var(--warning); margin-left: 4px;" title="Budget warning: > 80% used"></i>' : '');
                    return `
                        <tr style="border-bottom: 1px solid var(--border); ${rowStyle}">
                            <td style="padding: 12px; font-weight: 600;">${wu.code}</td>
                            <td style="padding: 12px;">${wu.name}</td>
                            <td style="padding: 12px; color: var(--text-muted);">${wu.grant_source || '-'}</td>
                            <td style="padding: 12px; text-align: right;">${this.formatCurrency(wu.budget_total)}</td>
                            <td style="padding: 12px; text-align: right; color: var(--danger);">${this.formatCurrency(wu.budget_used)} <span style="font-size: 11px; color: var(--text-muted);">(${pct.toFixed(1)}%)</span>${budgetIcon}</td>
                            <td style="padding: 12px; text-align: right; color: ${remaining < 0 ? 'var(--danger)' : 'var(--success)'};">${this.formatCurrency(remaining)}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="background: ${wu.status === 'active' ? 'rgba(34,197,94,0.2)' : 'rgba(156,163,175,0.2)'}; color: ${wu.status === 'active' ? 'var(--success)' : 'var(--text-muted)'}; padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">
                                    ${wu.status}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="FinanceApp.editWorkUnit('${wu.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="FinanceApp.deleteWorkUnit('${wu.id}')"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            openWorkUnitModal() {
                document.getElementById('finWorkUnitId').value = '';
                document.getElementById('finWorkUnitCode').value = '';
                document.getElementById('finWorkUnitName').value = '';
                document.getElementById('finWorkUnitSource').value = '';
                document.getElementById('finWorkUnitBudget').value = '';
                document.getElementById('finWorkUnitDesc').value = '';
                document.getElementById('finWorkUnitModalTitle').textContent = 'Add Work Unit';
                document.getElementById('finWorkUnitModal').classList.add('active');
            },

            async editWorkUnit(id) {
                const wu = await this.api(`/api/finance/work-units/${id}`);
                document.getElementById('finWorkUnitId').value = wu.id;
                document.getElementById('finWorkUnitCode').value = wu.code;
                document.getElementById('finWorkUnitName').value = wu.name;
                document.getElementById('finWorkUnitSource').value = wu.grant_source || '';
                document.getElementById('finWorkUnitBudget').value = wu.budget_total;
                document.getElementById('finWorkUnitDesc').value = wu.description || '';
                document.getElementById('finWorkUnitModalTitle').textContent = 'Edit Work Unit';
                document.getElementById('finWorkUnitModal').classList.add('active');
            },

            async saveWorkUnit() {
                const id = document.getElementById('finWorkUnitId').value;
                const data = {
                    code: document.getElementById('finWorkUnitCode').value,
                    name: document.getElementById('finWorkUnitName').value,
                    grant_source: document.getElementById('finWorkUnitSource').value,
                    budget_total: parseFloat(document.getElementById('finWorkUnitBudget').value) || 0,
                    description: document.getElementById('finWorkUnitDesc').value,
                    fiscal_year: this.currentYear,
                    status: 'active'
                };

                if (!data.code || !data.name) { Toast.warning('Please fill in code and name'); return; }

                if (id) {
                    await this.api(`/api/finance/work-units/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await this.api('/api/finance/work-units', { method: 'POST', body: JSON.stringify(data) });
                }

                this.closeModal('finWorkUnitModal');
                this.loadWorkUnits();
                this.loadDashboard();
            },

            async deleteWorkUnit(id) {
                if (!confirm('Delete this work unit?')) return;
                const result = await this.api(`/api/finance/work-units/${id}`, { method: 'DELETE' });
                if (result.error) {
                    Toast.error(result.error);
                    return;
                }
                this.loadWorkUnits();
                this.loadDashboard();
            },

            // Invoices
            async loadInvoices() {
                const direction = document.getElementById('finInvoiceDirection')?.value || '';
                let url = `/api/finance/invoices?year=${this.currentYear}`;
                if (direction) url += `&direction=${direction}`;

                const invoices = await this.api(url);
                const tbody = document.getElementById('finInvoicesTable');
                if (invoices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="padding: 20px; text-align: center; color: var(--text-muted);">No invoices</td></tr>';
                    return;
                }
                tbody.innerHTML = invoices.map(inv => `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px; font-weight: 600;">${inv.invoice_number}</td>
                        <td style="padding: 12px;">
                            <span style="background: ${inv.direction === 'outgoing' ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)'}; color: ${inv.direction === 'outgoing' ? 'var(--success)' : 'var(--danger)'}; padding: 2px 8px; border-radius: 4px; font-size: 11px;">
                                ${inv.direction === 'outgoing' ? 'Outgoing' : 'Incoming'}
                            </span>
                        </td>
                        <td style="padding: 12px;">${inv.party_name}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">${this.formatCurrency(inv.total)}</td>
                        <td style="padding: 12px;">${inv.issue_date || '-'}</td>
                        <td style="padding: 12px;">${inv.due_date || '-'}</td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background: ${inv.status === 'paid' ? 'rgba(34,197,94,0.2)' : inv.status === 'issued' ? 'rgba(245,158,11,0.2)' : 'rgba(156,163,175,0.2)'}; color: ${inv.status === 'paid' ? 'var(--success)' : inv.status === 'issued' ? 'var(--warning)' : 'var(--text-muted)'}; padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">
                                ${inv.status}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="window.open('/api/finance/invoices/${inv.id}/pdf', '_blank')" title="View PDF"><i class="fas fa-file-pdf"></i></button>
                            ${inv.status === 'draft' ? `<button class="btn btn-secondary" style="padding: 4px 8px;" onclick="FinanceApp.issueInvoice('${inv.id}')" title="Issue"><i class="fas fa-paper-plane"></i></button>` : ''}
                            ${inv.status === 'issued' ? `<button class="btn btn-secondary" style="padding: 4px 8px;" onclick="FinanceApp.markInvoicePaid('${inv.id}')" title="Mark Paid"><i class="fas fa-check"></i></button>` : ''}
                            <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="FinanceApp.deleteInvoice('${inv.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            openInvoiceModal() {
                document.getElementById('finInvoiceId').value = '';
                document.getElementById('finInvoiceDirection2').value = 'outgoing';
                document.getElementById('finInvoiceFiscalized').value = '0';
                document.getElementById('finInvoicePartyName').value = '';
                document.getElementById('finInvoicePartyAddress').value = '';
                document.getElementById('finInvoicePartyOib').value = '';
                document.getElementById('finInvoicePartyEmail').value = '';
                document.getElementById('finInvoiceIssueDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('finInvoiceDueDate').value = '';
                document.getElementById('finInvoiceNotes').value = '';
                document.getElementById('finInvoiceModalTitle').textContent = 'Create Invoice';
                this.invoiceItems = [];
                this.addInvoiceItem();
                document.getElementById('finInvoiceModal').classList.add('active');
            },

            addInvoiceItem() {
                const container = document.getElementById('finInvoiceItems');
                const idx = this.invoiceItems.length;
                this.invoiceItems.push({ description: '', quantity: 1, unit_price: 0, discount_percent: 0, vat_rate: 25 });
                container.innerHTML += `
                    <div class="invoice-item" data-idx="${idx}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; align-items: end;">
                        <input type="text" placeholder="Description" onchange="FinanceApp.updateInvoiceItem(${idx}, 'description', this.value)" style="padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        <input type="number" placeholder="Qty" value="1" onchange="FinanceApp.updateInvoiceItem(${idx}, 'quantity', this.value)" style="padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        <input type="number" placeholder="Price" step="0.01" onchange="FinanceApp.updateInvoiceItem(${idx}, 'unit_price', this.value)" style="padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        <input type="number" placeholder="Disc %" value="0" onchange="FinanceApp.updateInvoiceItem(${idx}, 'discount_percent', this.value)" style="padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        <input type="number" placeholder="VAT %" value="25" onchange="FinanceApp.updateInvoiceItem(${idx}, 'vat_rate', this.value)" style="padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                        <button class="btn btn-secondary" style="padding: 8px;" onclick="FinanceApp.removeInvoiceItem(${idx})"><i class="fas fa-times"></i></button>
                    </div>
                `;
            },

            updateInvoiceItem(idx, field, value) {
                if (this.invoiceItems[idx]) {
                    this.invoiceItems[idx][field] = field === 'description' ? value : parseFloat(value) || 0;
                    this.calculateInvoiceTotals();
                }
            },

            removeInvoiceItem(idx) {
                this.invoiceItems.splice(idx, 1);
                this.renderInvoiceItems();
            },

            renderInvoiceItems() {
                const container = document.getElementById('finInvoiceItems');
                container.innerHTML = '';
                this.invoiceItems.forEach((item, idx) => {
                    container.innerHTML += `
                        <div class="invoice-item" data-idx="${idx}" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; align-items: end;">
                            <input type="text" placeholder="Description" value="${item.description}" onchange="FinanceApp.updateInvoiceItem(${idx}, 'description', this.value)" style="padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <input type="number" placeholder="Qty" value="${item.quantity}" onchange="FinanceApp.updateInvoiceItem(${idx}, 'quantity', this.value)" style="padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <input type="number" placeholder="Price" step="0.01" value="${item.unit_price}" onchange="FinanceApp.updateInvoiceItem(${idx}, 'unit_price', this.value)" style="padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <input type="number" placeholder="Disc %" value="${item.discount_percent}" onchange="FinanceApp.updateInvoiceItem(${idx}, 'discount_percent', this.value)" style="padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <input type="number" placeholder="VAT %" value="${item.vat_rate}" onchange="FinanceApp.updateInvoiceItem(${idx}, 'vat_rate', this.value)" style="padding: 8px; border-radius: 4px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-primary);">
                            <button class="btn btn-secondary" style="padding: 8px;" onclick="FinanceApp.removeInvoiceItem(${idx})"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                });
                this.calculateInvoiceTotals();
            },

            calculateInvoiceTotals() {
                let subtotal = 0, discount = 0, vat = 0;
                this.invoiceItems.forEach(item => {
                    const lineSubtotal = (item.quantity || 1) * (item.unit_price || 0);
                    const discountAmt = lineSubtotal * ((item.discount_percent || 0) / 100);
                    const afterDiscount = lineSubtotal - discountAmt;
                    const vatAmt = afterDiscount * ((item.vat_rate || 0) / 100);
                    subtotal += lineSubtotal;
                    discount += discountAmt;
                    vat += vatAmt;
                });
                const total = subtotal - discount + vat;
                document.getElementById('finInvoiceSubtotal').textContent = this.formatCurrency(subtotal);
                document.getElementById('finInvoiceDiscount').textContent = this.formatCurrency(discount);
                document.getElementById('finInvoiceVat').textContent = this.formatCurrency(vat);
                document.getElementById('finInvoiceTotal').textContent = this.formatCurrency(total);
            },

            async saveInvoice() {
                const id = document.getElementById('finInvoiceId').value;
                const data = {
                    direction: document.getElementById('finInvoiceDirection2').value,
                    fiscalized: document.getElementById('finInvoiceFiscalized').value === '1',
                    party_name: document.getElementById('finInvoicePartyName').value,
                    party_address: document.getElementById('finInvoicePartyAddress').value,
                    party_oib: document.getElementById('finInvoicePartyOib').value,
                    party_email: document.getElementById('finInvoicePartyEmail').value,
                    issue_date: document.getElementById('finInvoiceIssueDate').value,
                    due_date: document.getElementById('finInvoiceDueDate').value,
                    notes: document.getElementById('finInvoiceNotes').value,
                    invoice_type: 'standard',
                    fiscal_year: this.currentYear,
                    items: this.invoiceItems.filter(i => i.description && i.unit_price)
                };

                if (!data.party_name) { Toast.warning('Please fill in party name'); return; }
                if (data.items.length === 0) { Toast.warning('Please add at least one item'); return; }

                if (id) {
                    await this.api(`/api/finance/invoices/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await this.api('/api/finance/invoices', { method: 'POST', body: JSON.stringify(data) });
                }

                this.closeModal('finInvoiceModal');
                this.loadInvoices();
                this.loadDashboard();
            },

            async issueInvoice(id) {
                if (!confirm('Issue this invoice?')) return;
                await this.api(`/api/finance/invoices/${id}/issue`, { method: 'POST' });
                this.loadInvoices();
                this.loadDashboard();
            },

            async markInvoicePaid(id) {
                if (!confirm('Mark this invoice as paid? This will create a transaction.')) return;
                await this.api(`/api/finance/invoices/${id}/mark-paid`, { method: 'POST' });
                this.loadInvoices();
                this.loadDashboard();
                // Marking paid creates a transaction, so refresh transactions list if it's been loaded
                this.loadTransactions();
            },

            async deleteInvoice(id) {
                if (!confirm('Delete this invoice?')) return;
                await this.api(`/api/finance/invoices/${id}`, { method: 'DELETE' });
                this.loadInvoices();
                this.loadDashboard();
            },

            // Payment Orders
            async loadPaymentOrders() {
                const orders = await this.api(`/api/finance/payment-orders?year=${this.currentYear}`);
                const tbody = document.getElementById('finPaymentOrdersTable');
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: var(--text-muted);">No payment orders</td></tr>';
                    return;
                }
                tbody.innerHTML = orders.map(po => `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px; font-weight: 600;">${po.order_number}</td>
                        <td style="padding: 12px;">${po.recipient_name}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">${this.formatCurrency(po.amount)}</td>
                        <td style="padding: 12px;">${po.date}</td>
                        <td style="padding: 12px; text-transform: capitalize;">${po.project || '-'}</td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background: ${po.status === 'executed' ? 'rgba(34,197,94,0.2)' : 'rgba(245,158,11,0.2)'}; color: ${po.status === 'executed' ? 'var(--success)' : 'var(--warning)'}; padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">
                                ${po.status}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="FinanceApp.editPaymentOrder('${po.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="FinanceApp.deletePaymentOrder('${po.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            openPaymentOrderModal() {
                document.getElementById('finPaymentOrderId').value = '';
                document.getElementById('finPaymentOrderRecipient').value = '';
                document.getElementById('finPaymentOrderIban').value = '';
                document.getElementById('finPaymentOrderAmount').value = '';
                document.getElementById('finPaymentOrderDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('finPaymentOrderRef').value = '';
                document.getElementById('finPaymentOrderDesc').value = '';
                document.getElementById('finPaymentOrderProject').value = '';
                document.getElementById('finPaymentOrderModalTitle').textContent = 'Add Payment Order';
                document.getElementById('finPaymentOrderModal').classList.add('active');
            },

            async editPaymentOrder(id) {
                const po = await this.api(`/api/finance/payment-orders/${id}`);
                document.getElementById('finPaymentOrderId').value = po.id;
                document.getElementById('finPaymentOrderRecipient').value = po.recipient_name;
                document.getElementById('finPaymentOrderIban').value = po.recipient_iban || '';
                document.getElementById('finPaymentOrderAmount').value = po.amount;
                document.getElementById('finPaymentOrderDate').value = po.date;
                document.getElementById('finPaymentOrderRef').value = po.reference || '';
                document.getElementById('finPaymentOrderDesc').value = po.description || '';
                document.getElementById('finPaymentOrderProject').value = po.project || '';
                document.getElementById('finPaymentOrderModalTitle').textContent = 'Edit Payment Order';
                document.getElementById('finPaymentOrderModal').classList.add('active');
            },

            async savePaymentOrder() {
                const id = document.getElementById('finPaymentOrderId').value;
                const data = {
                    recipient_name: document.getElementById('finPaymentOrderRecipient').value,
                    recipient_iban: document.getElementById('finPaymentOrderIban').value,
                    amount: parseFloat(document.getElementById('finPaymentOrderAmount').value),
                    date: document.getElementById('finPaymentOrderDate').value,
                    reference: document.getElementById('finPaymentOrderRef').value,
                    description: document.getElementById('finPaymentOrderDesc').value,
                    project: document.getElementById('finPaymentOrderProject').value || null,
                    fiscal_year: this.currentYear,
                    status: 'pending'
                };

                if (!data.recipient_name || !data.amount || !data.date) { Toast.warning('Please fill in recipient, amount and date'); return; }

                if (id) {
                    await this.api(`/api/finance/payment-orders/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await this.api('/api/finance/payment-orders', { method: 'POST', body: JSON.stringify(data) });
                }

                this.closeModal('finPaymentOrderModal');
                this.loadPaymentOrders();
                this.loadDashboard();
            },

            async deletePaymentOrder(id) {
                if (!confirm('Delete this payment order?')) return;
                await this.api(`/api/finance/payment-orders/${id}`, { method: 'DELETE' });
                this.loadPaymentOrders();
                this.loadDashboard();
            },

            // Travel Orders
            async loadTravelOrders() {
                const status = document.getElementById('finTravelStatus')?.value || '';
                let url = `/api/finance/travel-orders?year=${this.currentYear}`;
                if (status) url += `&status=${status}`;

                const orders = await this.api(url);
                const tbody = document.getElementById('finTravelOrdersTable');
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="padding: 20px; text-align: center; color: var(--text-muted);">No travel orders</td></tr>';
                    return;
                }
                tbody.innerHTML = orders.map(to => {
                    const statusColors = {
                        assigned: { bg: 'rgba(59,130,246,0.2)', color: '#3b82f6' },
                        submitted: { bg: 'rgba(245,158,11,0.2)', color: 'var(--warning)' },
                        approved: { bg: 'rgba(34,197,94,0.2)', color: 'var(--success)' },
                        rejected: { bg: 'rgba(239,68,68,0.2)', color: 'var(--danger)' },
                        paid: { bg: 'rgba(16,185,129,0.2)', color: 'var(--finances)' }
                    };
                    const sc = statusColors[to.status] || statusColors.assigned;
                    return `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 12px; font-weight: 600;">${to.order_number}</td>
                            <td style="padding: 12px;">${to.traveler_name}</td>
                            <td style="padding: 12px;">${to.destination}</td>
                            <td style="padding: 12px;">${to.planned_departure || '-'} - ${to.planned_return || '-'}</td>
                            <td style="padding: 12px; text-align: right; font-weight: 600;">${this.formatCurrency(to.cost_total || 0)}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="background: ${sc.bg}; color: ${sc.color}; padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">
                                    ${to.status}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="FinanceApp.viewTravelOrder('${to.id}')" title="View"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="window.open('/api/finance/travel-orders/${to.id}/pdf', '_blank')" title="PDF"><i class="fas fa-file-pdf"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            async openTravelOrderModal() {
                document.getElementById('finTravelOrderId').value = '';
                document.getElementById('finTravelOrderDest').value = '';
                document.getElementById('finTravelOrderPurpose').value = '';
                document.getElementById('finTravelOrderDeparture').value = '';
                document.getElementById('finTravelOrderReturn').value = '';
                document.getElementById('finTravelOrderMethod').value = 'plane';
                document.getElementById('finTravelOrderAdvance').value = '0';
                document.getElementById('finTravelOrderProject').value = '';
                document.getElementById('finTravelOrderNotes').value = '';
                document.getElementById('finTravelOrderModalTitle').textContent = 'Create Travel Order';

                // Load team members
                const members = await this.api('/api/team');
                const select = document.getElementById('finTravelOrderTraveler');
                select.innerHTML = '<option value="">Select team member</option>' + members.map(m => `<option value="${m.id}" data-name="${m.name}">${m.name}</option>`).join('');

                document.getElementById('finTravelOrderModal').classList.add('active');
            },

            async saveTravelOrder() {
                const travelerSelect = document.getElementById('finTravelOrderTraveler');
                const selectedOption = travelerSelect.options[travelerSelect.selectedIndex];
                const data = {
                    traveler_id: travelerSelect.value,
                    traveler_name: selectedOption?.dataset?.name || '',
                    destination: document.getElementById('finTravelOrderDest').value,
                    purpose: document.getElementById('finTravelOrderPurpose').value,
                    planned_departure: document.getElementById('finTravelOrderDeparture').value,
                    planned_return: document.getElementById('finTravelOrderReturn').value,
                    travel_method: document.getElementById('finTravelOrderMethod').value,
                    advance_amount: parseFloat(document.getElementById('finTravelOrderAdvance').value) || 0,
                    project: document.getElementById('finTravelOrderProject').value || null,
                    notes: document.getElementById('finTravelOrderNotes').value,
                    fiscal_year: this.currentYear
                };

                if (!data.traveler_id || !data.destination) { Toast.warning('Please select traveler and destination'); return; }

                await this.api('/api/finance/travel-orders', { method: 'POST', body: JSON.stringify(data) });
                this.closeModal('finTravelOrderModal');
                this.loadTravelOrders();
                this.loadDashboard();
            },

            async viewTravelOrder(id) {
                const order = await this.api(`/api/finance/travel-orders/${id}`);
                const body = document.getElementById('finTravelOrderDetailBody');
                const footer = document.getElementById('finTravelOrderDetailFooter');
                document.getElementById('finTravelOrderDetailTitle').textContent = `Travel Order ${order.order_number}`;

                body.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div><strong>Traveler:</strong> ${order.traveler_name}</div>
                        <div><strong>Status:</strong> ${order.status.toUpperCase()}</div>
                        <div><strong>Destination:</strong> ${order.destination}</div>
                        <div><strong>Purpose:</strong> ${order.purpose || '-'}</div>
                        <div><strong>Planned:</strong> ${order.planned_departure || '-'} to ${order.planned_return || '-'}</div>
                        <div><strong>Actual:</strong> ${order.actual_departure || '-'} to ${order.actual_return || '-'}</div>
                    </div>
                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h4 style="margin-bottom: 12px;">Costs</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div>Transport: ${this.formatCurrency(order.cost_transport || 0)}</div>
                            <div>Accommodation: ${this.formatCurrency(order.cost_accommodation || 0)}</div>
                            <div>Daily Allowance: ${this.formatCurrency(order.cost_daily_allowance || 0)}</div>
                            <div>Other: ${this.formatCurrency(order.cost_other || 0)}</div>
                        </div>
                        <div style="margin-top: 12px; font-size: 18px; font-weight: 600;">Total: ${this.formatCurrency(order.cost_total || 0)}</div>
                        ${order.advance_amount > 0 ? `<div>Advance: ${this.formatCurrency(order.advance_amount)}</div>` : ''}
                        ${order.reimbursement_amount ? `<div>To Reimburse: ${this.formatCurrency(order.reimbursement_amount)}</div>` : ''}
                    </div>
                    ${order.traveler_notes ? `<div style="margin-bottom: 16px;"><strong>Traveler Notes:</strong> ${order.traveler_notes}</div>` : ''}
                    ${order.rejection_reason ? `<div style="color: var(--danger); margin-bottom: 16px;"><strong>Rejection Reason:</strong> ${order.rejection_reason}</div>` : ''}
                    ${order.evidence && order.evidence.length > 0 ? `
                        <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                            <h4 style="margin-bottom: 12px;">Evidence Files</h4>
                            ${order.evidence.map(e => `<div style="margin-bottom: 4px;"><a href="${e.file_path}" target="_blank">${e.file_name}</a></div>`).join('')}
                        </div>
                    ` : ''}
                `;

                // Footer actions based on status
                let actions = '<button class="btn btn-secondary" onclick="FinanceApp.closeModal(\'finTravelOrderDetailModal\')">Close</button>';
                if (order.status === 'submitted') {
                    actions += ` <button class="btn btn-primary" onclick="FinanceApp.approveTravelOrder('${id}')"><i class="fas fa-check"></i> Approve</button>`;
                    actions += ` <button class="btn btn-danger" onclick="FinanceApp.rejectTravelOrder('${id}')"><i class="fas fa-times"></i> Reject</button>`;
                } else if (order.status === 'approved') {
                    actions += ` <button class="btn btn-primary" onclick="FinanceApp.payTravelOrder('${id}')"><i class="fas fa-euro-sign"></i> Mark Paid</button>`;
                }
                footer.innerHTML = actions;

                document.getElementById('finTravelOrderDetailModal').classList.add('active');
            },

            async approveTravelOrder(id) {
                if (!confirm('Approve this travel order?')) return;
                await this.api(`/api/finance/travel-orders/${id}/approve`, { method: 'POST' });
                this.closeModal('finTravelOrderDetailModal');
                this.loadTravelOrders();
                this.loadDashboard();
            },

            async rejectTravelOrder(id) {
                const reason = prompt('Rejection reason:');
                if (reason === null) return;
                await this.api(`/api/finance/travel-orders/${id}/reject`, {
                    method: 'POST',
                    body: JSON.stringify({ rejection_reason: reason })
                });
                this.closeModal('finTravelOrderDetailModal');
                this.loadTravelOrders();
                this.loadDashboard();
            },

            async payTravelOrder(id) {
                if (!confirm('Mark this travel order as paid? This will create an expense transaction.')) return;
                await this.api(`/api/finance/travel-orders/${id}/pay`, { method: 'POST' });
                this.closeModal('finTravelOrderDetailModal');
                this.loadTravelOrders();
                this.loadDashboard();
                // Paying creates an expense transaction, so refresh transactions list
                this.loadTransactions();
            },

            // Conference Payments
            _confPaySearchTimeout: null,
            _confPaySourceFilter: 'all',

            debounceConfPaySearch() {
                clearTimeout(this._confPaySearchTimeout);
                this._confPaySearchTimeout = setTimeout(() => this.loadConferencePayments(), 300);
            },

            filterConfPaySource(source) {
                this._confPaySourceFilter = source;
                // Update button styles
                document.querySelectorAll('.confPaySrcBtn').forEach(btn => {
                    btn.style.border = '2px solid transparent';
                    btn.style.opacity = '0.7';
                });
                const activeBtn = document.getElementById('confPaySrc' + source.charAt(0).toUpperCase() + source.slice(1));
                if (activeBtn) {
                    activeBtn.style.border = '2px solid var(--border)';
                    activeBtn.style.opacity = '1';
                }
                this.loadConferencePayments();
            },

            _getSourceBadge(source) {
                const colors = { plexus: '#6366f1', gala: '#C9A962', accelerator: '#3b82f6', forum: '#14b8a6' };
                const labels = { plexus: 'Plexus', gala: 'Gala', accelerator: 'Accelerator', forum: 'Forum' };
                const color = colors[source] || '#64748b';
                const label = labels[source] || source;
                return `<span style="padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; background: ${color}18; color: ${color}; white-space: nowrap;">${label}</span>`;
            },

            async loadConferencePayments() {
                const status = document.getElementById('confPayStatusFilter')?.value || 'all';
                const search = document.getElementById('confPaySearch')?.value || '';
                const source = this._confPaySourceFilter || 'all';

                let url = `/api/finance/conference-payments?status=${status}&source=${source}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;

                const data = await this.api(url);

                // Update summary cards
                if (data.summary) {
                    document.getElementById('confPayTotal').textContent = data.summary.total;
                    document.getElementById('confPayPending').textContent = data.summary.pending;
                    document.getElementById('confPayPaid').textContent = data.summary.paid;
                    document.getElementById('confPayRevenue').textContent = this.formatCurrency(data.summary.totalRevenue);
                    document.getElementById('confPayPendingRevenue').textContent = '€' + (data.summary.pendingRevenue || 0).toFixed(2);
                }

                // Render table
                const tbody = document.getElementById('confPayTable');
                if (!tbody) return;

                if (!data.payments || data.payments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--text-muted);"><i class="fas fa-inbox" style="font-size: 24px; display: block; margin-bottom: 8px;"></i>No payments found</td></tr>';
                    return;
                }

                tbody.innerHTML = data.payments.map(p => {
                    const isCard = p.payment_method === 'card';
                    const methodIcon = isCard
                        ? '<i class="fas fa-credit-card" style="color: #6366f1;" title="Card (Stripe)"></i>'
                        : '<i class="fas fa-university" style="color: #C9A962;" title="Bank Transfer"></i>';
                    const stripeRef = p.stripe_payment_id
                        ? `<div style="font-size: 10px; color: var(--text-muted); font-family: monospace;" title="${this.escapeHtml(p.stripe_payment_id)}">Stripe: ${this.escapeHtml(p.stripe_payment_id.substring(0, 16))}...</div>`
                        : '';
                    return `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px 16px;">
                            <div style="font-weight: 600; color: var(--text-primary);">${this.escapeHtml(p.attendee)}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">${this.escapeHtml(p.email || '')}</div>
                            ${p.institution ? `<div style="font-size: 11px; color: var(--text-muted);">${this.escapeHtml(p.institution)}</div>` : ''}
                        </td>
                        <td style="padding: 12px 16px; text-align: center;">${this._getSourceBadge(p.source)}</td>
                        <td style="padding: 12px 16px;">
                            <div style="font-family: monospace; font-size: 13px; font-weight: 600;">${this.escapeHtml(p.invoice_number || '—')}</div>
                            ${p.fira_invoice_number ? `<div style="font-size: 11px; color: var(--text-muted);">FIRA: ${this.escapeHtml(p.fira_invoice_number)}</div>` : ''}
                            ${stripeRef}
                        </td>
                        <td style="padding: 12px 16px; font-size: 13px;">${this.escapeHtml(p.ticket || '')}</td>
                        <td style="padding: 12px 16px; text-align: right; font-weight: 600; font-size: 14px;">${p.amount > 0 ? '€' + Number(p.amount).toFixed(2) : 'Free'}</td>
                        <td style="padding: 12px 16px; text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 6px;">
                                ${methodIcon}
                                <span style="padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;
                                    background: ${p.payment_status === 'paid' ? 'rgba(34,197,94,0.15)' : 'rgba(245,158,11,0.15)'};
                                    color: ${p.payment_status === 'paid' ? '#16a34a' : '#d97706'};">
                                    ${p.payment_status === 'paid' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-clock"></i>'}
                                    ${(p.payment_status || 'pending').charAt(0).toUpperCase() + (p.payment_status || 'pending').slice(1)}
                                </span>
                            </div>
                        </td>
                        <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">
                            ${p.created_at ? new Date(p.created_at).toLocaleDateString() : '—'}
                            ${p.due_date ? `<div style="font-size: 11px;">Due: ${p.due_date}</div>` : ''}
                        </td>
                        <td style="padding: 12px 16px; text-align: center;">
                            ${(p.payment_status === 'pending' || p.payment_status === 'unpaid') && p.amount > 0 && p.source === 'plexus' ?
                                `<button onclick="FinanceApp.confirmConferencePayment('${p.id}', '${this.escapeHtml(p.attendee)}')" style="padding: 6px 14px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                                    <i class="fas fa-check"></i> Mark Paid
                                </button>` :
                                p.payment_status === 'paid' ? '<span style="color: var(--text-muted); font-size: 12px;"><i class="fas fa-check-double"></i></span>' : '—'
                            }
                        </td>
                    </tr>`;
                }).join('');
            },

            async confirmConferencePayment(regId, attendeeName) {
                if (!confirm(`Confirm bank transfer received from ${attendeeName}?`)) return;

                const res = await this.api(`/api/finance/conference-payments/${regId}/confirm`, {
                    method: 'POST'
                });

                if (res.success) {
                    Toast.success(`Payment confirmed for ${attendeeName}`);
                    this.loadConferencePayments();
                } else {
                    Toast.error(res.error || 'Failed to confirm payment');
                }
            },

            escapeHtml(str) {
                if (!str) return '';
                return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            },

            // Reports
            async loadReports() {
                const [byProject, byWorkUnit, monthly] = await Promise.all([
                    this.api(`/api/finance/reports/by-project?year=${this.currentYear}`),
                    this.api(`/api/finance/reports/by-work-unit?year=${this.currentYear}`),
                    this.api(`/api/finance/reports/monthly?year=${this.currentYear}`)
                ]);

                // By project
                const projTable = document.getElementById('finReportProjectTable');
                if (byProject.length === 0) {
                    projTable.innerHTML = '<tr><td colspan="4" style="padding: 10px; color: var(--text-muted);">No data</td></tr>';
                } else {
                    projTable.innerHTML = byProject.map(p => `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 10px; text-transform: capitalize;">${p.project}</td>
                            <td style="padding: 10px; text-align: right; color: var(--success);">${this.formatCurrency(p.total_income)}</td>
                            <td style="padding: 10px; text-align: right; color: var(--danger);">${this.formatCurrency(p.total_expenses)}</td>
                            <td style="padding: 10px; text-align: right; font-weight: 600;">${this.formatCurrency(p.total_income - p.total_expenses)}</td>
                        </tr>
                    `).join('');
                }

                // By work unit
                const wuTable = document.getElementById('finReportWorkUnitTable');
                if (byWorkUnit.length === 0) {
                    wuTable.innerHTML = '<tr><td colspan="5" style="padding: 10px; color: var(--text-muted);">No data</td></tr>';
                } else {
                    wuTable.innerHTML = byWorkUnit.map(wu => {
                        const pct = wu.budget_total > 0 ? (wu.budget_used / wu.budget_total * 100).toFixed(1) : 0;
                        return `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 10px; font-weight: 600;">${wu.code}</td>
                                <td style="padding: 10px;">${wu.name}</td>
                                <td style="padding: 10px; text-align: right;">${this.formatCurrency(wu.budget_total)}</td>
                                <td style="padding: 10px; text-align: right; color: var(--danger);">${this.formatCurrency(wu.budget_used)}</td>
                                <td style="padding: 10px; text-align: right;">${pct}%</td>
                            </tr>
                        `;
                    }).join('');
                }

                // Monthly
                const monthTable = document.getElementById('finReportMonthlyTable');
                if (monthly.length === 0) {
                    monthTable.innerHTML = '<tr><td colspan="4" style="padding: 10px; color: var(--text-muted);">No data</td></tr>';
                } else {
                    monthTable.innerHTML = monthly.map(m => `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 10px;">${m.month}</td>
                            <td style="padding: 10px; text-align: right; color: var(--success);">${this.formatCurrency(m.income)}</td>
                            <td style="padding: 10px; text-align: right; color: var(--danger);">${this.formatCurrency(m.expenses)}</td>
                            <td style="padding: 10px; text-align: right; font-weight: 600;">${this.formatCurrency(m.income - m.expenses)}</td>
                        </tr>
                    `).join('');
                }
            },

            // Close year
            async closeYear() {
                if (!confirm(`Close fiscal year ${this.currentYear}? This will close all work units for this year.`)) return;
                await this.api(`/api/finance/years/${this.currentYear}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: 'closed' })
                });
                Toast.success('Fiscal year closed.');
                // Closing a year affects all data — do a full refresh
                this.loadWorkUnits();
                this.refreshAll();
            },

            // Settings
            async loadSettings() {
                try {
                    const settings = await this.api('/api/finance/settings');
                    document.getElementById('finSettingCompanyName').value = settings.company_name || '';
                    document.getElementById('finSettingOib').value = settings.company_oib || '';
                    document.getElementById('finSettingAddress').value = settings.company_address || '';
                    document.getElementById('finSettingEmail').value = settings.company_email || '';
                    document.getElementById('finSettingIban').value = settings.company_iban || '';
                    document.getElementById('finSettingDailyRate').value = settings.daily_allowance_rate || '';
                    document.getElementById('finSettingKmRate').value = settings.km_rate || '';
                    document.getElementById('finSettingInvoiceFooter').value = settings.invoice_footer || '';
                } catch (e) {
                    // No settings yet
                }
            },

            async saveSettings() {
                const data = {
                    company_name: document.getElementById('finSettingCompanyName').value,
                    company_oib: document.getElementById('finSettingOib').value,
                    company_address: document.getElementById('finSettingAddress').value,
                    company_email: document.getElementById('finSettingEmail').value,
                    company_iban: document.getElementById('finSettingIban').value,
                    daily_allowance_rate: parseFloat(document.getElementById('finSettingDailyRate').value) || null,
                    km_rate: parseFloat(document.getElementById('finSettingKmRate').value) || null,
                    invoice_footer: document.getElementById('finSettingInvoiceFooter').value
                };

                await this.api('/api/finance/settings', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                Toast.success('Settings saved.');
            },

            // Helpers
            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'EUR' }).format(amount || 0);
            },

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }
        };

        // ===== NETWORK APP =====
        const NetworkApp = {
            contacts: [],

            async api(endpoint, options = {}) {
                const res = await fetch(endpoint, {
                    ...options,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.token}`, ...options.headers }
                });
                return res.json();
            },

            async init() {
                const contacts = await this.api('/api/contacts');
                document.getElementById('networkCount').textContent = contacts.length || 0;
            },

            openPanel() {
                document.getElementById('networkPanel').style.left = '0';
                document.getElementById('networkOverlay').style.display = 'block';
                this.loadContacts();
            },

            closePanel() {
                document.getElementById('networkPanel').style.left = '-65%';
                document.getElementById('networkOverlay').style.display = 'none';
            },

            async loadContacts() {
                const search = document.getElementById('networkSearch')?.value || '';
                const project = document.getElementById('networkProjectFilter')?.value || '';
                const favoritesOnly = document.getElementById('networkFavoritesOnly')?.checked || false;

                let url = '/api/contacts?';
                if (search) url += `search=${encodeURIComponent(search)}&`;
                if (project) url += `project=${encodeURIComponent(project)}&`;
                if (favoritesOnly) url += `favorites=1&`;

                this.contacts = await this.api(url);
                document.getElementById('networkCount').textContent = this.contacts.length || 0;

                const container = document.getElementById('networkContactsList');
                if (!this.contacts.length) {
                    container.innerHTML = '<tr><td colspan="8" style="padding: 40px; text-align: center; color: var(--text-muted);">No contacts found. Add your first contact!</td></tr>';
                    return;
                }

                const projectColors = {
                    plexus: '#a78bfa',
                    accelerator: '#22d3ee',
                    forum: '#fb923c',
                    bridges: '#f472b6'
                };

                container.innerHTML = this.contacts.map(c => {
                    const projects = c.projects ? c.projects.split(',').map(p => p.trim()).filter(p => p) : [];
                    const projectBadges = projects.map(p =>
                        `<span style="background: ${projectColors[p] || 'var(--bg-tertiary)'}20; color: ${projectColors[p] || 'var(--text-muted)'}; padding: 2px 6px; border-radius: 4px; font-size: 10px; text-transform: capitalize; white-space: nowrap;">${p}</span>`
                    ).join(' ');

                    const location = [c.city, c.country].filter(x => x).join(', ') || '-';
                    const contactInfo = [];
                    if (c.email) contactInfo.push(`<a href="mailto:${c.email}" style="color: var(--accent-gold);" onclick="event.stopPropagation();">${c.email}</a>`);
                    if (c.phone) contactInfo.push(`<span style="color: var(--text-muted);">${c.phone}</span>`);

                    return `
                        <tr style="border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s;"
                            onmouseover="this.style.background='var(--bg-tertiary)'"
                            onmouseout="this.style.background='transparent'"
                            onclick="NetworkApp.openContactModal(${JSON.stringify(c).replace(/"/g, '&quot;')})">
                            <td style="padding: 10px 8px; vertical-align: middle;">
                                <i class="fas fa-star" style="color: ${c.is_favorite ? 'var(--accent-gold)' : 'var(--border)'}; font-size: 12px; cursor: pointer;"
                                   onclick="event.stopPropagation(); NetworkApp.toggleFavorite('${c.id}')"></i>
                            </td>
                            <td style="padding: 10px 8px; font-weight: 500; white-space: nowrap;">
                                ${c.first_name} ${c.last_name}
                            </td>
                            <td style="padding: 10px 8px;">
                                <div style="font-size: 12px;">${c.position || '-'}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">${c.organization || ''}</div>
                            </td>
                            <td style="padding: 10px 8px;">
                                <div style="display: flex; gap: 4px; flex-wrap: wrap;">${projectBadges || '<span style="color: var(--text-muted);">-</span>'}</div>
                            </td>
                            <td style="padding: 10px 8px; font-size: 12px; color: var(--text-secondary);">${location}</td>
                            <td style="padding: 10px 8px; font-size: 11px;">
                                ${contactInfo.join('<br>') || '<span style="color: var(--text-muted);">-</span>'}
                            </td>
                            <td style="padding: 10px 8px; font-size: 11px; max-width: 200px;">
                                ${c.notes ? `<div style="color: var(--warning); background: rgba(245, 158, 11, 0.1); padding: 4px 8px; border-radius: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${c.notes.replace(/"/g, '&quot;')}"><i class="fas fa-sticky-note" style="margin-right: 4px;"></i>${c.notes.substring(0, 40)}${c.notes.length > 40 ? '...' : ''}</div>` : '<span style="color: var(--text-muted);">-</span>'}
                            </td>
                            <td style="padding: 10px 8px;">
                                <div style="display: flex; gap: 4px;">
                                    <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="event.stopPropagation(); NetworkApp.openContactModal(${JSON.stringify(c).replace(/"/g, '&quot;')})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="event.stopPropagation(); NetworkApp.deleteContact('${c.id}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            openContactModal(contact = null) {
                document.getElementById('networkContactModalTitle').textContent = contact ? 'Edit Contact' : 'Add Contact';
                document.getElementById('networkContactId').value = contact?.id || '';
                document.getElementById('networkFirstName').value = contact?.first_name || '';
                document.getElementById('networkLastName').value = contact?.last_name || '';
                document.getElementById('networkOrg').value = contact?.organization || '';
                document.getElementById('networkPosition').value = contact?.position || '';
                document.getElementById('networkEmail').value = contact?.email || '';
                document.getElementById('networkPhone').value = contact?.phone || '';
                document.getElementById('networkCity').value = contact?.city || '';
                document.getElementById('networkCountry').value = contact?.country || '';
                document.getElementById('networkTags').value = contact?.tags || '';
                document.getElementById('networkNotes').value = contact?.notes || '';

                // Set project checkboxes
                const projects = contact?.projects ? contact.projects.split(',').map(p => p.trim()) : [];
                document.getElementById('networkProjPlexus').checked = projects.includes('plexus');
                document.getElementById('networkProjAccelerator').checked = projects.includes('accelerator');
                document.getElementById('networkProjForum').checked = projects.includes('forum');
                document.getElementById('networkProjBridges').checked = projects.includes('bridges');

                document.getElementById('networkContactModal').classList.add('active');
            },

            closeModal() {
                document.getElementById('networkContactModal').classList.remove('active');
            },

            async saveContact() {
                const id = document.getElementById('networkContactId').value;

                // Gather projects
                const projects = [];
                if (document.getElementById('networkProjPlexus').checked) projects.push('plexus');
                if (document.getElementById('networkProjAccelerator').checked) projects.push('accelerator');
                if (document.getElementById('networkProjForum').checked) projects.push('forum');
                if (document.getElementById('networkProjBridges').checked) projects.push('bridges');

                const data = {
                    first_name: document.getElementById('networkFirstName').value,
                    last_name: document.getElementById('networkLastName').value,
                    organization: document.getElementById('networkOrg').value,
                    position: document.getElementById('networkPosition').value,
                    email: document.getElementById('networkEmail').value,
                    phone: document.getElementById('networkPhone').value,
                    city: document.getElementById('networkCity').value,
                    country: document.getElementById('networkCountry').value,
                    tags: document.getElementById('networkTags').value,
                    notes: document.getElementById('networkNotes').value,
                    projects: projects.join(',')
                };

                if (!data.first_name || !data.last_name) {
                    Toast.warning('Please enter first and last name');
                    return;
                }

                if (id) {
                    await this.api(`/api/contacts/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await this.api('/api/contacts', { method: 'POST', body: JSON.stringify(data) });
                }

                this.closeModal();
                this.loadContacts();
            },

            async toggleFavorite(contactId) {
                await this.api(`/api/contacts/${contactId}/favorite`, { method: 'POST' });
                this.loadContacts();
            },

            async deleteContact(contactId) {
                if (!confirm('Delete this contact?')) return;
                await this.api(`/api/contacts/${contactId}`, { method: 'DELETE' });
                this.loadContacts();
            }
        };

        // ===== BUILDING BRIDGES APP =====
        const BridgesApp = {
            events: [],
            currentEvent: null,
            currentRegistrations: [],

            async api(endpoint, options = {}) {
                const res = await fetch(endpoint, {
                    ...options,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.token}`, ...options.headers }
                });
                return res.json();
            },

            async init() {
                await this.loadEvents();
                await this.loadSpeakers();
                await this.loadProgram();
            },

            async loadEvents() {
                const statusFilter = document.getElementById('bridgesStatusFilter')?.value || '';
                this.events = await this.api('/api/bridges/events');

                let filtered = this.events;
                if (statusFilter) {
                    filtered = this.events.filter(e => e.status === statusFilter);
                }

                const grid = document.getElementById('bridgesEventsGrid');
                if (!filtered.length) {
                    grid.innerHTML = '<p style="color: var(--text-muted); grid-column: 1/-1;">No events found. Click "New Event" to create one.</p>';
                    return;
                }

                const statusColors = {
                    upcoming: { bg: 'rgba(34, 197, 94, 0.2)', color: '#22c55e' },
                    planning: { bg: 'rgba(251, 146, 60, 0.2)', color: '#fb923c' },
                    registration_open: { bg: 'rgba(59, 130, 246, 0.2)', color: '#3b82f6' },
                    ongoing: { bg: 'rgba(168, 85, 247, 0.2)', color: '#a855f7' },
                    completed: { bg: 'rgba(148, 163, 184, 0.2)', color: '#94a3b8' },
                    cancelled: { bg: 'rgba(239, 68, 68, 0.2)', color: '#ef4444' }
                };

                grid.innerHTML = filtered.map(event => {
                    const date = new Date(event.event_date);
                    const day = date.getDate();
                    const month = date.toLocaleString('en', { month: 'short' });
                    const statusStyle = statusColors[event.status] || statusColors.planning;
                    const regPercent = event.capacity ? Math.round((event.registration_count / event.capacity) * 100) : 0;

                    return `
                        <div class="card" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;"
                             onclick="BridgesApp.showEventDetail('${event.id}')"
                             onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.3)'"
                             onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            <div style="display: flex; align-items: center; gap: 16px; padding: 20px;">
                                <div style="min-width: 60px; text-align: center; background: var(--bg-tertiary); border-radius: 8px; padding: 12px 8px;">
                                    <div style="font-size: 24px; font-weight: 700; color: var(--bridges);">${day}</div>
                                    <div style="font-size: 12px; color: var(--text-muted); text-transform: uppercase;">${month}</div>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">${event.city}</div>
                                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">${event.venue_name || 'Venue TBD'}</div>
                                    <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                        <span style="background: ${statusStyle.bg}; color: ${statusStyle.color}; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 500; text-transform: capitalize;">${event.status}</span>
                                        ${event.is_published
                                            ? '<span style="background: rgba(34, 197, 94, 0.15); color: #22c55e; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;"><i class="fas fa-globe" style="margin-right: 3px;"></i>Published</span>'
                                            : '<span style="background: rgba(148, 163, 184, 0.15); color: #94a3b8; padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;"><i class="fas fa-eye-slash" style="margin-right: 3px;"></i>Draft</span>'
                                        }
                                        <span style="font-size: 12px; color: var(--text-muted);"><i class="fas fa-users" style="margin-right: 4px;"></i>${event.registration_count || 0}/${event.capacity || 50}</span>
                                    </div>
                                </div>
                                <div style="width: 50px; height: 50px; position: relative;">
                                    <svg viewBox="0 0 36 36" style="width: 50px; height: 50px; transform: rotate(-90deg);">
                                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--bg-tertiary)" stroke-width="3"/>
                                        <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--bridges)" stroke-width="3" stroke-dasharray="${regPercent}, 100"/>
                                    </svg>
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: 600;">${regPercent}%</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            async showEventDetail(eventId) {
                const event = await this.api(`/api/bridges/events/${eventId}`);
                this.currentEvent = event;
                this.currentRegistrations = event.registrations || [];

                document.getElementById('bridgesEventsList').style.display = 'none';
                document.getElementById('bridgesEventDetail').style.display = 'block';

                // Populate header
                document.getElementById('bridgesEventTitle').textContent = `${event.city} - ${event.name || 'Symposium'}`;
                document.getElementById('bridgesEventSubtitle').textContent = `${event.event_date} ${event.event_time ? 'at ' + event.event_time : ''}`;

                // Stats
                document.getElementById('bridgesEventRegCount').textContent = event.registration_count || 0;
                document.getElementById('bridgesEventCheckedIn').textContent = event.checked_in_count || 0;
                document.getElementById('bridgesEventCapacity').textContent = event.capacity || 50;

                // Status badge
                const statusColors = {
                    upcoming: { bg: 'rgba(34, 197, 94, 0.2)', color: '#22c55e' },
                    planning: { bg: 'rgba(251, 146, 60, 0.2)', color: '#fb923c' },
                    registration_open: { bg: 'rgba(59, 130, 246, 0.2)', color: '#3b82f6' },
                    ongoing: { bg: 'rgba(168, 85, 247, 0.2)', color: '#a855f7' },
                    completed: { bg: 'rgba(148, 163, 184, 0.2)', color: '#94a3b8' },
                    cancelled: { bg: 'rgba(239, 68, 68, 0.2)', color: '#ef4444' }
                };
                const style = statusColors[event.status] || statusColors.planning;
                const statusEl = document.getElementById('bridgesEventStatus');
                statusEl.textContent = event.status;
                statusEl.style.background = style.bg;
                statusEl.style.color = style.color;

                // Publish button state
                const publishBtn = document.getElementById('bridgesPublishBtn');
                if (publishBtn) {
                    if (event.is_published) {
                        publishBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Unpublish';
                        publishBtn.style.background = 'rgba(34, 197, 94, 0.15)';
                        publishBtn.style.color = '#22c55e';
                        publishBtn.style.borderColor = '#22c55e';
                    } else {
                        publishBtn.innerHTML = '<i class="fas fa-globe"></i> Publish';
                        publishBtn.style.background = '';
                        publishBtn.style.color = '';
                        publishBtn.style.borderColor = '';
                    }
                }

                // Details
                document.getElementById('bridgesEventDetails').innerHTML = `
                    <div><i class="fas fa-map-marker-alt" style="width: 20px; color: var(--bridges);"></i> ${event.venue_name || 'TBD'}</div>
                    <div><i class="fas fa-building" style="width: 20px; color: var(--text-muted);"></i> ${event.venue_address || 'Address TBD'}</div>
                    <div><i class="fas fa-clock" style="width: 20px; color: var(--text-muted);"></i> ${event.event_time || 'Time TBD'} - ${event.end_time || ''}</div>
                    <div><i class="fas fa-envelope" style="width: 20px; color: var(--text-muted);"></i> ${event.contact_email || 'N/A'}</div>
                    <div><i class="fas fa-calendar-times" style="width: 20px; color: var(--text-muted);"></i> Registration deadline: ${event.registration_deadline || 'N/A'}</div>
                    <div><i class="fas fa-globe" style="width: 20px; color: ${event.is_published ? '#22c55e' : 'var(--text-muted)'};"></i> ${event.is_published ? 'Published to user portal' : 'Not published (draft)'}</div>
                `;

                document.getElementById('bridgesEventDescription').textContent = event.description || 'No description provided.';

                this.renderRegistrations();

                // Show check-in card for upcoming events
                const checkinCard = document.getElementById('bridgesCheckinCard');
                if (checkinCard) checkinCard.style.display = (event.status === 'upcoming' || event.status === 'planning') ? 'block' : 'none';
            },

            showEventsList() {
                document.getElementById('bridgesEventDetail').style.display = 'none';
                document.getElementById('bridgesEventsList').style.display = 'block';
                const checkinCard = document.getElementById('bridgesCheckinCard');
                if (checkinCard) checkinCard.style.display = 'none';
                this.loadEvents();
            },

            renderRegistrations() {
                const tbody = document.getElementById('bridgesRegistrationsTable');
                if (!this.currentRegistrations.length) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: var(--text-muted);">No registrations yet</td></tr>';
                    return;
                }

                const search = document.getElementById('bridgesRegSearch')?.value?.toLowerCase() || '';
                let filtered = this.currentRegistrations;
                if (search) {
                    filtered = filtered.filter(r =>
                        r.first_name.toLowerCase().includes(search) ||
                        r.last_name.toLowerCase().includes(search) ||
                        r.email.toLowerCase().includes(search) ||
                        (r.institution && r.institution.toLowerCase().includes(search))
                    );
                }

                tbody.innerHTML = filtered.map(r => `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px 16px;">
                            <div style="font-weight: 500;">${r.first_name} ${r.last_name}</div>
                            ${r.position ? `<div style="font-size: 12px; color: var(--text-muted);">${r.position}</div>` : ''}
                        </td>
                        <td style="padding: 12px 16px; font-size: 13px;">${r.email}</td>
                        <td style="padding: 12px 16px; font-size: 13px; color: var(--text-muted);">${r.institution || '-'}</td>
                        <td style="padding: 12px 16px;">
                            <span style="background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${r.status}</span>
                        </td>
                        <td style="padding: 12px 16px; text-align: center;">
                            ${r.checked_in
                                ? `<button class="btn btn-secondary" style="padding: 4px 10px; font-size: 11px;" onclick="BridgesApp.undoCheckin('${r.id}')"><i class="fas fa-undo"></i> Undo</button>`
                                : `<button class="btn btn-primary" style="padding: 4px 10px; font-size: 11px;" onclick="BridgesApp.checkinRegistration('${r.id}')"><i class="fas fa-check"></i> Check In</button>`
                            }
                        </td>
                        <td style="padding: 12px 16px; text-align: right;">
                            <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="BridgesApp.editRegistration('${r.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger" style="padding: 4px 8px; margin-left: 4px;" onclick="BridgesApp.deleteRegistration('${r.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },

            filterRegistrations() {
                this.renderRegistrations();
            },

            openEventModal(event = null) {
                document.getElementById('bridgesEventModalTitle').textContent = event ? 'Edit Event' : 'New Event';
                document.getElementById('bridgesEventId').value = event?.id || '';
                document.getElementById('bridgesEventName').value = event?.name || '';
                document.getElementById('bridgesEventCity').value = event?.city || '';
                document.getElementById('bridgesEventVenue').value = event?.venue_name || '';
                document.getElementById('bridgesEventAddress').value = event?.venue_address || '';
                document.getElementById('bridgesEventDate').value = event?.event_date || '';
                document.getElementById('bridgesEventTime').value = event?.event_time || '';
                document.getElementById('bridgesEventEndTime').value = event?.end_time || '';
                document.getElementById('bridgesEventCapacity').value = event?.capacity || 50;
                document.getElementById('bridgesEventStatusSelect').value = event?.status || 'planning';
                document.getElementById('bridgesEventDeadline').value = event?.registration_deadline || '';
                document.getElementById('bridgesEventEmail').value = event?.contact_email || '';
                document.getElementById('bridgesEventPhone').value = event?.contact_phone || '';
                document.getElementById('bridgesEventDescriptionInput').value = event?.description || '';
                document.getElementById('bridgesEventNotes').value = event?.notes || '';
                document.getElementById('bridgesEventPublished').checked = !!event?.is_published;
                document.getElementById('bridgesEventModal').classList.add('active');
            },

            async saveEvent() {
                const id = document.getElementById('bridgesEventId').value;
                const data = {
                    name: document.getElementById('bridgesEventName').value,
                    city: document.getElementById('bridgesEventCity').value,
                    venue_name: document.getElementById('bridgesEventVenue').value,
                    venue_address: document.getElementById('bridgesEventAddress').value,
                    event_date: document.getElementById('bridgesEventDate').value,
                    event_time: document.getElementById('bridgesEventTime').value,
                    end_time: document.getElementById('bridgesEventEndTime').value,
                    capacity: parseInt(document.getElementById('bridgesEventCapacity').value) || 50,
                    status: document.getElementById('bridgesEventStatusSelect').value,
                    registration_deadline: document.getElementById('bridgesEventDeadline').value,
                    contact_email: document.getElementById('bridgesEventEmail').value,
                    contact_phone: document.getElementById('bridgesEventPhone').value,
                    description: document.getElementById('bridgesEventDescriptionInput').value,
                    notes: document.getElementById('bridgesEventNotes').value,
                    is_published: document.getElementById('bridgesEventPublished').checked ? 1 : 0
                };

                if (!data.city || !data.event_date) {
                    Toast.warning('Please fill in at least City and Date');
                    return;
                }

                if (id) {
                    await this.api(`/api/bridges/events/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await this.api('/api/bridges/events', { method: 'POST', body: JSON.stringify(data) });
                }

                this.closeModal('bridgesEventModal');
                this.loadEvents();
                if (this.currentEvent && id === this.currentEvent.id) {
                    this.showEventDetail(id);
                }
            },

            editCurrentEvent() {
                this.openEventModal(this.currentEvent);
            },

            async deleteCurrentEvent() {
                if (!confirm('Are you sure you want to delete this event and all its registrations?')) return;
                await this.api(`/api/bridges/events/${this.currentEvent.id}`, { method: 'DELETE' });
                this.showEventsList();
            },

            async togglePublish() {
                if (!this.currentEvent) return;
                const action = this.currentEvent.is_published ? 'unpublish' : 'publish';
                if (!confirm(`Are you sure you want to ${action} this event? ${action === 'publish' ? 'It will be visible on the user portal.' : 'It will be hidden from the user portal.'}`)) return;
                const result = await this.api(`/api/bridges/events/${this.currentEvent.id}/publish`, { method: 'PUT' });
                if (result.success) {
                    this.showEventDetail(this.currentEvent.id);
                }
            },

            openRegistrationModal(reg = null) {
                document.getElementById('bridgesRegModalTitle').textContent = reg ? 'Edit Registration' : 'Add Registration';
                document.getElementById('bridgesRegId').value = reg?.id || '';
                document.getElementById('bridgesRegFirstName').value = reg?.first_name || '';
                document.getElementById('bridgesRegLastName').value = reg?.last_name || '';
                document.getElementById('bridgesRegEmail').value = reg?.email || '';
                document.getElementById('bridgesRegPhone').value = reg?.phone || '';
                document.getElementById('bridgesRegInstitution').value = reg?.institution || '';
                document.getElementById('bridgesRegPosition').value = reg?.position || '';
                document.getElementById('bridgesRegDietary').value = reg?.dietary_requirements || '';
                document.getElementById('bridgesRegSpecial').value = reg?.special_requests || '';
                document.getElementById('bridgesRegModal').classList.add('active');
            },

            async saveRegistration() {
                const id = document.getElementById('bridgesRegId').value;
                const data = {
                    first_name: document.getElementById('bridgesRegFirstName').value,
                    last_name: document.getElementById('bridgesRegLastName').value,
                    email: document.getElementById('bridgesRegEmail').value,
                    phone: document.getElementById('bridgesRegPhone').value,
                    institution: document.getElementById('bridgesRegInstitution').value,
                    position: document.getElementById('bridgesRegPosition').value,
                    dietary_requirements: document.getElementById('bridgesRegDietary').value,
                    special_requests: document.getElementById('bridgesRegSpecial').value
                };

                if (!data.first_name || !data.last_name || !data.email) {
                    Toast.warning('Please fill in First Name, Last Name, and Email');
                    return;
                }

                if (id) {
                    await this.api(`/api/bridges/registrations/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await this.api(`/api/bridges/events/${this.currentEvent.id}/registrations`, { method: 'POST', body: JSON.stringify(data) });
                }

                this.closeModal('bridgesRegModal');
                this.showEventDetail(this.currentEvent.id);
            },

            editRegistration(regId) {
                const reg = this.currentRegistrations.find(r => r.id === regId);
                if (reg) this.openRegistrationModal(reg);
            },

            async deleteRegistration(regId) {
                if (!confirm('Delete this registration?')) return;
                await this.api(`/api/bridges/registrations/${regId}`, { method: 'DELETE' });
                this.showEventDetail(this.currentEvent.id);
            },

            async checkinRegistration(regId) {
                await this.api(`/api/bridges/registrations/${regId}/checkin`, { method: 'POST' });
                this.showEventDetail(this.currentEvent.id);
            },

            async undoCheckin(regId) {
                await this.api(`/api/bridges/registrations/${regId}/undo-checkin`, { method: 'POST' });
                this.showEventDetail(this.currentEvent.id);
            },

            // ========== SPEAKERS MANAGEMENT ==========

            speakers: [],

            async loadSpeakers() {
                const eventFilter = document.getElementById('bridgesSpeakerEventFilter')?.value || '';
                const url = eventFilter ? `/api/bridges/speakers?event_id=${eventFilter}` : '/api/bridges/speakers';
                this.speakers = await this.api(url);

                // Update event filter dropdown
                this.populateEventFilters();

                const grid = document.getElementById('bridgesSpeakersGrid');
                if (!this.speakers.length) {
                    grid.innerHTML = '<p style="color: var(--text-muted); grid-column: 1/-1;">No speakers yet. Click "Add Speaker" to create one.</p>';
                    return;
                }

                grid.innerHTML = this.speakers.map(s => {
                    const initials = s.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                    const eventName = this.events.find(e => e.id === s.event_id)?.city || 'General';
                    return `
                        <div class="card" style="margin: 0; position: relative; overflow: hidden;">
                            <div style="padding: 20px;">
                                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                                    ${s.photo_url
                                        ? `<img src="${s.photo_url}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">`
                                        : `<div style="width: 50px; height: 50px; border-radius: 50%; background: rgba(244,114,182,0.2); color: var(--bridges); display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px;">${initials}</div>`
                                    }
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 600; font-size: 15px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${s.name}</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">${s.title || ''}</div>
                                    </div>
                                </div>
                                ${s.institution ? `<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;"><i class="fas fa-building" style="width: 16px; color: var(--text-muted);"></i> ${s.institution}</div>` : ''}
                                ${s.talk_title ? `<div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;"><i class="fas fa-chalkboard-teacher" style="width: 16px;"></i> ${s.talk_title}</div>` : ''}
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                                    <div style="display: flex; gap: 6px; align-items: center;">
                                        <span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: ${s.is_published ? 'rgba(34,197,94,0.2)' : 'rgba(251,146,60,0.2)'}; color: ${s.is_published ? '#22c55e' : '#fb923c'};">${s.is_published ? 'Published' : 'Draft'}</span>
                                        <span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: rgba(244,114,182,0.1); color: #f472b6;">${eventName}</span>
                                    </div>
                                    <div style="display: flex; gap: 4px;">
                                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="BridgesApp.toggleSpeakerPublish('${s.id}')" title="${s.is_published ? 'Unpublish' : 'Publish'}"><i class="fas fa-${s.is_published ? 'eye-slash' : 'eye'}"></i></button>
                                        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="BridgesApp.editSpeaker('${s.id}')"><i class="fas fa-edit"></i></button>
                                        <button class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="BridgesApp.deleteSpeaker('${s.id}')"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            populateEventFilters() {
                const selectors = ['bridgesSpeakerEventFilter', 'bridgesProgramEventFilter', 'bridgesSpeakerEvent', 'bridgesProgramEvent'];
                selectors.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    const currentVal = el.value;
                    const isFilter = id.includes('Filter');
                    el.innerHTML = `<option value="">${isFilter ? 'All Events' : '-- No specific event --'}</option>`;
                    (this.events || []).forEach(e => {
                        el.innerHTML += `<option value="${e.id}">${e.city} - ${e.name || 'Event'}</option>`;
                    });
                    el.value = currentVal;
                });
            },

            openSpeakerModal(speaker = null) {
                this.populateEventFilters();
                document.getElementById('bridgesSpeakerModalTitle').textContent = speaker ? 'Edit Speaker' : 'Add Speaker';
                document.getElementById('bridgesSpeakerId').value = speaker?.id || '';
                document.getElementById('bridgesSpeakerEvent').value = speaker?.event_id || '';
                document.getElementById('bridgesSpeakerName').value = speaker?.name || '';
                document.getElementById('bridgesSpeakerTitle').value = speaker?.title || '';
                document.getElementById('bridgesSpeakerInstitution').value = speaker?.institution || '';
                document.getElementById('bridgesSpeakerTalkTitle').value = speaker?.talk_title || '';
                document.getElementById('bridgesSpeakerPhotoUrl').value = speaker?.photo_url || '';
                document.getElementById('bridgesSpeakerBio').value = speaker?.bio || '';
                document.getElementById('bridgesSpeakerSortOrder').value = speaker?.sort_order || 0;
                document.getElementById('bridgesSpeakerPublished').checked = !!speaker?.is_published;
                document.getElementById('bridgesSpeakerModal').classList.add('active');
            },

            async saveSpeaker() {
                const id = document.getElementById('bridgesSpeakerId').value;
                const data = {
                    event_id: document.getElementById('bridgesSpeakerEvent').value || null,
                    name: document.getElementById('bridgesSpeakerName').value,
                    title: document.getElementById('bridgesSpeakerTitle').value,
                    institution: document.getElementById('bridgesSpeakerInstitution').value,
                    talk_title: document.getElementById('bridgesSpeakerTalkTitle').value,
                    photo_url: document.getElementById('bridgesSpeakerPhotoUrl').value,
                    bio: document.getElementById('bridgesSpeakerBio').value,
                    sort_order: parseInt(document.getElementById('bridgesSpeakerSortOrder').value) || 0,
                    is_published: document.getElementById('bridgesSpeakerPublished').checked ? 1 : 0
                };

                if (!data.name) { Toast.warning('Please enter a speaker name'); return; }

                if (id) {
                    await this.api(`/api/bridges/speakers/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await this.api('/api/bridges/speakers', { method: 'POST', body: JSON.stringify(data) });
                }

                this.closeModal('bridgesSpeakerModal');
                this.loadSpeakers();
            },

            editSpeaker(speakerId) {
                const speaker = this.speakers.find(s => s.id === speakerId);
                if (speaker) this.openSpeakerModal(speaker);
            },

            async deleteSpeaker(speakerId) {
                if (!confirm('Delete this speaker?')) return;
                await this.api(`/api/bridges/speakers/${speakerId}`, { method: 'DELETE' });
                this.loadSpeakers();
            },

            async toggleSpeakerPublish(speakerId) {
                await this.api(`/api/bridges/speakers/${speakerId}/publish`, { method: 'PUT' });
                this.loadSpeakers();
            },

            // ========== PROGRAM MANAGEMENT ==========

            programItems: [],

            async loadProgram() {
                const eventFilter = document.getElementById('bridgesProgramEventFilter')?.value || '';
                const url = eventFilter ? `/api/bridges/program?event_id=${eventFilter}` : '/api/bridges/program';
                this.programItems = await this.api(url);

                this.populateEventFilters();

                // Also populate speaker dropdown in modal
                const speakerSelect = document.getElementById('bridgesProgramSpeaker');
                if (speakerSelect) {
                    const currentVal = speakerSelect.value;
                    speakerSelect.innerHTML = '<option value="">-- No speaker --</option>';
                    (this.speakers || []).forEach(s => {
                        speakerSelect.innerHTML += `<option value="${s.id}">${s.name}${s.institution ? ' (' + s.institution + ')' : ''}</option>`;
                    });
                    speakerSelect.value = currentVal;
                }

                const list = document.getElementById('bridgesProgramList');
                if (!this.programItems.length) {
                    list.innerHTML = '<p style="padding: 20px; color: var(--text-muted);">No program items yet. Click "Add Item" to create one.</p>';
                    return;
                }

                list.innerHTML = this.programItems.map((item, idx) => {
                    const eventName = this.events.find(e => e.id === item.event_id)?.city || 'General';
                    return `
                        <div style="display: flex; align-items: center; gap: 16px; padding: 14px 20px; border-bottom: 1px solid var(--border); ${idx === 0 ? '' : ''}">
                            <div style="min-width: 80px; text-align: center;">
                                ${item.start_time ? `<div style="font-weight: 600; color: var(--bridges); font-size: 14px;">${item.start_time}</div>` : ''}
                                ${item.end_time ? `<div style="font-size: 11px; color: var(--text-muted);">- ${item.end_time}</div>` : ''}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; font-size: 14px; margin-bottom: 2px;">${item.title}</div>
                                ${item.speaker_name ? `<div style="font-size: 12px; color: var(--text-secondary);"><i class="fas fa-user" style="margin-right: 4px;"></i>${item.speaker_name}${item.speaker_institution ? ' - ' + item.speaker_institution : ''}</div>` : ''}
                                ${item.description ? `<div style="font-size: 12px; color: var(--text-muted); margin-top: 2px;">${item.description}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 6px; align-items: center; flex-shrink: 0;">
                                <span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: rgba(244,114,182,0.1); color: #f472b6;">${eventName}</span>
                                <span style="font-size: 11px; padding: 2px 8px; border-radius: 10px; background: ${item.is_published ? 'rgba(34,197,94,0.2)' : 'rgba(251,146,60,0.2)'}; color: ${item.is_published ? '#22c55e' : '#fb923c'};">${item.is_published ? 'Published' : 'Draft'}</span>
                                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="BridgesApp.toggleProgramPublish('${item.id}')" title="${item.is_published ? 'Unpublish' : 'Publish'}"><i class="fas fa-${item.is_published ? 'eye-slash' : 'eye'}"></i></button>
                                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="BridgesApp.editProgramItem('${item.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-danger" style="padding: 4px 8px; font-size: 11px;" onclick="BridgesApp.deleteProgramItem('${item.id}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
            },

            openProgramModal(item = null) {
                this.populateEventFilters();
                // Populate speaker dropdown
                const speakerSelect = document.getElementById('bridgesProgramSpeaker');
                if (speakerSelect) {
                    speakerSelect.innerHTML = '<option value="">-- No speaker --</option>';
                    (this.speakers || []).forEach(s => {
                        speakerSelect.innerHTML += `<option value="${s.id}">${s.name}${s.institution ? ' (' + s.institution + ')' : ''}</option>`;
                    });
                }

                document.getElementById('bridgesProgramModalTitle').textContent = item ? 'Edit Program Item' : 'Add Program Item';
                document.getElementById('bridgesProgramId').value = item?.id || '';
                document.getElementById('bridgesProgramEvent').value = item?.event_id || '';
                document.getElementById('bridgesProgramTitle').value = item?.title || '';
                document.getElementById('bridgesProgramDescription').value = item?.description || '';
                document.getElementById('bridgesProgramSpeaker').value = item?.speaker_id || '';
                document.getElementById('bridgesProgramStartTime').value = item?.start_time || '';
                document.getElementById('bridgesProgramEndTime').value = item?.end_time || '';
                document.getElementById('bridgesProgramSortOrder').value = item?.sort_order || 0;
                document.getElementById('bridgesProgramPublished').checked = !!item?.is_published;
                document.getElementById('bridgesProgramModal').classList.add('active');
            },

            async saveProgramItem() {
                const id = document.getElementById('bridgesProgramId').value;
                const data = {
                    event_id: document.getElementById('bridgesProgramEvent').value || null,
                    title: document.getElementById('bridgesProgramTitle').value,
                    description: document.getElementById('bridgesProgramDescription').value,
                    speaker_id: document.getElementById('bridgesProgramSpeaker').value || null,
                    start_time: document.getElementById('bridgesProgramStartTime').value,
                    end_time: document.getElementById('bridgesProgramEndTime').value,
                    sort_order: parseInt(document.getElementById('bridgesProgramSortOrder').value) || 0,
                    is_published: document.getElementById('bridgesProgramPublished').checked ? 1 : 0
                };

                if (!data.title) { Toast.warning('Please enter a program item title'); return; }

                if (id) {
                    await this.api(`/api/bridges/program/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await this.api('/api/bridges/program', { method: 'POST', body: JSON.stringify(data) });
                }

                this.closeModal('bridgesProgramModal');
                this.loadProgram();
            },

            editProgramItem(itemId) {
                const item = this.programItems.find(p => p.id === itemId);
                if (item) this.openProgramModal(item);
            },

            async deleteProgramItem(itemId) {
                if (!confirm('Delete this program item?')) return;
                await this.api(`/api/bridges/program/${itemId}`, { method: 'DELETE' });
                this.loadProgram();
            },

            async toggleProgramPublish(itemId) {
                await this.api(`/api/bridges/program/${itemId}/publish`, { method: 'PUT' });
                this.loadProgram();
            },

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }
        };

        // ===== USER NOTIFICATIONS APP =====
        const UserNotifApp = {
            notifications: [],

            async init() {
                await this.load();
                this.updateNotificationBadge();
            },

            async updateNotificationBadge() {
                try {
                    const resp = await fetch('/api/admin/notifications/user-notifications?limit=100');
                    const data = await resp.json();
                    const badge = document.getElementById('userNotifCount');
                    if (badge && data.notifications) {
                        const count = data.notifications.length;
                        if (count > 0) {
                            badge.textContent = count;
                            badge.style.display = 'inline-flex';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                } catch (e) { /* silently fail */ }
            },

            showSendForm() {
                document.getElementById('notifSendForm').style.display = 'block';
            },

            hideSendForm() {
                document.getElementById('notifSendForm').style.display = 'none';
                this.clearForm();
            },

            clearForm() {
                document.getElementById('notifTitle').value = '';
                document.getElementById('notifMessage').value = '';
                document.getElementById('notifCategory').value = 'announcement';
                document.getElementById('notifGroup').value = 'all';
                document.getElementById('notifProject').value = '';
                document.getElementById('notifIcon').value = 'fa-bullhorn';
                document.getElementById('notifLink').value = '';
                document.getElementById('notifType').value = 'info';
                document.getElementById('notifTargetTier').value = 'all';
                document.getElementById('notifPlacement').value = 'panel';
                document.getElementById('notifExpiry').value = '';
            },

            useTemplate(type) {
                const templates = {
                    registration: { title: 'Registration Now Open', message: 'Registration is now open! Secure your spot today with early bird pricing.', category: 'registration', icon: 'fa-calendar-check' },
                    speaker: { title: 'New Speaker Announced', message: 'We are excited to announce a new speaker for the upcoming event. Check the speakers page for details!', category: 'event', icon: 'fa-user-plus' },
                    schedule: { title: 'Schedule Updated', message: 'The event schedule has been updated. Please review the latest changes.', category: 'event', icon: 'fa-clock' },
                    deadline: { title: 'Deadline Reminder', message: 'Don\'t forget — the submission deadline is approaching. Make sure to submit your materials on time.', category: 'reminder', icon: 'fa-exclamation-triangle' },
                    welcome: { title: 'Welcome to Med&X Portal', message: 'Welcome to the Med&X community! Explore upcoming events, connect with peers, and stay updated.', category: 'system', icon: 'fa-star' }
                };
                const t = templates[type];
                if (!t) return;
                document.getElementById('notifTitle').value = t.title;
                document.getElementById('notifMessage').value = t.message;
                document.getElementById('notifCategory').value = t.category;
                document.getElementById('notifIcon').value = t.icon;
            },

            async send() {
                const title = document.getElementById('notifTitle').value.trim();
                const message = document.getElementById('notifMessage').value.trim();
                const category = document.getElementById('notifCategory').value;
                const user_group = document.getElementById('notifGroup').value;
                const project = document.getElementById('notifProject').value;
                const icon = document.getElementById('notifIcon').value;
                const link = document.getElementById('notifLink').value.trim();
                const notification_type = document.getElementById('notifType').value;
                const target_tier = document.getElementById('notifTargetTier').value;
                const placement = document.getElementById('notifPlacement').value;
                const expires_at = document.getElementById('notifExpiry').value || undefined;

                if (!title) {
                    Toast.warning('Title is required');
                    return;
                }

                try {
                    const resp = await fetch('/api/admin/notifications/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, message, category, user_group, project: project || undefined, icon, icon_class: category, link: link || undefined, notification_type, target_tier, expires_at, placement })
                    });
                    const data = await resp.json();
                    if (data.success) {
                        this.hideSendForm();
                        this.load();
                        // Show success toast if available
                        Toast.success('Notification sent!');
                    } else {
                        Toast.error('Error: ' + (data.error || 'Unknown error'));
                    }
                } catch (err) {
                    Toast.error('Failed to send: ' + err.message);
                }
            },

            async load() {
                try {
                    const category = document.getElementById('notifFilterCategory')?.value || '';
                    const project = document.getElementById('notifFilterProject')?.value || '';
                    const placement = document.getElementById('notifFilterPlacement')?.value || '';
                    let url = '/api/admin/notifications/user-notifications?limit=100';
                    if (category) url += `&category=${category}`;
                    if (project) url += `&project=${project}`;

                    const resp = await fetch(url);
                    const data = await resp.json();
                    let notifications = data.notifications || [];

                    // Client-side placement filter
                    if (placement) {
                        if (placement === 'homepage') {
                            notifications = notifications.filter(n => n.placement === 'homepage' || n.placement === 'both');
                        } else {
                            notifications = notifications.filter(n => n.placement === placement);
                        }
                    }

                    this.notifications = notifications;
                    this.renderHistory();
                } catch (err) {
                    console.error('Failed to load notifications:', err);
                }
            },

            async deleteNotif(id) {
                if (!confirm('Delete this notification?')) return;
                try {
                    await fetch(`/api/admin/notifications/user-notifications/${id}`, { method: 'DELETE' });
                    this.load();
                } catch (err) {
                    Toast.error('Failed to delete: ' + err.message);
                }
            },

            formatTime(dateStr) {
                if (!dateStr) return '';
                const d = new Date(dateStr);
                const now = new Date();
                const diffMs = now - d;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            },

            getCategoryColor(cat) {
                const colors = { announcement: '#22d3ee', event: '#8b5cf6', registration: '#10b981', reminder: '#f59e0b', homepage: '#c9a962', system: '#6b7280' };
                return colors[cat] || '#6b7280';
            },

            renderHistory() {
                const container = document.getElementById('notifHistory');
                if (!this.notifications.length) {
                    container.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--text-muted);"><i class="fas fa-bell-slash" style="font-size: 32px; margin-bottom: 12px; opacity: 0.3;"></i><p>No notifications sent yet</p></div>`;
                    return;
                }
                container.innerHTML = this.notifications.map(n => `
                    <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px 16px; border-bottom: 1px solid var(--border); transition: background 0.15s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                        <div style="width: 36px; height: 36px; border-radius: 8px; background: ${this.getCategoryColor(n.category)}20; color: ${this.getCategoryColor(n.category)}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas ${n.icon || 'fa-bell'}"></i>
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; font-size: 13px; margin-bottom: 2px;">${n.title}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">${n.message || ''}</div>
                            <div style="display: flex; gap: 8px; align-items: center; font-size: 11px; color: var(--text-muted);">
                                <span style="background: ${this.getCategoryColor(n.category)}20; color: ${this.getCategoryColor(n.category)}; padding: 1px 8px; border-radius: 4px; font-weight: 500;">${n.category}</span>
                                ${n.notification_type && n.notification_type !== 'info' ? `<span style="background: ${n.notification_type === 'warning' ? '#f59e0b' : n.notification_type === 'alert' ? '#ef4444' : n.notification_type === 'success' ? '#22c55e' : '#6b7280'}20; color: ${n.notification_type === 'warning' ? '#f59e0b' : n.notification_type === 'alert' ? '#ef4444' : n.notification_type === 'success' ? '#22c55e' : '#6b7280'}; padding: 1px 6px; border-radius: 4px; font-weight: 500;">${n.notification_type}</span>` : ''}
                                ${n.placement && n.placement !== 'panel' ? `<span style="background: #8b5cf620; color: #8b5cf6; padding: 1px 6px; border-radius: 4px; font-weight: 500;"><i class="fas fa-home" style="margin-right: 2px;"></i>${n.placement}</span>` : ''}
                                ${n.project ? `<span><i class="fas fa-folder" style="margin-right: 3px;"></i>${n.project}</span>` : ''}
                                ${n.user_group !== 'all' ? `<span><i class="fas fa-users" style="margin-right: 3px;"></i>${n.user_group}</span>` : '<span><i class="fas fa-globe" style="margin-right: 3px;"></i>All users</span>'}
                                ${n.target_tier && n.target_tier !== 'all' ? `<span><i class="fas fa-crown" style="margin-right: 3px;"></i>${n.target_tier}</span>` : ''}
                                ${n.expires_at ? `<span><i class="fas fa-hourglass-half" style="margin-right: 3px;"></i>Exp: ${new Date(n.expires_at).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}</span>` : ''}
                                <span>${this.formatTime(n.created_at)}</span>
                            </div>
                        </div>
                        <button onclick="UserNotifApp.deleteNotif('${n.id}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; opacity: 0.5; transition: opacity 0.15s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'" title="Delete">
                            <i class="fas fa-trash" style="font-size: 12px;"></i>
                        </button>
                    </div>
                `).join('');
            }
        };

        // ===== MEMBER NEWSLETTER APP =====
        const NewsletterApp = {
            newsletters: [],

            async init() {
                await this.load();
            },

            showCompose(editData) {
                document.getElementById('newsletterComposeArea').style.display = 'block';
                document.getElementById('newsletterPreviewArea').style.display = 'none';
                if (editData) {
                    document.getElementById('newsletterEditId').value = editData.id || '';
                    document.getElementById('newsletterTitleInput').value = editData.title || '';
                    document.getElementById('newsletterBodyInput').value = editData.body || '';
                    document.getElementById('newsletterAudience').value = editData.target_audience || 'all';
                    document.getElementById('newsletterComposeTitle').textContent = 'Edit Newsletter';
                } else {
                    this.clearForm();
                    document.getElementById('newsletterComposeTitle').textContent = 'Compose Newsletter';
                }
            },

            hideCompose() {
                document.getElementById('newsletterComposeArea').style.display = 'none';
                this.clearForm();
            },

            clearForm() {
                document.getElementById('newsletterEditId').value = '';
                document.getElementById('newsletterTitleInput').value = '';
                document.getElementById('newsletterBodyInput').value = '';
                document.getElementById('newsletterAudience').value = 'all';
                document.getElementById('newsletterPreviewArea').style.display = 'none';
            },

            togglePreview() {
                const previewArea = document.getElementById('newsletterPreviewArea');
                const previewContent = document.getElementById('newsletterPreviewContent');
                if (previewArea.style.display === 'none') {
                    const title = document.getElementById('newsletterTitleInput').value || '(No title)';
                    const body = document.getElementById('newsletterBodyInput').value || '(No content)';
                    const audience = document.getElementById('newsletterAudience').value;
                    const audienceLabels = { all: 'All Members', bronze: 'Bronze', silver: 'Silver', gold: 'Gold', platinum: 'Platinum', plexus: 'Plexus Registrants' };
                    previewContent.innerHTML = `<div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border);"><strong style="font-size: 16px;">${this.escapeHtml(title)}</strong><div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">To: ${audienceLabels[audience] || audience}</div></div><div style="white-space: pre-wrap;">${this.escapeHtml(body)}</div>`;
                    previewArea.style.display = 'block';
                } else {
                    previewArea.style.display = 'none';
                }
            },

            async autoGenerate() {
                try {
                    Toast.info('Generating newsletter draft...');
                    const resp = await fetch('/api/admin/newsletters/auto-generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await resp.json();
                    if (data.success) {
                        document.getElementById('newsletterTitleInput').value = data.title;
                        document.getElementById('newsletterBodyInput').value = data.body;
                        Toast.success('Newsletter draft generated from recent data!');
                    } else {
                        Toast.error('Failed to auto-generate: ' + (data.error || 'Unknown error'));
                    }
                } catch (err) {
                    Toast.error('Auto-generate failed: ' + err.message);
                }
            },

            async saveDraft() {
                const editId = document.getElementById('newsletterEditId').value;
                const title = document.getElementById('newsletterTitleInput').value.trim();
                const body = document.getElementById('newsletterBodyInput').value.trim();
                const target_audience = document.getElementById('newsletterAudience').value;

                if (!title) { Toast.warning('Title is required'); return; }

                try {
                    let resp;
                    if (editId) {
                        resp = await fetch(`/api/admin/newsletters/${editId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title, body, target_audience })
                        });
                    } else {
                        resp = await fetch('/api/admin/newsletters', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title, body, target_audience })
                        });
                    }
                    const data = await resp.json();
                    if (data.success) {
                        Toast.success(editId ? 'Newsletter updated!' : 'Draft saved!');
                        this.hideCompose();
                        this.load();
                    } else {
                        Toast.error('Error: ' + (data.error || 'Unknown error'));
                    }
                } catch (err) {
                    Toast.error('Save failed: ' + err.message);
                }
            },

            async sendNewsletter() {
                const editId = document.getElementById('newsletterEditId').value;
                const title = document.getElementById('newsletterTitleInput').value.trim();
                const body = document.getElementById('newsletterBodyInput').value.trim();
                const target_audience = document.getElementById('newsletterAudience').value;

                if (!title) { Toast.warning('Title is required'); return; }

                const audienceLabels = { all: 'All Members', bronze: 'Bronze', silver: 'Silver', gold: 'Gold', platinum: 'Platinum', plexus: 'Plexus Registrants' };
                if (!confirm(`Send this newsletter to ${audienceLabels[target_audience] || target_audience}?`)) return;

                try {
                    let nlId = editId;
                    // Save first if new
                    if (!nlId) {
                        const saveResp = await fetch('/api/admin/newsletters', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title, body, target_audience })
                        });
                        const saveData = await saveResp.json();
                        if (!saveData.success) { Toast.error('Failed to save: ' + (saveData.error || '')); return; }
                        nlId = saveData.id;
                    } else {
                        // Update first
                        await fetch(`/api/admin/newsletters/${nlId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title, body, target_audience })
                        });
                    }

                    const resp = await fetch(`/api/admin/newsletters/${nlId}/send`, { method: 'POST' });
                    const data = await resp.json();
                    if (data.success) {
                        Toast.success('Newsletter sent!');
                        this.hideCompose();
                        this.load();
                    } else {
                        Toast.error('Send failed: ' + (data.error || 'Unknown error'));
                    }
                } catch (err) {
                    Toast.error('Send failed: ' + err.message);
                }
            },

            async load() {
                try {
                    const resp = await fetch('/api/admin/newsletters');
                    const data = await resp.json();
                    let newsletters = data.newsletters || [];

                    // Apply filters
                    const statusFilter = document.getElementById('newsletterFilterStatus')?.value || '';
                    const audienceFilter = document.getElementById('newsletterFilterAudience')?.value || '';
                    if (statusFilter) newsletters = newsletters.filter(n => n.status === statusFilter);
                    if (audienceFilter) newsletters = newsletters.filter(n => n.target_audience === audienceFilter);

                    this.newsletters = newsletters;
                    this.renderHistory();
                } catch (err) {
                    console.error('Failed to load newsletters:', err);
                }
            },

            async deleteNewsletter(id) {
                if (!confirm('Delete this newsletter?')) return;
                try {
                    await fetch(`/api/admin/newsletters/${id}`, { method: 'DELETE' });
                    Toast.success('Newsletter deleted');
                    this.load();
                } catch (err) {
                    Toast.error('Delete failed: ' + err.message);
                }
            },

            editNewsletter(id) {
                const nl = this.newsletters.find(n => n.id === id);
                if (!nl) return;
                if (nl.status === 'sent') { Toast.warning('Cannot edit a sent newsletter'); return; }
                this.showCompose(nl);
            },

            async sendExisting(id) {
                const nl = this.newsletters.find(n => n.id === id);
                if (!nl) return;
                const audienceLabels = { all: 'All Members', bronze: 'Bronze', silver: 'Silver', gold: 'Gold', platinum: 'Platinum', plexus: 'Plexus Registrants' };
                if (!confirm(`Send "${nl.title}" to ${audienceLabels[nl.target_audience] || nl.target_audience}?`)) return;
                try {
                    const resp = await fetch(`/api/admin/newsletters/${id}/send`, { method: 'POST' });
                    const data = await resp.json();
                    if (data.success) { Toast.success('Newsletter sent!'); this.load(); }
                    else Toast.error('Send failed: ' + (data.error || ''));
                } catch (err) {
                    Toast.error('Send failed: ' + err.message);
                }
            },

            getAudienceLabel(val) {
                const labels = { all: 'All Members', bronze: 'Bronze', silver: 'Silver', gold: 'Gold', platinum: 'Platinum', plexus: 'Plexus' };
                return labels[val] || val;
            },

            getAudienceColor(val) {
                const colors = { all: '#22d3ee', bronze: '#cd7f32', silver: '#c0c0c0', gold: '#c9a962', platinum: '#e5e4e2', plexus: '#a78bfa' };
                return colors[val] || '#6b7280';
            },

            formatDate(dateStr) {
                if (!dateStr) return '-';
                return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            },

            escapeHtml(str) {
                if (!str) return '';
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            renderHistory() {
                const tbody = document.getElementById('newsletterHistoryBody');
                if (!this.newsletters.length) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);"><i class="fas fa-envelope" style="font-size: 32px; margin-bottom: 12px; opacity: 0.3; display: block;"></i>No newsletters yet</td></tr>`;
                    return;
                }
                tbody.innerHTML = this.newsletters.map(n => `
                    <tr style="border-bottom: 1px solid var(--border); transition: background 0.15s;" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background='transparent'">
                        <td style="padding: 12px 16px;">
                            <div style="font-weight: 600; font-size: 13px;">${this.escapeHtml(n.title)}</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 2px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${this.escapeHtml((n.body || '').substring(0, 80))}</div>
                        </td>
                        <td style="padding: 12px 16px;">
                            <span style="background: ${this.getAudienceColor(n.target_audience)}20; color: ${this.getAudienceColor(n.target_audience)}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${this.getAudienceLabel(n.target_audience)}</span>
                        </td>
                        <td style="padding: 12px 16px;">
                            <span style="background: ${n.status === 'sent' ? '#22c55e20' : '#f59e0b20'}; color: ${n.status === 'sent' ? '#22c55e' : '#f59e0b'}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                <i class="fas ${n.status === 'sent' ? 'fa-check-circle' : 'fa-pen'}" style="margin-right: 3px;"></i>${n.status === 'sent' ? 'Sent' : 'Draft'}
                            </span>
                        </td>
                        <td style="padding: 12px 16px; font-size: 12px; color: var(--text-secondary);">${this.formatDate(n.status === 'sent' ? n.sent_at : n.created_at)}</td>
                        <td style="padding: 12px 16px; text-align: right;">
                            <div style="display: flex; gap: 4px; justify-content: flex-end;">
                                ${n.status === 'draft' ? `
                                    <button onclick="NewsletterApp.editNewsletter('${n.id}')" style="background: none; border: 1px solid var(--border); color: var(--text-secondary); cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 11px;" title="Edit"><i class="fas fa-edit"></i></button>
                                    <button onclick="NewsletterApp.sendExisting('${n.id}')" style="background: #10b98120; border: 1px solid #10b981; color: #10b981; cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 11px;" title="Send"><i class="fas fa-paper-plane"></i></button>
                                ` : ''}
                                <button onclick="NewsletterApp.deleteNewsletter('${n.id}')" style="background: none; border: 1px solid var(--border); color: var(--text-muted); cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 11px;" title="Delete"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        };

        // ===== PORTAL CONTENT MANAGEMENT APP =====
        const PortalContentApp = {
            items: [],
            currentFilter: 'all',

            async init() {
                await this.load();
                this.setupPreview();
            },

            setupPreview() {
                ['pcTitle', 'pcContent', 'pcSection', 'pcProject', 'pcImageUrl', 'pcLink'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.removeEventListener('input', this._previewHandler);
                        this._previewHandler = () => this.updatePreview();
                        el.addEventListener('input', this._previewHandler);
                    }
                });
            },

            _previewHandler: null,

            updatePreview() {
                const title = document.getElementById('pcTitle')?.value || '';
                const content = document.getElementById('pcContent')?.value || '';
                const section = document.getElementById('pcSection')?.value || 'news';
                const project = document.getElementById('pcProject')?.value || '';
                const imageUrl = document.getElementById('pcImageUrl')?.value || '';
                const link = document.getElementById('pcLink')?.value || '';
                const container = document.getElementById('pcPreview');
                if (!container) return;

                if (!title) {
                    container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px; font-size: 13px;"><i class="fas fa-eye" style="margin-right: 6px;"></i> Fill in the fields above to see a preview</div>';
                    return;
                }

                const sectionIcon = { hero: 'fa-star', news: 'fa-newspaper', featured: 'fa-award', links: 'fa-link' }[section] || 'fa-file';
                const sectionColor = { hero: '#c9a962', news: '#3b82f6', featured: '#8b5cf6', links: '#10b981' }[section] || '#6b7280';
                const projectLabel = project ? `<span style="background: rgba(201,169,98,0.15); color: var(--accent-gold); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${project}</span>` : '';

                container.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        ${imageUrl ? `<img src="${this.escapeHtml(imageUrl)}" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover;" onerror="this.style.display='none'">` : `<div style="width: 40px; height: 40px; border-radius: 8px; background: ${sectionColor}22; display: flex; align-items: center; justify-content: center; flex-shrink: 0;"><i class="fas ${sectionIcon}" style="color: ${sectionColor}; font-size: 16px;"></i></div>`}
                        <div style="flex: 1; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="font-weight: 600; font-size: 14px; color: var(--text-primary);">${this.escapeHtml(title)}</span>
                                ${projectLabel}
                            </div>
                            <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.4;">${this.escapeHtml(content).substring(0, 120)}${content.length > 120 ? '...' : ''}</div>
                            ${link ? `<div style="margin-top: 6px; font-size: 12px; color: var(--accent-gold);"><i class="fas fa-link" style="margin-right: 4px;"></i>${this.escapeHtml(link)}</div>` : ''}
                        </div>
                    </div>
                `;
            },

            escapeHtml(str) {
                if (!str) return '';
                return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            },

            async load() {
                try {
                    const items = await App.api('/api/portal-content');
                    this.items = items || [];
                    this.render();
                    this.updateStats();
                } catch (err) {
                    console.error('Failed to load portal content:', err);
                }
            },

            updateStats() {
                const total = this.items.length;
                const published = this.items.filter(i => i.is_published).length;
                const drafts = total - published;
                const sections = new Set(this.items.map(i => i.section)).size;

                const el = (id) => document.getElementById(id);
                if (el('pcStatTotal')) el('pcStatTotal').textContent = total;
                if (el('pcStatPublished')) el('pcStatPublished').textContent = published;
                if (el('pcStatDraft')) el('pcStatDraft').textContent = drafts;
                if (el('pcStatSections')) el('pcStatSections').textContent = sections;
            },

            filterSection(section, btn) {
                this.currentFilter = section;
                document.querySelectorAll('.pc-filter-tab').forEach(t => {
                    t.style.background = 'var(--bg-secondary)';
                    t.style.color = 'var(--text-secondary)';
                    t.style.borderColor = 'var(--border)';
                    t.classList.remove('active');
                });
                if (btn) {
                    btn.style.background = 'var(--accent-gold)';
                    btn.style.color = 'var(--bg-primary)';
                    btn.style.borderColor = 'var(--accent-gold)';
                    btn.classList.add('active');
                }
                this.render();
            },

            render() {
                const container = document.getElementById('pcContentList');
                if (!container) return;

                let filtered = this.items;
                if (this.currentFilter !== 'all') {
                    filtered = filtered.filter(i => i.section === this.currentFilter);
                }

                if (filtered.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-muted);">
                            <i class="fas fa-th-large" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                            <p>${this.currentFilter !== 'all' ? 'No items in this section.' : 'No content items yet. Click "Add Content" to create your first item.'}</p>
                        </div>
                    `;
                    return;
                }

                const sectionIcons = { hero: 'fa-star', news: 'fa-newspaper', featured: 'fa-award', links: 'fa-link' };
                const sectionColors = { hero: '#c9a962', news: '#3b82f6', featured: '#8b5cf6', links: '#10b981' };
                const sectionLabels = { hero: 'Hero', news: 'News', featured: 'Featured', links: 'Links' };

                container.innerHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border); font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;">
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600;">Order</th>
                                <th style="padding: 12px 16px; text-align: left; font-weight: 600;">Content</th>
                                <th style="padding: 12px 8px; text-align: center; font-weight: 600;">Section</th>
                                <th style="padding: 12px 8px; text-align: center; font-weight: 600;">Project</th>
                                <th style="padding: 12px 8px; text-align: center; font-weight: 600;">Status</th>
                                <th style="padding: 12px 16px; text-align: right; font-weight: 600;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filtered.map((item, idx) => {
                                const icon = sectionIcons[item.section] || 'fa-file';
                                const color = sectionColors[item.section] || '#6b7280';
                                const label = sectionLabels[item.section] || item.section;
                                return `
                                    <tr style="border-bottom: 1px solid var(--border); transition: background 0.15s;" onmouseover="this.style.background='rgba(201,169,98,0.05)'" onmouseout="this.style.background='transparent'">
                                        <td style="padding: 12px 16px; width: 80px;">
                                            <div style="display: flex; gap: 4px;">
                                                ${idx > 0 ? `<button onclick="PortalContentApp.moveItem('${item.id}', -1)" style="background: none; border: 1px solid var(--border); border-radius: 4px; padding: 2px 6px; cursor: pointer; color: var(--text-secondary);" title="Move up"><i class="fas fa-chevron-up" style="font-size: 10px;"></i></button>` : '<span style="width: 28px;"></span>'}
                                                ${idx < filtered.length - 1 ? `<button onclick="PortalContentApp.moveItem('${item.id}', 1)" style="background: none; border: 1px solid var(--border); border-radius: 4px; padding: 2px 6px; cursor: pointer; color: var(--text-secondary);" title="Move down"><i class="fas fa-chevron-down" style="font-size: 10px;"></i></button>` : '<span style="width: 28px;"></span>'}
                                            </div>
                                        </td>
                                        <td style="padding: 12px 16px;">
                                            <div style="font-weight: 600; font-size: 14px; color: var(--text-primary); margin-bottom: 2px;">${this.escapeHtml(item.title || 'Untitled')}</div>
                                            <div style="font-size: 12px; color: var(--text-muted); max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${this.escapeHtml((item.content || '').substring(0, 80))}</div>
                                        </td>
                                        <td style="padding: 12px 8px; text-align: center;">
                                            <span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; background: ${color}18; color: ${color};">
                                                <i class="fas ${icon}" style="font-size: 10px;"></i> ${label}
                                            </span>
                                        </td>
                                        <td style="padding: 12px 8px; text-align: center;">
                                            <span style="font-size: 12px; color: var(--text-secondary);">${item.project || 'Global'}</span>
                                        </td>
                                        <td style="padding: 12px 8px; text-align: center;">
                                            <button onclick="PortalContentApp.togglePublish('${item.id}')" style="background: none; border: none; cursor: pointer; padding: 4px 8px;" title="${item.is_published ? 'Unpublish' : 'Publish'}">
                                                <span style="display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; background: ${item.is_published ? 'rgba(34,197,94,0.15)' : 'rgba(245,158,11,0.15)'}; color: ${item.is_published ? '#22c55e' : '#f59e0b'};">
                                                    <i class="fas ${item.is_published ? 'fa-check-circle' : 'fa-clock'}" style="font-size: 10px;"></i>
                                                    ${item.is_published ? 'Published' : 'Draft'}
                                                </span>
                                            </button>
                                        </td>
                                        <td style="padding: 12px 16px; text-align: right;">
                                            <div style="display: flex; gap: 6px; justify-content: flex-end;">
                                                <button onclick="PortalContentApp.edit('${item.id}')" style="background: none; border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; cursor: pointer; color: var(--text-secondary); transition: all 0.15s;" onmouseover="this.style.borderColor='var(--accent-gold)';this.style.color='var(--accent-gold)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-secondary)'" title="Edit">
                                                    <i class="fas fa-edit" style="font-size: 12px;"></i>
                                                </button>
                                                <button onclick="PortalContentApp.remove('${item.id}')" style="background: none; border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; cursor: pointer; color: var(--text-secondary); transition: all 0.15s;" onmouseover="this.style.borderColor='#ef4444';this.style.color='#ef4444'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-secondary)'" title="Delete">
                                                    <i class="fas fa-trash" style="font-size: 12px;"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            },

            openCreateModal() {
                document.getElementById('pcEditId').value = '';
                document.getElementById('pcModalTitle').textContent = 'Add Content';
                document.getElementById('pcSection').value = 'news';
                document.getElementById('pcProject').value = '';
                document.getElementById('pcTitle').value = '';
                document.getElementById('pcContent').value = '';
                document.getElementById('pcImageUrl').value = '';
                document.getElementById('pcLink').value = '';
                document.getElementById('pcSortOrder').value = this.items.length;
                document.getElementById('pcPublished').checked = false;
                this.updatePreview();
                document.getElementById('pcModal').style.display = 'flex';
                this.setupPreview();
            },

            edit(id) {
                const item = this.items.find(i => i.id === id);
                if (!item) return;
                document.getElementById('pcEditId').value = item.id;
                document.getElementById('pcModalTitle').textContent = 'Edit Content';
                document.getElementById('pcSection').value = item.section || 'news';
                document.getElementById('pcProject').value = item.project || '';
                document.getElementById('pcTitle').value = item.title || '';
                document.getElementById('pcContent').value = item.content || '';
                document.getElementById('pcImageUrl').value = item.image_url || '';
                document.getElementById('pcLink').value = item.link || '';
                document.getElementById('pcSortOrder').value = item.sort_order || 0;
                document.getElementById('pcPublished').checked = !!item.is_published;
                this.updatePreview();
                document.getElementById('pcModal').style.display = 'flex';
                this.setupPreview();
            },

            async save() {
                const editId = document.getElementById('pcEditId').value;
                const data = {
                    section: document.getElementById('pcSection').value,
                    project: document.getElementById('pcProject').value || null,
                    title: document.getElementById('pcTitle').value.trim(),
                    content: document.getElementById('pcContent').value.trim(),
                    image_url: document.getElementById('pcImageUrl').value.trim() || null,
                    link: document.getElementById('pcLink').value.trim() || null,
                    sort_order: parseInt(document.getElementById('pcSortOrder').value) || 0,
                    is_published: document.getElementById('pcPublished').checked
                };

                if (!data.title) {
                    Toast.warning('Title is required');
                    return;
                }
                if (!data.section) {
                    Toast.warning('Section is required');
                    return;
                }

                try {
                    if (editId) {
                        await App.api(`/api/portal-content/${editId}`, {
                            method: 'PUT',
                            body: JSON.stringify(data)
                        });
                    } else {
                        await App.api('/api/portal-content', {
                            method: 'POST',
                            body: JSON.stringify(data)
                        });
                    }
                    App.closeModal('pcModal');
                    await this.load();
                } catch (err) {
                    Toast.error('Failed to save: ' + err.message);
                }
            },

            async togglePublish(id) {
                try {
                    await App.api(`/api/portal-content/${id}/publish`, { method: 'PUT' });
                    await this.load();
                } catch (err) {
                    Toast.error('Failed to toggle publish: ' + err.message);
                }
            },

            async remove(id) {
                if (!confirm('Delete this content item?')) return;
                try {
                    await App.api(`/api/portal-content/${id}`, { method: 'DELETE' });
                    await this.load();
                } catch (err) {
                    Toast.error('Failed to delete: ' + err.message);
                }
            },

            async moveItem(id, direction) {
                const filtered = this.currentFilter === 'all' ? [...this.items] : this.items.filter(i => i.section === this.currentFilter);
                const idx = filtered.findIndex(i => i.id === id);
                if (idx < 0) return;
                const newIdx = idx + direction;
                if (newIdx < 0 || newIdx >= filtered.length) return;

                // Swap sort_order values
                const items = [
                    { id: filtered[idx].id, sort_order: filtered[newIdx].sort_order },
                    { id: filtered[newIdx].id, sort_order: filtered[idx].sort_order }
                ];

                try {
                    await App.api('/api/portal-content/reorder', {
                        method: 'POST',
                        body: JSON.stringify({ items })
                    });
                    await this.load();
                } catch (err) {
                    Toast.error('Failed to reorder: ' + err.message);
                }
            }
        };

        // ===== PR & MEDIA APP =====
        const PRApp = {
            currentProject: '',
            currentMonth: new Date(),
            platformIcons: {
                instagram: 'fab fa-instagram',
                linkedin: 'fab fa-linkedin',
                twitter: 'fab fa-twitter',
                facebook: 'fab fa-facebook'
            },
            platformColors: {
                instagram: '#E4405F',
                linkedin: '#0077B5',
                twitter: '#1DA1F2',
                facebook: '#1877F2'
            },

            async api(endpoint, options = {}) {
                const res = await fetch(endpoint, {
                    ...options,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.token}`, ...options.headers }
                });
                return res.json();
            },

            async init() {
                await this.loadDashboard();
            },

            showTab(tabId, btn) {
                document.querySelectorAll('.pr-tab').forEach(t => t.classList.remove('active'));
                document.getElementById(`pr-tab-${tabId}`)?.classList.add('active');

                document.querySelectorAll('#section-pr-media .tab-btn').forEach(b => {
                    b.style.background = 'transparent';
                    b.style.color = 'var(--text-secondary)';
                });
                if (btn) {
                    btn.style.background = 'var(--pr-media)';
                    btn.style.color = 'white';
                }

                if (tabId === 'dashboard') this.loadDashboard();
                else if (tabId === 'calendar') this.loadCalendar();
                else if (tabId === 'social') this.loadPosts();
                else if (tabId === 'newsletters') this.loadNewsletters();
                else if (tabId === 'media') this.loadMedia();
                else if (tabId === 'ai-studio') this.loadAiHistory();
                else if (tabId === 'campaigns') this.loadCampaigns();
                else if (tabId === 'subscribers') this.loadSubscribers();
            },

            filterByProject(project) {
                this.currentProject = project;
                const activeTab = document.querySelector('.pr-tab.active');
                if (activeTab) {
                    const tabId = activeTab.id.replace('pr-tab-', '');
                    this.showTab(tabId, document.querySelector(`#section-pr-media .tab-btn.active`));
                }
            },

            // Dashboard
            async loadDashboard() {
                const data = await this.api('/api/pr/dashboard');

                document.getElementById('prDashPosts').textContent = data.monthStats?.count || 0;
                document.getElementById('prDashEngagement').textContent =
                    (data.monthStats?.total_likes || 0) + (data.monthStats?.total_comments || 0) + (data.monthStats?.total_shares || 0);
                document.getElementById('prDashSubscribers').textContent = data.subscribers?.active || 0;
                document.getElementById('prDashCampaigns').textContent = data.campaigns?.length || 0;

                // Upcoming content
                const upcoming = document.getElementById('prDashUpcoming');
                if (data.upcoming?.length) {
                    upcoming.innerHTML = data.upcoming.map(c => `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px; border-bottom: 1px solid var(--border);">
                            <i class="${this.platformIcons[c.platform]}" style="font-size: 20px; color: ${this.platformColors[c.platform]};"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">${c.title || c.content_text?.substring(0, 50) || 'Untitled'}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${c.scheduled_date} ${c.scheduled_time || ''}</div>
                            </div>
                            <span style="background: rgba(var(--pr-media-rgb), 0.2); color: var(--pr-media); padding: 2px 8px; border-radius: 4px; font-size: 11px;">${c.status}</span>
                        </div>
                    `).join('');
                } else {
                    upcoming.innerHTML = '<p style="color: var(--text-muted);">No upcoming content scheduled</p>';
                }

                // Recent posts
                const recent = document.getElementById('prDashRecent');
                if (data.recentPosts?.length) {
                    recent.innerHTML = data.recentPosts.slice(0, 5).map(p => `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px; border-bottom: 1px solid var(--border);">
                            <i class="${this.platformIcons[p.platform]}" style="font-size: 20px; color: ${this.platformColors[p.platform]};"></i>
                            <div style="flex: 1;">
                                <div style="font-size: 13px;">${p.content_text?.substring(0, 60) || 'No caption'}...</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${p.published_at?.split('T')[0] || ''}</div>
                            </div>
                            <div style="text-align: right; font-size: 12px;">
                                <span style="color: var(--danger);"><i class="fas fa-heart"></i> ${p.likes}</span>
                                <span style="margin-left: 8px;"><i class="fas fa-comment"></i> ${p.comments}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    recent.innerHTML = '<p style="color: var(--text-muted);">No recent posts</p>';
                }

                // Draft newsletters
                const newsletters = document.getElementById('prDashNewsletters');
                if (data.draftNewsletters?.length) {
                    newsletters.innerHTML = data.draftNewsletters.map(n => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <div>
                                <div style="font-weight: 500;">${n.name}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${n.subject}</div>
                            </div>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="PRApp.editNewsletter('${n.id}')">Edit</button>
                        </div>
                    `).join('');
                } else {
                    newsletters.innerHTML = '<p style="color: var(--text-muted);">No draft newsletters</p>';
                }

                // Campaigns
                const campaigns = document.getElementById('prDashCampaignsList');
                if (data.campaigns?.length) {
                    campaigns.innerHTML = data.campaigns.map(c => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border);">
                            <div>
                                <div style="font-weight: 500;">${c.name}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${c.start_date} - ${c.end_date}</div>
                            </div>
                            <span style="color: var(--success); font-size: 12px;"><i class="fas fa-circle"></i> Active</span>
                        </div>
                    `).join('');
                } else {
                    campaigns.innerHTML = '<p style="color: var(--text-muted);">No active campaigns</p>';
                }
            },

            // Calendar
            prevMonth() {
                this.currentMonth.setMonth(this.currentMonth.getMonth() - 1);
                this.loadCalendar();
            },

            nextMonth() {
                this.currentMonth.setMonth(this.currentMonth.getMonth() + 1);
                this.loadCalendar();
            },

            async loadCalendar() {
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth();
                const monthStr = `${year}-${String(month + 1).padStart(2, '0')}`;

                document.getElementById('prCalendarMonth').textContent =
                    this.currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                const platform = document.getElementById('prCalendarPlatform')?.value || '';
                const project = this.currentProject;

                let url = `/api/pr/calendar?month=${monthStr}`;
                if (platform) url += `&platform=${platform}`;
                if (project) url += `&project=${project}`;

                const items = await this.api(url);

                const grid = document.getElementById('prCalendarGrid');
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                let html = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d =>
                    `<div style="padding: 8px; text-align: center; font-weight: 600; color: var(--text-muted);">${d}</div>`
                ).join('');

                for (let i = 0; i < firstDay; i++) {
                    html += '<div style="padding: 8px;"></div>';
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayItems = items.filter(i => i.scheduled_date === dateStr);
                    const isToday = dateStr === new Date().toISOString().split('T')[0];

                    html += `
                        <div style="min-height: 80px; padding: 4px; border: 1px solid var(--border); background: ${isToday ? 'rgba(236,72,153,0.1)' : 'var(--bg-secondary)'}; border-radius: 4px;">
                            <div style="font-weight: ${isToday ? '700' : '500'}; margin-bottom: 4px; color: ${isToday ? 'var(--pr-media)' : 'inherit'};">${day}</div>
                            ${dayItems.slice(0, 3).map(i => `
                                <div style="font-size: 10px; padding: 2px 4px; margin-bottom: 2px; background: ${this.platformColors[i.platform]}22; color: ${this.platformColors[i.platform]}; border-radius: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer;" onclick="PRApp.editContent('${i.id}')">
                                    <i class="${this.platformIcons[i.platform]}"></i> ${i.title || i.content_text?.substring(0, 15) || 'Untitled'}
                                </div>
                            `).join('')}
                            ${dayItems.length > 3 ? `<div style="font-size: 10px; color: var(--text-muted);">+${dayItems.length - 3} more</div>` : ''}
                        </div>
                    `;
                }

                grid.innerHTML = html;
            },

            // Content
            openContentModal(date = null) {
                document.getElementById('prContentId').value = '';
                document.getElementById('prContentProject').value = this.currentProject || 'plexus';
                document.getElementById('prContentPlatform').value = 'instagram';
                document.getElementById('prContentDate').value = date || new Date().toISOString().split('T')[0];
                document.getElementById('prContentTime').value = '12:00';
                document.getElementById('prContentTitle').value = '';
                document.getElementById('prContentText').value = '';
                document.getElementById('prContentHashtags').value = '';
                document.getElementById('prContentImage').value = '';
                document.getElementById('prContentStatus').value = 'draft';
                document.getElementById('prContentModalTitle').textContent = 'Schedule Content';
                document.getElementById('prContentModal').classList.add('active');
            },

            async editContent(id) {
                const item = await this.api(`/api/pr/calendar/${id}`);
                document.getElementById('prContentId').value = item.id;
                document.getElementById('prContentProject').value = item.project;
                document.getElementById('prContentPlatform').value = item.platform;
                document.getElementById('prContentDate').value = item.scheduled_date;
                document.getElementById('prContentTime').value = item.scheduled_time || '';
                document.getElementById('prContentTitle').value = item.title || '';
                document.getElementById('prContentText').value = item.content_text || '';
                document.getElementById('prContentHashtags').value = item.hashtags || '';
                document.getElementById('prContentImage').value = item.image_url || '';
                document.getElementById('prContentStatus').value = item.status;
                document.getElementById('prContentModalTitle').textContent = 'Edit Content';
                document.getElementById('prContentModal').classList.add('active');
            },

            async saveContent() {
                const id = document.getElementById('prContentId').value;
                const data = {
                    project: document.getElementById('prContentProject').value,
                    platform: document.getElementById('prContentPlatform').value,
                    scheduled_date: document.getElementById('prContentDate').value,
                    scheduled_time: document.getElementById('prContentTime').value,
                    title: document.getElementById('prContentTitle').value,
                    content_text: document.getElementById('prContentText').value,
                    hashtags: document.getElementById('prContentHashtags').value,
                    image_url: document.getElementById('prContentImage').value,
                    status: document.getElementById('prContentStatus').value
                };

                if (id) {
                    await this.api(`/api/pr/calendar/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await this.api('/api/pr/calendar', { method: 'POST', body: JSON.stringify(data) });
                }

                this.closeModal('prContentModal');
                this.loadCalendar();
                this.loadDashboard();
            },

            // Posts
            async loadPosts() {
                const platform = document.getElementById('prPostsPlatform')?.value || '';
                let url = '/api/pr/posts?limit=50';
                if (platform) url += `&platform=${platform}`;
                if (this.currentProject) url += `&project=${this.currentProject}`;

                const posts = await this.api(url);
                const container = document.getElementById('prPostsList');

                if (!posts.length) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No posts yet. Log your published posts to track engagement.</p>';
                    return;
                }

                container.innerHTML = posts.map(p => `
                    <div class="card" style="padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <i class="${this.platformIcons[p.platform]}" style="font-size: 24px; color: ${this.platformColors[p.platform]};"></i>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; text-transform: capitalize;">${p.platform}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${p.published_at?.split('T')[0] || ''}</div>
                            </div>
                            <span style="background: rgba(var(--plexus-rgb), 0.2); color: var(--plexus); padding: 2px 8px; border-radius: 4px; font-size: 11px;">${p.project}</span>
                        </div>
                        <p style="font-size: 13px; margin-bottom: 12px;">${p.content_text?.substring(0, 150) || 'No caption'}...</p>
                        <div style="display: flex; gap: 16px; font-size: 13px;">
                            <span><i class="fas fa-heart" style="color: var(--danger);"></i> ${p.likes}</span>
                            <span><i class="fas fa-comment"></i> ${p.comments}</span>
                            <span><i class="fas fa-share"></i> ${p.shares}</span>
                            <span><i class="fas fa-eye"></i> ${p.reach}</span>
                        </div>
                    </div>
                `).join('');
            },

            openPostModal() {
                document.getElementById('prPostId').value = '';
                document.getElementById('prPostProject').value = this.currentProject || 'plexus';
                document.getElementById('prPostPlatform').value = 'instagram';
                document.getElementById('prPostDate').value = new Date().toISOString().slice(0, 16);
                document.getElementById('prPostText').value = '';
                document.getElementById('prPostLikes').value = 0;
                document.getElementById('prPostComments').value = 0;
                document.getElementById('prPostShares').value = 0;
                document.getElementById('prPostReach').value = 0;
                document.getElementById('prPostModal').classList.add('active');
            },

            async savePost() {
                const data = {
                    project: document.getElementById('prPostProject').value,
                    platform: document.getElementById('prPostPlatform').value,
                    published_at: document.getElementById('prPostDate').value,
                    content_text: document.getElementById('prPostText').value,
                    likes: parseInt(document.getElementById('prPostLikes').value) || 0,
                    comments: parseInt(document.getElementById('prPostComments').value) || 0,
                    shares: parseInt(document.getElementById('prPostShares').value) || 0,
                    reach: parseInt(document.getElementById('prPostReach').value) || 0
                };

                await this.api('/api/pr/posts', { method: 'POST', body: JSON.stringify(data) });
                this.closeModal('prPostModal');
                this.loadPosts();
                this.loadDashboard();
            },

            // Newsletters
            async loadNewsletters() {
                const status = document.getElementById('prNewsletterStatus')?.value || '';
                let url = '/api/pr/newsletters';
                if (status) url += `?status=${status}`;

                const newsletters = await this.api(url);
                const tbody = document.getElementById('prNewslettersList');

                if (!newsletters.length) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: var(--text-muted);">No newsletters</td></tr>';
                    return;
                }

                tbody.innerHTML = newsletters.map(n => {
                    const statusColors = { draft: 'var(--text-muted)', scheduled: 'var(--warning)', sent: 'var(--success)' };
                    return `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 12px;">${n.name}</td>
                            <td style="padding: 12px;">${n.subject}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="background: ${statusColors[n.status]}22; color: ${statusColors[n.status]}; padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">${n.status}</span>
                            </td>
                            <td style="padding: 12px; text-align: center;">${n.recipient_count || '-'}</td>
                            <td style="padding: 12px; text-align: center;">${n.open_rate ? n.open_rate.toFixed(1) + '%' : '-'}</td>
                            <td style="padding: 12px; text-align: center;">
                                <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="PRApp.editNewsletter('${n.id}')"><i class="fas fa-edit"></i></button>
                                ${n.status === 'draft' ? `<button class="btn btn-primary" style="padding: 4px 8px;" onclick="PRApp.sendNewsletter('${n.id}')"><i class="fas fa-paper-plane"></i></button>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            openNewsletterModal() {
                document.getElementById('prNewsletterId').value = '';
                document.getElementById('prNewsletterName').value = '';
                document.getElementById('prNewsletterProject').value = '';
                document.getElementById('prNewsletterSubject').value = '';
                document.getElementById('prNewsletterPreview').value = '';
                document.getElementById('prNewsletterContent').value = '';
                document.getElementById('prNewsletterModalTitle').textContent = 'Create Newsletter';
                document.getElementById('prNewsletterModal').classList.add('active');
            },

            async editNewsletter(id) {
                const n = await this.api(`/api/pr/newsletters/${id}`);
                document.getElementById('prNewsletterId').value = n.id;
                document.getElementById('prNewsletterName').value = n.name;
                document.getElementById('prNewsletterProject').value = n.project || '';
                document.getElementById('prNewsletterSubject').value = n.subject;
                document.getElementById('prNewsletterPreview').value = n.preview_text || '';
                document.getElementById('prNewsletterContent').value = n.content_html || '';
                document.getElementById('prNewsletterModalTitle').textContent = 'Edit Newsletter';
                document.getElementById('prNewsletterModal').classList.add('active');
            },

            async saveNewsletter() {
                const id = document.getElementById('prNewsletterId').value;
                const data = {
                    name: document.getElementById('prNewsletterName').value,
                    project: document.getElementById('prNewsletterProject').value || null,
                    subject: document.getElementById('prNewsletterSubject').value,
                    preview_text: document.getElementById('prNewsletterPreview').value,
                    content_html: document.getElementById('prNewsletterContent').value,
                    status: 'draft'
                };

                if (id) {
                    await this.api(`/api/pr/newsletters/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await this.api('/api/pr/newsletters', { method: 'POST', body: JSON.stringify(data) });
                }

                this.closeModal('prNewsletterModal');
                this.loadNewsletters();
            },

            async sendNewsletter(id) {
                if (!confirm('Send this newsletter to all active subscribers?')) return;
                const result = await this.api(`/api/pr/newsletters/${id}/send`, { method: 'POST' });
                Toast.success(`Newsletter sent to ${result.recipientCount} subscribers!`);
                this.loadNewsletters();
            },

            // Media
            async loadMedia() {
                const category = document.getElementById('prMediaCategory')?.value || '';
                const search = document.getElementById('prMediaSearch')?.value || '';

                let url = '/api/pr/media?';
                if (category) url += `category=${category}&`;
                if (search) url += `search=${search}&`;
                if (this.currentProject) url += `project=${this.currentProject}`;

                const assets = await this.api(url);
                const grid = document.getElementById('prMediaGrid');

                if (!assets.length) {
                    grid.innerHTML = '<p style="color: var(--text-muted);">No media files. Upload images to build your library.</p>';
                    return;
                }

                grid.innerHTML = assets.map(a => `
                    <div style="position: relative; border-radius: 8px; overflow: hidden; background: var(--bg-secondary); cursor: pointer;" onclick="PRApp.viewMedia('${a.id}')">
                        <img src="${a.file_path}" style="width: 100%; height: 150px; object-fit: cover;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><rect fill=%22%23374151%22 width=%22100%22 height=%22100%22/><text fill=%22%239CA3AF%22 x=%2250%22 y=%2250%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22>No Preview</text></svg>'">
                        <div style="padding: 8px;">
                            <div style="font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${a.original_name || a.file_name}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">${a.category}</div>
                        </div>
                        ${a.ai_generated ? '<div style="position: absolute; top: 4px; right: 4px; background: var(--pr-media); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;"><i class="fas fa-magic"></i></div>' : ''}
                    </div>
                `).join('');
            },

            async viewMedia(id) {
                try {
                    const asset = await this.api(`/api/pr/media/${id}`);
                    if (!asset) return;
                    // Show in a simple preview overlay
                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; cursor: pointer;';
                    overlay.onclick = () => overlay.remove();
                    overlay.innerHTML = `
                        <div style="max-width: 90%; max-height: 90%; background: var(--bg-secondary); border-radius: 12px; overflow: hidden; cursor: default;" onclick="event.stopPropagation()">
                            <img src="${asset.file_path}" style="max-width: 100%; max-height: 70vh; display: block;" onerror="this.outerHTML='<div style=\\'padding: 40px; text-align: center; color: var(--text-muted);\\'>Preview not available</div>'">
                            <div style="padding: 16px;">
                                <div style="font-weight: 600;">${asset.original_name || asset.file_name || 'Media'}</div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${asset.category || ''} ${asset.tags ? '• ' + asset.tags : ''}</div>
                                ${asset.caption ? `<div style="font-size: 13px; margin-top: 8px; color: var(--text-secondary);">${asset.caption}</div>` : ''}
                                <button class="btn btn-danger" style="margin-top: 12px;" onclick="PRApp.deleteMedia('${id}'); this.closest('[style*=position]').remove();">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>`;
                    document.body.appendChild(overlay);
                } catch (err) {
                    console.error('Failed to load media:', err);
                }
            },

            async deleteMedia(id) {
                if (!confirm('Delete this media file?')) return;
                try {
                    await this.api(`/api/pr/media/${id}`, { method: 'DELETE' });
                    this.loadMedia();
                } catch (err) {
                    console.error('Failed to delete media:', err);
                }
            },

            openUploadModal() {
                document.getElementById('prUploadFile').value = '';
                document.getElementById('prUploadProject').value = this.currentProject || '';
                document.getElementById('prUploadCategory').value = 'photo';
                document.getElementById('prUploadTags').value = '';
                document.getElementById('prUploadCaption').value = '';
                document.getElementById('prUploadModal').classList.add('active');
            },

            async uploadMedia() {
                const file = document.getElementById('prUploadFile').files[0];
                if (!file) { Toast.warning('Please select a file'); return; }

                const formData = new FormData();
                formData.append('file', file);
                formData.append('project', document.getElementById('prUploadProject').value);
                formData.append('category', document.getElementById('prUploadCategory').value);
                formData.append('tags', document.getElementById('prUploadTags').value);
                formData.append('caption', document.getElementById('prUploadCaption').value);

                await fetch('/api/pr/media', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${App.token}` },
                    body: formData
                });

                this.closeModal('prUploadModal');
                this.loadMedia();
            },

            // Campaigns
            async loadCampaigns() {
                let url = '/api/pr/campaigns';
                if (this.currentProject) url += `?project=${this.currentProject}`;

                const campaigns = await this.api(url);
                const container = document.getElementById('prCampaignsList');

                if (!campaigns.length) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No campaigns yet. Create a campaign to organize your content.</p>';
                    return;
                }

                const statusColors = { planning: 'var(--text-muted)', active: 'var(--success)', completed: 'var(--plexus)', paused: 'var(--warning)' };

                container.innerHTML = campaigns.map(c => `
                    <div class="card" style="padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <h4 style="margin-bottom: 4px;">${c.name}</h4>
                                <span style="background: ${statusColors[c.status]}22; color: ${statusColors[c.status]}; padding: 2px 8px; border-radius: 4px; font-size: 11px; text-transform: uppercase;">${c.status}</span>
                            </div>
                            <button class="btn btn-secondary" style="padding: 4px 8px;" onclick="PRApp.editCampaign('${c.id}')"><i class="fas fa-edit"></i></button>
                        </div>
                        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">${c.description || 'No description'}</p>
                        <div style="display: flex; gap: 16px; font-size: 12px; color: var(--text-muted);">
                            <span><i class="fas fa-calendar"></i> ${c.start_date || 'TBD'} - ${c.end_date || 'TBD'}</span>
                            ${c.goal ? `<span><i class="fas fa-bullseye"></i> ${c.goal}</span>` : ''}
                        </div>
                    </div>
                `).join('');
            },

            openCampaignModal() {
                document.getElementById('prCampaignId').value = '';
                document.getElementById('prCampaignName').value = '';
                document.getElementById('prCampaignProject').value = this.currentProject || '';
                document.getElementById('prCampaignDesc').value = '';
                document.getElementById('prCampaignStart').value = '';
                document.getElementById('prCampaignEnd').value = '';
                document.getElementById('prCampaignGoal').value = '';
                document.getElementById('prCampaignAudience').value = '';
                document.getElementById('prCampaignModalTitle').textContent = 'New Campaign';
                document.getElementById('prCampaignModal').classList.add('active');
            },

            async editCampaign(id) {
                const c = await this.api(`/api/pr/campaigns/${id}`);
                document.getElementById('prCampaignId').value = c.id;
                document.getElementById('prCampaignName').value = c.name;
                document.getElementById('prCampaignProject').value = c.project || '';
                document.getElementById('prCampaignDesc').value = c.description || '';
                document.getElementById('prCampaignStart').value = c.start_date || '';
                document.getElementById('prCampaignEnd').value = c.end_date || '';
                document.getElementById('prCampaignGoal').value = c.goal || '';
                document.getElementById('prCampaignAudience').value = c.target_audience || '';
                document.getElementById('prCampaignModalTitle').textContent = 'Edit Campaign';
                document.getElementById('prCampaignModal').classList.add('active');
            },

            async saveCampaign() {
                const id = document.getElementById('prCampaignId').value;
                const data = {
                    name: document.getElementById('prCampaignName').value,
                    project: document.getElementById('prCampaignProject').value || null,
                    description: document.getElementById('prCampaignDesc').value,
                    start_date: document.getElementById('prCampaignStart').value || null,
                    end_date: document.getElementById('prCampaignEnd').value || null,
                    goal: document.getElementById('prCampaignGoal').value,
                    target_audience: document.getElementById('prCampaignAudience').value,
                    status: id ? undefined : 'planning'
                };

                if (id) {
                    await this.api(`/api/pr/campaigns/${id}`, { method: 'PUT', body: JSON.stringify(data) });
                } else {
                    await this.api('/api/pr/campaigns', { method: 'POST', body: JSON.stringify(data) });
                }

                this.closeModal('prCampaignModal');
                this.loadCampaigns();
            },

            // Subscribers
            async loadSubscribers() {
                const search = document.getElementById('prSubscriberSearch')?.value || '';
                let url = '/api/pr/subscribers';
                if (search) url += `?search=${search}`;

                const subscribers = await this.api(url);
                const tbody = document.getElementById('prSubscribersList');

                document.getElementById('prSubscriberCount').textContent = `${subscribers.length} subscribers`;
                document.getElementById('prActiveCount').textContent = `${subscribers.filter(s => s.status === 'active').length} active`;

                if (!subscribers.length) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 20px; text-align: center; color: var(--text-muted);">No subscribers</td></tr>';
                    return;
                }

                tbody.innerHTML = subscribers.map(s => `
                    <tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px;">${s.email}</td>
                        <td style="padding: 12px;">${s.first_name || ''} ${s.last_name || ''}</td>
                        <td style="padding: 12px; text-align: center;">${s.subscribed_projects || 'all'}</td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="background: ${s.status === 'active' ? 'rgba(34,197,94,0.2)' : 'rgba(156,163,175,0.2)'}; color: ${s.status === 'active' ? 'var(--success)' : 'var(--text-muted)'}; padding: 2px 8px; border-radius: 4px; font-size: 11px;">${s.status}</span>
                        </td>
                        <td style="padding: 12px; text-align: center; font-size: 12px; color: var(--text-muted);">${s.subscribed_at?.split('T')[0] || ''}</td>
                        <td style="padding: 12px; text-align: center;">
                            ${s.status === 'active' ? `<button class="btn btn-secondary" style="padding: 4px 8px;" onclick="PRApp.unsubscribe('${s.id}')"><i class="fas fa-user-minus"></i></button>` : ''}
                        </td>
                    </tr>
                `).join('');
            },

            openSubscriberModal() {
                document.getElementById('prSubscriberEmail').value = '';
                document.getElementById('prSubscriberFirst').value = '';
                document.getElementById('prSubscriberLast').value = '';
                document.getElementById('prSubscriberProjects').value = 'all';
                document.getElementById('prSubscriberModal').classList.add('active');
            },

            async saveSubscriber() {
                const data = {
                    email: document.getElementById('prSubscriberEmail').value,
                    first_name: document.getElementById('prSubscriberFirst').value,
                    last_name: document.getElementById('prSubscriberLast').value,
                    subscribed_projects: document.getElementById('prSubscriberProjects').value
                };

                if (!data.email) { Toast.warning('Email is required'); return; }

                await this.api('/api/pr/subscribers', { method: 'POST', body: JSON.stringify(data) });
                this.closeModal('prSubscriberModal');
                this.loadSubscribers();
            },

            async unsubscribe(id) {
                if (!confirm('Unsubscribe this user?')) return;
                await this.api(`/api/pr/subscribers/${id}/unsubscribe`, { method: 'POST' });
                this.loadSubscribers();
            },

            exportSubscribers() {
                window.location.href = '/api/pr/subscribers/export';
            },

            // AI Studio
            async loadAiHistory() {
                const history = await this.api('/api/pr/ai-generations');
                const container = document.getElementById('prAiHistory');

                if (!history.length) {
                    container.innerHTML = '<p style="color: var(--text-muted);">No generations yet. Use the tools above to generate content.</p>';
                    return;
                }

                container.innerHTML = history.map(h => `
                    <div style="display: flex; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border);">
                        ${h.result_image_path ? `<img src="${h.result_image_path}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px;">` : '<div style="width: 60px; height: 60px; background: var(--bg-secondary); border-radius: 6px; display: flex; align-items: center; justify-content: center;"><i class="fas fa-align-left" style="color: var(--text-muted);"></i></div>'}
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 4px;">${h.type === 'image' ? 'Image' : 'Caption'} - ${h.project || 'General'}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">${h.prompt?.substring(0, 80)}...</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${h.created_at?.split('T')[0]}</div>
                        </div>
                        <div>
                            ${h.used ? '<span style="color: var(--success);"><i class="fas fa-check"></i> Used</span>' : '<button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="PRApp.markUsed(\'' + h.id + '\')">Use</button>'}
                        </div>
                    </div>
                `).join('');
            },

            async generateImage() {
                const prompt = document.getElementById('prAiImagePrompt').value;
                if (!prompt) { Toast.warning('Please enter a prompt'); return; }

                const project = document.getElementById('prAiProject').value;
                const platform = document.getElementById('prAiPlatform').value;

                // Show loading
                document.getElementById('prAiImageResult').style.display = 'block';
                document.getElementById('prAiGeneratedImage').src = '';
                document.getElementById('prAiGeneratedImage').alt = 'Generating...';

                alert('AI image generation would be triggered here. This requires the nano-banana MCP server to be running.');

                // Save to history
                await this.api('/api/pr/ai-generations', {
                    method: 'POST',
                    body: JSON.stringify({ type: 'image', prompt, project, platform, model: 'nano-banana' })
                });
            },

            async generateCaption() {
                const topic = document.getElementById('prAiCaptionTopic').value;
                if (!topic) { Toast.warning('Please enter a topic'); return; }

                const tone = document.getElementById('prAiCaptionTone').value;
                const platform = document.getElementById('prAiCaptionPlatform').value;

                // Generate caption based on parameters
                let caption = '';
                if (platform === 'twitter') {
                    caption = `${topic.substring(0, 200)}\n\n#MedX #Healthcare`;
                } else {
                    caption = `${topic}\n\nJoin us on this journey! Link in bio.\n\n#MedX #Plexus2026 #Healthcare #Science`;
                }

                document.getElementById('prAiCaptionResult').style.display = 'block';
                document.getElementById('prAiGeneratedCaption').textContent = caption;

                // Save to history
                await this.api('/api/pr/ai-generations', {
                    method: 'POST',
                    body: JSON.stringify({ type: 'caption', prompt: topic, result_text: caption, platform })
                });
            },

            useGeneratedImage() {
                const img = document.getElementById('prAiGeneratedImage');
                if (!img || !img.src) { Toast.warning('No image generated yet'); return; }
                // Copy image URL to clipboard for use in posts
                navigator.clipboard.writeText(img.src);
                Toast.success('Image URL copied to clipboard!');
            },

            useGeneratedCaption() {
                const caption = document.getElementById('prAiGeneratedCaption').textContent;
                navigator.clipboard.writeText(caption);
                Toast.success('Caption copied to clipboard!');
            },

            async markUsed(id) {
                await this.api(`/api/pr/ai-generations/${id}/use`, { method: 'POST' });
                this.loadAiHistory();
            },

            // ========== Week View ==========
            calendarView: 'month',
            currentWeek: new Date(),

            setCalendarView(view) {
                this.calendarView = view;
                const monthBtn = document.getElementById('prViewMonth');
                const weekBtn = document.getElementById('prViewWeek');
                const monthNav = document.getElementById('prCalendarMonthNav');
                const weekNav = document.getElementById('prCalendarWeekNav');
                const monthView = document.getElementById('prMonthView');
                const weekView = document.getElementById('prWeekView');

                if (view === 'month') {
                    monthBtn.style.background = 'var(--pr-media)'; monthBtn.style.color = 'white';
                    weekBtn.style.background = 'var(--bg-secondary)'; weekBtn.style.color = 'var(--text-secondary)';
                    monthNav.style.display = 'flex'; weekNav.style.display = 'none';
                    monthView.style.display = ''; weekView.style.display = 'none';
                    this.loadCalendar();
                } else {
                    weekBtn.style.background = 'var(--pr-media)'; weekBtn.style.color = 'white';
                    monthBtn.style.background = 'var(--bg-secondary)'; monthBtn.style.color = 'var(--text-secondary)';
                    weekNav.style.display = 'flex'; monthNav.style.display = 'none';
                    weekView.style.display = ''; monthView.style.display = 'none';
                    this.renderWeekView();
                }
            },

            refreshCalendarView() {
                if (this.calendarView === 'week') this.renderWeekView();
                else this.loadCalendar();
            },

            prevWeek() {
                this.currentWeek.setDate(this.currentWeek.getDate() - 7);
                this.renderWeekView();
            },

            nextWeek() {
                this.currentWeek.setDate(this.currentWeek.getDate() + 7);
                this.renderWeekView();
            },

            _getWeekDates(date) {
                const d = new Date(date);
                const day = d.getDay();
                const monday = new Date(d);
                monday.setDate(d.getDate() - ((day + 6) % 7));
                const days = [];
                for (let i = 0; i < 7; i++) {
                    const dd = new Date(monday);
                    dd.setDate(monday.getDate() + i);
                    days.push(dd);
                }
                return days;
            },

            async renderWeekView() {
                const days = this._getWeekDates(this.currentWeek);
                const startStr = days[0].toISOString().split('T')[0];
                const endStr = days[6].toISOString().split('T')[0];

                const opts = { month: 'short', day: 'numeric' };
                const yearOpts = { month: 'short', day: 'numeric', year: 'numeric' };
                document.getElementById('prWeekLabel').textContent =
                    `${days[0].toLocaleDateString('en-US', opts)} - ${days[6].toLocaleDateString('en-US', yearOpts)}`;

                const platform = document.getElementById('prCalendarPlatform')?.value || '';
                let url = `/api/pr/calendar?start=${startStr}&end=${endStr}`;
                if (platform) url += `&platform=${platform}`;
                if (this.currentProject) url += `&project=${this.currentProject}`;

                let items = [];
                try { items = await this.api(url); } catch(e) { items = []; }
                if (!Array.isArray(items)) items = [];

                const todayStr = new Date().toISOString().split('T')[0];
                const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const pColors = { instagram: '#E1306C', twitter: '#1DA1F2', facebook: '#4267B2', linkedin: '#0077B5', tiktok: '#000000', youtube: '#FF0000' };
                const pIcons = { instagram: 'fab fa-instagram', twitter: 'fab fa-twitter', facebook: 'fab fa-facebook', linkedin: 'fab fa-linkedin', tiktok: 'fab fa-tiktok', youtube: 'fab fa-youtube' };

                let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">';
                days.forEach((day, i) => {
                    const dateStr = day.toISOString().split('T')[0];
                    const isToday = dateStr === todayStr;
                    const dayItems = items.filter(it => it.scheduled_date === dateStr);

                    html += `<div style="background: var(--bg-secondary); border-radius: 8px; border: 1px solid ${isToday ? 'var(--pr-media)' : 'var(--border)'}; min-height: 200px; overflow: hidden;">`;
                    html += `<div style="padding: 10px 12px; border-bottom: 1px solid var(--border); background: ${isToday ? 'rgba(236,72,153,0.15)' : 'transparent'};">`;
                    html += `<div style="font-weight: 600; color: ${isToday ? 'var(--pr-media)' : 'var(--text-primary)'};">${dayNames[i]}</div>`;
                    html += `<div style="font-size: 12px; color: var(--text-muted);">${day.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>`;
                    html += '</div><div style="padding: 8px;">';

                    if (dayItems.length === 0) {
                        html += '<div style="text-align: center; padding: 20px 0; color: var(--text-muted); font-size: 11px;">No content</div>';
                    } else {
                        dayItems.forEach(item => {
                            const color = pColors[item.platform] || '#888';
                            const icon = pIcons[item.platform] || 'fas fa-globe';
                            html += `<div onclick="PRApp.editContent('${item.id}')" style="padding: 8px; margin-bottom: 6px; background: ${color}15; border-left: 3px solid ${color}; border-radius: 4px; cursor: pointer;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform=''">`;
                            html += `<div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><i class="${icon}" style="color: ${color}; font-size: 12px;"></i>`;
                            html += `<span style="font-size: 11px; font-weight: 600; color: ${color}; text-transform: capitalize;">${item.platform}</span>`;
                            if (item.scheduled_time) html += `<span style="font-size: 10px; color: var(--text-muted); margin-left: auto;">${item.scheduled_time}</span>`;
                            html += '</div>';
                            html += `<div style="font-size: 12px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.title || item.content_text?.substring(0, 40) || 'Untitled'}</div>`;
                            html += `<div style="font-size: 10px; margin-top: 2px; padding: 1px 6px; display: inline-block; border-radius: 3px; background: ${item.status === 'published' ? 'rgba(16,185,129,0.2)' : 'rgba(255,255,255,0.1)'}; color: ${item.status === 'published' ? '#10b981' : 'var(--text-muted)'};">${item.status}</div>`;
                            html += '</div>';
                        });
                    }
                    html += '</div></div>';
                });
                html += '</div>';
                document.getElementById('prWeekGrid').innerHTML = html;
            },

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }
        };

        // =========================================
        // PLEXUS SETTINGS ADMIN
        // =========================================
        const PlexusSettingsAdmin = {
            settings: null,
            keyDates: [],
            testimonials: [],

            async loadSettings() {
                try {
                    const res = await fetch('/api/admin/plexus/settings', {
                        headers: { 'Authorization': 'Bearer ' + App.token }
                    });
                    if (res.ok) {
                        this.settings = await res.json();
                        this.keyDates = this.settings.key_dates || [];
                        this.testimonials = this.settings.testimonials || [];
                        this.populateForm();
                        this.renderKeyDatesEditor();
                        this.renderTestimonialsEditor();
                    }
                } catch(e) { console.error('Failed to load plexus settings:', e); }
            },

            populateForm() {
                const s = this.settings;
                if (!s) return;
                const setVal = (id, val) => { const el = document.getElementById(id); if (el && val != null) el.value = val; };
                setVal('pxSettingPriceStudentEarly', s.price_student_early);
                setVal('pxSettingPriceStudentLate', s.price_student_late);
                setVal('pxSettingPriceProfEarly', s.price_professional_early);
                setVal('pxSettingPriceProfLate', s.price_professional_late);
                setVal('pxSettingStartDate', s.conference_start_date);
                setVal('pxSettingEndDate', s.conference_end_date);
                setVal('pxSettingEarlyBirdDeadline', s.early_bird_deadline);
                setVal('pxSettingAbstractDeadline', s.abstract_deadline);
                setVal('pxSettingRegOpen', s.is_registration_open ? '1' : '0');
            },

            renderKeyDatesEditor() {
                const container = document.getElementById('pxKeyDatesEditor');
                if (!container) return;
                if (this.keyDates.length === 0) { container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No key dates yet.</p>'; return; }
                container.innerHTML = this.keyDates.map((d, i) => '<div style="display: grid; grid-template-columns: 1fr 1fr auto auto; gap: 12px; align-items: end; margin-bottom: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Label</label><input type="text" class="form-input" value="' + (d.label || '').replace(/"/g, '&quot;') + '" onchange="PlexusSettingsAdmin.updateKeyDate(' + i + ', \'label\', this.value)"></div>' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Date Text</label><input type="text" class="form-input" value="' + (d.date || '').replace(/"/g, '&quot;') + '" onchange="PlexusSettingsAdmin.updateKeyDate(' + i + ', \'date\', this.value)"></div>' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Color</label><input type="color" class="form-input" value="' + (d.color && d.color.startsWith('#') ? d.color : '#0f172a') + '" onchange="PlexusSettingsAdmin.updateKeyDate(' + i + ', \'color\', this.value)" style="width:50px;height:36px;padding:2px;"></div>' +
                    '<button class="btn btn-secondary" onclick="PlexusSettingsAdmin.removeKeyDate(' + i + ')" style="height:36px;padding:0 12px;color:var(--danger);" title="Remove"><i class="fas fa-trash"></i></button>' +
                '</div>').join('');
            },

            addKeyDate() { this.keyDates.push({ label: 'New Date', date: 'TBD', color: '#0f172a' }); this.renderKeyDatesEditor(); },
            updateKeyDate(i, field, val) { if (this.keyDates[i]) this.keyDates[i][field] = val; },
            removeKeyDate(i) { this.keyDates.splice(i, 1); this.renderKeyDatesEditor(); },

            renderTestimonialsEditor() {
                const container = document.getElementById('pxTestimonialsEditor');
                if (!container) return;
                if (this.testimonials.length === 0) { container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No testimonials yet.</p>'; return; }
                container.innerHTML = this.testimonials.map((t, i) => '<div style="padding:16px;background:var(--bg-secondary);border-radius:8px;margin-bottom:12px;">' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px;">' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Name</label><input type="text" class="form-input" value="' + (t.name || '').replace(/"/g, '&quot;') + '" onchange="PlexusSettingsAdmin.updateTestimonial(' + i + ', \'name\', this.value)"></div>' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Title</label><input type="text" class="form-input" value="' + (t.title || '').replace(/"/g, '&quot;') + '" onchange="PlexusSettingsAdmin.updateTestimonial(' + i + ', \'title\', this.value)"></div>' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Year</label><input type="text" class="form-input" value="' + (t.year || '').replace(/"/g, '&quot;') + '" onchange="PlexusSettingsAdmin.updateTestimonial(' + i + ', \'year\', this.value)"></div>' +
                    '</div>' +
                    '<div style="display:grid;grid-template-columns:1fr auto;gap:12px;margin-bottom:12px;">' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Avatar URL</label><input type="text" class="form-input" value="' + (t.avatar || '').replace(/"/g, '&quot;') + '" onchange="PlexusSettingsAdmin.updateTestimonial(' + i + ', \'avatar\', this.value)"></div>' +
                    '<button class="btn btn-secondary" onclick="PlexusSettingsAdmin.removeTestimonial(' + i + ')" style="height:36px;align-self:end;padding:0 12px;color:var(--danger);" title="Remove"><i class="fas fa-trash"></i></button></div>' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Quote</label><textarea class="form-input" rows="2" onchange="PlexusSettingsAdmin.updateTestimonial(' + i + ', \'quote\', this.value)">' + (t.quote || '').replace(/</g, '&lt;') + '</textarea></div>' +
                '</div>').join('');
            },

            addTestimonial() { this.testimonials.push({ name: '', title: '', year: 'Plexus 2026', quote: '', avatar: '' }); this.renderTestimonialsEditor(); },
            updateTestimonial(i, field, val) { if (this.testimonials[i]) this.testimonials[i][field] = val; },
            removeTestimonial(i) { this.testimonials.splice(i, 1); this.renderTestimonialsEditor(); },

            async saveSettings() {
                const getVal = (id) => document.getElementById(id)?.value || '';
                const data = {
                    price_student_early: parseFloat(getVal('pxSettingPriceStudentEarly')) || 39,
                    price_student_late: parseFloat(getVal('pxSettingPriceStudentLate')) || 59,
                    price_professional_early: parseFloat(getVal('pxSettingPriceProfEarly')) || 99,
                    price_professional_late: parseFloat(getVal('pxSettingPriceProfLate')) || 149,
                    conference_start_date: getVal('pxSettingStartDate'),
                    conference_end_date: getVal('pxSettingEndDate'),
                    early_bird_deadline: getVal('pxSettingEarlyBirdDeadline'),
                    abstract_deadline: getVal('pxSettingAbstractDeadline'),
                    is_registration_open: getVal('pxSettingRegOpen') === '1',
                    key_dates_json: JSON.stringify(this.keyDates),
                    testimonials_json: JSON.stringify(this.testimonials)
                };
                try {
                    const res = await fetch('/api/admin/plexus/settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + App.token },
                        body: JSON.stringify(data)
                    });
                    if (res.ok) { Toast.success('Plexus settings saved successfully'); const r = await res.json(); this.settings = r.settings; }
                    else { Toast.error('Failed to save settings'); }
                } catch(e) { console.error('Save plexus settings error:', e); Toast.error('Failed to save settings'); }
            }
        };

        // =========================================
        // GALA ADMIN - Gala Evening Management
        // =========================================
        const GalaAdmin = {
            registrations: [],
            settings: null,
            initialized: false,

            async init() {
                if (this.initialized) {
                    this.loadRegistrations();
                    return;
                }
                this.initialized = true;
                await Promise.all([this.loadRegistrations(), this.loadSettings()]);
            },

            async loadRegistrations() {
                try {
                    const res = await fetch('/api/gala/registrations', {
                        headers: { 'Authorization': `Bearer ${App.token}` }
                    });
                    if (res.ok) {
                        this.registrations = await res.json();
                        this.renderRegistrations();
                        this.updateStats();
                    }
                } catch (err) {
                    console.error('Failed to load gala registrations:', err);
                }
            },

            async loadSettings() {
                try {
                    const res = await fetch('/api/admin/gala/settings', {
                        headers: { 'Authorization': `Bearer ${App.token}` }
                    });
                    if (res.ok) {
                        this.settings = await res.json();
                        this.populateSettings();
                        this.renderSpeakersEditor();
                        this.renderScheduleEditor();
                    }
                } catch (err) {
                    console.error('Failed to load gala settings:', err);
                }
            },

            populateSettings() {
                const s = this.settings;
                if (!s) return;
                const setVal = (id, val) => { const el = document.getElementById(id); if (el && val != null) el.value = val; };
                setVal('galaSettingTitle', s.title);
                setVal('galaSettingTagline', s.tagline);
                setVal('galaSettingDate', s.date);
                setVal('galaSettingTime', s.time);
                setVal('galaSettingVenue', s.venue);
                setVal('galaSettingDressCode', s.dress_code);
                setVal('galaSettingCapacity', s.capacity);
                setVal('galaSettingRegOpen', s.is_registration_open ? '1' : '0');
                setVal('galaSettingDescription', s.description);
                setVal('galaSettingPriceOnly', s.price_gala_only);
                setVal('galaSettingPriceBundle', s.price_bundle);
                setVal('galaSettingPriceBundleOrig', s.price_bundle_original);
            },

            async saveSettings() {
                const getVal = (id) => document.getElementById(id)?.value || '';
                const data = {
                    title: getVal('galaSettingTitle'),
                    tagline: getVal('galaSettingTagline'),
                    date: getVal('galaSettingDate'),
                    time: getVal('galaSettingTime'),
                    venue: getVal('galaSettingVenue'),
                    dress_code: getVal('galaSettingDressCode'),
                    capacity: parseInt(getVal('galaSettingCapacity')) || 150,
                    is_registration_open: getVal('galaSettingRegOpen') === '1',
                    description: getVal('galaSettingDescription'),
                    price_gala_only: parseFloat(getVal('galaSettingPriceOnly')) || 95,
                    price_bundle: parseFloat(getVal('galaSettingPriceBundle')) || 174,
                    price_bundle_original: parseFloat(getVal('galaSettingPriceBundleOrig')) || 194,
                };
                try {
                    const res = await fetch('/api/admin/gala/settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.token}` },
                        body: JSON.stringify(data)
                    });
                    if (res.ok) {
                        Toast.success('Gala settings saved');
                        this.settings = data;
                    } else {
                        alert('Failed to save settings');
                    }
                } catch (err) {
                    console.error('Failed to save gala settings:', err);
                    alert('Error saving settings');
                }
            },

            updateStats() {
                const total = this.registrations.length;
                const pending = this.registrations.filter(r => r.status === 'pending').length;
                const approved = this.registrations.filter(r => r.status === 'approved').length;
                const paid = this.registrations.filter(r => r.payment_status === 'paid' || r.status === 'confirmed').length;

                document.getElementById('galaStatTotal').textContent = total;
                document.getElementById('galaStatPending').textContent = pending;
                document.getElementById('galaStatApproved').textContent = approved;
                document.getElementById('galaStatPaid').textContent = paid;

                // Update sidebar badge
                const badge = document.getElementById('galaPendingCount');
                if (badge) {
                    badge.textContent = pending;
                    badge.style.display = pending > 0 ? 'inline' : 'none';
                }
            },

            showTab(tab) {
                const regsTab = document.getElementById('galaRegistrationsTab');
                const settingsTab = document.getElementById('galaSettingsTab');
                const regsBtn = document.getElementById('galaTabRegs');
                const settingsBtn = document.getElementById('galaTabSettings');

                if (tab === 'registrations') {
                    regsTab.style.display = 'block';
                    settingsTab.style.display = 'none';
                    regsBtn.className = 'btn btn-primary';
                    settingsBtn.className = 'btn btn-secondary';
                } else {
                    regsTab.style.display = 'none';
                    settingsTab.style.display = 'block';
                    regsBtn.className = 'btn btn-secondary';
                    settingsBtn.className = 'btn btn-primary';
                }
            },

            // Speakers editor
            renderSpeakersEditor() {
                const container = document.getElementById('galaSpeakersEditor');
                if (!container) return;
                const speakers = this.settings?.speakers || [];
                if (speakers.length === 0) { container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No speakers yet.</p>'; return; }
                container.innerHTML = speakers.map((s, i) => '<div style="padding:16px;background:var(--bg-secondary);border-radius:8px;margin-bottom:12px;">' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;margin-bottom:12px;">' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Name</label><input type="text" class="form-input" value="' + (s.name || '').replace(/"/g, '&quot;') + '" onchange="GalaAdmin.updateSpeaker(' + i + ', \'name\', this.value)"></div>' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Title</label><input type="text" class="form-input" value="' + (s.title || '').replace(/"/g, '&quot;') + '" onchange="GalaAdmin.updateSpeaker(' + i + ', \'title\', this.value)"></div>' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Topic</label><input type="text" class="form-input" value="' + (s.topic || '').replace(/"/g, '&quot;') + '" onchange="GalaAdmin.updateSpeaker(' + i + ', \'topic\', this.value)"></div>' +
                    '<button class="btn btn-secondary" onclick="GalaAdmin.removeSpeaker(' + i + ')" style="height:36px;align-self:end;padding:0 12px;color:var(--danger);" title="Remove"><i class="fas fa-trash"></i></button></div>' +
                    '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Image URL</label><input type="text" class="form-input" value="' + (s.image || '').replace(/"/g, '&quot;') + '" onchange="GalaAdmin.updateSpeaker(' + i + ', \'image\', this.value)"></div>' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Badge</label><input type="text" class="form-input" value="' + (s.badge || '').replace(/"/g, '&quot;') + '" onchange="GalaAdmin.updateSpeaker(' + i + ', \'badge\', this.value)"></div></div>' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Bio</label><textarea class="form-input" rows="2" onchange="GalaAdmin.updateSpeaker(' + i + ', \'bio\', this.value)">' + (s.bio || '').replace(/</g, '&lt;') + '</textarea></div></div>').join('');
            },
            addSpeaker() {
                if (!this.settings) this.settings = {};
                if (!this.settings.speakers) this.settings.speakers = [];
                this.settings.speakers.push({ key: 'speaker_' + Date.now(), name: '', title: '', topic: '', image: '', bio: '', badge: '', featured: false });
                this.renderSpeakersEditor();
            },
            updateSpeaker(i, field, val) { if (this.settings?.speakers?.[i]) this.settings.speakers[i][field] = val; },
            removeSpeaker(i) { if (this.settings?.speakers) { this.settings.speakers.splice(i, 1); this.renderSpeakersEditor(); } },

            // Schedule editor
            renderScheduleEditor() {
                const container = document.getElementById('galaScheduleEditor');
                if (!container) return;
                const schedule = this.settings?.schedule || [];
                if (schedule.length === 0) { container.innerHTML = '<p style="color: var(--text-muted); font-size: 13px;">No schedule items yet.</p>'; return; }
                container.innerHTML = schedule.map((item, i) => '<div style="display:grid;grid-template-columns:100px 1fr 1fr 120px auto;gap:12px;align-items:end;margin-bottom:12px;padding:12px;background:var(--bg-secondary);border-radius:8px;">' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Time</label><input type="text" class="form-input" value="' + (item.time || '').replace(/"/g, '&quot;') + '" onchange="GalaAdmin.updateScheduleItem(' + i + ', \'time\', this.value)" placeholder="18:00"></div>' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Title</label><input type="text" class="form-input" value="' + (item.title || '').replace(/"/g, '&quot;') + '" onchange="GalaAdmin.updateScheduleItem(' + i + ', \'title\', this.value)"></div>' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Description</label><input type="text" class="form-input" value="' + (item.description || '').replace(/"/g, '&quot;') + '" onchange="GalaAdmin.updateScheduleItem(' + i + ', \'description\', this.value)"></div>' +
                    '<div class="form-group" style="margin:0;"><label class="form-label" style="font-size:11px;">Icon</label><input type="text" class="form-input" value="' + (item.icon || '').replace(/"/g, '&quot;') + '" onchange="GalaAdmin.updateScheduleItem(' + i + ', \'icon\', this.value)" placeholder="fas fa-star"></div>' +
                    '<button class="btn btn-secondary" onclick="GalaAdmin.removeScheduleItem(' + i + ')" style="height:36px;padding:0 12px;color:var(--danger);" title="Remove"><i class="fas fa-trash"></i></button></div>').join('');
            },
            addScheduleItem() {
                if (!this.settings) this.settings = {};
                if (!this.settings.schedule) this.settings.schedule = [];
                this.settings.schedule.push({ time: '', title: '', description: '', icon: 'fas fa-star' });
                this.renderScheduleEditor();
            },
            updateScheduleItem(i, field, val) { if (this.settings?.schedule?.[i]) this.settings.schedule[i][field] = val; },
            removeScheduleItem(i) { if (this.settings?.schedule) { this.settings.schedule.splice(i, 1); this.renderScheduleEditor(); } },

            async saveSpeakersAndSchedule() {
                try {
                    const res = await fetch('/api/admin/gala/settings', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + App.token },
                        body: JSON.stringify({
                            speakers_json: JSON.stringify(this.settings?.speakers || []),
                            schedule_json: JSON.stringify(this.settings?.schedule || [])
                        })
                    });
                    if (res.ok) { Toast.success('Gala speakers & schedule saved'); }
                    else { Toast.error('Failed to save'); }
                } catch(e) { console.error('Save gala speakers/schedule error:', e); Toast.error('Failed to save'); }
            },

            filterRegistrations() {
                this.renderRegistrations();
            },

            renderRegistrations() {
                const container = document.getElementById('galaRegistrationsList');
                const filter = document.getElementById('galaStatusFilter')?.value || 'all';
                let regs = this.registrations;

                if (filter !== 'all') {
                    if (filter === 'confirmed') {
                        regs = regs.filter(r => r.payment_status === 'paid' || r.status === 'confirmed');
                    } else {
                        regs = regs.filter(r => r.status === filter);
                    }
                }

                if (regs.length === 0) {
                    container.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        <i class="fas fa-glass-cheers" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <p>No registrations found</p>
                    </div>`;
                    return;
                }

                let html = `<table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border);">
                            <th style="text-align: left; padding: 12px 16px; font-size: 12px; text-transform: uppercase; color: var(--text-muted); font-weight: 600;">Name</th>
                            <th style="text-align: left; padding: 12px 16px; font-size: 12px; text-transform: uppercase; color: var(--text-muted); font-weight: 600;">Email</th>
                            <th style="text-align: left; padding: 12px 16px; font-size: 12px; text-transform: uppercase; color: var(--text-muted); font-weight: 600;">Institution</th>
                            <th style="text-align: left; padding: 12px 16px; font-size: 12px; text-transform: uppercase; color: var(--text-muted); font-weight: 600;">Ticket</th>
                            <th style="text-align: left; padding: 12px 16px; font-size: 12px; text-transform: uppercase; color: var(--text-muted); font-weight: 600;">Status</th>
                            <th style="text-align: left; padding: 12px 16px; font-size: 12px; text-transform: uppercase; color: var(--text-muted); font-weight: 600;">Payment</th>
                            <th style="text-align: center; padding: 12px 16px; font-size: 12px; text-transform: uppercase; color: var(--text-muted); font-weight: 600;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>`;

                regs.forEach(r => {
                    const statusColors = { pending: '#f59e0b', approved: '#10b981', rejected: '#ef4444', confirmed: '#3b82f6' };
                    const effectiveStatus = r.payment_status === 'paid' ? 'confirmed' : r.status;
                    const statusColor = statusColors[effectiveStatus] || '#6b7280';
                    const pricing = r.pricing === 'bundle' ? 'Bundle' : 'Gala Only';
                    const paymentBadge = r.payment_status === 'paid'
                        ? '<span style="background: rgba(16, 185, 129, 0.15); color: #10b981; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;">Paid</span>'
                        : '<span style="background: rgba(107, 114, 128, 0.15); color: #6b7280; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 600;">Unpaid</span>';

                    html += `<tr style="border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px 16px; font-weight: 500;">${r.first_name} ${r.last_name}</td>
                        <td style="padding: 12px 16px; font-size: 13px; color: var(--text-secondary);">${r.email}</td>
                        <td style="padding: 12px 16px; font-size: 13px; color: var(--text-secondary);">${r.institution || '-'}</td>
                        <td style="padding: 12px 16px; font-size: 13px;">${pricing}</td>
                        <td style="padding: 12px 16px;">
                            <span style="background: ${statusColor}22; color: ${statusColor}; padding: 2px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: capitalize;">${effectiveStatus}</span>
                        </td>
                        <td style="padding: 12px 16px;">${paymentBadge}</td>
                        <td style="padding: 12px 16px; text-align: center;">`;

                    if (r.status === 'pending') {
                        html += `
                            <button class="btn btn-primary" onclick="GalaAdmin.updateStatus('${r.id}', 'approved')" style="padding: 4px 12px; font-size: 12px; margin-right: 4px;" title="Approve">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-secondary" onclick="GalaAdmin.updateStatus('${r.id}', 'rejected')" style="padding: 4px 12px; font-size: 12px; color: #ef4444;" title="Reject">
                                <i class="fas fa-times"></i>
                            </button>`;
                    } else if (r.status === 'approved' && r.payment_status !== 'paid') {
                        html += `<span style="font-size: 12px; color: var(--text-muted);">Awaiting payment</span>`;
                    } else if (r.payment_status === 'paid') {
                        html += `<span style="font-size: 12px; color: #10b981;"><i class="fas fa-check-circle"></i> Confirmed</span>`;
                    } else {
                        html += `<button class="btn btn-secondary" onclick="GalaAdmin.updateStatus('${r.id}', 'pending')" style="padding: 4px 12px; font-size: 12px;" title="Reset to pending">
                            <i class="fas fa-undo"></i>
                        </button>`;
                    }

                    html += `</td></tr>`;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
            },

            async updateStatus(id, status) {
                const notes = status === 'rejected' ? prompt('Optional note for rejection:') || '' : '';
                try {
                    const res = await fetch(`/api/gala/registrations/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${App.token}` },
                        body: JSON.stringify({ status, admin_notes: notes })
                    });
                    if (res.ok) {
                        Toast.success(`Registration ${status}`);
                        this.loadRegistrations();
                    } else {
                        alert('Failed to update status');
                    }
                } catch (err) {
                    console.error('Failed to update gala status:', err);
                }
            }
        };

        // Initialize FinanceApp when Finances section is shown
        const originalShowSection = App.showSection;
        App.showSection = function(sectionId, navItem, skipHistory) {
            originalShowSection.call(this, sectionId, navItem, skipHistory);
            if (sectionId === 'finances') {
                FinanceApp.init();
                // Load finance-specific chat channels
                this.loadProjectChannels('finances');
            }
            if (sectionId === 'pr-media') {
                PRApp.init();
                // Load PR-specific chat channels
                this.loadProjectChannels('pr-media');
            }
        };

        // Initialize AcceleratorApp when Accelerator section is shown
        const originalShowProject = App.showProject;
        App.showProject = function(project, el) {
            originalShowProject.call(this, project, el);
            if (project === 'accelerator') {
                AcceleratorApp.init();
            }
        };

        // Global Escape key handler for modals and command palette
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Close command palette first if open
                const palette = document.getElementById('cmdPalette');
                if (palette && palette.classList.contains('active')) {
                    CmdPalette.forceClose();
                    return;
                }
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    if (modal.style.display !== 'none' && modal.style.display !== '') {
                        modal.style.display = 'none';
                    }
                    modal.classList.remove('active');
                });
            }
        });

        // ========================================
        // CMD+K COMMAND PALETTE
        // ========================================
        const CmdPalette = {
            selectedIndex: 0,
            filteredItems: [],

            registry: [
                // Sections
                { title: 'Dashboard', sub: 'Home', icon: 'fa-home', color: 'var(--accent-gold)', group: 'Sections', action: () => App.showSection('dashboard') },
                { title: 'Finances', sub: 'Budget, transactions, invoices', icon: 'fa-coins', color: 'var(--finances)', group: 'Sections', action: () => App.showSection('finances') },
                { title: 'PR & Media', sub: 'Social, newsletters, campaigns', icon: 'fa-bullhorn', color: 'var(--pr-media)', group: 'Sections', action: () => App.showSection('pr-media') },
                { title: 'Notifications', sub: 'Send user notifications', icon: 'fa-paper-plane', color: '#22d3ee', group: 'Sections', action: () => App.showSection('user-notifications') },
                { title: 'Portal Content', sub: 'CMS for user portal', icon: 'fa-th-large', color: 'var(--accent-gold)', group: 'Sections', action: () => App.showSection('portal-content') },
                { title: 'Messages', sub: 'Direct messaging with users', icon: 'fa-envelope', color: '#a78bfa', group: 'Sections', action: () => App.showSection('messages') },
                { title: 'Settings', sub: 'Profile, security, sections', icon: 'fa-cog', color: 'var(--text-muted)', group: 'Sections', action: () => App.openSettings() },

                // Projects
                { title: 'Plexus Conference', sub: 'Project', icon: 'fa-microscope', color: 'var(--plexus)', group: 'Projects', action: () => App.showProject('plexus') },
                { title: 'Accelerator', sub: 'Project', icon: 'fa-rocket', color: 'var(--accelerator)', group: 'Projects', action: () => App.showProject('accelerator') },
                { title: 'Biomedical Forum', sub: 'Project', icon: 'fa-dna', color: 'var(--forum)', group: 'Projects', action: () => App.showProject('forum') },
                { title: 'Building Bridges', sub: 'Project', icon: 'fa-bridge', color: 'var(--bridges)', group: 'Projects', action: () => App.showProject('bridges') },

                // Plexus Tabs
                { title: 'Registrations', sub: 'Plexus Conference', icon: 'fa-users', color: 'var(--plexus)', group: 'Plexus Tabs', action: () => { App.showProject('plexus'); App.showPlexusTab('registrations'); } },
                { title: 'Abstracts', sub: 'Plexus Conference', icon: 'fa-file-alt', color: 'var(--plexus)', group: 'Plexus Tabs', action: () => { App.showProject('plexus'); App.showPlexusTab('abstracts'); } },
                { title: 'Schedule', sub: 'Plexus Conference', icon: 'fa-calendar', color: 'var(--plexus)', group: 'Plexus Tabs', action: () => { App.showProject('plexus'); App.showPlexusTab('schedule'); } },
                { title: 'Speakers', sub: 'Plexus Conference', icon: 'fa-microphone', color: 'var(--plexus)', group: 'Plexus Tabs', action: () => { App.showProject('plexus'); App.showPlexusTab('speakers'); } },
                { title: 'Sponsors', sub: 'Plexus Conference', icon: 'fa-handshake', color: 'var(--plexus)', group: 'Plexus Tabs', action: () => { App.showProject('plexus'); App.showPlexusTab('sponsors'); } },
                { title: 'Volunteers', sub: 'Plexus Conference', icon: 'fa-hand-holding-heart', color: 'var(--plexus)', group: 'Plexus Tabs', action: () => { App.showProject('plexus'); App.showPlexusTab('volunteers'); } },

                // Accelerator Tabs
                { title: 'Key Dates', sub: 'Accelerator', icon: 'fa-calendar-check', color: 'var(--accelerator)', group: 'Accelerator Tabs', action: () => { App.showProject('accelerator'); AcceleratorApp.showTab('dates'); } },
                { title: 'Institutions', sub: 'Accelerator', icon: 'fa-university', color: 'var(--accelerator)', group: 'Accelerator Tabs', action: () => { App.showProject('accelerator'); AcceleratorApp.showTab('institutions'); } },
                { title: 'Applications', sub: 'Accelerator', icon: 'fa-file-signature', color: 'var(--accelerator)', group: 'Accelerator Tabs', action: () => { App.showProject('accelerator'); AcceleratorApp.showTab('applications'); } },
                { title: 'Evaluation', sub: 'Accelerator', icon: 'fa-star-half-alt', color: 'var(--accelerator)', group: 'Accelerator Tabs', action: () => { App.showProject('accelerator'); AcceleratorApp.showTab('evaluation'); } },
                { title: 'Ranking', sub: 'Accelerator', icon: 'fa-trophy', color: 'var(--accelerator)', group: 'Accelerator Tabs', action: () => { App.showProject('accelerator'); AcceleratorApp.showTab('ranking'); } },

                // Finance Tabs
                { title: 'Bank Balance', sub: 'Finances', icon: 'fa-university', color: 'var(--finances)', group: 'Finance Tabs', action: () => { App.showSection('finances'); FinanceApp.showTab('bank-balance'); } },
                { title: 'Transactions', sub: 'Finances', icon: 'fa-exchange-alt', color: 'var(--finances)', group: 'Finance Tabs', action: () => { App.showSection('finances'); FinanceApp.showTab('transactions'); } },
                { title: 'Invoices', sub: 'Finances', icon: 'fa-file-invoice', color: 'var(--finances)', group: 'Finance Tabs', action: () => { App.showSection('finances'); FinanceApp.showTab('invoices'); } },
                { title: 'Work Units', sub: 'Finances', icon: 'fa-briefcase', color: 'var(--finances)', group: 'Finance Tabs', action: () => { App.showSection('finances'); FinanceApp.showTab('work-units'); } },
                { title: 'Travel Orders', sub: 'Finances', icon: 'fa-plane', color: 'var(--finances)', group: 'Finance Tabs', action: () => { App.showSection('finances'); FinanceApp.showTab('travel-orders'); } },

                // PR Tabs
                { title: 'Content Calendar', sub: 'PR & Media', icon: 'fa-calendar-alt', color: 'var(--pr-media)', group: 'PR Tabs', action: () => { App.showSection('pr-media'); PRApp.showTab('calendar'); } },
                { title: 'Social Posts', sub: 'PR & Media', icon: 'fa-share-alt', color: 'var(--pr-media)', group: 'PR Tabs', action: () => { App.showSection('pr-media'); PRApp.showTab('social'); } },
                { title: 'Newsletters', sub: 'PR & Media', icon: 'fa-envelope-open-text', color: 'var(--pr-media)', group: 'PR Tabs', action: () => { App.showSection('pr-media'); PRApp.showTab('newsletters'); } },
                { title: 'AI Studio', sub: 'PR & Media', icon: 'fa-magic', color: 'var(--pr-media)', group: 'PR Tabs', action: () => { App.showSection('pr-media'); PRApp.showTab('ai-studio'); } },
                { title: 'Campaigns', sub: 'PR & Media', icon: 'fa-bullseye', color: 'var(--pr-media)', group: 'PR Tabs', action: () => { App.showSection('pr-media'); PRApp.showTab('campaigns'); } },

                // Forum Tabs
                { title: 'Forum Events', sub: 'Biomedical Forum', icon: 'fa-calendar-day', color: 'var(--forum)', group: 'Forum Tabs', action: () => { App.showProject('forum'); App.showForumTab('events'); } },
                { title: 'Forum Members', sub: 'Biomedical Forum', icon: 'fa-users', color: 'var(--forum)', group: 'Forum Tabs', action: () => { App.showProject('forum'); App.showForumTab('members'); } },
                { title: 'Forum Feed', sub: 'Biomedical Forum', icon: 'fa-comments', color: 'var(--forum)', group: 'Forum Tabs', action: () => { App.showProject('forum'); App.showForumTab('feed'); } },
                { title: 'Forum Gallery', sub: 'Biomedical Forum', icon: 'fa-images', color: 'var(--forum)', group: 'Forum Tabs', action: () => { App.showProject('forum'); App.showForumTab('gallery'); } },

                // Quick Actions
                { title: 'Send Notification', sub: 'Quick send to users', icon: 'fa-bell', color: '#22d3ee', group: 'Actions', action: () => App.showSection('user-notifications') },
                { title: 'New Task', sub: 'Create a new to-do item', icon: 'fa-plus-circle', color: '#10b981', group: 'Quick Actions', action: () => App.openTaskModal() },
                { title: 'My Network', sub: 'Open contacts panel', icon: 'fa-address-book', color: 'var(--accent-gold)', group: 'Quick Actions', action: () => NetworkApp.openPanel() },
            ],

            open() {
                const overlay = document.getElementById('cmdPalette');
                overlay.classList.add('active');
                const input = document.getElementById('cmdPaletteInput');
                input.value = '';
                this.selectedIndex = 0;
                this.filter();
                setTimeout(() => input.focus(), 50);
            },

            close(e) {
                if (e && e.target !== document.getElementById('cmdPalette')) return;
                document.getElementById('cmdPalette').classList.remove('active');
            },

            forceClose() {
                document.getElementById('cmdPalette').classList.remove('active');
            },

            filter() {
                const query = document.getElementById('cmdPaletteInput').value.toLowerCase().trim();
                const container = document.getElementById('cmdPaletteResults');

                if (!query) {
                    this.filteredItems = [...this.registry];
                } else {
                    this.filteredItems = this.registry.filter(item =>
                        item.title.toLowerCase().includes(query) ||
                        item.sub.toLowerCase().includes(query) ||
                        item.group.toLowerCase().includes(query)
                    );
                }

                this.selectedIndex = 0;
                this.render(container);
            },

            render(container) {
                if (this.filteredItems.length === 0) {
                    container.innerHTML = '<div class="cmd-palette-empty"><i class="fas fa-search" style="font-size: 24px; margin-bottom: 8px; display: block; opacity: 0.3;"></i>No results found</div>';
                    return;
                }

                let html = '';
                let lastGroup = '';
                this.filteredItems.forEach((item, i) => {
                    if (item.group !== lastGroup) {
                        html += `<div class="cmd-palette-group">${item.group}</div>`;
                        lastGroup = item.group;
                    }
                    html += `<div class="cmd-palette-item${i === this.selectedIndex ? ' selected' : ''}" data-index="${i}" onclick="CmdPalette.execute(${i})" onmouseenter="CmdPalette.select(${i})">
                        <div class="cmd-palette-item-icon" style="background: ${item.color}20; color: ${item.color};">
                            <i class="fas ${item.icon}"></i>
                        </div>
                        <div class="cmd-palette-item-text">
                            <div class="cmd-palette-item-title">${item.title}</div>
                            <div class="cmd-palette-item-sub">${item.sub}</div>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            },

            select(index) {
                this.selectedIndex = index;
                document.querySelectorAll('.cmd-palette-item').forEach((el, i) => {
                    el.classList.toggle('selected', i === index);
                });
            },

            handleKey(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    this.selectedIndex = Math.min(this.selectedIndex + 1, this.filteredItems.length - 1);
                    this.updateSelection();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
                    this.updateSelection();
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    this.execute(this.selectedIndex);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    this.forceClose();
                }
            },

            updateSelection() {
                const items = document.querySelectorAll('.cmd-palette-item');
                items.forEach((el, i) => el.classList.toggle('selected', i === this.selectedIndex));
                items[this.selectedIndex]?.scrollIntoView({ block: 'nearest' });
            },

            execute(index) {
                const item = this.filteredItems[index];
                if (item) {
                    this.forceClose();
                    item.action();
                }
            }
        };

        // Global Cmd+K listener
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                e.preventDefault();
                const overlay = document.getElementById('cmdPalette');
                if (overlay.classList.contains('active')) {
                    CmdPalette.forceClose();
                } else {
                    CmdPalette.open();
                }
            }
        });

        // ========================================
        // BREADCRUMBS
        // ========================================
        const Breadcrumbs = {
            sectionNames: {
                'dashboard': { label: 'Home', icon: 'fa-home' },
                'plexus': { label: 'Plexus Conference', icon: 'fa-microscope' },
                'accelerator': { label: 'Accelerator', icon: 'fa-rocket' },
                'forum': { label: 'Biomedical Forum', icon: 'fa-dna' },
                'bridges': { label: 'Building Bridges', icon: 'fa-bridge' },
                'finances': { label: 'Finances', icon: 'fa-coins' },
                'pr-media': { label: 'PR & Media', icon: 'fa-bullhorn' },
                'user-notifications': { label: 'Notifications', icon: 'fa-paper-plane' },
                'portal-content': { label: 'Portal Content', icon: 'fa-th-large' },
                'settings': { label: 'Settings', icon: 'fa-cog' },
            },

            current: { section: 'dashboard', tab: null },

            update(section, tab = null) {
                this.current = { section, tab };
                const el = document.getElementById('breadcrumbs');
                if (!el) return;

                if (section === 'dashboard') {
                    el.innerHTML = '';
                    return;
                }

                const info = this.sectionNames[section] || { label: section, icon: 'fa-folder' };
                let html = `<span class="breadcrumb-item" onclick="App.showSection('dashboard')"><i class="fas fa-home"></i> Home</span>`;
                html += `<span class="breadcrumb-sep"><i class="fas fa-chevron-right"></i></span>`;

                if (tab) {
                    html += `<span class="breadcrumb-item" onclick="${this.getNavAction(section)}"><i class="fas ${info.icon}"></i> ${info.label}</span>`;
                    html += `<span class="breadcrumb-sep"><i class="fas fa-chevron-right"></i></span>`;
                    html += `<span class="breadcrumb-item current">${tab}</span>`;
                } else {
                    html += `<span class="breadcrumb-item current"><i class="fas ${info.icon}"></i> ${info.label}</span>`;
                }

                el.innerHTML = html;
            },

            getNavAction(section) {
                const projects = ['plexus', 'accelerator', 'forum', 'bridges'];
                if (projects.includes(section)) return `App.showProject('${section}')`;
                return `App.showSection('${section}')`;
            }
        };

        // Hook breadcrumbs into showSection
        const _origShowSection = App.showSection;
        App.showSection = function(sectionId, navItem, skipHistory) {
            _origShowSection.call(this, sectionId, navItem, skipHistory);
            Breadcrumbs.update(sectionId);
        };

        // Hook breadcrumbs into showProject
        const _origShowProject = App.showProject;
        App.showProject = function(projectId, navItem, skipHistory) {
            _origShowProject.call(this, projectId, navItem, skipHistory);
            Breadcrumbs.update(projectId);
        };

        // Hook breadcrumbs into Plexus tabs
        const _origShowPlexusTab = App.showPlexusTab;
        App.showPlexusTab = function(tab) {
            _origShowPlexusTab.call(this, tab);
            const tabNames = { dashboard: 'Dashboard', registrations: 'Registrations', abstracts: 'Abstracts', schedule: 'Schedule', speakers: 'Speakers', sponsors: 'Sponsors', volunteers: 'Volunteers', checkin: 'Check-in', pending: 'Pending' };
            Breadcrumbs.update('plexus', tabNames[tab] || tab);
        };

        // Hook breadcrumbs into Forum tabs
        const _origShowForumTab = App.showForumTab;
        App.showForumTab = function(tab) {
            _origShowForumTab.call(this, tab);
            const tabNames = { dashboard: 'Dashboard', feed: 'Feed', events: 'Events', groups: 'Groups', resources: 'Resources', gallery: 'Gallery', members: 'Members', applications: 'Applications', checkin: 'Check-in' };
            Breadcrumbs.update('forum', tabNames[tab] || tab);
        };

        // Hook breadcrumbs into Accelerator tabs
        const _origAccShowTab = AcceleratorApp.showTab;
        AcceleratorApp.showTab = function(tab) {
            _origAccShowTab.call(this, tab);
            const tabNames = { overview: 'Overview', dates: 'Key Dates', institutions: 'Institutions', apply: 'Application Form', applications: 'Applications', evaluation: 'Evaluation', interviewers: 'Interviewers', ranking: 'Ranking', files: 'Files' };
            Breadcrumbs.update('accelerator', tabNames[tab] || tab);
        };

        // Hook breadcrumbs into Finance tabs
        const _origFinShowTab = FinanceApp.showTab;
        FinanceApp.showTab = function(tabId, btn) {
            _origFinShowTab.call(this, tabId, btn);
            const tabNames = { dashboard: 'Dashboard', 'bank-balance': 'Bank Balance', transactions: 'Transactions', 'work-units': 'Work Units', invoices: 'Invoices', 'payment-orders': 'Payment Orders', 'travel-orders': 'Travel Orders', reports: 'Reports', settings: 'Settings' };
            Breadcrumbs.update('finances', tabNames[tabId] || tabId);
        };

        // Hook breadcrumbs into PR tabs
        const _origPRShowTab = PRApp.showTab;
        PRApp.showTab = function(tabId, btn) {
            _origPRShowTab.call(this, tabId, btn);
            const tabNames = { dashboard: 'Dashboard', calendar: 'Calendar', social: 'Social Posts', newsletters: 'Newsletters', media: 'Media Kit', 'ai-studio': 'AI Studio', campaigns: 'Campaigns', subscribers: 'Subscribers' };
            Breadcrumbs.update('pr-media', tabNames[tabId] || tabId);
        };

        // ========================================
        // UNSAVED CHANGES TRACKER
        // ========================================
        const UnsavedChanges = {
            dirty: false,
            activeModal: null,
            trackedInputs: new Set(),

            init() {
                // Watch for modal opens — track inputs inside them
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach(m => {
                        if (m.type === 'attributes' && m.attributeName === 'class') {
                            const modal = m.target;
                            if (modal.classList.contains('modal-overlay') && modal.classList.contains('active')) {
                                this.trackModal(modal);
                            } else if (modal.classList.contains('modal-overlay') && !modal.classList.contains('active')) {
                                this.clear();
                            }
                        }
                    });
                });

                // Observe all modal overlays
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
                });

                // Also use MutationObserver on body for dynamically added modals
                const bodyObserver = new MutationObserver(() => {
                    document.querySelectorAll('.modal-overlay').forEach(modal => {
                        if (!modal._unsavedObserved) {
                            modal._unsavedObserved = true;
                            observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
                        }
                    });
                });
                bodyObserver.observe(document.body, { childList: true, subtree: true });

                // Warn on page unload
                window.addEventListener('beforeunload', (e) => {
                    if (this.dirty) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
            },

            trackModal(modal) {
                this.activeModal = modal;
                this.dirty = false;
                this.trackedInputs.clear();
                this.hide();

                // Slight delay to let modal render
                setTimeout(() => {
                    const inputs = modal.querySelectorAll('input, textarea, select');
                    inputs.forEach(input => {
                        if (this.trackedInputs.has(input)) return;
                        this.trackedInputs.add(input);
                        const handler = () => { this.markDirty(); };
                        input.addEventListener('input', handler);
                        input.addEventListener('change', handler);
                    });
                }, 200);
            },

            markDirty() {
                if (!this.dirty) {
                    this.dirty = true;
                    this.show();
                }
            },

            clear() {
                this.dirty = false;
                this.activeModal = null;
                this.trackedInputs.clear();
                this.hide();
            },

            show() {
                document.getElementById('unsavedBar')?.classList.add('visible');
            },

            hide() {
                document.getElementById('unsavedBar')?.classList.remove('visible');
            },

            discard() {
                if (this.activeModal) {
                    this.activeModal.classList.remove('active');
                    this.activeModal.style.display = 'none';
                }
                this.clear();
            }
        };

        // Initialize UnsavedChanges after DOM ready
        setTimeout(() => UnsavedChanges.init(), 500);

        // Initialize app
        App.init();
    </script>
</body>
</html>
